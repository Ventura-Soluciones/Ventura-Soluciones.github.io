// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/thirdparty/datajs","sap/base/i18n/Localization","sap/ui/core/Supportability","sap/ushell_abap/pbServices/ui2/Utils","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell_abap/pbServices/ui2/Error","sap/base/Log","sap/ui/thirdparty/jquery"],function(e,t,a,r,n,s,i,jQuery){"use strict";function o(){}function u(e,t){if(r.isArray(e)){e.forEach(function(e){e.reject(t)})}else{e.reject(t)}}var c;c=function(e,a){var n="saplb",f,l,d,h=this,g,b;function O(e){var t={};t.baseUrl=e[0];if(typeof e[2]==="boolean"){t.supportsChangeSets=e[2]}return t}this.getBatchQueue=function(){return f};c.headerValue=function(e,t){e=e.toLowerCase();for(var a in t){if(Object.prototype.hasOwnProperty.call(t,a)&&a.toLowerCase()===e){return t[a]}}return undefined};function S(t){var a=e["sap-language"]||c["sap-language"],r=e["sap-statistics"]||c["sap-statistics"],n=e["sap-client"]||c["sap-client"];t=t||{};if(a){t["sap-language"]=a}if(r||r==="false"){t["sap-statistics"]=""+r}if(n){t["sap-client"]=n}return t}function y(e){e=e||{};var t=c.oStickySessionConfiguration[g];if(typeof t==="undefined"){return e}if(t&&t.enabled&&typeof t.value!=="undefined"){e[n]=t.value}return e}this.detectStickySession=function(e){var t,a=c.oStickySessionConfiguration[g];if(!a||!a.enabled){return}t=c.headerValue(n,e);if(typeof t==="undefined"){return}if(a.value!==t){a.value=t}};c.csrfTokenValue=function(e){var t=c.headerValue("x-csrf-token",e);if(t==="Required"){return t}var a=c.headerValue("cache-control",e);if(a===undefined||a.indexOf("max-age=0")>-1||a.indexOf("no-cache")>-1){return t||""}return""};this.doRequest=function(e,n,s,u,f,p,l){i.debug("[000] do request, sMethod",n,"ODataWrapper");var d;u=u||o;f=f||a.getDefaultErrorHandler();h.check(u,f);d={Accept:"application/json","Accept-Language":t.getLanguage()||"","X-CSRF-Token":a.getCsrfToken()};S(d);y(d);OData.request({requestUri:e,method:n,data:s,headers:d},function(t,a){this.detectStickySession((a||{}).headers);i.debug("Received OData response for "+n+' "'+e+'"',null,"ODataWrapper");r.callHandler(u.bind(null,t),f)}.bind(this),function(t){function r(){f.apply(null,arguments)}function o(){u.apply(null,arguments)}if(!l&&t.response.statusCode===403&&c.csrfTokenValue(t.response.headers).toLowerCase()==="required"){i.debug("CSRF token required for "+n+' "'+e+'", refreshing it',JSON.stringify(t.response),"ODataWrapper");a.refreshCsrfToken(this.doRequest.bind(h,e,n,s,o,r,p,true),r)}else{h.onError(n,e,f,null,t)}}.bind(this),p);i.debug("Sent OData request for "+n+' "'+e+'"',null,"ODataWrapper")};this.toRelativeUrl=function(e){var t=e.indexOf(g);if(t<0){throw new s('Not relative to base URL "'+g+'": '+e,"ODataWrapper")}return e.slice(t+g.length)};this.toRequestUrl=function(e){if(/^\//.test(e)){throw new s("Not a relative URL: "+e,"ODataWrapper")}return g+e};this.readOrBatch=function(e,a,r){var n,s=this.toRequestUrl(e),o=y(S());if(f){i.debug('Queued OData request for GET "'+e+'"',null,"ODataWrapper");f.push({method:"GET",requestUri:e,headers:o});n=(new jQuery.Deferred).done(a).fail(r);d.push(n);l=false;return}o.Accept="application/json";o["Accept-Language"]=t.getLanguage()||"";o["X-CSRF-Token"]="Fetch";OData.read({requestUri:s,headers:o},a,r);i.debug('Sent OData request for GET "'+s+'"',null,"ODataWrapper")};this.requestOrBatch=function(e,t,n,s,u){var c,p={data:n,method:t,requestUri:e,headers:y(S())},g=this.toRequestUrl(e);if(f){s=s||o;u=u||a.getDefaultErrorHandler();h.check(s,u);i.debug("Queued OData request for "+t+' "'+e+'"',null,"ODataWrapper");if(!l){f.push({__changeRequests:[]});d.push([]);l=b}f[f.length-1].__changeRequests.push(p);c=(new jQuery.Deferred).done(function(e,a){i.debug("Received OData response for "+t+' "'+g+'"',null,"ODataWrapper");r.callHandler(s.bind(null,e),u)}).fail(h.onError.bind(h,t,g,u,null));d[d.length-1].push(c);return}this.doRequest(g,t,n,s,u)};this.isStickySessionEnabled=function(){return(c.oStickySessionConfiguration[g]||{}).enabled||false};this.enableStickySession=function(){c.oStickySessionConfiguration[g].enabled=true};this.check=function(e,t){if(!e){throw new s("Missing success callback","ODataWrapper")}if(typeof e!=="function"){throw new s("Success callback is not a function","ODataWrapper")}if(!t){throw new s("Missing error callback","ODataWrapper")}if(typeof t!=="function"){throw new s("Error callback is not a function","ODataWrapper")}};this.create=function(e,t,a,r){i.debug("[000] create: url",e,"ODataWrapper");this.requestOrBatch(e,"POST",t,a,r)};this.del=function(e,t,a){var r=e;if(typeof r!=="string"){r=this.toRelativeUrl(e.__metadata.uri)}this.requestOrBatch(r,"DELETE",null,function(e){if(t){t()}},a)};this.getBaseUrl=function(){return g};this.getODataService=function(){return a};this.onError=function(e,t,a,r,n){var s,o="Error ";if(n.response&&n.response.statusCode){o+="("+n.response.statusCode+", "+n.response.statusText+") "}o+="in OData response for "+e+' "'+t+'": '+n.message;if(n.response&&n.response.body){try{s=JSON.parse(n.response.body).error;if(s){if(s.hasOwnProperty("message")&&s.message.hasOwnProperty("value")){o+="\nDetails: "+s.message.value}if(n.response.statusCode&&!s.httpStatus){s.httpStatus=n.response.statusCode}}}catch(e){}}i.error(o,JSON.stringify(n.response),"ODataWrapper");if(r){r.reject(o,s)}a(o,s)};this.openBatchQueue=function(){if(f){throw new s("Batch queue already open","ODataWrapper")}f=[];d=[];l=false};this.isBatchQueueOpen=function(){return!!f};this.read=function(e,t,n,s){var o,u=this.toRequestUrl(e),f;function p(e,s){this.detectStickySession(s.headers);a.setCsrfToken(c.csrfTokenValue(s.headers)||a.getCsrfToken());i.debug('Received OData response for GET "'+u+'"',null,"ODataWrapper");f=c.headerValue("sap-message",s.headers);if(f){i.warning("SAP message for GET "+u,f,"ODataWrapper")}if(o){o.resolve(JSON.parse(JSON.stringify(e)),a.getCsrfToken())}r.callHandler(t.bind(null,e),n)}n=n||a.getDefaultErrorHandler();this.check(t,n);if(s){OData.read.$cache=OData.read.$cache||new r.Map;o=OData.read.$cache.get(u);if(o){i.debug('Using cached response for GET "'+u+'"',null,"ODataWrapper");o.done(function(e,s){a.setCsrfToken(a.getCsrfToken()||s);r.callHandler(t.bind(null,JSON.parse(JSON.stringify(e))),n)}).fail(n);return}o=new jQuery.Deferred;OData.read.$cache.put(u,o.promise())}this.readOrBatch(e,p.bind(this),this.onError.bind(this,"GET",u,n,o))};this.batch=function(e,t,a){var r=this.toRequestUrl("$batch");this.doRequest(r,"POST",e,t,a,OData.batchHandler)};this.submitBatchQueue=function(e,t){var n=d;function o(s){var i=s.__batchResponses.length,o=n.length;if(o!==i){h.onError("POST",this.toRequestUrl("$batch"),t,null,{message:"Protocol error! Expected "+o+" responses, but received "+i});return}s.__batchResponses.forEach(function(e,t){var a=n[t];if(e.response){u(a,e)}else if(e.__changeResponses){e.__changeResponses.forEach(function(e,t){a[t].resolve(e.data,e)})}else{a.resolve(e.data,e)}});if(e){r.callHandler(e,a.getDefaultErrorHandler())}}if(!f){throw new s("No open batch queue to submit","ODataWrapper")}if(f.length>0){i.debug("[000] submit batch queue: batch","ODataWrpper");this.batch({__batchRequests:f},o.bind(this),t)}else if(e){r.callHandler(e,a.getDefaultErrorHandler(),true)}i.debug("[000] submit batch queue","ODataWrapper");f=undefined;d=undefined};this.toString=function(e){var t=['ODataWrapper({sBaseUrl:"',g,'"'];t.push("})");return t.join("")};this.put=function(e,t,a,r){i.debug("[000] put: request or batch, payload.id",t.id,"ODataWrapper");this.requestOrBatch(e,"PUT",t,function(e){if(a){a()}},r)};this.update=function(e,t,a){var r={__metadata:{type:e.__metadata&&e.__metadata.type}},n,s=this.toRelativeUrl(e.__metadata.uri);for(n in e){if(Object.prototype.hasOwnProperty.call(e,n)&&n.indexOf("$")!==0&&typeof e[n]!=="object"){r[n]=e[n]}}this.put(s,r,t,a)};if(typeof e==="string"){e=O(arguments)}else if(typeof e==="object"){e=p(e)}if(!e||!e.baseUrl||typeof e.baseUrl!=="string"){throw new s("Missing base URL","ODataWrapper")}if(!a||typeof a!=="object"){throw new s("Missing OData service facade","ODataWrapper")}e.baseUrl=e.baseUrl.replace(/\/$/,"")+"/";g=e.baseUrl;b=e.supportsChangeSets;if(typeof c.oStickySessionConfiguration==="undefined"){i.error("ODataWrapper.oStickySessionConfiguration is not defined!","the ODataWrapper constructor was called before the static property was defined","ODataWrapper")}else if(typeof c.oStickySessionConfiguration[g]==="undefined"){c.oStickySessionConfiguration[g]={enabled:false,value:undefined}}};function f(e){var t={};var a={};t.baseUrl=e[0];if(typeof e[1]==="boolean"){t.supportsChangeSets=e[1]}if(typeof e[2]==="function"){a.defaultFailure=e[2]}a.settings=t;return a}function p(e){if(e===undefined){return undefined}try{return JSON.parse(JSON.stringify(e))}catch(e){return undefined}}if(typeof c.oStickySessionConfiguration==="undefined"){c.oStickySessionConfiguration={}}c.checkSapStatisticsSetting=function(e){try{c["sap-statistics"]=a.isStatisticsEnabled()}catch(t){c["sap-statistics"]=/sap-statistics=(true|x|X)/.test(e)}};c.checkSapStatisticsSetting(window.location.search);c._Service=function e(t,a){var r=new c(t,this);n.call(this,r,a);return r};c.createODataWrapper=function(e,t){i.debug("[000] createOdataWrapper","ODataWrapper");if(typeof arguments[0]==="string"){var a=f(arguments);e=a.settings;if(a.defaultFailure){t=a.defaultFailure}}else if(typeof arguments[0]==="object"){e=p(e)}return new c._Service(e,t)};return c});
//# sourceMappingURL=ODataWrapper.js.map