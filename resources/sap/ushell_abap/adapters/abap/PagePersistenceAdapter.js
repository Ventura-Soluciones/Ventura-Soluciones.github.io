// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/i18n/Localization","sap/base/util/ObjectPath","sap/ushell/utils/HttpClient","sap/ushell/resources","sap/ushell/utils/chipsUtils","sap/ushell/Config","sap/ushell/Container"],function(e,t,i,a,r,n,s){"use strict";function o(){var e=window["sap-ushell-config"].services&&window["sap-ushell-config"].services.PagePersistence||{};return(t.get("config.serviceUrl",e.adapter)||"").replace(/\/?$/,"/")}var c=function(){this.S_COMPONENT_NAME="sap.ushell_abap.adapters.abap.PagePersistenceAdapter"};c.prototype.getPage=function(e){return Promise.all([this._readPage(e),s.getServiceAsync("URLParsing")]).then(function(e){var t=e[0];var i=e[1];return this._convertODataToReferenceData(t,i)}.bind(this)).catch(this._rejectWithError.bind(this))};c.prototype.getPages=function(e){return Promise.all([this._readPages(e),s.getServiceAsync("URLParsing")]).then(function(e){var t=e[0].results;var i=e[1];return t.map(function(e){return this._convertODataToReferenceData(e,i)}.bind(this))}.bind(this)).catch(this._rejectWithError.bind(this))};c.prototype._readPage=function(t){return new Promise(function(a,r){var n={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":e.getLanguage()||"",Accept:"application/json, text/plain"};var c=s.getUser().getLanguage();if(c){n["sap-language"]=c}var p=s.getLogonSystem();var l=p?p.getClient():"";if(l){n["sap-client"]=l}var d=o();var u=new i(d,{headers:n});var g=d+"pageSet('"+encodeURIComponent(t)+"')"+"?$expand=sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported";u.get(g).then(function(e){a(JSON.parse(e.responseText).d)}).catch(r)})};c.prototype._readPages=function(t){return new Promise(function(a,r){var n={"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0","Accept-Language":e.getLanguage()||"",Accept:"application/json, text/plain","content-type":"multipart/mixed; boundary=batch_bd56-ff53-571c"};var c=s.getUser().getLanguage();if(c){n["sap-language"]=c}var p=s.getLogonSystem();var l=p?p.getClient():"";if(l){n["sap-client"]=l}var d="pageSet?$expand="+encodeURIComponent("sections/viz,vizReferences/chipBags/properties,tileTypes/vizOptions/displayFormats/supported")+"&$filter=";var u=t.length?"id eq '"+t.join("' or id eq '")+"'":"";var g=o();var h=g+"$batch";var f=new i(g,{headers:n});var v=this._createBatchData(d+encodeURIComponent(u).replace(/[!'()*]/g,escape));f.post(h,{data:v}).then(function(e){var t=this._retrieveBatchData(e);a(t)}.bind(this)).catch(r)}.bind(this))};c.prototype._createBatchData=function(e){var t=s.getUser().getLanguage();var i=s.getLogonSystem()?s.getLogonSystem().getClient():"";var a=["--batch_bd56-ff53-571c","Content-Type: application/http","Content-Transfer-Encoding: binary","","GET "+e+" HTTP/1.1","sap-cancel-on-close: true","sap-language: "+(t||""),"sap-client: "+(i||""),"sap-contextid-accept: header","Accept: application/json","Accept-Language: "+(t||""),"DataServiceVersion: 2.0","MaxDataServiceVersion: 2.0","X-Requested-With: XMLHttpRequest","","","","--batch_bd56-ff53-571c--"];return a.join("\r\n")};c.prototype._retrieveBatchData=function(e){var t=e.responseText.split("\r\n");var i=[];for(var a=0;a<t.length;a++){if(t[a].startsWith("{")){i=t[a]}}return JSON.parse(i).d};c.prototype._convertODataToReferenceData=function(e,t){var i={};var a={page:{id:e.id,title:e.title,description:e.description,createdBy:e.createdBy,createdByFullname:e.createdByFullname||e.createdBy,modifiedBy:e.modifiedBy,modifiedByFullname:e.modifiedByFullname||e.modifiedBy,sections:e.sections.results.map(function(e){return{id:e.id,sectionIndex:e.sectionIndex,title:e.title,viz:e.viz.results.map(function(e){return{catalogTileId:e.catalogTileId,id:e.id,itemIndex:e.itemIndex,targetMappingId:e.targetMappingId,vizId:e.catalogTileIdStable,inboundPermanentKey:e.targetMappingIdStable,displayFormatHint:e.displayFormatHint}}).sort(function(e,t){return e.itemIndex-t.itemIndex})}}).sort(function(e,t){return e.sectionIndex-t.sectionIndex})},visualizations:e.vizReferences.results.reduce(function(e,a){var n=this._getSimplifiedChip(a);var s={vizId:a.catalogTileIdStable,vizType:a.tileType,title:a.title,subTitle:a.subTitle,icon:a.iconUrl,info:r.getInfoFromSimplifiedChip(n),keywords:r.getKeywordsFromSimplifiedChip(n),size:r.getTileSizeFromSimplifiedChip(n),indicatorDataSource:r.getIndicatorDataSourceFromSimplifiedChip(n),url:r.getTargetUrlFromSimplifiedChip(n,t),numberUnit:r.getNumberUnitFromSimplifiedChip(n),isCustomTile:r.isCustomTileFromSimplifiedChip(n),_instantiationData:{platform:"ABAP",simplifiedChipFormat:true,chip:n}};e[a.catalogTileIdStable]=s;if(a.fromPersonalization&&a.id!==a.catalogTileIdStable){i[a.id]=s}return e}.bind(this),{}),vizTypes:e.tileTypes.results.reduce(function(e,t){var i=t.vizOptions.displayFormats;var a=t.id;e[a]={id:a,url:t.url,vizOptions:{displayFormats:{supported:i.supported.results.map(function(e){return e.id}),default:i.preferred}}};return e},{})};a.unstableVisualizations=Object.keys(i).length>0?i:null;return a};c.prototype._getSimplifiedChip=function(e){var t={};var i;try{i=JSON.parse(e.configuration)}catch(e){i={}}e.chipBags.results.forEach(function(e){t[e.id]={texts:{},properties:{}};e.properties.results.forEach(function(i){if(i.translatable){t[e.id].texts[i.id]=i.value}else{t[e.id].properties[i.id]=i.value}})});return{chipId:e.tileType,configuration:i,bags:t}};c.prototype._rejectWithError=function(e){var t={component:this.S_COMPONENT_NAME,description:a.i18n.getText("PagePersistenceAdapter.CannotLoadPage"),detail:e};return Promise.reject(t)};return c});
//# sourceMappingURL=PagePersistenceAdapter.js.map