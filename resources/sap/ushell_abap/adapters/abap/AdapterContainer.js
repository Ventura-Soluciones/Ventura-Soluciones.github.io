// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/ObjectPath","sap/base/Log","sap/ui/thirdparty/jquery","sap/ui/core/format/DateFormat","sap/ushell_abap/pbServices/ui2/ODataService","sap/ushell/services/_Personalization/constants"],function(e,t,jQuery,r,n,i){"use strict";var o="PersContainers",a="yyyyMMddHHmmss",s=new Date(9999,1,1,0,0,0),c=new Date(9999,1,1,0,0,0,0),u="ADMIN#sap-ushell-container-expireUTCTimestamp",p="ADMIN#sap-ushell-container-storageUTCTimestamp",f="ADMIN#sap-ushell-container-scope";function y(e){var r="sap.ushell.personalization#";if(e.substring(0,r.length)!==r){t.error("Unexpected ContainerKey "+e);return e}return e.substring(r.length,r.length+40)}var h=function(t,r,n,i){this._oService=r;this._oScope=n;this["sap-cache-id"]=e.get("_oService._oConfig.services.personalization.cacheId",this);this._sContainerKey=y(t);this._sAppName=i||"";this._category=this._determineCategory(n);this._oJSONContainer={category:this._category,clientExpirationTime:c,appName:this._sAppName,component:"",id:this._sContainerKey,PersContainerItems:[]};this._oPropertyBag={};this._aOperationQueue=[]};h.prototype._reset=function(){this._oJSONContainer.PersContainerItems=[]};h.prototype._obtainODataWrapper=function(){return this._oService._oWrapper};h.prototype.load=function(){var e=new jQuery.Deferred,r=this,i=this._obtainODataWrapper(),a=o+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')?$expand=PersContainerItems";if(this._category&&this._category==="P"&&this["sap-cache-id"]){a=a+"&sap-cache-id="+this["sap-cache-id"]}n.call(this,i,function(){return false});i.read(a,function(t){r._oJSONContainer=t;r._oJSONContainer.category=r._category;r._oJSONContainer.id=r._sContainerKey;r._oJSONContainer.appName=r._sAppName;r._oJSONContainer.PersContainerItems=r._oJSONContainer.PersContainerItems&&r._oJSONContainer.PersContainerItems.results||[];e.resolve(r)},function(r){t.error(r);e.reject(r)});return e.promise()};h.prototype.save=function(){t.debug("[000] save","AdapterContainer");var e=new jQuery.Deferred,r=this,i=this._obtainODataWrapper(),a=o;n.call(this,i,function(){return false});i.create(a,this._oJSONContainer,function(){e.resolve(r)},function(t){e.reject(t)});return e.promise()};h.prototype.del=function(){var e=new jQuery.Deferred,t=this,r=this._obtainODataWrapper(),i=o+"(category='"+this._category+"',id='"+encodeURIComponent(this._sContainerKey)+"')";n.call(this,r,function(){return false});r.del(i,function(r){e.resolve(t)},function(t){e.reject(t)});this._reset();return e.promise()};h.prototype.getItemKeys=function(){var e=[];this._oJSONContainer.PersContainerItems.forEach(function(t){if(t.category==="V"){e.push("VARIANTSET#"+t.id)}else if(t.category==="I"){e.push("ITEM#"+t.id)}});if(this._oJSONContainer.validity>=0){e.push(p);e.push(u);e.push(f)}return e};h.prototype.containsItem=function(e){return this.getItemKeys().indexOf(e)>=0};function l(e){if(e===undefined||e===null){return null}var t=r.getDateInstance({pattern:a});return t.parse(JSON.parse(e),true)}function d(e){var n=r.getDateInstance({pattern:a});if(e===null){e=c}if(typeof e==="string"){if(/\/Date\(([0-9]+)\)\//.exec(e)){e=new Date(parseInt(/\/Date\(([0-9]+)\)\//.exec(e)[1],10))}else{t.error("Expected Date format "+e)}}if(+e===+c){return undefined}return n.format(e,true)}h.prototype._findItemIndex=function(e,t){var r;for(r=0;r<this._oJSONContainer.PersContainerItems.length;r=r+1){if(this._oJSONContainer.PersContainerItems[r].id===e&&this._oJSONContainer.PersContainerItems[r].category===t){return r}}return undefined};h.prototype._locateItem=function(e){var r={index:-1};if(e===u){return{containerProperty:"clientExpirationTime",initialValue:c,convToABAP:l,convFromABAP:d}}if(e===f){return{containerProperty:"validity",initialValue:0,convToABAP:function(e){if(!e){return null}return JSON.parse(e).validity},convFromABAP:function(e,t){if(e<=0){return undefined}t=t||{};t.validity=e;return t}}}if(e===p){return{containerProperty:" ignore",initialValue:s,convToABAP:l,convFromABAP:d}}if(e.indexOf("ITEM#")===0){r.trueItemKey=e.substring("ITEM#".length,"ITEM#".length+40);r.category="I"}else if(e.indexOf("VARIANTSET#")===0){r.trueItemKey=e.substring("VARIANTSET#".length,"VARIANTSET#".length+40);r.category="V"}else if(e.indexOf("ADMIN#")!==0){t.error("Unknown itemkey prefix"+e)}r.index=this._findItemIndex(r.trueItemKey,r.category);return r};h.prototype.getItemValue=function(e){var t="",r,n=this._locateItem(e);if(n.containerProperty===" ignore"){return undefined}if(n.index>=0){t=this._oJSONContainer.PersContainerItems[n.index].value;try{r=JSON.parse(t)}catch(e){if(t==="X"){r=true}else{r=undefined}}}if(n.containerProperty){if(typeof n.convFromABAP==="function"){return n.convFromABAP(this._oJSONContainer[n.containerProperty],r)}return this._oJSONContainer[n.containerProperty]}return r};h.prototype.setItemValue=function(e,t){var r=JSON.stringify(t),n=this._locateItem(e);if(n.containerProperty===" ignore"){return}if(n.containerProperty){if(typeof n.convToABAP==="function"){this._oJSONContainer[n.containerProperty]=n.convToABAP(r)}else{this._oJSONContainer[n.containerProperty]=r}if(!n.trueItemKey){return}}if(n.index>=0){this._oJSONContainer.PersContainerItems[n.index].value=r;return}this._oJSONContainer.PersContainerItems.push({value:r,id:n.trueItemKey,category:n.category,containerId:this._sContainerKey,containerCategory:this._category})};h.prototype.delItem=function(e){var t=this._locateItem(e);if(t.containerProperty===" ignore"){return}if(t.containerProperty){this._oJSONContainer[t.containerProperty]=t.initialValue;return}if(t.index>=0){this._oJSONContainer.PersContainerItems.splice(t.index,1);return}};h.prototype._determineCategory=function(e){if(!e){return"U"}var t=i;if(e.keyCategory&&e.keyCategory===t.keyCategory.FIXED_KEY&&e.writeFrequency&&e.writeFrequency===t.writeFrequency.LOW&&e.clientStorageAllowed&&e.clientStorageAllowed===true){return"P"}return"U"};return h});
//# sourceMappingURL=AdapterContainer.js.map