// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["./abap.bootstrap.utils","sap/base/util/ObjectPath","sap/base/Log"],function(e,t,o){"use strict";var i="sap-ushell-reloaded";function r(e,t){this._oWindow=e||window;this._sXhrLogonMode=t;this._bPending=false}r.prototype.handleEvent=function(e){if(this._bPending){return true}if(e.type==="logon"){this._bPending=true;if(this._sXhrLogonMode==="logoffAndRedirect"){this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._logoffAndRedirect,this._handleAuthenticationRequiredNoUi5.bind(this))}else{this._showErrorAndReload({key:"bootstrap.xhr.authenticationRequired",text:"Authentication required"},{key:"bootstrap.xhr.sessionExpired",text:"Your session has expired. Press OK to reload."},this._reloadPage,this._handleAuthenticationRequiredNoUi5.bind(this))}}else{o.error("Cannot handle event with type: "+e.type,null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}return true};r.prototype._getUpdatedLocationSearchForReload=function(e){var t=Date.now(),o=new RegExp(["(.*)([?&])",i,"(=[^&]*)?(.*)"].join("")),r,n=false;if(typeof e!=="string"){throw new Error("Illegal argument: sCurrentLocationSearch must be a string")}r=e.replace(o,function(e,o,r,a,s){n=true;return[o,r,i,"=",t,s].join("")});if(!n){if(e){r=[e,"&",i,"=",t].join("")}else{r=["?",i,"=",t].join("")}}return r};r.prototype._reloadPage=function(){var e=this;e._oWindow.setTimeout(function(){e._oWindow.location.search=e._getUpdatedLocationSearchForReload(e._oWindow.location.search)},0)};r.prototype._logoffAndRedirect=function(){var o=e.getLocationHref(),i=t.get("sap-ushell-config.services.Container.adapter.config.client"),r;r=new URI("/sap/public/bc/icf/logoff").absoluteTo(o).search("sap-client="+i+"&propagateLogoff=false&redirectURL="+encodeURIComponent(o)).toString();document.location=r};r.prototype._isPageReloaded=function(){return new RegExp(["[?&]",i].join("")).test(this._oWindow.location.search)};r.prototype._handleAuthenticationRequiredNoUi5=function(e){if(!this._isPageReloaded()){o.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized. "+"This should not happen if the FioriLaunchpad.html page is loaded from the server. Trying to reload page once.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler");var t="Authentication required\n\nYour session might have expired. Press OK to reload.";this._oWindow.alert(t);e.call(this)}else{o.error("Illegal state: XHR authentication (mode=reload) requested before SAPUI5 is initialized and page reload has been triggered once."+" Stopping reload to avoid endless loop. This state cannot be overcome. Please ensure that the FioriLaunchpad.html"+" page is not cached, but always loaded from the server.",null,"sap.ushell_abap.bootstrap.evo.XhrLogonEventHandler")}};r.prototype._showErrorAndReload=function(e,t,o,i){var r;var n;if(sap.ui.require("sap/ui/core/Core")&&sap.ui.require("sap/m/MessageBox")){var a=sap.ui.require("sap/m/MessageBox");var s=a.Action;var d=a.Icon;const i=sap.ui.require("sap/ushell/resources");if(i){r=this._getText(e,i);n=this._getText(t,i)}if(sap.ui.require("sap/ui/core/BusyIndicator")){var l=sap.ui.require("sap/ui/core/BusyIndicator");if(typeof l.show==="function"&&typeof l.hide==="function"){l.hide();l.show=function(){}}}a.show(n,{icon:d.ERROR,title:r,actions:[s.OK],onClose:o.bind(this)})}else{i.call(this,o)}};r.prototype._getText=function(e,t){const o=t.i18n.getText(e.key);if(o&&o!==e.key){return o}return e.text};return r},true);
//# sourceMappingURL=XhrLogonEventHandler.js.map