/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/m/Button","sap/m/CheckBox","sap/m/Input","sap/m/Label","sap/m/MessageBox","sap/m/MessageStrip","sap/m/MessageToast","sap/m/Toolbar","sap/m/VBox","sap/m/library","sap/ui/core/EventBus","sap/ui/core/message/MessageType","sap/ui/layout/form/SimpleForm","sap/ui/unified/FileUploader","sap/ushell/Container","./BaseSettingsPanel","./flexibility/Layout.flexibility","./utils/Constants","./utils/HttpHelper"],function(e,t,s,n,i,o,a,r,l,d,g,h,c,u,p,w,m,F,y){"use strict";function N(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function S(e,t){try{var s=e()}catch(e){return t(e)}if(s&&s.then){return s.then(void 0,t)}return s}const U=N(w);const C=m["CHANGE_TYPES"];const f=F["KEYUSER_SETTINGS_PANELS_KEYS"];const P=N(y);const _={NEWS_FEED_POST_API:"/sap/opu/odata4/ui2/insights_srv/srvd/ui2/"+"insights_repo_srv/0001/"+"NEWS_FEED"};const b=U.extend("sap.cux.home.KeyUserNewsSettingsPanel",{metadata:{library:"sap.cux.home"},init:function e(){U.prototype.init.call(this);this.controlMap=new Map;this.setProperty("key",f.NEWS);this.setProperty("title",this._i18nBundle.getText("editNewsFeed"));this.addAggregation("content",this.getContent());this.attachPanelNavigated(()=>this.loadSettings());this._eventBus=g.getInstance();this._eventBus.subscribe("KeyUserChanges","newsFeedLoadFailed",(e,t,s)=>{if(s?.showError){this.showMessageStrip(true,h.Warning,"invalidNewsUrl");this.validChanges=false}else{this.getMessageStrip().setVisible(false);this.validChanges=true}},this)},getCurrentKeyUserChange:function e(){const t=this.getKeyUserChanges();const s=t.find(e=>e.changeSpecificData.changeType===C.NEWS_FEED_URL);return s?.changeSpecificData.content},getContent:function e(){const t=`${this.getId()}-wrapperVBox`;const s=new l(t);this.controlMap.set(t,s);return s},isValidChanges:function e(t){try{const s=this;function n(){return s.validChanges}s.validChanges=true;const o=s.getFileUploader();const a=s.getCurrentKeyUserChange();const r=s.customNewsVisibility===undefined?Boolean(s._getPanel().getProperty("showCustom")):s.customNewsVisibility;const l=function(){if(s.getNewsFeedUploadBtn().getEnabled()){if(r){i.error(String(s._i18nBundle.getText("newsFeedSaveUploadChanges")));s.validChanges=false}else{if(o){o.setValue(a.customNewsFeedFileName||String(s._getPanel().getProperty("customFileName")))}}}else{const e=function(){if(r&&o.getValue()===""&&t){s.showMessageStrip(true,h.Error,"noNewsFileError");s.validChanges=false}else{const e=function(){if(!r&&t&&!s.getMessageStrip().getVisible()){const e=a.newsFeedURL;return Promise.resolve(s._getPanel().setURL(String(e))).then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();return Promise.resolve(l&&l.then?l.then(n):n(l))}catch(d){return Promise.reject(d)}},clearNewsPanelChanges:function e(){const t=this._getPanel();this.getMessageStrip().setVisible(false);const s=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);s.setValue(String(t.getProperty("url")));this.customNewsVisibility=Boolean(t.getProperty("showCustom"));this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(this.customNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(!this.customNewsVisibility);this.controlMap.get(`${this.getId()}-customNewsFeedCheckBox`).setSelected(this.customNewsVisibility);this.getFileUploader().setValue(String(t.getProperty("customFileName")));this.clearKeyUserChanges()},addMessageStrip:function e(t){const s=`${this.getId()}-keyUserNewsPanelToolbar`;if(!this.controlMap.get(s)){const e=new r(s,{height:"auto"});const t=new l(`${this.getId()}-messageStripWrapper`,{width:"100%"});const n=`${this.getId()}-messageStrip`;const i=new o(n,{showIcon:true,visible:false});this.controlMap.set(n,i);t.addItem(i);e.addContent(t);this.controlMap.set(s,e)}t.addItem(this.controlMap.get(s))},handleSelectCustomNewsFeed:function e(t){this.customNewsVisibility=t.getSource().getSelected();this.controlMap.get(`${this.getId()}-customNewsUploadFileUploader`).setEnabled(this.customNewsVisibility);this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setEnabled(!this.customNewsVisibility);const s=this._getPanel();const n=s.getParent();const i=n.getParent();const o=this.getCurrentKeyUserChange();if(!o){this.addKeyUserChanges({selectorControl:i,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:Boolean(this._getPanel().getProperty("showCustom")),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),newsFeedURL:String(this._getPanel().getProperty("url")),showCustomNewsFeed:this.customNewsVisibility,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName"))}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(o.showCustomNewsFeed!==this.customNewsVisibility){o.showCustomNewsFeed=this.customNewsVisibility}this.removeUrlMesageStrip();this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date})},addCustomNewsFeedCheckBox:function e(s){const n=`${this.getId()}-customNewsFeedCheckBox`;if(!this.controlMap.get(n)){const e=new t(`${this.getId()}-customNewsFeedCheckBox`,{text:this._i18nBundle.getText("selectCustomNewsFeed"),selected:Boolean(this._getPanel().getProperty("showCustom")),select:this.handleSelectCustomNewsFeed.bind(this)}).addStyleClass("sapUiTinyMargin");this.controlMap.set(n,e)}else if(!this.getCurrentKeyUserChange()){this.controlMap.get(`${this.getId()}-customNewsFeedCheckBox`).setSelected(Boolean(this._getPanel().getProperty("showCustom")))}s.addItem(this.controlMap.get(n))},onNewsUrlChange:function e(t){const s=this._getPanel();const n=s.getParent();const i=n.getParent();let o=t.getParameter("value");const a=this.getCurrentKeyUserChange();const r=this.getValidURL(String(o));if(!r){return}else{o=r}if(!a){this.addKeyUserChanges({selectorControl:i,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(this._getPanel().getProperty("url")),oldShowCustomNewsFeed:Boolean(this._getPanel().getProperty("showCustom")),oldCustomNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),newsFeedURL:o,showCustomNewsFeed:false,customNewsFeedKey:String(this._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(this._getPanel().getProperty("customFileName"))}}});this._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:this.getKeyUserChanges()})}else if(a.newsFeedURL!==o){a.newsFeedURL=o;a.showCustomNewsFeed=false}},showMessageStrip:function e(t,s,n){this.getMessageStrip().setType(s);this.getMessageStrip().setVisible(t);this.getMessageStrip().setText(String(this._i18nBundle.getText(n)));if(s===h.Error){this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:t,date:new Date})}},getValidURL:function e(t){try{const e=new URL(t);return e.href}catch{return""}},removeUrlMesageStrip:function e(){this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date});this.getMessageStrip().setVisible(false);const t=this.controlMap.get(`${this.getId()}-newsFeedURLInput`);if(!this.getValidURL(t.getValue())){t.setValue("")}},onUrlLiveChange:function e(t){const s=t.getParameter("value")||"";this.showMessageStrip(!this.getValidURL(s),h.Error,"invalidNewsUrl")},getMessageStrip:function e(){const t=`${this.getId()}-messageStrip`;return this.controlMap.get(t)},addNewsURLSimpleForm:function e(t){const i=`${this.getId()}-newsFeedURLSimpleForm`;if(!this.controlMap.get(i)){const e=new c(`${this.getId()}-newsFeedURLSimpleForm`,{content:[new n(`${this.getId()}-newsFeedURLLabel`,{text:this._i18nBundle.getText("editNewsURL")})]}).addStyleClass("sapContrastPlus");const t=`${this.getId()}-newsFeedURLInput`;const o=new s(t,{value:String(this._getPanel().getProperty("url")),type:d.InputType.Url,change:this.onNewsUrlChange.bind(this),liveChange:this.onUrlLiveChange.bind(this),enabled:!this._getPanel().getProperty("showCustom")});this.controlMap.set(t,o);e.addContent(o);this.controlMap.set(i,e)}else if(this.getCurrentKeyUserChange()){this.controlMap.get(`${this.getId()}-newsFeedURLInput`).setValue(String(this._getPanel().getProperty("url")))}t.addItem(this.controlMap.get(i))},handleFileChange:function e(t){const s=t.getSource();this.getMessageStrip().setVisible(false);this._eventBus.publish("KeyUserChanges","disabledSaveBtn",{disable:false,date:new Date});this.setNewsFeedEnabled(s.getValue()!=="")},setNewsFeedEnabled:function e(t){const s=this.getNewsFeedUploadBtn();if(s){s.setEnabled(t)}},getNewsFeedUploadBtn:function e(){const t=`${this.getId()}-customNewsUploadFileUploaderButton`;return this.controlMap.get(t)},handleFileUploadError:function e(t){const s=t.getSource();const n=s.getMaximumFileSize();this.setNewsFeedEnabled(false);i.error(String(this._i18nBundle.getText("newsFeedMaxFileSizeError",[n])))},handleFileDialogClose:function e(t){const s=t.getSource();let n=s.getValue();if(n===""){n=this.getCurrentKeyUserChange()?.customNewsFeedFileName||String(this._getPanel().getProperty("customFileName"));this.setNewsFeedEnabled(false)}s.setValue(n)},handleNewsFeedFileUpload:function e(){try{const e=this;let t=e._i18nBundle.getText("newsFeedFileUploadError");return Promise.resolve(S(function(){return Promise.resolve(Promise.all([e.getUploadedFile(),p.getServiceAsync("UserInfo")])).then(function(s){const n=s[0];const i=s[1];const o=i&&i.getId();const r={changeId:o+"_"+Date.now().toString(),attachment:n.content};if(n.type){r.documentType=n.type}return Promise.resolve(P.Post(_.NEWS_FEED_POST_API,r)).then(function(s){const n=e.getCurrentKeyUserChange();const i=e._getPanel();const o=i.getParent();const r=o.getParent();if(s&&s.error){e.getFileUploader().setValue("");if(n){n.customNewsFeedFileName=""}else{e.addKeyUserChanges({selectorControl:r,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(e._getPanel().getProperty("url")),oldShowCustomNewsFeed:Boolean(e._getPanel().getProperty("showCustom")),oldCustomNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),newsFeedURL:String(e._getPanel().getProperty("url")),showCustomNewsFeed:true,customNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),customNewsFeedFileName:String(e._getPanel().getProperty("customFileName"))}}})}t=s.error.message.includes("NODATA")?e._i18nBundle.getText("newsFeedEmptyFileError"):t;throw new Error(t)}const l=s.changeId;if(n){n.customNewsFeedKey=l;n.customNewsFeedFileName=e.getFileUploader().getValue()}else{e.addKeyUserChanges({selectorControl:r,changeSpecificData:{changeType:C.NEWS_FEED_URL,content:{oldNewsFeedUrl:String(e._getPanel().getProperty("url")),oldShowCustomNewsFeed:Boolean(e._getPanel().getProperty("showCustom")),oldCustomNewsFeedKey:String(e._getPanel().getProperty("customFeedKey")),newsFeedURL:String(e._getPanel().getProperty("url")),showCustomNewsFeed:true,customNewsFeedKey:l,customNewsFeedFileName:e.getFileUploader().getValue()}}});e._eventBus.publish("KeyUserChanges","addNewsPagesChanges",{changes:e.getKeyUserChanges()})}a.show(String(e._i18nBundle.getText("customNewsFeedUploaded")));e.setNewsFeedEnabled(false)})})},function(t){i.error(t.message);e.setNewsFeedEnabled(false)}))}catch(e){return Promise.reject(e)}},getUploadedFile:function e(){return new Promise((e,t)=>{const s=this.getFileUploader();let n=this._i18nBundle.getText("newsFeedFileUploadError");if(s&&!s.getValue()){n=this._i18nBundle.getText("noNewsFileError");t(new Error(n))}const i=s.oFileUpload.files[0];const o=new FileReader;o.onload=function(){try{const t=o.result;let s;const n={type:"",content:""};if(i.type==="text/csv"){s=window.btoa(encodeURIComponent(String(t)).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt(t,16))}));n.type="CSV"}else{s=t.replace("data:","").replace(/^.+,/,"")}n.content=s;e(n)}catch{t(new Error(n))}};if(i.type==="text/csv"){o.readAsText(i)}else{o.readAsDataURL(i)}})},getFileUploader:function e(){const t=`${this.getId()}-customNewsUploadFileUploader`;return this.controlMap.get(t)},addCustomNewsUploadSimpleForm:function t(s){const i=`${this.getId()}-customNewsUploadSimpleForm`;if(!this.controlMap.get(i)){const t=new c(`${this.getId()}-customNewsUploadSimpleForm`,{content:[new n(`${this.getId()}-customNewsUploadLabel`,{text:this._i18nBundle.getText("customNewsFeed")})]}).addStyleClass("sapContrastPlus");const s=new l(`${this.getId()}-customNewsUploadVBox`);const o=`${this.getId()}-customNewsUploadFileUploader`;const a=this._getPanel();const r=new u(o,{name:"newsFeedFileUploader",tooltip:this._i18nBundle.getText("uploadNewsFeedFile"),fileType:a?.getProperty("supportedFileFormats"),width:"100%",change:this.handleFileChange.bind(this),maximumFileSize:25,fileSizeExceed:this.handleFileUploadError.bind(this),sameFilenameAllowed:true,afterDialogClose:this.handleFileDialogClose.bind(this),value:String(this._getPanel().getProperty("customFileName")),enabled:this._getPanel().getProperty("showCustom")});this.controlMap.set(o,r);const d=`${this.getId()}-customNewsUploadFileUploaderButton`;const g=new e(d,{text:this._i18nBundle.getText("uploadNewsFeedBtn"),press:this.handleNewsFeedFileUpload.bind(this),type:"Emphasized",enabled:false});this.controlMap.set(d,g);s.addItem(r);s.addItem(g);t.addContent(s);this.controlMap.set(i,t)}s.addItem(this.controlMap.get(i))},loadSettings:function e(){const t=`${this.getId()}-wrapperVBox`;const s=this.controlMap.get(t);s.removeAllItems();this.addMessageStrip(s);this.addCustomNewsFeedCheckBox(s);this.addNewsURLSimpleForm(s);this.addCustomNewsUploadSimpleForm(s)}});return b});
//# sourceMappingURL=KeyUserNewsSettingsPanel.js.map