/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/m/Button","sap/m/CustomListItem","sap/m/ExpandableText","sap/m/FlexBox","sap/m/GenericTile","sap/m/HBox","sap/m/Label","sap/m/library","sap/m/MessageToast","sap/m/Text","sap/m/VBox","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/model/resource/ResourceModel","sap/ushell/Container","./AppsContainer","./BaseSettingsPanel","./FavAppPanel","./utils/AppManager","./utils/Constants"],function(e,t,n,r,s,i,o,a,u,c,l,p,d,h,f,g,m,P,A,y,v){"use strict";function S(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function T(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const _=u["ButtonType"];function C(e,t){try{var n=e()}catch(e){return t(true,e)}if(n&&n.then){return n.then(t.bind(null,false),t.bind(null,true))}return t(false,n)}const x=S(m);const I=typeof Symbol!=="undefined"?Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator")):"@@iterator";function b(e,t,n){if(!e.s){if(n instanceof w){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=b.bind(null,e,t);return}}if(n&&n.then){n.then(b.bind(null,e,t),b.bind(null,e,2));return}e.s=t;e.v=n;const r=e.o;if(r){r(e)}}}const w=function(){function e(){}e.prototype.then=function(t,n){const r=new e;const s=this.s;if(s){const e=s&1?t:n;if(e){try{b(r,1,e(this.v))}catch(e){b(r,2,e)}return r}else{return this}}this.o=function(e){try{const s=e.v;if(e.s&1){b(r,1,t?t(s):s)}else if(n){b(r,1,n(s))}else{b(r,2,s)}}catch(e){b(r,2,e)}};return r};return e}();function B(e){return e instanceof w&&e.s&1}function E(e,t,n){var r=-1,s,i;function o(a){try{while(++r<e.length&&(!n||!n())){a=t(r);if(a&&a.then){if(B(a)){a=a.v}else{a.then(o,i||(i=b.bind(null,s=new w,2)));return}}}if(s){b(s,1,a)}else{s=a}}catch(e){b(s||(s=new w),2,e)}}o();return s}const D=S(P);function F(e,t,n){if(typeof e[I]==="function"){var r=e[I](),s,i,o;function l(e){try{while(!(s=r.next()).done&&(!n||!n())){e=t(s.value);if(e&&e.then){if(B(e)){e=e.v}else{e.then(l,o||(o=b.bind(null,i=new w,2)));return}}}if(i){b(i,1,e)}else{i=e}}catch(e){b(i||(i=new w),2,e)}}l();if(r.return){var a=function(e){try{if(!s.done){r.return()}}catch(e){}return e};if(i&&i.then){return i.then(a,function(e){throw a(e)})}a()}return i}if(!("length"in e)){throw new TypeError("Object is not iterable")}var u=[];for(var c=0;c<e.length;c++){u.push(e[c])}return E(u,function(e){return t(u[e])},n)}const M=S(A);const z=S(y);const L=v["AI_APP_FINDER_API"];const N=v["AI_APP_FINDER_BASE_URL"];const R=v["CONTENT_ADDITION_PANEL_TYPES"];const j=v["FEATURE_TOGGLES"];const V={DeprecatedInfoText:"deprecated",MinQueryLength:5,MaxDescriptionLength:400};var k=function(e){e["Idle"]="idle";e["Searching"]="searching";e["Complete"]="complete";return e}(k||{});var $=function(e){e["NoResultsFound"]="noResultsFound";e["ServiceError"]="serviceError";e["ValidationError"]="validationError";e["DefaultError"]="defaultError";return e}($||{});var O=function(e){e["Static"]="STATIC";return e}(O||{});const U=D.extend("sap.cux.home.AppsAdditionPanel",{constructor:function e(){D.prototype.constructor.apply(this,arguments);this.appManagerInstance=z.getInstance()},init:function e(){D.prototype.init.call(this);this.userSelectedApps=new Set;this.setProperty("key",R.AI_APP_FINDER);this.setProperty("title",this._i18nBundle.getText("addAppsAndTile"));this._setupActions();void this._setupContent();this.attachEvent("onDialogClose",this.resetPanel.bind(this))},_setupActions:function e(){this.addAppsButton=new t(`${this.getId()}-add-app-btn`,{text:this._i18nBundle.getText("addFromInsightsDialogBtn"),type:_.Emphasized,press:()=>{void this.onPressAddApps()}});this.addAppsButton.bindProperty("enabled",{parts:["/hasError","/searchStatus","/userSelectedApps"],formatter:(e,t,n)=>!e&&t===k.Complete&&n.length>0});this.addActionButton(this.addAppsButton)},_setupContent:function e(){try{const e=this;return Promise.resolve(g.getServiceAsync("VisualizationInstantiation")).then(function(t){e.vizInstantiationService=t;return Promise.resolve(d.load({id:`${e.getId()}-content`,name:"sap.cux.home.utils.fragment.appsAdditionContent",controller:e})).then(function(t){const n=t;e.addAggregation("content",n);e.model=new h({query:"",hasError:false,errorType:$.DefaultError,errorDescription:"",searchStatus:k.Idle,loadingAnimation:e._generateSearchingAnimation(),suggestedAppsCount:0,userSelectedApps:[],suggestedApps:[]});n.setModel(e.model);n.setModel(new f({bundleName:"sap.cux.home.i18n.messagebundle"}),"i18n");e.addAppsButton.setModel(e.model);e.appSuggestionList=d.byId(`${e.getId()}-content`,"appsList");e.appSuggestionList.bindAggregation("items",{path:"/suggestedApps",factory:e._generateListItem.bind(e)})})})}catch(e){return Promise.reject(e)}},_generateListItem:function e(t,r){const i=new n(t,{selected:r.getProperty("addedToHomePage"),content:[new s(`${t}-result-container`,{renderType:"Bare",wrap:"Wrap",direction:r.getProperty("isStaticApp")?"Column":"Row",alignItems:r.getProperty("isStaticApp")?"Start":"Center",items:[this._getAppPreviewContainer(t,r),this._getAppDetailsContainer(t,r)]}).addStyleClass("sapUiSmallMargin")]});i.getMultiSelectControl(true).setEnabled(!r.getProperty("addedToHomePage"));return i},_getAppPreviewContainer:function e(t,n){const r=new o(`${t}-suggestedAppContainer`,{renderType:"Bare"});if(n.getProperty("isStaticApp")){r.addItem(new i(`${t}-staticApp`,{mode:"IconMode",frameType:"TwoByHalf",header:n.getProperty("title"),subheader:n.getProperty("subTitle"),tileIcon:n.getProperty("icon"),visible:n.getProperty("isStaticApp")}).addStyleClass("suggestedTile"))}else{const e=this.vizInstantiationService.instantiateVisualization(n.getProperty("vizData"));e?.setActive(true);e.setClickable(false);r.addItem(e)}return r},_getAppDetailsContainer:function e(t,n){return new p(`${t}-app-details-container`,{renderType:"Bare",gap:"0.5rem",items:[new a(`${t}-descriptionLabel`,{text:this._i18nBundle.getText("appDescription"),showColon:true}),new r(`${t}-description`,{text:n.getProperty("description"),maxCharacters:V.MaxDescriptionLength}),new o(`${t}-app-status-container`,{renderType:"Bare",visible:n.getProperty("status").length>0,items:[new a(`${t}-appStatusLabel`,{text:this._i18nBundle.getText("appStatus"),showColon:true}),new o(`${t}-app-status-texts`,{renderType:"Bare",items:this._generateStatusTexts(n.getProperty("status"))}).addStyleClass("sapUiTinyMarginBegin statusTextsContainer")]})]}).addStyleClass(n.getProperty("isStaticApp")?"sapUiSmallMarginTop":"sapUiSmallMarginBegin")},isSupported:function t(){try{const n=this;function r(){if(!n.isPanelSupported){n.removeActionButton(n.addAppsButton);const e=n.getParent();e.removePanel(n);e.updateActionButtons()}return n.isPanelSupported}const s=function(){if(n.isPanelSupported===undefined){n.isPanelSupported=false;const t=function(){if(n.getFavAppPanel()){const t=T(function(){return Promise.resolve(n.appManagerInstance.isFeatureEnabled(j.AI_SMART_APPFINDER)).then(function(e){const t=function(){if(e){return Promise.resolve(g.getServiceAsync("Navigation")).then(function(e){return Promise.resolve(e.isNavigationSupported([{target:{semanticObject:"IntelligentPrompt",action:"propose"}}])).then(function(e){let[{supported:t}]=e;n.isPanelSupported=t})})}}();if(t&&t.then)return t.then(function(){})})},function(t){e.error(t.message)});if(t&&t.then)return t.then(function(){})}}();if(t&&t.then)return t.then(function(){})}}();return Promise.resolve(s&&s.then?s.then(r):r(s))}catch(i){return Promise.reject(i)}},_generateSearchingAnimation:function e(){return`<svg height="210" fill="none">\n            <g>\n                <rect height="210" rx="4" fill="white"/>\n                <rect x="16" y="143" width="90%" height="8" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n                <rect x="16" y="103" width="84%" height="32" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n                <rect x="16" y="33" width="90%" height="8" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n                <rect x="16" y="16" width="96%" height="12" rx="4" fill="var(--sapContent_Placeholderloading_Background)"/>\n            </g>\n        </svg>`},resetPanel:function e(){const t={query:"",hasError:false,searchStatus:k.Idle,suggestedAppsCount:0,userSelectedApps:[],suggestedApps:[]};this.model.setData({...this.model.getData(),...t});this.userSelectedApps.clear()},onPressGo:function t(n){try{const t=this;if(n.getParameter("clearButtonPressed")){t.resetPanel();return Promise.resolve()}const r=t.model.getProperty("/query");if(!t.isValidQuery(r))return Promise.resolve();const s=C(function(){return T(function(){t.model.setProperty("/hasError",false);t.model.setProperty("/searchStatus",k.Searching);t.appSuggestionList.removeSelections(true);return Promise.resolve(t.fetchAppsFromSearch(r)).then(function(e){const n=function(){if(e.length>0&&t.model.getProperty("/searchStatus")===k.Searching){return Promise.resolve(t.fetchAllAvailableVisualizations()).then(function(n){return Promise.resolve(t.appManagerInstance.fetchFavVizs(true,true)).then(function(r){return Promise.resolve(t.appManagerInstance.fetchInsightApps(true,t._i18nBundle.getText("insights"))).then(function(s){const i=t._generateApps(e,n,[...r,...s]);return Promise.resolve(t._filterUnsupportedApps(i)).then(function(e){t.model.setProperty("/suggestedApps",e);t.model.setProperty("/suggestedAppsCount",e.length)})})})})}}();if(n&&n.then)return n.then(function(){})})},function(n){e.error(n.message);t._handleError()})},function(e,n){if(t.model.getProperty("/searchStatus")===k.Searching){t.model.setProperty("/searchStatus",k.Complete)}if(e)throw n;return n});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},_filterUnsupportedApps:function e(t){try{const e=t.map(e=>e.vizData?.target)||[];return Promise.resolve(g.getServiceAsync("Navigation")).then(function(n){return Promise.resolve(n.isNavigationSupported(e)).then(function(e){return t.filter((t,n)=>e[n])})})}catch(e){return Promise.reject(e)}},_generateApps:function e(t,n,r){return t.map(e=>{const t=n.find(t=>t.vizId===e.chipID);const s=r.some(t=>t.visualization?.vizId===e.chipID);return{title:e.title,chipID:e.chipID,subTitle:e.subTitle,description:e.appDescription,icon:e.iconUrl,vizData:t,addedToHomePage:s,isStaticApp:e.tileType===O.Static,status:this.getAppStatusTexts(e.configuration,s)}})},isValidQuery:function e(t){return Boolean(t?.trim()&&t.trim().length>=V.MinQueryLength)},fetchAllAvailableVisualizations:function e(){try{const t=this;function n(){return t.allAvailableVisualizations}const r=function(){if(!t.allAvailableVisualizations){return Promise.resolve(g.getServiceAsync("SearchableContent")).then(function(e){return Promise.resolve(e.getApps({enableVisualizationPreview:false})).then(function(e){t.allAvailableVisualizations=e.reduce((e,t)=>e.concat(t.visualizations),[])})})}}();return Promise.resolve(r&&r.then?r.then(n):n(r))}catch(s){return Promise.reject(s)}},_fetchCSRFToken:function t(){try{return Promise.resolve(T(function(){return Promise.resolve(fetch(N,{method:"GET",headers:{"X-CSRF-Token":"Fetch"}})).then(function(e){return e.headers.get("X-CSRF-Token")})},function(t){e.error("Failed to fetch CSRF token",t);return null}))}catch(e){return Promise.reject(e)}},fetchAppsFromSearch:function t(n){try{const t=this;return Promise.resolve(T(function(){return Promise.resolve(t._fetchCSRFToken()).then(function(e){const r={"Content-Type":"application/json",...e&&{"X-CSRF-Token":e}};return Promise.resolve(fetch(L,{method:"POST",headers:r,body:JSON.stringify({UserInput:n})})).then(function(e){let n=false;function r(t){return n?t:Promise.resolve(e.json()).then(function(e){const t=e;return t.value||[]})}const s=function(){if(!e.ok){return Promise.resolve(e.json()).then(function(e){const r=e;t._handleError(r.error?.message||"");const s=[];n=true;return s})}}();return s&&s.then?s.then(r):r(s)})})},function(n){e.error(n.message);t._handleError();return[]}))}catch(e){return Promise.reject(e)}},getAppStatusTexts:function t(n,r){let s=[];if(r){s.push(this._i18nBundle.getText("alreadyAddedApp"))}if(n){try{const e=JSON.parse(n);const t=JSON.parse(e?.tileConfiguration);const r=(t?.display_info_text||"").toLowerCase();if(r===V.DeprecatedInfoText){s.push(this._i18nBundle.getText("deprecatedApp"))}}catch(t){e.warning(t.message)}}return s},_generateStatusTexts:function e(t){return t.map(e=>new l({text:this._i18nBundle.getText(e)}).addStyleClass(this.applyStatusClass(e)))},applyStatusClass:function e(t){if(t===this._i18nBundle.getText("alreadyAddedApp")){return"addedAppStatusText"}else if(t===this._i18nBundle.getText("deprecatedApp")){return"deprecatedAppStatusText"}else{return""}},onPressAddApps:function e(){try{const t=this;function n(){return Promise.resolve(t.refreshFavoriteApps()).then(function(){t.getParent().close();c.show(t._i18nBundle.getText("appAddedToFavorites"));t.resetPanel()})}const r=t.model.getProperty("/userSelectedApps");const s=r.map(e=>e.getBindingContext()?.getProperty("chipID"));const i=F(s,function(e){return Promise.resolve(t.appManagerInstance.addVisualization(e)).then(function(){})});return Promise.resolve(i&&i.then?i.then(n):n(i))}catch(o){return Promise.reject(o)}},getAppsContainer:function e(){const t=this.getParent()?.getParent();return t.getContent().find(e=>e instanceof x)},getFavAppPanel:function e(){return this.getAppsContainer()?.getContent().find(e=>e instanceof M)},refreshFavoriteApps:function e(){try{const e=this;return Promise.resolve(e.getAppsContainer()?.refreshPanel(e.getFavAppPanel())).then(function(){})}catch(e){return Promise.reject(e)}},onListSelectionChange:function e(t){const n=t.getParameter("listItem");const r=t.getParameter("selected");if(!r)this.userSelectedApps.delete(n);else{const e=n.getBindingContext();const t=e?.getProperty("addedToHomePage");if(!t)this.userSelectedApps.add(n)}this.model.setProperty("/userSelectedApps",Array.from(this.userSelectedApps))},_handleError:function e(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";const[,n,r]=t.match(/\((\d{2})\d*\)\s*(.*)/)||[];this.model.setProperty("/hasError",true);this.model.setProperty("/errorType",this._getErrorType(n));this.model.setProperty("/errorDescription",r||"")},_getErrorType:function e(){let t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";switch(t){case"10":return $.ServiceError;case"20":case"40":return $.NoResultsFound;case"30":return $.ValidationError;default:return $.DefaultError}}});return U});
//# sourceMappingURL=AppsAdditionPanel.js.map