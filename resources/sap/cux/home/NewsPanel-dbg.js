/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *  * (c) Copyright 2009-2025 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/m/GenericTile","sap/m/SlideTile","sap/ui/core/EventBus","sap/ui/core/format/DateFormat","sap/ui/model/xml/XMLModel","sap/ushell/Container","./BaseNewsPanel","./MenuItem","./NewsGroup","./NewsItem","./library","./utils/Constants","./utils/DataFormatUtils","./utils/Device","./utils/FESRUtil","./utils/HttpHelper","./utils/PersonalisationUtils","./utils/UshellPersonalizer"],function(e,t,n,s,r,i,o,a,l,u,c,f,d,h,m,g,p,w,N){"use strict";function y(e){return e&&e.__esModule&&typeof e.default!=="undefined"?e.default:e}function v(e,t,n){if(!e.s){if(n instanceof P){if(n.s){if(t&1){t=n.s}n=n.v}else{n.o=v.bind(null,e,t);return}}if(n&&n.then){n.then(v.bind(null,e,t),v.bind(null,e,2));return}e.s=t;e.v=n;const s=e.o;if(s){s(e)}}}const F=y(a);const P=function(){function e(){}e.prototype.then=function(t,n){const s=new e;const r=this.s;if(r){const e=r&1?t:n;if(e){try{v(s,1,e(this.v))}catch(e){v(s,2,e)}return s}else{return this}}this.o=function(e){try{const r=e.v;if(e.s&1){v(s,1,t?t(r):r)}else if(n){v(s,1,n(r))}else{v(s,2,r)}}catch(e){v(s,2,e)}};return s};return e}();function T(e){return e instanceof P&&e.s&1}function b(e,t,n){var s;for(;;){var r=e();if(T(r)){r=r.v}if(!r){return i}if(r.then){s=0;break}var i=n();if(i&&i.then){if(T(i)){i=i.s}else{s=1;break}}if(t){var o=t();if(o&&o.then&&!T(o)){s=2;break}}}var a=new P;var l=v.bind(null,a,2);(s===0?r.then(c):s===1?i.then(u):o.then(f)).then(void 0,l);return a;function u(s){i=s;do{if(t){o=t();if(o&&o.then&&!T(o)){o.then(f).then(void 0,l);return}}r=e();if(!r||T(r)&&!r.v){v(a,1,i);return}if(r.then){r.then(c).then(void 0,l);return}i=n();if(T(i)){i=i.v}}while(!i||!i.then);i.then(u).then(void 0,l)}function c(e){if(e){i=n();if(i&&i.then){i.then(u).then(void 0,l)}else{u(i)}}else{v(a,1,i)}}function f(){if(r=e()){if(r.then){r.then(c).then(void 0,l)}else{c(r)}}else{v(a,1,i)}}}const C=y(l);function E(e,t){try{var n=e()}catch(e){return t(e)}if(n&&n.then){return n.then(void 0,t)}return n}const _=y(u);const S=y(c);const M=f["NewsType"];const A=d["DEFAULT_NEWS_URL"];const D=h["recycleId"];const I=m["DeviceType"];const U=g["addFESRId"];const L=y(p);const x=y(w);const R=y(N);const B="/sap/opu/odata4/ui2/insights_srv/srvd/ui2/",O=B+"insights_read_srv/0001/"+"NEWS_FEED",V=B+"insights_read_srv/0001/"+"NewsFeedColumnTranslation",j=7,$=function(e,t){return Array.from({length:t},function(t,n){return e+"/"+(n+1)+".jpg"})};const q={TITLE:"LineOfBusiness",LINK:"WhatsNewDocument",VALIDITY:"ValidAsOf",PREPARATION_REQUIRED:"PreparationRequired",EXCLUDE_FIELDS:["ChangeId","LineNumber","LineOfBusiness","SolutionArea","Title","Description","Type","ValidAsOf","WhatsNewDocument","Link"],IMAGE_URL:"sap/cux/home/img/CustomNewsFeed/",FESR_STEP_NAME:"custNewsSlide-press",EMPTY_DATA_ERROR_CODE:"NODATA"},J={"Application Platform and Infrastructure":$("ApplicationPlatformandInfrastructure",3),"Asset Management":$("AssetManagement",3),"Cross Applications":$("CrossApplications",3),Finance:$("Finance",3),Manufacturing:$("Manufacturing",3),"R&D / Engineering":$("RnDandEngineering",3),Sales:$("Sales",3),"Sourcing and Procurement":$("SourcingandProcurement",3),"Supply Chain":$("SupplyChain",3),default:["default.jpg"]};const W=F.extend("sap.cux.home.NewsPanel",{metadata:{library:"sap.cux.home",properties:{url:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},type:{type:"sap.cux.home.NewsType",group:"Misc",visibility:"public",defaultValue:M.RSS},customFeedKey:{type:"string",group:"Misc",defaultValue:"",visibility:"public"},customFileName:{type:"string",group:"Misc",defaultValue:""},showCustom:{type:"boolean",group:"Misc",defaultValue:false},newsAvailable:{type:"boolean",group:"Misc",defaultValue:true,visibility:"hidden"},supportedFileFormats:{type:"FileFormat[]",group:"Misc",defaultValue:["xlsx"],visibility:"hidden"}},aggregations:{newsGroup:{type:"sap.cux.home.NewsGroup",singularName:"newsGroup",multiple:true,visibility:"hidden"}}},constructor:function e(t,n){F.prototype.constructor.call(this,t,n);this._defaultNewsPromise=null;this.customNewsFeedCache=new Map},init:function e(){F.prototype.init.call(this);this.oNewsTile=new n(this.getId()+"--idNewsSlide",{displayTime:2e4,width:"100%",height:"17rem",tiles:[new t(this.getId()+"--placeholder",{state:"Loading",mode:"ArticleMode",frameType:"Stretch"})]}).addStyleClass("newsTileMaxWidth sapUiSmallMarginTop");U(this.oNewsTile,"newsSlidePress");this.getNewsWrapper().addContent(this.oNewsTile);this.getNewsWrapper().addStyleClass("newsWrapper");this.setProperty("title",this._i18nBundle.getText("newsTitle"));this._eventBus=s.getInstance();this.oManageMenuItem=new C(`${this.getId()}-manageNews`,{title:this._i18nBundle.getText("mngNews"),icon:"sap-icon://edit",press:this.handleEditNews.bind(this)});this.addAggregation("menuItems",this.oManageMenuItem);U(this.oManageMenuItem,"manageNews");let r=this.isURLParamEnabled("default-News");if(r){this.setUrl(A);this.setProperty("showCustom",false)}},isURLParamEnabled:function e(t){const n=new URLSearchParams(window.location.search);return n.get(t)?.toUpperCase()==="TRUE"},getData:function e(){try{const t=this;function n(){function e(){t.fireEvent("loaded");t.adjustLayout()}const n=function(){if(s&&s!==A&&!t.getProperty("showCustom")){return Promise.resolve(t.initializeXmlModel(s)).then(function(e){t.oNewsModel=e;t.oNewsTile.setModel(t.oNewsModel);t.oManageMenuItem.setVisible(false)})}else{const e=function(){if(s==A&&!t.getProperty("showCustom")){t.bNewsLoad=t.bNewsLoad||false;t.oManageMenuItem.setVisible(true);void t.setCustomNewsFeed("")}else{const e=function(){if(t.getProperty("showCustom")){t.bNewsLoad=t.bNewsLoad||false;t.oManageMenuItem.setVisible(true);const e=t.getCustomFeedKey();const n=function(){if(e){return Promise.resolve(t.setCustomNewsFeed(e)).then(function(){})}else{t.handleFeedError()}}();if(n&&n.then)return n.then(function(){})}else{t.handleFeedError()}}();if(e&&e.then)return e.then(function(){})}}();if(e&&e.then)return e.then(function(){})}}();return n&&n.then?n.then(e):e(n)}let s=t.getUrl();let r=t.isURLParamEnabled("default-News");t.mandatoryNewsFeed=[];const i=function(){if(!t.favNewsFeed){return Promise.resolve(t.setFavNewsFeed(r)).then(function(){})}}();return Promise.resolve(i&&i.then?i.then(n):n(i))}catch(o){return Promise.reject(o)}},getCurrentNewsGroup:function e(t){let n=this._defaultNews.value;let s=t.split("-");let r=s?.[s.length-1];let i=n.find(e=>e.group_id===r);return i},getCustomFeedKey:function e(){return this.getProperty("customFeedKey")},getUrl:function e(){return this.getProperty("url")},initializeXmlModel:function e(t){try{const e=this;const n=e.getParent();return Promise.resolve(new Promise(s=>{const r=new i(t);r.setDefaultBindingMode("OneWay");r.attachRequestCompleted(t=>{void function(){try{if(!e.bNewsLoad){n?.panelLoadedFn("News",{loaded:true,count:j});e.bNewsLoad=true}const i=t.getSource().getData();return Promise.resolve(e.loadNewsFeed(i,0)).then(function(){e._eventBus.publish("KeyUserChanges","newsFeedLoadFailed",{showError:false,date:new Date});s(r)})}catch(e){return Promise.reject(e)}}()});r.attachRequestFailed(()=>{e.handleFeedError();if(!e.bNewsLoad){n?.panelLoadedFn("News",{loaded:false,count:0});e.bNewsLoad=true}e._eventBus.publish("KeyUserChanges","newsFeedLoadFailed",{showError:true,date:new Date});s(r)})}))}catch(e){return Promise.reject(e)}},loadNewsFeed:function e(t,n){try{const s=this;function r(){if(!!t?.querySelector("rss")&&!!t?.querySelector("item")){i={path:"/channel/item/",length:n||j}}else if(!!t?.querySelector("atom")&&!!t?.querySelector("entry")){i={path:"/entry/",length:n||j}}else if((!!t?.querySelector("customFeed")||!!t?.querySelector("defaultFeed"))&&!!t?.querySelector("item")){s.destroyAggregation("newsItems");i={path:"/item/",length:n||j}}else{s.handleFeedError();return}s.bindNewsTile(s.oNewsTile,i)}let i;const o=function(){if(!t?.querySelector("customFeed")&&!t?.querySelector("defaultFeed")){return Promise.resolve(s.extractAllImageUrls(t,n||j)).then(function(){})}}();return Promise.resolve(o&&o.then?o.then(r):r(o))}catch(a){return Promise.reject(a)}},handleFeedError:function e(){if(this.getProperty("showCustom")||this.getUrl()===A){this.generateErrorMessage().setVisible(true);this.oNewsTile.setVisible(false)}else{(this.getNewsWrapper()?.getParent()).setVisible(false);this.setProperty("newsAvailable",false);this.oManageMenuItem.setVisible(false)}},setURL:function e(t){try{const e=this;e.setProperty("showCustom",false);e.setProperty("newsAvailable",true);e.generateErrorMessage().setVisible(false);(e.getNewsWrapper()?.getParent()).setVisible(true);e.oNewsTile.setVisible(true);e.setProperty("url",t);return Promise.resolve(e.getData()).then(function(){})}catch(e){return Promise.reject(e)}},adjustLayout:function e(){if(this.getDeviceType()===I.Mobile){this.oNewsTile.setHeight("11rem");this.generateErrorMessage().setWidth("100%");this.oNewsTile.removeStyleClass("sapUiSmallMarginTop")}else{this.oNewsTile.setHeight("17rem");(this.getNewsWrapper()?.getParent()).setWidth("100%")}},bindNewsTile:function e(t,n){if(n){if(!t.getBinding("tiles")){t.bindAggregation("tiles",{path:n.path,length:n.length,templateShareable:false,factory:(e,t)=>{const n=t.getObject();let s;if(n.getElementsByTagName("link").length>0){s=new S(D(`${e}-news-item`),{url:n.getElementsByTagName("link")[0].textContent,title:n.getElementsByTagName("title")[0].textContent,subTitle:n.getElementsByTagName("description")[0].textContent,imageUrl:n.getElementsByTagName("imageUrl")[0].textContent,footer:this.formatDate(n.getElementsByTagName("pubDate")[0].textContent)})}else{let t=n.getElementsByTagName("id")?.[0]?.textContent??"";let r=t?e+"-newsgroup-"+t:e+"-newsgroup";let i=n.getElementsByTagName("subTitle")?.[0]?.textContent??"";s=new _(D(r),{title:n.getElementsByTagName("title")[0].textContent,subTitle:i||this._i18nBundle.getText("newsFeedDescription"),imageUrl:n.getElementsByTagName("imageUrl")?.[0]?.textContent,footer:n.getElementsByTagName("footer")?.[0]?.textContent})}this.addAggregation("newsItems",s,true);return s.getTile()}})}}},extractAllImageUrls:function e(t,n){try{const e=this;let s=0;const r=b(function(){return s<n},function(){return s++},function(){const n=t?.getElementsByTagName("item")[s];return Promise.resolve(e.extractImage(n.getElementsByTagName("link")[0].textContent)).then(function(e){const s=t.createElement("imageUrl");s.textContent=e;n.appendChild(s)})});return Promise.resolve(r&&r.then?r.then(function(){}):void 0)}catch(e){return Promise.reject(e)}},formatDate:function e(t){const n=r.getDateTimeInstance({style:"medium",relative:true,relativeStyle:"short"});return n.format(new Date(t))},getFavNewsFeed:function e(){return this.favNewsFeed},extractImage:function e(t){const n=()=>{const e=sap.ui.require.toUrl("sap/cux/home/utils");this.image=this.image?this.image+1:1;this.image=this.image<9?this.image:1;return`${e}/imgNews/${this.image}.jpg`};return fetch(t).then(e=>e.text()).then(e=>{const t=e.match(/<meta[^>]*property=["']og:image["'][^>]*content=["']([^"']+)["'][^>]*>/i);return Array.isArray(t)&&t[1]?t[1]:n()}).catch(n)},isCSVFileFormat:function e(t){return t.split(".").pop()?.toLowerCase()==="csv"},setFavNewsFeed:function e(t){try{const e=this;return Promise.resolve(e._getUserPersonalization()).then(function(n){return Promise.resolve(n?.read()).then(function(n){e.favNewsFeed=t?n?.defaultNewsFeed:n?.favNewsFeed})})}catch(e){return Promise.reject(e)}},setCustomNewsFeed:function t(n){try{const t=this;return Promise.resolve(E(function(){t.oNewsTile.setVisible(true);t.generateErrorMessage().setVisible(false);return Promise.resolve(t.setFavNewsFeed(!n)).then(function(){function e(){if(i.length===0){throw new Error("Error: No news feed available")}if(t.favNewsFeed?.items?.length){i=i.filter(e=>t.favNewsFeed?.items.includes(e.title))}else if(t.favNewsFeed?.items?.length===0){t.getParent()?.panelLoadedFn("News",{loaded:true,count:0});throw new Error("Error: No fav news feed available")}return Promise.resolve(t.loadCustomNewsFeed(i,n?"customFeed":"defaultFeed")).then(function(){})}const s=t.getProperty("customFileName");const r=t.isCSVFileFormat(s)?false:t.favNewsFeed?.showAllPreparationRequired??true;if(t.isCSVFileFormat(s)){q.EXCLUDE_FIELDS.push("PreparationRequired")}let i;const o=function(){if(n){return Promise.resolve(t.getCustomNewsFeed(n,r)).then(function(e){i=e})}else{return Promise.resolve(t.getCustomNewsFeed("",true)).then(function(e){i=e})}}();return o&&o.then?o.then(e):e(o)})},function(n){e.error(n);t.handleFeedError()}))}catch(e){return Promise.reject(e)}},filterMandatoryNews:function e(t){return t.filter(e=>{const t=e.mandatory_text?.toUpperCase()==="TRUE";const n=e._group_to_article?.some(function(t){if(t.mandatory_text?.toUpperCase()==="TRUE"){e.mandatory_text="TRUE";return true}});return t||n})},getDefaultNewsFeedDetails:function e(t){let n=JSON.parse(JSON.stringify(t.value||[]));const s=[];const r={};this.mandatoryNewsFeed=[];if(n?.length>0){this.mandatoryNewsFeed=this.filterMandatoryNews(n).map(e=>e.title);for(const e of n){const t=e.title;let n="";if(!r[t]){n=e.subTitle||e.description||"";s.push({title:t,footer:e.footer_text,imageUrl:this.getDefaultFeedImage(e),id:e.group_id,subTitle:n||""});r[t]=t}}}return s},getMandatoryDefaultNewsFeed:function e(){return this.mandatoryNewsFeed||[]},getDefaultNewsResponse:function e(){if(this._defaultNews){return Promise.resolve(this._defaultNews)}if(!this._defaultNewsPromise){this._defaultNewsPromise=this.fetchDefaultNews()}return this._defaultNewsPromise},fetchDefaultNews:function t(){try{const t=this;return Promise.resolve(E(function(){return Promise.resolve(fetch(A)).then(function(e){if(!e.ok){throw new Error(`HTTP error! status: ${e.status}`)}return Promise.resolve(e.json()).then(function(e){t._defaultNews=e;return t._defaultNews})})},function(n){t._defaultNewsPromise=null;e.error(n);throw n}))}catch(e){return Promise.reject(e)}},getCustomNewsFeed:function e(t,n){try{const e=this;if(!t){return Promise.resolve(e.getDefaultNewsResponse()).then(function(){let t=e.getDefaultNewsFeedDetails(e._defaultNews);return t})}else{return Promise.resolve(e.getCustomFeedData(t,n))}}catch(e){return Promise.reject(e)}},getCustomFeedData:function t(n,s){try{const t=this;return Promise.resolve(E(function(){const e=t.getNewsFeedDetailsUrl({changeId:n,showAllPreparationRequired:s});if(!t.customNewsFeedCache.has(e)){t.customNewsFeedCache.set(e,t.getAuthNewsFeed(e))}return Promise.resolve(t.customNewsFeedCache.get(e)).then(function(e){const n=e;const s={};const r=[];if(n?.length>0){n.forEach(e=>{const n=e[q.TITLE];if(!s[n.value]){r.push({title:n.value,footer:e[q.VALIDITY].value,imageUrl:t.getCustomFeedImage(n.value)});s[n.value]=n.value}})}return r})},function(t){e.error(t);throw new Error(t)}))}catch(e){return Promise.reject(e)}},getNewsFeedDetailsUrl:function e(t){let n=O+"?$filter=ChangeId eq "+"'"+t.changeId+"'";const s=this.getProperty("customFileName");if(!this.isCSVFileFormat(s)&&t.showAllPreparationRequired){n=n+" and PreparationRequired eq true"}return n+"&$top=999"},getAuthNewsFeed:function t(n,s){try{const t=this;return Promise.resolve(E(function(){return Promise.resolve(Promise.all([t.getAllAvailableApps(),t.getNewsFeedDetails(n,s)])).then(function(e){let[n,s]=e;return n.length===0?s:t.arrangeNewsFeeds(s,n)})},function(t){e.error(t)}))}catch(e){return Promise.reject(e)}},arrangeNewsFeeds:function e(t,n){const s=[];t.forEach(e=>{if(e.Category.value!=="App"||!e.ImpactedArtifacts.value){s.push(e)}else{const t=e.ImpactedArtifacts.value.split("\n");for(let r of t){const t=r;if(t&&this.isAuthFeed(n,r)){s.push(e);break}}}});return s},isAuthFeed:function e(t,n){const s="|";if(n.includes(s)){const e=n.split(s);const r=(e[e.length-1]||"").trim();if(r){const e=t.findIndex(e=>r===e?.signature?.parameters["sap-fiori-id"]?.defaultValue?.value);return e>-1}}return true},getAllAvailableApps:function t(){try{return Promise.resolve(E(function(){return Promise.resolve(o.getServiceAsync("ClientSideTargetResolution")).then(function(e){return e?._oAdapter._aInbounds||[]})},function(t){if(t instanceof Error){e.error(t.message)}return[]}))}catch(e){return Promise.reject(e)}},getNewsFeedDetails:function e(t,n){try{let s=false;const r=this;function i(e){if(s)return e;const i=e=>e.replace(/([a-z0-9])([A-Z])/g,"$1 $2");return Promise.resolve(Promise.all([L.GetJSON(t),r.getTranslatedText(r.getCustomFeedKey())])).then(function(e){let[t,s]=e;let o=JSON.parse(JSON.stringify(t.value||[]));const a=JSON.parse(JSON.stringify(s.value||[]));o=r.filterNewsOnTitle(o,n);return o.map(e=>{const t=Object.keys(e);const n=[];t.forEach(t=>{const s=a.find(e=>e?.ColumnName?.toUpperCase()===t.toUpperCase());const r=s?.TranslatedName||i(t);e[t]={label:r,value:e[t]};if(!q.EXCLUDE_FIELDS.includes(t)){n.push(e[t])}});e.Link={label:r._i18nBundle.getText("readMoreLink"),value:e[q.LINK],text:"Link"};e.expanded=o.length===1;e.expandFields=n;return e})})}const o=function(){if(r.customNewsFeedCache.has(t)){return Promise.resolve(r.customNewsFeedCache.get(t)).then(function(e){const t=r.filterNewsOnTitle(e,n);s=true;return t})}}();return Promise.resolve(o&&o.then?o.then(i):i(o))}catch(a){return Promise.reject(a)}},filterNewsOnTitle:function e(t,n){if(n){return t.filter(e=>e.LineOfBusiness.value===n)}return t},getTranslatedText:function t(n){try{const e=V+"?$filter=Changeid eq '"+n+"'";if(!this.customNewsFeedCache.has(e)){this.customNewsFeedCache.set(e,L.GetJSON(e))}return this.customNewsFeedCache.get(e)}catch(t){if(t instanceof Error){e.error(t.message)}return[]}},loadCustomNewsFeed:function e(t,n){try{const e=this;const s=e.parseJsonToXml(JSON.parse(JSON.stringify(t)),n);const r=e.getParent();if(!e.oNewsModel){e.oNewsModel=new i(s);if(!e.bNewsLoad){r?.panelLoadedFn("News",{loaded:true,count:j});e.bNewsLoad=true}e.oNewsTile.setModel(e.oNewsModel)}else{e.oNewsTile.unbindAggregation("tiles",false);e.oNewsTile.destroyAggregation("tiles");e.oNewsModel.setData(s)}return Promise.resolve(e.loadNewsFeed(s,t.length)).then(function(){})}catch(e){return Promise.reject(e)}},parseJsonToXml:function e(t,n){const s=e=>e.map(e=>({item:e}));const r=e=>{let t="";let n;for(n in e){const s=e[n];if(s){if(typeof s==="object"){t+=`<${n}>${r(s)}</${n}>`}else{t+=`<${n}>${s}</${n}>`}}}return t.replace(/<\/?\d+>/g,"")};const i=JSON.parse(JSON.stringify(s(t)));let o="<?xml version='1.0' encoding='UTF-8'?>";const a=n;o+=`<${a}>`;o+=r(i);o+=`</${a}>`;o=o.replaceAll("&","&amp;");const l=new DOMParser;return l.parseFromString(o,"text/xml")},getCustomFeedImage:function e(t){const n=sap.ui.require.toUrl(q.IMAGE_URL);let s=n+J.default[0];const r=J[t]||[];let i=0;if(r.length>0){const e=new window.Uint32Array(1);window.crypto.getRandomValues(e);i=e[0]%3;s=n+r[i]}return s},getDefaultFeedImage:function e(t){const n=t?.bg_image_id;const s=t?._group_to_image;if(!s||s.image_id!==n){return""}let r=s.mime_type;const i=s.bg_image;if(!i){return""}if(r==="application/octet-stream"){r="image/jpeg"}if(!this.isValidBase64(i)){const e=this.base64UrlToBase64(i);return`data:${r};base64,${e}`}return`data:${r};base64,${i}`},base64UrlToBase64:function e(t){let n=t?.replace(/_/g,"/").replace(/-/g,"+");while(n.length%4!==0){n+="="}return n},isValidBase64:function e(t){if(!t||t.length===0){return false}const n=/^[A-Za-z0-9+/]*={0,2}$/;if(!n.test(t)){return false}if(t.length%4!==0){return false}if(t.includes("=")){const e=t.indexOf("=");const n=t.lastIndexOf("=");if(e!==t.length-(t.length-e)){return false}if(t.length-e>2){return false}if(e!==n&&n!==e+1){return false}}return true},_getUserPersonalization:function e(){const t=x.getPersContainerId(this);const n=x.getOwnerComponent(this);return R.getInstance(t,n)}});return W});
//# sourceMappingURL=NewsPanel-dbg.js.map