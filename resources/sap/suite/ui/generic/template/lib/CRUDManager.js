sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/util/ModelUtil","sap/ui/generic/app/util/ActionUtil","sap/suite/ui/generic/template/lib/MessageUtils","sap/suite/ui/generic/template/lib/CRUDHelper","sap/suite/ui/generic/template/genericUtilities/CacheHelper","sap/suite/ui/generic/template/genericUtilities/testableHelper","sap/base/util/extend","sap/base/util/isEmptyObject","sap/suite/ui/generic/template/genericUtilities/FeError","sap/ui/model/Context","sap/m/MessageBox","sap/suite/ui/generic/template/genericUtilities/oDataModelHelper","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/suite/ui/generic/template/js/AnnotationHelper"],function(e,t,n,r,a,i,o,s,l,c,u,g,p,f,v,d){"use strict";var C="lib.CRUDManager";var m=Promise.reject();m.catch(Function.prototype);function E(e){return Object.keys(e).map(function(t){return e[t]})}function h(e){if(e){return e.map(function(e,t){return t})}}function D(e,D,y,b,A){function T(t,n,a,i){if(a){r.handleError(t,e,y,a,i)}return(n||Function.prototype)(a)}var x;function P(t){return new Promise(function(n,a){var i=e.getOwnerComponent();var o=i.getBindingContext();var s=i.getModel();s.read(o.getPath(),{urlParameters:{$expand:"DraftAdministrativeData"},success:function(e){if(!e.DraftAdministrativeData){if(t){return T(r.operations.editEntity,a,t)}return n({})}if(e.DraftAdministrativeData.InProcessByUser){var i=e.DraftAdministrativeData.InProcessByUserDescription||e.DraftAdministrativeData.InProcessByUser;var o=Promise.resolve(t||D.getMainComponentUtils().then(function(e){var t=e.getText("ST_GENERIC_DRAFT_LOCKED_BY_USER",[" ",i]);return new c(t)}));return o.then(function(e){T(r.operations.editEntity,a,e,e)})}return n({draftAdministrativeData:e.DraftAdministrativeData})},error:T.bind(null,r.operations.editEntity,a)})})}function M(){var t=e.getView().getModel();var n=e.getOwnerComponent();var r=n.getAppComponent();var a=r.getId();return D.getMainComponentUtils().then(function(e){var n=i.getInfoForContentIdPromise(e.entitySet,t,a,e.getRootExpand);return n.then(function(e){return e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:null})})}function R(e,t,n){var a=e.bindingContext;if(n&&n.draftAdministrativeData){return Promise.resolve(n)}return M().then(function(n){return new Promise(function(i,o){y.oTransactionController.editEntity(a,!t,n).then(function(t){var n;n=e.view;var r=function(){a.getModel().invalidateEntry(a);n.detachEvent("modelContextChange",r)};if(n){n.attachEvent("modelContextChange",r)}return i({context:t.context})},function(e){if(e&&e.response&&e.response.statusCode==="409"&&!t){y.oApplication.removeTransientMessages();return P(e).then(i,o)}else{T(r.operations.editEntity,o,e,e)}})})})}x=function(t){var n=D.isDraftEnabled();var r,a;if(n){var i=D.getViewLevel();var o;if(i>0){o=D.getMainComponentDetails();var s=y.oApplication.checkContextData(o.bindingContext);if(!s){y.oApplication.registerContext(o.bindingContext,1,o.entitySet,y.oApplication.getCurrentKeys(1))}a=D.getTargetKeyFromLevel(2)}if(!t){var l=y.oDraftController.getDraftContext();var c=l.hasPreserveChanges(o.bindingContext);if(!c){r=P().then(R.bind(null,o,true))}}r=r||R(o,t,{});y.oApplication.editingStarted(o.bindingContext,r)}else{var u=e.getView().getBindingContext();r=Promise.resolve({context:u})}var g=Promise.all([r,a]);return g.then(function(e){var t={};var n=Object.keys(e[0])[0];t[n]=e[0][n];t.targetSiblingKey=e[1];return t})};function I(e){if(A.isBusy()){return m}var t=x(e);A.setBusy(t);return t}function S(n,a,i){var o=new Promise(function(o,s){var l=function(){var e=t.getEntitySetFromContext(i);var o=y.oDraftController.getDraftContext();var s=o.isDraftRoot(e);var l=D.getViewLevel();var c=l>=2?b.getText("ITEM_DELETED"):b.getText("ST_GENERIC_OBJECT_DELETED");if(!n&&s){c=b.getText(a?"ST_GENERIC_DRAFT_WITH_ACTIVE_DOCUMENT_DELETED":"ST_GENERIC_DRAFT_WITHOUT_ACTIVE_DOCUMENT_DELETED")}r.showSuccessMessageIfRequired(c,y)};var c=function(t){if(t.length===0){l();o()}else{r.handleError(r.operations.deleteEntity,e,y,t[0].oError,null);s()}};var u=w({pathes:[i.getPath()],withWarningDialog:true});u.then(c,s)});return o}function O(){var t=e.getView().getBindingContext();var n=y.oDraftController.isActiveEntity(t);return a.deleteEntity(y.oDraftController,S,y.oApplication,t,n,"deleteAction")}function F(e,t,n){var a={mFailed:Object.create(null),mSuccess:Object.create(null),mWarning:Object.create(null),aMessagesForUserDecision:[]};for(var i=0;i<e.length;i++){var o=e[i];var s=t[i];var c=r.parseError(s);var u=parseInt(c.httpStatusCode,10);var g=s&&s.response&&s.response.headers;if(u>=200&&u<300||u===304){a.mSuccess[o]=s}else if(u===412&&g&&g["preference-applied"]){a.mWarning[o]=s}else{a.mFailed[o]=s}}if(!l(a.mWarning)&&n){a.aMessagesForUserDecision=y.oApplication.getTransientMessages();y.oApplication.removeTransientMessages()}return a}function w(e){var t=new Promise(function(t,n){var r=Object.create(null);var a=Object.create(null);var i=function(e,t,n){a[e]={resolve:t,reject:n}};for(var o=0;o<e.pathes.length;o++){var c=e.pathes[o];r[c]=new Promise(i.bind(null,c))}y.oApplication.prepareDeletion(r,e.suppressRefreshAllComponents);var u=Object.create(null);var g=Object.create(null);var p;var f=function(r){if(!l(u)){y.oApplication.markCurrentDraftAsModified()}for(var i in a){var o=a[i];o[u[i]?"resolve":"reject"]()}if(r){return n()}var s=e.pathes.map(function(e){return{sPath:e,oError:g[e]||p[e],isWarning:!!p[e]}}).filter(function(e){return!!e.oError});t(s)};var v=function(e){if(e.length>0){var t=D.getCRUDActionHandler();var n={messagesForUserDecison:e};t.handleCRUDScenario(4,d.bind(null,Object.keys(p),false,false),f.bind(null,true),"Delete",n);return}f()};var d=function(t,n,r){if(e.suppressRefreshAllComponents&&e.smartTable){y.oPresentationControlHandlerFactory.getPresentationControlHandler(e.smartTable).refresh("Changes")}var a=function(n){var a=F(t,n,r,e.onlyOneDraftPlusActive);g=s(g,a.mFailed);u=s(u,a.mSuccess);p=a.mWarning;v(a.aMessagesForUserDecision)};var i=y.oTransactionController.deleteEntities(t,{bIsStrict:n}).then(a,a);A.setBusy(i)};var C=e.withWarningDialog&&(e.pathes.length===1||e.onlyOneDraftPlusActive);d(e.pathes,true,C)});return t}function U(e){return a.discardDraft(y.oDraftController,y.oTransactionController,y.oApplication,e)}function _(e){var t=function(t){var n=[];e.forEach(function(e){n.push(e.sContextPath)});var r=F(n,t);var a=E(r.mSuccess);return a};var n=y.oTransactionController.updateMultipleEntities(e).then(t,t);A.setBusy(n);return n}function B(t){var n=t.getMetaModel().getODataEntitySet(e.getOwnerComponent().getEntitySet());return d.getRequiredProps(n)}function N(e,t){var n=t.getObject();return e.filter(function(e){return!n[e]})}function H(t){var n=t.oMetaModel.getODataEntitySet(e.getOwnerComponent().getEntitySet()),r=t.oMetaModel.getODataEntityType(n.entityType);return r}function j(e,t,n,r){t.removeAllMessages();var a=H(r);e.forEach(function(e){var i=n.target,o=n.fullTarget,s=r.oMetaModel.getODataProperty(a,e)&&r.oMetaModel.getODataProperty(a,e)["sap:label"];if(s){var l=new f({message:b.getSpecializedText("ENTER_MANDATORY",e,null,[s]),persistent:false,technical:false,target:i+"/"+e,fullTarget:o+"/"+e,type:v.Error,processor:r});t.addMessages(l)}});y.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}function L(t,n,r){var i=sap.ui.getCore().getMessageManager();var o=e.getView().getModel();if(!r){var s=B(o),l=e.getView().getBindingContext(),c=N(s,l);if(c.length>0){j(c,i,y.oTemplateCapabilities.oMessageButtonHelper.getTargetInfo(o),o);n();return}}var u=r?r:y.oTemplateCapabilities.oMessageButtonHelper&&y.oTemplateCapabilities.oMessageButtonHelper.getContextFilter(false);var g=a.fnGetMessagesFromContextFilter(u,i,true);var p=Object.create(null);g.forEach(function(e){p[e.getId()]=e});var f=function(){var e=D.getCRUDActionHandler();e.handleCRUDScenario(4,v.bind(null,false),n,"Activate")};var v=function(e){var o=y.oTransactionController.triggerSubmitChanges({bStrict:e});o.then(function(e){i.removeMessages(g);t(e.context)},function(t){var o=false;var s=[];var l=a.fnGetMessagesFromContextFilter(u,i,true);var c=l.map(function(e){if(!p[e.getId()]){e.persistent=false;e.technical=false;o=o||e.technicalDetails.statusCode==="412"&&e.technicalDetails.headers["preference-applied"]==="handling=strict";s.push(e)}return e});if(s.length){i.removeMessages(c);i.addMessages(s);if(o&&e){f();return}if(!r){y.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover()}}n()});A.setBusy(o)};v(true)}function G(e){var t=e;var n=new Promise(function(e,n){L(e,n,t)});return n}function V(t,n){return a.activateDraftEntity(t,n,A,y,e,D)}function W(e){var t=new n(e);t.setActionLabel(e.actionLabel);return t}function k(e,t,n){if(!D.isDraftEnabled()||n){var r,a;var i=y.oPresentationControlHandlerFactory.getPresentationControlHandler(b.getOwnerPresentationControl(e));var o=i.getEntitySet();var s=i.getBindingContext();if(s&&s.getPath()!==o){r=s;a=i.getBindingPath()}else{r=new u(i.getModel(),"/"+o)}return y.oTransactionController.getDefaultValues([r],t,a)}else{return t}}function q(t,n,r,a){if(A.isBusy()){a();return}var i=[];var o=[];var s=[];var l=false;var c=Object.create(null);var p=[];var f=t.contexts||[];var v=t.sourceControlHandler;if(f.length===0&&v){var d=v.getModel();var C="/";var m=v.getEntitySet();var T=C.concat(m);f.push(new u(d,T))}var x=t.label;var P=t.operationGrouping;var M=function(){if(f[0]){var e=f[0].oModel;if(e&&e.hasPendingChanges()){e.resetChanges()}}};var R=function(e){M();a(e)};var I=function(e,t){if(e.length>0){var n=D.getCRUDActionHandler();var r;if(f.length===0){r=O.bind(null,false,false,f)}else{var a=f.filter(function(e,t){return p.includes(""+t)});r=O.bind(null,false,false,a)}var i={messagesForUserDecison:e,actionName:x};n.handleCRUDScenario(4,r,t,"BOPFAction",i);return}t()};var S=f.length<=1;var O=function(n,u,f){if(!n){M()}var d=W({controller:e,applicationController:y.oApplicationController,contexts:f,functionImport:t.functionImport,functionImportPath:t.functionImportPath,entityType:t.entityType,actionLabel:x,actionButtonText:t.actionButtonText,isDraftEnabled:D.isDraftEnabled(),contextIndependentParameterData:c,expand:t.sRootExpand,operationGrouping:P,handleFocus:y.controllerServices&&y.controllerServices.getRestoreFocusHelper?y.controllerServices.getRestoreFocusHelper().rememberFocus:null});d.call(n).then(function(e){var t={};t.actionLabel=x;y.oApplication.setNextFocus(Function.prototype);A.setBusy(e.executionPromise,null,t);e.executionPromise.then(C,C)},R);var C=function(e){var t=Array.isArray(e)?e:[e];var n=h(t);var r=t.map(function(e){var t=e.error||e.response;if(t){t.actionContext=e.actionContext}return t});c=t[0].userEnteredAdditionalParams;var a=F(n,r,u);o=o.concat(E(a.mFailed));i=i.concat(E(a.mSuccess));p=Object.keys(a.mWarning);s=E(a.mWarning);I(a.aMessagesForUserDecision,m.bind(null,t))};var m=function(e){var t=o.concat(i.concat(s));if(t.length>1){var n=s.length>0;var c=o.concat(s);var u=t.length;var p=c.length;if(p>0){var f;if(u===p){f=b.getText("ST_GENERIC_NOT_PROCESSED_RECORDS_PLURAL")}else{f=b.getText("ST_GENERIC_NOT_PROCESSED_RECORDS",[p,u])}if(n){f=f+"\n";if(p===1){f=f+b.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_SINGULAR")}else{f=f+b.getText("ST_GENERIC_ACTION_WITH_WARNING_SUGGESTION_PLURAL")}}A.getUnbusy().then(function(){if(o.length>1){g.error(f)}else{g.warning(f)}})}}var C,m;l=l||d.getExecutedSuccessfully();if(l){var E;if(i.length===1&&s.length===0&&o.length===0){C=i[0];E=e[0].actionContext}m=C&&C.context;var h;if(m&&m.getObject()){h=y.oApplication.registerContext(m)}if(m&&m!==E&&m.getPath()!=="/undefined"){y.oApplication.setNextFocus(function(e,t){t({ignorePersistence:true})});y.oApplication.navigateToDetailContextIfPossible(m,false,h.bIsDraft?2*(1+h.bIsCreate):1,h)}else{y.oApplication.setNextFocus(function(e,t){t()})}var T=v&&v.getBindingInfo();var x=T&&T.binding;if(x&&x.oEntityType){v.setEnabledToolbarButtons();if(D.getViewLevel()===0){v.setEnabledFooterButtons()}}r(t)}else{M();a(t)}}};O(true,S,f)}function K(t,n){var r=e.getView().getModel();var a=r.getMetaModel();var o=e.getOwnerComponent();var s=o.getEntitySet();var l=z(a,t.functionImportPath);var c=a.getODataEntitySet(s);var u=l&&l.returnType;var g=c&&c.entityType;var p=a.getODataEntityType(g);t.functionImport=l;t.entityType=p;if(u===g){var f=o.getAppComponent();var v=y.oApplication.getComponentUtilsIfLoaded(s);var d=v&&v.viewRegistered&&!v.fnViewRegisteredResolve&&v.getRootExpand;var C=i.getInfoForContentIdPromise(s,r,f.getId(),d);return C.then(function(e){var r=e.contentIdRequestPossible?e.parametersForContentIdRequest.sRootExpand:null;t.sRootExpand=r;return Y(t,n)})}return Y(t,n)}function Y(e,t){var n=new Promise(function(n,r){y.oApplication.performAfterSideEffectExecution(q.bind(null,e,t,n,r))});return n}function z(e,t){if(e&&t){var n=t.split("/").pop();return e.getODataFunctionImport(n)}return undefined}function J(t,n){if(!t){throw new c(C,"Unknown Table")}var o=e.getOwnerComponent();var s=o.getAppComponent();var l=e.getView();var u=l.getModel();var g,f;var v=D.getViewLevel();if(v>0){var d=y.oPresentationControlHandlerFactory.getPresentationControlHandler(b.getOwnerPresentationControl(t)).getBindingInfo().path;g=t.getEntitySet();f=o.getComponentContainer().getElementBinding().getPath()+"/"+d}else{g=o.getCreationEntitySet&&o.getCreationEntitySet()||t.getEntitySet();f="/"+g}return new Promise(function(t,o){var l=function(e){var t=y.oApplication.getBusyHelper();t.setBusy(e);y.oApplication.setNextFocus(Function.prototype)};var c=y.oApplication.getComponentUtilsIfLoaded(g);var d=c&&c.viewRegistered&&!c.fnViewRegisteredResolve&&c.getRootExpand;var C=i.getInfoForContentIdPromise(g,u,s.getId(),d);l(C);C.then(function(i){var s=D.getSettings();var c=i.contentIdRequestPossible?i.parametersForContentIdRequest.sRootExpand:null;var d={sRootExpand:c,oController:e,oApplicationController:y.oApplicationController,bUseNewActionForCreate:s&&s.useNewActionForCreate,fnSetBusy:l,handleFocus:y.controllerServices&&y.controllerServices.getRestoreFocusHelper?y.controllerServices.getRestoreFocusHelper().rememberFocus:null};var C=a.create(y.oDraftController,g,f,u,y.oApplication,n,d,b);C.catch(T.bind(null,r.operations.addEntry,function(e){o();if(e){throw e}}));var m=v===0?y.oApplication.preloadComponent(g):Promise.resolve();Promise.all([C,m]).then(function(e){var n=e[0];y.oApplication.markCurrentDraftAsModified();var r=D.getCurrentKeys();r.push(p.analyseContext(n).key);var a=r.length-1;y.oApplication.registerContext(n,a,g,r);t(n)})})})}var T=o.testable(T,"handleError");var W=o.testable(W,"getActionUtil");return{editEntity:I,deleteEntity:O,deleteEntities:w,saveEntity:G,activateDraftEntity:V,discardDraft:U,callAction:K,addEntry:J,updateMultipleEntities:_,getDefaultValues:k,getUnfilledProperties:N}}return e.extend("sap.suite.ui.generic.template.lib.CRUDManager",{constructor:function(e,t,n,r,a){s(this,D(e,t,n,r,a))}})});
//# sourceMappingURL=CRUDManager.js.map