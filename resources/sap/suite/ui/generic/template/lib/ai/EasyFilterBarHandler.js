sap.ui.define(["sap/ui/base/Object","sap/base/util/extend","sap/suite/ui/generic/template/lib/filterHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/ui/model/FilterOperator","sap/ui/model/Filter","sap/suite/ui/generic/template/js/AnnotationHelper"],function(e,t,a,r,i,n,o){"use strict";var l=new r("lib.ai.EasyFilterBarHandler").getLogger();function s(e,t,r){var s={};var u;var c,p;var f;function g(){return new Promise(function(t){e.oIappStateHandler.onFEStartupInitialized().then(function(){v().then(function(e){t(e)})})})}function v(){var n=[];var o;var l={};var c=e.oSmartFilterbar;var p=c.getModel();var f=p.getMetaModel();var g=t.getOwnerComponent().getEntitySet();var v={};var m=r.oCommonUtils.getMetaModelEntityType(g);m.property.map(function(e){var t="ValueHelp";if(a.isPropertyFilterable(e)){var r;e.extensions&&e.extensions.forEach(function(e){if(e.name==="value-list"&&e.value==="fixed-values"){t="MenuWithCheckBox";r=true}});if(e.type==="Edm.DateTime"&&e["sap:display-format"]==="Date"||e.type==="Edm.String"&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"]&&e["com.sap.vocabularies.Common.v1.IsCalendarDate"].Bool==="true"){t="Calendar"}else if(e.type==="Edm.DateTimeOffset"){t="Time"}v[e.name]={name:e.name,dataType:e.type,defaultValue:[],filterable:true,sortable:false,codeList:r,type:t,unit:e["sap:unit"]||"",required:e["sap:required-in-filter"]==="true"?true:false}}});u={version:1,entitySet:g,fields:[]};l=c.getFilterData()||{};c.getAllFilterItems().forEach(function(e){var t=v[e.getName()];if(t){var a=l[e.getName()];if(a){var r=[];if(a.ranges&&a.ranges.length>0){r=a.ranges.map(function(e){if(e.exclude===false){if(e.operation==="BT"){return{operator:i.BT,selectedValues:[{value1:e.value1,value2:e.value2}]}}else{return{operator:e.operation,selectedValues:[e.value1]}}}else{return{operator:i.NE,selectedValues:[e.value1]}}})}else if(a.items&&a.items.length>0){a.items.forEach(function(e){r.push({operator:i.EQ,selectedValues:[e.key]})})}else if(a){r=[{operator:i.EQ,selectedValues:[a]}]}t.defaultValue=r}t.label=e.getLabel();if(t.codeList){var c=f.getODataProperty(m,t.name,true);var g=f.createBindingContext(c);var h=f.getODataValueLists(g);n.push(h);h.then(function(e){if(s[t.name]){t.codeList=s[t.name]}else{t.codeList=function(){return d(t,e,p)}}u.fields.push(t)})}else{u.fields.push(t)}}else if(e.getName()==="EditState"){o=e}});if(r.oComponentUtils.isDraftEnabled()){var h=t.byId("editStateFilter");if(h){var y=h.getItems().map(function(e){return{value:e.getKey(),description:e.getText()}});var S={name:o.getName(),label:o.getLabel(),dataType:"Edm.String",filterable:true,required:false,sortable:false,type:"MenuWithSingleSelect",codeList:y};u.fields.push(S)}}return Promise.allSettled(n).then(function(){return u})}function d(e,t,a){if(s[e.name]){return s[e.name]}return new Promise(function(r,i){var n=t[""];if(n){var o=n.Parameters&&n.Parameters.map(function(e){return e.ValueListProperty.String}).join(",");var l=function(t){var a=[];t.results&&t.results.forEach(function(e){a.push({value:e[c],description:p?e[p]:undefined})});s[e.name]=a;u.fields.forEach(function(t){if(t.name===e.name){t.codeList=a}});r(a)};a.read("/"+n.CollectionPath.String,{$select:o,success:l,error:i});var c;var p;n.Parameters&&n.Parameters.forEach(function(t){if(t.LocalDataProperty&&t.LocalDataProperty.PropertyPath===e.name){c=t.ValueListProperty.String}else{p=t.ValueListProperty.String}})}})}function m(e){var t=[];var a=0;e.forEach(function(e){if(e.key==="EditState"){a=e.keySpecificSelectedValues[0].selectedValues[0]}else{var r={PropertyName:e.key,Ranges:[]};e.keySpecificSelectedValues.forEach(function(e){e.selectedValues.forEach(function(t){var a={Sign:"I",High:""};if(e.operator==="Contains"){a.Option="CP";a.Low=t}else if(e.operator==="BT"||e.operator==="NB"){a.Low=t[0];a.High=t[1]}else{a.Option=e.operator;a.Low=t}r.Ranges.push(a)})});t.push(r)}});return{aSelectOptions:t,oEditStateFilter:a}}function h(){return t.byId("template::easyFilterContainer")}function y(){var e=h();var a=g();var i=t.getOwnerComponent().getEntitySet();a.then(a=>{e.setContextPath(i);e.setAppId(t.getOwnerComponent().getAppComponent().getManifestEntry("sap.app").id);e.setFilterBarMetadata(a.fields);e.easyfilter=r.oServices.oFioriAIHandler.fioriaiLib.EasyFilter})}function S(t){var a=e.oSmartFilterbar;a.search()}function E(e){p()}function V(e){c=new Promise(function(e){p=e});r.oComponentUtils.getBusyHelper().setBusy(c)}function F(t){var a=e.oSmartFilterbar;var i=t.getParameter("tokens");var n=a.getId();var o=r.oCommonUtils.getControlStateWrapperById(n,"SmartFilterBar");var l=o.getState();var s=m(i);var u=Object.keys(l.customFilters.appExtension);if(u.length>0){u.forEach(function(e){l.customFilters.appExtension[e]=""})}l.selectOptions=s.aSelectOptions;if(r.oComponentUtils.isDraftEnabled()){l.customFilters.editState=s.oEditStateFilter}o.setState(l);a.getSmartVariant()&&a.getSmartVariant().currentVariantSetModified(true);a.search()}function P(t){var a=e.oSmartFilterbar;f=t.getParameter("resolve");a.associateValueLists();try{a.openValueHelpRequestForFilterItem(t.getParameter("key"))}catch(e){l.error("Value help cannot be triggered for the field "+t.getParameter("key"))}}function b(){}function C(e){var t=e.getParameters("mParameters");var a=[];var r;if(t.sId==="change"&&f){r=t.getParameter("filterChangeReason");e.getSource().getFilters().forEach(function(e){e.aFilters&&e.aFilters.forEach(function(e){e=e.aFilters?e.aFilters:[e];e.forEach(function(e){if(e.sPath===r){var t={operator:"",selectedValues:[]};var i=a.find(function(t){return t.operator===e.sOperator});if(i){a.forEach(function(t){if(t.operator===e.sOperator){t.selectedValues.push({value:e.oValue1,description:e.oValue1})}})}else{t.operator=e.sOperator;t.selectedValues.push({value:e.oValue1,description:e.oValue1});a.push(t)}}})})});f(a)}}function O(t){var a=r.oComponentUtils.getTemplatePrivateModel();if(!t.getParameter("context")&&a.getProperty("/listReport/filterMode")!=="classic"){var i=e.oSmartFilterbar;a.setProperty("/listReport/filterMode","classic");i.setVisible(true)}}function B(e,t){const a=[];for(var r=0;r<t.length;++r){const o=t[r];if(o.operator===i.BT||o.operator===i.NB){a.push(new n({path:e,operator:o.operator,value1:o.selectedValues[0],value2:o.selectedValues[1]}))}else{for(var r=0;r<o.selectedValues.length;++r){a.push(new n({path:e,operator:o.operator,value1:o.selectedValues[r]}))}}}return a}function L(a,l,s){return new Promise((s,u)=>{var c=[];var p=e.oSmartFilterbar;var f=t.getOwnerComponent().getEntitySet();var g=r.oCommonUtils.getMetaModelEntityType(f);var v=p.getModel();var d=v.getMetaModel();var m=B(a,l);var h=d.getODataProperty(g,a);var y=d.getODataProperty(g,a,true);var S=o.isValueHelpTableAvailable(h);if(S){var E=d.createBindingContext(y);var V=d.getODataValueLists(E);var F=m.length;var P=0;let e=(e,t,r,n)=>{++P;var l=e.results;t.forEach(e=>{var t=l.find(t=>t[a]===e.getValue1());if(t){c.push({operator:i.EQ,selectedValues:[{value:t[a],description:o.getTextArrangementFinalString(t,a,r.split("/")[1],n)}]})}else{c.push(M(e))}});if(P===F){s(c)}};let t=(t,l,u)=>{var p=r.oCommonUtils.getMetaModelEntityType(u);var f=d.getODataProperty(p,a);var g=t.results;var m=o.getTextArrangementPath(f);var h=o.getTextArrangement(p,f)||"idOnly";var y=null;var S=null;if(m&&m.split("/").length>1){y=m.split("/")[0];S=d.getODataAssociationSetEnd(p,y).entitySet}if(g.length===0){++P;c.push(M(l))}else if(g.length!==0&&S&&u!==S){var E=g.map(e=>e[a]);var V=E.map(e=>new n({path:a,operator:i.EQ,value1:e}));v.read("/"+S,{filters:V,success:function(t){e(t,V)}})}else{++P;g.forEach(e=>{c.push({operator:i.EQ,selectedValues:[{value:e[a],description:o.getTextArrangementFinalString(e,a,m,h)}]})})}if(P===F){s(c)}};V.then(e=>{var a=e[""];var r=a.CollectionPath.String;m.forEach(e=>{v.read("/"+r,{urlParameters:{search:e.getValue1()},success:function(a){t(a,e,r)}})})})}else{m.forEach(e=>c.push(M(e)));s(c)}})}function M(e){var t=[];if(e.getOperator()===i.BT||e.getOperator()===i.NB){var t=[{value:e.getValue1(),description:e.getValue1()},{value:e.getValue2(),description:e.getValue2()}]}else{t.push({value:e.getValue1(),description:e.getValue1()})}return{operator:e.getOperator(),selectedValues:t}}return{getEasyFilterBar:h,initialiseEasyFilterBar:y,getSFBVariantData:m,getEasyFilterSearchMetadata:g,onClearFilters:S,onAfterQueryProcessing:E,onBeforeQueryProcessing:V,onQueryChanged:b,onTokensChanged:F,onShowValueHelp:P,onFilterChange:C,handleVariantLoad:O,onDataFetcher:L,getkeySpecifiedResultFromFilters:M}}return e.extend("sap.suite.ui.generic.template.lib.ai.EasyFilterBarHandler",{constructor:function(e,a,r){t(this,s(e,a,r))}})});
//# sourceMappingURL=EasyFilterBarHandler.js.map