sap.ui.define(["sap/ui/base/Event","sap/ui/core/library","sap/ui/core/IconPool","sap/m/MessageToast","sap/ui/generic/app/util/MessageUtil","sap/suite/ui/generic/template/genericUtilities/controlHelper","sap/suite/ui/generic/template/genericUtilities/FeLogger","sap/suite/ui/generic/template/lib/TemplateComponent","sap/m/IllustratedMessageType"],function(e,t,r,a,s,o,n,i,l){"use strict";var c=t.ValueState;var g=t.IconColor;var u=new n("lib.MessageUtils").getLogger();var E=sap.ui.getCore().getMessageManager();function p(e,t,r,a,o,n){o=o||{};var i=s.parseErrorResponse(a);var c=i.messageText;var g;var E=false;var p=false;var T=t&&t.getOwnerComponent();var f=o.resourceBundle||T.getModel("i18n").getResourceBundle();var v=o.navigationController||r.oNavigationController;var _=o.model||T.getModel();u.debug("handleError has been called with operation "+e+" and HTTP response status code "+i.httpStatusCode);var I=n&&n[i.httpStatusCode];if(I){I(i.httpStatusCode)}var S=i.httpStatusCode;switch(S){case 400:switch(e){case s.operations.modifyEntity:break;case s.operations.callAction:c=f.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;case s.operations.deleteEntity:c=f.getText("ST_GENERIC_BAD_REQUEST_DELETE");break;case s.operations.editEntity:c=f.getText("ST_GENERIC_BAD_REQUEST_EDIT");break;case s.operations.saveEntity:case s.operations.activateDraftEntity:if(r&&r.oTemplateCapabilities&&r.oTemplateCapabilities.oMessageButtonHelper&&r.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover){r.oTemplateCapabilities.oMessageButtonHelper.showMessagePopover();p=true}else{u.info("A MessageButtonHelper class instance could not be found as one of the services' template capabilities.")}break;default:c=f.getText("ST_GENERIC_BAD_REQUEST");break}break;case 401:E=true;c=f.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED");g=f.getText("ST_GENERIC_ERROR_AUTHENTICATED_FAILED_DESC");break;case 403:switch(e){case s.operations.callAction:c=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_ACTION");break;case s.operations.addEntry:c=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_CREATE");break;case s.operations.deleteEntity:c=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DELETE");break;case s.operations.editEntity:c=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_EDIT");break;default:c=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED");g=f.getText("ST_GENERIC_ERROR_NOT_AUTORIZED_DESC");E=true;break}break;case 404:switch(e){case s.operations.callAction:c=f.getText("ST_GENERIC_BAD_REQUEST_ACTION");break;default:c=f.getText("ST_GENERIC_BAD_REQUEST");break}break;case 409:case 412:if((e===s.operations.activateDraftEntity||e===s.operations.deleteEntity)&&a.response&&a.response.headers&&a.response.headers["preference-applied"]==="handling=strict"){return}break;case 422:break;case 423:if(e===s.operations.activateDraftEntity||e===s.operations.saveEntity||e===s.operations.deleteEntity){return}break;case 500:case 501:case 502:case 503:case 504:case 505:E=!Object.keys(s.operations).some(function(t){return t===e});switch(e){case s.operations.callAction:c=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_FOR_ACTION");break;default:c=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");break}g=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break;case 0:E=false;p=true;break;default:E=true;c=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE");g=f.getText("ST_GENERIC_ERROR_SYSTEM_UNAVAILABLE_DESC");break}if(E){var d;if(T){var R=T.getModel("_templPriv");d=R.getProperty("/generic/viewLevel")}v.navigateToMessagePage({title:f.getText("ST_GENERIC_ERROR_TITLE"),text:c,description:g,messageType:l.UnableToLoad,viewLevel:d})}else if(!i.containsTransientMessage&&!p){s.addTransientErrorMessage(c,g,_)}}function T(t,r,a,s,n){var l;if(r instanceof e){var c=r.getParameter("item");l=c.getBindingContext("msg").getObject()}else{l=r}var g=t.oCommonUtils.getPositionableControlId(l.controlIds,true);if(!g){t.oServices.oApplication.registerForMessageNavigation(t,l,a);return}var u=Promise.resolve(false);if(s){var E=o.byId(g);if(o.isTable(E)){var p=l.controlIds.filter(function(e){var t=o.byId(e);return!o.isTable(t)});var T;p.forEach(function(e){var r=o.isElementVisibleOnView(e,null,function(t){var r=o.isView(t)&&t.getVisible()&&t.getController().getOwnerComponent();return r instanceof i&&{component:r,controlId:e}});if(r&&t.oServices.oApplication.isComponentActive(r.component)){var a=r.component.getModel("_templPriv");r.level=a.getProperty("/generic/viewLevel");if(!T||T.level<r.level){T=r}}});if(T){g=T.controlId;a=T.component}else{var f=l.aFullTargets.find(function(e){return e.startsWith(n)&&e.lastIndexOf("/")>n.length});if(f){u=t.oServices.oApplication.navigateToMessageTarget(l,f)}}}}u.then(function(e){if(e){return}var r={targetInfo:l};t.oServices.oApplication.prepareForControlNavigation(a,g).then(function(){var e=o.byId(g);var t=o.isSmartField(e)?o.getSmartFieldIsFocussableForInputPromise(e):Promise.resolve(true);t.then(function(t){o.focusUI5Control(t?e:e.getParent(),r)})})})}function f(e,t){var r=E.getMessageModel().getData();var a=r.some(function(e){return e.persistent&&t.oApplication.isTransientMessageNoCustomMessage(e)});if(!a){t.oApplication.showMessageToast(e)}}function v(e,t){var r=e.some(function(e){var r=t.oCommonUtils.getPositionableControlId(e.controlIds,true);return!r||o.isTable(o.byId(r))});return r?t.oComponentUtils.prepareForMessageHandling(e):Promise.resolve()}function _(e){var t=e.getTechnicalDetails();return!!t&&t.statusCode==="412"&&!t.headers["preference-applied"]}function I(e){var t=E.getMessageModel().getData();return t.find(function(t){return t.id===e})}function S(e,t){var r=E.getMessageModel().getProperty("/");var a=r.filter(function(r){return r.persistent&&(e||!r.technicalDetails||r.technicalDetails.statusCode!=="404"||r.type!=="Error")&&t(r)});return a}function d(e){var t=S(true,e);if(t.length>0){E.removeMessages(t)}}function R(e){var t=c.None,r=0;for(var a=0;a<e.length;a++){var s=C(e[a]);if(s>r){t=e[a].type;r=s}}return t}function A(e,t){var r,a="";r=R(e);var s="";if(r===c.Error){s=e.length>1?"ST_MESSAGES_DIALOG_TITLE_ERROR_PLURAL":"ST_MESSAGES_DIALOG_TITLE_ERROR"}else if(r===c.Warning){s=e.length>1?"ST_MESSAGES_DIALOG_TITLE_WARNING_PLURAL":"ST_MESSAGES_DIALOG_TITLE_WARNING"}else if(r===c.Information){s="ST_MESSAGES_DIALOG_TITLE_INFORMATION"}else if(r===c.Success){s="ST_MESSAGES_DIALOG_TITLE_SUCCESS_PLURAL"}a=t.getText(s);return{sTitle:a,sSeverity:r}}function m(e,t,r){var s=e.oApplicationProxy.isTransientMessageNoCustomMessage;var n=S(false,s);if(n.length===0){return Promise.resolve()}d(s);var i;if(n.length===1){i=n[0].type;if(i===c.Success||i===c.Information||i===c.None){a.show(n[0].message);return Promise.resolve()}}var l=A(n,e);i=l.sSeverity;return new Promise(function(a){var s,g,u;var E=function(){u.setProperty("/backButtonVisible",false);u.setProperty("/messages",[]);u.setProperty("/messageToGroupName",Object.create(null));g.navigateBack();u.getProperty("/resolve")()};var p={onMessageDialogClose:function(){s.close()},onActionButtonPressed:function(){u.getProperty("/actionButtonCallback")();s.close()},afterClose:E,onBackButtonPress:function(){u.setProperty("/backButtonVisible",false);g.navigateBack()},onMessageSelect:function(){var e=s.getButtons().find(function(e){return e.isFocusable()});o.focusUI5Control(e);u.setProperty("/backButtonVisible",true)},getSeverityIconFromIconPool:b,getIconColor:y};var T=function(t,r){r.setProperty("/genericGroupName",e.getText("ST_MESSAGE_GENERAL_TITLE"));r.setProperty("/backButtonVisible",false);r.setProperty("/cancelButtonText",e.getText("CANCEL"));r.setProperty("/closeButtonText",e.getText("ST_GENERIC_DIALOG_CLOSE_BUT"))};var f=function(e){var t=sap.ui.require("sap/ushell/Container");if(!t){e.promise.resolve({allowed:false,id:e.id})}t.getServiceAsync("Navigation").then(function(t){t.isUrlSupported(e.url).then(function(){e.promise.resolve({allowed:true,id:e.id})}).catch(function(){e.promise.resolve({allowed:false,id:e.id})})})};e.oApplicationProxy.getDialogFragmentAsync("sap.suite.ui.generic.template.fragments.MessageDialog",p,"settings",T,false,true).then(function(e){s=e;g=s.getContent()[0];g.setAsyncURLHandler(f);var o=s.getModel();var E=o&&o.getMetaModel();var p=false;var T=!!(r&&r.action);var v=Object.create(null);if(E){n.forEach(function(e){var t=e.getTargets()[0];if(!t){return}if(t.lastIndexOf("/")>0){t=t.substring(0,t.lastIndexOf("/"))}var r=t.substring(1,t.indexOf("("));var a=r&&E.getODataEntitySet(r);var s=a&&E.getODataEntityType(a.entityType);var n=s&&s["com.sap.vocabularies.UI.v1.HeaderInfo"];var i=n&&n.Title&&n.Title.Value&&n.Title.Value.Path;var l=o.getProperty(t);var c=l&&l[i];if(c){v[e.getId()]=c;p=true}})}u=s.getModel("settings");u.setProperty("/showActionButton",T);if(T){u.setProperty("/actionButtonText",r.actionLabel);u.setProperty("/actionButtonCallback",r.action)}u.setSizeLimit(9999);u.setProperty("/title",i!==c.Error&&i!==c.Warning&&t||l.sTitle);u.setProperty("/messages",n);u.setProperty("/grouping",p);u.setProperty("/state",i);u.setProperty("/resolve",a);u.setProperty("/messageToGroupName",v);s.open()})})}function C(e){var t;switch(e.type){case"Error":t=4;break;case"Warning":t=3;break;case"Information":t=2;break;case"Success":t=1;break;default:t=0}return t}function b(e){switch(e){case c.Error:return r.getIconURI("error");case c.Warning:return r.getIconURI("alert");case c.Information:return r.getIconURI("information");case c.Success:return r.getIconURI("sys-enter-2");default:return""}}function y(e){switch(e){case c.Error:return g.Negative;case c.Warning:return g.Critical;case c.Success:return g.Positive;default:return""}}function M(e){var t=[];e.forEach(function(e){var r=I(e);if(r){t.push(r)}});E.removeMessages(t)}return{operations:s.operations,handleTransientMessages:m,prepareForMessageHandling:v,handleError:p,navigateFromMessageTitleEvent:T,removeTransientMessages:d,getTransientMessages:S,showSuccessMessageIfRequired:f,parseError:s.parseErrorResponse,isMessageETagMessage:_,getMessageById:I,getSeverityAsNumber:C,getSeverityIconFromIconPool:b,getIconColor:y,getMessageDialogTitleAndSeverity:A,deleteMessages:M}});
//# sourceMappingURL=MessageUtils.js.map