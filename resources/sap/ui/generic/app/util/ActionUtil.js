/*
 * ! SAPUI5

(c) Copyright 2009-2020 SAP SE. All rights reserved
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/m/MessageBox","sap/ui/comp/smartform/SmartForm","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/m/Dialog","sap/m/Button","sap/base/strings/formatMessage","sap/ui/core/Lib","sap/ui/generic/app/util/ModelUtil","sap/ui/core/CustomData","sap/base/util/extend"],function(e,t,a,n,r,o,i,s,l,u,c,p,d,m){"use strict";var f=e.extend("sap.ui.generic.app.util.ActionUtil",{metadata:{properties:{controller:{type:"object",group:"Misc",defaultValue:null},applicationController:{type:"object",group:"Misc",defaultValue:null},contexts:{type:"object",group:"Misc",defaultValue:null},functionImport:{type:"object",group:"Misc",defaultValue:null},functionImportPath:{type:"string",group:"Misc",defaultValue:null},entityType:{type:"object",group:"Misc",defaultValue:null},actionLabel:{type:"string",group:"Misc",defaultValue:null},actionButtonText:{type:"string",group:"Misc",defaultValue:null},isDraftEnabled:{type:"boolean",group:"Misc",defaultValue:false},isCreateAction:{type:"boolean",group:"Misc",defaultValue:false},contextIndependentParameterData:{type:"object",group:"Misc",defaultValue:null},expand:{type:"string",group:"Misc",defaultValue:undefined},successCallback:{type:"function",group:"Misc",defaultValue:null},operationGrouping:{type:"string",group:"Misc",defaultValue:null},isBoundAction:{type:"boolean",group:"Misc",defaultValue:false},handleFocus:{type:"function",group:"Misc",defaultValue:null}}}});f.prototype.call=function(e){return new Promise(function(t,a){var n=this.getFunctionImport();if(!n){a("Call method invoked without setting the functionImport property of ActionUtil instance.")}var r=!!n["sap:action-for"];this.setIsBoundAction(r);if(r){var o=this.getContexts();if(!o||o.length===0){a("Bound action is executed without a context.")}var i=p.getEntityTypeFromContext(o[0]);this.setEntityType(i)}this._callMethodPromise={resolve:t,reject:a};if(this._isActionCritical()&&e){this._displayCriticalActionDialog()}else{this._prepareParamsAndInvokeAction(e)}}.bind(this))};f.prototype._displayCriticalActionDialog=function(){var e;var a="ACTION_CONFIRM|"+this.getFunctionImport().name;var n=this.getController();var r=n.getOwnerComponent();var o=r.getAppComponent();var i=o.getModel("i18n");var s=i&&i.getResourceBundle();if(s&&s.hasText(a)){e=s.getText(a)}else{e=c.getResourceBundleFor("sap.ui.generic.app").getText("ACTION_CONFIRM");e=u(e,this.getActionLabel())}t.confirm(e,{title:this.getActionLabel(),onClose:function(e){if(e==="OK"){this._prepareParamsAndInvokeAction(true)}else if(e==="CANCEL"){this._callMethodPromise.reject("Action execution cancelled by user.")}}.bind(this),sClass:this._getCompactModeStyleClass()})};f.prototype._prepareParamsAndInvokeAction=function(e){this._prepareParameters().then(function(t){this._initiateCall(t,e)}.bind(this))};f.prototype._prepareParameters=function(){return new Promise(function(e){var t=this.getFunctionImport();var a={inParameters:{},contextSpecificParameterData:[],hasParametersRequiringUserInput:false,defaultValues:null};var n=this.getContexts();var r=this.getContextIndependentParameterData()||{};var o=this.getApplicationController().getTransactionController();var i=t.name;var s=function(e){a.defaultValues=e};var l=function(){var o={};var i=this._getKeys();r=this.getContextIndependentParameterData()||{};if(t.parameter){for(var s=0;s<t.parameter.length;s++){var l=t.parameter[s];var u=l.name;this._checkAndUpdateLabelAnnotation(l,this.getEntityType(),this.getContexts()[0]);if(u==="ResultIsActiveEntity"){if(l.nullable!=="false"){continue}}var c=!!i[u];if(l.mode.toUpperCase()==="IN"){o[u]={metadata:l,isKey:c};var p=r[u]||a.defaultValues?.[u];if(this.getIsBoundAction()&&(n.length===1||c)||l.hasOwnProperty("com.sap.vocabularies.UI.v1.Hidden")||p){for(var d=0;d<n.length;d++){this.initializeContextSpecificParameterData(n[d],d,a,p,u)}}a.inParameters=o;a.hasParametersRequiringUserInput=a.hasParametersRequiringUserInput||this._checkParameterRelevant4UserInput(a,o[u])}}}e(a)}.bind(this);var u=o.getDefaultValues(n,null,undefined,i);if(u instanceof Promise){u.then(s,s).then(l)}else{Promise.resolve().then(function(){l()})}}.bind(this))};f.prototype.initializeContextSpecificParameterData=function(e,t,a,n,r){var o;var i=e.getObject();if(!a.contextSpecificParameterData[t]){a.contextSpecificParameterData[t]={}}if(n){o=n}else if(r==="ResultIsActiveEntity"){o=false}else if(i&&i.hasOwnProperty(r)){o=i[r]}a.contextSpecificParameterData[t][r]=o};f.prototype._getKeys=function(){const e={};const t=this.getEntityType();if(t){t.key.propertyRef.forEach(t=>{e[t.name]=true})}return e};f.prototype._getCompactModeStyleClass=function(){if(this.getController().getView().$().closest(".sapUiSizeCompact").length){return"sapUiSizeCompact"}return""};f.prototype._cleanUpContext=function(e){const t=e.map(e=>e.sPath);const a=e[0].getModel();a.resetChanges(t,true,true)};f.prototype._isActionCritical=function(){var e=this.getFunctionImport()["com.sap.vocabularies.Common.v1.IsActionCritical"];if(!e){return false}if(e.Bool===undefined){return true}return this._toBoolean(e.Bool)};f.prototype._toBoolean=function(e){if(typeof e==="string"){var t=e.toLowerCase();return!(t==="false"||t===""||t===" ")}return!!e};f.prototype._initiateCall=function(e,t){var a=t?"strict":"lenient";var n={Prefer:"handling="+a};var r=this.getContextIndependentParameterData()||{};var i=this.getIsDraftEnabled();if(!e.hasParametersRequiringUserInput||this._checkContextIndependentParameterDataForInParams(e)){var u=m(e.defaultValues,r);this._call(u,i,n,this.expand)}else if(Object.keys(e.inParameters).length>0){var p=this.getApplicationController();var d=i?p.synchronizeDraftAsync():Promise.resolve();d.then(function(){var a={urlParameters:{},headers:n,expand:this.expand};var r=this.getContexts();var i=p._getChangeSetFunc(r,this.getOperationGrouping());var u=r.map(function(e,t){a.changeSetId=i(t);return p.getNewActionContext(this.getFunctionImportPath(),e,a)}.bind(this));var d=u.map(function(e){return e.context});Promise.all(d).then(function(a){a.forEach(function(t,a){var n=e.contextSpecificParameterData[a];for(var r in n){t.getModel().setProperty(r,n[r],t,true)}});if(t){var n=this._buildParametersForm(e,a[0]);var i=false;var p=new s({title:this.getActionLabel(),content:[n.form],beginButton:new l({text:this.getActionButtonText()||this.getActionLabel(),type:"Emphasized",press:function(){var o=n.form?n.form.check():Promise.resolve();o.then(function(){if(n.hasNoClientErrors()){if(this.getHandleFocus()&&p&&p.oPopup&&p.oPopup._oPreviousFocus&&p.oPopup._oPreviousFocus.sFocusId){this.getHandleFocus()(p.oPopup._oPreviousFocus.sFocusId);p.oPopup._oPreviousFocus=null}p.close();i=this._triggerActionPromise(u,r,e,a,t)}}.bind(this))}.bind(this)}),endButton:new l({text:c.getResourceBundleFor("sap.ui.generic.app").getText("ACTION_CANCEL"),press:function(){u[0].abort();p.close();this._cleanUpContext(a);this._callMethodPromise.reject();i=true}.bind(this)}),afterClose:function(){p.destroy();if(!i){this._callMethodPromise.reject()}}.bind(this)}).addStyleClass("sapUiNoContentPadding");p.addStyleClass(this._getCompactModeStyleClass());p.setModel(a[0].getModel());if(this.getController().getView().getModel("@i18n")){p.setModel(this.getController().getView().getModel("@i18n"),"@i18n")}var d=p.getAggregation("content")[0].mAggregations["content"];var m=d.getFormContainers()[0].getFormElements();var f=m.some(function(e){var t=e.getFields()[0];return t instanceof o&&t.getVisible()===true});if(m.length===0||!f){this._triggerActionPromise(u,r,e,a,t);p.destroy()}else{p.open()}}else{this._triggerActionPromise(u,r,e,a)}}.bind(this))}.bind(this))}else{this._call(null,i,n,null)}};f.prototype._triggerActionPromise=function(e,t,a,n,r){const o={};this._callMethodPromise.resolve({executionPromise:this.getApplicationController()._newPromiseAll(e.map(function(e){return e.result})).then(function(e){this._bExecutedSuccessfully=this.getApplicationController()._checkAtLeastOneSuccess(t,e);if(r){e.forEach(function(e){e.userEnteredAdditionalParams=o})}if(this._bExecutedSuccessfully){return e}else{this._cleanUpContext(n);return Promise.reject(e)}}.bind(this),function(e){this._bExecutedSuccessfully=false;e.forEach(function(e){e.userEnteredAdditionalParams=o});throw e}.bind(this))});var i=n[0].getObject();var s=Object.values(a.inParameters);s.forEach(function(e){if(this._checkParameterRelevant4UserInput(a,e)){var t=e.metadata;var r=i[t.name]===null?undefined:i[t.name];if(r===undefined){if(t.type==="Edm.Boolean"){r=false}n[0].getModel().setProperty(t.name,r,n[0],true)}o[t.name]=r;for(var s=1;s<n.length;s++){var l=n[s];l.getModel().setProperty(t.name,r,l,true)}}}.bind(this));var l=this.getFunctionImport().name;t.forEach(function(e,t){this.getApplicationController().submitActionContext(e,n[t],l)}.bind(this));return r};f.prototype._call=function(e,t,a,n){var r=this.getContexts();var o=this.getApplicationController();var i={urlParameters:e,operationGrouping:this.getOperationGrouping(),triggerChanges:t,headers:a,expand:n};this._callMethodPromise.resolve({executionPromise:o.invokeActions(this.getFunctionImportPath(),r,i).then(function(e){this._bExecutedSuccessfully=true;return e}.bind(this),function(e){this._bExecutedSuccessfully=false;throw e}.bind(this))})};f.prototype._buildParametersForm=function(e,t){var s=new a({editable:true,validationMode:"Async"});s.setBindingContext(t);var l;var u=[];var c;var p=new n;const m=Object.values(e.inParameters);for(var f=0;f<m.length;f++){var h=m[f].metadata;if(!this._checkParameterRelevant4UserInput(e,m[f])){continue}if(!h["com.sap.vocabularies.UI.v1.TextArrangement"]){h["com.sap.vocabularies.UI.v1.TextArrangement"]={EnumMember:"com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"}}l=new o("ActionUtil-"+this.getFunctionImportPath().replace("/","-")+"-"+h.name,{value:"{"+h.name+"}",textLabel:this._getParameterName(h),width:"100%"});l.addCustomData(new d({key:"defaultTextInEditModeSource",value:h&&h["com.sap.vocabularies.Common.v1.ValueListForValidation"]!==undefined?"ValueList":"ValueListNoValidation"}));l.addCustomData(new d({key:"defaultInputFieldDisplayBehaviour",value:"descriptionOnly"}));u.push(l);c=new i;c.setLabelFor(l);var g=new r;g.addElement(l);p.addGroupElement(g)}s.addGroup(p);var v=function(){var e=true;for(var t=0;t<u.length;t++){if(u[t].getValueState()!="None"){e=false;break}}return e};return{form:s,hasNoClientErrors:v}};f.prototype._checkParameterRelevant4UserInput=function(e,t){const a=t.metadata;var n=a["com.sap.vocabularies.UI.v1.Hidden"];return!(n&&!n.Path&&n.Bool!=="false"||t.isKey&&this.getIsBoundAction())};f.prototype._getParameterName=function(e){return e["com.sap.vocabularies.Common.v1.Label"]?e["com.sap.vocabularies.Common.v1.Label"].String:e.name};f.prototype._checkAndUpdateLabelAnnotation=function(e,t,a){if(t&&e&&!e["com.sap.vocabularies.Common.v1.Label"]){var n=a.getModel().getMetaModel().getODataProperty(t,e.name,false);if(n&&n["com.sap.vocabularies.Common.v1.Label"]){e["com.sap.vocabularies.Common.v1.Label"]=n["com.sap.vocabularies.Common.v1.Label"]}}};f.prototype._checkContextIndependentParameterDataForInParams=function(e){var t=this.getContextIndependentParameterData()||{};var a=Object.values(e.inParameters);for(var n=0;n<a.length;n++){var r=a[n].metadata.name;if(!t[r]){return false}}return true};f.prototype.getExecutedSuccessfully=function(){return this._bExecutedSuccessfully};return f});
//# sourceMappingURL=ActionUtil.js.map