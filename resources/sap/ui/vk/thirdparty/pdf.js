/**
 * @licstart The following is the entire license notice for the
 * JavaScript code in this page
 *
 * Copyright 2023 Mozilla Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * @licend The above is the entire license notice for the
 * JavaScript code in this page
 */var __webpack_require__={};(()=>{__webpack_require__.d=(t,e)=>{for(var s in e){if(__webpack_require__.o(e,s)&&!__webpack_require__.o(t,s)){Object.defineProperty(t,s,{enumerable:true,get:e[s]})}}}})();(()=>{__webpack_require__.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e)})();var __webpack_exports__=globalThis.pdfjsLib={};__webpack_require__.d(__webpack_exports__,{AbortException:()=>AbortException,AnnotationEditorLayer:()=>AnnotationEditorLayer,AnnotationEditorParamsType:()=>AnnotationEditorParamsType,AnnotationEditorType:()=>AnnotationEditorType,AnnotationEditorUIManager:()=>AnnotationEditorUIManager,AnnotationLayer:()=>AnnotationLayer,AnnotationMode:()=>AnnotationMode,CMapCompressionType:()=>CMapCompressionType,ColorPicker:()=>ColorPicker,DOMSVGFactory:()=>DOMSVGFactory,DrawLayer:()=>DrawLayer,FeatureTest:()=>util_FeatureTest,GlobalWorkerOptions:()=>GlobalWorkerOptions,ImageKind:()=>util_ImageKind,InvalidPDFException:()=>InvalidPDFException,MissingPDFException:()=>MissingPDFException,OPS:()=>OPS,Outliner:()=>Outliner,PDFDataRangeTransport:()=>PDFDataRangeTransport,PDFDateString:()=>PDFDateString,PDFWorker:()=>PDFWorker,PasswordResponses:()=>PasswordResponses,PermissionFlag:()=>PermissionFlag,PixelsPerInch:()=>PixelsPerInch,RenderingCancelledException:()=>RenderingCancelledException,TextLayer:()=>TextLayer,UnexpectedResponseException:()=>UnexpectedResponseException,Util:()=>Util,VerbosityLevel:()=>VerbosityLevel,XfaLayer:()=>XfaLayer,build:()=>build,createValidAbsoluteUrl:()=>createValidAbsoluteUrl,fetchData:()=>fetchData,getDocument:()=>getDocument,getFilenameFromUrl:()=>getFilenameFromUrl,getPdfFilenameFromUrl:()=>getPdfFilenameFromUrl,getXfaPageViewport:()=>getXfaPageViewport,isDataScheme:()=>isDataScheme,isPdfFile:()=>isPdfFile,noContextMenu:()=>noContextMenu,normalizeUnicode:()=>normalizeUnicode,renderTextLayer:()=>renderTextLayer,setLayerDimensions:()=>setLayerDimensions,shadow:()=>shadow,updateTextLayer:()=>updateTextLayer,version:()=>version});const isNodeJS=typeof process==="object"&&process+""==="[object process]"&&!process.versions.nw&&!(process.versions.electron&&process.type&&process.type!=="browser");const IDENTITY_MATRIX=[1,0,0,1,0,0];const FONT_IDENTITY_MATRIX=[.001,0,0,.001,0,0];const MAX_IMAGE_SIZE_TO_CACHE=1e7;const LINE_FACTOR=1.35;const LINE_DESCENT_FACTOR=.35;const BASELINE_FACTOR=LINE_DESCENT_FACTOR/LINE_FACTOR;const RenderingIntentFlag={ANY:1,DISPLAY:2,PRINT:4,SAVE:8,ANNOTATIONS_FORMS:16,ANNOTATIONS_STORAGE:32,ANNOTATIONS_DISABLE:64,OPLIST:256};const AnnotationMode={DISABLE:0,ENABLE:1,ENABLE_FORMS:2,ENABLE_STORAGE:3};const AnnotationEditorPrefix="pdfjs_internal_editor_";const AnnotationEditorType={DISABLE:-1,NONE:0,FREETEXT:3,HIGHLIGHT:9,STAMP:13,INK:15};const AnnotationEditorParamsType={RESIZE:1,CREATE:2,FREETEXT_SIZE:11,FREETEXT_COLOR:12,FREETEXT_OPACITY:13,INK_COLOR:21,INK_THICKNESS:22,INK_OPACITY:23,HIGHLIGHT_COLOR:31,HIGHLIGHT_DEFAULT_COLOR:32,HIGHLIGHT_THICKNESS:33,HIGHLIGHT_FREE:34,HIGHLIGHT_SHOW_ALL:35};const PermissionFlag={PRINT:4,MODIFY_CONTENTS:8,COPY:16,MODIFY_ANNOTATIONS:32,FILL_INTERACTIVE_FORMS:256,COPY_FOR_ACCESSIBILITY:512,ASSEMBLE:1024,PRINT_HIGH_QUALITY:2048};const TextRenderingMode={FILL:0,STROKE:1,FILL_STROKE:2,INVISIBLE:3,FILL_ADD_TO_PATH:4,STROKE_ADD_TO_PATH:5,FILL_STROKE_ADD_TO_PATH:6,ADD_TO_PATH:7,FILL_STROKE_MASK:3,ADD_TO_PATH_FLAG:4};const util_ImageKind={GRAYSCALE_1BPP:1,RGB_24BPP:2,RGBA_32BPP:3};const AnnotationType={TEXT:1,LINK:2,FREETEXT:3,LINE:4,SQUARE:5,CIRCLE:6,POLYGON:7,POLYLINE:8,HIGHLIGHT:9,UNDERLINE:10,SQUIGGLY:11,STRIKEOUT:12,STAMP:13,CARET:14,INK:15,POPUP:16,FILEATTACHMENT:17,SOUND:18,MOVIE:19,WIDGET:20,SCREEN:21,PRINTERMARK:22,TRAPNET:23,WATERMARK:24,THREED:25,REDACT:26};const AnnotationReplyType={GROUP:"Group",REPLY:"R"};const AnnotationFlag={INVISIBLE:1,HIDDEN:2,PRINT:4,NOZOOM:8,NOROTATE:16,NOVIEW:32,READONLY:64,LOCKED:128,TOGGLENOVIEW:256,LOCKEDCONTENTS:512};const AnnotationFieldFlag={READONLY:1,REQUIRED:2,NOEXPORT:4,MULTILINE:4096,PASSWORD:8192,NOTOGGLETOOFF:16384,RADIO:32768,PUSHBUTTON:65536,COMBO:131072,EDIT:262144,SORT:524288,FILESELECT:1048576,MULTISELECT:2097152,DONOTSPELLCHECK:4194304,DONOTSCROLL:8388608,COMB:16777216,RICHTEXT:33554432,RADIOSINUNISON:33554432,COMMITONSELCHANGE:67108864};const AnnotationBorderStyleType={SOLID:1,DASHED:2,BEVELED:3,INSET:4,UNDERLINE:5};const AnnotationActionEventType={E:"Mouse Enter",X:"Mouse Exit",D:"Mouse Down",U:"Mouse Up",Fo:"Focus",Bl:"Blur",PO:"PageOpen",PC:"PageClose",PV:"PageVisible",PI:"PageInvisible",K:"Keystroke",F:"Format",V:"Validate",C:"Calculate"};const DocumentActionEventType={WC:"WillClose",WS:"WillSave",DS:"DidSave",WP:"WillPrint",DP:"DidPrint"};const PageActionEventType={O:"PageOpen",C:"PageClose"};const VerbosityLevel={ERRORS:0,WARNINGS:1,INFOS:5};const CMapCompressionType={NONE:0,BINARY:1};const OPS={dependency:1,setLineWidth:2,setLineCap:3,setLineJoin:4,setMiterLimit:5,setDash:6,setRenderingIntent:7,setFlatness:8,setGState:9,save:10,restore:11,transform:12,moveTo:13,lineTo:14,curveTo:15,curveTo2:16,curveTo3:17,closePath:18,rectangle:19,stroke:20,closeStroke:21,fill:22,eoFill:23,fillStroke:24,eoFillStroke:25,closeFillStroke:26,closeEOFillStroke:27,endPath:28,clip:29,eoClip:30,beginText:31,endText:32,setCharSpacing:33,setWordSpacing:34,setHScale:35,setLeading:36,setFont:37,setTextRenderingMode:38,setTextRise:39,moveText:40,setLeadingMoveText:41,setTextMatrix:42,nextLine:43,showText:44,showSpacedText:45,nextLineShowText:46,nextLineSetSpacingShowText:47,setCharWidth:48,setCharWidthAndBounds:49,setStrokeColorSpace:50,setFillColorSpace:51,setStrokeColor:52,setStrokeColorN:53,setFillColor:54,setFillColorN:55,setStrokeGray:56,setFillGray:57,setStrokeRGBColor:58,setFillRGBColor:59,setStrokeCMYKColor:60,setFillCMYKColor:61,shadingFill:62,beginInlineImage:63,beginImageData:64,endInlineImage:65,paintXObject:66,markPoint:67,markPointProps:68,beginMarkedContent:69,beginMarkedContentProps:70,endMarkedContent:71,beginCompat:72,endCompat:73,paintFormXObjectBegin:74,paintFormXObjectEnd:75,beginGroup:76,endGroup:77,beginAnnotation:80,endAnnotation:81,paintImageMaskXObject:83,paintImageMaskXObjectGroup:84,paintImageXObject:85,paintInlineImageXObject:86,paintInlineImageXObjectGroup:87,paintImageXObjectRepeat:88,paintImageMaskXObjectRepeat:89,paintSolidColorImageMask:90,constructPath:91};const PasswordResponses={NEED_PASSWORD:1,INCORRECT_PASSWORD:2};let verbosity=VerbosityLevel.WARNINGS;function setVerbosityLevel(t){if(Number.isInteger(t)){verbosity=t}}function getVerbosityLevel(){return verbosity}function info(t){if(verbosity>=VerbosityLevel.INFOS){console.log(`Info: ${t}`)}}function warn(t){if(verbosity>=VerbosityLevel.WARNINGS){console.log(`Warning: ${t}`)}}function unreachable(t){throw new Error(t)}function assert(t,e){if(!t){unreachable(e)}}function _isValidProtocol(t){switch(t?.protocol){case"http:":case"https:":case"ftp:":case"mailto:":case"tel:":return true;default:return false}}function createValidAbsoluteUrl(t,e=null,s=null){if(!t){return null}try{if(s&&typeof t==="string"){if(s.addDefaultProtocol&&t.startsWith("www.")){const e=t.match(/\./g);if(e?.length>=2){t=`http://${t}`}}if(s.tryConvertEncoding){try{t=stringToUTF8String(t)}catch{}}}const i=e?new URL(t,e):new URL(t);if(_isValidProtocol(i)){return i}}catch{}return null}function shadow(t,e,s,i=false){Object.defineProperty(t,e,{value:s,enumerable:!i,configurable:true,writable:false});return s}const BaseException=function t(){function e(t,s){if(this.constructor===e){unreachable("Cannot initialize BaseException.")}this.message=t;this.name=s}e.prototype=new Error;e.constructor=e;return e}();class PasswordException extends BaseException{constructor(t,e){super(t,"PasswordException");this.code=e}}class UnknownErrorException extends BaseException{constructor(t,e){super(t,"UnknownErrorException");this.details=e}}class InvalidPDFException extends BaseException{constructor(t){super(t,"InvalidPDFException")}}class MissingPDFException extends BaseException{constructor(t){super(t,"MissingPDFException")}}class UnexpectedResponseException extends BaseException{constructor(t,e){super(t,"UnexpectedResponseException");this.status=e}}class FormatError extends BaseException{constructor(t){super(t,"FormatError")}}class AbortException extends BaseException{constructor(t){super(t,"AbortException")}}function bytesToString(t){if(typeof t!=="object"||t?.length===undefined){unreachable("Invalid argument for bytesToString")}const e=t.length;const s=8192;if(e<s){return String.fromCharCode.apply(null,t)}const i=[];for(let n=0;n<e;n+=s){const a=Math.min(n+s,e);const r=t.subarray(n,a);i.push(String.fromCharCode.apply(null,r))}return i.join("")}function stringToBytes(t){if(typeof t!=="string"){unreachable("Invalid argument for stringToBytes")}const e=t.length;const s=new Uint8Array(e);for(let i=0;i<e;++i){s[i]=t.charCodeAt(i)&255}return s}function string32(t){return String.fromCharCode(t>>24&255,t>>16&255,t>>8&255,t&255)}function objectSize(t){return Object.keys(t).length}function objectFromMap(t){const e=Object.create(null);for(const[s,i]of t){e[s]=i}return e}function isLittleEndian(){const t=new Uint8Array(4);t[0]=1;const e=new Uint32Array(t.buffer,0,1);return e[0]===1}function isEvalSupported(){try{new Function("");return true}catch{return false}}class util_FeatureTest{static get isLittleEndian(){return shadow(this,"isLittleEndian",isLittleEndian())}static get isEvalSupported(){return shadow(this,"isEvalSupported",isEvalSupported())}static get isOffscreenCanvasSupported(){return shadow(this,"isOffscreenCanvasSupported",typeof OffscreenCanvas!=="undefined")}static get platform(){if(typeof navigator!=="undefined"&&typeof navigator?.platform==="string"){return shadow(this,"platform",{isMac:navigator.platform.includes("Mac")})}return shadow(this,"platform",{isMac:false})}static get isCSSRoundSupported(){return shadow(this,"isCSSRoundSupported",globalThis.CSS?.supports?.("width: round(1.5px, 1px)"))}}const hexNumbers=Array.from(Array(256).keys(),t=>t.toString(16).padStart(2,"0"));class Util{static makeHexColor(t,e,s){return`#${hexNumbers[t]}${hexNumbers[e]}${hexNumbers[s]}`}static scaleMinMax(t,e){let s;if(t[0]){if(t[0]<0){s=e[0];e[0]=e[2];e[2]=s}e[0]*=t[0];e[2]*=t[0];if(t[3]<0){s=e[1];e[1]=e[3];e[3]=s}e[1]*=t[3];e[3]*=t[3]}else{s=e[0];e[0]=e[1];e[1]=s;s=e[2];e[2]=e[3];e[3]=s;if(t[1]<0){s=e[1];e[1]=e[3];e[3]=s}e[1]*=t[1];e[3]*=t[1];if(t[2]<0){s=e[0];e[0]=e[2];e[2]=s}e[0]*=t[2];e[2]*=t[2]}e[0]+=t[4];e[1]+=t[5];e[2]+=t[4];e[3]+=t[5]}static transform(t,e){return[t[0]*e[0]+t[2]*e[1],t[1]*e[0]+t[3]*e[1],t[0]*e[2]+t[2]*e[3],t[1]*e[2]+t[3]*e[3],t[0]*e[4]+t[2]*e[5]+t[4],t[1]*e[4]+t[3]*e[5]+t[5]]}static applyTransform(t,e){const s=t[0]*e[0]+t[1]*e[2]+e[4];const i=t[0]*e[1]+t[1]*e[3]+e[5];return[s,i]}static applyInverseTransform(t,e){const s=e[0]*e[3]-e[1]*e[2];const i=(t[0]*e[3]-t[1]*e[2]+e[2]*e[5]-e[4]*e[3])/s;const n=(-t[0]*e[1]+t[1]*e[0]+e[4]*e[1]-e[5]*e[0])/s;return[i,n]}static getAxialAlignedBoundingBox(t,e){const s=this.applyTransform(t,e);const i=this.applyTransform(t.slice(2,4),e);const n=this.applyTransform([t[0],t[3]],e);const a=this.applyTransform([t[2],t[1]],e);return[Math.min(s[0],i[0],n[0],a[0]),Math.min(s[1],i[1],n[1],a[1]),Math.max(s[0],i[0],n[0],a[0]),Math.max(s[1],i[1],n[1],a[1])]}static inverseTransform(t){const e=t[0]*t[3]-t[1]*t[2];return[t[3]/e,-t[1]/e,-t[2]/e,t[0]/e,(t[2]*t[5]-t[4]*t[3])/e,(t[4]*t[1]-t[5]*t[0])/e]}static singularValueDecompose2dScale(t){const e=[t[0],t[2],t[1],t[3]];const s=t[0]*e[0]+t[1]*e[2];const i=t[0]*e[1]+t[1]*e[3];const n=t[2]*e[0]+t[3]*e[2];const a=t[2]*e[1]+t[3]*e[3];const r=(s+a)/2;const o=Math.sqrt((s+a)**2-4*(s*a-n*i))/2;const l=r+o||1;const h=r-o||1;return[Math.sqrt(l),Math.sqrt(h)]}static normalizeRect(t){const e=t.slice(0);if(t[0]>t[2]){e[0]=t[2];e[2]=t[0]}if(t[1]>t[3]){e[1]=t[3];e[3]=t[1]}return e}static intersect(t,e){const s=Math.max(Math.min(t[0],t[2]),Math.min(e[0],e[2]));const i=Math.min(Math.max(t[0],t[2]),Math.max(e[0],e[2]));if(s>i){return null}const n=Math.max(Math.min(t[1],t[3]),Math.min(e[1],e[3]));const a=Math.min(Math.max(t[1],t[3]),Math.max(e[1],e[3]));if(n>a){return null}return[s,n,i,a]}static#t(t,e,s,i,n,a,r,o,l,h){if(l<=0||l>=1){return}const c=1-l;const d=l*l;const u=d*l;const p=c*(c*(c*t+3*l*e)+3*d*s)+u*i;const g=c*(c*(c*n+3*l*a)+3*d*r)+u*o;h[0]=Math.min(h[0],p);h[1]=Math.min(h[1],g);h[2]=Math.max(h[2],p);h[3]=Math.max(h[3],g)}static#e(t,e,s,i,n,a,r,o,l,h,c,d){if(Math.abs(l)<1e-12){if(Math.abs(h)>=1e-12){this.#t(t,e,s,i,n,a,r,o,-c/h,d)}return}const u=h**2-4*c*l;if(u<0){return}const p=Math.sqrt(u);const g=2*l;this.#t(t,e,s,i,n,a,r,o,(-h+p)/g,d);this.#t(t,e,s,i,n,a,r,o,(-h-p)/g,d)}static bezierBoundingBox(t,e,s,i,n,a,r,o,l){if(l){l[0]=Math.min(l[0],t,r);l[1]=Math.min(l[1],e,o);l[2]=Math.max(l[2],t,r);l[3]=Math.max(l[3],e,o)}else{l=[Math.min(t,r),Math.min(e,o),Math.max(t,r),Math.max(e,o)]}this.#e(t,s,n,r,e,i,a,o,3*(-t+3*(s-n)+r),6*(t-2*s+n),3*(s-t),l);this.#e(t,s,n,r,e,i,a,o,3*(-e+3*(i-a)+o),6*(e-2*i+a),3*(i-e),l);return l}}const PDFStringTranslateTable=null&&[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,728,711,710,729,733,731,730,732,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,8226,8224,8225,8230,8212,8211,402,8260,8249,8250,8722,8240,8222,8220,8221,8216,8217,8218,8482,64257,64258,321,338,352,376,381,305,322,339,353,382,0,8364];function stringToPDFString(t){if(t[0]>="ï"){let e;if(t[0]==="þ"&&t[1]==="ÿ"){e="utf-16be";if(t.length%2===1){t=t.slice(0,-1)}}else if(t[0]==="ÿ"&&t[1]==="þ"){e="utf-16le";if(t.length%2===1){t=t.slice(0,-1)}}else if(t[0]==="ï"&&t[1]==="»"&&t[2]==="¿"){e="utf-8"}if(e){try{const s=new TextDecoder(e,{fatal:true});const i=stringToBytes(t);const n=s.decode(i);if(!n.includes("")){return n}return n.replaceAll(/\x1b[^\x1b]*(?:\x1b|$)/g,"")}catch(t){warn(`stringToPDFString: "${t}".`)}}}const e=[];for(let s=0,i=t.length;s<i;s++){const n=t.charCodeAt(s);if(n===27){while(++s<i&&t.charCodeAt(s)!==27){}continue}const a=PDFStringTranslateTable[n];e.push(a?String.fromCharCode(a):t.charAt(s))}return e.join("")}function stringToUTF8String(t){return decodeURIComponent(escape(t))}function utf8StringToString(t){return unescape(encodeURIComponent(t))}function isArrayEqual(t,e){if(t.length!==e.length){return false}for(let s=0,i=t.length;s<i;s++){if(t[s]!==e[s]){return false}}return true}function getModificationDate(t=new Date){const e=[t.getUTCFullYear().toString(),(t.getUTCMonth()+1).toString().padStart(2,"0"),t.getUTCDate().toString().padStart(2,"0"),t.getUTCHours().toString().padStart(2,"0"),t.getUTCMinutes().toString().padStart(2,"0"),t.getUTCSeconds().toString().padStart(2,"0")];return e.join("")}let NormalizeRegex=null;let NormalizationMap=null;function normalizeUnicode(t){if(!NormalizeRegex){NormalizeRegex=/([\u00a0\u00b5\u037e\u0eb3\u2000-\u200a\u202f\u2126\ufb00-\ufb04\ufb06\ufb20-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufba1\ufba4-\ufba9\ufbae-\ufbb1\ufbd3-\ufbdc\ufbde-\ufbe7\ufbea-\ufbf8\ufbfc-\ufbfd\ufc00-\ufc5d\ufc64-\ufcf1\ufcf5-\ufd3d\ufd88\ufdf4\ufdfa-\ufdfb\ufe71\ufe77\ufe79\ufe7b\ufe7d]+)|(\ufb05+)/gu;NormalizationMap=new Map([["ﬅ","ſt"]])}return t.replaceAll(NormalizeRegex,(t,e,s)=>e?e.normalize("NFKC"):NormalizationMap.get(s))}function getUuid(){if(typeof crypto!=="undefined"&&typeof crypto?.randomUUID==="function"){return crypto.randomUUID()}const t=new Uint8Array(32);if(typeof crypto!=="undefined"&&typeof crypto?.getRandomValues==="function"){crypto.getRandomValues(t)}else{for(let e=0;e<32;e++){t[e]=Math.floor(Math.random()*255)}}return bytesToString(t)}const AnnotationPrefix="pdfjs_internal_id_";const FontRenderOps={BEZIER_CURVE_TO:0,MOVE_TO:1,LINE_TO:2,QUADRATIC_CURVE_TO:3,RESTORE:4,SAVE:5,SCALE:6,TRANSFORM:7,TRANSLATE:8};class BaseFilterFactory{constructor(){if(this.constructor===BaseFilterFactory){unreachable("Cannot initialize BaseFilterFactory.")}}addFilter(t){return"none"}addHCMFilter(t,e){return"none"}addAlphaFilter(t){return"none"}addLuminosityFilter(t){return"none"}addHighlightHCMFilter(t,e,s,i,n){return"none"}destroy(t=false){}}class BaseCanvasFactory{#s=false;constructor({enableHWA:t=false}={}){if(this.constructor===BaseCanvasFactory){unreachable("Cannot initialize BaseCanvasFactory.")}this.#s=t}create(t,e){if(t<=0||e<=0){throw new Error("Invalid canvas size")}const s=this._createCanvas(t,e);return{canvas:s,context:s.getContext("2d",{willReadFrequently:!this.#s})}}reset(t,e,s){if(!t.canvas){throw new Error("Canvas is not specified")}if(e<=0||s<=0){throw new Error("Invalid canvas size")}t.canvas.width=e;t.canvas.height=s}destroy(t){if(!t.canvas){throw new Error("Canvas is not specified")}t.canvas.width=0;t.canvas.height=0;t.canvas=null;t.context=null}_createCanvas(t,e){unreachable("Abstract method `_createCanvas` called.")}}class BaseCMapReaderFactory{constructor({baseUrl:t=null,isCompressed:e=true}){if(this.constructor===BaseCMapReaderFactory){unreachable("Cannot initialize BaseCMapReaderFactory.")}this.baseUrl=t;this.isCompressed=e}async fetch({name:t}){if(!this.baseUrl){throw new Error('The CMap "baseUrl" parameter must be specified, ensure that '+'the "cMapUrl" and "cMapPacked" API parameters are provided.')}if(!t){throw new Error("CMap name must be specified.")}const e=this.baseUrl+t+(this.isCompressed?".bcmap":"");const s=this.isCompressed?CMapCompressionType.BINARY:CMapCompressionType.NONE;return this._fetchData(e,s).catch(t=>{throw new Error(`Unable to load ${this.isCompressed?"binary ":""}CMap at: ${e}`)})}_fetchData(t,e){unreachable("Abstract method `_fetchData` called.")}}class BaseStandardFontDataFactory{constructor({baseUrl:t=null}){if(this.constructor===BaseStandardFontDataFactory){unreachable("Cannot initialize BaseStandardFontDataFactory.")}this.baseUrl=t}async fetch({filename:t}){if(!this.baseUrl){throw new Error('The standard font "baseUrl" parameter must be specified, ensure that '+'the "standardFontDataUrl" API parameter is provided.')}if(!t){throw new Error("Font filename must be specified.")}const e=`${this.baseUrl}${t}`;return this._fetchData(e).catch(t=>{throw new Error(`Unable to load font data at: ${e}`)})}_fetchData(t){unreachable("Abstract method `_fetchData` called.")}}class BaseSVGFactory{constructor(){if(this.constructor===BaseSVGFactory){unreachable("Cannot initialize BaseSVGFactory.")}}create(t,e,s=false){if(t<=0||e<=0){throw new Error("Invalid SVG dimensions")}const i=this._createSVG("svg:svg");i.setAttribute("version","1.1");if(!s){i.setAttribute("width",`${t}px`);i.setAttribute("height",`${e}px`)}i.setAttribute("preserveAspectRatio","none");i.setAttribute("viewBox",`0 0 ${t} ${e}`);return i}createElement(t){if(typeof t!=="string"){throw new Error("Invalid SVG element type")}return this._createSVG(t)}_createSVG(t){unreachable("Abstract method `_createSVG` called.")}}const SVG_NS="http://www.w3.org/2000/svg";class PixelsPerInch{static CSS=96;static PDF=72;static PDF_TO_CSS_UNITS=this.CSS/this.PDF}class DOMFilterFactory extends BaseFilterFactory{#i;#n;#a;#r;#o;#l=0;constructor({docId:t,ownerDocument:e=globalThis.document}={}){super();this.#a=t;this.#r=e}get#h(){return this.#i||=new Map}get#c(){return this.#o||=new Map}get#d(){if(!this.#n){const t=this.#r.createElement("div");const{style:e}=t;e.visibility="hidden";e.contain="strict";e.width=e.height=0;e.position="absolute";e.top=e.left=0;e.zIndex=-1;const s=this.#r.createElementNS(SVG_NS,"svg");s.setAttribute("width",0);s.setAttribute("height",0);this.#n=this.#r.createElementNS(SVG_NS,"defs");t.append(s);s.append(this.#n);this.#r.body.append(t)}return this.#n}#u(t){if(t.length===1){const e=t[0];const s=new Array(256);for(let t=0;t<256;t++){s[t]=e[t]/255}const i=s.join(",");return[i,i,i]}const[e,s,i]=t;const n=new Array(256);const a=new Array(256);const r=new Array(256);for(let t=0;t<256;t++){n[t]=e[t]/255;a[t]=s[t]/255;r[t]=i[t]/255}return[n.join(","),a.join(","),r.join(",")]}addFilter(t){if(!t){return"none"}let e=this.#h.get(t);if(e){return e}const[s,i,n]=this.#u(t);const a=t.length===1?s:`${s}${i}${n}`;e=this.#h.get(a);if(e){this.#h.set(t,e);return e}const r=`g_${this.#a}_transfer_map_${this.#l++}`;const o=`url(#${r})`;this.#h.set(t,o);this.#h.set(a,o);const l=this.#p(r);this.#g(s,i,n,l);return o}addHCMFilter(t,e){const s=`${t}-${e}`;const i="base";let n=this.#c.get(i);if(n?.key===s){return n.url}if(n){n.filter?.remove();n.key=s;n.url="none";n.filter=null}else{n={key:s,url:"none",filter:null};this.#c.set(i,n)}if(!t||!e){return n.url}const a=this.#f(t);t=Util.makeHexColor(...a);const r=this.#f(e);e=Util.makeHexColor(...r);this.#d.style.color="";if(t==="#000000"&&e==="#ffffff"||t===e){return n.url}const o=new Array(256);for(let t=0;t<=255;t++){const e=t/255;o[t]=e<=.03928?e/12.92:((e+.055)/1.055)**2.4}const l=o.join(",");const h=`g_${this.#a}_hcm_filter`;const c=n.filter=this.#p(h);this.#g(l,l,l,c);this.#m(c);const d=(t,e)=>{const s=a[t]/255;const i=r[t]/255;const n=new Array(e+1);for(let t=0;t<=e;t++){n[t]=s+t/e*(i-s)}return n.join(",")};this.#g(d(0,5),d(1,5),d(2,5),c);n.url=`url(#${h})`;return n.url}addAlphaFilter(t){let e=this.#h.get(t);if(e){return e}const[s]=this.#u([t]);const i=`alpha_${s}`;e=this.#h.get(i);if(e){this.#h.set(t,e);return e}const n=`g_${this.#a}_alpha_map_${this.#l++}`;const a=`url(#${n})`;this.#h.set(t,a);this.#h.set(i,a);const r=this.#p(n);this.#b(s,r);return a}addLuminosityFilter(t){let e=this.#h.get(t||"luminosity");if(e){return e}let s,i;if(t){[s]=this.#u([t]);i=`luminosity_${s}`}else{i="luminosity"}e=this.#h.get(i);if(e){this.#h.set(t,e);return e}const n=`g_${this.#a}_luminosity_map_${this.#l++}`;const a=`url(#${n})`;this.#h.set(t,a);this.#h.set(i,a);const r=this.#p(n);this.#_(r);if(t){this.#b(s,r)}return a}addHighlightHCMFilter(t,e,s,i,n){const a=`${e}-${s}-${i}-${n}`;let r=this.#c.get(t);if(r?.key===a){return r.url}if(r){r.filter?.remove();r.key=a;r.url="none";r.filter=null}else{r={key:a,url:"none",filter:null};this.#c.set(t,r)}if(!e||!s){return r.url}const[o,l]=[e,s].map(this.#f.bind(this));let h=Math.round(.2126*o[0]+.7152*o[1]+.0722*o[2]);let c=Math.round(.2126*l[0]+.7152*l[1]+.0722*l[2]);let[d,u]=[i,n].map(this.#f.bind(this));if(c<h){[h,c,d,u]=[c,h,u,d]}this.#d.style.color="";const p=(t,e,s)=>{const i=new Array(256);const n=(c-h)/s;const a=t/255;const r=(e-t)/(255*s);let o=0;for(let t=0;t<=s;t++){const e=Math.round(h+t*n);const s=a+t*r;for(let t=o;t<=e;t++){i[t]=s}o=e+1}for(let t=o;t<256;t++){i[t]=i[o-1]}return i.join(",")};const g=`g_${this.#a}_hcm_${t}_filter`;const f=r.filter=this.#p(g);this.#m(f);this.#g(p(d[0],u[0],5),p(d[1],u[1],5),p(d[2],u[2],5),f);r.url=`url(#${g})`;return r.url}destroy(t=false){if(t&&this.#c.size!==0){return}if(this.#n){this.#n.parentNode.parentNode.remove();this.#n=null}if(this.#i){this.#i.clear();this.#i=null}this.#l=0}#_(t){const e=this.#r.createElementNS(SVG_NS,"feColorMatrix");e.setAttribute("type","matrix");e.setAttribute("values","0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.3 0.59 0.11 0 0");t.append(e)}#m(t){const e=this.#r.createElementNS(SVG_NS,"feColorMatrix");e.setAttribute("type","matrix");e.setAttribute("values","0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0.2126 0.7152 0.0722 0 0 0 0 0 1 0");t.append(e)}#p(t){const e=this.#r.createElementNS(SVG_NS,"filter");e.setAttribute("color-interpolation-filters","sRGB");e.setAttribute("id",t);this.#d.append(e);return e}#A(t,e,s){const i=this.#r.createElementNS(SVG_NS,e);i.setAttribute("type","discrete");i.setAttribute("tableValues",s);t.append(i)}#g(t,e,s,i){const n=this.#r.createElementNS(SVG_NS,"feComponentTransfer");i.append(n);this.#A(n,"feFuncR",t);this.#A(n,"feFuncG",e);this.#A(n,"feFuncB",s)}#b(t,e){const s=this.#r.createElementNS(SVG_NS,"feComponentTransfer");e.append(s);this.#A(s,"feFuncA",t)}#f(t){this.#d.style.color=t;return getRGB(getComputedStyle(this.#d).getPropertyValue("color"))}}class DOMCanvasFactory extends BaseCanvasFactory{constructor({ownerDocument:t=globalThis.document,enableHWA:e=false}={}){super({enableHWA:e});this._document=t}_createCanvas(t,e){const s=this._document.createElement("canvas");s.width=t;s.height=e;return s}}async function fetchData(t,e="text"){if(isValidFetchUrl(t,document.baseURI)){const s=await fetch(t);if(!s.ok){throw new Error(s.statusText)}switch(e){case"arraybuffer":return s.arrayBuffer();case"blob":return s.blob();case"json":return s.json()}return s.text()}return new Promise((s,i)=>{const n=new XMLHttpRequest;n.open("GET",t,true);n.responseType=e;n.onreadystatechange=()=>{if(n.readyState!==XMLHttpRequest.DONE){return}if(n.status===200||n.status===0){switch(e){case"arraybuffer":case"blob":case"json":s(n.response);return}s(n.responseText);return}i(new Error(n.statusText))};n.send(null)})}class DOMCMapReaderFactory extends BaseCMapReaderFactory{_fetchData(t,e){return fetchData(t,this.isCompressed?"arraybuffer":"text").then(t=>({cMapData:t instanceof ArrayBuffer?new Uint8Array(t):stringToBytes(t),compressionType:e}))}}class DOMStandardFontDataFactory extends BaseStandardFontDataFactory{_fetchData(t){return fetchData(t,"arraybuffer").then(t=>new Uint8Array(t))}}class DOMSVGFactory extends BaseSVGFactory{_createSVG(t){return document.createElementNS(SVG_NS,t)}}class PageViewport{constructor({viewBox:t,scale:e,rotation:s,offsetX:i=0,offsetY:n=0,dontFlip:a=false}){this.viewBox=t;this.scale=e;this.rotation=s;this.offsetX=i;this.offsetY=n;const r=(t[2]+t[0])/2;const o=(t[3]+t[1])/2;let l,h,c,d;s%=360;if(s<0){s+=360}switch(s){case 180:l=-1;h=0;c=0;d=1;break;case 90:l=0;h=1;c=1;d=0;break;case 270:l=0;h=-1;c=-1;d=0;break;case 0:l=1;h=0;c=0;d=-1;break;default:throw new Error("PageViewport: Invalid rotation, must be a multiple of 90 degrees.")}if(a){c=-c;d=-d}let u,p;let g,f;if(l===0){u=Math.abs(o-t[1])*e+i;p=Math.abs(r-t[0])*e+n;g=(t[3]-t[1])*e;f=(t[2]-t[0])*e}else{u=Math.abs(r-t[0])*e+i;p=Math.abs(o-t[1])*e+n;g=(t[2]-t[0])*e;f=(t[3]-t[1])*e}this.transform=[l*e,h*e,c*e,d*e,u-l*e*r-c*e*o,p-h*e*r-d*e*o];this.width=g;this.height=f}get rawDims(){const{viewBox:t}=this;return shadow(this,"rawDims",{pageWidth:t[2]-t[0],pageHeight:t[3]-t[1],pageX:t[0],pageY:t[1]})}clone({scale:t=this.scale,rotation:e=this.rotation,offsetX:s=this.offsetX,offsetY:i=this.offsetY,dontFlip:n=false}={}){return new PageViewport({viewBox:this.viewBox.slice(),scale:t,rotation:e,offsetX:s,offsetY:i,dontFlip:n})}convertToViewportPoint(t,e){return Util.applyTransform([t,e],this.transform)}convertToViewportRectangle(t){const e=Util.applyTransform([t[0],t[1]],this.transform);const s=Util.applyTransform([t[2],t[3]],this.transform);return[e[0],e[1],s[0],s[1]]}convertToPdfPoint(t,e){return Util.applyInverseTransform([t,e],this.transform)}}class RenderingCancelledException extends BaseException{constructor(t,e=0){super(t,"RenderingCancelledException");this.extraDelay=e}}function isDataScheme(t){const e=t.length;let s=0;while(s<e&&t[s].trim()===""){s++}return t.substring(s,s+5).toLowerCase()==="data:"}function isPdfFile(t){return typeof t==="string"&&/\.pdf$/i.test(t)}function getFilenameFromUrl(t){[t]=t.split(/[#?]/,1);return t.substring(t.lastIndexOf("/")+1)}function getPdfFilenameFromUrl(t,e="document.pdf"){if(typeof t!=="string"){return e}if(isDataScheme(t)){warn('getPdfFilenameFromUrl: ignore "data:"-URL for performance reasons.');return e}const s=/^(?:(?:[^:]+:)?\/\/[^/]+)?([^?#]*)(\?[^#]*)?(#.*)?$/;const i=/[^/?#=]+\.pdf\b(?!.*\.pdf\b)/i;const n=s.exec(t);let a=i.exec(n[1])||i.exec(n[2])||i.exec(n[3]);if(a){a=a[0];if(a.includes("%")){try{a=i.exec(decodeURIComponent(a))[0]}catch{}}}return a||e}class StatTimer{started=Object.create(null);times=[];time(t){if(t in this.started){warn(`Timer is already running for ${t}`)}this.started[t]=Date.now()}timeEnd(t){if(!(t in this.started)){warn(`Timer has not been started for ${t}`)}this.times.push({name:t,start:this.started[t],end:Date.now()});delete this.started[t]}toString(){const t=[];let e=0;for(const{name:t}of this.times){e=Math.max(t.length,e)}for(const{name:s,start:i,end:n}of this.times){t.push(`${s.padEnd(e)} ${n-i}ms\n`)}return t.join("")}}function isValidFetchUrl(t,e){try{const{protocol:s}=e?new URL(t,e):new URL(t);return s==="http:"||s==="https:"}catch{return false}}function noContextMenu(t){t.preventDefault()}function deprecated(t){console.log("Deprecated API usage: "+t)}let pdfDateStringRegex;class PDFDateString{static toDateObject(t){if(!t||typeof t!=="string"){return null}pdfDateStringRegex||=new RegExp("^D:"+"(\\d{4})"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"(\\d{2})?"+"([Z|+|-])?"+"(\\d{2})?"+"'?"+"(\\d{2})?"+"'?");const e=pdfDateStringRegex.exec(t);if(!e){return null}const s=parseInt(e[1],10);let i=parseInt(e[2],10);i=i>=1&&i<=12?i-1:0;let n=parseInt(e[3],10);n=n>=1&&n<=31?n:1;let a=parseInt(e[4],10);a=a>=0&&a<=23?a:0;let r=parseInt(e[5],10);r=r>=0&&r<=59?r:0;let o=parseInt(e[6],10);o=o>=0&&o<=59?o:0;const l=e[7]||"Z";let h=parseInt(e[8],10);h=h>=0&&h<=23?h:0;let c=parseInt(e[9],10)||0;c=c>=0&&c<=59?c:0;if(l==="-"){a+=h;r+=c}else if(l==="+"){a-=h;r-=c}return new Date(Date.UTC(s,i,n,a,r,o))}}function getXfaPageViewport(t,{scale:e=1,rotation:s=0}){const{width:i,height:n}=t.attributes.style;const a=[0,0,parseInt(i),parseInt(n)];return new PageViewport({viewBox:a,scale:e,rotation:s})}function getRGB(t){if(t.startsWith("#")){const e=parseInt(t.slice(1),16);return[(e&16711680)>>16,(e&65280)>>8,e&255]}if(t.startsWith("rgb(")){return t.slice(4,-1).split(",").map(t=>parseInt(t))}if(t.startsWith("rgba(")){return t.slice(5,-1).split(",").map(t=>parseInt(t)).slice(0,3)}warn(`Not a valid color format: "${t}"`);return[0,0,0]}function getColorValues(t){const e=document.createElement("span");e.style.visibility="hidden";document.body.append(e);for(const s of t.keys()){e.style.color=s;const i=window.getComputedStyle(e).color;t.set(s,getRGB(i))}e.remove()}function getCurrentTransform(t){const{a:e,b:s,c:i,d:n,e:a,f:r}=t.getTransform();return[e,s,i,n,a,r]}function getCurrentTransformInverse(t){const{a:e,b:s,c:i,d:n,e:a,f:r}=t.getTransform().invertSelf();return[e,s,i,n,a,r]}function setLayerDimensions(t,e,s=false,i=true){if(e instanceof PageViewport){const{pageWidth:i,pageHeight:n}=e.rawDims;const{style:a}=t;const r=util_FeatureTest.isCSSRoundSupported;const o=`var(--scale-factor) * ${i}px`,l=`var(--scale-factor) * ${n}px`;const h=r?`round(${o}, 1px)`:`calc(${o})`,c=r?`round(${l}, 1px)`:`calc(${l})`;if(!s||e.rotation%180===0){a.width=h;a.height=c}else{a.width=c;a.height=h}}if(i){t.setAttribute("data-main-rotation",e.rotation)}}class EditorToolbar{#v=null;#y=null;#E;#w=null;constructor(t){this.#E=t}render(){const t=this.#v=document.createElement("div");t.className="editToolbar";t.setAttribute("role","toolbar");const e=this.#E._uiManager._signal;t.addEventListener("contextmenu",noContextMenu,{signal:e});t.addEventListener("pointerdown",EditorToolbar.#x,{signal:e});const s=this.#w=document.createElement("div");s.className="buttons";t.append(s);const i=this.#E.toolbarPosition;if(i){const{style:e}=t;const s=this.#E._uiManager.direction==="ltr"?1-i[0]:i[0];e.insetInlineEnd=`${100*s}%`;e.top=`calc(${100*i[1]}% + var(--editor-toolbar-vert-offset))`}this.#T();return t}static#x(t){t.stopPropagation()}#S(t){this.#E._focusEventsAllowed=false;t.preventDefault();t.stopPropagation()}#C(t){this.#E._focusEventsAllowed=true;t.preventDefault();t.stopPropagation()}#P(t){const e=this.#E._uiManager._signal;t.addEventListener("focusin",this.#S.bind(this),{capture:true,signal:e});t.addEventListener("focusout",this.#C.bind(this),{capture:true,signal:e});t.addEventListener("contextmenu",noContextMenu,{signal:e})}hide(){this.#v.classList.add("hidden");this.#y?.hideDropdown()}show(){this.#v.classList.remove("hidden")}#T(){const t=document.createElement("button");t.className="delete";t.tabIndex=0;t.setAttribute("data-l10n-id",`pdfjs-editor-remove-${this.#E.editorType}-button`);this.#P(t);t.addEventListener("click",t=>{this.#E._uiManager.delete()},{signal:this.#E._uiManager._signal});this.#w.append(t)}get#M(){const t=document.createElement("div");t.className="divider";return t}addAltTextButton(t){this.#P(t);this.#w.prepend(t,this.#M)}addColorPicker(t){this.#y=t;const e=t.renderButton();this.#P(e);this.#w.prepend(e,this.#M)}remove(){this.#v.remove();this.#y?.destroy();this.#y=null}}class HighlightToolbar{#w=null;#v=null;#k;constructor(t){this.#k=t}#I(){const t=this.#v=document.createElement("div");t.className="editToolbar";t.setAttribute("role","toolbar");t.addEventListener("contextmenu",noContextMenu,{signal:this.#k._signal});const e=this.#w=document.createElement("div");e.className="buttons";t.append(e);this.#R();return t}#F(t,e){let s=0;let i=0;for(const n of t){const t=n.y+n.height;if(t<s){continue}const a=n.x+(e?n.width:0);if(t>s){i=a;s=t;continue}if(e){if(a>i){i=a}}else if(a<i){i=a}}return[e?1-i:i,s]}show(t,e,s){const[i,n]=this.#F(e,s);const{style:a}=this.#v||=this.#I();t.append(this.#v);a.insetInlineEnd=`${100*i}%`;a.top=`calc(${100*n}% + var(--editor-toolbar-vert-offset))`}hide(){this.#v.remove()}#R(){const t=document.createElement("button");t.className="highlightButton";t.tabIndex=0;t.setAttribute("data-l10n-id",`pdfjs-highlight-floating-button1`);const e=document.createElement("span");t.append(e);e.className="visuallyHidden";e.setAttribute("data-l10n-id","pdfjs-highlight-floating-button-label");const s=this.#k._signal;t.addEventListener("contextmenu",noContextMenu,{signal:s});t.addEventListener("click",()=>{this.#k.highlightSelection("floating_button")},{signal:s});this.#w.append(t)}}function bindEvents(t,e,s){for(const i of s){e.addEventListener(i,t[i].bind(t))}}function opacityToHex(t){return Math.round(Math.min(255,Math.max(1,255*t))).toString(16).padStart(2,"0")}class IdManager{#l=0;get id(){return`${AnnotationEditorPrefix}${this.#l++}`}}class ImageManager{#L=getUuid();#l=0;#h=null;static get _isSVGFittingCanvas(){const t=`data:image/svg+xml;charset=UTF-8,<svg viewBox="0 0 1 1" width="1" height="1" xmlns="http://www.w3.org/2000/svg"><rect width="1" height="1" style="fill:red;"/></svg>`;const e=new OffscreenCanvas(1,3);const s=e.getContext("2d",{willReadFrequently:true});const i=new Image;i.src=t;const n=i.decode().then(()=>{s.drawImage(i,0,0,1,1,0,0,1,3);return new Uint32Array(s.getImageData(0,0,1,1).data.buffer)[0]===0});return shadow(this,"_isSVGFittingCanvas",n)}async#D(t,e){this.#h||=new Map;let s=this.#h.get(t);if(s===null){return null}if(s?.bitmap){s.refCounter+=1;return s}try{s||={bitmap:null,id:`image_${this.#L}_${this.#l++}`,refCounter:0,isSvg:false};let t;if(typeof e==="string"){s.url=e;t=await fetchData(e,"blob")}else{t=s.file=e}if(t.type==="image/svg+xml"){const e=ImageManager._isSVGFittingCanvas;const i=new FileReader;const n=new Image;const a=new Promise((t,a)=>{n.onload=()=>{s.bitmap=n;s.isSvg=true;t()};i.onload=async()=>{const t=s.svgUrl=i.result;n.src=await e?`${t}#svgView(preserveAspectRatio(none))`:t};n.onerror=i.onerror=a});i.readAsDataURL(t);await a}else{s.bitmap=await createImageBitmap(t)}s.refCounter=1}catch(t){console.error(t);s=null}this.#h.set(t,s);if(s){this.#h.set(s.id,s)}return s}async getFromFile(t){const{lastModified:e,name:s,size:i,type:n}=t;return this.#D(`${e}_${s}_${i}_${n}`,t)}async getFromUrl(t){return this.#D(t,t)}async getFromId(t){this.#h||=new Map;const e=this.#h.get(t);if(!e){return null}if(e.bitmap){e.refCounter+=1;return e}if(e.file){return this.getFromFile(e.file)}return this.getFromUrl(e.url)}getSvgUrl(t){const e=this.#h.get(t);if(!e?.isSvg){return null}return e.svgUrl}deleteId(t){this.#h||=new Map;const e=this.#h.get(t);if(!e){return}e.refCounter-=1;if(e.refCounter!==0){return}e.bitmap=null}isValidId(t){return t.startsWith(`image_${this.#L}_`)}}class CommandManager{#O=[];#N=false;#B;#H=-1;constructor(t=128){this.#B=t}add({cmd:t,undo:e,post:s,mustExec:i,type:n=NaN,overwriteIfSameType:a=false,keepUndo:r=false}){if(i){t()}if(this.#N){return}const o={cmd:t,undo:e,post:s,type:n};if(this.#H===-1){if(this.#O.length>0){this.#O.length=0}this.#H=0;this.#O.push(o);return}if(a&&this.#O[this.#H].type===n){if(r){o.undo=this.#O[this.#H].undo}this.#O[this.#H]=o;return}const l=this.#H+1;if(l===this.#B){this.#O.splice(0,1)}else{this.#H=l;if(l<this.#O.length){this.#O.splice(l)}}this.#O.push(o)}undo(){if(this.#H===-1){return}this.#N=true;const{undo:t,post:e}=this.#O[this.#H];t();e?.();this.#N=false;this.#H-=1}redo(){if(this.#H<this.#O.length-1){this.#H+=1;this.#N=true;const{cmd:t,post:e}=this.#O[this.#H];t();e?.();this.#N=false}}hasSomethingToUndo(){return this.#H!==-1}hasSomethingToRedo(){return this.#H<this.#O.length-1}destroy(){this.#O=null}}class KeyboardManager{constructor(t){this.buffer=[];this.callbacks=new Map;this.allKeys=new Set;const{isMac:e}=util_FeatureTest.platform;for(const[s,i,n={}]of t){for(const t of s){const s=t.startsWith("mac+");if(e&&s){this.callbacks.set(t.slice(4),{callback:i,options:n});this.allKeys.add(t.split("+").at(-1))}else if(!e&&!s){this.callbacks.set(t,{callback:i,options:n});this.allKeys.add(t.split("+").at(-1))}}}}#U(t){if(t.altKey){this.buffer.push("alt")}if(t.ctrlKey){this.buffer.push("ctrl")}if(t.metaKey){this.buffer.push("meta")}if(t.shiftKey){this.buffer.push("shift")}this.buffer.push(t.key);const e=this.buffer.join("+");this.buffer.length=0;return e}exec(t,e){if(!this.allKeys.has(e.key)){return}const s=this.callbacks.get(this.#U(e));if(!s){return}const{callback:i,options:{bubbles:n=false,args:a=[],checker:r=null}}=s;if(r&&!r(t,e)){return}i.bind(t,...a,e)();if(!n){e.stopPropagation();e.preventDefault()}}}class ColorManager{static _colorsMapping=new Map([["CanvasText",[0,0,0]],["Canvas",[255,255,255]]]);get _colors(){const t=new Map([["CanvasText",null],["Canvas",null]]);getColorValues(t);return shadow(this,"_colors",t)}convert(t){const e=getRGB(t);if(!window.matchMedia("(forced-colors: active)").matches){return e}for(const[t,s]of this._colors){if(s.every((t,s)=>t===e[s])){return ColorManager._colorsMapping.get(t)}}return e}getHexCode(t){const e=this._colors.get(t);if(!e){return t}return Util.makeHexColor(...e)}}class AnnotationEditorUIManager{#z=new AbortController;#G=null;#V=new Map;#W=new Map;#j=null;#$=null;#K=null;#q=new CommandManager;#X=0;#Y=new Set;#J=null;#Q=null;#Z=new Set;#tt=false;#et=null;#st=null;#it=null;#nt=false;#at=null;#rt=new IdManager;#ot=false;#lt=false;#ht=null;#ct=null;#dt=null;#ut=AnnotationEditorType.NONE;#pt=new Set;#gt=null;#ft=null;#mt=null;#bt=this.blur.bind(this);#_t=this.focus.bind(this);#At=this.copy.bind(this);#vt=this.cut.bind(this);#yt=this.paste.bind(this);#Et=this.keydown.bind(this);#wt=this.keyup.bind(this);#xt=this.onEditingAction.bind(this);#Tt=this.onPageChanging.bind(this);#St=this.onScaleChanging.bind(this);#Ct=this.onRotationChanging.bind(this);#Pt={isEditing:false,isEmpty:true,hasSomethingToUndo:false,hasSomethingToRedo:false,hasSelectedEditor:false,hasSelectedText:false};#Mt=[0,0];#kt=null;#It=null;#Rt=null;static TRANSLATE_SMALL=1;static TRANSLATE_BIG=10;static get _keyboardManager(){const t=AnnotationEditorUIManager.prototype;const e=t=>t.#It.contains(document.activeElement)&&document.activeElement.tagName!=="BUTTON"&&t.hasSomethingToControl();const s=(t,{target:e})=>{if(e instanceof HTMLInputElement){const{type:t}=e;return t!=="text"&&t!=="number"}return true};const i=this.TRANSLATE_SMALL;const n=this.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+a","mac+meta+a"],t.selectAll,{checker:s}],[["ctrl+z","mac+meta+z"],t.undo,{checker:s}],[["ctrl+y","ctrl+shift+z","mac+meta+shift+z","ctrl+shift+Z","mac+meta+shift+Z"],t.redo,{checker:s}],[["Backspace","alt+Backspace","ctrl+Backspace","shift+Backspace","mac+Backspace","mac+alt+Backspace","mac+ctrl+Backspace","Delete","ctrl+Delete","shift+Delete","mac+Delete"],t.delete,{checker:s}],[["Enter","mac+Enter"],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#It.contains(e)&&!t.isEnterHandled}],[[" ","mac+ "],t.addNewEditorFromKeyboard,{checker:(t,{target:e})=>!(e instanceof HTMLButtonElement)&&t.#It.contains(document.activeElement)}],[["Escape","mac+Escape"],t.unselectAll],[["ArrowLeft","mac+ArrowLeft"],t.translateSelectedEditors,{args:[-i,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t.translateSelectedEditors,{args:[-n,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t.translateSelectedEditors,{args:[i,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t.translateSelectedEditors,{args:[n,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t.translateSelectedEditors,{args:[0,-i],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t.translateSelectedEditors,{args:[0,-n],checker:e}],[["ArrowDown","mac+ArrowDown"],t.translateSelectedEditors,{args:[0,i],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t.translateSelectedEditors,{args:[0,n],checker:e}]]))}constructor(t,e,s,i,n,a,r,o,l){this._signal=this.#z.signal;this.#It=t;this.#Rt=e;this.#j=s;this._eventBus=i;this._eventBus._on("editingaction",this.#xt);this._eventBus._on("pagechanging",this.#Tt);this._eventBus._on("scalechanging",this.#St);this._eventBus._on("rotationchanging",this.#Ct);this.#Ft();this.#Lt();this.#Dt();this.#$=n.annotationStorage;this.#et=n.filterFactory;this.#ft=a;this.#it=r||null;this.#tt=o;this.#dt=l||null;this.viewParameters={realScale:PixelsPerInch.PDF_TO_CSS_UNITS,rotation:0};this.isShiftKeyDown=false}destroy(){this.#z?.abort();this.#z=null;this._signal=null;this._eventBus._off("editingaction",this.#xt);this._eventBus._off("pagechanging",this.#Tt);this._eventBus._off("scalechanging",this.#St);this._eventBus._off("rotationchanging",this.#Ct);for(const t of this.#W.values()){t.destroy()}this.#W.clear();this.#V.clear();this.#Z.clear();this.#G=null;this.#pt.clear();this.#q.destroy();this.#j?.destroy();this.#at?.hide();this.#at=null;if(this.#st){clearTimeout(this.#st);this.#st=null}if(this.#kt){clearTimeout(this.#kt);this.#kt=null}}async mlGuess(t){return this.#dt?.guess(t)||null}get hasMLManager(){return!!this.#dt}get hcmFilter(){return shadow(this,"hcmFilter",this.#ft?this.#et.addHCMFilter(this.#ft.foreground,this.#ft.background):"none")}get direction(){return shadow(this,"direction",getComputedStyle(this.#It).direction)}get highlightColors(){return shadow(this,"highlightColors",this.#it?new Map(this.#it.split(",").map(t=>t.split("=").map(t=>t.trim()))):null)}get highlightColorNames(){return shadow(this,"highlightColorNames",this.highlightColors?new Map(Array.from(this.highlightColors,t=>t.reverse())):null)}setMainHighlightColorPicker(t){this.#ct=t}editAltText(t){this.#j?.editAltText(this,t)}onPageChanging({pageNumber:t}){this.#X=t-1}focusMainContainer(){this.#It.focus()}findParent(t,e){for(const s of this.#W.values()){const{x:i,y:n,width:a,height:r}=s.div.getBoundingClientRect();if(t>=i&&t<=i+a&&e>=n&&e<=n+r){return s}}return null}disableUserSelect(t=false){this.#Rt.classList.toggle("noUserSelect",t)}addShouldRescale(t){this.#Z.add(t)}removeShouldRescale(t){this.#Z.delete(t)}onScaleChanging({scale:t}){this.commitOrRemove();this.viewParameters.realScale=t*PixelsPerInch.PDF_TO_CSS_UNITS;for(const t of this.#Z){t.onScaleChanging()}}onRotationChanging({pagesRotation:t}){this.commitOrRemove();this.viewParameters.rotation=t}#Ot({anchorNode:t}){return t.nodeType===Node.TEXT_NODE?t.parentElement:t}highlightSelection(t=""){const e=document.getSelection();if(!e||e.isCollapsed){return}const{anchorNode:s,anchorOffset:i,focusNode:n,focusOffset:a}=e;const r=e.toString();const o=this.#Ot(e);const l=o.closest(".textLayer");const h=this.getSelectionBoxes(l);if(!h){return}e.empty();if(this.#ut===AnnotationEditorType.NONE){this._eventBus.dispatch("showannotationeditorui",{source:this,mode:AnnotationEditorType.HIGHLIGHT});this.showAllEditors("highlight",true,true)}for(const e of this.#W.values()){if(e.hasTextLayer(l)){e.createAndAddNewEditor({x:0,y:0},false,{methodOfCreation:t,boxes:h,anchorNode:s,anchorOffset:i,focusNode:n,focusOffset:a,text:r});break}}}#Nt(){const t=document.getSelection();if(!t||t.isCollapsed){return}const e=this.#Ot(t);const s=e.closest(".textLayer");const i=this.getSelectionBoxes(s);if(!i){return}this.#at||=new HighlightToolbar(this);this.#at.show(s,i,this.direction==="ltr")}addToAnnotationStorage(t){if(!t.isEmpty()&&this.#$&&!this.#$.has(t.id)){this.#$.setValue(t.id,t)}}#Bt(){const t=document.getSelection();if(!t||t.isCollapsed){if(this.#gt){this.#at?.hide();this.#gt=null;this.#Ht({hasSelectedText:false})}return}const{anchorNode:e}=t;if(e===this.#gt){return}const s=this.#Ot(t);const i=s.closest(".textLayer");if(!i){if(this.#gt){this.#at?.hide();this.#gt=null;this.#Ht({hasSelectedText:false})}return}this.#at?.hide();this.#gt=e;this.#Ht({hasSelectedText:true});if(this.#ut!==AnnotationEditorType.HIGHLIGHT&&this.#ut!==AnnotationEditorType.NONE){return}if(this.#ut===AnnotationEditorType.HIGHLIGHT){this.showAllEditors("highlight",true,true)}this.#nt=this.isShiftKeyDown;if(!this.isShiftKeyDown){const t=this._signal;const e=t=>{if(t.type==="pointerup"&&t.button!==0){return}window.removeEventListener("pointerup",e);window.removeEventListener("blur",e);if(t.type==="pointerup"){this.#Ut("main_toolbar")}};window.addEventListener("pointerup",e,{signal:t});window.addEventListener("blur",e,{signal:t})}}#Ut(t=""){if(this.#ut===AnnotationEditorType.HIGHLIGHT){this.highlightSelection(t)}else if(this.#tt){this.#Nt()}}#Ft(){document.addEventListener("selectionchange",this.#Bt.bind(this),{signal:this._signal})}#zt(){const t=this._signal;window.addEventListener("focus",this.#_t,{signal:t});window.addEventListener("blur",this.#bt,{signal:t})}#Gt(){window.removeEventListener("focus",this.#_t);window.removeEventListener("blur",this.#bt)}blur(){this.isShiftKeyDown=false;if(this.#nt){this.#nt=false;this.#Ut("main_toolbar")}if(!this.hasSelection){return}const{activeElement:t}=document;for(const e of this.#pt){if(e.div.contains(t)){this.#ht=[e,t];e._focusEventsAllowed=false;break}}}focus(){if(!this.#ht){return}const[t,e]=this.#ht;this.#ht=null;e.addEventListener("focusin",()=>{t._focusEventsAllowed=true},{once:true,signal:this._signal});e.focus()}#Dt(){const t=this._signal;window.addEventListener("keydown",this.#Et,{signal:t});window.addEventListener("keyup",this.#wt,{signal:t})}#Vt(){window.removeEventListener("keydown",this.#Et);window.removeEventListener("keyup",this.#wt)}#Wt(){const t=this._signal;document.addEventListener("copy",this.#At,{signal:t});document.addEventListener("cut",this.#vt,{signal:t});document.addEventListener("paste",this.#yt,{signal:t})}#jt(){document.removeEventListener("copy",this.#At);document.removeEventListener("cut",this.#vt);document.removeEventListener("paste",this.#yt)}#Lt(){const t=this._signal;document.addEventListener("dragover",this.dragOver.bind(this),{signal:t});document.addEventListener("drop",this.drop.bind(this),{signal:t})}addEditListeners(){this.#Dt();this.#Wt()}removeEditListeners(){this.#Vt();this.#jt()}dragOver(t){for(const{type:e}of t.dataTransfer.items){for(const s of this.#Q){if(s.isHandlingMimeForPasting(e)){t.dataTransfer.dropEffect="copy";t.preventDefault();return}}}}drop(t){for(const e of t.dataTransfer.items){for(const s of this.#Q){if(s.isHandlingMimeForPasting(e.type)){s.paste(e,this.currentLayer);t.preventDefault();return}}}}copy(t){t.preventDefault();this.#G?.commitOrRemove();if(!this.hasSelection){return}const e=[];for(const t of this.#pt){const s=t.serialize(true);if(s){e.push(s)}}if(e.length===0){return}t.clipboardData.setData("application/pdfjs",JSON.stringify(e))}cut(t){this.copy(t);this.delete()}paste(t){t.preventDefault();const{clipboardData:e}=t;for(const t of e.items){for(const e of this.#Q){if(e.isHandlingMimeForPasting(t.type)){e.paste(t,this.currentLayer);return}}}let s=e.getData("application/pdfjs");if(!s){return}try{s=JSON.parse(s)}catch(t){warn(`paste: "${t.message}".`);return}if(!Array.isArray(s)){return}this.unselectAll();const i=this.currentLayer;try{const t=[];for(const e of s){const s=i.deserialize(e);if(!s){return}t.push(s)}const e=()=>{for(const e of t){this.#$t(e)}this.#Kt(t)};const n=()=>{for(const e of t){e.remove()}};this.addCommands({cmd:e,undo:n,mustExec:true})}catch(t){warn(`paste: "${t.message}".`)}}keydown(t){if(!this.isShiftKeyDown&&t.key==="Shift"){this.isShiftKeyDown=true}if(this.#ut!==AnnotationEditorType.NONE&&!this.isEditorHandlingKeyboard){AnnotationEditorUIManager._keyboardManager.exec(this,t)}}keyup(t){if(this.isShiftKeyDown&&t.key==="Shift"){this.isShiftKeyDown=false;if(this.#nt){this.#nt=false;this.#Ut("main_toolbar")}}}onEditingAction({name:t}){switch(t){case"undo":case"redo":case"delete":case"selectAll":this[t]();break;case"highlightSelection":this.highlightSelection("context_menu");break}}#Ht(t){const e=Object.entries(t).some(([t,e])=>this.#Pt[t]!==e);if(e){this._eventBus.dispatch("annotationeditorstateschanged",{source:this,details:Object.assign(this.#Pt,t)});if(this.#ut===AnnotationEditorType.HIGHLIGHT&&t.hasSelectedEditor===false){this.#qt([[AnnotationEditorParamsType.HIGHLIGHT_FREE,true]])}}}#qt(t){this._eventBus.dispatch("annotationeditorparamschanged",{source:this,details:t})}setEditingState(t){if(t){this.#zt();this.#Wt();this.#Ht({isEditing:this.#ut!==AnnotationEditorType.NONE,isEmpty:this.#Xt(),hasSomethingToUndo:this.#q.hasSomethingToUndo(),hasSomethingToRedo:this.#q.hasSomethingToRedo(),hasSelectedEditor:false})}else{this.#Gt();this.#jt();this.#Ht({isEditing:false});this.disableUserSelect(false)}}registerEditorTypes(t){if(this.#Q){return}this.#Q=t;for(const t of this.#Q){this.#qt(t.defaultPropertiesToUpdate)}}getId(){return this.#rt.id}get currentLayer(){return this.#W.get(this.#X)}getLayer(t){return this.#W.get(t)}get currentPageIndex(){return this.#X}addLayer(t){this.#W.set(t.pageIndex,t);if(this.#ot){t.enable()}else{t.disable()}}removeLayer(t){this.#W.delete(t.pageIndex)}updateMode(t,e=null,s=false){if(this.#ut===t){return}this.#ut=t;if(t===AnnotationEditorType.NONE){this.setEditingState(false);this.#Yt();return}this.setEditingState(true);this.#Jt();this.unselectAll();for(const e of this.#W.values()){e.updateMode(t)}if(!e&&s){this.addNewEditorFromKeyboard();return}if(!e){return}for(const t of this.#V.values()){if(t.annotationElementId===e){this.setSelected(t);t.enterInEditMode();break}}}addNewEditorFromKeyboard(){if(this.currentLayer.canCreateNewEmptyEditor()){this.currentLayer.addNewEditor()}}updateToolbar(t){if(t===this.#ut){return}this._eventBus.dispatch("switchannotationeditormode",{source:this,mode:t})}updateParams(t,e){if(!this.#Q){return}switch(t){case AnnotationEditorParamsType.CREATE:this.currentLayer.addNewEditor();return;case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:this.#ct?.updateColor(e);break;case AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL:this._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:{type:"highlight",action:"toggle_visibility"}}});(this.#mt||=new Map).set(t,e);this.showAllEditors("highlight",e);break}for(const s of this.#pt){s.updateParams(t,e)}for(const s of this.#Q){s.updateDefaultParams(t,e)}}showAllEditors(t,e,s=false){for(const s of this.#V.values()){if(s.editorType===t){s.show(e)}}const i=this.#mt?.get(AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL)??true;if(i!==e){this.#qt([[AnnotationEditorParamsType.HIGHLIGHT_SHOW_ALL,e]])}}enableWaiting(t=false){if(this.#lt===t){return}this.#lt=t;for(const e of this.#W.values()){if(t){e.disableClick()}else{e.enableClick()}e.div.classList.toggle("waiting",t)}}#Jt(){if(!this.#ot){this.#ot=true;for(const t of this.#W.values()){t.enable()}for(const t of this.#V.values()){t.enable()}}}#Yt(){this.unselectAll();if(this.#ot){this.#ot=false;for(const t of this.#W.values()){t.disable()}for(const t of this.#V.values()){t.disable()}}}getEditors(t){const e=[];for(const s of this.#V.values()){if(s.pageIndex===t){e.push(s)}}return e}getEditor(t){return this.#V.get(t)}addEditor(t){this.#V.set(t.id,t)}removeEditor(t){if(t.div.contains(document.activeElement)){if(this.#st){clearTimeout(this.#st)}this.#st=setTimeout(()=>{this.focusMainContainer();this.#st=null},0)}this.#V.delete(t.id);this.unselect(t);if(!t.annotationElementId||!this.#Y.has(t.annotationElementId)){this.#$?.remove(t.id)}}addDeletedAnnotationElement(t){this.#Y.add(t.annotationElementId);this.addChangedExistingAnnotation(t);t.deleted=true}isDeletedAnnotationElement(t){return this.#Y.has(t)}removeDeletedAnnotationElement(t){this.#Y.delete(t.annotationElementId);this.removeChangedExistingAnnotation(t);t.deleted=false}#$t(t){const e=this.#W.get(t.pageIndex);if(e){e.addOrRebuild(t)}else{this.addEditor(t);this.addToAnnotationStorage(t)}}setActiveEditor(t){if(this.#G===t){return}this.#G=t;if(t){this.#qt(t.propertiesToUpdate)}}get#Qt(){let t=null;for(t of this.#pt){}return t}updateUI(t){if(this.#Qt===t){this.#qt(t.propertiesToUpdate)}}toggleSelected(t){if(this.#pt.has(t)){this.#pt.delete(t);t.unselect();this.#Ht({hasSelectedEditor:this.hasSelection});return}this.#pt.add(t);t.select();this.#qt(t.propertiesToUpdate);this.#Ht({hasSelectedEditor:true})}setSelected(t){for(const e of this.#pt){if(e!==t){e.unselect()}}this.#pt.clear();this.#pt.add(t);t.select();this.#qt(t.propertiesToUpdate);this.#Ht({hasSelectedEditor:true})}isSelected(t){return this.#pt.has(t)}get firstSelectedEditor(){return this.#pt.values().next().value}unselect(t){t.unselect();this.#pt.delete(t);this.#Ht({hasSelectedEditor:this.hasSelection})}get hasSelection(){return this.#pt.size!==0}get isEnterHandled(){return this.#pt.size===1&&this.firstSelectedEditor.isEnterHandled}undo(){this.#q.undo();this.#Ht({hasSomethingToUndo:this.#q.hasSomethingToUndo(),hasSomethingToRedo:true,isEmpty:this.#Xt()})}redo(){this.#q.redo();this.#Ht({hasSomethingToUndo:true,hasSomethingToRedo:this.#q.hasSomethingToRedo(),isEmpty:this.#Xt()})}addCommands(t){this.#q.add(t);this.#Ht({hasSomethingToUndo:true,hasSomethingToRedo:false,isEmpty:this.#Xt()})}#Xt(){if(this.#V.size===0){return true}if(this.#V.size===1){for(const t of this.#V.values()){return t.isEmpty()}}return false}delete(){this.commitOrRemove();if(!this.hasSelection){return}const t=[...this.#pt];const e=()=>{for(const e of t){e.remove()}};const s=()=>{for(const e of t){this.#$t(e)}};this.addCommands({cmd:e,undo:s,mustExec:true})}commitOrRemove(){this.#G?.commitOrRemove()}hasSomethingToControl(){return this.#G||this.hasSelection}#Kt(t){for(const t of this.#pt){t.unselect()}this.#pt.clear();for(const e of t){if(e.isEmpty()){continue}this.#pt.add(e);e.select()}this.#Ht({hasSelectedEditor:this.hasSelection})}selectAll(){for(const t of this.#pt){t.commit()}this.#Kt(this.#V.values())}unselectAll(){if(this.#G){this.#G.commitOrRemove();if(this.#ut!==AnnotationEditorType.NONE){return}}if(!this.hasSelection){return}for(const t of this.#pt){t.unselect()}this.#pt.clear();this.#Ht({hasSelectedEditor:false})}translateSelectedEditors(t,e,s=false){if(!s){this.commitOrRemove()}if(!this.hasSelection){return}this.#Mt[0]+=t;this.#Mt[1]+=e;const[i,n]=this.#Mt;const a=[...this.#pt];const r=1e3;if(this.#kt){clearTimeout(this.#kt)}this.#kt=setTimeout(()=>{this.#kt=null;this.#Mt[0]=this.#Mt[1]=0;this.addCommands({cmd:()=>{for(const t of a){if(this.#V.has(t.id)){t.translateInPage(i,n)}}},undo:()=>{for(const t of a){if(this.#V.has(t.id)){t.translateInPage(-i,-n)}}},mustExec:false})},r);for(const s of a){s.translateInPage(t,e)}}setUpDragSession(){if(!this.hasSelection){return}this.disableUserSelect(true);this.#J=new Map;for(const t of this.#pt){this.#J.set(t,{savedX:t.x,savedY:t.y,savedPageIndex:t.pageIndex,newX:0,newY:0,newPageIndex:-1})}}endDragSession(){if(!this.#J){return false}this.disableUserSelect(false);const t=this.#J;this.#J=null;let e=false;for(const[{x:s,y:i,pageIndex:n},a]of t){a.newX=s;a.newY=i;a.newPageIndex=n;e||=s!==a.savedX||i!==a.savedY||n!==a.savedPageIndex}if(!e){return false}const s=(t,e,s,i)=>{if(this.#V.has(t.id)){const n=this.#W.get(i);if(n){t._setParentAndPosition(n,e,s)}else{t.pageIndex=i;t.x=e;t.y=s}}};this.addCommands({cmd:()=>{for(const[e,{newX:i,newY:n,newPageIndex:a}]of t){s(e,i,n,a)}},undo:()=>{for(const[e,{savedX:i,savedY:n,savedPageIndex:a}]of t){s(e,i,n,a)}},mustExec:true});return true}dragSelectedEditors(t,e){if(!this.#J){return}for(const s of this.#J.keys()){s.drag(t,e)}}rebuild(t){if(t.parent===null){const e=this.getLayer(t.pageIndex);if(e){e.changeParent(t);e.addOrRebuild(t)}else{this.addEditor(t);this.addToAnnotationStorage(t);t.rebuild()}}else{t.parent.addOrRebuild(t)}}get isEditorHandlingKeyboard(){return this.getActive()?.shouldGetKeyboardEvents()||this.#pt.size===1&&this.firstSelectedEditor.shouldGetKeyboardEvents()}isActive(t){return this.#G===t}getActive(){return this.#G}getMode(){return this.#ut}get imageManager(){return shadow(this,"imageManager",new ImageManager)}getSelectionBoxes(t){if(!t){return null}const e=document.getSelection();for(let s=0,i=e.rangeCount;s<i;s++){if(!t.contains(e.getRangeAt(s).commonAncestorContainer)){return null}}const{x:s,y:i,width:n,height:a}=t.getBoundingClientRect();let r;switch(t.getAttribute("data-main-rotation")){case"90":r=(t,e,r,o)=>({x:(e-i)/a,y:1-(t+r-s)/n,width:o/a,height:r/n});break;case"180":r=(t,e,r,o)=>({x:1-(t+r-s)/n,y:1-(e+o-i)/a,width:r/n,height:o/a});break;case"270":r=(t,e,r,o)=>({x:1-(e+o-i)/a,y:(t-s)/n,width:o/a,height:r/n});break;default:r=(t,e,r,o)=>({x:(t-s)/n,y:(e-i)/a,width:r/n,height:o/a});break}const o=[];for(let t=0,s=e.rangeCount;t<s;t++){const s=e.getRangeAt(t);if(s.collapsed){continue}for(const{x:t,y:e,width:i,height:n}of s.getClientRects()){if(i===0||n===0){continue}o.push(r(t,e,i,n))}}return o.length===0?null:o}addChangedExistingAnnotation({annotationElementId:t,id:e}){(this.#K||=new Map).set(t,e)}removeChangedExistingAnnotation({annotationElementId:t}){this.#K?.delete(t)}renderAnnotationElement(t){const e=this.#K?.get(t.data.id);if(!e){return}const s=this.#$.getRawValue(e);if(!s){return}if(this.#ut===AnnotationEditorType.NONE&&!s.hasBeenModified){return}s.renderAnnotationElement(t)}}class AltText{#Zt="";#te=false;#ee=null;#se=null;#ie=null;#ne=false;#E=null;static _l10nPromise=null;constructor(t){this.#E=t}static initialize(t){AltText._l10nPromise||=t}async render(){const t=this.#ee=document.createElement("button");t.className="altText";const e=await AltText._l10nPromise.get("pdfjs-editor-alt-text-button-label");t.textContent=e;t.setAttribute("aria-label",e);t.tabIndex="0";const s=this.#E._uiManager._signal;t.addEventListener("contextmenu",noContextMenu,{signal:s});t.addEventListener("pointerdown",t=>t.stopPropagation(),{signal:s});const i=t=>{t.preventDefault();this.#E._uiManager.editAltText(this.#E)};t.addEventListener("click",i,{capture:true,signal:s});t.addEventListener("keydown",e=>{if(e.target===t&&e.key==="Enter"){this.#ne=true;i(e)}},{signal:s});await this.#ae();return t}finish(){if(!this.#ee){return}this.#ee.focus({focusVisible:this.#ne});this.#ne=false}isEmpty(){return!this.#Zt&&!this.#te}get data(){return{altText:this.#Zt,decorative:this.#te}}set data({altText:t,decorative:e}){if(this.#Zt===t&&this.#te===e){return}this.#Zt=t;this.#te=e;this.#ae()}toggle(t=false){if(!this.#ee){return}if(!t&&this.#ie){clearTimeout(this.#ie);this.#ie=null}this.#ee.disabled=!t}destroy(){this.#ee?.remove();this.#ee=null;this.#se=null}async#ae(){const t=this.#ee;if(!t){return}if(!this.#Zt&&!this.#te){t.classList.remove("done");this.#se?.remove();return}t.classList.add("done");AltText._l10nPromise.get("pdfjs-editor-alt-text-edit-button-label").then(e=>{t.setAttribute("aria-label",e)});let e=this.#se;if(!e){this.#se=e=document.createElement("span");e.className="tooltip";e.setAttribute("role","tooltip");const s=e.id=`alt-text-tooltip-${this.#E.id}`;t.setAttribute("aria-describedby",s);const i=100;const n=this.#E._uiManager._signal;n.addEventListener("abort",()=>{clearTimeout(this.#ie);this.#ie=null},{once:true});t.addEventListener("mouseenter",()=>{this.#ie=setTimeout(()=>{this.#ie=null;this.#se.classList.add("show");this.#E._reportTelemetry({action:"alt_text_tooltip"})},i)},{signal:n});t.addEventListener("mouseleave",()=>{if(this.#ie){clearTimeout(this.#ie);this.#ie=null}this.#se?.classList.remove("show")},{signal:n})}e.innerText=this.#te?await AltText._l10nPromise.get("pdfjs-editor-alt-text-decorative-tooltip"):this.#Zt;if(!e.parentNode){t.append(e)}const s=this.#E.getImageForAltText();s?.setAttribute("aria-describedby",e.id)}}class AnnotationEditor{#re=null;#oe=null;#Zt=null;#le=false;#he=false;#ce=null;#de=null;#ue=this.focusin.bind(this);#pe=this.focusout.bind(this);#ge=null;#fe="";#me=false;#be=null;#_e=false;#Ae=false;#ve=false;#ye=null;#Ee=0;#we=0;#xe=null;_initialOptions=Object.create(null);_isVisible=true;_uiManager=null;_focusEventsAllowed=true;_l10nPromise=null;#Te=false;#Se=AnnotationEditor._zIndex++;static _borderLineWidth=-1;static _colorManager=new ColorManager;static _zIndex=1;static _telemetryTimeout=1e3;static get _resizerKeyboardManager(){const t=AnnotationEditor.prototype._resizeWithKeyboard;const e=AnnotationEditorUIManager.TRANSLATE_SMALL;const s=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_resizerKeyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],t,{args:[-e,0]}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t,{args:[-s,0]}],[["ArrowRight","mac+ArrowRight"],t,{args:[e,0]}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t,{args:[s,0]}],[["ArrowUp","mac+ArrowUp"],t,{args:[0,-e]}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t,{args:[0,-s]}],[["ArrowDown","mac+ArrowDown"],t,{args:[0,e]}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t,{args:[0,s]}],[["Escape","mac+Escape"],AnnotationEditor.prototype._stopResizingWithKeyboard]]))}constructor(t){if(this.constructor===AnnotationEditor){unreachable("Cannot initialize AnnotationEditor.")}this.parent=t.parent;this.id=t.id;this.width=this.height=null;this.pageIndex=t.parent.pageIndex;this.name=t.name;this.div=null;this._uiManager=t.uiManager;this.annotationElementId=null;this._willKeepAspectRatio=false;this._initialOptions.isCentered=t.isCentered;this._structTreeParentId=null;const{rotation:e,rawDims:{pageWidth:s,pageHeight:i,pageX:n,pageY:a}}=this.parent.viewport;this.rotation=e;this.pageRotation=(360+e-this._uiManager.viewParameters.rotation)%360;this.pageDimensions=[s,i];this.pageTranslation=[n,a];const[r,o]=this.parentDimensions;this.x=t.x/r;this.y=t.y/o;this.isAttachedToDOM=false;this.deleted=false}get editorType(){return Object.getPrototypeOf(this).constructor._type}static get _defaultLineColor(){return shadow(this,"_defaultLineColor",this._colorManager.getHexCode("CanvasText"))}static deleteAnnotationElement(t){const e=new FakeEditor({id:t.parent.getNextId(),parent:t.parent,uiManager:t._uiManager});e.annotationElementId=t.annotationElementId;e.deleted=true;e._uiManager.addToAnnotationStorage(e)}static initialize(t,e,s){AnnotationEditor._l10nPromise||=new Map(["pdfjs-editor-alt-text-button-label","pdfjs-editor-alt-text-edit-button-label","pdfjs-editor-alt-text-decorative-tooltip","pdfjs-editor-resizer-label-topLeft","pdfjs-editor-resizer-label-topMiddle","pdfjs-editor-resizer-label-topRight","pdfjs-editor-resizer-label-middleRight","pdfjs-editor-resizer-label-bottomRight","pdfjs-editor-resizer-label-bottomMiddle","pdfjs-editor-resizer-label-bottomLeft","pdfjs-editor-resizer-label-middleLeft"].map(e=>[e,t.get(e.replaceAll(/([A-Z])/g,t=>`-${t.toLowerCase()}`))]));if(s?.strings){for(const e of s.strings){AnnotationEditor._l10nPromise.set(e,t.get(e))}}if(AnnotationEditor._borderLineWidth!==-1){return}const i=getComputedStyle(document.documentElement);AnnotationEditor._borderLineWidth=parseFloat(i.getPropertyValue("--outline-width"))||0}static updateDefaultParams(t,e){}static get defaultPropertiesToUpdate(){return[]}static isHandlingMimeForPasting(t){return false}static paste(t,e){unreachable("Not implemented")}get propertiesToUpdate(){return[]}get _isDraggable(){return this.#Te}set _isDraggable(t){this.#Te=t;this.div?.classList.toggle("draggable",t)}get isEnterHandled(){return true}center(){const[t,e]=this.pageDimensions;switch(this.parentRotation){case 90:this.x-=this.height*e/(t*2);this.y+=this.width*t/(e*2);break;case 180:this.x+=this.width/2;this.y+=this.height/2;break;case 270:this.x+=this.height*e/(t*2);this.y-=this.width*t/(e*2);break;default:this.x-=this.width/2;this.y-=this.height/2;break}this.fixAndSetPosition()}addCommands(t){this._uiManager.addCommands(t)}get currentLayer(){return this._uiManager.currentLayer}setInBackground(){this.div.style.zIndex=0}setInForeground(){this.div.style.zIndex=this.#Se}setParent(t){if(t!==null){this.pageIndex=t.pageIndex;this.pageDimensions=t.pageDimensions}else{this.#Ce()}this.parent=t}focusin(t){if(!this._focusEventsAllowed){return}if(!this.#me){this.parent.setSelected(this)}else{this.#me=false}}focusout(t){if(!this._focusEventsAllowed){return}if(!this.isAttachedToDOM){return}const e=t.relatedTarget;if(e?.closest(`#${this.id}`)){return}t.preventDefault();if(!this.parent?.isMultipleSelection){this.commitOrRemove()}}commitOrRemove(){if(this.isEmpty()){this.remove()}else{this.commit()}}commit(){this.addToAnnotationStorage()}addToAnnotationStorage(){this._uiManager.addToAnnotationStorage(this)}setAt(t,e,s,i){const[n,a]=this.parentDimensions;[s,i]=this.screenToPageTranslation(s,i);this.x=(t+s)/n;this.y=(e+i)/a;this.fixAndSetPosition()}#Pe([t,e],s,i){[s,i]=this.screenToPageTranslation(s,i);this.x+=s/t;this.y+=i/e;this.fixAndSetPosition()}translate(t,e){this.#Pe(this.parentDimensions,t,e)}translateInPage(t,e){this.#be||=[this.x,this.y];this.#Pe(this.pageDimensions,t,e);this.div.scrollIntoView({block:"nearest"})}drag(t,e){this.#be||=[this.x,this.y];const[s,i]=this.parentDimensions;this.x+=t/s;this.y+=e/i;if(this.parent&&(this.x<0||this.x>1||this.y<0||this.y>1)){const{x:t,y:e}=this.div.getBoundingClientRect();if(this.parent.findNewParent(this,t,e)){this.x-=Math.floor(this.x);this.y-=Math.floor(this.y)}}let{x:n,y:a}=this;const[r,o]=this.getBaseTranslation();n+=r;a+=o;this.div.style.left=`${(100*n).toFixed(2)}%`;this.div.style.top=`${(100*a).toFixed(2)}%`;this.div.scrollIntoView({block:"nearest"})}get _hasBeenMoved(){return!!this.#be&&(this.#be[0]!==this.x||this.#be[1]!==this.y)}getBaseTranslation(){const[t,e]=this.parentDimensions;const{_borderLineWidth:s}=AnnotationEditor;const i=s/t;const n=s/e;switch(this.rotation){case 90:return[-i,n];case 180:return[i,n];case 270:return[i,-n];default:return[-i,-n]}}get _mustFixPosition(){return true}fixAndSetPosition(t=this.rotation){const[e,s]=this.pageDimensions;let{x:i,y:n,width:a,height:r}=this;a*=e;r*=s;i*=e;n*=s;if(this._mustFixPosition){switch(t){case 0:i=Math.max(0,Math.min(e-a,i));n=Math.max(0,Math.min(s-r,n));break;case 90:i=Math.max(0,Math.min(e-r,i));n=Math.min(s,Math.max(a,n));break;case 180:i=Math.min(e,Math.max(a,i));n=Math.min(s,Math.max(r,n));break;case 270:i=Math.min(e,Math.max(r,i));n=Math.max(0,Math.min(s-a,n));break}}this.x=i/=e;this.y=n/=s;const[o,l]=this.getBaseTranslation();i+=o;n+=l;const{style:h}=this.div;h.left=`${(100*i).toFixed(2)}%`;h.top=`${(100*n).toFixed(2)}%`;this.moveInDOM()}static#Me(t,e,s){switch(s){case 90:return[e,-t];case 180:return[-t,-e];case 270:return[-e,t];default:return[t,e]}}screenToPageTranslation(t,e){return AnnotationEditor.#Me(t,e,this.parentRotation)}pageTranslationToScreen(t,e){return AnnotationEditor.#Me(t,e,360-this.parentRotation)}#ke(t){switch(t){case 90:{const[t,e]=this.pageDimensions;return[0,-t/e,e/t,0]}case 180:return[-1,0,0,-1];case 270:{const[t,e]=this.pageDimensions;return[0,t/e,-e/t,0]}default:return[1,0,0,1]}}get parentScale(){return this._uiManager.viewParameters.realScale}get parentRotation(){return(this._uiManager.viewParameters.rotation+this.pageRotation)%360}get parentDimensions(){const{parentScale:t,pageDimensions:[e,s]}=this;const i=e*t;const n=s*t;return util_FeatureTest.isCSSRoundSupported?[Math.round(i),Math.round(n)]:[i,n]}setDims(t,e){const[s,i]=this.parentDimensions;this.div.style.width=`${(100*t/s).toFixed(2)}%`;if(!this.#he){this.div.style.height=`${(100*e/i).toFixed(2)}%`}}fixDims(){const{style:t}=this.div;const{height:e,width:s}=t;const i=s.endsWith("%");const n=!this.#he&&e.endsWith("%");if(i&&n){return}const[a,r]=this.parentDimensions;if(!i){t.width=`${(100*parseFloat(s)/a).toFixed(2)}%`}if(!this.#he&&!n){t.height=`${(100*parseFloat(e)/r).toFixed(2)}%`}}getInitialTranslation(){return[0,0]}#Ie(){if(this.#ce){return}this.#ce=document.createElement("div");this.#ce.classList.add("resizers");const t=this._willKeepAspectRatio?["topLeft","topRight","bottomRight","bottomLeft"]:["topLeft","topMiddle","topRight","middleRight","bottomRight","bottomMiddle","bottomLeft","middleLeft"];const e=this._uiManager._signal;for(const s of t){const t=document.createElement("div");this.#ce.append(t);t.classList.add("resizer",s);t.setAttribute("data-resizer-name",s);t.addEventListener("pointerdown",this.#Re.bind(this,s),{signal:e});t.addEventListener("contextmenu",noContextMenu,{signal:e});t.tabIndex=-1}this.div.prepend(this.#ce)}#Re(t,e){e.preventDefault();const{isMac:s}=util_FeatureTest.platform;if(e.button!==0||e.ctrlKey&&s){return}this.#Zt?.toggle(false);const i=this.#Fe.bind(this,t);const n=this._isDraggable;this._isDraggable=false;const a=this._uiManager._signal;const r={passive:true,capture:true,signal:a};this.parent.togglePointerEvents(false);window.addEventListener("pointermove",i,r);window.addEventListener("contextmenu",noContextMenu,{signal:a});const o=this.x;const l=this.y;const h=this.width;const c=this.height;const d=this.parent.div.style.cursor;const u=this.div.style.cursor;this.div.style.cursor=this.parent.div.style.cursor=window.getComputedStyle(e.target).cursor;const p=()=>{this.parent.togglePointerEvents(true);this.#Zt?.toggle(true);this._isDraggable=n;window.removeEventListener("pointerup",p);window.removeEventListener("blur",p);window.removeEventListener("pointermove",i,r);window.removeEventListener("contextmenu",noContextMenu);this.parent.div.style.cursor=d;this.div.style.cursor=u;this.#Le(o,l,h,c)};window.addEventListener("pointerup",p,{signal:a});window.addEventListener("blur",p,{signal:a})}#Le(t,e,s,i){const n=this.x;const a=this.y;const r=this.width;const o=this.height;if(n===t&&a===e&&r===s&&o===i){return}this.addCommands({cmd:()=>{this.width=r;this.height=o;this.x=n;this.y=a;const[t,e]=this.parentDimensions;this.setDims(t*r,e*o);this.fixAndSetPosition()},undo:()=>{this.width=s;this.height=i;this.x=t;this.y=e;const[n,a]=this.parentDimensions;this.setDims(n*s,a*i);this.fixAndSetPosition()},mustExec:true})}#Fe(t,e){const[s,i]=this.parentDimensions;const n=this.x;const a=this.y;const r=this.width;const o=this.height;const l=AnnotationEditor.MIN_SIZE/s;const h=AnnotationEditor.MIN_SIZE/i;const c=t=>Math.round(t*1e4)/1e4;const d=this.#ke(this.rotation);const u=(t,e)=>[d[0]*t+d[2]*e,d[1]*t+d[3]*e];const p=this.#ke(360-this.rotation);const g=(t,e)=>[p[0]*t+p[2]*e,p[1]*t+p[3]*e];let f;let m;let b=false;let _=false;switch(t){case"topLeft":b=true;f=(t,e)=>[0,0];m=(t,e)=>[t,e];break;case"topMiddle":f=(t,e)=>[t/2,0];m=(t,e)=>[t/2,e];break;case"topRight":b=true;f=(t,e)=>[t,0];m=(t,e)=>[0,e];break;case"middleRight":_=true;f=(t,e)=>[t,e/2];m=(t,e)=>[0,e/2];break;case"bottomRight":b=true;f=(t,e)=>[t,e];m=(t,e)=>[0,0];break;case"bottomMiddle":f=(t,e)=>[t/2,e];m=(t,e)=>[t/2,0];break;case"bottomLeft":b=true;f=(t,e)=>[0,e];m=(t,e)=>[t,0];break;case"middleLeft":_=true;f=(t,e)=>[0,e/2];m=(t,e)=>[t,e/2];break}const A=f(r,o);const v=m(r,o);let y=u(...v);const E=c(n+y[0]);const w=c(a+y[1]);let x=1;let T=1;let[S,C]=this.screenToPageTranslation(e.movementX,e.movementY);[S,C]=g(S/s,C/i);if(b){const t=Math.hypot(r,o);x=T=Math.max(Math.min(Math.hypot(v[0]-A[0]-S,v[1]-A[1]-C)/t,1/r,1/o),l/r,h/o)}else if(_){x=Math.max(l,Math.min(1,Math.abs(v[0]-A[0]-S)))/r}else{T=Math.max(h,Math.min(1,Math.abs(v[1]-A[1]-C)))/o}const P=c(r*x);const M=c(o*T);y=u(...m(P,M));const k=E-y[0];const I=w-y[1];this.width=P;this.height=M;this.x=k;this.y=I;this.setDims(s*P,i*M);this.fixAndSetPosition()}altTextFinish(){this.#Zt?.finish()}async addEditToolbar(){if(this.#ge||this.#Ae){return this.#ge}this.#ge=new EditorToolbar(this);this.div.append(this.#ge.render());if(this.#Zt){this.#ge.addAltTextButton(await this.#Zt.render())}return this.#ge}removeEditToolbar(){if(!this.#ge){return}this.#ge.remove();this.#ge=null;this.#Zt?.destroy()}getClientDimensions(){return this.div.getBoundingClientRect()}async addAltTextButton(){if(this.#Zt){return}AltText.initialize(AnnotationEditor._l10nPromise);this.#Zt=new AltText(this);if(this.#re){this.#Zt.data=this.#re;this.#re=null}await this.addEditToolbar()}get altTextData(){return this.#Zt?.data}set altTextData(t){if(!this.#Zt){return}this.#Zt.data=t}hasAltText(){return!this.#Zt?.isEmpty()}render(){this.div=document.createElement("div");this.div.setAttribute("data-editor-rotation",(360-this.rotation)%360);this.div.className=this.name;this.div.setAttribute("id",this.id);this.div.tabIndex=this.#le?-1:0;if(!this._isVisible){this.div.classList.add("hidden")}this.setInForeground();const t=this._uiManager._signal;this.div.addEventListener("focusin",this.#ue,{signal:t});this.div.addEventListener("focusout",this.#pe,{signal:t});const[e,s]=this.parentDimensions;if(this.parentRotation%180!==0){this.div.style.maxWidth=`${(100*s/e).toFixed(2)}%`;this.div.style.maxHeight=`${(100*e/s).toFixed(2)}%`}const[i,n]=this.getInitialTranslation();this.translate(i,n);bindEvents(this,this.div,["pointerdown"]);return this.div}pointerdown(t){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){t.preventDefault();return}this.#me=true;if(this._isDraggable){this.#De(t);return}this.#Oe(t)}#Oe(t){const{isMac:e}=util_FeatureTest.platform;if(t.ctrlKey&&!e||t.shiftKey||t.metaKey&&e){this.parent.toggleSelected(this)}else{this.parent.setSelected(this)}}#De(t){const e=this._uiManager.isSelected(this);this._uiManager.setUpDragSession();let s,i;const n=this._uiManager._signal;if(e){this.div.classList.add("moving");s={passive:true,capture:true,signal:n};this.#Ee=t.clientX;this.#we=t.clientY;i=t=>{const{clientX:e,clientY:s}=t;const[i,n]=this.screenToPageTranslation(e-this.#Ee,s-this.#we);this.#Ee=e;this.#we=s;this._uiManager.dragSelectedEditors(i,n)};window.addEventListener("pointermove",i,s)}const a=()=>{window.removeEventListener("pointerup",a);window.removeEventListener("blur",a);if(e){this.div.classList.remove("moving");window.removeEventListener("pointermove",i,s)}this.#me=false;if(!this._uiManager.endDragSession()){this.#Oe(t)}};window.addEventListener("pointerup",a,{signal:n});window.addEventListener("blur",a,{signal:n})}moveInDOM(){if(this.#ye){clearTimeout(this.#ye)}this.#ye=setTimeout(()=>{this.#ye=null;this.parent?.moveEditorInDOM(this)},0)}_setParentAndPosition(t,e,s){t.changeParent(this);this.x=e;this.y=s;this.fixAndSetPosition()}getRect(t,e,s=this.rotation){const i=this.parentScale;const[n,a]=this.pageDimensions;const[r,o]=this.pageTranslation;const l=t/i;const h=e/i;const c=this.x*n;const d=this.y*a;const u=this.width*n;const p=this.height*a;switch(s){case 0:return[c+l+r,a-d-h-p+o,c+l+u+r,a-d-h+o];case 90:return[c+h+r,a-d+l+o,c+h+p+r,a-d+l+u+o];case 180:return[c-l-u+r,a-d+h+o,c-l+r,a-d+h+p+o];case 270:return[c-h-p+r,a-d-l-u+o,c-h+r,a-d-l+o];default:throw new Error("Invalid rotation")}}getRectInCurrentCoords(t,e){const[s,i,n,a]=t;const r=n-s;const o=a-i;switch(this.rotation){case 0:return[s,e-a,r,o];case 90:return[s,e-i,o,r];case 180:return[n,e-i,r,o];case 270:return[n,e-a,o,r];default:throw new Error("Invalid rotation")}}onceAdded(){}isEmpty(){return false}enableEditMode(){this.#Ae=true}disableEditMode(){this.#Ae=false}isInEditMode(){return this.#Ae}shouldGetKeyboardEvents(){return this.#ve}needsToBeRebuilt(){return this.div&&!this.isAttachedToDOM}rebuild(){const t=this._uiManager._signal;this.div?.addEventListener("focusin",this.#ue,{signal:t});this.div?.addEventListener("focusout",this.#pe,{signal:t})}rotate(t){}serialize(t=false,e=null){unreachable("An editor must be serializable")}static deserialize(t,e,s){const i=new this.prototype.constructor({parent:e,id:e.getNextId(),uiManager:s});i.rotation=t.rotation;i.#re=t.accessibilityData;const[n,a]=i.pageDimensions;const[r,o,l,h]=i.getRectInCurrentCoords(t.rect,a);i.x=r/n;i.y=o/a;i.width=l/n;i.height=h/a;return i}get hasBeenModified(){return!!this.annotationElementId&&(this.deleted||this.serialize()!==null)}remove(){this.div.removeEventListener("focusin",this.#ue);this.div.removeEventListener("focusout",this.#pe);if(!this.isEmpty()){this.commit()}if(this.parent){this.parent.remove(this)}else{this._uiManager.removeEditor(this)}if(this.#ye){clearTimeout(this.#ye);this.#ye=null}this.#Ce();this.removeEditToolbar();if(this.#xe){for(const t of this.#xe.values()){clearTimeout(t)}this.#xe=null}this.parent=null}get isResizable(){return false}makeResizable(){if(this.isResizable){this.#Ie();this.#ce.classList.remove("hidden");bindEvents(this,this.div,["keydown"])}}get toolbarPosition(){return null}keydown(t){if(!this.isResizable||t.target!==this.div||t.key!=="Enter"){return}this._uiManager.setSelected(this);this.#de={savedX:this.x,savedY:this.y,savedWidth:this.width,savedHeight:this.height};const e=this.#ce.children;if(!this.#oe){this.#oe=Array.from(e);const t=this.#Ne.bind(this);const s=this.#Be.bind(this);const i=this._uiManager._signal;for(const e of this.#oe){const n=e.getAttribute("data-resizer-name");e.setAttribute("role","spinbutton");e.addEventListener("keydown",t,{signal:i});e.addEventListener("blur",s,{signal:i});e.addEventListener("focus",this.#He.bind(this,n),{signal:i});AnnotationEditor._l10nPromise.get(`pdfjs-editor-resizer-label-${n}`).then(t=>e.setAttribute("aria-label",t))}}const s=this.#oe[0];let i=0;for(const t of e){if(t===s){break}i++}const n=(360-this.rotation+this.parentRotation)%360/90*(this.#oe.length/4);if(n!==i){if(n<i){for(let t=0;t<i-n;t++){this.#ce.append(this.#ce.firstChild)}}else if(n>i){for(let t=0;t<n-i;t++){this.#ce.firstChild.before(this.#ce.lastChild)}}let t=0;for(const s of e){const e=this.#oe[t++];const i=e.getAttribute("data-resizer-name");AnnotationEditor._l10nPromise.get(`pdfjs-editor-resizer-label-${i}`).then(t=>s.setAttribute("aria-label",t))}}this.#Ue(0);this.#ve=true;this.#ce.firstChild.focus({focusVisible:true});t.preventDefault();t.stopImmediatePropagation()}#Ne(t){AnnotationEditor._resizerKeyboardManager.exec(this,t)}#Be(t){if(this.#ve&&t.relatedTarget?.parentNode!==this.#ce){this.#Ce()}}#He(t){this.#fe=this.#ve?t:""}#Ue(t){if(!this.#oe){return}for(const e of this.#oe){e.tabIndex=t}}_resizeWithKeyboard(t,e){if(!this.#ve){return}this.#Fe(this.#fe,{movementX:t,movementY:e})}#Ce(){this.#ve=false;this.#Ue(-1);if(this.#de){const{savedX:t,savedY:e,savedWidth:s,savedHeight:i}=this.#de;this.#Le(t,e,s,i);this.#de=null}}_stopResizingWithKeyboard(){this.#Ce();this.div.focus()}select(){this.makeResizable();this.div?.classList.add("selectedEditor");if(!this.#ge){this.addEditToolbar().then(()=>{if(this.div?.classList.contains("selectedEditor")){this.#ge?.show()}});return}this.#ge?.show()}unselect(){this.#ce?.classList.add("hidden");this.div?.classList.remove("selectedEditor");if(this.div?.contains(document.activeElement)){this._uiManager.currentLayer.div.focus({preventScroll:true})}this.#ge?.hide()}updateParams(t,e){}disableEditing(){}enableEditing(){}enterInEditMode(){}getImageForAltText(){return null}get contentDiv(){return this.div}get isEditing(){return this.#_e}set isEditing(t){this.#_e=t;if(!this.parent){return}if(t){this.parent.setSelected(this);this.parent.setActiveEditor(this)}else{this.parent.setActiveEditor(null)}}setAspectRatio(t,e){this.#he=true;const s=t/e;const{style:i}=this.div;i.aspectRatio=s;i.height="auto"}static get MIN_SIZE(){return 16}static canCreateNewEmptyEditor(){return true}get telemetryInitialData(){return{action:"added"}}get telemetryFinalData(){return null}_reportTelemetry(t,e=false){if(e){this.#xe||=new Map;const{action:e}=t;let s=this.#xe.get(e);if(s){clearTimeout(s)}s=setTimeout(()=>{this._reportTelemetry(t);this.#xe.delete(e);if(this.#xe.size===0){this.#xe=null}},AnnotationEditor._telemetryTimeout);this.#xe.set(e,s);return}t.type||=this.editorType;this._uiManager._eventBus.dispatch("reporttelemetry",{source:this,details:{type:"editing",data:t}})}show(t=this._isVisible){this.div.classList.toggle("hidden",!t);this._isVisible=t}enable(){if(this.div){this.div.tabIndex=0}this.#le=false}disable(){if(this.div){this.div.tabIndex=-1}this.#le=true}renderAnnotationElement(t){let e=t.container.querySelector(".annotationContent");if(!e){e=document.createElement("div");e.classList.add("annotationContent",this.editorType);t.container.prepend(e)}else if(e.nodeName==="CANVAS"){const t=e;e=document.createElement("div");e.classList.add("annotationContent",this.editorType);t.before(e)}return e}resetAnnotationElement(t){const{firstChild:e}=t.container;if(e.nodeName==="DIV"&&e.classList.contains("annotationContent")){e.remove()}}}class FakeEditor extends AnnotationEditor{constructor(t){super(t);this.annotationElementId=t.annotationElementId;this.deleted=true}serialize(){return{id:this.annotationElementId,deleted:true,pageIndex:this.pageIndex}}}const SEED=3285377520;const MASK_HIGH=4294901760;const MASK_LOW=65535;class MurmurHash3_64{constructor(t){this.h1=t?t&4294967295:SEED;this.h2=t?t&4294967295:SEED}update(t){let e,s;if(typeof t==="string"){e=new Uint8Array(t.length*2);s=0;for(let i=0,n=t.length;i<n;i++){const n=t.charCodeAt(i);if(n<=255){e[s++]=n}else{e[s++]=n>>>8;e[s++]=n&255}}}else if(ArrayBuffer.isView(t)){e=t.slice();s=e.byteLength}else{throw new Error("Invalid data format, must be a string or TypedArray.")}const i=s>>2;const n=s-i*4;const a=new Uint32Array(e.buffer,0,i);let r=0,o=0;let l=this.h1,h=this.h2;const c=3432918353,d=461845907;const u=c&MASK_LOW,p=d&MASK_LOW;for(let t=0;t<i;t++){if(t&1){r=a[t];r=r*c&MASK_HIGH|r*u&MASK_LOW;r=r<<15|r>>>17;r=r*d&MASK_HIGH|r*p&MASK_LOW;l^=r;l=l<<13|l>>>19;l=l*5+3864292196}else{o=a[t];o=o*c&MASK_HIGH|o*u&MASK_LOW;o=o<<15|o>>>17;o=o*d&MASK_HIGH|o*p&MASK_LOW;h^=o;h=h<<13|h>>>19;h=h*5+3864292196}}r=0;switch(n){case 3:r^=e[i*4+2]<<16;case 2:r^=e[i*4+1]<<8;case 1:r^=e[i*4];r=r*c&MASK_HIGH|r*u&MASK_LOW;r=r<<15|r>>>17;r=r*d&MASK_HIGH|r*p&MASK_LOW;if(i&1){l^=r}else{h^=r}}this.h1=l;this.h2=h}hexdigest(){let t=this.h1,e=this.h2;t^=e>>>1;t=t*3981806797&MASK_HIGH|t*36045&MASK_LOW;e=e*4283543511&MASK_HIGH|((e<<16|t>>>16)*2950163797&MASK_HIGH)>>>16;t^=e>>>1;t=t*444984403&MASK_HIGH|t*60499&MASK_LOW;e=e*3301882366&MASK_HIGH|((e<<16|t>>>16)*3120437893&MASK_HIGH)>>>16;t^=e>>>1;return(t>>>0).toString(16).padStart(8,"0")+(e>>>0).toString(16).padStart(8,"0")}}const SerializableEmpty=Object.freeze({map:null,hash:"",transfer:undefined});class AnnotationStorage{#ze=false;#Ge=new Map;constructor(){this.onSetModified=null;this.onResetModified=null;this.onAnnotationEditor=null}getValue(t,e){const s=this.#Ge.get(t);if(s===undefined){return e}return Object.assign(e,s)}getRawValue(t){return this.#Ge.get(t)}remove(t){this.#Ge.delete(t);if(this.#Ge.size===0){this.resetModified()}if(typeof this.onAnnotationEditor==="function"){for(const t of this.#Ge.values()){if(t instanceof AnnotationEditor){return}}this.onAnnotationEditor(null)}}setValue(t,e){const s=this.#Ge.get(t);let i=false;if(s!==undefined){for(const[t,n]of Object.entries(e)){if(s[t]!==n){i=true;s[t]=n}}}else{i=true;this.#Ge.set(t,e)}if(i){this.#Ve()}if(e instanceof AnnotationEditor&&typeof this.onAnnotationEditor==="function"){this.onAnnotationEditor(e.constructor._type)}}has(t){return this.#Ge.has(t)}getAll(){return this.#Ge.size>0?objectFromMap(this.#Ge):null}setAll(t){for(const[e,s]of Object.entries(t)){this.setValue(e,s)}}get size(){return this.#Ge.size}#Ve(){if(!this.#ze){this.#ze=true;if(typeof this.onSetModified==="function"){this.onSetModified()}}}resetModified(){if(this.#ze){this.#ze=false;if(typeof this.onResetModified==="function"){this.onResetModified()}}}get print(){return new PrintAnnotationStorage(this)}get serializable(){if(this.#Ge.size===0){return SerializableEmpty}const t=new Map,e=new MurmurHash3_64,s=[];const i=Object.create(null);let n=false;for(const[s,a]of this.#Ge){const r=a instanceof AnnotationEditor?a.serialize(false,i):a;if(r){t.set(s,r);e.update(`${s}:${JSON.stringify(r)}`);n||=!!r.bitmap}}if(n){for(const e of t.values()){if(e.bitmap){s.push(e.bitmap)}}}return t.size>0?{map:t,hash:e.hexdigest(),transfer:s}:SerializableEmpty}get editorStats(){let t=null;const e=new Map;for(const s of this.#Ge.values()){if(!(s instanceof AnnotationEditor)){continue}const i=s.telemetryFinalData;if(!i){continue}const{type:n}=i;if(!e.has(n)){e.set(n,Object.getPrototypeOf(s).constructor)}t||=Object.create(null);const a=t[n]||=new Map;for(const[t,e]of Object.entries(i)){if(t==="type"){continue}let s=a.get(t);if(!s){s=new Map;a.set(t,s)}const i=s.get(e)??0;s.set(e,i+1)}}for(const[s,i]of e){t[s]=i.computeTelemetryFinalData(t[s])}return t}}class PrintAnnotationStorage extends AnnotationStorage{#We;constructor(t){super();const{map:e,hash:s,transfer:i}=t.serializable;const n=structuredClone(e,i?{transfer:i}:null);this.#We={map:n,hash:s,transfer:i}}get print(){unreachable("Should not call PrintAnnotationStorage.print")}get serializable(){return this.#We}}class FontLoader{#je=new Set;constructor({ownerDocument:t=globalThis.document,styleElement:e=null}){this._document=t;this.nativeFontFaces=new Set;this.styleElement=null;this.loadingRequests=[];this.loadTestFontId=0}addNativeFontFace(t){this.nativeFontFaces.add(t);this._document.fonts.add(t)}removeNativeFontFace(t){this.nativeFontFaces.delete(t);this._document.fonts.delete(t)}insertRule(t){if(!this.styleElement){this.styleElement=this._document.createElement("style");this._document.documentElement.getElementsByTagName("head")[0].append(this.styleElement)}const e=this.styleElement.sheet;e.insertRule(t,e.cssRules.length)}clear(){for(const t of this.nativeFontFaces){this._document.fonts.delete(t)}this.nativeFontFaces.clear();this.#je.clear();if(this.styleElement){this.styleElement.remove();this.styleElement=null}}async loadSystemFont({systemFontInfo:t,_inspectFont:e}){if(!t||this.#je.has(t.loadedName)){return}assert(!this.disableFontFace,"loadSystemFont shouldn't be called when `disableFontFace` is set.");if(this.isFontLoadingAPISupported){const{loadedName:s,src:i,style:n}=t;const a=new FontFace(s,i,n);this.addNativeFontFace(a);try{await a.load();this.#je.add(s);e?.(t)}catch{warn(`Cannot load system font: ${t.baseFontName}, installing it could help to improve PDF rendering.`);this.removeNativeFontFace(a)}return}unreachable("Not implemented: loadSystemFont without the Font Loading API.")}async bind(t){if(t.attached||t.missingFile&&!t.systemFontInfo){return}t.attached=true;if(t.systemFontInfo){await this.loadSystemFont(t);return}if(this.isFontLoadingAPISupported){const e=t.createNativeFontFace();if(e){this.addNativeFontFace(e);try{await e.loaded}catch(s){warn(`Failed to load font '${e.family}': '${s}'.`);t.disableFontFace=true;throw s}}return}const e=t.createFontFaceRule();if(e){this.insertRule(e);if(this.isSyncFontLoadingSupported){return}await new Promise(e=>{const s=this._queueLoadingCallback(e);this._prepareFontLoadEvent(t,s)})}}get isFontLoadingAPISupported(){const t=!!this._document?.fonts;return shadow(this,"isFontLoadingAPISupported",t)}get isSyncFontLoadingSupported(){let t=false;if(isNodeJS){t=true}else if(typeof navigator!=="undefined"&&typeof navigator?.userAgent==="string"&&/Mozilla\/5.0.*?rv:\d+.*? Gecko/.test(navigator.userAgent)){t=true}return shadow(this,"isSyncFontLoadingSupported",t)}_queueLoadingCallback(t){function e(){assert(!i.done,"completeRequest() cannot be called twice.");i.done=true;while(s.length>0&&s[0].done){const t=s.shift();setTimeout(t.callback,0)}}const{loadingRequests:s}=this;const i={done:false,complete:e,callback:t};s.push(i);return i}get _loadTestFont(){const t=atob("T1RUTwALAIAAAwAwQ0ZGIDHtZg4AAAOYAAAAgUZGVE1lkzZwAAAEHAAAABxHREVGABQA"+"FQAABDgAAAAeT1MvMlYNYwkAAAEgAAAAYGNtYXABDQLUAAACNAAAAUJoZWFk/xVFDQAA"+"ALwAAAA2aGhlYQdkA+oAAAD0AAAAJGhtdHgD6AAAAAAEWAAAAAZtYXhwAAJQAAAAARgA"+"AAAGbmFtZVjmdH4AAAGAAAAAsXBvc3T/hgAzAAADeAAAACAAAQAAAAEAALZRFsRfDzz1"+"AAsD6AAAAADOBOTLAAAAAM4KHDwAAAAAA+gDIQAAAAgAAgAAAAAAAAABAAADIQAAAFoD"+"6AAAAAAD6AABAAAAAAAAAAAAAAAAAAAAAQAAUAAAAgAAAAQD6AH0AAUAAAKKArwAAACM"+"AooCvAAAAeAAMQECAAACAAYJAAAAAAAAAAAAAQAAAAAAAAAAAAAAAFBmRWQAwAAuAC4D"+"IP84AFoDIQAAAAAAAQAAAAAAAAAAACAAIAABAAAADgCuAAEAAAAAAAAAAQAAAAEAAAAA"+"AAEAAQAAAAEAAAAAAAIAAQAAAAEAAAAAAAMAAQAAAAEAAAAAAAQAAQAAAAEAAAAAAAUA"+"AQAAAAEAAAAAAAYAAQAAAAMAAQQJAAAAAgABAAMAAQQJAAEAAgABAAMAAQQJAAIAAgAB"+"AAMAAQQJAAMAAgABAAMAAQQJAAQAAgABAAMAAQQJAAUAAgABAAMAAQQJAAYAAgABWABY"+"AAAAAAAAAwAAAAMAAAAcAAEAAAAAADwAAwABAAAAHAAEACAAAAAEAAQAAQAAAC7//wAA"+"AC7////TAAEAAAAAAAABBgAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"+"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMAAAAAAAD/gwAyAAAAAQAAAAAAAAAAAAAAAAAA"+"AAABAAQEAAEBAQJYAAEBASH4DwD4GwHEAvgcA/gXBIwMAYuL+nz5tQXkD5j3CBLnEQAC"+"AQEBIVhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYWFhYAAABAQAADwACAQEEE/t3"+"Dov6fAH6fAT+fPp8+nwHDosMCvm1Cvm1DAz6fBQAAAAAAAABAAAAAMmJbzEAAAAAzgTj"+"FQAAAADOBOQpAAEAAAAAAAAADAAUAAQAAAABAAAAAgABAAAAAAAAAAAD6AAAAAAAAA==");return shadow(this,"_loadTestFont",t)}_prepareFontLoadEvent(t,e){function s(t,e){return t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3)&255}function i(t,e,s,i){const n=t.substring(0,e);const a=t.substring(e+s);return n+i+a}let n,a;const r=this._document.createElement("canvas");r.width=1;r.height=1;const o=r.getContext("2d");let l=0;function h(t,e){if(++l>30){warn("Load test font never loaded.");e();return}o.font="30px "+t;o.fillText(".",0,20);const s=o.getImageData(0,0,1,1);if(s.data[3]>0){e();return}setTimeout(h.bind(null,t,e))}const c=`lt${Date.now()}${this.loadTestFontId++}`;let d=this._loadTestFont;const u=976;d=i(d,u,c.length,c);const p=16;const g=1482184792;let f=s(d,p);for(n=0,a=c.length-3;n<a;n+=4){f=f-g+s(c,n)|0}if(n<c.length){f=f-g+s(c+"XXX",n)|0}d=i(d,p,4,string32(f));const m=`url(data:font/opentype;base64,${btoa(d)});`;const b=`@font-face {font-family:"${c}";src:${m}}`;this.insertRule(b);const _=this._document.createElement("div");_.style.visibility="hidden";_.style.width=_.style.height="10px";_.style.position="absolute";_.style.top=_.style.left="0px";for(const e of[t.loadedName,c]){const t=this._document.createElement("span");t.textContent="Hi";t.style.fontFamily=e;_.append(t)}this._document.body.append(_);h(c,()=>{_.remove();e.complete()})}}class FontFaceObject{constructor(t,{disableFontFace:e=false,inspectFont:s=null}){this.compiledGlyphs=Object.create(null);for(const e in t){this[e]=t[e]}this.disableFontFace=e===true;this._inspectFont=s}createNativeFontFace(){if(!this.data||this.disableFontFace){return null}let t;if(!this.cssFontInfo){t=new FontFace(this.loadedName,this.data,{})}else{const e={weight:this.cssFontInfo.fontWeight};if(this.cssFontInfo.italicAngle){e.style=`oblique ${this.cssFontInfo.italicAngle}deg`}t=new FontFace(this.cssFontInfo.fontFamily,this.data,e)}this._inspectFont?.(this);return t}createFontFaceRule(){if(!this.data||this.disableFontFace){return null}const t=bytesToString(this.data);const e=`url(data:${this.mimetype};base64,${btoa(t)});`;let s;if(!this.cssFontInfo){s=`@font-face {font-family:"${this.loadedName}";src:${e}}`}else{let t=`font-weight: ${this.cssFontInfo.fontWeight};`;if(this.cssFontInfo.italicAngle){t+=`font-style: oblique ${this.cssFontInfo.italicAngle}deg;`}s=`@font-face {font-family:"${this.cssFontInfo.fontFamily}";${t}src:${e}}`}this._inspectFont?.(this,e);return s}getPathGenerator(t,e){if(this.compiledGlyphs[e]!==undefined){return this.compiledGlyphs[e]}let s;try{s=t.get(this.loadedName+"_path_"+e)}catch(t){warn(`getPathGenerator - ignoring character: "${t}".`)}if(!Array.isArray(s)||s.length===0){return this.compiledGlyphs[e]=function(t,e){}}const i=[];for(let t=0,e=s.length;t<e;){switch(s[t++]){case FontRenderOps.BEZIER_CURVE_TO:{const[e,n,a,r,o,l]=s.slice(t,t+6);i.push(t=>t.bezierCurveTo(e,n,a,r,o,l));t+=6}break;case FontRenderOps.MOVE_TO:{const[e,n]=s.slice(t,t+2);i.push(t=>t.moveTo(e,n));t+=2}break;case FontRenderOps.LINE_TO:{const[e,n]=s.slice(t,t+2);i.push(t=>t.lineTo(e,n));t+=2}break;case FontRenderOps.QUADRATIC_CURVE_TO:{const[e,n,a,r]=s.slice(t,t+4);i.push(t=>t.quadraticCurveTo(e,n,a,r));t+=4}break;case FontRenderOps.RESTORE:i.push(t=>t.restore());break;case FontRenderOps.SAVE:i.push(t=>t.save());break;case FontRenderOps.SCALE:assert(i.length===2,"Scale command is only valid at the third position.");break;case FontRenderOps.TRANSFORM:{const[e,n,a,r,o,l]=s.slice(t,t+6);i.push(t=>t.transform(e,n,a,r,o,l));t+=6}break;case FontRenderOps.TRANSLATE:{const[e,n]=s.slice(t,t+2);i.push(t=>t.translate(e,n));t+=2}break}}return this.compiledGlyphs[e]=function t(e,s){i[0](e);i[1](e);e.scale(s,-s);for(let t=2,s=i.length;t<s;t++){i[t](e)}}}}if(isNodeJS){var packageCapability=Promise.withResolvers();var packageMap=null;const t=async()=>{const t=await import("fs"),e=await import("http"),s=await import("https"),i=await import("url");let n,a;return new Map(Object.entries({fs:t,http:e,https:s,url:i,canvas:n,path2d:a}))};t().then(t=>{packageMap=t;packageCapability.resolve()},t=>{warn(`loadPackages: ${t}`);packageMap=new Map;packageCapability.resolve()})}class NodePackages{static get promise(){return packageCapability.promise}static get(t){return packageMap?.get(t)}}const node_utils_fetchData=function(t){const e=NodePackages.get("fs");return e.promises.readFile(t).then(t=>new Uint8Array(t))};class NodeFilterFactory extends BaseFilterFactory{}class NodeCanvasFactory extends BaseCanvasFactory{_createCanvas(t,e){const s=NodePackages.get("canvas");return s.createCanvas(t,e)}}class NodeCMapReaderFactory extends BaseCMapReaderFactory{_fetchData(t,e){return node_utils_fetchData(t).then(t=>({cMapData:t,compressionType:e}))}}class NodeStandardFontDataFactory extends BaseStandardFontDataFactory{_fetchData(t){return node_utils_fetchData(t)}}const PathType={FILL:"Fill",STROKE:"Stroke",SHADING:"Shading"};function applyBoundingBox(t,e){if(!e){return}const s=e[2]-e[0];const i=e[3]-e[1];const n=new Path2D;n.rect(e[0],e[1],s,i);t.clip(n)}class BaseShadingPattern{constructor(){if(this.constructor===BaseShadingPattern){unreachable("Cannot initialize BaseShadingPattern.")}}getPattern(){unreachable("Abstract method `getPattern` called.")}}class RadialAxialShadingPattern extends BaseShadingPattern{constructor(t){super();this._type=t[1];this._bbox=t[2];this._colorStops=t[3];this._p0=t[4];this._p1=t[5];this._r0=t[6];this._r1=t[7];this.matrix=null}_createGradient(t){let e;if(this._type==="axial"){e=t.createLinearGradient(this._p0[0],this._p0[1],this._p1[0],this._p1[1])}else if(this._type==="radial"){e=t.createRadialGradient(this._p0[0],this._p0[1],this._r0,this._p1[0],this._p1[1],this._r1)}for(const t of this._colorStops){e.addColorStop(t[0],t[1])}return e}getPattern(t,e,s,i){let n;if(i===PathType.STROKE||i===PathType.FILL){const a=e.current.getClippedPathBoundingBox(i,getCurrentTransform(t))||[0,0,0,0];const r=Math.ceil(a[2]-a[0])||1;const o=Math.ceil(a[3]-a[1])||1;const l=e.cachedCanvases.getCanvas("pattern",r,o,true);const h=l.context;h.clearRect(0,0,h.canvas.width,h.canvas.height);h.beginPath();h.rect(0,0,h.canvas.width,h.canvas.height);h.translate(-a[0],-a[1]);s=Util.transform(s,[1,0,0,1,a[0],a[1]]);h.transform(...e.baseTransform);if(this.matrix){h.transform(...this.matrix)}applyBoundingBox(h,this._bbox);h.fillStyle=this._createGradient(h);h.fill();n=t.createPattern(l.canvas,"no-repeat");const c=new DOMMatrix(s);n.setTransform(c)}else{applyBoundingBox(t,this._bbox);n=this._createGradient(t)}return n}}function drawTriangle(t,e,s,i,n,a,r,o){const l=e.coords,h=e.colors;const c=t.data,d=t.width*4;let u;if(l[s+1]>l[i+1]){u=s;s=i;i=u;u=a;a=r;r=u}if(l[i+1]>l[n+1]){u=i;i=n;n=u;u=r;r=o;o=u}if(l[s+1]>l[i+1]){u=s;s=i;i=u;u=a;a=r;r=u}const p=(l[s]+e.offsetX)*e.scaleX;const g=(l[s+1]+e.offsetY)*e.scaleY;const f=(l[i]+e.offsetX)*e.scaleX;const m=(l[i+1]+e.offsetY)*e.scaleY;const b=(l[n]+e.offsetX)*e.scaleX;const _=(l[n+1]+e.offsetY)*e.scaleY;if(g>=_){return}const A=h[a],v=h[a+1],y=h[a+2];const E=h[r],w=h[r+1],x=h[r+2];const T=h[o],S=h[o+1],C=h[o+2];const P=Math.round(g),M=Math.round(_);let k,I,R,F;let L,D,O,N;for(let t=P;t<=M;t++){if(t<m){const e=t<g?0:(g-t)/(g-m);k=p-(p-f)*e;I=A-(A-E)*e;R=v-(v-w)*e;F=y-(y-x)*e}else{let e;if(t>_){e=1}else if(m===_){e=0}else{e=(m-t)/(m-_)}k=f-(f-b)*e;I=E-(E-T)*e;R=w-(w-S)*e;F=x-(x-C)*e}let e;if(t<g){e=0}else if(t>_){e=1}else{e=(g-t)/(g-_)}L=p-(p-b)*e;D=A-(A-T)*e;O=v-(v-S)*e;N=y-(y-C)*e;const s=Math.round(Math.min(k,L));const i=Math.round(Math.max(k,L));let n=d*t+s*4;for(let t=s;t<=i;t++){e=(k-t)/(k-L);if(e<0){e=0}else if(e>1){e=1}c[n++]=I-(I-D)*e|0;c[n++]=R-(R-O)*e|0;c[n++]=F-(F-N)*e|0;c[n++]=255}}}function drawFigure(t,e,s){const i=e.coords;const n=e.colors;let a,r;switch(e.type){case"lattice":const o=e.verticesPerRow;const l=Math.floor(i.length/o)-1;const h=o-1;for(a=0;a<l;a++){let e=a*o;for(let a=0;a<h;a++,e++){drawTriangle(t,s,i[e],i[e+1],i[e+o],n[e],n[e+1],n[e+o]);drawTriangle(t,s,i[e+o+1],i[e+1],i[e+o],n[e+o+1],n[e+1],n[e+o])}}break;case"triangles":for(a=0,r=i.length;a<r;a+=3){drawTriangle(t,s,i[a],i[a+1],i[a+2],n[a],n[a+1],n[a+2])}break;default:throw new Error("illegal figure")}}class MeshShadingPattern extends BaseShadingPattern{constructor(t){super();this._coords=t[2];this._colors=t[3];this._figures=t[4];this._bounds=t[5];this._bbox=t[7];this._background=t[8];this.matrix=null}_createMeshCanvas(t,e,s){const i=1.1;const n=3e3;const a=2;const r=Math.floor(this._bounds[0]);const o=Math.floor(this._bounds[1]);const l=Math.ceil(this._bounds[2])-r;const h=Math.ceil(this._bounds[3])-o;const c=Math.min(Math.ceil(Math.abs(l*t[0]*i)),n);const d=Math.min(Math.ceil(Math.abs(h*t[1]*i)),n);const u=l/c;const p=h/d;const g={coords:this._coords,colors:this._colors,offsetX:-r,offsetY:-o,scaleX:1/u,scaleY:1/p};const f=c+a*2;const m=d+a*2;const b=s.getCanvas("mesh",f,m,false);const _=b.context;const A=_.createImageData(c,d);if(e){const t=A.data;for(let s=0,i=t.length;s<i;s+=4){t[s]=e[0];t[s+1]=e[1];t[s+2]=e[2];t[s+3]=255}}for(const t of this._figures){drawFigure(A,t,g)}_.putImageData(A,a,a);const v=b.canvas;return{canvas:v,offsetX:r-a*u,offsetY:o-a*p,scaleX:u,scaleY:p}}getPattern(t,e,s,i){applyBoundingBox(t,this._bbox);let n;if(i===PathType.SHADING){n=Util.singularValueDecompose2dScale(getCurrentTransform(t))}else{n=Util.singularValueDecompose2dScale(e.baseTransform);if(this.matrix){const t=Util.singularValueDecompose2dScale(this.matrix);n=[n[0]*t[0],n[1]*t[1]]}}const a=this._createMeshCanvas(n,i===PathType.SHADING?null:this._background,e.cachedCanvases);if(i!==PathType.SHADING){t.setTransform(...e.baseTransform);if(this.matrix){t.transform(...this.matrix)}}t.translate(a.offsetX,a.offsetY);t.scale(a.scaleX,a.scaleY);return t.createPattern(a.canvas,"no-repeat")}}class DummyShadingPattern extends BaseShadingPattern{getPattern(){return"hotpink"}}function getShadingPattern(t){switch(t[0]){case"RadialAxial":return new RadialAxialShadingPattern(t);case"Mesh":return new MeshShadingPattern(t);case"Dummy":return new DummyShadingPattern}throw new Error(`Unknown IR type: ${t[0]}`)}const PaintType={COLORED:1,UNCOLORED:2};class TilingPattern{static MAX_PATTERN_SIZE=3e3;constructor(t,e,s,i,n){this.operatorList=t[2];this.matrix=t[3];this.bbox=t[4];this.xstep=t[5];this.ystep=t[6];this.paintType=t[7];this.tilingType=t[8];this.color=e;this.ctx=s;this.canvasGraphicsFactory=i;this.baseTransform=n}createPatternCanvas(t){const e=this.operatorList;const s=this.bbox;const i=this.xstep;const n=this.ystep;const a=this.paintType;const r=this.tilingType;const o=this.color;const l=this.canvasGraphicsFactory;info("TilingType: "+r);const h=s[0],c=s[1],d=s[2],u=s[3];const p=Util.singularValueDecompose2dScale(this.matrix);const g=Util.singularValueDecompose2dScale(this.baseTransform);const f=[p[0]*g[0],p[1]*g[1]];const m=this.getSizeAndScale(i,this.ctx.canvas.width,f[0]);const b=this.getSizeAndScale(n,this.ctx.canvas.height,f[1]);const _=t.cachedCanvases.getCanvas("pattern",m.size,b.size,true);const A=_.context;const v=l.createCanvasGraphics(A);v.groupLevel=t.groupLevel;this.setFillAndStrokeStyleToContext(v,a,o);let y=h;let E=c;let w=d;let x=u;if(h<0){y=0;w+=Math.abs(h)}if(c<0){E=0;x+=Math.abs(c)}A.translate(-(m.scale*y),-(b.scale*E));v.transform(m.scale,0,0,b.scale,0,0);A.save();this.clipBbox(v,y,E,w,x);v.baseTransform=getCurrentTransform(v.ctx);v.executeOperatorList(e);v.endDrawing();return{canvas:_.canvas,scaleX:m.scale,scaleY:b.scale,offsetX:y,offsetY:E}}getSizeAndScale(t,e,s){t=Math.abs(t);const i=Math.max(TilingPattern.MAX_PATTERN_SIZE,e);let n=Math.ceil(t*s);if(n>=i){n=i}else{s=n/t}return{scale:s,size:n}}clipBbox(t,e,s,i,n){const a=i-e;const r=n-s;t.ctx.rect(e,s,a,r);t.current.updateRectMinMax(getCurrentTransform(t.ctx),[e,s,i,n]);t.clip();t.endPath()}setFillAndStrokeStyleToContext(t,e,s){const i=t.ctx,n=t.current;switch(e){case PaintType.COLORED:const t=this.ctx;i.fillStyle=t.fillStyle;i.strokeStyle=t.strokeStyle;n.fillColor=t.fillStyle;n.strokeColor=t.strokeStyle;break;case PaintType.UNCOLORED:const a=Util.makeHexColor(s[0],s[1],s[2]);i.fillStyle=a;i.strokeStyle=a;n.fillColor=a;n.strokeColor=a;break;default:throw new FormatError(`Unsupported paint type: ${e}`)}}getPattern(t,e,s,i){let n=s;if(i!==PathType.SHADING){n=Util.transform(n,e.baseTransform);if(this.matrix){n=Util.transform(n,this.matrix)}}const a=this.createPatternCanvas(e);let r=new DOMMatrix(n);r=r.translate(a.offsetX,a.offsetY);r=r.scale(1/a.scaleX,1/a.scaleY);const o=t.createPattern(a.canvas,"repeat");o.setTransform(r);return o}}function convertToRGBA(t){switch(t.kind){case ImageKind.GRAYSCALE_1BPP:return convertBlackAndWhiteToRGBA(t);case ImageKind.RGB_24BPP:return convertRGBToRGBA(t)}return null}function convertBlackAndWhiteToRGBA({src:t,srcPos:e=0,dest:s,width:i,height:n,nonBlackColor:a=4294967295,inverseDecode:r=false}){const o=util_FeatureTest.isLittleEndian?4278190080:255;const[l,h]=r?[a,o]:[o,a];const c=i>>3;const d=i&7;const u=t.length;s=new Uint32Array(s.buffer);let p=0;for(let i=0;i<n;i++){for(const i=e+c;e<i;e++){const i=e<u?t[e]:255;s[p++]=i&128?h:l;s[p++]=i&64?h:l;s[p++]=i&32?h:l;s[p++]=i&16?h:l;s[p++]=i&8?h:l;s[p++]=i&4?h:l;s[p++]=i&2?h:l;s[p++]=i&1?h:l}if(d===0){continue}const i=e<u?t[e++]:255;for(let t=0;t<d;t++){s[p++]=i&1<<7-t?h:l}}return{srcPos:e,destPos:p}}function convertRGBToRGBA({src:t,srcPos:e=0,dest:s,destPos:i=0,width:n,height:a}){let r=0;const o=t.length>>2;const l=new Uint32Array(t.buffer,e,o);if(FeatureTest.isLittleEndian){for(;r<o-2;r+=3,i+=4){const t=l[r];const e=l[r+1];const n=l[r+2];s[i]=t|4278190080;s[i+1]=t>>>24|e<<8|4278190080;s[i+2]=e>>>16|n<<16|4278190080;s[i+3]=n>>>8|4278190080}for(let e=r*4,n=t.length;e<n;e+=3){s[i++]=t[e]|t[e+1]<<8|t[e+2]<<16|4278190080}}else{for(;r<o-2;r+=3,i+=4){const t=l[r];const e=l[r+1];const n=l[r+2];s[i]=t|255;s[i+1]=t<<24|e>>>8|255;s[i+2]=e<<16|n>>>16|255;s[i+3]=n<<8|255}for(let e=r*4,n=t.length;e<n;e+=3){s[i++]=t[e]<<24|t[e+1]<<16|t[e+2]<<8|255}}return{srcPos:e,destPos:i}}function grayToRGBA(t,e){if(FeatureTest.isLittleEndian){for(let s=0,i=t.length;s<i;s++){e[s]=t[s]*65793|4278190080}}else{for(let s=0,i=t.length;s<i;s++){e[s]=t[s]*16843008|255}}}const MIN_FONT_SIZE=16;const MAX_FONT_SIZE=100;const EXECUTION_TIME=15;const EXECUTION_STEPS=10;const MAX_SIZE_TO_COMPILE=1e3;const FULL_CHUNK_HEIGHT=16;function mirrorContextOperations(t,e){if(t._removeMirroring){throw new Error("Context is already forwarding operations.")}t.__originalSave=t.save;t.__originalRestore=t.restore;t.__originalRotate=t.rotate;t.__originalScale=t.scale;t.__originalTranslate=t.translate;t.__originalTransform=t.transform;t.__originalSetTransform=t.setTransform;t.__originalResetTransform=t.resetTransform;t.__originalClip=t.clip;t.__originalMoveTo=t.moveTo;t.__originalLineTo=t.lineTo;t.__originalBezierCurveTo=t.bezierCurveTo;t.__originalRect=t.rect;t.__originalClosePath=t.closePath;t.__originalBeginPath=t.beginPath;t._removeMirroring=()=>{t.save=t.__originalSave;t.restore=t.__originalRestore;t.rotate=t.__originalRotate;t.scale=t.__originalScale;t.translate=t.__originalTranslate;t.transform=t.__originalTransform;t.setTransform=t.__originalSetTransform;t.resetTransform=t.__originalResetTransform;t.clip=t.__originalClip;t.moveTo=t.__originalMoveTo;t.lineTo=t.__originalLineTo;t.bezierCurveTo=t.__originalBezierCurveTo;t.rect=t.__originalRect;t.closePath=t.__originalClosePath;t.beginPath=t.__originalBeginPath;delete t._removeMirroring};t.save=function t(){e.save();this.__originalSave()};t.restore=function t(){e.restore();this.__originalRestore()};t.translate=function t(s,i){e.translate(s,i);this.__originalTranslate(s,i)};t.scale=function t(s,i){e.scale(s,i);this.__originalScale(s,i)};t.transform=function t(s,i,n,a,r,o){e.transform(s,i,n,a,r,o);this.__originalTransform(s,i,n,a,r,o)};t.setTransform=function t(s,i,n,a,r,o){e.setTransform(s,i,n,a,r,o);this.__originalSetTransform(s,i,n,a,r,o)};t.resetTransform=function t(){e.resetTransform();this.__originalResetTransform()};t.rotate=function t(s){e.rotate(s);this.__originalRotate(s)};t.clip=function t(s){e.clip(s);this.__originalClip(s)};t.moveTo=function(t,s){e.moveTo(t,s);this.__originalMoveTo(t,s)};t.lineTo=function(t,s){e.lineTo(t,s);this.__originalLineTo(t,s)};t.bezierCurveTo=function(t,s,i,n,a,r){e.bezierCurveTo(t,s,i,n,a,r);this.__originalBezierCurveTo(t,s,i,n,a,r)};t.rect=function(t,s,i,n){e.rect(t,s,i,n);this.__originalRect(t,s,i,n)};t.closePath=function(){e.closePath();this.__originalClosePath()};t.beginPath=function(){e.beginPath();this.__originalBeginPath()}}class CachedCanvases{constructor(t){this.canvasFactory=t;this.cache=Object.create(null)}getCanvas(t,e,s){let i;if(this.cache[t]!==undefined){i=this.cache[t];this.canvasFactory.reset(i,e,s)}else{i=this.canvasFactory.create(e,s);this.cache[t]=i}return i}delete(t){delete this.cache[t]}clear(){for(const t in this.cache){const e=this.cache[t];this.canvasFactory.destroy(e);delete this.cache[t]}}}function drawImageAtIntegerCoords(t,e,s,i,n,a,r,o,l,h){const[c,d,u,p,g,f]=getCurrentTransform(t);if(d===0&&u===0){const m=r*c+g;const b=Math.round(m);const _=o*p+f;const A=Math.round(_);const v=(r+l)*c+g;const y=Math.abs(Math.round(v)-b)||1;const E=(o+h)*p+f;const w=Math.abs(Math.round(E)-A)||1;t.setTransform(Math.sign(c),0,0,Math.sign(p),b,A);t.drawImage(e,s,i,n,a,0,0,y,w);t.setTransform(c,d,u,p,g,f);return[y,w]}if(c===0&&p===0){const m=o*u+g;const b=Math.round(m);const _=r*d+f;const A=Math.round(_);const v=(o+h)*u+g;const y=Math.abs(Math.round(v)-b)||1;const E=(r+l)*d+f;const w=Math.abs(Math.round(E)-A)||1;t.setTransform(0,Math.sign(d),Math.sign(u),0,b,A);t.drawImage(e,s,i,n,a,0,0,w,y);t.setTransform(c,d,u,p,g,f);return[w,y]}t.drawImage(e,s,i,n,a,r,o,l,h);const m=Math.hypot(c,d);const b=Math.hypot(u,p);return[m*l,b*h]}function compileType3Glyph(t){const{width:e,height:s}=t;if(e>MAX_SIZE_TO_COMPILE||s>MAX_SIZE_TO_COMPILE){return null}const i=1e3;const n=new Uint8Array([0,2,4,0,1,0,5,4,8,10,0,8,0,2,1,0]);const a=e+1;let r=new Uint8Array(a*(s+1));let o,l,h;const c=e+7&~7;let d=new Uint8Array(c*s),u=0;for(const e of t.data){let t=128;while(t>0){d[u++]=e&t?0:255;t>>=1}}let p=0;u=0;if(d[u]!==0){r[0]=1;++p}for(l=1;l<e;l++){if(d[u]!==d[u+1]){r[l]=d[u]?2:1;++p}u++}if(d[u]!==0){r[l]=2;++p}for(o=1;o<s;o++){u=o*c;h=o*a;if(d[u-c]!==d[u]){r[h]=d[u]?1:8;++p}let t=(d[u]?4:0)+(d[u-c]?8:0);for(l=1;l<e;l++){t=(t>>2)+(d[u+1]?4:0)+(d[u-c+1]?8:0);if(n[t]){r[h+l]=n[t];++p}u++}if(d[u-c]!==d[u]){r[h+l]=d[u]?2:4;++p}if(p>i){return null}}u=c*(s-1);h=o*a;if(d[u]!==0){r[h]=8;++p}for(l=1;l<e;l++){if(d[u]!==d[u+1]){r[h+l]=d[u]?4:8;++p}u++}if(d[u]!==0){r[h+l]=4;++p}if(p>i){return null}const g=new Int32Array([0,a,-1,0,-a,0,0,0,1]);const f=new Path2D;for(o=0;p&&o<=s;o++){let t=o*a;const s=t+e;while(t<s&&!r[t]){t++}if(t===s){continue}f.moveTo(t%a,o);const i=t;let n=r[t];do{const e=g[n];do{t+=e}while(!r[t]);const s=r[t];if(s!==5&&s!==10){n=s;r[t]=0}else{n=s&51*n>>4;r[t]&=n>>2|n<<2}f.lineTo(t%a,t/a|0);if(!r[t]){--p}}while(i!==t);--o}d=null;r=null;const m=function(t){t.save();t.scale(1/e,-1/s);t.translate(0,-s);t.fill(f);t.beginPath();t.restore()};return m}class CanvasExtraState{constructor(t,e){this.alphaIsShape=false;this.fontSize=0;this.fontSizeScale=1;this.textMatrix=IDENTITY_MATRIX;this.textMatrixScale=1;this.fontMatrix=FONT_IDENTITY_MATRIX;this.leading=0;this.x=0;this.y=0;this.lineX=0;this.lineY=0;this.charSpacing=0;this.wordSpacing=0;this.textHScale=1;this.textRenderingMode=TextRenderingMode.FILL;this.textRise=0;this.fillColor="#000000";this.strokeColor="#000000";this.patternFill=false;this.fillAlpha=1;this.strokeAlpha=1;this.lineWidth=1;this.activeSMask=null;this.transferMaps="none";this.startNewPathAndClipBox([0,0,t,e])}clone(){const t=Object.create(this);t.clipBox=this.clipBox.slice();return t}setCurrentPoint(t,e){this.x=t;this.y=e}updatePathMinMax(t,e,s){[e,s]=Util.applyTransform([e,s],t);this.minX=Math.min(this.minX,e);this.minY=Math.min(this.minY,s);this.maxX=Math.max(this.maxX,e);this.maxY=Math.max(this.maxY,s)}updateRectMinMax(t,e){const s=Util.applyTransform(e,t);const i=Util.applyTransform(e.slice(2),t);const n=Util.applyTransform([e[0],e[3]],t);const a=Util.applyTransform([e[2],e[1]],t);this.minX=Math.min(this.minX,s[0],i[0],n[0],a[0]);this.minY=Math.min(this.minY,s[1],i[1],n[1],a[1]);this.maxX=Math.max(this.maxX,s[0],i[0],n[0],a[0]);this.maxY=Math.max(this.maxY,s[1],i[1],n[1],a[1])}updateScalingPathMinMax(t,e){Util.scaleMinMax(t,e);this.minX=Math.min(this.minX,e[0]);this.minY=Math.min(this.minY,e[1]);this.maxX=Math.max(this.maxX,e[2]);this.maxY=Math.max(this.maxY,e[3])}updateCurvePathMinMax(t,e,s,i,n,a,r,o,l,h){const c=Util.bezierBoundingBox(e,s,i,n,a,r,o,l,h);if(h){return}this.updateRectMinMax(t,c)}getPathBoundingBox(t=PathType.FILL,e=null){const s=[this.minX,this.minY,this.maxX,this.maxY];if(t===PathType.STROKE){if(!e){unreachable("Stroke bounding box must include transform.")}const t=Util.singularValueDecompose2dScale(e);const i=t[0]*this.lineWidth/2;const n=t[1]*this.lineWidth/2;s[0]-=i;s[1]-=n;s[2]+=i;s[3]+=n}return s}updateClipFromPath(){const t=Util.intersect(this.clipBox,this.getPathBoundingBox());this.startNewPathAndClipBox(t||[0,0,0,0])}isEmptyClip(){return this.minX===Infinity}startNewPathAndClipBox(t){this.clipBox=t;this.minX=Infinity;this.minY=Infinity;this.maxX=0;this.maxY=0}getClippedPathBoundingBox(t=PathType.FILL,e=null){return Util.intersect(this.clipBox,this.getPathBoundingBox(t,e))}}function putBinaryImageData(t,e){if(typeof ImageData!=="undefined"&&e instanceof ImageData){t.putImageData(e,0,0);return}const s=e.height,i=e.width;const n=s%FULL_CHUNK_HEIGHT;const a=(s-n)/FULL_CHUNK_HEIGHT;const r=n===0?a:a+1;const o=t.createImageData(i,FULL_CHUNK_HEIGHT);let l=0,h;const c=e.data;const d=o.data;let u,p,g,f;if(e.kind===util_ImageKind.GRAYSCALE_1BPP){const e=c.byteLength;const s=new Uint32Array(d.buffer,0,d.byteLength>>2);const f=s.length;const m=i+7>>3;const b=4294967295;const _=util_FeatureTest.isLittleEndian?4278190080:255;for(u=0;u<r;u++){g=u<a?FULL_CHUNK_HEIGHT:n;h=0;for(p=0;p<g;p++){const t=e-l;let n=0;const a=t>m?i:t*8-7;const r=a&~7;let o=0;let d=0;for(;n<r;n+=8){d=c[l++];s[h++]=d&128?b:_;s[h++]=d&64?b:_;s[h++]=d&32?b:_;s[h++]=d&16?b:_;s[h++]=d&8?b:_;s[h++]=d&4?b:_;s[h++]=d&2?b:_;s[h++]=d&1?b:_}for(;n<a;n++){if(o===0){d=c[l++];o=128}s[h++]=d&o?b:_;o>>=1}}while(h<f){s[h++]=0}t.putImageData(o,0,u*FULL_CHUNK_HEIGHT)}}else if(e.kind===util_ImageKind.RGBA_32BPP){p=0;f=i*FULL_CHUNK_HEIGHT*4;for(u=0;u<a;u++){d.set(c.subarray(l,l+f));l+=f;t.putImageData(o,0,p);p+=FULL_CHUNK_HEIGHT}if(u<r){f=i*n*4;d.set(c.subarray(l,l+f));t.putImageData(o,0,p)}}else if(e.kind===util_ImageKind.RGB_24BPP){g=FULL_CHUNK_HEIGHT;f=i*g;for(u=0;u<r;u++){if(u>=a){g=n;f=i*g}h=0;for(p=f;p--;){d[h++]=c[l++];d[h++]=c[l++];d[h++]=c[l++];d[h++]=255}t.putImageData(o,0,u*FULL_CHUNK_HEIGHT)}}else{throw new Error(`bad image kind: ${e.kind}`)}}function putBinaryImageMask(t,e){if(e.bitmap){t.drawImage(e.bitmap,0,0);return}const s=e.height,i=e.width;const n=s%FULL_CHUNK_HEIGHT;const a=(s-n)/FULL_CHUNK_HEIGHT;const r=n===0?a:a+1;const o=t.createImageData(i,FULL_CHUNK_HEIGHT);let l=0;const h=e.data;const c=o.data;for(let e=0;e<r;e++){const s=e<a?FULL_CHUNK_HEIGHT:n;({srcPos:l}=convertBlackAndWhiteToRGBA({src:h,srcPos:l,dest:c,width:i,height:s,nonBlackColor:0}));t.putImageData(o,0,e*FULL_CHUNK_HEIGHT)}}function copyCtxState(t,e){const s=["strokeStyle","fillStyle","fillRule","globalAlpha","lineWidth","lineCap","lineJoin","miterLimit","globalCompositeOperation","font","filter"];for(const i of s){if(t[i]!==undefined){e[i]=t[i]}}if(t.setLineDash!==undefined){e.setLineDash(t.getLineDash());e.lineDashOffset=t.lineDashOffset}}function resetCtxToDefault(t){t.strokeStyle=t.fillStyle="#000000";t.fillRule="nonzero";t.globalAlpha=1;t.lineWidth=1;t.lineCap="butt";t.lineJoin="miter";t.miterLimit=10;t.globalCompositeOperation="source-over";t.font="10px sans-serif";if(t.setLineDash!==undefined){t.setLineDash([]);t.lineDashOffset=0}if(!isNodeJS){const{filter:e}=t;if(e!=="none"&&e!==""){t.filter="none"}}}function getImageSmoothingEnabled(t,e){if(e){return true}const s=Util.singularValueDecompose2dScale(t);s[0]=Math.fround(s[0]);s[1]=Math.fround(s[1]);const i=Math.fround((globalThis.devicePixelRatio||1)*PixelsPerInch.PDF_TO_CSS_UNITS);return s[0]<=i&&s[1]<=i}const LINE_CAP_STYLES=["butt","round","square"];const LINE_JOIN_STYLES=["miter","round","bevel"];const NORMAL_CLIP={};const EO_CLIP={};class CanvasGraphics{constructor(t,e,s,i,n,{optionalContentConfig:a,markedContentStack:r=null},o,l){this.ctx=t;this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height);this.stateStack=[];this.pendingClip=null;this.pendingEOFill=false;this.res=null;this.xobjs=null;this.commonObjs=e;this.objs=s;this.canvasFactory=i;this.filterFactory=n;this.groupStack=[];this.processingType3=null;this.baseTransform=null;this.baseTransformStack=[];this.groupLevel=0;this.smaskStack=[];this.smaskCounter=0;this.tempSMask=null;this.suspendedCtx=null;this.contentVisible=true;this.markedContentStack=r||[];this.optionalContentConfig=a;this.cachedCanvases=new CachedCanvases(this.canvasFactory);this.cachedPatterns=new Map;this.annotationCanvasMap=o;this.viewportScale=1;this.outputScaleX=1;this.outputScaleY=1;this.pageColors=l;this._cachedScaleForStroking=[-1,0];this._cachedGetSinglePixelWidth=null;this._cachedBitmapsMap=new Map}getObject(t,e=null){if(typeof t==="string"){return t.startsWith("g_")?this.commonObjs.get(t):this.objs.get(t)}return e}beginDrawing({transform:t,viewport:e,transparency:s=false,background:i=null}){const n=this.ctx.canvas.width;const a=this.ctx.canvas.height;const r=this.ctx.fillStyle;this.ctx.fillStyle=i||"#ffffff";this.ctx.fillRect(0,0,n,a);this.ctx.fillStyle=r;if(s){const t=this.cachedCanvases.getCanvas("transparent",n,a);this.compositeCtx=this.ctx;this.transparentCanvas=t.canvas;this.ctx=t.context;this.ctx.save();this.ctx.transform(...getCurrentTransform(this.compositeCtx))}this.ctx.save();resetCtxToDefault(this.ctx);if(t){this.ctx.transform(...t);this.outputScaleX=t[0];this.outputScaleY=t[0]}this.ctx.transform(...e.transform);this.viewportScale=e.scale;this.baseTransform=getCurrentTransform(this.ctx)}executeOperatorList(t,e,s,i){const n=t.argsArray;const a=t.fnArray;let r=e||0;const o=n.length;if(o===r){return r}const l=o-r>EXECUTION_STEPS&&typeof s==="function";const h=l?Date.now()+EXECUTION_TIME:0;let c=0;const d=this.commonObjs;const u=this.objs;let p;while(true){if(i!==undefined&&r===i.nextBreakPoint){i.breakIt(r,s);return r}p=a[r];if(p!==OPS.dependency){this[p].apply(this,n[r])}else{for(const t of n[r]){const e=t.startsWith("g_")?d:u;if(!e.has(t)){e.get(t,s);return r}}}r++;if(r===o){return r}if(l&&++c>EXECUTION_STEPS){if(Date.now()>h){s();return r}c=0}}}#$e(){while(this.stateStack.length||this.inSMaskMode){this.restore()}this.ctx.restore();if(this.transparentCanvas){this.ctx=this.compositeCtx;this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.drawImage(this.transparentCanvas,0,0);this.ctx.restore();this.transparentCanvas=null}}endDrawing(){this.#$e();this.cachedCanvases.clear();this.cachedPatterns.clear();for(const t of this._cachedBitmapsMap.values()){for(const e of t.values()){if(typeof HTMLCanvasElement!=="undefined"&&e instanceof HTMLCanvasElement){e.width=e.height=0}}t.clear()}this._cachedBitmapsMap.clear();this.#Ke()}#Ke(){if(this.pageColors){const t=this.filterFactory.addHCMFilter(this.pageColors.foreground,this.pageColors.background);if(t!=="none"){const e=this.ctx.filter;this.ctx.filter=t;this.ctx.drawImage(this.ctx.canvas,0,0);this.ctx.filter=e}}}_scaleImage(t,e){const s=t.width;const i=t.height;let n=Math.max(Math.hypot(e[0],e[1]),1);let a=Math.max(Math.hypot(e[2],e[3]),1);let r=s,o=i;let l="prescale1";let h,c;while(n>2&&r>1||a>2&&o>1){let e=r,s=o;if(n>2&&r>1){e=r>=16384?Math.floor(r/2)-1||1:Math.ceil(r/2);n/=r/e}if(a>2&&o>1){s=o>=16384?Math.floor(o/2)-1||1:Math.ceil(o)/2;a/=o/s}h=this.cachedCanvases.getCanvas(l,e,s);c=h.context;c.clearRect(0,0,e,s);c.drawImage(t,0,0,r,o,0,0,e,s);t=h.canvas;r=e;o=s;l=l==="prescale1"?"prescale2":"prescale1"}return{img:t,paintWidth:r,paintHeight:o}}_createMaskCanvas(t){const e=this.ctx;const{width:s,height:i}=t;const n=this.current.fillColor;const a=this.current.patternFill;const r=getCurrentTransform(e);let o,l,h,c;if((t.bitmap||t.data)&&t.count>1){const e=t.bitmap||t.data.buffer;l=JSON.stringify(a?r:[r.slice(0,4),n]);o=this._cachedBitmapsMap.get(e);if(!o){o=new Map;this._cachedBitmapsMap.set(e,o)}const s=o.get(l);if(s&&!a){const t=Math.round(Math.min(r[0],r[2])+r[4]);const e=Math.round(Math.min(r[1],r[3])+r[5]);return{canvas:s,offsetX:t,offsetY:e}}h=s}if(!h){c=this.cachedCanvases.getCanvas("maskCanvas",s,i);putBinaryImageMask(c.context,t)}let d=Util.transform(r,[1/s,0,0,-1/i,0,0]);d=Util.transform(d,[1,0,0,1,0,-i]);const[u,p,g,f]=Util.getAxialAlignedBoundingBox([0,0,s,i],d);const m=Math.round(g-u)||1;const b=Math.round(f-p)||1;const _=this.cachedCanvases.getCanvas("fillCanvas",m,b);const A=_.context;const v=u;const y=p;A.translate(-v,-y);A.transform(...d);if(!h){h=this._scaleImage(c.canvas,getCurrentTransformInverse(A));h=h.img;if(o&&a){o.set(l,h)}}A.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(A),t.interpolate);drawImageAtIntegerCoords(A,h,0,0,h.width,h.height,0,0,s,i);A.globalCompositeOperation="source-in";const E=Util.transform(getCurrentTransformInverse(A),[1,0,0,1,-v,-y]);A.fillStyle=a?n.getPattern(e,this,E,PathType.FILL):n;A.fillRect(0,0,s,i);if(o&&!a){this.cachedCanvases.delete("fillCanvas");o.set(l,_.canvas)}return{canvas:_.canvas,offsetX:Math.round(v),offsetY:Math.round(y)}}setLineWidth(t){if(t!==this.current.lineWidth){this._cachedScaleForStroking[0]=-1}this.current.lineWidth=t;this.ctx.lineWidth=t}setLineCap(t){this.ctx.lineCap=LINE_CAP_STYLES[t]}setLineJoin(t){this.ctx.lineJoin=LINE_JOIN_STYLES[t]}setMiterLimit(t){this.ctx.miterLimit=t}setDash(t,e){const s=this.ctx;if(s.setLineDash!==undefined){s.setLineDash(t);s.lineDashOffset=e}}setRenderingIntent(t){}setFlatness(t){}setGState(t){for(const[e,s]of t){switch(e){case"LW":this.setLineWidth(s);break;case"LC":this.setLineCap(s);break;case"LJ":this.setLineJoin(s);break;case"ML":this.setMiterLimit(s);break;case"D":this.setDash(s[0],s[1]);break;case"RI":this.setRenderingIntent(s);break;case"FL":this.setFlatness(s);break;case"Font":this.setFont(s[0],s[1]);break;case"CA":this.current.strokeAlpha=s;break;case"ca":this.current.fillAlpha=s;this.ctx.globalAlpha=s;break;case"BM":this.ctx.globalCompositeOperation=s;break;case"SMask":this.current.activeSMask=s?this.tempSMask:null;this.tempSMask=null;this.checkSMaskState();break;case"TR":this.ctx.filter=this.current.transferMaps=this.filterFactory.addFilter(s);break}}}get inSMaskMode(){return!!this.suspendedCtx}checkSMaskState(){const t=this.inSMaskMode;if(this.current.activeSMask&&!t){this.beginSMaskMode()}else if(!this.current.activeSMask&&t){this.endSMaskMode()}}beginSMaskMode(){if(this.inSMaskMode){throw new Error("beginSMaskMode called while already in smask mode")}const t=this.ctx.canvas.width;const e=this.ctx.canvas.height;const s="smaskGroupAt"+this.groupLevel;const i=this.cachedCanvases.getCanvas(s,t,e);this.suspendedCtx=this.ctx;this.ctx=i.context;const n=this.ctx;n.setTransform(...getCurrentTransform(this.suspendedCtx));copyCtxState(this.suspendedCtx,n);mirrorContextOperations(n,this.suspendedCtx);this.setGState([["BM","source-over"],["ca",1],["CA",1]])}endSMaskMode(){if(!this.inSMaskMode){throw new Error("endSMaskMode called while not in smask mode")}this.ctx._removeMirroring();copyCtxState(this.ctx,this.suspendedCtx);this.ctx=this.suspendedCtx;this.suspendedCtx=null}compose(t){if(!this.current.activeSMask){return}if(!t){t=[0,0,this.ctx.canvas.width,this.ctx.canvas.height]}else{t[0]=Math.floor(t[0]);t[1]=Math.floor(t[1]);t[2]=Math.ceil(t[2]);t[3]=Math.ceil(t[3])}const e=this.current.activeSMask;const s=this.suspendedCtx;this.composeSMask(s,e,this.ctx,t);this.ctx.save();this.ctx.setTransform(1,0,0,1,0,0);this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);this.ctx.restore()}composeSMask(t,e,s,i){const n=i[0];const a=i[1];const r=i[2]-n;const o=i[3]-a;if(r===0||o===0){return}this.genericComposeSMask(e.context,s,r,o,e.subtype,e.backdrop,e.transferMap,n,a,e.offsetX,e.offsetY);t.save();t.globalAlpha=1;t.globalCompositeOperation="source-over";t.setTransform(1,0,0,1,0,0);t.drawImage(s.canvas,0,0);t.restore()}genericComposeSMask(t,e,s,i,n,a,r,o,l,h,c){let d=t.canvas;let u=o-h;let p=l-c;if(a){if(u<0||p<0||u+s>d.width||p+i>d.height){const t=this.cachedCanvases.getCanvas("maskExtension",s,i);const e=t.context;e.drawImage(d,-u,-p);if(a.some(t=>t!==0)){e.globalCompositeOperation="destination-atop";e.fillStyle=Util.makeHexColor(...a);e.fillRect(0,0,s,i);e.globalCompositeOperation="source-over"}d=t.canvas;u=p=0}else if(a.some(t=>t!==0)){t.save();t.globalAlpha=1;t.setTransform(1,0,0,1,0,0);const e=new Path2D;e.rect(u,p,s,i);t.clip(e);t.globalCompositeOperation="destination-atop";t.fillStyle=Util.makeHexColor(...a);t.fillRect(u,p,s,i);t.restore()}}e.save();e.globalAlpha=1;e.setTransform(1,0,0,1,0,0);if(n==="Alpha"&&r){e.filter=this.filterFactory.addAlphaFilter(r)}else if(n==="Luminosity"){e.filter=this.filterFactory.addLuminosityFilter(r)}const g=new Path2D;g.rect(o,l,s,i);e.clip(g);e.globalCompositeOperation="destination-in";e.drawImage(d,u,p,s,i,o,l,s,i);e.restore()}save(){if(this.inSMaskMode){copyCtxState(this.ctx,this.suspendedCtx);this.suspendedCtx.save()}else{this.ctx.save()}const t=this.current;this.stateStack.push(t);this.current=t.clone()}restore(){if(this.stateStack.length===0&&this.inSMaskMode){this.endSMaskMode()}if(this.stateStack.length!==0){this.current=this.stateStack.pop();if(this.inSMaskMode){this.suspendedCtx.restore();copyCtxState(this.suspendedCtx,this.ctx)}else{this.ctx.restore()}this.checkSMaskState();this.pendingClip=null;this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null}}transform(t,e,s,i,n,a){this.ctx.transform(t,e,s,i,n,a);this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null}constructPath(t,e,s){const i=this.ctx;const n=this.current;let a=n.x,r=n.y;let o,l;const h=getCurrentTransform(i);const c=h[0]===0&&h[3]===0||h[1]===0&&h[2]===0;const d=c?s.slice(0):null;for(let s=0,u=0,p=t.length;s<p;s++){switch(t[s]|0){case OPS.rectangle:a=e[u++];r=e[u++];const t=e[u++];const s=e[u++];const p=a+t;const g=r+s;i.moveTo(a,r);if(t===0||s===0){i.lineTo(p,g)}else{i.lineTo(p,r);i.lineTo(p,g);i.lineTo(a,g)}if(!c){n.updateRectMinMax(h,[a,r,p,g])}i.closePath();break;case OPS.moveTo:a=e[u++];r=e[u++];i.moveTo(a,r);if(!c){n.updatePathMinMax(h,a,r)}break;case OPS.lineTo:a=e[u++];r=e[u++];i.lineTo(a,r);if(!c){n.updatePathMinMax(h,a,r)}break;case OPS.curveTo:o=a;l=r;a=e[u+4];r=e[u+5];i.bezierCurveTo(e[u],e[u+1],e[u+2],e[u+3],a,r);n.updateCurvePathMinMax(h,o,l,e[u],e[u+1],e[u+2],e[u+3],a,r,d);u+=6;break;case OPS.curveTo2:o=a;l=r;i.bezierCurveTo(a,r,e[u],e[u+1],e[u+2],e[u+3]);n.updateCurvePathMinMax(h,o,l,a,r,e[u],e[u+1],e[u+2],e[u+3],d);a=e[u+2];r=e[u+3];u+=4;break;case OPS.curveTo3:o=a;l=r;a=e[u+2];r=e[u+3];i.bezierCurveTo(e[u],e[u+1],a,r,a,r);n.updateCurvePathMinMax(h,o,l,e[u],e[u+1],a,r,a,r,d);u+=4;break;case OPS.closePath:i.closePath();break}}if(c){n.updateScalingPathMinMax(h,d)}n.setCurrentPoint(a,r)}closePath(){this.ctx.closePath()}stroke(t=true){const e=this.ctx;const s=this.current.strokeColor;e.globalAlpha=this.current.strokeAlpha;if(this.contentVisible){if(typeof s==="object"&&s?.getPattern){e.save();e.strokeStyle=s.getPattern(e,this,getCurrentTransformInverse(e),PathType.STROKE);this.rescaleAndStroke(false);e.restore()}else{this.rescaleAndStroke(true)}}if(t){this.consumePath(this.current.getClippedPathBoundingBox())}e.globalAlpha=this.current.fillAlpha}closeStroke(){this.closePath();this.stroke()}fill(t=true){const e=this.ctx;const s=this.current.fillColor;const i=this.current.patternFill;let n=false;if(i){e.save();e.fillStyle=s.getPattern(e,this,getCurrentTransformInverse(e),PathType.FILL);n=true}const a=this.current.getClippedPathBoundingBox();if(this.contentVisible&&a!==null){if(this.pendingEOFill){e.fill("evenodd");this.pendingEOFill=false}else{e.fill()}}if(n){e.restore()}if(t){this.consumePath(a)}}eoFill(){this.pendingEOFill=true;this.fill()}fillStroke(){this.fill(false);this.stroke(false);this.consumePath()}eoFillStroke(){this.pendingEOFill=true;this.fillStroke()}closeFillStroke(){this.closePath();this.fillStroke()}closeEOFillStroke(){this.pendingEOFill=true;this.closePath();this.fillStroke()}endPath(){this.consumePath()}clip(){this.pendingClip=NORMAL_CLIP}eoClip(){this.pendingClip=EO_CLIP}beginText(){this.current.textMatrix=IDENTITY_MATRIX;this.current.textMatrixScale=1;this.current.x=this.current.lineX=0;this.current.y=this.current.lineY=0}endText(){const t=this.pendingTextPaths;const e=this.ctx;if(t===undefined){e.beginPath();return}e.save();e.beginPath();for(const s of t){e.setTransform(...s.transform);e.translate(s.x,s.y);s.addToPath(e,s.fontSize)}e.restore();e.clip();e.beginPath();delete this.pendingTextPaths}setCharSpacing(t){this.current.charSpacing=t}setWordSpacing(t){this.current.wordSpacing=t}setHScale(t){this.current.textHScale=t/100}setLeading(t){this.current.leading=-t}setFont(t,e){const s=this.commonObjs.get(t);const i=this.current;if(!s){throw new Error(`Can't find font for ${t}`)}i.fontMatrix=s.fontMatrix||FONT_IDENTITY_MATRIX;if(i.fontMatrix[0]===0||i.fontMatrix[3]===0){warn("Invalid font matrix for font "+t)}if(e<0){e=-e;i.fontDirection=-1}else{i.fontDirection=1}this.current.font=s;this.current.fontSize=e;if(s.isType3Font){return}const n=s.loadedName||"sans-serif";const a=s.systemFontInfo?.css||`"${n}", ${s.fallbackName}`;let r="normal";if(s.black){r="900"}else if(s.bold){r="bold"}const o=s.italic?"italic":"normal";let l=e;if(e<MIN_FONT_SIZE){l=MIN_FONT_SIZE}else if(e>MAX_FONT_SIZE){l=MAX_FONT_SIZE}this.current.fontSizeScale=e/l;this.ctx.font=`${o} ${r} ${l}px ${a}`}setTextRenderingMode(t){this.current.textRenderingMode=t}setTextRise(t){this.current.textRise=t}moveText(t,e){this.current.x=this.current.lineX+=t;this.current.y=this.current.lineY+=e}setLeadingMoveText(t,e){this.setLeading(-e);this.moveText(t,e)}setTextMatrix(t,e,s,i,n,a){this.current.textMatrix=[t,e,s,i,n,a];this.current.textMatrixScale=Math.hypot(t,e);this.current.x=this.current.lineX=0;this.current.y=this.current.lineY=0}nextLine(){this.moveText(0,this.current.leading)}paintChar(t,e,s,i){const n=this.ctx;const a=this.current;const r=a.font;const o=a.textRenderingMode;const l=a.fontSize/a.fontSizeScale;const h=o&TextRenderingMode.FILL_STROKE_MASK;const c=!!(o&TextRenderingMode.ADD_TO_PATH_FLAG);const d=a.patternFill&&!r.missingFile;let u;if(r.disableFontFace||c||d){u=r.getPathGenerator(this.commonObjs,t)}if(r.disableFontFace||d){n.save();n.translate(e,s);n.beginPath();u(n,l);if(i){n.setTransform(...i)}if(h===TextRenderingMode.FILL||h===TextRenderingMode.FILL_STROKE){n.fill()}if(h===TextRenderingMode.STROKE||h===TextRenderingMode.FILL_STROKE){n.stroke()}n.restore()}else{if(h===TextRenderingMode.FILL||h===TextRenderingMode.FILL_STROKE){n.fillText(t,e,s)}if(h===TextRenderingMode.STROKE||h===TextRenderingMode.FILL_STROKE){n.strokeText(t,e,s)}}if(c){const t=this.pendingTextPaths||=[];t.push({transform:getCurrentTransform(n),x:e,y:s,fontSize:l,addToPath:u})}}get isFontSubpixelAAEnabled(){const{context:t}=this.cachedCanvases.getCanvas("isFontSubpixelAAEnabled",10,10);t.scale(1.5,1);t.fillText("I",0,10);const e=t.getImageData(0,0,10,10).data;let s=false;for(let t=3;t<e.length;t+=4){if(e[t]>0&&e[t]<255){s=true;break}}return shadow(this,"isFontSubpixelAAEnabled",s)}showText(t){const e=this.current;const s=e.font;if(s.isType3Font){return this.showType3Text(t)}const i=e.fontSize;if(i===0){return undefined}const n=this.ctx;const a=e.fontSizeScale;const r=e.charSpacing;const o=e.wordSpacing;const l=e.fontDirection;const h=e.textHScale*l;const c=t.length;const d=s.vertical;const u=d?1:-1;const p=s.defaultVMetrics;const g=i*e.fontMatrix[0];const f=e.textRenderingMode===TextRenderingMode.FILL&&!s.disableFontFace&&!e.patternFill;n.save();n.transform(...e.textMatrix);n.translate(e.x,e.y+e.textRise);if(l>0){n.scale(h,-1)}else{n.scale(h,1)}let m;if(e.patternFill){n.save();const t=e.fillColor.getPattern(n,this,getCurrentTransformInverse(n),PathType.FILL);m=getCurrentTransform(n);n.restore();n.fillStyle=t}let b=e.lineWidth;const _=e.textMatrixScale;if(_===0||b===0){const t=e.textRenderingMode&TextRenderingMode.FILL_STROKE_MASK;if(t===TextRenderingMode.STROKE||t===TextRenderingMode.FILL_STROKE){b=this.getSinglePixelWidth()}}else{b/=_}if(a!==1){n.scale(a,a);b/=a}n.lineWidth=b;if(s.isInvalidPDFjsFont){const s=[];let i=0;for(const e of t){s.push(e.unicode);i+=e.width}n.fillText(s.join(""),0,0);e.x+=i*g*h;n.restore();this.compose();return undefined}let A=0,v;for(v=0;v<c;++v){const e=t[v];if(typeof e==="number"){A+=u*e*i/1e3;continue}let h=false;const c=(e.isSpace?o:0)+r;const b=e.fontChar;const _=e.accent;let y,E;let w=e.width;if(d){const t=e.vmetric||p;const s=-(e.vmetric?t[1]:w*.5)*g;const i=t[2]*g;w=t?-t[0]:w;y=s/a;E=(A+i)/a}else{y=A/a;E=0}if(s.remeasure&&w>0){const t=n.measureText(b).width*1e3/i*a;if(w<t&&this.isFontSubpixelAAEnabled){const e=w/t;h=true;n.save();n.scale(e,1);y/=e}else if(w!==t){y+=(w-t)/2e3*i/a}}if(this.contentVisible&&(e.isInFont||s.missingFile)){if(f&&!_){n.fillText(b,y,E)}else{this.paintChar(b,y,E,m);if(_){const t=y+i*_.offset.x/a;const e=E-i*_.offset.y/a;this.paintChar(_.fontChar,t,e,m)}}}const x=d?w*g-c*l:w*g+c*l;A+=x;if(h){n.restore()}}if(d){e.y-=A}else{e.x+=A*h}n.restore();this.compose();return undefined}showType3Text(t){const e=this.ctx;const s=this.current;const i=s.font;const n=s.fontSize;const a=s.fontDirection;const r=i.vertical?1:-1;const o=s.charSpacing;const l=s.wordSpacing;const h=s.textHScale*a;const c=s.fontMatrix||FONT_IDENTITY_MATRIX;const d=t.length;const u=s.textRenderingMode===TextRenderingMode.INVISIBLE;let p,g,f,m;if(u||n===0){return}this._cachedScaleForStroking[0]=-1;this._cachedGetSinglePixelWidth=null;e.save();e.transform(...s.textMatrix);e.translate(s.x,s.y);e.scale(h,a);for(p=0;p<d;++p){g=t[p];if(typeof g==="number"){m=r*g*n/1e3;this.ctx.translate(m,0);s.x+=m*h;continue}const a=(g.isSpace?l:0)+o;const d=i.charProcOperatorList[g.operatorListId];if(!d){warn(`Type3 character "${g.operatorListId}" is not available.`);continue}if(this.contentVisible){this.processingType3=g;this.save();e.scale(n,n);e.transform(...c);this.executeOperatorList(d);this.restore()}const u=Util.applyTransform([g.width,0],c);f=u[0]*n+a;e.translate(f,0);s.x+=f*h}e.restore();this.processingType3=null}setCharWidth(t,e){}setCharWidthAndBounds(t,e,s,i,n,a){this.ctx.rect(s,i,n-s,a-i);this.ctx.clip();this.endPath()}getColorN_Pattern(t){let e;if(t[0]==="TilingPattern"){const s=t[1];const i=this.baseTransform||getCurrentTransform(this.ctx);const n={createCanvasGraphics:t=>new CanvasGraphics(t,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:this.optionalContentConfig,markedContentStack:this.markedContentStack})};e=new TilingPattern(t,s,this.ctx,n,i)}else{e=this._getPattern(t[1],t[2])}return e}setStrokeColorN(){this.current.strokeColor=this.getColorN_Pattern(arguments)}setFillColorN(){this.current.fillColor=this.getColorN_Pattern(arguments);this.current.patternFill=true}setStrokeRGBColor(t,e,s){const i=Util.makeHexColor(t,e,s);this.ctx.strokeStyle=i;this.current.strokeColor=i}setFillRGBColor(t,e,s){const i=Util.makeHexColor(t,e,s);this.ctx.fillStyle=i;this.current.fillColor=i;this.current.patternFill=false}_getPattern(t,e=null){let s;if(this.cachedPatterns.has(t)){s=this.cachedPatterns.get(t)}else{s=getShadingPattern(this.getObject(t));this.cachedPatterns.set(t,s)}if(e){s.matrix=e}return s}shadingFill(t){if(!this.contentVisible){return}const e=this.ctx;this.save();const s=this._getPattern(t);e.fillStyle=s.getPattern(e,this,getCurrentTransformInverse(e),PathType.SHADING);const i=getCurrentTransformInverse(e);if(i){const{width:t,height:s}=e.canvas;const[n,a,r,o]=Util.getAxialAlignedBoundingBox([0,0,t,s],i);this.ctx.fillRect(n,a,r-n,o-a)}else{this.ctx.fillRect(-1e10,-1e10,2e10,2e10)}this.compose(this.current.getClippedPathBoundingBox());this.restore()}beginInlineImage(){unreachable("Should not call beginInlineImage")}beginImageData(){unreachable("Should not call beginImageData")}paintFormXObjectBegin(t,e){if(!this.contentVisible){return}this.save();this.baseTransformStack.push(this.baseTransform);if(t){this.transform(...t)}this.baseTransform=getCurrentTransform(this.ctx);if(e){const t=e[2]-e[0];const s=e[3]-e[1];this.ctx.rect(e[0],e[1],t,s);this.current.updateRectMinMax(getCurrentTransform(this.ctx),e);this.clip();this.endPath()}}paintFormXObjectEnd(){if(!this.contentVisible){return}this.restore();this.baseTransform=this.baseTransformStack.pop()}beginGroup(t){if(!this.contentVisible){return}this.save();if(this.inSMaskMode){this.endSMaskMode();this.current.activeSMask=null}const e=this.ctx;if(!t.isolated){info("TODO: Support non-isolated groups.")}if(t.knockout){warn("Knockout groups not supported.")}const s=getCurrentTransform(e);if(t.matrix){e.transform(...t.matrix)}if(!t.bbox){throw new Error("Bounding box is required.")}let i=Util.getAxialAlignedBoundingBox(t.bbox,getCurrentTransform(e));const n=[0,0,e.canvas.width,e.canvas.height];i=Util.intersect(i,n)||[0,0,0,0];const a=Math.floor(i[0]);const r=Math.floor(i[1]);const o=Math.max(Math.ceil(i[2])-a,1);const l=Math.max(Math.ceil(i[3])-r,1);this.current.startNewPathAndClipBox([0,0,o,l]);let h="groupAt"+this.groupLevel;if(t.smask){h+="_smask_"+this.smaskCounter++%2}const c=this.cachedCanvases.getCanvas(h,o,l);const d=c.context;d.translate(-a,-r);d.transform(...s);if(t.smask){this.smaskStack.push({canvas:c.canvas,context:d,offsetX:a,offsetY:r,subtype:t.smask.subtype,backdrop:t.smask.backdrop,transferMap:t.smask.transferMap||null,startTransformInverse:null})}else{e.setTransform(1,0,0,1,0,0);e.translate(a,r);e.save()}copyCtxState(e,d);this.ctx=d;this.setGState([["BM","source-over"],["ca",1],["CA",1]]);this.groupStack.push(e);this.groupLevel++}endGroup(t){if(!this.contentVisible){return}this.groupLevel--;const e=this.ctx;const s=this.groupStack.pop();this.ctx=s;this.ctx.imageSmoothingEnabled=false;if(t.smask){this.tempSMask=this.smaskStack.pop();this.restore()}else{this.ctx.restore();const t=getCurrentTransform(this.ctx);this.restore();this.ctx.save();this.ctx.setTransform(...t);const s=Util.getAxialAlignedBoundingBox([0,0,e.canvas.width,e.canvas.height],t);this.ctx.drawImage(e.canvas,0,0);this.ctx.restore();this.compose(s)}}beginAnnotation(t,e,s,i,n){this.#$e();resetCtxToDefault(this.ctx);this.ctx.save();this.save();if(this.baseTransform){this.ctx.setTransform(...this.baseTransform)}if(e){const i=e[2]-e[0];const a=e[3]-e[1];if(n&&this.annotationCanvasMap){s=s.slice();s[4]-=e[0];s[5]-=e[1];e=e.slice();e[0]=e[1]=0;e[2]=i;e[3]=a;const[n,r]=Util.singularValueDecompose2dScale(getCurrentTransform(this.ctx));const{viewportScale:o}=this;const l=Math.ceil(i*this.outputScaleX*o);const h=Math.ceil(a*this.outputScaleY*o);this.annotationCanvas=this.canvasFactory.create(l,h);const{canvas:c,context:d}=this.annotationCanvas;this.annotationCanvasMap.set(t,c);this.annotationCanvas.savedCtx=this.ctx;this.ctx=d;this.ctx.save();this.ctx.setTransform(n,0,0,-r,0,a*r);resetCtxToDefault(this.ctx)}else{resetCtxToDefault(this.ctx);this.ctx.rect(e[0],e[1],i,a);this.ctx.clip();this.endPath()}}this.current=new CanvasExtraState(this.ctx.canvas.width,this.ctx.canvas.height);this.transform(...s);this.transform(...i)}endAnnotation(){if(this.annotationCanvas){this.ctx.restore();this.#Ke();this.ctx=this.annotationCanvas.savedCtx;delete this.annotationCanvas.savedCtx;delete this.annotationCanvas}}paintImageMaskXObject(t){if(!this.contentVisible){return}const e=t.count;t=this.getObject(t.data,t);t.count=e;const s=this.ctx;const i=this.processingType3;if(i){if(i.compiled===undefined){i.compiled=compileType3Glyph(t)}if(i.compiled){i.compiled(s);return}}const n=this._createMaskCanvas(t);const a=n.canvas;s.save();s.setTransform(1,0,0,1,0,0);s.drawImage(a,n.offsetX,n.offsetY);s.restore();this.compose()}paintImageMaskXObjectRepeat(t,e,s=0,i=0,n,a){if(!this.contentVisible){return}t=this.getObject(t.data,t);const r=this.ctx;r.save();const o=getCurrentTransform(r);r.transform(e,s,i,n,0,0);const l=this._createMaskCanvas(t);r.setTransform(1,0,0,1,l.offsetX-o[4],l.offsetY-o[5]);for(let t=0,h=a.length;t<h;t+=2){const h=Util.transform(o,[e,s,i,n,a[t],a[t+1]]);const[c,d]=Util.applyTransform([0,0],h);r.drawImage(l.canvas,c,d)}r.restore();this.compose()}paintImageMaskXObjectGroup(t){if(!this.contentVisible){return}const e=this.ctx;const s=this.current.fillColor;const i=this.current.patternFill;for(const n of t){const{data:t,width:a,height:r,transform:o}=n;const l=this.cachedCanvases.getCanvas("maskCanvas",a,r);const h=l.context;h.save();const c=this.getObject(t,n);putBinaryImageMask(h,c);h.globalCompositeOperation="source-in";h.fillStyle=i?s.getPattern(h,this,getCurrentTransformInverse(e),PathType.FILL):s;h.fillRect(0,0,a,r);h.restore();e.save();e.transform(...o);e.scale(1,-1);drawImageAtIntegerCoords(e,l.canvas,0,0,a,r,0,-1,1,1);e.restore()}this.compose()}paintImageXObject(t){if(!this.contentVisible){return}const e=this.getObject(t);if(!e){warn("Dependent image isn't ready yet");return}this.paintInlineImageXObject(e)}paintImageXObjectRepeat(t,e,s,i){if(!this.contentVisible){return}const n=this.getObject(t);if(!n){warn("Dependent image isn't ready yet");return}const a=n.width;const r=n.height;const o=[];for(let t=0,n=i.length;t<n;t+=2){o.push({transform:[e,0,0,s,i[t],i[t+1]],x:0,y:0,w:a,h:r})}this.paintInlineImageXObjectGroup(n,o)}applyTransferMapsToCanvas(t){if(this.current.transferMaps!=="none"){t.filter=this.current.transferMaps;t.drawImage(t.canvas,0,0);t.filter="none"}return t.canvas}applyTransferMapsToBitmap(t){if(this.current.transferMaps==="none"){return t.bitmap}const{bitmap:e,width:s,height:i}=t;const n=this.cachedCanvases.getCanvas("inlineImage",s,i);const a=n.context;a.filter=this.current.transferMaps;a.drawImage(e,0,0);a.filter="none";return n.canvas}paintInlineImageXObject(t){if(!this.contentVisible){return}const e=t.width;const s=t.height;const i=this.ctx;this.save();if(!isNodeJS){const{filter:t}=i;if(t!=="none"&&t!==""){i.filter="none"}}i.scale(1/e,-1/s);let n;if(t.bitmap){n=this.applyTransferMapsToBitmap(t)}else if(typeof HTMLElement==="function"&&t instanceof HTMLElement||!t.data){n=t}else{const i=this.cachedCanvases.getCanvas("inlineImage",e,s);const a=i.context;putBinaryImageData(a,t);n=this.applyTransferMapsToCanvas(a)}const a=this._scaleImage(n,getCurrentTransformInverse(i));i.imageSmoothingEnabled=getImageSmoothingEnabled(getCurrentTransform(i),t.interpolate);drawImageAtIntegerCoords(i,a.img,0,0,a.paintWidth,a.paintHeight,0,-s,e,s);this.compose();this.restore()}paintInlineImageXObjectGroup(t,e){if(!this.contentVisible){return}const s=this.ctx;let i;if(t.bitmap){i=t.bitmap}else{const e=t.width;const s=t.height;const n=this.cachedCanvases.getCanvas("inlineImage",e,s);const a=n.context;putBinaryImageData(a,t);i=this.applyTransferMapsToCanvas(a)}for(const t of e){s.save();s.transform(...t.transform);s.scale(1,-1);drawImageAtIntegerCoords(s,i,t.x,t.y,t.w,t.h,0,-1,1,1);s.restore()}this.compose()}paintSolidColorImageMask(){if(!this.contentVisible){return}this.ctx.fillRect(0,0,1,1);this.compose()}markPoint(t){}markPointProps(t,e){}beginMarkedContent(t){this.markedContentStack.push({visible:true})}beginMarkedContentProps(t,e){if(t==="OC"){this.markedContentStack.push({visible:this.optionalContentConfig.isVisible(e)})}else{this.markedContentStack.push({visible:true})}this.contentVisible=this.isContentVisible()}endMarkedContent(){this.markedContentStack.pop();this.contentVisible=this.isContentVisible()}beginCompat(){}endCompat(){}consumePath(t){const e=this.current.isEmptyClip();if(this.pendingClip){this.current.updateClipFromPath()}if(!this.pendingClip){this.compose(t)}const s=this.ctx;if(this.pendingClip){if(!e){if(this.pendingClip===EO_CLIP){s.clip("evenodd")}else{s.clip()}}this.pendingClip=null}this.current.startNewPathAndClipBox(this.current.clipBox);s.beginPath()}getSinglePixelWidth(){if(!this._cachedGetSinglePixelWidth){const t=getCurrentTransform(this.ctx);if(t[1]===0&&t[2]===0){this._cachedGetSinglePixelWidth=1/Math.min(Math.abs(t[0]),Math.abs(t[3]))}else{const e=Math.abs(t[0]*t[3]-t[2]*t[1]);const s=Math.hypot(t[0],t[2]);const i=Math.hypot(t[1],t[3]);this._cachedGetSinglePixelWidth=Math.max(s,i)/e}}return this._cachedGetSinglePixelWidth}getScaleForStroking(){if(this._cachedScaleForStroking[0]===-1){const{lineWidth:t}=this.current;const{a:e,b:s,c:i,d:n}=this.ctx.getTransform();let a,r;if(s===0&&i===0){const s=Math.abs(e);const i=Math.abs(n);if(s===i){if(t===0){a=r=1/s}else{const e=s*t;a=r=e<1?1/e:1}}else if(t===0){a=1/s;r=1/i}else{const e=s*t;const n=i*t;a=e<1?1/e:1;r=n<1?1/n:1}}else{const o=Math.abs(e*n-s*i);const l=Math.hypot(e,s);const h=Math.hypot(i,n);if(t===0){a=h/o;r=l/o}else{const e=t*o;a=h>e?h/e:1;r=l>e?l/e:1}}this._cachedScaleForStroking[0]=a;this._cachedScaleForStroking[1]=r}return this._cachedScaleForStroking}rescaleAndStroke(t){const{ctx:e}=this;const{lineWidth:s}=this.current;const[i,n]=this.getScaleForStroking();e.lineWidth=s||1;if(i===1&&n===1){e.stroke();return}const a=e.getLineDash();if(t){e.save()}e.scale(i,n);if(a.length>0){const t=Math.max(i,n);e.setLineDash(a.map(e=>e/t));e.lineDashOffset/=t}e.stroke();if(t){e.restore()}}isContentVisible(){for(let t=this.markedContentStack.length-1;t>=0;t--){if(!this.markedContentStack[t].visible){return false}}return true}}for(const t in OPS){if(CanvasGraphics.prototype[t]!==undefined){CanvasGraphics.prototype[OPS[t]]=CanvasGraphics.prototype[t]}}class GlobalWorkerOptions{static#qe=null;static#Xe="";static get workerPort(){return this.#qe}static set workerPort(t){if(!(typeof Worker!=="undefined"&&t instanceof Worker)&&t!==null){throw new Error("Invalid `workerPort` type.")}this.#qe=t}static get workerSrc(){return this.#Xe}static set workerSrc(t){if(typeof t!=="string"){throw new Error("Invalid `workerSrc` type.")}this.#Xe=t}}const CallbackKind={UNKNOWN:0,DATA:1,ERROR:2};const StreamKind={UNKNOWN:0,CANCEL:1,CANCEL_COMPLETE:2,CLOSE:3,ENQUEUE:4,ERROR:5,PULL:6,PULL_COMPLETE:7,START_COMPLETE:8};function wrapReason(t){if(!(t instanceof Error||typeof t==="object"&&t!==null)){unreachable('wrapReason: Expected "reason" to be a (possibly cloned) Error.')}switch(t.name){case"AbortException":return new AbortException(t.message);case"MissingPDFException":return new MissingPDFException(t.message);case"PasswordException":return new PasswordException(t.message,t.code);case"UnexpectedResponseException":return new UnexpectedResponseException(t.message,t.status);case"UnknownErrorException":return new UnknownErrorException(t.message,t.details);default:return new UnknownErrorException(t.message,t.toString())}}class MessageHandler{constructor(t,e,s){this.sourceName=t;this.targetName=e;this.comObj=s;this.callbackId=1;this.streamId=1;this.streamSinks=Object.create(null);this.streamControllers=Object.create(null);this.callbackCapabilities=Object.create(null);this.actionHandler=Object.create(null);this._onComObjOnMessage=t=>{const e=t.data;if(e.targetName!==this.sourceName){return}if(e.stream){this.#Ye(e);return}if(e.callback){const t=e.callbackId;const s=this.callbackCapabilities[t];if(!s){throw new Error(`Cannot resolve callback ${t}`)}delete this.callbackCapabilities[t];if(e.callback===CallbackKind.DATA){s.resolve(e.data)}else if(e.callback===CallbackKind.ERROR){s.reject(wrapReason(e.reason))}else{throw new Error("Unexpected callback case")}return}const i=this.actionHandler[e.action];if(!i){throw new Error(`Unknown action from worker: ${e.action}`)}if(e.callbackId){const t=this.sourceName;const n=e.sourceName;new Promise(function(t){t(i(e.data))}).then(function(i){s.postMessage({sourceName:t,targetName:n,callback:CallbackKind.DATA,callbackId:e.callbackId,data:i})},function(i){s.postMessage({sourceName:t,targetName:n,callback:CallbackKind.ERROR,callbackId:e.callbackId,reason:wrapReason(i)})});return}if(e.streamId){this.#Je(e);return}i(e.data)};s.addEventListener("message",this._onComObjOnMessage)}on(t,e){const s=this.actionHandler;if(s[t]){throw new Error(`There is already an actionName called "${t}"`)}s[t]=e}send(t,e,s){this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,data:e},s)}sendWithPromise(t,e,s){const i=this.callbackId++;const n=Promise.withResolvers();this.callbackCapabilities[i]=n;try{this.comObj.postMessage({sourceName:this.sourceName,targetName:this.targetName,action:t,callbackId:i,data:e},s)}catch(t){n.reject(t)}return n.promise}sendWithStream(t,e,s,i){const n=this.streamId++,a=this.sourceName,r=this.targetName,o=this.comObj;return new ReadableStream({start:s=>{const l=Promise.withResolvers();this.streamControllers[n]={controller:s,startCall:l,pullCall:null,cancelCall:null,isClosed:false};o.postMessage({sourceName:a,targetName:r,action:t,streamId:n,data:e,desiredSize:s.desiredSize},i);return l.promise},pull:t=>{const e=Promise.withResolvers();this.streamControllers[n].pullCall=e;o.postMessage({sourceName:a,targetName:r,stream:StreamKind.PULL,streamId:n,desiredSize:t.desiredSize});return e.promise},cancel:t=>{assert(t instanceof Error,"cancel must have a valid reason");const e=Promise.withResolvers();this.streamControllers[n].cancelCall=e;this.streamControllers[n].isClosed=true;o.postMessage({sourceName:a,targetName:r,stream:StreamKind.CANCEL,streamId:n,reason:wrapReason(t)});return e.promise}},s)}#Je(t){const e=t.streamId,s=this.sourceName,i=t.sourceName,n=this.comObj;const a=this,r=this.actionHandler[t.action];const o={enqueue(t,a=1,r){if(this.isCancelled){return}const o=this.desiredSize;this.desiredSize-=a;if(o>0&&this.desiredSize<=0){this.sinkCapability=Promise.withResolvers();this.ready=this.sinkCapability.promise}n.postMessage({sourceName:s,targetName:i,stream:StreamKind.ENQUEUE,streamId:e,chunk:t},r)},close(){if(this.isCancelled){return}this.isCancelled=true;n.postMessage({sourceName:s,targetName:i,stream:StreamKind.CLOSE,streamId:e});delete a.streamSinks[e]},error(t){assert(t instanceof Error,"error must have a valid reason");if(this.isCancelled){return}this.isCancelled=true;n.postMessage({sourceName:s,targetName:i,stream:StreamKind.ERROR,streamId:e,reason:wrapReason(t)})},sinkCapability:Promise.withResolvers(),onPull:null,onCancel:null,isCancelled:false,desiredSize:t.desiredSize,ready:null};o.sinkCapability.resolve();o.ready=o.sinkCapability.promise;this.streamSinks[e]=o;new Promise(function(e){e(r(t.data,o))}).then(function(){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.START_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.START_COMPLETE,streamId:e,reason:wrapReason(t)})})}#Ye(t){const e=t.streamId,s=this.sourceName,i=t.sourceName,n=this.comObj;const a=this.streamControllers[e],r=this.streamSinks[e];switch(t.stream){case StreamKind.START_COMPLETE:if(t.success){a.startCall.resolve()}else{a.startCall.reject(wrapReason(t.reason))}break;case StreamKind.PULL_COMPLETE:if(t.success){a.pullCall.resolve()}else{a.pullCall.reject(wrapReason(t.reason))}break;case StreamKind.PULL:if(!r){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:e,success:true});break}if(r.desiredSize<=0&&t.desiredSize>0){r.sinkCapability.resolve()}r.desiredSize=t.desiredSize;new Promise(function(t){t(r.onPull?.())}).then(function(){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.PULL_COMPLETE,streamId:e,reason:wrapReason(t)})});break;case StreamKind.ENQUEUE:assert(a,"enqueue should have stream controller");if(a.isClosed){break}a.controller.enqueue(t.chunk);break;case StreamKind.CLOSE:assert(a,"close should have stream controller");if(a.isClosed){break}a.isClosed=true;a.controller.close();this.#Qe(a,e);break;case StreamKind.ERROR:assert(a,"error should have stream controller");a.controller.error(wrapReason(t.reason));this.#Qe(a,e);break;case StreamKind.CANCEL_COMPLETE:if(t.success){a.cancelCall.resolve()}else{a.cancelCall.reject(wrapReason(t.reason))}this.#Qe(a,e);break;case StreamKind.CANCEL:if(!r){break}new Promise(function(e){e(r.onCancel?.(wrapReason(t.reason)))}).then(function(){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.CANCEL_COMPLETE,streamId:e,success:true})},function(t){n.postMessage({sourceName:s,targetName:i,stream:StreamKind.CANCEL_COMPLETE,streamId:e,reason:wrapReason(t)})});r.sinkCapability.reject(wrapReason(t.reason));r.isCancelled=true;delete this.streamSinks[e];break;default:throw new Error("Unexpected stream case")}}async#Qe(t,e){await Promise.allSettled([t.startCall?.promise,t.pullCall?.promise,t.cancelCall?.promise]);delete this.streamControllers[e]}destroy(){this.comObj.removeEventListener("message",this._onComObjOnMessage)}}class Metadata{#Ze;#ts;constructor({parsedData:t,rawData:e}){this.#Ze=t;this.#ts=e}getRaw(){return this.#ts}get(t){return this.#Ze.get(t)??null}getAll(){return objectFromMap(this.#Ze)}has(t){return this.#Ze.has(t)}}const INTERNAL=Symbol("INTERNAL");class OptionalContentGroup{#es=false;#ss=false;#is=false;#ns=true;constructor(t,{name:e,intent:s,usage:i}){this.#es=!!(t&RenderingIntentFlag.DISPLAY);this.#ss=!!(t&RenderingIntentFlag.PRINT);this.name=e;this.intent=s;this.usage=i}get visible(){if(this.#is){return this.#ns}if(!this.#ns){return false}const{print:t,view:e}=this.usage;if(this.#es){return e?.viewState!=="OFF"}else if(this.#ss){return t?.printState!=="OFF"}return true}_setVisible(t,e,s=false){if(t!==INTERNAL){unreachable("Internal method `_setVisible` called.")}this.#is=s;this.#ns=e}}class OptionalContentConfig{#as=null;#rs=new Map;#os=null;#ls=null;constructor(t,e=RenderingIntentFlag.DISPLAY){this.renderingIntent=e;this.name=null;this.creator=null;if(t===null){return}this.name=t.name;this.creator=t.creator;this.#ls=t.order;for(const s of t.groups){this.#rs.set(s.id,new OptionalContentGroup(e,s))}if(t.baseState==="OFF"){for(const t of this.#rs.values()){t._setVisible(INTERNAL,false)}}for(const e of t.on){this.#rs.get(e)._setVisible(INTERNAL,true)}for(const e of t.off){this.#rs.get(e)._setVisible(INTERNAL,false)}this.#os=this.getHash()}#hs(t){const e=t.length;if(e<2){return true}const s=t[0];for(let i=1;i<e;i++){const e=t[i];let n;if(Array.isArray(e)){n=this.#hs(e)}else if(this.#rs.has(e)){n=this.#rs.get(e).visible}else{warn(`Optional content group not found: ${e}`);return true}switch(s){case"And":if(!n){return false}break;case"Or":if(n){return true}break;case"Not":return!n;default:return true}}return s==="And"}isVisible(t){if(this.#rs.size===0){return true}if(!t){info("Optional content group not defined.");return true}if(t.type==="OCG"){if(!this.#rs.has(t.id)){warn(`Optional content group not found: ${t.id}`);return true}return this.#rs.get(t.id).visible}else if(t.type==="OCMD"){if(t.expression){return this.#hs(t.expression)}if(!t.policy||t.policy==="AnyOn"){for(const e of t.ids){if(!this.#rs.has(e)){warn(`Optional content group not found: ${e}`);return true}if(this.#rs.get(e).visible){return true}}return false}else if(t.policy==="AllOn"){for(const e of t.ids){if(!this.#rs.has(e)){warn(`Optional content group not found: ${e}`);return true}if(!this.#rs.get(e).visible){return false}}return true}else if(t.policy==="AnyOff"){for(const e of t.ids){if(!this.#rs.has(e)){warn(`Optional content group not found: ${e}`);return true}if(!this.#rs.get(e).visible){return true}}return false}else if(t.policy==="AllOff"){for(const e of t.ids){if(!this.#rs.has(e)){warn(`Optional content group not found: ${e}`);return true}if(this.#rs.get(e).visible){return false}}return true}warn(`Unknown optional content policy ${t.policy}.`);return true}warn(`Unknown group type ${t.type}.`);return true}setVisibility(t,e=true){const s=this.#rs.get(t);if(!s){warn(`Optional content group not found: ${t}`);return}s._setVisible(INTERNAL,!!e,true);this.#as=null}setOCGState({state:t,preserveRB:e}){let s;for(const e of t){switch(e){case"ON":case"OFF":case"Toggle":s=e;continue}const t=this.#rs.get(e);if(!t){continue}switch(s){case"ON":t._setVisible(INTERNAL,true);break;case"OFF":t._setVisible(INTERNAL,false);break;case"Toggle":t._setVisible(INTERNAL,!t.visible);break}}this.#as=null}get hasInitialVisibility(){return this.#os===null||this.getHash()===this.#os}getOrder(){if(!this.#rs.size){return null}if(this.#ls){return this.#ls.slice()}return[...this.#rs.keys()]}getGroups(){return this.#rs.size>0?objectFromMap(this.#rs):null}getGroup(t){return this.#rs.get(t)||null}getHash(){if(this.#as!==null){return this.#as}const t=new MurmurHash3_64;for(const[e,s]of this.#rs){t.update(`${e}:${s.visible}`)}return this.#as=t.hexdigest()}}class PDFDataTransportStream{constructor(t,{disableRange:e=false,disableStream:s=false}){assert(t,'PDFDataTransportStream - missing required "pdfDataRangeTransport" argument.');const{length:i,initialData:n,progressiveDone:a,contentDispositionFilename:r}=t;this._queuedChunks=[];this._progressiveDone=a;this._contentDispositionFilename=r;if(n?.length>0){const t=n instanceof Uint8Array&&n.byteLength===n.buffer.byteLength?n.buffer:new Uint8Array(n).buffer;this._queuedChunks.push(t)}this._pdfDataRangeTransport=t;this._isStreamingSupported=!s;this._isRangeSupported=!e;this._contentLength=i;this._fullRequestReader=null;this._rangeReaders=[];t.addRangeListener((t,e)=>{this._onReceiveData({begin:t,chunk:e})});t.addProgressListener((t,e)=>{this._onProgress({loaded:t,total:e})});t.addProgressiveReadListener(t=>{this._onReceiveData({chunk:t})});t.addProgressiveDoneListener(()=>{this._onProgressiveDone()});t.transportReady()}_onReceiveData({begin:t,chunk:e}){const s=e instanceof Uint8Array&&e.byteLength===e.buffer.byteLength?e.buffer:new Uint8Array(e).buffer;if(t===undefined){if(this._fullRequestReader){this._fullRequestReader._enqueue(s)}else{this._queuedChunks.push(s)}}else{const e=this._rangeReaders.some(function(e){if(e._begin!==t){return false}e._enqueue(s);return true});assert(e,"_onReceiveData - no `PDFDataTransportStreamRangeReader` instance found.")}}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}_onProgress(t){if(t.total===undefined){this._rangeReaders[0]?.onProgress?.({loaded:t.loaded})}else{this._fullRequestReader?.onProgress?.({loaded:t.loaded,total:t.total})}}_onProgressiveDone(){this._fullRequestReader?.progressiveDone();this._progressiveDone=true}_removeRangeReader(t){const e=this._rangeReaders.indexOf(t);if(e>=0){this._rangeReaders.splice(e,1)}}getFullReader(){assert(!this._fullRequestReader,"PDFDataTransportStream.getFullReader can only be called once.");const t=this._queuedChunks;this._queuedChunks=null;return new PDFDataTransportStreamReader(this,t,this._progressiveDone,this._contentDispositionFilename)}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const s=new PDFDataTransportStreamRangeReader(this,t,e);this._pdfDataRangeTransport.requestDataRange(t,e);this._rangeReaders.push(s);return s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeReaders.slice(0)){e.cancel(t)}this._pdfDataRangeTransport.abort()}}class PDFDataTransportStreamReader{constructor(t,e,s=false,i=null){this._stream=t;this._done=s||false;this._filename=isPdfFile(i)?i:null;this._queuedChunks=e||[];this._loaded=0;for(const t of this._queuedChunks){this._loaded+=t.byteLength}this._requests=[];this._headersReady=Promise.resolve();t._fullRequestReader=this;this.onProgress=null}_enqueue(t){if(this._done){return}if(this._requests.length>0){const e=this._requests.shift();e.resolve({value:t,done:false})}else{this._queuedChunks.push(t)}this._loaded+=t.byteLength}get headersReady(){return this._headersReady}get filename(){return this._filename}get isRangeSupported(){return this._stream._isRangeSupported}get isStreamingSupported(){return this._stream._isStreamingSupported}get contentLength(){return this._stream._contentLength}async read(){if(this._queuedChunks.length>0){const t=this._queuedChunks.shift();return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}progressiveDone(){if(this._done){return}this._done=true}}class PDFDataTransportStreamRangeReader{constructor(t,e,s){this._stream=t;this._begin=e;this._end=s;this._queuedChunk=null;this._requests=[];this._done=false;this.onProgress=null}_enqueue(t){if(this._done){return}if(this._requests.length===0){this._queuedChunk=t}else{const e=this._requests.shift();e.resolve({value:t,done:false});for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}this._done=true;this._stream._removeRangeReader(this)}get isStreamingSupported(){return false}async read(){if(this._queuedChunk){const t=this._queuedChunk;this._queuedChunk=null;return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;this._stream._removeRangeReader(this)}}function getFilenameFromContentDispositionHeader(t){let e=true;let s=i("filename\\*","i").exec(t);if(s){s=s[1];let t=o(s);t=unescape(t);t=l(t);t=h(t);return a(t)}s=r(t);if(s){const t=h(s);return a(t)}s=i("filename","i").exec(t);if(s){s=s[1];let t=o(s);t=h(t);return a(t)}function i(t,e){return new RegExp("(?:^|;)\\s*"+t+"\\s*=\\s*"+"("+'[^";\\s][^;\\s]*'+"|"+'"(?:[^"\\\\]|\\\\"?)+"?'+")",e)}function n(t,s){if(t){if(!/^[\x00-\xFF]+$/.test(s)){return s}try{const i=new TextDecoder(t,{fatal:true});const n=stringToBytes(s);s=i.decode(n);e=false}catch{}}return s}function a(t){if(e&&/[\x80-\xff]/.test(t)){t=n("utf-8",t);if(e){t=n("iso-8859-1",t)}}return t}function r(t){const e=[];let s;const n=i("filename\\*((?!0\\d)\\d+)(\\*?)","ig");while((s=n.exec(t))!==null){let[,t,i,n]=s;t=parseInt(t,10);if(t in e){if(t===0){break}continue}e[t]=[i,n]}const a=[];for(let t=0;t<e.length;++t){if(!(t in e)){break}let[s,i]=e[t];i=o(i);if(s){i=unescape(i);if(t===0){i=l(i)}}a.push(i)}return a.join("")}function o(t){if(t.startsWith('"')){const e=t.slice(1).split('\\"');for(let t=0;t<e.length;++t){const s=e[t].indexOf('"');if(s!==-1){e[t]=e[t].slice(0,s);e.length=t+1}e[t]=e[t].replaceAll(/\\(.)/g,"$1")}t=e.join('"')}return t}function l(t){const e=t.indexOf("'");if(e===-1){return t}const s=t.slice(0,e);const i=t.slice(e+1);const a=i.replace(/^[^']*'/,"");return n(s,a)}function h(t){if(!t.startsWith("=?")||/[\x00-\x19\x80-\xff]/.test(t)){return t}return t.replaceAll(/=\?([\w-]*)\?([QqBb])\?((?:[^?]|\?(?!=))*)\?=/g,function(t,e,s,i){if(s==="q"||s==="Q"){i=i.replaceAll("_"," ");i=i.replaceAll(/=([0-9a-fA-F]{2})/g,function(t,e){return String.fromCharCode(parseInt(e,16))});return n(e,i)}try{i=atob(i)}catch{}return n(e,i)})}return""}function validateRangeRequestCapabilities({getResponseHeader:t,isHttp:e,rangeChunkSize:s,disableRange:i}){const n={allowRangeRequests:false,suggestedLength:undefined};const a=parseInt(t("Content-Length"),10);if(!Number.isInteger(a)){return n}n.suggestedLength=a;if(a<=2*s){return n}if(i||!e){return n}if(t("Accept-Ranges")!=="bytes"){return n}const r=t("Content-Encoding")||"identity";if(r!=="identity"){return n}n.allowRangeRequests=true;return n}function extractFilenameFromHeader(t){const e=t("Content-Disposition");if(e){let t=getFilenameFromContentDispositionHeader(e);if(t.includes("%")){try{t=decodeURIComponent(t)}catch{}}if(isPdfFile(t)){return t}}return null}function createResponseStatusError(t,e){if(t===404||t===0&&e.startsWith("file:")){return new MissingPDFException('Missing PDF "'+e+'".')}return new UnexpectedResponseException(`Unexpected server response (${t}) while retrieving PDF "${e}".`,t)}function validateResponseStatus(t){return t===200||t===206}function createFetchOptions(t,e,s){return{method:"GET",headers:t,signal:s.signal,mode:"cors",credentials:e?"include":"same-origin",redirect:"follow"}}function createHeaders(t){const e=new Headers;for(const s in t){const i=t[s];if(i===undefined){continue}e.append(s,i)}return e}function getArrayBuffer(t){if(t instanceof Uint8Array){return t.buffer}if(t instanceof ArrayBuffer){return t}warn(`getArrayBuffer - unexpected data format: ${t}`);return new Uint8Array(t).buffer}class PDFFetchStream{constructor(t){this.source=t;this.isHttp=/^https?:/i.test(t.url);this.httpHeaders=this.isHttp&&t.httpHeaders||{};this._fullRequestReader=null;this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){assert(!this._fullRequestReader,"PDFFetchStream.getFullReader can only be called once.");this._fullRequestReader=new PDFFetchStreamReader(this);return this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const s=new PDFFetchStreamRangeReader(this,t,e);this._rangeRequestReaders.push(s);return s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class PDFFetchStreamReader{constructor(t){this._stream=t;this._reader=null;this._loaded=0;this._filename=null;const e=t.source;this._withCredentials=e.withCredentials||false;this._contentLength=e.length;this._headersCapability=Promise.withResolvers();this._disableRange=e.disableRange||false;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._abortController=new AbortController;this._isStreamingSupported=!e.disableStream;this._isRangeSupported=!e.disableRange;this._headers=createHeaders(this._stream.httpHeaders);const s=e.url;fetch(s,createFetchOptions(this._headers,this._withCredentials,this._abortController)).then(t=>{if(!validateResponseStatus(t.status)){throw createResponseStatusError(t.status,s)}this._reader=t.body.getReader();this._headersCapability.resolve();const e=e=>t.headers.get(e);const{allowRangeRequests:i,suggestedLength:n}=validateRangeRequestCapabilities({getResponseHeader:e,isHttp:this._stream.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=i;this._contentLength=n||this._contentLength;this._filename=extractFilenameFromHeader(e);if(!this._isStreamingSupported&&this._isRangeSupported){this.cancel(new AbortException("Streaming is disabled."))}}).catch(this._headersCapability.reject);this.onProgress=null}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._headersCapability.promise;const{value:t,done:e}=await this._reader.read();if(e){return{value:t,done:e}}this._loaded+=t.byteLength;this.onProgress?.({loaded:this._loaded,total:this._contentLength});return{value:getArrayBuffer(t),done:false}}cancel(t){this._reader?.cancel(t);this._abortController.abort()}}class PDFFetchStreamRangeReader{constructor(t,e,s){this._stream=t;this._reader=null;this._loaded=0;const i=t.source;this._withCredentials=i.withCredentials||false;this._readCapability=Promise.withResolvers();this._isStreamingSupported=!i.disableStream;this._abortController=new AbortController;this._headers=createHeaders(this._stream.httpHeaders);this._headers.append("Range",`bytes=${e}-${s-1}`);const n=i.url;fetch(n,createFetchOptions(this._headers,this._withCredentials,this._abortController)).then(t=>{if(!validateResponseStatus(t.status)){throw createResponseStatusError(t.status,n)}this._readCapability.resolve();this._reader=t.body.getReader()}).catch(this._readCapability.reject);this.onProgress=null}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;const{value:t,done:e}=await this._reader.read();if(e){return{value:t,done:e}}this._loaded+=t.byteLength;this.onProgress?.({loaded:this._loaded});return{value:getArrayBuffer(t),done:false}}cancel(t){this._reader?.cancel(t);this._abortController.abort()}}const OK_RESPONSE=200;const PARTIAL_CONTENT_RESPONSE=206;function network_getArrayBuffer(t){const e=t.response;if(typeof e!=="string"){return e}return stringToBytes(e).buffer}class NetworkManager{constructor(t,e={}){this.url=t;this.isHttp=/^https?:/i.test(t);this.httpHeaders=this.isHttp&&e.httpHeaders||Object.create(null);this.withCredentials=e.withCredentials||false;this.currXhrId=0;this.pendingRequests=Object.create(null)}requestRange(t,e,s){const i={begin:t,end:e};for(const t in s){i[t]=s[t]}return this.request(i)}requestFull(t){return this.request(t)}request(t){const e=new XMLHttpRequest;const s=this.currXhrId++;const i=this.pendingRequests[s]={xhr:e};e.open("GET",this.url);e.withCredentials=this.withCredentials;for(const t in this.httpHeaders){const s=this.httpHeaders[t];if(s===undefined){continue}e.setRequestHeader(t,s)}if(this.isHttp&&"begin"in t&&"end"in t){e.setRequestHeader("Range",`bytes=${t.begin}-${t.end-1}`);i.expectedStatus=PARTIAL_CONTENT_RESPONSE}else{i.expectedStatus=OK_RESPONSE}e.responseType="arraybuffer";if(t.onError){e.onerror=function(s){t.onError(e.status)}}e.onreadystatechange=this.onStateChange.bind(this,s);e.onprogress=this.onProgress.bind(this,s);i.onHeadersReceived=t.onHeadersReceived;i.onDone=t.onDone;i.onError=t.onError;i.onProgress=t.onProgress;e.send(null);return s}onProgress(t,e){const s=this.pendingRequests[t];if(!s){return}s.onProgress?.(e)}onStateChange(t,e){const s=this.pendingRequests[t];if(!s){return}const i=s.xhr;if(i.readyState>=2&&s.onHeadersReceived){s.onHeadersReceived();delete s.onHeadersReceived}if(i.readyState!==4){return}if(!(t in this.pendingRequests)){return}delete this.pendingRequests[t];if(i.status===0&&this.isHttp){s.onError?.(i.status);return}const n=i.status||OK_RESPONSE;const a=n===OK_RESPONSE&&s.expectedStatus===PARTIAL_CONTENT_RESPONSE;if(!a&&n!==s.expectedStatus){s.onError?.(i.status);return}const r=network_getArrayBuffer(i);if(n===PARTIAL_CONTENT_RESPONSE){const t=i.getResponseHeader("Content-Range");const e=/bytes (\d+)-(\d+)\/(\d+)/.exec(t);s.onDone({begin:parseInt(e[1],10),chunk:r})}else if(r){s.onDone({begin:0,chunk:r})}else{s.onError?.(i.status)}}getRequestXhr(t){return this.pendingRequests[t].xhr}isPendingRequest(t){return t in this.pendingRequests}abortRequest(t){const e=this.pendingRequests[t].xhr;delete this.pendingRequests[t];e.abort()}}class PDFNetworkStream{constructor(t){this._source=t;this._manager=new NetworkManager(t.url,{httpHeaders:t.httpHeaders,withCredentials:t.withCredentials});this._rangeChunkSize=t.rangeChunkSize;this._fullRequestReader=null;this._rangeRequestReaders=[]}_onRangeRequestReaderClosed(t){const e=this._rangeRequestReaders.indexOf(t);if(e>=0){this._rangeRequestReaders.splice(e,1)}}getFullReader(){assert(!this._fullRequestReader,"PDFNetworkStream.getFullReader can only be called once.");this._fullRequestReader=new PDFNetworkStreamFullRequestReader(this._manager,this._source);return this._fullRequestReader}getRangeReader(t,e){const s=new PDFNetworkStreamRangeRequestReader(this._manager,t,e);s.onClosed=this._onRangeRequestReaderClosed.bind(this);this._rangeRequestReaders.push(s);return s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class PDFNetworkStreamFullRequestReader{constructor(t,e){this._manager=t;const s={onHeadersReceived:this._onHeadersReceived.bind(this),onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)};this._url=e.url;this._fullRequestId=t.requestFull(s);this._headersReceivedCapability=Promise.withResolvers();this._disableRange=e.disableRange||false;this._contentLength=e.length;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._isStreamingSupported=false;this._isRangeSupported=false;this._cachedChunks=[];this._requests=[];this._done=false;this._storedError=undefined;this._filename=null;this.onProgress=null}_onHeadersReceived(){const t=this._fullRequestId;const e=this._manager.getRequestXhr(t);const s=t=>e.getResponseHeader(t);const{allowRangeRequests:i,suggestedLength:n}=validateRangeRequestCapabilities({getResponseHeader:s,isHttp:this._manager.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});if(i){this._isRangeSupported=true}this._contentLength=n||this._contentLength;this._filename=extractFilenameFromHeader(s);if(this._isRangeSupported){this._manager.abortRequest(t)}this._headersReceivedCapability.resolve()}_onDone(t){if(t){if(this._requests.length>0){const e=this._requests.shift();e.resolve({value:t.chunk,done:false})}else{this._cachedChunks.push(t.chunk)}}this._done=true;if(this._cachedChunks.length>0){return}for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0}_onError(t){this._storedError=createResponseStatusError(t,this._url);this._headersReceivedCapability.reject(this._storedError);for(const t of this._requests){t.reject(this._storedError)}this._requests.length=0;this._cachedChunks.length=0}_onProgress(t){this.onProgress?.({loaded:t.loaded,total:t.lengthComputable?t.total:this._contentLength})}get filename(){return this._filename}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}get contentLength(){return this._contentLength}get headersReady(){return this._headersReceivedCapability.promise}async read(){if(this._storedError){throw this._storedError}if(this._cachedChunks.length>0){const t=this._cachedChunks.shift();return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;this._headersReceivedCapability.reject(t);for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;if(this._manager.isPendingRequest(this._fullRequestId)){this._manager.abortRequest(this._fullRequestId)}this._fullRequestReader=null}}class PDFNetworkStreamRangeRequestReader{constructor(t,e,s){this._manager=t;const i={onDone:this._onDone.bind(this),onError:this._onError.bind(this),onProgress:this._onProgress.bind(this)};this._url=t.url;this._requestId=t.requestRange(e,s,i);this._requests=[];this._queuedChunk=null;this._done=false;this._storedError=undefined;this.onProgress=null;this.onClosed=null}_close(){this.onClosed?.(this)}_onDone(t){const e=t.chunk;if(this._requests.length>0){const t=this._requests.shift();t.resolve({value:e,done:false})}else{this._queuedChunk=e}this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;this._close()}_onError(t){this._storedError=createResponseStatusError(t,this._url);for(const t of this._requests){t.reject(this._storedError)}this._requests.length=0;this._queuedChunk=null}_onProgress(t){if(!this.isStreamingSupported){this.onProgress?.({loaded:t.loaded})}}get isStreamingSupported(){return false}async read(){if(this._storedError){throw this._storedError}if(this._queuedChunk!==null){const t=this._queuedChunk;this._queuedChunk=null;return{value:t,done:false}}if(this._done){return{value:undefined,done:true}}const t=Promise.withResolvers();this._requests.push(t);return t.promise}cancel(t){this._done=true;for(const t of this._requests){t.resolve({value:undefined,done:true})}this._requests.length=0;if(this._manager.isPendingRequest(this._requestId)){this._manager.abortRequest(this._requestId)}this._close()}}const fileUriRegex=/^file:\/\/\/[a-zA-Z]:\//;function parseUrl(t){const e=NodePackages.get("url");const s=e.parse(t);if(s.protocol==="file:"||s.host){return s}if(/^[a-z]:[/\\]/i.test(t)){return e.parse(`file:///${t}`)}if(!s.host){s.protocol="file:"}return s}class PDFNodeStream{constructor(t){this.source=t;this.url=parseUrl(t.url);this.isHttp=this.url.protocol==="http:"||this.url.protocol==="https:";this.isFsUrl=this.url.protocol==="file:";this.httpHeaders=this.isHttp&&t.httpHeaders||{};this._fullRequestReader=null;this._rangeRequestReaders=[]}get _progressiveDataLength(){return this._fullRequestReader?._loaded??0}getFullReader(){assert(!this._fullRequestReader,"PDFNodeStream.getFullReader can only be called once.");this._fullRequestReader=this.isFsUrl?new PDFNodeStreamFsFullReader(this):new PDFNodeStreamFullReader(this);return this._fullRequestReader}getRangeReader(t,e){if(e<=this._progressiveDataLength){return null}const s=this.isFsUrl?new PDFNodeStreamFsRangeReader(this,t,e):new PDFNodeStreamRangeReader(this,t,e);this._rangeRequestReaders.push(s);return s}cancelAllRequests(t){this._fullRequestReader?.cancel(t);for(const e of this._rangeRequestReaders.slice(0)){e.cancel(t)}}}class BaseFullReader{constructor(t){this._url=t.url;this._done=false;this._storedError=null;this.onProgress=null;const e=t.source;this._contentLength=e.length;this._loaded=0;this._filename=null;this._disableRange=e.disableRange||false;this._rangeChunkSize=e.rangeChunkSize;if(!this._rangeChunkSize&&!this._disableRange){this._disableRange=true}this._isStreamingSupported=!e.disableStream;this._isRangeSupported=!e.disableRange;this._readableStream=null;this._readCapability=Promise.withResolvers();this._headersCapability=Promise.withResolvers()}get headersReady(){return this._headersCapability.promise}get filename(){return this._filename}get contentLength(){return this._contentLength}get isRangeSupported(){return this._isRangeSupported}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;if(this._done){return{value:undefined,done:true}}if(this._storedError){throw this._storedError}const t=this._readableStream.read();if(t===null){this._readCapability=Promise.withResolvers();return this.read()}this._loaded+=t.length;this.onProgress?.({loaded:this._loaded,total:this._contentLength});const e=new Uint8Array(t).buffer;return{value:e,done:false}}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t;this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t;t.on("readable",()=>{this._readCapability.resolve()});t.on("end",()=>{t.destroy();this._done=true;this._readCapability.resolve()});t.on("error",t=>{this._error(t)});if(!this._isStreamingSupported&&this._isRangeSupported){this._error(new AbortException("streaming is disabled"))}if(this._storedError){this._readableStream.destroy(this._storedError)}}}class BaseRangeReader{constructor(t){this._url=t.url;this._done=false;this._storedError=null;this.onProgress=null;this._loaded=0;this._readableStream=null;this._readCapability=Promise.withResolvers();const e=t.source;this._isStreamingSupported=!e.disableStream}get isStreamingSupported(){return this._isStreamingSupported}async read(){await this._readCapability.promise;if(this._done){return{value:undefined,done:true}}if(this._storedError){throw this._storedError}const t=this._readableStream.read();if(t===null){this._readCapability=Promise.withResolvers();return this.read()}this._loaded+=t.length;this.onProgress?.({loaded:this._loaded});const e=new Uint8Array(t).buffer;return{value:e,done:false}}cancel(t){if(!this._readableStream){this._error(t);return}this._readableStream.destroy(t)}_error(t){this._storedError=t;this._readCapability.resolve()}_setReadableStream(t){this._readableStream=t;t.on("readable",()=>{this._readCapability.resolve()});t.on("end",()=>{t.destroy();this._done=true;this._readCapability.resolve()});t.on("error",t=>{this._error(t)});if(this._storedError){this._readableStream.destroy(this._storedError)}}}function createRequestOptions(t,e){return{protocol:t.protocol,auth:t.auth,host:t.hostname,port:t.port,path:t.path,method:"GET",headers:e}}class PDFNodeStreamFullReader extends BaseFullReader{constructor(t){super(t);const e=e=>{if(e.statusCode===404){const t=new MissingPDFException(`Missing PDF "${this._url}".`);this._storedError=t;this._headersCapability.reject(t);return}this._headersCapability.resolve();this._setReadableStream(e);const s=t=>this._readableStream.headers[t.toLowerCase()];const{allowRangeRequests:i,suggestedLength:n}=validateRangeRequestCapabilities({getResponseHeader:s,isHttp:t.isHttp,rangeChunkSize:this._rangeChunkSize,disableRange:this._disableRange});this._isRangeSupported=i;this._contentLength=n||this._contentLength;this._filename=extractFilenameFromHeader(s)};this._request=null;if(this._url.protocol==="http:"){const s=NodePackages.get("http");this._request=s.request(createRequestOptions(this._url,t.httpHeaders),e)}else{const s=NodePackages.get("https");this._request=s.request(createRequestOptions(this._url,t.httpHeaders),e)}this._request.on("error",t=>{this._storedError=t;this._headersCapability.reject(t)});this._request.end()}}class PDFNodeStreamRangeReader extends BaseRangeReader{constructor(t,e,s){super(t);this._httpHeaders={};for(const e in t.httpHeaders){const s=t.httpHeaders[e];if(s===undefined){continue}this._httpHeaders[e]=s}this._httpHeaders.Range=`bytes=${e}-${s-1}`;const i=t=>{if(t.statusCode===404){const t=new MissingPDFException(`Missing PDF "${this._url}".`);this._storedError=t;return}this._setReadableStream(t)};this._request=null;if(this._url.protocol==="http:"){const t=NodePackages.get("http");this._request=t.request(createRequestOptions(this._url,this._httpHeaders),i)}else{const t=NodePackages.get("https");this._request=t.request(createRequestOptions(this._url,this._httpHeaders),i)}this._request.on("error",t=>{this._storedError=t});this._request.end()}}class PDFNodeStreamFsFullReader extends BaseFullReader{constructor(t){super(t);let e=decodeURIComponent(this._url.path);if(fileUriRegex.test(this._url.href)){e=e.replace(/^\//,"")}const s=NodePackages.get("fs");s.promises.lstat(e).then(t=>{this._contentLength=t.size;this._setReadableStream(s.createReadStream(e));this._headersCapability.resolve()},t=>{if(t.code==="ENOENT"){t=new MissingPDFException(`Missing PDF "${e}".`)}this._storedError=t;this._headersCapability.reject(t)})}}class PDFNodeStreamFsRangeReader extends BaseRangeReader{constructor(t,e,s){super(t);let i=decodeURIComponent(this._url.path);if(fileUriRegex.test(this._url.href)){i=i.replace(/^\//,"")}const n=NodePackages.get("fs");this._setReadableStream(n.createReadStream(i,{start:e,end:s-1}))}}const MAX_TEXT_DIVS_TO_RENDER=1e5;const DEFAULT_FONT_SIZE=30;const DEFAULT_FONT_ASCENT=.8;class TextLayer{#cs=Promise.withResolvers();#It=null;#ds=false;#us=!!globalThis.FontInspector?.enabled;#ps=null;#gs=null;#fs=0;#ms=0;#bs=null;#_s=null;#As=0;#vs=0;#ys=Object.create(null);#Es=[];#ws=null;#xs=[];#Ts=new WeakMap;#Ss=null;static#Cs=new Map;static#Ps=new Map;static#Ms=null;static#ks=new Set;constructor({textContentSource:t,container:e,viewport:s}){if(t instanceof ReadableStream){this.#ws=t}else if(typeof t==="object"){this.#ws=new ReadableStream({start(e){e.enqueue(t);e.close()}})}else{throw new Error('No "textContentSource" parameter specified.')}this.#It=this.#_s=e;this.#vs=s.scale*(globalThis.devicePixelRatio||1);this.#As=s.rotation;this.#gs={prevFontSize:null,prevFontFamily:null,div:null,properties:null,ctx:null};const{pageWidth:i,pageHeight:n,pageX:a,pageY:r}=s.rawDims;this.#Ss=[1,0,0,-1,-a,r+n];this.#ms=i;this.#fs=n;TextLayer.#Is();setLayerDimensions(e,s);this.#cs.promise.catch(()=>{}).then(()=>{TextLayer.#ks.delete(this);this.#gs=null;this.#ys=null})}render(){const t=()=>{this.#bs.read().then(({value:e,done:s})=>{if(s){this.#cs.resolve();return}this.#ps??=e.lang;Object.assign(this.#ys,e.styles);this.#Rs(e.items);t()},this.#cs.reject)};this.#bs=this.#ws.getReader();TextLayer.#ks.add(this);t();return this.#cs.promise}update({viewport:t,onBefore:e=null}){const s=t.scale*(globalThis.devicePixelRatio||1);const i=t.rotation;if(i!==this.#As){e?.();this.#As=i;setLayerDimensions(this.#_s,{rotation:i})}if(s!==this.#vs){e?.();this.#vs=s;const t={prevFontSize:null,prevFontFamily:null,div:null,properties:null,ctx:TextLayer.#Fs(this.#ps)};for(const e of this.#xs){t.properties=this.#Ts.get(e);t.div=e;this.#Ls(t)}}}cancel(){const t=new AbortException("TextLayer task cancelled.");this.#bs?.cancel(t).catch(()=>{});this.#bs=null;this.#cs.reject(t)}get textDivs(){return this.#xs}get textContentItemsStr(){return this.#Es}#Rs(t){if(this.#ds){return}this.#gs.ctx??=TextLayer.#Fs(this.#ps);const e=this.#xs,s=this.#Es;for(const i of t){if(e.length>MAX_TEXT_DIVS_TO_RENDER){warn("Ignoring additional textDivs for performance reasons.");this.#ds=true;return}if(i.str===undefined){if(i.type==="beginMarkedContentProps"||i.type==="beginMarkedContent"){const t=this.#It;this.#It=document.createElement("span");this.#It.classList.add("markedContent");if(i.id!==null){this.#It.setAttribute("id",`${i.id}`)}t.append(this.#It)}else if(i.type==="endMarkedContent"){this.#It=this.#It.parentNode}continue}s.push(i.str);this.#Ds(i)}}#Ds(t){const e=document.createElement("span");const s={angle:0,canvasWidth:0,hasText:t.str!=="",hasEOL:t.hasEOL,fontSize:0};this.#xs.push(e);const i=Util.transform(this.#Ss,t.transform);let n=Math.atan2(i[1],i[0]);const a=this.#ys[t.fontName];if(a.vertical){n+=Math.PI/2}const r=this.#us&&a.fontSubstitution||a.fontFamily;const o=Math.hypot(i[2],i[3]);const l=o*TextLayer.#Os(r,this.#ps);let h,c;if(n===0){h=i[4];c=i[5]-l}else{h=i[4]+l*Math.sin(n);c=i[5]-l*Math.cos(n)}const d="calc(var(--scale-factor)*";const u=e.style;if(this.#It===this.#_s){u.left=`${(100*h/this.#ms).toFixed(2)}%`;u.top=`${(100*c/this.#fs).toFixed(2)}%`}else{u.left=`${d}${h.toFixed(2)}px)`;u.top=`${d}${c.toFixed(2)}px)`}u.fontSize=`${d}${(TextLayer.#Ms*o).toFixed(2)}px)`;u.fontFamily=r;s.fontSize=o;e.setAttribute("role","presentation");e.textContent=t.str;e.dir=t.dir;if(this.#us){e.dataset.fontName=a.fontSubstitutionLoadedName||t.fontName}if(n!==0){s.angle=n*(180/Math.PI)}let p=false;if(t.str.length>1){p=true}else if(t.str!==" "&&t.transform[0]!==t.transform[3]){const e=Math.abs(t.transform[0]),s=Math.abs(t.transform[3]);if(e!==s&&Math.max(e,s)/Math.min(e,s)>1.5){p=true}}if(p){s.canvasWidth=a.vertical?t.height:t.width}this.#Ts.set(e,s);this.#gs.div=e;this.#gs.properties=s;this.#Ls(this.#gs);if(s.hasText){this.#It.append(e)}if(s.hasEOL){const t=document.createElement("br");t.setAttribute("role","presentation");this.#It.append(t)}}#Ls(t){const{div:e,properties:s,ctx:i,prevFontSize:n,prevFontFamily:a}=t;const{style:r}=e;let o="";if(TextLayer.#Ms>1){o=`scale(${1/TextLayer.#Ms})`}if(s.canvasWidth!==0&&s.hasText){const{fontFamily:l}=r;const{canvasWidth:h,fontSize:c}=s;if(n!==c||a!==l){i.font=`${c*this.#vs}px ${l}`;t.prevFontSize=c;t.prevFontFamily=l}const{width:d}=i.measureText(e.textContent);if(d>0){o=`scaleX(${h*this.#vs/d}) ${o}`}}if(s.angle!==0){o=`rotate(${s.angle}deg) ${o}`}if(o.length>0){r.transform=o}}static cleanup(){if(this.#ks.size>0){return}this.#Cs.clear();for(const{canvas:t}of this.#Ps.values()){t.remove()}this.#Ps.clear()}static#Fs(t=null){let e=this.#Ps.get(t||="");if(!e){const s=document.createElement("canvas");s.className="hiddenCanvasElement";s.lang=t;document.body.append(s);e=s.getContext("2d",{alpha:false,willReadFrequently:true});this.#Ps.set(t,e)}return e}static#Is(){if(this.#Ms!==null){return}const t=document.createElement("div");t.style.opacity=0;t.style.lineHeight=1;t.style.fontSize="1px";t.textContent="X";document.body.append(t);this.#Ms=t.getBoundingClientRect().height;t.remove()}static#Os(t,e){const s=this.#Cs.get(t);if(s){return s}const i=this.#Fs(e);const n=i.font;i.canvas.width=i.canvas.height=DEFAULT_FONT_SIZE;i.font=`${DEFAULT_FONT_SIZE}px ${t}`;const a=i.measureText("");let r=a.fontBoundingBoxAscent;let o=Math.abs(a.fontBoundingBoxDescent);if(r){const e=r/(r+o);this.#Cs.set(t,e);i.canvas.width=i.canvas.height=0;i.font=n;return e}i.strokeStyle="red";i.clearRect(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE);i.strokeText("g",0,0);let l=i.getImageData(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE).data;o=0;for(let t=l.length-1-3;t>=0;t-=4){if(l[t]>0){o=Math.ceil(t/4/DEFAULT_FONT_SIZE);break}}i.clearRect(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE);i.strokeText("A",0,DEFAULT_FONT_SIZE);l=i.getImageData(0,0,DEFAULT_FONT_SIZE,DEFAULT_FONT_SIZE).data;r=0;for(let t=0,e=l.length;t<e;t+=4){if(l[t]>0){r=DEFAULT_FONT_SIZE-Math.floor(t/4/DEFAULT_FONT_SIZE);break}}i.canvas.width=i.canvas.height=0;i.font=n;const h=r?r/(r+o):DEFAULT_FONT_ASCENT;this.#Cs.set(t,h);return h}}function renderTextLayer(){deprecated("`renderTextLayer`, please use `TextLayer` instead.");const{textContentSource:t,container:e,viewport:s,...i}=arguments[0];const n=Object.keys(i);if(n.length>0){warn("Ignoring `renderTextLayer` parameters: "+n.join(", "))}const a=new TextLayer({textContentSource:t,container:e,viewport:s});const{textDivs:r,textContentItemsStr:o}=a;const l=a.render();return{promise:l,textDivs:r,textContentItemsStr:o}}function updateTextLayer(){deprecated("`updateTextLayer`, please use `TextLayer` instead.")}class XfaText{static textContent(t){const e=[];const s={items:e,styles:Object.create(null)};function i(t){if(!t){return}let s=null;const n=t.name;if(n==="#text"){s=t.value}else if(!XfaText.shouldBuildText(n)){return}else if(t?.attributes?.textContent){s=t.attributes.textContent}else if(t.value){s=t.value}if(s!==null){e.push({str:s})}if(!t.children){return}for(const e of t.children){i(e)}}i(t);return s}static shouldBuildText(t){return!(t==="textarea"||t==="input"||t==="option"||t==="select")}}const DEFAULT_RANGE_CHUNK_SIZE=65536;const RENDERING_CANCELLED_TIMEOUT=100;const DELAYED_CLEANUP_TIMEOUT=5e3;const DefaultCanvasFactory=isNodeJS?NodeCanvasFactory:DOMCanvasFactory;const DefaultCMapReaderFactory=isNodeJS?NodeCMapReaderFactory:DOMCMapReaderFactory;const DefaultFilterFactory=isNodeJS?NodeFilterFactory:DOMFilterFactory;const DefaultStandardFontDataFactory=isNodeJS?NodeStandardFontDataFactory:DOMStandardFontDataFactory;function getDocument(t={}){if(typeof t==="string"||t instanceof URL){t={url:t}}else if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)){t={data:t}}const e=new PDFDocumentLoadingTask;const{docId:s}=e;const i=t.url?getUrlProp(t.url):null;const n=t.data?getDataProp(t.data):null;const a=t.httpHeaders||null;const r=t.withCredentials===true;const o=t.password??null;const l=t.range instanceof PDFDataRangeTransport?t.range:null;const h=Number.isInteger(t.rangeChunkSize)&&t.rangeChunkSize>0?t.rangeChunkSize:DEFAULT_RANGE_CHUNK_SIZE;let c=t.worker instanceof PDFWorker?t.worker:null;const d=t.verbosity;const u=typeof t.docBaseUrl==="string"&&!isDataScheme(t.docBaseUrl)?t.docBaseUrl:null;const p=typeof t.cMapUrl==="string"?t.cMapUrl:null;const g=t.cMapPacked!==false;const f=t.CMapReaderFactory||DefaultCMapReaderFactory;const m=typeof t.standardFontDataUrl==="string"?t.standardFontDataUrl:null;const b=t.StandardFontDataFactory||DefaultStandardFontDataFactory;const _=t.stopAtErrors!==true;const A=Number.isInteger(t.maxImageSize)&&t.maxImageSize>-1?t.maxImageSize:-1;const v=t.isEvalSupported!==false;const y=typeof t.isOffscreenCanvasSupported==="boolean"?t.isOffscreenCanvasSupported:!isNodeJS;const E=Number.isInteger(t.canvasMaxAreaInBytes)?t.canvasMaxAreaInBytes:-1;const w=typeof t.disableFontFace==="boolean"?t.disableFontFace:isNodeJS;const x=t.fontExtraProperties===true;const T=t.enableXfa===true;const S=t.ownerDocument||globalThis.document;const C=t.disableRange===true;const P=t.disableStream===true;const M=t.disableAutoFetch===true;const k=t.pdfBug===true;const I=t.enableHWA===true;const R=l?l.length:t.length??NaN;const F=typeof t.useSystemFonts==="boolean"?t.useSystemFonts:!isNodeJS&&!w;const L=typeof t.useWorkerFetch==="boolean"?t.useWorkerFetch:f===DOMCMapReaderFactory&&b===DOMStandardFontDataFactory&&p&&m&&isValidFetchUrl(p,document.baseURI)&&isValidFetchUrl(m,document.baseURI);const D=t.canvasFactory||new DefaultCanvasFactory({ownerDocument:S,enableHWA:I});const O=t.filterFactory||new DefaultFilterFactory({docId:s,ownerDocument:S});const N=null;setVerbosityLevel(d);const B={canvasFactory:D,filterFactory:O};if(!L){B.cMapReaderFactory=new f({baseUrl:p,isCompressed:g});B.standardFontDataFactory=new b({baseUrl:m})}if(!c){const t={verbosity:d,port:GlobalWorkerOptions.workerPort};c=t.port?PDFWorker.fromPort(t):new PDFWorker(t);e._worker=c}const H={docId:s,apiVersion:"4.4.168",data:n,password:o,disableAutoFetch:M,rangeChunkSize:h,length:R,docBaseUrl:u,enableXfa:T,evaluatorOptions:{maxImageSize:A,disableFontFace:w,ignoreErrors:_,isEvalSupported:v,isOffscreenCanvasSupported:y,canvasMaxAreaInBytes:E,fontExtraProperties:x,useSystemFonts:F,cMapUrl:L?p:null,standardFontDataUrl:L?m:null}};const U={disableFontFace:w,fontExtraProperties:x,ownerDocument:S,pdfBug:k,styleElement:N,loadingParams:{disableAutoFetch:M,enableXfa:T}};c.promise.then(function(){if(e.destroyed){throw new Error("Loading aborted")}if(c.destroyed){throw new Error("Worker was destroyed")}const t=c.messageHandler.sendWithPromise("GetDocRequest",H,n?[n.buffer]:null);let o;if(l){o=new PDFDataTransportStream(l,{disableRange:C,disableStream:P})}else if(!n){if(!i){throw new Error("getDocument - no `url` parameter provided.")}const t=t=>{if(isNodeJS){const e=function(){return typeof fetch!=="undefined"&&typeof Response!=="undefined"&&"body"in Response.prototype};return e()&&isValidFetchUrl(t.url)?new PDFFetchStream(t):new PDFNodeStream(t)}return isValidFetchUrl(t.url)?new PDFFetchStream(t):new PDFNetworkStream(t)};o=t({url:i,length:R,httpHeaders:a,withCredentials:r,rangeChunkSize:h,disableRange:C,disableStream:P})}return t.then(t=>{if(e.destroyed){throw new Error("Loading aborted")}if(c.destroyed){throw new Error("Worker was destroyed")}const i=new MessageHandler(s,t,c.port);const n=new WorkerTransport(i,e,o,U,B);e._transport=n;i.send("Ready",null)})}).catch(e._capability.reject);return e}function getUrlProp(t){if(t instanceof URL){return t.href}try{return new URL(t,window.location).href}catch{if(isNodeJS&&typeof t==="string"){return t}}throw new Error("Invalid PDF url data: "+"either string or URL-object is expected in the url property.")}function getDataProp(t){if(isNodeJS&&typeof Buffer!=="undefined"&&t instanceof Buffer){throw new Error("Please provide binary data as `Uint8Array`, rather than `Buffer`.")}if(t instanceof Uint8Array&&t.byteLength===t.buffer.byteLength){return t}if(typeof t==="string"){return stringToBytes(t)}if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)||typeof t==="object"&&!isNaN(t?.length)){return new Uint8Array(t)}throw new Error("Invalid PDF binary data: either TypedArray, "+"string, or array-like object is expected in the data property.")}function isRefProxy(t){return typeof t==="object"&&Number.isInteger(t?.num)&&t.num>=0&&Number.isInteger(t?.gen)&&t.gen>=0}class PDFDocumentLoadingTask{static#a=0;constructor(){this._capability=Promise.withResolvers();this._transport=null;this._worker=null;this.docId=`d${PDFDocumentLoadingTask.#a++}`;this.destroyed=false;this.onPassword=null;this.onProgress=null}get promise(){return this._capability.promise}async destroy(){this.destroyed=true;try{if(this._worker?.port){this._worker._pendingDestroy=true}await(this._transport?.destroy())}catch(t){if(this._worker?.port){delete this._worker._pendingDestroy}throw t}this._transport=null;if(this._worker){this._worker.destroy();this._worker=null}}}class PDFDataRangeTransport{constructor(t,e,s=false,i=null){this.length=t;this.initialData=e;this.progressiveDone=s;this.contentDispositionFilename=i;this._rangeListeners=[];this._progressListeners=[];this._progressiveReadListeners=[];this._progressiveDoneListeners=[];this._readyCapability=Promise.withResolvers()}addRangeListener(t){this._rangeListeners.push(t)}addProgressListener(t){this._progressListeners.push(t)}addProgressiveReadListener(t){this._progressiveReadListeners.push(t)}addProgressiveDoneListener(t){this._progressiveDoneListeners.push(t)}onDataRange(t,e){for(const s of this._rangeListeners){s(t,e)}}onDataProgress(t,e){this._readyCapability.promise.then(()=>{for(const s of this._progressListeners){s(t,e)}})}onDataProgressiveRead(t){this._readyCapability.promise.then(()=>{for(const e of this._progressiveReadListeners){e(t)}})}onDataProgressiveDone(){this._readyCapability.promise.then(()=>{for(const t of this._progressiveDoneListeners){t()}})}transportReady(){this._readyCapability.resolve()}requestDataRange(t,e){unreachable("Abstract method PDFDataRangeTransport.requestDataRange")}abort(){}}class PDFDocumentProxy{constructor(t,e){this._pdfInfo=t;this._transport=e}get annotationStorage(){return this._transport.annotationStorage}get filterFactory(){return this._transport.filterFactory}get numPages(){return this._pdfInfo.numPages}get fingerprints(){return this._pdfInfo.fingerprints}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}get allXfaHtml(){return this._transport._htmlForXfa}getPage(t){return this._transport.getPage(t)}getPageIndex(t){return this._transport.getPageIndex(t)}getDestinations(){return this._transport.getDestinations()}getDestination(t){return this._transport.getDestination(t)}getPageLabels(){return this._transport.getPageLabels()}getPageLayout(){return this._transport.getPageLayout()}getPageMode(){return this._transport.getPageMode()}getViewerPreferences(){return this._transport.getViewerPreferences()}getOpenAction(){return this._transport.getOpenAction()}getAttachments(){return this._transport.getAttachments()}getJSActions(){return this._transport.getDocJSActions()}getOutline(){return this._transport.getOutline()}getOptionalContentConfig({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getOptionalContentConfig(e)}getPermissions(){return this._transport.getPermissions()}getMetadata(){return this._transport.getMetadata()}getMarkInfo(){return this._transport.getMarkInfo()}getData(){return this._transport.getData()}saveDocument(){return this._transport.saveDocument()}getDownloadInfo(){return this._transport.downloadInfoCapability.promise}cleanup(t=false){return this._transport.startCleanup(t||this.isPureXfa)}destroy(){return this.loadingTask.destroy()}cachedPageNumber(t){return this._transport.cachedPageNumber(t)}get loadingParams(){return this._transport.loadingParams}get loadingTask(){return this._transport.loadingTask}getFieldObjects(){return this._transport.getFieldObjects()}hasJSActions(){return this._transport.hasJSActions()}getCalculationOrderIds(){return this._transport.getCalculationOrderIds()}}class PDFPageProxy{#Ns=null;#Bs=false;constructor(t,e,s,i=false){this._pageIndex=t;this._pageInfo=e;this._transport=s;this._stats=i?new StatTimer:null;this._pdfBug=i;this.commonObjs=s.commonObjs;this.objs=new PDFObjects;this._maybeCleanupAfterRender=false;this._intentStates=new Map;this.destroyed=false}get pageNumber(){return this._pageIndex+1}get rotate(){return this._pageInfo.rotate}get ref(){return this._pageInfo.ref}get userUnit(){return this._pageInfo.userUnit}get view(){return this._pageInfo.view}getViewport({scale:t,rotation:e=this.rotate,offsetX:s=0,offsetY:i=0,dontFlip:n=false}={}){return new PageViewport({viewBox:this.view,scale:t,rotation:e,offsetX:s,offsetY:i,dontFlip:n})}getAnnotations({intent:t="display"}={}){const{renderingIntent:e}=this._transport.getRenderingIntent(t);return this._transport.getAnnotations(this._pageIndex,e)}getJSActions(){return this._transport.getPageJSActions(this._pageIndex)}get filterFactory(){return this._transport.filterFactory}get isPureXfa(){return shadow(this,"isPureXfa",!!this._transport._htmlForXfa)}async getXfa(){return this._transport._htmlForXfa?.children[this._pageIndex]||null}render({canvasContext:t,viewport:e,intent:s="display",annotationMode:i=AnnotationMode.ENABLE,transform:n=null,background:a=null,optionalContentConfigPromise:r=null,annotationCanvasMap:o=null,pageColors:l=null,printAnnotationStorage:h=null}){this._stats?.time("Overall");const c=this._transport.getRenderingIntent(s,i,h);const{renderingIntent:d,cacheKey:u}=c;this.#Bs=false;this.#Hs();r||=this._transport.getOptionalContentConfig(d);let p=this._intentStates.get(u);if(!p){p=Object.create(null);this._intentStates.set(u,p)}if(p.streamReaderCancelTimeout){clearTimeout(p.streamReaderCancelTimeout);p.streamReaderCancelTimeout=null}const g=!!(d&RenderingIntentFlag.PRINT);if(!p.displayReadyCapability){p.displayReadyCapability=Promise.withResolvers();p.operatorList={fnArray:[],argsArray:[],lastChunk:false,separateAnnots:null};this._stats?.time("Page Request");this._pumpOperatorList(c)}const f=t=>{p.renderTasks.delete(m);if(this._maybeCleanupAfterRender||g){this.#Bs=true}this.#Us(!g);if(t){m.capability.reject(t);this._abortOperatorList({intentState:p,reason:t instanceof Error?t:new Error(t)})}else{m.capability.resolve()}if(this._stats){this._stats.timeEnd("Rendering");this._stats.timeEnd("Overall");if(globalThis.Stats?.enabled){globalThis.Stats.add(this.pageNumber,this._stats)}}};const m=new InternalRenderTask({callback:f,params:{canvasContext:t,viewport:e,transform:n,background:a},objs:this.objs,commonObjs:this.commonObjs,annotationCanvasMap:o,operatorList:p.operatorList,pageIndex:this._pageIndex,canvasFactory:this._transport.canvasFactory,filterFactory:this._transport.filterFactory,useRequestAnimationFrame:!g,pdfBug:this._pdfBug,pageColors:l});(p.renderTasks||=new Set).add(m);const b=m.task;Promise.all([p.displayReadyCapability.promise,r]).then(([t,e])=>{if(this.destroyed){f();return}this._stats?.time("Rendering");if(!(e.renderingIntent&d)){throw new Error("Must use the same `intent`-argument when calling the `PDFPageProxy.render` "+"and `PDFDocumentProxy.getOptionalContentConfig` methods.")}m.initializeGraphics({transparency:t,optionalContentConfig:e});m.operatorListChanged()}).catch(f);return b}getOperatorList({intent:t="display",annotationMode:e=AnnotationMode.ENABLE,printAnnotationStorage:s=null}={}){function i(){if(a.operatorList.lastChunk){a.opListReadCapability.resolve(a.operatorList);a.renderTasks.delete(r)}}const n=this._transport.getRenderingIntent(t,e,s,true);let a=this._intentStates.get(n.cacheKey);if(!a){a=Object.create(null);this._intentStates.set(n.cacheKey,a)}let r;if(!a.opListReadCapability){r=Object.create(null);r.operatorListChanged=i;a.opListReadCapability=Promise.withResolvers();(a.renderTasks||=new Set).add(r);a.operatorList={fnArray:[],argsArray:[],lastChunk:false,separateAnnots:null};this._stats?.time("Page Request");this._pumpOperatorList(n)}return a.opListReadCapability.promise}streamTextContent({includeMarkedContent:t=false,disableNormalization:e=false}={}){const s=100;return this._transport.messageHandler.sendWithStream("GetTextContent",{pageIndex:this._pageIndex,includeMarkedContent:t===true,disableNormalization:e===true},{highWaterMark:s,size(t){return t.items.length}})}getTextContent(t={}){if(this._transport._htmlForXfa){return this.getXfa().then(t=>XfaText.textContent(t))}const e=this.streamTextContent(t);return new Promise(function(t,s){function i(){n.read().then(function({value:e,done:s}){if(s){t(a);return}a.lang??=e.lang;Object.assign(a.styles,e.styles);a.items.push(...e.items);i()},s)}const n=e.getReader();const a={items:[],styles:Object.create(null),lang:null};i()})}getStructTree(){return this._transport.getStructTree(this._pageIndex)}_destroy(){this.destroyed=true;const t=[];for(const e of this._intentStates.values()){this._abortOperatorList({intentState:e,reason:new Error("Page was destroyed."),force:true});if(e.opListReadCapability){continue}for(const s of e.renderTasks){t.push(s.completed);s.cancel()}}this.objs.clear();this.#Bs=false;this.#Hs();return Promise.all(t)}cleanup(t=false){this.#Bs=true;const e=this.#Us(false);if(t&&e){this._stats&&=new StatTimer}return e}#Us(t=false){this.#Hs();if(!this.#Bs||this.destroyed){return false}if(t){this.#Ns=setTimeout(()=>{this.#Ns=null;this.#Us(false)},DELAYED_CLEANUP_TIMEOUT);return false}for(const{renderTasks:t,operatorList:e}of this._intentStates.values()){if(t.size>0||!e.lastChunk){return false}}this._intentStates.clear();this.objs.clear();this.#Bs=false;return true}#Hs(){if(this.#Ns){clearTimeout(this.#Ns);this.#Ns=null}}_startRenderPage(t,e){const s=this._intentStates.get(e);if(!s){return}this._stats?.timeEnd("Page Request");s.displayReadyCapability?.resolve(t)}_renderPageChunk(t,e){for(let s=0,i=t.length;s<i;s++){e.operatorList.fnArray.push(t.fnArray[s]);e.operatorList.argsArray.push(t.argsArray[s])}e.operatorList.lastChunk=t.lastChunk;e.operatorList.separateAnnots=t.separateAnnots;for(const t of e.renderTasks){t.operatorListChanged()}if(t.lastChunk){this.#Us(true)}}_pumpOperatorList({renderingIntent:t,cacheKey:e,annotationStorageSerializable:s}){const{map:i,transfer:n}=s;const a=this._transport.messageHandler.sendWithStream("GetOperatorList",{pageIndex:this._pageIndex,intent:t,cacheKey:e,annotationStorage:i},n);const r=a.getReader();const o=this._intentStates.get(e);o.streamReader=r;const l=()=>{r.read().then(({value:t,done:e})=>{if(e){o.streamReader=null;return}if(this._transport.destroyed){return}this._renderPageChunk(t,o);l()},t=>{o.streamReader=null;if(this._transport.destroyed){return}if(o.operatorList){o.operatorList.lastChunk=true;for(const t of o.renderTasks){t.operatorListChanged()}this.#Us(true)}if(o.displayReadyCapability){o.displayReadyCapability.reject(t)}else if(o.opListReadCapability){o.opListReadCapability.reject(t)}else{throw t}})};l()}_abortOperatorList({intentState:t,reason:e,force:s=false}){if(!t.streamReader){return}if(t.streamReaderCancelTimeout){clearTimeout(t.streamReaderCancelTimeout);t.streamReaderCancelTimeout=null}if(!s){if(t.renderTasks.size>0){return}if(e instanceof RenderingCancelledException){let s=RENDERING_CANCELLED_TIMEOUT;if(e.extraDelay>0&&e.extraDelay<1e3){s+=e.extraDelay}t.streamReaderCancelTimeout=setTimeout(()=>{t.streamReaderCancelTimeout=null;this._abortOperatorList({intentState:t,reason:e,force:true})},s);return}}t.streamReader.cancel(new AbortException(e.message)).catch(()=>{});t.streamReader=null;if(this._transport.destroyed){return}for(const[e,s]of this._intentStates){if(s===t){this._intentStates.delete(e);break}}this.cleanup()}get stats(){return this._stats}}class LoopbackPort{#zs=new Set;#Gs=Promise.resolve();postMessage(t,e){const s={data:structuredClone(t,e?{transfer:e}:null)};this.#Gs.then(()=>{for(const t of this.#zs){t.call(this,s)}})}addEventListener(t,e){this.#zs.add(e)}removeEventListener(t,e){this.#zs.delete(e)}terminate(){this.#zs.clear()}}const PDFWorkerUtil={isWorkerDisabled:false,fakeWorkerId:0};{if(isNodeJS){PDFWorkerUtil.isWorkerDisabled=true;GlobalWorkerOptions.workerSrc||="./pdf.worker.mjs"}PDFWorkerUtil.isSameOrigin=function(t,e){let s;try{s=new URL(t);if(!s.origin||s.origin==="null"){return false}}catch{return false}const i=new URL(e,s);return s.origin===i.origin};PDFWorkerUtil.createCDNWrapper=function(t){const e=`await import("${t}");`;return URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}}class PDFWorker{static#Vs;constructor({name:t=null,port:e=null,verbosity:s=getVerbosityLevel()}={}){this.name=t;this.destroyed=false;this.verbosity=s;this._readyCapability=Promise.withResolvers();this._port=null;this._webWorker=null;this._messageHandler=null;if(e){if(PDFWorker.#Vs?.has(e)){throw new Error("Cannot use more than one PDFWorker per port.")}(PDFWorker.#Vs||=new WeakMap).set(e,this);this._initializeFromPort(e);return}this._initialize()}get promise(){if(isNodeJS){return Promise.all([NodePackages.promise,this._readyCapability.promise])}return this._readyCapability.promise}#Ws(){this._readyCapability.resolve();this._messageHandler.send("configure",{verbosity:this.verbosity})}get port(){return this._port}get messageHandler(){return this._messageHandler}_initializeFromPort(t){this._port=t;this._messageHandler=new MessageHandler("main","worker",t);this._messageHandler.on("ready",function(){});this.#Ws()}_initialize(){if(PDFWorkerUtil.isWorkerDisabled||PDFWorker.#js){this._setupFakeWorker();return}let{workerSrc:t}=PDFWorker;try{if(!PDFWorkerUtil.isSameOrigin(window.location.href,t)){t=PDFWorkerUtil.createCDNWrapper(new URL(t,window.location).href)}const e=new Worker(t,{type:"module"});const s=new MessageHandler("main","worker",e);const i=()=>{n.abort();s.destroy();e.terminate();if(this.destroyed){this._readyCapability.reject(new Error("Worker was destroyed"))}else{this._setupFakeWorker()}};const n=new AbortController;e.addEventListener("error",()=>{if(!this._webWorker){i()}},{signal:n.signal});s.on("test",t=>{n.abort();if(this.destroyed||!t){i();return}this._messageHandler=s;this._port=e;this._webWorker=e;this.#Ws()});s.on("ready",t=>{n.abort();if(this.destroyed){i();return}try{a()}catch{this._setupFakeWorker()}});const a=()=>{const t=new Uint8Array;s.send("test",t,[t.buffer])};a();return}catch{info("The worker has been disabled.")}this._setupFakeWorker()}_setupFakeWorker(){if(!PDFWorkerUtil.isWorkerDisabled){warn("Setting up fake worker.");PDFWorkerUtil.isWorkerDisabled=true}PDFWorker._setupFakeWorkerGlobal.then(t=>{if(this.destroyed){this._readyCapability.reject(new Error("Worker was destroyed"));return}const e=new LoopbackPort;this._port=e;const s=`fake${PDFWorkerUtil.fakeWorkerId++}`;const i=new MessageHandler(s+"_worker",s,e);t.setup(i,e);this._messageHandler=new MessageHandler(s,s+"_worker",e);this.#Ws()}).catch(t=>{this._readyCapability.reject(new Error(`Setting up fake worker failed: "${t.message}".`))})}destroy(){this.destroyed=true;if(this._webWorker){this._webWorker.terminate();this._webWorker=null}PDFWorker.#Vs?.delete(this._port);this._port=null;if(this._messageHandler){this._messageHandler.destroy();this._messageHandler=null}}static fromPort(t){if(!t?.port){throw new Error("PDFWorker.fromPort - invalid method signature.")}const e=this.#Vs?.get(t.port);if(e){if(e._pendingDestroy){throw new Error("PDFWorker.fromPort - the worker is being destroyed.\n"+"Please remember to await `PDFDocumentLoadingTask.destroy()`-calls.")}return e}return new PDFWorker(t)}static get workerSrc(){if(GlobalWorkerOptions.workerSrc){return GlobalWorkerOptions.workerSrc}throw new Error('No "GlobalWorkerOptions.workerSrc" specified.')}static get#js(){try{return globalThis.pdfjsWorker?.WorkerMessageHandler||null}catch{return null}}static get _setupFakeWorkerGlobal(){const t=async()=>{if(this.#js){return this.#js}const t=await import(this.workerSrc);return t.WorkerMessageHandler};return shadow(this,"_setupFakeWorkerGlobal",t())}}class WorkerTransport{#$s=new Map;#Ks=new Map;#qs=new Map;#Xs=new Map;#Ys=null;constructor(t,e,s,i,n){this.messageHandler=t;this.loadingTask=e;this.commonObjs=new PDFObjects;this.fontLoader=new FontLoader({ownerDocument:i.ownerDocument,styleElement:i.styleElement});this.loadingParams=i.loadingParams;this._params=i;this.canvasFactory=n.canvasFactory;this.filterFactory=n.filterFactory;this.cMapReaderFactory=n.cMapReaderFactory;this.standardFontDataFactory=n.standardFontDataFactory;this.destroyed=false;this.destroyCapability=null;this._networkStream=s;this._fullReader=null;this._lastProgress=null;this.downloadInfoCapability=Promise.withResolvers();this.setupMessageHandler()}#Js(t,e=null){const s=this.#$s.get(t);if(s){return s}const i=this.messageHandler.sendWithPromise(t,e);this.#$s.set(t,i);return i}get annotationStorage(){return shadow(this,"annotationStorage",new AnnotationStorage)}getRenderingIntent(t,e=AnnotationMode.ENABLE,s=null,i=false){let n=RenderingIntentFlag.DISPLAY;let a=SerializableEmpty;switch(t){case"any":n=RenderingIntentFlag.ANY;break;case"display":break;case"print":n=RenderingIntentFlag.PRINT;break;default:warn(`getRenderingIntent - invalid intent: ${t}`)}switch(e){case AnnotationMode.DISABLE:n+=RenderingIntentFlag.ANNOTATIONS_DISABLE;break;case AnnotationMode.ENABLE:break;case AnnotationMode.ENABLE_FORMS:n+=RenderingIntentFlag.ANNOTATIONS_FORMS;break;case AnnotationMode.ENABLE_STORAGE:n+=RenderingIntentFlag.ANNOTATIONS_STORAGE;const t=n&RenderingIntentFlag.PRINT&&s instanceof PrintAnnotationStorage?s:this.annotationStorage;a=t.serializable;break;default:warn(`getRenderingIntent - invalid annotationMode: ${e}`)}if(i){n+=RenderingIntentFlag.OPLIST}return{renderingIntent:n,cacheKey:`${n}_${a.hash}`,annotationStorageSerializable:a}}destroy(){if(this.destroyCapability){return this.destroyCapability.promise}this.destroyed=true;this.destroyCapability=Promise.withResolvers();this.#Ys?.reject(new Error("Worker was destroyed during onPassword callback"));const t=[];for(const e of this.#Ks.values()){t.push(e._destroy())}this.#Ks.clear();this.#qs.clear();this.#Xs.clear();if(this.hasOwnProperty("annotationStorage")){this.annotationStorage.resetModified()}const e=this.messageHandler.sendWithPromise("Terminate",null);t.push(e);Promise.all(t).then(()=>{this.commonObjs.clear();this.fontLoader.clear();this.#$s.clear();this.filterFactory.destroy();TextLayer.cleanup();this._networkStream?.cancelAllRequests(new AbortException("Worker was terminated."));if(this.messageHandler){this.messageHandler.destroy();this.messageHandler=null}this.destroyCapability.resolve()},this.destroyCapability.reject);return this.destroyCapability.promise}setupMessageHandler(){const{messageHandler:t,loadingTask:e}=this;t.on("GetReader",(t,e)=>{assert(this._networkStream,"GetReader - no `IPDFStream` instance available.");this._fullReader=this._networkStream.getFullReader();this._fullReader.onProgress=t=>{this._lastProgress={loaded:t.loaded,total:t.total}};e.onPull=()=>{this._fullReader.read().then(function({value:t,done:s}){if(s){e.close();return}assert(t instanceof ArrayBuffer,"GetReader - expected an ArrayBuffer.");e.enqueue(new Uint8Array(t),1,[t])}).catch(t=>{e.error(t)})};e.onCancel=t=>{this._fullReader.cancel(t);e.ready.catch(t=>{if(this.destroyed){return}throw t})}});t.on("ReaderHeadersReady",t=>{const s=Promise.withResolvers();const i=this._fullReader;i.headersReady.then(()=>{if(!i.isStreamingSupported||!i.isRangeSupported){if(this._lastProgress){e.onProgress?.(this._lastProgress)}i.onProgress=t=>{e.onProgress?.({loaded:t.loaded,total:t.total})}}s.resolve({isStreamingSupported:i.isStreamingSupported,isRangeSupported:i.isRangeSupported,contentLength:i.contentLength})},s.reject);return s.promise});t.on("GetRangeReader",(t,e)=>{assert(this._networkStream,"GetRangeReader - no `IPDFStream` instance available.");const s=this._networkStream.getRangeReader(t.begin,t.end);if(!s){e.close();return}e.onPull=()=>{s.read().then(function({value:t,done:s}){if(s){e.close();return}assert(t instanceof ArrayBuffer,"GetRangeReader - expected an ArrayBuffer.");e.enqueue(new Uint8Array(t),1,[t])}).catch(t=>{e.error(t)})};e.onCancel=t=>{s.cancel(t);e.ready.catch(t=>{if(this.destroyed){return}throw t})}});t.on("GetDoc",({pdfInfo:t})=>{this._numPages=t.numPages;this._htmlForXfa=t.htmlForXfa;delete t.htmlForXfa;e._capability.resolve(new PDFDocumentProxy(t,this))});t.on("DocException",function(t){let s;switch(t.name){case"PasswordException":s=new PasswordException(t.message,t.code);break;case"InvalidPDFException":s=new InvalidPDFException(t.message);break;case"MissingPDFException":s=new MissingPDFException(t.message);break;case"UnexpectedResponseException":s=new UnexpectedResponseException(t.message,t.status);break;case"UnknownErrorException":s=new UnknownErrorException(t.message,t.details);break;default:unreachable("DocException - expected a valid Error.")}e._capability.reject(s)});t.on("PasswordRequest",t=>{this.#Ys=Promise.withResolvers();if(e.onPassword){const s=t=>{if(t instanceof Error){this.#Ys.reject(t)}else{this.#Ys.resolve({password:t})}};try{e.onPassword(s,t.code)}catch(t){this.#Ys.reject(t)}}else{this.#Ys.reject(new PasswordException(t.message,t.code))}return this.#Ys.promise});t.on("DataLoaded",t=>{e.onProgress?.({loaded:t.length,total:t.length});this.downloadInfoCapability.resolve(t)});t.on("StartRenderPage",t=>{if(this.destroyed){return}const e=this.#Ks.get(t.pageIndex);e._startRenderPage(t.transparency,t.cacheKey)});t.on("commonobj",([e,s,i])=>{if(this.destroyed){return null}if(this.commonObjs.has(e)){return null}switch(s){case"Font":const{disableFontFace:n,fontExtraProperties:a,pdfBug:r}=this._params;if("error"in i){const t=i.error;warn(`Error during font loading: ${t}`);this.commonObjs.resolve(e,t);break}const o=r&&globalThis.FontInspector?.enabled?(t,e)=>globalThis.FontInspector.fontAdded(t,e):null;const l=new FontFaceObject(i,{disableFontFace:n,inspectFont:o});this.fontLoader.bind(l).catch(()=>t.sendWithPromise("FontFallback",{id:e})).finally(()=>{if(!a&&l.data){l.data=null}this.commonObjs.resolve(e,l)});break;case"CopyLocalImage":const{imageRef:h}=i;assert(h,"The imageRef must be defined.");for(const t of this.#Ks.values()){for(const[,s]of t.objs){if(s?.ref!==h){continue}if(!s.dataLen){return null}this.commonObjs.resolve(e,structuredClone(s));return s.dataLen}}break;case"FontPath":case"Image":case"Pattern":this.commonObjs.resolve(e,i);break;default:throw new Error(`Got unknown common object type ${s}`)}return null});t.on("obj",([t,e,s,i])=>{if(this.destroyed){return}const n=this.#Ks.get(e);if(n.objs.has(t)){return}if(n._intentStates.size===0){i?.bitmap?.close();return}switch(s){case"Image":n.objs.resolve(t,i);if(i?.dataLen>MAX_IMAGE_SIZE_TO_CACHE){n._maybeCleanupAfterRender=true}break;case"Pattern":n.objs.resolve(t,i);break;default:throw new Error(`Got unknown object type ${s}`)}});t.on("DocProgress",t=>{if(this.destroyed){return}e.onProgress?.({loaded:t.loaded,total:t.total})});t.on("FetchBuiltInCMap",t=>{if(this.destroyed){return Promise.reject(new Error("Worker was destroyed."))}if(!this.cMapReaderFactory){return Promise.reject(new Error("CMapReaderFactory not initialized, see the `useWorkerFetch` parameter."))}return this.cMapReaderFactory.fetch(t)});t.on("FetchStandardFontData",t=>{if(this.destroyed){return Promise.reject(new Error("Worker was destroyed."))}if(!this.standardFontDataFactory){return Promise.reject(new Error("StandardFontDataFactory not initialized, see the `useWorkerFetch` parameter."))}return this.standardFontDataFactory.fetch(t)})}getData(){return this.messageHandler.sendWithPromise("GetData",null)}saveDocument(){if(this.annotationStorage.size<=0){warn("saveDocument called while `annotationStorage` is empty, "+"please use the getData-method instead.")}const{map:t,transfer:e}=this.annotationStorage.serializable;return this.messageHandler.sendWithPromise("SaveDocument",{isPureXfa:!!this._htmlForXfa,numPages:this._numPages,annotationStorage:t,filename:this._fullReader?.filename??null},e).finally(()=>{this.annotationStorage.resetModified()})}getPage(t){if(!Number.isInteger(t)||t<=0||t>this._numPages){return Promise.reject(new Error("Invalid page request."))}const e=t-1,s=this.#qs.get(e);if(s){return s}const i=this.messageHandler.sendWithPromise("GetPage",{pageIndex:e}).then(s=>{if(this.destroyed){throw new Error("Transport destroyed")}if(s.refStr){this.#Xs.set(s.refStr,t)}const i=new PDFPageProxy(e,s,this,this._params.pdfBug);this.#Ks.set(e,i);return i});this.#qs.set(e,i);return i}getPageIndex(t){if(!isRefProxy(t)){return Promise.reject(new Error("Invalid pageIndex request."))}return this.messageHandler.sendWithPromise("GetPageIndex",{num:t.num,gen:t.gen})}getAnnotations(t,e){return this.messageHandler.sendWithPromise("GetAnnotations",{pageIndex:t,intent:e})}getFieldObjects(){return this.#Js("GetFieldObjects")}hasJSActions(){return this.#Js("HasJSActions")}getCalculationOrderIds(){return this.messageHandler.sendWithPromise("GetCalculationOrderIds",null)}getDestinations(){return this.messageHandler.sendWithPromise("GetDestinations",null)}getDestination(t){if(typeof t!=="string"){return Promise.reject(new Error("Invalid destination request."))}return this.messageHandler.sendWithPromise("GetDestination",{id:t})}getPageLabels(){return this.messageHandler.sendWithPromise("GetPageLabels",null)}getPageLayout(){return this.messageHandler.sendWithPromise("GetPageLayout",null)}getPageMode(){return this.messageHandler.sendWithPromise("GetPageMode",null)}getViewerPreferences(){return this.messageHandler.sendWithPromise("GetViewerPreferences",null)}getOpenAction(){return this.messageHandler.sendWithPromise("GetOpenAction",null)}getAttachments(){return this.messageHandler.sendWithPromise("GetAttachments",null)}getDocJSActions(){return this.#Js("GetDocJSActions")}getPageJSActions(t){return this.messageHandler.sendWithPromise("GetPageJSActions",{pageIndex:t})}getStructTree(t){return this.messageHandler.sendWithPromise("GetStructTree",{pageIndex:t})}getOutline(){return this.messageHandler.sendWithPromise("GetOutline",null)}getOptionalContentConfig(t){return this.#Js("GetOptionalContentConfig").then(e=>new OptionalContentConfig(e,t))}getPermissions(){return this.messageHandler.sendWithPromise("GetPermissions",null)}getMetadata(){const t="GetMetadata",e=this.#$s.get(t);if(e){return e}const s=this.messageHandler.sendWithPromise(t,null).then(t=>({info:t[0],metadata:t[1]?new Metadata(t[1]):null,contentDispositionFilename:this._fullReader?.filename??null,contentLength:this._fullReader?.contentLength??null}));this.#$s.set(t,s);return s}getMarkInfo(){return this.messageHandler.sendWithPromise("GetMarkInfo",null)}async startCleanup(t=false){if(this.destroyed){return}await this.messageHandler.sendWithPromise("Cleanup",null);for(const t of this.#Ks.values()){const e=t.cleanup();if(!e){throw new Error(`startCleanup: Page ${t.pageNumber} is currently rendering.`)}}this.commonObjs.clear();if(!t){this.fontLoader.clear()}this.#$s.clear();this.filterFactory.destroy(true);TextLayer.cleanup()}cachedPageNumber(t){if(!isRefProxy(t)){return null}const e=t.gen===0?`${t.num}R`:`${t.num}R${t.gen}`;return this.#Xs.get(e)??null}}const INITIAL_DATA=Symbol("INITIAL_DATA");class PDFObjects{#Qs=Object.create(null);#Zs(t){return this.#Qs[t]||={...Promise.withResolvers(),data:INITIAL_DATA}}get(t,e=null){if(e){const s=this.#Zs(t);s.promise.then(()=>e(s.data));return null}const s=this.#Qs[t];if(!s||s.data===INITIAL_DATA){throw new Error(`Requesting object that isn't resolved yet ${t}.`)}return s.data}has(t){const e=this.#Qs[t];return!!e&&e.data!==INITIAL_DATA}resolve(t,e=null){const s=this.#Zs(t);s.data=e;s.resolve()}clear(){for(const t in this.#Qs){const{data:e}=this.#Qs[t];e?.bitmap?.close()}this.#Qs=Object.create(null)}*[Symbol.iterator](){for(const t in this.#Qs){const{data:e}=this.#Qs[t];if(e===INITIAL_DATA){continue}yield[t,e]}}}class RenderTask{#ti=null;constructor(t){this.#ti=t;this.onContinue=null}get promise(){return this.#ti.capability.promise}cancel(t=0){this.#ti.cancel(null,t)}get separateAnnots(){const{separateAnnots:t}=this.#ti.operatorList;if(!t){return false}const{annotationCanvasMap:e}=this.#ti;return t.form||t.canvas&&e?.size>0}}class InternalRenderTask{#ei=null;static#si=new WeakSet;constructor({callback:t,params:e,objs:s,commonObjs:i,annotationCanvasMap:n,operatorList:a,pageIndex:r,canvasFactory:o,filterFactory:l,useRequestAnimationFrame:h=false,pdfBug:c=false,pageColors:d=null}){this.callback=t;this.params=e;this.objs=s;this.commonObjs=i;this.annotationCanvasMap=n;this.operatorListIdx=null;this.operatorList=a;this._pageIndex=r;this.canvasFactory=o;this.filterFactory=l;this._pdfBug=c;this.pageColors=d;this.running=false;this.graphicsReadyCallback=null;this.graphicsReady=false;this._useRequestAnimationFrame=h===true&&typeof window!=="undefined";this.cancelled=false;this.capability=Promise.withResolvers();this.task=new RenderTask(this);this._cancelBound=this.cancel.bind(this);this._continueBound=this._continue.bind(this);this._scheduleNextBound=this._scheduleNext.bind(this);this._nextBound=this._next.bind(this);this._canvas=e.canvasContext.canvas}get completed(){return this.capability.promise.catch(function(){})}initializeGraphics({transparency:t=false,optionalContentConfig:e}){if(this.cancelled){return}if(this._canvas){if(InternalRenderTask.#si.has(this._canvas)){throw new Error("Cannot use the same canvas during multiple render() operations. "+"Use different canvas or ensure previous operations were "+"cancelled or completed.")}InternalRenderTask.#si.add(this._canvas)}if(this._pdfBug&&globalThis.StepperManager?.enabled){this.stepper=globalThis.StepperManager.create(this._pageIndex);this.stepper.init(this.operatorList);this.stepper.nextBreakPoint=this.stepper.getNextBreakPoint()}const{canvasContext:s,viewport:i,transform:n,background:a}=this.params;this.gfx=new CanvasGraphics(s,this.commonObjs,this.objs,this.canvasFactory,this.filterFactory,{optionalContentConfig:e},this.annotationCanvasMap,this.pageColors);this.gfx.beginDrawing({transform:n,viewport:i,transparency:t,background:a});this.operatorListIdx=0;this.graphicsReady=true;this.graphicsReadyCallback?.()}cancel(t=null,e=0){this.running=false;this.cancelled=true;this.gfx?.endDrawing();if(this.#ei){window.cancelAnimationFrame(this.#ei);this.#ei=null}InternalRenderTask.#si.delete(this._canvas);this.callback(t||new RenderingCancelledException(`Rendering cancelled, page ${this._pageIndex+1}`,e))}operatorListChanged(){if(!this.graphicsReady){this.graphicsReadyCallback||=this._continueBound;return}this.stepper?.updateOperatorList(this.operatorList);if(this.running){return}this._continue()}_continue(){this.running=true;if(this.cancelled){return}if(this.task.onContinue){this.task.onContinue(this._scheduleNextBound)}else{this._scheduleNext()}}_scheduleNext(){if(this._useRequestAnimationFrame){this.#ei=window.requestAnimationFrame(()=>{this.#ei=null;this._nextBound().catch(this._cancelBound)})}else{Promise.resolve().then(this._nextBound).catch(this._cancelBound)}}async _next(){if(this.cancelled){return}this.operatorListIdx=this.gfx.executeOperatorList(this.operatorList,this.operatorListIdx,this._continueBound,this.stepper);if(this.operatorListIdx===this.operatorList.argsArray.length){this.running=false;if(this.operatorList.lastChunk){this.gfx.endDrawing();InternalRenderTask.#si.delete(this._canvas);this.callback()}}}}const version="4.4.168";const build="19fbc8998";function makeColorComp(t){return Math.floor(Math.max(0,Math.min(1,t))*255).toString(16).padStart(2,"0")}function scaleAndClamp(t){return Math.max(0,Math.min(255,255*t))}class ColorConverters{static CMYK_G([t,e,s,i]){return["G",1-Math.min(1,.3*t+.59*s+.11*e+i)]}static G_CMYK([t]){return["CMYK",0,0,0,1-t]}static G_RGB([t]){return["RGB",t,t,t]}static G_rgb([t]){t=scaleAndClamp(t);return[t,t,t]}static G_HTML([t]){const e=makeColorComp(t);return`#${e}${e}${e}`}static RGB_G([t,e,s]){return["G",.3*t+.59*e+.11*s]}static RGB_rgb(t){return t.map(scaleAndClamp)}static RGB_HTML(t){return`#${t.map(makeColorComp).join("")}`}static T_HTML(){return"#00000000"}static T_rgb(){return[null]}static CMYK_RGB([t,e,s,i]){return["RGB",1-Math.min(1,t+i),1-Math.min(1,s+i),1-Math.min(1,e+i)]}static CMYK_rgb([t,e,s,i]){return[scaleAndClamp(1-Math.min(1,t+i)),scaleAndClamp(1-Math.min(1,s+i)),scaleAndClamp(1-Math.min(1,e+i))]}static CMYK_HTML(t){const e=this.CMYK_RGB(t).slice(1);return this.RGB_HTML(e)}static RGB_CMYK([t,e,s]){const i=1-t;const n=1-e;const a=1-s;const r=Math.min(i,n,a);return["CMYK",i,n,a,r]}}class XfaLayer{static setupStorage(t,e,s,i,n){const a=i.getValue(e,{value:null});switch(s.name){case"textarea":if(a.value!==null){t.textContent=a.value}if(n==="print"){break}t.addEventListener("input",t=>{i.setValue(e,{value:t.target.value})});break;case"input":if(s.attributes.type==="radio"||s.attributes.type==="checkbox"){if(a.value===s.attributes.xfaOn){t.setAttribute("checked",true)}else if(a.value===s.attributes.xfaOff){t.removeAttribute("checked")}if(n==="print"){break}t.addEventListener("change",t=>{i.setValue(e,{value:t.target.checked?t.target.getAttribute("xfaOn"):t.target.getAttribute("xfaOff")})})}else{if(a.value!==null){t.setAttribute("value",a.value)}if(n==="print"){break}t.addEventListener("input",t=>{i.setValue(e,{value:t.target.value})})}break;case"select":if(a.value!==null){t.setAttribute("value",a.value);for(const t of s.children){if(t.attributes.value===a.value){t.attributes.selected=true}else if(t.attributes.hasOwnProperty("selected")){delete t.attributes.selected}}}t.addEventListener("input",t=>{const s=t.target.options;const n=s.selectedIndex===-1?"":s[s.selectedIndex].value;i.setValue(e,{value:n})});break}}static setAttributes({html:t,element:e,storage:s=null,intent:i,linkService:n}){const{attributes:a}=e;const r=t instanceof HTMLAnchorElement;if(a.type==="radio"){a.name=`${a.name}-${i}`}for(const[e,s]of Object.entries(a)){if(s===null||s===undefined){continue}switch(e){case"class":if(s.length){t.setAttribute(e,s.join(" "))}break;case"dataId":break;case"id":t.setAttribute("data-element-id",s);break;case"style":Object.assign(t.style,s);break;case"textContent":t.textContent=s;break;default:if(!r||e!=="href"&&e!=="newWindow"){t.setAttribute(e,s)}}}if(r){n.addLinkAttributes(t,a.href,a.newWindow)}if(s&&a.dataId){this.setupStorage(t,a.dataId,e,s)}}static render(t){const e=t.annotationStorage;const s=t.linkService;const i=t.xfaHtml;const n=t.intent||"display";const a=document.createElement(i.name);if(i.attributes){this.setAttributes({html:a,element:i,intent:n,linkService:s})}const r=n!=="richText";const o=t.div;o.append(a);if(t.viewport){const e=`matrix(${t.viewport.transform.join(",")})`;o.style.transform=e}if(r){o.setAttribute("class","xfaLayer xfaFont")}const l=[];if(i.children.length===0){if(i.value){const t=document.createTextNode(i.value);a.append(t);if(r&&XfaText.shouldBuildText(i.name)){l.push(t)}}return{textDivs:l}}const h=[[i,-1,a]];while(h.length>0){const[t,i,a]=h.at(-1);if(i+1===t.children.length){h.pop();continue}const o=t.children[++h.at(-1)[1]];if(o===null){continue}const{name:c}=o;if(c==="#text"){const t=document.createTextNode(o.value);l.push(t);a.append(t);continue}const d=o?.attributes?.xmlns?document.createElementNS(o.attributes.xmlns,c):document.createElement(c);a.append(d);if(o.attributes){this.setAttributes({html:d,element:o,storage:e,intent:n,linkService:s})}if(o.children?.length>0){h.push([o,-1,d])}else if(o.value){const t=document.createTextNode(o.value);if(r&&XfaText.shouldBuildText(c)){l.push(t)}d.append(t)}}for(const t of o.querySelectorAll(".xfaNonInteractive input, .xfaNonInteractive textarea")){t.setAttribute("readOnly",true)}return{textDivs:l}}static update(t){const e=`matrix(${t.viewport.transform.join(",")})`;t.div.style.transform=e;t.div.hidden=false}}const DEFAULT_TAB_INDEX=1e3;const annotation_layer_DEFAULT_FONT_SIZE=9;const GetElementsByNameSet=new WeakSet;function getRectDims(t){return{width:t[2]-t[0],height:t[3]-t[1]}}class AnnotationElementFactory{static create(t){const e=t.data.annotationType;switch(e){case AnnotationType.LINK:return new LinkAnnotationElement(t);case AnnotationType.TEXT:return new TextAnnotationElement(t);case AnnotationType.WIDGET:const e=t.data.fieldType;switch(e){case"Tx":return new TextWidgetAnnotationElement(t);case"Btn":if(t.data.radioButton){return new RadioButtonWidgetAnnotationElement(t)}else if(t.data.checkBox){return new CheckboxWidgetAnnotationElement(t)}return new PushButtonWidgetAnnotationElement(t);case"Ch":return new ChoiceWidgetAnnotationElement(t);case"Sig":return new SignatureWidgetAnnotationElement(t)}return new WidgetAnnotationElement(t);case AnnotationType.POPUP:return new PopupAnnotationElement(t);case AnnotationType.FREETEXT:return new FreeTextAnnotationElement(t);case AnnotationType.LINE:return new LineAnnotationElement(t);case AnnotationType.SQUARE:return new SquareAnnotationElement(t);case AnnotationType.CIRCLE:return new CircleAnnotationElement(t);case AnnotationType.POLYLINE:return new PolylineAnnotationElement(t);case AnnotationType.CARET:return new CaretAnnotationElement(t);case AnnotationType.INK:return new InkAnnotationElement(t);case AnnotationType.POLYGON:return new PolygonAnnotationElement(t);case AnnotationType.HIGHLIGHT:return new HighlightAnnotationElement(t);case AnnotationType.UNDERLINE:return new UnderlineAnnotationElement(t);case AnnotationType.SQUIGGLY:return new SquigglyAnnotationElement(t);case AnnotationType.STRIKEOUT:return new StrikeOutAnnotationElement(t);case AnnotationType.STAMP:return new StampAnnotationElement(t);case AnnotationType.FILEATTACHMENT:return new FileAttachmentAnnotationElement(t);default:return new AnnotationElement(t)}}}class AnnotationElement{#ii=null;#ni=false;#ai=null;constructor(t,{isRenderable:e=false,ignoreBorder:s=false,createQuadrilaterals:i=false}={}){this.isRenderable=e;this.data=t.data;this.layer=t.layer;this.linkService=t.linkService;this.downloadManager=t.downloadManager;this.imageResourcesPath=t.imageResourcesPath;this.renderForms=t.renderForms;this.svgFactory=t.svgFactory;this.annotationStorage=t.annotationStorage;this.enableScripting=t.enableScripting;this.hasJSActions=t.hasJSActions;this._fieldObjects=t.fieldObjects;this.parent=t.parent;if(e){this.container=this._createContainer(s)}if(i){this._createQuadrilaterals()}}static _hasPopupData({titleObj:t,contentsObj:e,richText:s}){return!!(t?.str||e?.str||s?.str)}get hasPopupData(){return AnnotationElement._hasPopupData(this.data)}updateEdited(t){if(!this.container){return}this.#ii||={rect:this.data.rect.slice(0)};const{rect:e}=t;if(e){this.#ri(e)}this.#ai?.popup.updateEdited(t)}resetEdited(){if(!this.#ii){return}this.#ri(this.#ii.rect);this.#ai?.popup.resetEdited();this.#ii=null}#ri(t){const{container:{style:e},data:{rect:s,rotation:i},parent:{viewport:{rawDims:{pageWidth:n,pageHeight:a,pageX:r,pageY:o}}}}=this;s?.splice(0,4,...t);const{width:l,height:h}=getRectDims(t);e.left=`${100*(t[0]-r)/n}%`;e.top=`${100*(a-t[3]+o)/a}%`;if(i===0){e.width=`${100*l/n}%`;e.height=`${100*h/a}%`}else{this.setRotation(i)}}_createContainer(t){const{data:e,parent:{page:s,viewport:i}}=this;const n=document.createElement("section");n.setAttribute("data-annotation-id",e.id);if(!(this instanceof WidgetAnnotationElement)){n.tabIndex=DEFAULT_TAB_INDEX}const{style:a}=n;a.zIndex=this.parent.zIndex++;if(e.popupRef){n.setAttribute("aria-haspopup","dialog")}if(e.alternativeText){n.title=e.alternativeText}if(e.noRotate){n.classList.add("norotate")}if(!e.rect||this instanceof PopupAnnotationElement){const{rotation:t}=e;if(!e.hasOwnCanvas&&t!==0){this.setRotation(t,n)}return n}const{width:r,height:o}=getRectDims(e.rect);if(!t&&e.borderStyle.width>0){a.borderWidth=`${e.borderStyle.width}px`;const t=e.borderStyle.horizontalCornerRadius;const s=e.borderStyle.verticalCornerRadius;if(t>0||s>0){const e=`calc(${t}px * var(--scale-factor)) / calc(${s}px * var(--scale-factor))`;a.borderRadius=e}else if(this instanceof RadioButtonWidgetAnnotationElement){const t=`calc(${r}px * var(--scale-factor)) / calc(${o}px * var(--scale-factor))`;a.borderRadius=t}switch(e.borderStyle.style){case AnnotationBorderStyleType.SOLID:a.borderStyle="solid";break;case AnnotationBorderStyleType.DASHED:a.borderStyle="dashed";break;case AnnotationBorderStyleType.BEVELED:warn("Unimplemented border style: beveled");break;case AnnotationBorderStyleType.INSET:warn("Unimplemented border style: inset");break;case AnnotationBorderStyleType.UNDERLINE:a.borderBottomStyle="solid";break;default:break}const i=e.borderColor||null;if(i){this.#ni=true;a.borderColor=Util.makeHexColor(i[0]|0,i[1]|0,i[2]|0)}else{a.borderWidth=0}}const l=Util.normalizeRect([e.rect[0],s.view[3]-e.rect[1]+s.view[1],e.rect[2],s.view[3]-e.rect[3]+s.view[1]]);const{pageWidth:h,pageHeight:c,pageX:d,pageY:u}=i.rawDims;a.left=`${100*(l[0]-d)/h}%`;a.top=`${100*(l[1]-u)/c}%`;const{rotation:p}=e;if(e.hasOwnCanvas||p===0){a.width=`${100*r/h}%`;a.height=`${100*o/c}%`}else{this.setRotation(p,n)}return n}setRotation(t,e=this.container){if(!this.data.rect){return}const{pageWidth:s,pageHeight:i}=this.parent.viewport.rawDims;const{width:n,height:a}=getRectDims(this.data.rect);let r,o;if(t%180===0){r=100*n/s;o=100*a/i}else{r=100*a/s;o=100*n/i}e.style.width=`${r}%`;e.style.height=`${o}%`;e.setAttribute("data-main-rotation",(360-t)%360)}get _commonActions(){const t=(t,e,s)=>{const i=s.detail[t];const n=i[0];const a=i.slice(1);s.target.style[e]=ColorConverters[`${n}_HTML`](a);this.annotationStorage.setValue(this.data.id,{[e]:ColorConverters[`${n}_rgb`](a)})};return shadow(this,"_commonActions",{display:t=>{const{display:e}=t.detail;const s=e%2===1;this.container.style.visibility=s?"hidden":"visible";this.annotationStorage.setValue(this.data.id,{noView:s,noPrint:e===1||e===2})},print:t=>{this.annotationStorage.setValue(this.data.id,{noPrint:!t.detail.print})},hidden:t=>{const{hidden:e}=t.detail;this.container.style.visibility=e?"hidden":"visible";this.annotationStorage.setValue(this.data.id,{noPrint:e,noView:e})},focus:t=>{setTimeout(()=>t.target.focus({preventScroll:false}),0)},userName:t=>{t.target.title=t.detail.userName},readonly:t=>{t.target.disabled=t.detail.readonly},required:t=>{this._setRequired(t.target,t.detail.required)},bgColor:e=>{t("bgColor","backgroundColor",e)},fillColor:e=>{t("fillColor","backgroundColor",e)},fgColor:e=>{t("fgColor","color",e)},textColor:e=>{t("textColor","color",e)},borderColor:e=>{t("borderColor","borderColor",e)},strokeColor:e=>{t("strokeColor","borderColor",e)},rotation:t=>{const e=t.detail.rotation;this.setRotation(e);this.annotationStorage.setValue(this.data.id,{rotation:e})}})}_dispatchEventFromSandbox(t,e){const s=this._commonActions;for(const i of Object.keys(e.detail)){const n=t[i]||s[i];n?.(e)}}_setDefaultPropertiesFromJS(t){if(!this.enableScripting){return}const e=this.annotationStorage.getRawValue(this.data.id);if(!e){return}const s=this._commonActions;for(const[i,n]of Object.entries(e)){const a=s[i];if(a){const s={detail:{[i]:n},target:t};a(s);delete e[i]}}}_createQuadrilaterals(){if(!this.container){return}const{quadPoints:t}=this.data;if(!t){return}const[e,s,i,n]=this.data.rect.map(t=>Math.fround(t));if(t.length===8){const[a,r,o,l]=t.subarray(2,6);if(i===a&&n===r&&e===o&&s===l){return}}const{style:a}=this.container;let r;if(this.#ni){const{borderColor:t,borderWidth:e}=a;a.borderWidth=0;r=["url('data:image/svg+xml;utf8,",`<svg xmlns="http://www.w3.org/2000/svg"`,` preserveAspectRatio="none" viewBox="0 0 1 1">`,`<g fill="transparent" stroke="${t}" stroke-width="${e}">`];this.container.classList.add("hasBorder")}const o=i-e;const l=n-s;const{svgFactory:h}=this;const c=h.createElement("svg");c.classList.add("quadrilateralsContainer");c.setAttribute("width",0);c.setAttribute("height",0);const d=h.createElement("defs");c.append(d);const u=h.createElement("clipPath");const p=`clippath_${this.data.id}`;u.setAttribute("id",p);u.setAttribute("clipPathUnits","objectBoundingBox");d.append(u);for(let s=2,i=t.length;s<i;s+=8){const i=t[s];const a=t[s+1];const c=t[s+2];const d=t[s+3];const p=h.createElement("rect");const g=(c-e)/o;const f=(n-a)/l;const m=(i-c)/o;const b=(a-d)/l;p.setAttribute("x",g);p.setAttribute("y",f);p.setAttribute("width",m);p.setAttribute("height",b);u.append(p);r?.push(`<rect vector-effect="non-scaling-stroke" x="${g}" y="${f}" width="${m}" height="${b}"/>`)}if(this.#ni){r.push(`</g></svg>')`);a.backgroundImage=r.join("")}this.container.append(c);this.container.style.clipPath=`url(#${p})`}_createPopup(){const{container:t,data:e}=this;t.setAttribute("aria-haspopup","dialog");const s=this.#ai=new PopupAnnotationElement({data:{color:e.color,titleObj:e.titleObj,modificationDate:e.modificationDate,contentsObj:e.contentsObj,richText:e.richText,parentRect:e.rect,borderStyle:0,id:`popup_${e.id}`,rotation:e.rotation},parent:this.parent,elements:[this]});this.parent.div.append(s.render())}render(){unreachable("Abstract method `AnnotationElement.render` called")}_getElementsByName(t,e=null){const s=[];if(this._fieldObjects){const i=this._fieldObjects[t];if(i){for(const{page:t,id:n,exportValues:a}of i){if(t===-1){continue}if(n===e){continue}const i=typeof a==="string"?a:null;const r=document.querySelector(`[data-element-id="${n}"]`);if(r&&!GetElementsByNameSet.has(r)){warn(`_getElementsByName - element not allowed: ${n}`);continue}s.push({id:n,exportValue:i,domElement:r})}}return s}for(const i of document.getElementsByName(t)){const{exportValue:t}=i;const n=i.getAttribute("data-element-id");if(n===e){continue}if(!GetElementsByNameSet.has(i)){continue}s.push({id:n,exportValue:t,domElement:i})}return s}show(){if(this.container){this.container.hidden=false}this.popup?.maybeShow()}hide(){if(this.container){this.container.hidden=true}this.popup?.forceHide()}getElementsToTriggerPopup(){return this.container}addHighlightArea(){const t=this.getElementsToTriggerPopup();if(Array.isArray(t)){for(const e of t){e.classList.add("highlightArea")}}else{t.classList.add("highlightArea")}}get _isEditable(){return false}_editOnDoubleClick(){if(!this._isEditable){return}const{annotationEditorType:t,data:{id:e}}=this;this.container.addEventListener("dblclick",()=>{this.linkService.eventBus?.dispatch("switchannotationeditormode",{source:this,mode:t,editId:e})})}}class LinkAnnotationElement extends AnnotationElement{constructor(t,e=null){super(t,{isRenderable:true,ignoreBorder:!!e?.ignoreBorder,createQuadrilaterals:true});this.isTooltipOnly=t.data.isTooltipOnly}render(){const{data:t,linkService:e}=this;const s=document.createElement("a");s.setAttribute("data-element-id",t.id);let i=false;if(t.url){e.addLinkAttributes(s,t.url,t.newWindow);i=true}else if(t.action){this._bindNamedAction(s,t.action);i=true}else if(t.attachment){this.#oi(s,t.attachment,t.attachmentDest);i=true}else if(t.setOCGState){this.#li(s,t.setOCGState);i=true}else if(t.dest){this._bindLink(s,t.dest);i=true}else{if(t.actions&&(t.actions.Action||t.actions["Mouse Up"]||t.actions["Mouse Down"])&&this.enableScripting&&this.hasJSActions){this._bindJSAction(s,t);i=true}if(t.resetForm){this._bindResetFormAction(s,t.resetForm);i=true}else if(this.isTooltipOnly&&!i){this._bindLink(s,"");i=true}}this.container.classList.add("linkAnnotation");if(i){this.container.append(s)}return this.container}#hi(){this.container.setAttribute("data-internal-link","")}_bindLink(t,e){t.href=this.linkService.getDestinationHash(e);t.onclick=()=>{if(e){this.linkService.goToDestination(e)}return false};if(e||e===""){this.#hi()}}_bindNamedAction(t,e){t.href=this.linkService.getAnchorUrl("");t.onclick=()=>{this.linkService.executeNamedAction(e);return false};this.#hi()}#oi(t,e,s=null){t.href=this.linkService.getAnchorUrl("");if(e.description){t.title=e.description}t.onclick=()=>{this.downloadManager?.openOrDownloadData(e.content,e.filename,s);return false};this.#hi()}#li(t,e){t.href=this.linkService.getAnchorUrl("");t.onclick=()=>{this.linkService.executeSetOCGState(e);return false};this.#hi()}_bindJSAction(t,e){t.href=this.linkService.getAnchorUrl("");const s=new Map([["Action","onclick"],["Mouse Up","onmouseup"],["Mouse Down","onmousedown"]]);for(const i of Object.keys(e.actions)){const n=s.get(i);if(!n){continue}t[n]=()=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e.id,name:i}});return false}}if(!t.onclick){t.onclick=()=>false}this.#hi()}_bindResetFormAction(t,e){const s=t.onclick;if(!s){t.href=this.linkService.getAnchorUrl("")}this.#hi();if(!this._fieldObjects){warn(`_bindResetFormAction - "resetForm" action not supported, `+"ensure that the `fieldObjects` parameter is provided.");if(!s){t.onclick=()=>false}return}t.onclick=()=>{s?.();const{fields:t,refs:i,include:n}=e;const a=[];if(t.length!==0||i.length!==0){const e=new Set(i);for(const s of t){const t=this._fieldObjects[s]||[];for(const{id:s}of t){e.add(s)}}for(const t of Object.values(this._fieldObjects)){for(const s of t){if(e.has(s.id)===n){a.push(s)}}}}else{for(const t of Object.values(this._fieldObjects)){a.push(...t)}}const r=this.annotationStorage;const o=[];for(const t of a){const{id:e}=t;o.push(e);switch(t.type){case"text":{const s=t.defaultValue||"";r.setValue(e,{value:s});break}case"checkbox":case"radiobutton":{const s=t.defaultValue===t.exportValues;r.setValue(e,{value:s});break}case"combobox":case"listbox":{const s=t.defaultValue||"";r.setValue(e,{value:s});break}default:continue}const s=document.querySelector(`[data-element-id="${e}"]`);if(!s){continue}else if(!GetElementsByNameSet.has(s)){warn(`_bindResetFormAction - element not allowed: ${e}`);continue}s.dispatchEvent(new Event("resetform"))}if(this.enableScripting){this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:"app",ids:o,name:"ResetForm"}})}return false}}}class TextAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true})}render(){this.container.classList.add("textAnnotation");const t=document.createElement("img");t.src=this.imageResourcesPath+"annotation-"+this.data.name.toLowerCase()+".svg";t.setAttribute("data-l10n-id","pdfjs-text-annotation-type");t.setAttribute("data-l10n-args",JSON.stringify({type:this.data.name}));if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.append(t);return this.container}}class WidgetAnnotationElement extends AnnotationElement{render(){return this.container}showElementAndHideCanvas(t){if(this.data.hasOwnCanvas){if(t.previousSibling?.nodeName==="CANVAS"){t.previousSibling.hidden=true}t.hidden=false}}_getKeyModifier(t){return util_FeatureTest.platform.isMac?t.metaKey:t.ctrlKey}_setEventListener(t,e,s,i,n){if(s.includes("mouse")){t.addEventListener(s,t=>{this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:n(t),shift:t.shiftKey,modifier:this._getKeyModifier(t)}})})}else{t.addEventListener(s,t=>{if(s==="blur"){if(!e.focused||!t.relatedTarget){return}e.focused=false}else if(s==="focus"){if(e.focused){return}e.focused=true}if(!n){return}this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:this.data.id,name:i,value:n(t)}})})}}_setEventListeners(t,e,s,i){for(const[n,a]of s){if(a==="Action"||this.data.actions?.[a]){if(a==="Focus"||a==="Blur"){e||={focused:false}}this._setEventListener(t,e,n,a,i);if(a==="Focus"&&!this.data.actions?.Blur){this._setEventListener(t,e,"blur","Blur",null)}else if(a==="Blur"&&!this.data.actions?.Focus){this._setEventListener(t,e,"focus","Focus",null)}}}}_setBackgroundColor(t){const e=this.data.backgroundColor||null;t.style.backgroundColor=e===null?"transparent":Util.makeHexColor(e[0],e[1],e[2])}_setTextStyle(t){const e=["left","center","right"];const{fontColor:s}=this.data.defaultAppearanceData;const i=this.data.defaultAppearanceData.fontSize||annotation_layer_DEFAULT_FONT_SIZE;const n=t.style;let a;const r=2;const o=t=>Math.round(10*t)/10;if(this.data.multiLine){const t=Math.abs(this.data.rect[3]-this.data.rect[1]-r);const e=Math.round(t/(LINE_FACTOR*i))||1;const s=t/e;a=Math.min(i,o(s/LINE_FACTOR))}else{const t=Math.abs(this.data.rect[3]-this.data.rect[1]-r);a=Math.min(i,o(t/LINE_FACTOR))}n.fontSize=`calc(${a}px * var(--scale-factor))`;n.color=Util.makeHexColor(s[0],s[1],s[2]);if(this.data.textAlignment!==null){n.textAlign=e[this.data.textAlignment]}}_setRequired(t,e){if(e){t.setAttribute("required",true)}else{t.removeAttribute("required")}t.setAttribute("aria-required",e)}}class TextWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){const e=t.renderForms||t.data.hasOwnCanvas||!t.data.hasAppearance&&!!t.data.fieldValue;super(t,{isRenderable:e})}setPropertyOnSiblings(t,e,s,i){const n=this.annotationStorage;for(const a of this._getElementsByName(t.name,t.id)){if(a.domElement){a.domElement[e]=s}n.setValue(a.id,{[i]:s})}}render(){const t=this.annotationStorage;const e=this.data.id;this.container.classList.add("textWidgetAnnotation");let s=null;if(this.renderForms){const i=t.getValue(e,{value:this.data.fieldValue});let n=i.value||"";const a=t.getValue(e,{charLimit:this.data.maxLen}).charLimit;if(a&&n.length>a){n=n.slice(0,a)}let r=i.formattedValue||this.data.textContent?.join("\n")||null;if(r&&this.data.comb){r=r.replaceAll(/\s+/g,"")}const o={userValue:n,formattedValue:r,lastCommittedValue:null,commitKey:1,focused:false};if(this.data.multiLine){s=document.createElement("textarea");s.textContent=r??n;if(this.data.doNotScroll){s.style.overflowY="hidden"}}else{s=document.createElement("input");s.type="text";s.setAttribute("value",r??n);if(this.data.doNotScroll){s.style.overflowX="hidden"}}if(this.data.hasOwnCanvas){s.hidden=true}GetElementsByNameSet.add(s);s.setAttribute("data-element-id",e);s.disabled=this.data.readOnly;s.name=this.data.fieldName;s.tabIndex=DEFAULT_TAB_INDEX;this._setRequired(s,this.data.required);if(a){s.maxLength=a}s.addEventListener("input",i=>{t.setValue(e,{value:i.target.value});this.setPropertyOnSiblings(s,"value",i.target.value,"value");o.formattedValue=null});s.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue??"";s.value=o.userValue=e;o.formattedValue=null});let l=t=>{const{formattedValue:e}=o;if(e!==null&&e!==undefined){t.target.value=e}t.target.scrollLeft=0};if(this.enableScripting&&this.hasJSActions){s.addEventListener("focus",t=>{if(o.focused){return}const{target:e}=t;if(o.userValue){e.value=o.userValue}o.lastCommittedValue=e.value;o.commitKey=1;if(!this.data.actions?.Focus){o.focused=true}});s.addEventListener("updatefromsandbox",s=>{this.showElementAndHideCanvas(s.target);const i={value(s){o.userValue=s.detail.value??"";t.setValue(e,{value:o.userValue.toString()});s.target.value=o.userValue},formattedValue(s){const{formattedValue:i}=s.detail;o.formattedValue=i;if(i!==null&&i!==undefined&&s.target!==document.activeElement){s.target.value=i}t.setValue(e,{formattedValue:i})},selRange(t){t.target.setSelectionRange(...t.detail.selRange)},charLimit:s=>{const{charLimit:i}=s.detail;const{target:n}=s;if(i===0){n.removeAttribute("maxLength");return}n.setAttribute("maxLength",i);let a=o.userValue;if(!a||a.length<=i){return}a=a.slice(0,i);n.value=o.userValue=a;t.setValue(e,{value:a});this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:a,willCommit:true,commitKey:1,selStart:n.selectionStart,selEnd:n.selectionEnd}})}};this._dispatchEventFromSandbox(i,s)});s.addEventListener("keydown",t=>{o.commitKey=1;let s=-1;if(t.key==="Escape"){s=0}else if(t.key==="Enter"&&!this.data.multiLine){s=2}else if(t.key==="Tab"){o.commitKey=3}if(s===-1){return}const{value:i}=t.target;if(o.lastCommittedValue===i){return}o.lastCommittedValue=i;o.userValue=i;this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:i,willCommit:true,commitKey:s,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}})});const i=l;l=null;s.addEventListener("blur",t=>{if(!o.focused||!t.relatedTarget){return}if(!this.data.actions?.Blur){o.focused=false}const{value:s}=t.target;o.userValue=s;if(o.lastCommittedValue!==s){this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:s,willCommit:true,commitKey:o.commitKey,selStart:t.target.selectionStart,selEnd:t.target.selectionEnd}})}i(t)});if(this.data.actions?.Keystroke){s.addEventListener("beforeinput",t=>{o.lastCommittedValue=null;const{data:s,target:i}=t;const{value:n,selectionStart:a,selectionEnd:r}=i;let l=a,h=r;switch(t.inputType){case"deleteWordBackward":{const t=n.substring(0,a).match(/\w*[^\w]*$/);if(t){l-=t[0].length}break}case"deleteWordForward":{const t=n.substring(a).match(/^[^\w]*\w*/);if(t){h+=t[0].length}break}case"deleteContentBackward":if(a===r){l-=1}break;case"deleteContentForward":if(a===r){h+=1}break}t.preventDefault();this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:n,change:s||"",willCommit:false,selStart:l,selEnd:h}})})}this._setEventListeners(s,o,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.value)}if(l){s.addEventListener("blur",l)}if(this.data.comb){const t=this.data.rect[2]-this.data.rect[0];const e=t/a;s.classList.add("comb");s.style.letterSpacing=`calc(${e}px * var(--scale-factor) - 1ch)`}}else{s=document.createElement("div");s.textContent=this.data.fieldValue;s.style.verticalAlign="middle";s.style.display="table-cell";if(this.data.hasOwnCanvas){s.hidden=true}}this._setTextStyle(s);this._setBackgroundColor(s);this._setDefaultPropertiesFromJS(s);this.container.append(s);return this.container}}class SignatureWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:!!t.data.hasOwnCanvas})}}class CheckboxWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){const t=this.annotationStorage;const e=this.data;const s=e.id;let i=t.getValue(s,{value:e.exportValue===e.fieldValue}).value;if(typeof i==="string"){i=i!=="Off";t.setValue(s,{value:i})}this.container.classList.add("buttonWidgetAnnotation","checkBox");const n=document.createElement("input");GetElementsByNameSet.add(n);n.setAttribute("data-element-id",s);n.disabled=e.readOnly;this._setRequired(n,this.data.required);n.type="checkbox";n.name=e.fieldName;if(i){n.setAttribute("checked",true)}n.setAttribute("exportValue",e.exportValue);n.tabIndex=DEFAULT_TAB_INDEX;n.addEventListener("change",i=>{const{name:n,checked:a}=i.target;for(const i of this._getElementsByName(n,s)){const s=a&&i.exportValue===e.exportValue;if(i.domElement){i.domElement.checked=s}t.setValue(i.id,{value:s})}t.setValue(s,{value:a})});n.addEventListener("resetform",t=>{const s=e.defaultFieldValue||"Off";t.target.checked=s===e.exportValue});if(this.enableScripting&&this.hasJSActions){n.addEventListener("updatefromsandbox",e=>{const i={value(e){e.target.checked=e.detail.value!=="Off";t.setValue(s,{value:e.target.checked})}};this._dispatchEventFromSandbox(i,e)});this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)}this._setBackgroundColor(n);this._setDefaultPropertiesFromJS(n);this.container.append(n);return this.container}}class RadioButtonWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("buttonWidgetAnnotation","radioButton");const t=this.annotationStorage;const e=this.data;const s=e.id;let i=t.getValue(s,{value:e.fieldValue===e.buttonValue}).value;if(typeof i==="string"){i=i!==e.buttonValue;t.setValue(s,{value:i})}if(i){for(const i of this._getElementsByName(e.fieldName,s)){t.setValue(i.id,{value:false})}}const n=document.createElement("input");GetElementsByNameSet.add(n);n.setAttribute("data-element-id",s);n.disabled=e.readOnly;this._setRequired(n,this.data.required);n.type="radio";n.name=e.fieldName;if(i){n.setAttribute("checked",true)}n.tabIndex=DEFAULT_TAB_INDEX;n.addEventListener("change",e=>{const{name:i,checked:n}=e.target;for(const e of this._getElementsByName(i,s)){t.setValue(e.id,{value:false})}t.setValue(s,{value:n})});n.addEventListener("resetform",t=>{const s=e.defaultFieldValue;t.target.checked=s!==null&&s!==undefined&&s===e.buttonValue});if(this.enableScripting&&this.hasJSActions){const i=e.buttonValue;n.addEventListener("updatefromsandbox",e=>{const n={value:e=>{const n=i===e.detail.value;for(const i of this._getElementsByName(e.target.name)){const e=n&&i.id===s;if(i.domElement){i.domElement.checked=e}t.setValue(i.id,{value:e})}}};this._dispatchEventFromSandbox(n,e)});this._setEventListeners(n,null,[["change","Validate"],["change","Action"],["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"]],t=>t.target.checked)}this._setBackgroundColor(n);this._setDefaultPropertiesFromJS(n);this.container.append(n);return this.container}}class PushButtonWidgetAnnotationElement extends LinkAnnotationElement{constructor(t){super(t,{ignoreBorder:t.data.hasAppearance})}render(){const t=super.render();t.classList.add("buttonWidgetAnnotation","pushButton");const e=t.lastChild;if(this.enableScripting&&this.hasJSActions&&e){this._setDefaultPropertiesFromJS(e);e.addEventListener("updatefromsandbox",t=>{this._dispatchEventFromSandbox({},t)})}return t}}class ChoiceWidgetAnnotationElement extends WidgetAnnotationElement{constructor(t){super(t,{isRenderable:t.renderForms})}render(){this.container.classList.add("choiceWidgetAnnotation");const t=this.annotationStorage;const e=this.data.id;const s=t.getValue(e,{value:this.data.fieldValue});const i=document.createElement("select");GetElementsByNameSet.add(i);i.setAttribute("data-element-id",e);i.disabled=this.data.readOnly;this._setRequired(i,this.data.required);i.name=this.data.fieldName;i.tabIndex=DEFAULT_TAB_INDEX;let n=this.data.combo&&this.data.options.length>0;if(!this.data.combo){i.size=this.data.options.length;if(this.data.multiSelect){i.multiple=true}}i.addEventListener("resetform",t=>{const e=this.data.defaultFieldValue;for(const t of i.options){t.selected=t.value===e}});for(const t of this.data.options){const e=document.createElement("option");e.textContent=t.displayValue;e.value=t.exportValue;if(s.value.includes(t.exportValue)){e.setAttribute("selected",true);n=false}i.append(e)}let a=null;if(n){const t=document.createElement("option");t.value=" ";t.setAttribute("hidden",true);t.setAttribute("selected",true);i.prepend(t);a=()=>{t.remove();i.removeEventListener("input",a);a=null};i.addEventListener("input",a)}const r=t=>{const e=t?"value":"textContent";const{options:s,multiple:n}=i;if(!n){return s.selectedIndex===-1?null:s[s.selectedIndex][e]}return Array.prototype.filter.call(s,t=>t.selected).map(t=>t[e])};let o=r(false);const l=t=>{const e=t.target.options;return Array.prototype.map.call(e,t=>({displayValue:t.textContent,exportValue:t.value}))};if(this.enableScripting&&this.hasJSActions){i.addEventListener("updatefromsandbox",s=>{const n={value(s){a?.();const n=s.detail.value;const l=new Set(Array.isArray(n)?n:[n]);for(const t of i.options){t.selected=l.has(t.value)}t.setValue(e,{value:r(true)});o=r(false)},multipleSelection(t){i.multiple=true},remove(s){const n=i.options;const a=s.detail.remove;n[a].selected=false;i.remove(a);if(n.length>0){const t=Array.prototype.findIndex.call(n,t=>t.selected);if(t===-1){n[0].selected=true}}t.setValue(e,{value:r(true),items:l(s)});o=r(false)},clear(s){while(i.length!==0){i.remove(0)}t.setValue(e,{value:null,items:[]});o=r(false)},insert(s){const{index:n,displayValue:a,exportValue:h}=s.detail.insert;const c=i.children[n];const d=document.createElement("option");d.textContent=a;d.value=h;if(c){c.before(d)}else{i.append(d)}t.setValue(e,{value:r(true),items:l(s)});o=r(false)},items(s){const{items:n}=s.detail;while(i.length!==0){i.remove(0)}for(const t of n){const{displayValue:e,exportValue:s}=t;const n=document.createElement("option");n.textContent=e;n.value=s;i.append(n)}if(i.options.length>0){i.options[0].selected=true}t.setValue(e,{value:r(true),items:l(s)});o=r(false)},indices(s){const i=new Set(s.detail.indices);for(const t of s.target.options){t.selected=i.has(t.index)}t.setValue(e,{value:r(true)});o=r(false)},editable(t){t.target.disabled=!t.detail.editable}};this._dispatchEventFromSandbox(n,s)});i.addEventListener("input",s=>{const i=r(true);const n=r(false);t.setValue(e,{value:i});s.preventDefault();this.linkService.eventBus?.dispatch("dispatcheventinsandbox",{source:this,detail:{id:e,name:"Keystroke",value:o,change:n,changeEx:i,willCommit:false,commitKey:1,keyDown:false}})});this._setEventListeners(i,null,[["focus","Focus"],["blur","Blur"],["mousedown","Mouse Down"],["mouseenter","Mouse Enter"],["mouseleave","Mouse Exit"],["mouseup","Mouse Up"],["input","Action"],["input","Validate"]],t=>t.target.value)}else{i.addEventListener("input",function(s){t.setValue(e,{value:r(true)})})}if(this.data.combo){this._setTextStyle(i)}else{}this._setBackgroundColor(i);this._setDefaultPropertiesFromJS(i);this.container.append(i);return this.container}}class PopupAnnotationElement extends AnnotationElement{constructor(t){const{data:e,elements:s}=t;super(t,{isRenderable:AnnotationElement._hasPopupData(e)});this.elements=s;this.popup=null}render(){this.container.classList.add("popupAnnotation");const t=this.popup=new PopupElement({container:this.container,color:this.data.color,titleObj:this.data.titleObj,modificationDate:this.data.modificationDate,contentsObj:this.data.contentsObj,richText:this.data.richText,rect:this.data.rect,parentRect:this.data.parentRect||null,parent:this.parent,elements:this.elements,open:this.data.open});const e=[];for(const s of this.elements){s.popup=t;e.push(s.data.id);s.addHighlightArea()}this.container.setAttribute("aria-controls",e.map(t=>`${AnnotationPrefix}${t}`).join(","));return this.container}}class PopupElement{#ci=this.#di.bind(this);#ui=this.#pi.bind(this);#gi=this.#fi.bind(this);#mi=this.#bi.bind(this);#_i=null;#It=null;#Ai=null;#vi=null;#yi=null;#Ei=null;#wi=null;#xi=false;#Ti=null;#H=null;#Si=null;#Ci=null;#Pi=null;#ii=null;#Mi=false;constructor({container:t,color:e,elements:s,titleObj:i,modificationDate:n,contentsObj:a,richText:r,parent:o,rect:l,parentRect:h,open:c}){this.#It=t;this.#Pi=i;this.#Ai=a;this.#Ci=r;this.#Ei=o;this.#_i=e;this.#Si=l;this.#wi=h;this.#yi=s;this.#vi=PDFDateString.toDateObject(n);this.trigger=s.flatMap(t=>t.getElementsToTriggerPopup());for(const t of this.trigger){t.addEventListener("click",this.#mi);t.addEventListener("mouseenter",this.#gi);t.addEventListener("mouseleave",this.#ui);t.classList.add("popupTriggerArea")}for(const t of s){t.container?.addEventListener("keydown",this.#ci)}this.#It.hidden=true;if(c){this.#bi()}}render(){if(this.#Ti){return}const t=this.#Ti=document.createElement("div");t.className="popup";if(this.#_i){const e=t.style.outlineColor=Util.makeHexColor(...this.#_i);if(CSS.supports("background-color","color-mix(in srgb, red 30%, white)")){t.style.backgroundColor=`color-mix(in srgb, ${e} 30%, white)`}else{const e=.7;t.style.backgroundColor=Util.makeHexColor(...this.#_i.map(t=>Math.floor(e*(255-t)+t)))}}const e=document.createElement("span");e.className="header";const s=document.createElement("h1");e.append(s);({dir:s.dir,str:s.textContent}=this.#Pi);t.append(e);if(this.#vi){const t=document.createElement("span");t.classList.add("popupDate");t.setAttribute("data-l10n-id","pdfjs-annotation-date-string");t.setAttribute("data-l10n-args",JSON.stringify({date:this.#vi.toLocaleDateString(),time:this.#vi.toLocaleTimeString()}));e.append(t)}const i=this.#ki;if(i){XfaLayer.render({xfaHtml:i,intent:"richText",div:t});t.lastChild.classList.add("richText","popupContent")}else{const e=this._formatContents(this.#Ai);t.append(e)}this.#It.append(t)}get#ki(){const t=this.#Ci;const e=this.#Ai;if(t?.str&&(!e?.str||e.str===t.str)){return this.#Ci.html||null}return null}get#Ii(){return this.#ki?.attributes?.style?.fontSize||0}get#Ri(){return this.#ki?.attributes?.style?.color||null}#Fi(t){const e=[];const s={str:t,html:{name:"div",attributes:{dir:"auto"},children:[{name:"p",children:e}]}};const i={style:{color:this.#Ri,fontSize:this.#Ii?`calc(${this.#Ii}px * var(--scale-factor))`:""}};for(const s of t.split("\n")){e.push({name:"span",value:s,attributes:i})}return s}_formatContents({str:t,dir:e}){const s=document.createElement("p");s.classList.add("popupContent");s.dir=e;const i=t.split(/(?:\r\n?|\n)/);for(let t=0,e=i.length;t<e;++t){const n=i[t];s.append(document.createTextNode(n));if(t<e-1){s.append(document.createElement("br"))}}return s}#di(t){if(t.altKey||t.shiftKey||t.ctrlKey||t.metaKey){return}if(t.key==="Enter"||t.key==="Escape"&&this.#xi){this.#bi()}}updateEdited({rect:t,popupContent:e}){this.#ii||={contentsObj:this.#Ai,richText:this.#Ci};if(t){this.#H=null}if(e){this.#Ci=this.#Fi(e);this.#Ai=null}this.#Ti?.remove();this.#Ti=null}resetEdited(){if(!this.#ii){return}({contentsObj:this.#Ai,richText:this.#Ci}=this.#ii);this.#ii=null;this.#Ti?.remove();this.#Ti=null;this.#H=null}#Li(){if(this.#H!==null){return}const{page:{view:t},viewport:{rawDims:{pageWidth:e,pageHeight:s,pageX:i,pageY:n}}}=this.#Ei;let a=!!this.#wi;let r=a?this.#wi:this.#Si;for(const t of this.#yi){if(!r||Util.intersect(t.data.rect,r)!==null){r=t.data.rect;a=true;break}}const o=Util.normalizeRect([r[0],t[3]-r[1]+t[1],r[2],t[3]-r[3]+t[1]]);const l=5;const h=a?r[2]-r[0]+l:0;const c=o[0]+h;const d=o[1];this.#H=[100*(c-i)/e,100*(d-n)/s];const{style:u}=this.#It;u.left=`${this.#H[0]}%`;u.top=`${this.#H[1]}%`}#bi(){this.#xi=!this.#xi;if(this.#xi){this.#fi();this.#It.addEventListener("click",this.#mi);this.#It.addEventListener("keydown",this.#ci)}else{this.#pi();this.#It.removeEventListener("click",this.#mi);this.#It.removeEventListener("keydown",this.#ci)}}#fi(){if(!this.#Ti){this.render()}if(!this.isVisible){this.#Li();this.#It.hidden=false;this.#It.style.zIndex=parseInt(this.#It.style.zIndex)+1e3}else if(this.#xi){this.#It.classList.add("focused")}}#pi(){this.#It.classList.remove("focused");if(this.#xi||!this.isVisible){return}this.#It.hidden=true;this.#It.style.zIndex=parseInt(this.#It.style.zIndex)-1e3}forceHide(){this.#Mi=this.isVisible;if(!this.#Mi){return}this.#It.hidden=true}maybeShow(){if(!this.#Mi){return}if(!this.#Ti){this.#fi()}this.#Mi=false;this.#It.hidden=false}get isVisible(){return this.#It.hidden===false}}class FreeTextAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.textContent=t.data.textContent;this.textPosition=t.data.textPosition;this.annotationEditorType=AnnotationEditorType.FREETEXT}render(){this.container.classList.add("freeTextAnnotation");if(this.textContent){const t=document.createElement("div");t.classList.add("annotationTextContent");t.setAttribute("role","comment");for(const e of this.textContent){const s=document.createElement("span");s.textContent=e;t.append(s)}this.container.append(t)}if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this._editOnDoubleClick();return this.container}get _isEditable(){return this.data.hasOwnCanvas}}class LineAnnotationElement extends AnnotationElement{#Di=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("lineAnnotation");const t=this.data;const{width:e,height:s}=getRectDims(t.rect);const i=this.svgFactory.create(e,s,true);const n=this.#Di=this.svgFactory.createElement("svg:line");n.setAttribute("x1",t.rect[2]-t.lineCoordinates[0]);n.setAttribute("y1",t.rect[3]-t.lineCoordinates[1]);n.setAttribute("x2",t.rect[2]-t.lineCoordinates[2]);n.setAttribute("y2",t.rect[3]-t.lineCoordinates[3]);n.setAttribute("stroke-width",t.borderStyle.width||1);n.setAttribute("stroke","transparent");n.setAttribute("fill","transparent");i.append(n);this.container.append(i);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Di}addHighlightArea(){this.container.classList.add("highlightArea")}}class SquareAnnotationElement extends AnnotationElement{#Oi=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("squareAnnotation");const t=this.data;const{width:e,height:s}=getRectDims(t.rect);const i=this.svgFactory.create(e,s,true);const n=t.borderStyle.width;const a=this.#Oi=this.svgFactory.createElement("svg:rect");a.setAttribute("x",n/2);a.setAttribute("y",n/2);a.setAttribute("width",e-n);a.setAttribute("height",s-n);a.setAttribute("stroke-width",n||1);a.setAttribute("stroke","transparent");a.setAttribute("fill","transparent");i.append(a);this.container.append(i);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Oi}addHighlightArea(){this.container.classList.add("highlightArea")}}class CircleAnnotationElement extends AnnotationElement{#Ni=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("circleAnnotation");const t=this.data;const{width:e,height:s}=getRectDims(t.rect);const i=this.svgFactory.create(e,s,true);const n=t.borderStyle.width;const a=this.#Ni=this.svgFactory.createElement("svg:ellipse");a.setAttribute("cx",e/2);a.setAttribute("cy",s/2);a.setAttribute("rx",e/2-n/2);a.setAttribute("ry",s/2-n/2);a.setAttribute("stroke-width",n||1);a.setAttribute("stroke","transparent");a.setAttribute("fill","transparent");i.append(a);this.container.append(i);if(!t.popupRef&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Ni}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolylineAnnotationElement extends AnnotationElement{#Bi=null;constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.containerClassName="polylineAnnotation";this.svgElementName="svg:polyline"}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,vertices:e,borderStyle:s,popupRef:i}}=this;if(!e){return this.container}const{width:n,height:a}=getRectDims(t);const r=this.svgFactory.create(n,a,true);let o=[];for(let s=0,i=e.length;s<i;s+=2){const i=e[s]-t[0];const n=t[3]-e[s+1];o.push(`${i},${n}`)}o=o.join(" ");const l=this.#Bi=this.svgFactory.createElement(this.svgElementName);l.setAttribute("points",o);l.setAttribute("stroke-width",s.width||1);l.setAttribute("stroke","transparent");l.setAttribute("fill","transparent");r.append(l);this.container.append(r);if(!i&&this.hasPopupData){this._createPopup()}return this.container}getElementsToTriggerPopup(){return this.#Bi}addHighlightArea(){this.container.classList.add("highlightArea")}}class PolygonAnnotationElement extends PolylineAnnotationElement{constructor(t){super(t);this.containerClassName="polygonAnnotation";this.svgElementName="svg:polygon"}}class CaretAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("caretAnnotation");if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}return this.container}}class InkAnnotationElement extends AnnotationElement{#Hi=[];constructor(t){super(t,{isRenderable:true,ignoreBorder:true});this.containerClassName="inkAnnotation";this.svgElementName="svg:polyline";this.annotationEditorType=AnnotationEditorType.INK}render(){this.container.classList.add(this.containerClassName);const{data:{rect:t,inkLists:e,borderStyle:s,popupRef:i}}=this;const{width:n,height:a}=getRectDims(t);const r=this.svgFactory.create(n,a,true);for(const n of e){let e=[];for(let s=0,i=n.length;s<i;s+=2){const i=n[s]-t[0];const a=t[3]-n[s+1];e.push(`${i},${a}`)}e=e.join(" ");const a=this.svgFactory.createElement(this.svgElementName);this.#Hi.push(a);a.setAttribute("points",e);a.setAttribute("stroke-width",s.width||1);a.setAttribute("stroke","transparent");a.setAttribute("fill","transparent");if(!i&&this.hasPopupData){this._createPopup()}r.append(a)}this.container.append(r);return this.container}getElementsToTriggerPopup(){return this.#Hi}addHighlightArea(){this.container.classList.add("highlightArea")}}class HighlightAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.classList.add("highlightAnnotation");return this.container}}class UnderlineAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.classList.add("underlineAnnotation");return this.container}}class SquigglyAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.classList.add("squigglyAnnotation");return this.container}}class StrikeOutAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true,createQuadrilaterals:true})}render(){if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}this.container.classList.add("strikeoutAnnotation");return this.container}}class StampAnnotationElement extends AnnotationElement{constructor(t){super(t,{isRenderable:true,ignoreBorder:true})}render(){this.container.classList.add("stampAnnotation");if(!this.data.popupRef&&this.hasPopupData){this._createPopup()}return this.container}}class FileAttachmentAnnotationElement extends AnnotationElement{#Ui=null;constructor(t){super(t,{isRenderable:true});const{file:e}=this.data;this.filename=e.filename;this.content=e.content;this.linkService.eventBus?.dispatch("fileattachmentannotation",{source:this,...e})}render(){this.container.classList.add("fileAttachmentAnnotation");const{container:t,data:e}=this;let s;if(e.hasAppearance||e.fillAlpha===0){s=document.createElement("div")}else{s=document.createElement("img");s.src=`${this.imageResourcesPath}annotation-${/paperclip/i.test(e.name)?"paperclip":"pushpin"}.svg`;if(e.fillAlpha&&e.fillAlpha<1){s.style=`filter: opacity(${Math.round(e.fillAlpha*100)}%);`}}s.addEventListener("dblclick",this.#zi.bind(this));this.#Ui=s;const{isMac:i}=util_FeatureTest.platform;t.addEventListener("keydown",t=>{if(t.key==="Enter"&&(i?t.metaKey:t.ctrlKey)){this.#zi()}});if(!e.popupRef&&this.hasPopupData){this._createPopup()}else{s.classList.add("popupTriggerArea")}t.append(s);return t}getElementsToTriggerPopup(){return this.#Ui}addHighlightArea(){this.container.classList.add("highlightArea")}#zi(){this.downloadManager?.openOrDownloadData(this.content,this.filename)}}class AnnotationLayer{#Gi=null;#Vi=null;#Wi=new Map;constructor({div:t,accessibilityManager:e,annotationCanvasMap:s,annotationEditorUIManager:i,page:n,viewport:a}){this.div=t;this.#Gi=e;this.#Vi=s;this.page=n;this.viewport=a;this.zIndex=0;this._annotationEditorUIManager=i}#ji(t,e){const s=t.firstChild||t;s.id=`${AnnotationPrefix}${e}`;this.div.append(t);this.#Gi?.moveElementInDOM(this.div,t,s,false)}async render(t){const{annotations:e}=t;const s=this.div;setLayerDimensions(s,this.viewport);const i=new Map;const n={data:null,layer:s,linkService:t.linkService,downloadManager:t.downloadManager,imageResourcesPath:t.imageResourcesPath||"",renderForms:t.renderForms!==false,svgFactory:new DOMSVGFactory,annotationStorage:t.annotationStorage||new AnnotationStorage,enableScripting:t.enableScripting===true,hasJSActions:t.hasJSActions,fieldObjects:t.fieldObjects,parent:this,elements:null};for(const t of e){if(t.noHTML){continue}const e=t.annotationType===AnnotationType.POPUP;if(!e){const{width:e,height:s}=getRectDims(t.rect);if(e<=0||s<=0){continue}}else{const e=i.get(t.id);if(!e){continue}n.elements=e}n.data=t;const s=AnnotationElementFactory.create(n);if(!s.isRenderable){continue}if(!e&&t.popupRef){const e=i.get(t.popupRef);if(!e){i.set(t.popupRef,[s])}else{e.push(s)}}const a=s.render();if(t.hidden){a.style.visibility="hidden"}this.#ji(a,t.id);if(s.annotationEditorType>0){this.#Wi.set(s.data.id,s);this._annotationEditorUIManager?.renderAnnotationElement(s)}}this.#$i()}update({viewport:t}){const e=this.div;this.viewport=t;setLayerDimensions(e,{rotation:t.rotation});this.#$i();e.hidden=false}#$i(){if(!this.#Vi){return}const t=this.div;for(const[e,s]of this.#Vi){const i=t.querySelector(`[data-annotation-id="${e}"]`);if(!i){continue}s.className="annotationContent";const{firstChild:n}=i;if(!n){i.append(s)}else if(n.nodeName==="CANVAS"){n.replaceWith(s)}else if(!n.classList.contains("annotationContent")){n.before(s)}else{n.after(s)}}this.#Vi.clear()}getEditableAnnotations(){return Array.from(this.#Wi.values())}getEditableAnnotation(t){return this.#Wi.get(t)}}const EOL_PATTERN=/\r\n?|\n/g;class FreeTextEditor extends AnnotationEditor{#Ki=this.editorDivBlur.bind(this);#qi=this.editorDivFocus.bind(this);#Xi=this.editorDivInput.bind(this);#Yi=this.editorDivKeydown.bind(this);#Ji=this.editorDivPaste.bind(this);#_i;#Qi="";#Zi=`${this.id}-editor`;#Ii;#tn=null;static _freeTextDefaultContent="";static _internalPadding=0;static _defaultColor=null;static _defaultFontSize=10;static get _keyboardManager(){const t=FreeTextEditor.prototype;const e=t=>t.isEmpty();const s=AnnotationEditorUIManager.TRANSLATE_SMALL;const i=AnnotationEditorUIManager.TRANSLATE_BIG;return shadow(this,"_keyboardManager",new KeyboardManager([[["ctrl+s","mac+meta+s","ctrl+p","mac+meta+p"],t.commitOrRemove,{bubbles:true}],[["ctrl+Enter","mac+meta+Enter","Escape","mac+Escape"],t.commitOrRemove],[["ArrowLeft","mac+ArrowLeft"],t._translateEmpty,{args:[-s,0],checker:e}],[["ctrl+ArrowLeft","mac+shift+ArrowLeft"],t._translateEmpty,{args:[-i,0],checker:e}],[["ArrowRight","mac+ArrowRight"],t._translateEmpty,{args:[s,0],checker:e}],[["ctrl+ArrowRight","mac+shift+ArrowRight"],t._translateEmpty,{args:[i,0],checker:e}],[["ArrowUp","mac+ArrowUp"],t._translateEmpty,{args:[0,-s],checker:e}],[["ctrl+ArrowUp","mac+shift+ArrowUp"],t._translateEmpty,{args:[0,-i],checker:e}],[["ArrowDown","mac+ArrowDown"],t._translateEmpty,{args:[0,s],checker:e}],[["ctrl+ArrowDown","mac+shift+ArrowDown"],t._translateEmpty,{args:[0,i],checker:e}]]))}static _type="freetext";static _editorType=AnnotationEditorType.FREETEXT;constructor(t){super({...t,name:"freeTextEditor"});this.#_i=t.color||FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor;this.#Ii=t.fontSize||FreeTextEditor._defaultFontSize}static initialize(t,e){AnnotationEditor.initialize(t,e,{strings:["pdfjs-free-text-default-content"]});const s=getComputedStyle(document.documentElement);this._internalPadding=parseFloat(s.getPropertyValue("--freetext-padding"))}static updateDefaultParams(t,e){switch(t){case AnnotationEditorParamsType.FREETEXT_SIZE:FreeTextEditor._defaultFontSize=e;break;case AnnotationEditorParamsType.FREETEXT_COLOR:FreeTextEditor._defaultColor=e;break}}updateParams(t,e){switch(t){case AnnotationEditorParamsType.FREETEXT_SIZE:this.#en(e);break;case AnnotationEditorParamsType.FREETEXT_COLOR:this.#sn(e);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,FreeTextEditor._defaultFontSize],[AnnotationEditorParamsType.FREETEXT_COLOR,FreeTextEditor._defaultColor||AnnotationEditor._defaultLineColor]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.FREETEXT_SIZE,this.#Ii],[AnnotationEditorParamsType.FREETEXT_COLOR,this.#_i]]}#en(t){const e=t=>{this.editorDiv.style.fontSize=`calc(${t}px * var(--scale-factor))`;this.translate(0,-(t-this.#Ii)*this.parentScale);this.#Ii=t;this.#in()};const s=this.#Ii;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.FREETEXT_SIZE,overwriteIfSameType:true,keepUndo:true})}#sn(t){const e=t=>{this.#_i=this.editorDiv.style.color=t};const s=this.#_i;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.FREETEXT_COLOR,overwriteIfSameType:true,keepUndo:true})}_translateEmpty(t,e){this._uiManager.translateSelectedEditors(t,e,true)}getInitialTranslation(){const t=this.parentScale;return[-FreeTextEditor._internalPadding*t,-(FreeTextEditor._internalPadding+this.#Ii)*t]}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}if(!this.isAttachedToDOM){this.parent.add(this)}}enableEditMode(){if(this.isInEditMode()){return}this.parent.setEditingState(false);this.parent.updateToolbar(AnnotationEditorType.FREETEXT);super.enableEditMode();this.overlayDiv.classList.remove("enabled");this.editorDiv.contentEditable=true;this._isDraggable=false;this.div.removeAttribute("aria-activedescendant");const t=this._uiManager._signal;this.editorDiv.addEventListener("keydown",this.#Yi,{signal:t});this.editorDiv.addEventListener("focus",this.#qi,{signal:t});this.editorDiv.addEventListener("blur",this.#Ki,{signal:t});this.editorDiv.addEventListener("input",this.#Xi,{signal:t});this.editorDiv.addEventListener("paste",this.#Ji,{signal:t})}disableEditMode(){if(!this.isInEditMode()){return}this.parent.setEditingState(true);super.disableEditMode();this.overlayDiv.classList.add("enabled");this.editorDiv.contentEditable=false;this.div.setAttribute("aria-activedescendant",this.#Zi);this._isDraggable=true;this.editorDiv.removeEventListener("keydown",this.#Yi);this.editorDiv.removeEventListener("focus",this.#qi);this.editorDiv.removeEventListener("blur",this.#Ki);this.editorDiv.removeEventListener("input",this.#Xi);this.editorDiv.removeEventListener("paste",this.#Ji);this.div.focus({preventScroll:true});this.isEditing=false;this.parent.div.classList.add("freetextEditing")}focusin(t){if(!this._focusEventsAllowed){return}super.focusin(t);if(t.target!==this.editorDiv){this.editorDiv.focus()}}onceAdded(){if(this.width){return}this.enableEditMode();this.editorDiv.focus();if(this._initialOptions?.isCentered){this.center()}this._initialOptions=null}isEmpty(){return!this.editorDiv||this.editorDiv.innerText.trim()===""}remove(){this.isEditing=false;if(this.parent){this.parent.setEditingState(true);this.parent.div.classList.add("freetextEditing")}super.remove()}#nn(){const t=[];this.editorDiv.normalize();for(const e of this.editorDiv.childNodes){t.push(FreeTextEditor.#an(e))}return t.join("\n")}#in(){const[t,e]=this.parentDimensions;let s;if(this.isAttachedToDOM){s=this.div.getBoundingClientRect()}else{const{currentLayer:t,div:e}=this;const i=e.style.display;const n=e.classList.contains("hidden");e.classList.remove("hidden");e.style.display="hidden";t.div.append(this.div);s=e.getBoundingClientRect();e.remove();e.style.display=i;e.classList.toggle("hidden",n)}if(this.rotation%180===this.parentRotation%180){this.width=s.width/t;this.height=s.height/e}else{this.width=s.height/t;this.height=s.width/e}this.fixAndSetPosition()}commit(){if(!this.isInEditMode()){return}super.commit();this.disableEditMode();const t=this.#Qi;const e=this.#Qi=this.#nn().trimEnd();if(t===e){return}const s=t=>{this.#Qi=t;if(!t){this.remove();return}this.#rn();this._uiManager.rebuild(this);this.#in()};this.addCommands({cmd:()=>{s(e)},undo:()=>{s(t)},mustExec:false});this.#in()}shouldGetKeyboardEvents(){return this.isInEditMode()}enterInEditMode(){this.enableEditMode();this.editorDiv.focus()}dblclick(t){this.enterInEditMode()}keydown(t){if(t.target===this.div&&t.key==="Enter"){this.enterInEditMode();t.preventDefault()}}editorDivKeydown(t){FreeTextEditor._keyboardManager.exec(this,t)}editorDivFocus(t){this.isEditing=true}editorDivBlur(t){this.isEditing=false}editorDivInput(t){this.parent.div.classList.toggle("freetextEditing",this.isEmpty())}disableEditing(){this.editorDiv.setAttribute("role","comment");this.editorDiv.removeAttribute("aria-multiline")}enableEditing(){this.editorDiv.setAttribute("role","textbox");this.editorDiv.setAttribute("aria-multiline",true)}render(){if(this.div){return this.div}let t,e;if(this.width){t=this.x;e=this.y}super.render();this.editorDiv=document.createElement("div");this.editorDiv.className="internal";this.editorDiv.setAttribute("id",this.#Zi);this.editorDiv.setAttribute("data-l10n-id","pdfjs-free-text");this.enableEditing();AnnotationEditor._l10nPromise.get("pdfjs-free-text-default-content").then(t=>this.editorDiv?.setAttribute("default-content",t));this.editorDiv.contentEditable=true;const{style:s}=this.editorDiv;s.fontSize=`calc(${this.#Ii}px * var(--scale-factor))`;s.color=this.#_i;this.div.append(this.editorDiv);this.overlayDiv=document.createElement("div");this.overlayDiv.classList.add("overlay","enabled");this.div.append(this.overlayDiv);bindEvents(this,this.div,["dblclick","keydown"]);if(this.width){const[s,i]=this.parentDimensions;if(this.annotationElementId){const{position:n}=this.#tn;let[a,r]=this.getInitialTranslation();[a,r]=this.pageTranslationToScreen(a,r);const[o,l]=this.pageDimensions;const[h,c]=this.pageTranslation;let d,u;switch(this.rotation){case 0:d=t+(n[0]-h)/o;u=e+this.height-(n[1]-c)/l;break;case 90:d=t+(n[0]-h)/o;u=e-(n[1]-c)/l;[a,r]=[r,-a];break;case 180:d=t-this.width+(n[0]-h)/o;u=e-(n[1]-c)/l;[a,r]=[-a,-r];break;case 270:d=t+(n[0]-h-this.height*l)/o;u=e+(n[1]-c-this.width*o)/l;[a,r]=[-r,a];break}this.setAt(d*s,u*i,a,r)}else{this.setAt(t*s,e*i,this.width*s,this.height*i)}this.#rn();this._isDraggable=true;this.editorDiv.contentEditable=false}else{this._isDraggable=false;this.editorDiv.contentEditable=true}return this.div}static#an(t){return(t.nodeType===Node.TEXT_NODE?t.nodeValue:t.innerText).replaceAll(EOL_PATTERN,"")}editorDivPaste(t){const e=t.clipboardData||window.clipboardData;const{types:s}=e;if(s.length===1&&s[0]==="text/plain"){return}t.preventDefault();const i=FreeTextEditor.#on(e.getData("text")||"").replaceAll(EOL_PATTERN,"\n");if(!i){return}const n=window.getSelection();if(!n.rangeCount){return}this.editorDiv.normalize();n.deleteFromDocument();const a=n.getRangeAt(0);if(!i.includes("\n")){a.insertNode(document.createTextNode(i));this.editorDiv.normalize();n.collapseToStart();return}const{startContainer:r,startOffset:o}=a;const l=[];const h=[];if(r.nodeType===Node.TEXT_NODE){const t=r.parentElement;h.push(r.nodeValue.slice(o).replaceAll(EOL_PATTERN,""));if(t!==this.editorDiv){let e=l;for(const s of this.editorDiv.childNodes){if(s===t){e=h;continue}e.push(FreeTextEditor.#an(s))}}l.push(r.nodeValue.slice(0,o).replaceAll(EOL_PATTERN,""))}else if(r===this.editorDiv){let t=l;let e=0;for(const s of this.editorDiv.childNodes){if(e++===o){t=h}t.push(FreeTextEditor.#an(s))}}this.#Qi=`${l.join("\n")}${i}${h.join("\n")}`;this.#rn();const c=new Range;let d=l.reduce((t,e)=>t+e.length,0);for(const{firstChild:t}of this.editorDiv.childNodes){if(t.nodeType===Node.TEXT_NODE){const e=t.nodeValue.length;if(d<=e){c.setStart(t,d);c.setEnd(t,d);break}d-=e}}n.removeAllRanges();n.addRange(c)}#rn(){this.editorDiv.replaceChildren();if(!this.#Qi){return}for(const t of this.#Qi.split("\n")){const e=document.createElement("div");e.append(t?document.createTextNode(t):document.createElement("br"));this.editorDiv.append(e)}}#ln(){return this.#Qi.replaceAll(" "," ")}static#on(t){return t.replaceAll(" "," ")}get contentDiv(){return this.editorDiv}static deserialize(t,e,s){let i=null;if(t instanceof FreeTextAnnotationElement){const{data:{defaultAppearanceData:{fontSize:e,fontColor:s},rect:n,rotation:a,id:r},textContent:o,textPosition:l,parent:{page:{pageNumber:h}}}=t;if(!o||o.length===0){return null}i=t={annotationType:AnnotationEditorType.FREETEXT,color:Array.from(s),fontSize:e,value:o.join("\n"),position:l,pageIndex:h-1,rect:n.slice(0),rotation:a,id:r,deleted:false}}const n=super.deserialize(t,e,s);n.#Ii=t.fontSize;n.#_i=Util.makeHexColor(...t.color);n.#Qi=FreeTextEditor.#on(t.value);n.annotationElementId=t.id||null;n.#tn=i;return n}serialize(t=false){if(this.isEmpty()){return null}if(this.deleted){return{pageIndex:this.pageIndex,id:this.annotationElementId,deleted:true}}const e=FreeTextEditor._internalPadding*this.parentScale;const s=this.getRect(e,e);const i=AnnotationEditor._colorManager.convert(this.isAttachedToDOM?getComputedStyle(this.editorDiv).color:this.#_i);const n={annotationType:AnnotationEditorType.FREETEXT,color:i,fontSize:this.#Ii,value:this.#ln(),pageIndex:this.pageIndex,rect:s,rotation:this.rotation,structTreeParentId:this._structTreeParentId};if(t){return n}if(this.annotationElementId&&!this.#hn(n)){return null}n.id=this.annotationElementId;return n}#hn(t){const{value:e,fontSize:s,color:i,pageIndex:n}=this.#tn;return this._hasBeenMoved||t.value!==e||t.fontSize!==s||t.color.some((t,e)=>t!==i[e])||t.pageIndex!==n}renderAnnotationElement(t){const e=super.renderAnnotationElement(t);if(this.deleted){return e}const{style:s}=e;s.fontSize=`calc(${this.#Ii}px * var(--scale-factor))`;s.color=this.#_i;e.replaceChildren();for(const t of this.#Qi.split("\n")){const s=document.createElement("div");s.append(t?document.createTextNode(t):document.createElement("br"));e.append(s)}const i=FreeTextEditor._internalPadding*this.parentScale;t.updateEdited({rect:this.getRect(i,i),popupContent:this.#Qi});return e}resetAnnotationElement(t){super.resetAnnotationElement(t);t.resetEdited()}}class Outliner{#cn;#dn=[];#un=[];constructor(t,e=0,s=0,i=true){let n=Infinity;let a=-Infinity;let r=Infinity;let o=-Infinity;const l=4;const h=10**-l;for(const{x:s,y:i,width:l,height:c}of t){const t=Math.floor((s-e)/h)*h;const d=Math.ceil((s+l+e)/h)*h;const u=Math.floor((i-e)/h)*h;const p=Math.ceil((i+c+e)/h)*h;const g=[t,u,p,true];const f=[d,u,p,false];this.#dn.push(g,f);n=Math.min(n,t);a=Math.max(a,d);r=Math.min(r,u);o=Math.max(o,p)}const c=a-n+2*s;const d=o-r+2*s;const u=n-s;const p=r-s;const g=this.#dn.at(i?-1:-2);const f=[g[0],g[2]];for(const t of this.#dn){const[e,s,i]=t;t[0]=(e-u)/c;t[1]=(s-p)/d;t[2]=(i-p)/d}this.#cn={x:u,y:p,width:c,height:d,lastPoint:f}}getOutlines(){this.#dn.sort((t,e)=>t[0]-e[0]||t[1]-e[1]||t[2]-e[2]);const t=[];for(const e of this.#dn){if(e[3]){t.push(...this.#pn(e));this.#gn(e)}else{this.#fn(e);t.push(...this.#pn(e))}}return this.#mn(t)}#mn(t){const e=[];const s=new Set;for(const s of t){const[t,i,n]=s;e.push([t,i,s],[t,n,s])}e.sort((t,e)=>t[1]-e[1]||t[0]-e[0]);for(let t=0,i=e.length;t<i;t+=2){const i=e[t][2];const n=e[t+1][2];i.push(n);n.push(i);s.add(i);s.add(n)}const i=[];let n;while(s.size>0){const t=s.values().next().value;let[e,a,r,o,l]=t;s.delete(t);let h=e;let c=a;n=[e,r];i.push(n);while(true){let t;if(s.has(o)){t=o}else if(s.has(l)){t=l}else{break}s.delete(t);[e,a,r,o,l]=t;if(h!==e){n.push(h,c,e,c===a?a:r);h=e}c=c===a?r:a}n.push(h,c)}return new HighlightOutline(i,this.#cn)}#bn(t){const e=this.#un;let s=0;let i=e.length-1;while(s<=i){const n=s+i>>1;const a=e[n][0];if(a===t){return n}if(a<t){s=n+1}else{i=n-1}}return i+1}#gn([,t,e]){const s=this.#bn(t);this.#un.splice(s,0,[t,e])}#fn([,t,e]){const s=this.#bn(t);for(let i=s;i<this.#un.length;i++){const[s,n]=this.#un[i];if(s!==t){break}if(s===t&&n===e){this.#un.splice(i,1);return}}for(let i=s-1;i>=0;i--){const[s,n]=this.#un[i];if(s!==t){break}if(s===t&&n===e){this.#un.splice(i,1);return}}}#pn(t){const[e,s,i]=t;const n=[[e,s,i]];const a=this.#bn(i);for(let t=0;t<a;t++){const[s,i]=this.#un[t];for(let t=0,a=n.length;t<a;t++){const[,r,o]=n[t];if(i<=r||o<=s){continue}if(r>=s){if(o>i){n[t][1]=i}else{if(a===1){return[]}n.splice(t,1);t--;a--}continue}n[t][2]=s;if(o>i){n.push([e,i,o])}}}return n}}class Outline{toSVGPath(){throw new Error("Abstract method `toSVGPath` must be implemented.")}get box(){throw new Error("Abstract getter `box` must be implemented.")}serialize(t,e){throw new Error("Abstract method `serialize` must be implemented.")}get free(){return this instanceof FreeHighlightOutline}}class HighlightOutline extends Outline{#cn;#_n;constructor(t,e){super();this.#_n=t;this.#cn=e}toSVGPath(){const t=[];for(const e of this.#_n){let[s,i]=e;t.push(`M${s} ${i}`);for(let n=2;n<e.length;n+=2){const a=e[n];const r=e[n+1];if(a===s){t.push(`V${r}`);i=r}else if(r===i){t.push(`H${a}`);s=a}}t.push("Z")}return t.join(" ")}serialize([t,e,s,i],n){const a=[];const r=s-t;const o=i-e;for(const e of this.#_n){const s=new Array(e.length);for(let n=0;n<e.length;n+=2){s[n]=t+e[n]*r;s[n+1]=i-e[n+1]*o}a.push(s)}return a}get box(){return this.#cn}}class FreeOutliner{#cn;#An=[];#vn;#yn;#En=[];#wn=new Float64Array(18);#xn;#Tn;#Sn;#Cn;#Pn;#Mn;#kn=[];static#In=8;static#Rn=2;static#Fn=FreeOutliner.#In+FreeOutliner.#Rn;constructor({x:t,y:e},s,i,n,a,r=0){this.#cn=s;this.#Mn=n*i;this.#yn=a;this.#wn.set([NaN,NaN,NaN,NaN,t,e],6);this.#vn=r;this.#Cn=FreeOutliner.#In*i;this.#Sn=FreeOutliner.#Fn*i;this.#Pn=i;this.#kn.push(t,e)}get free(){return true}isEmpty(){return isNaN(this.#wn[8])}#Ln(){const t=this.#wn.subarray(4,6);const e=this.#wn.subarray(16,18);const[s,i,n,a]=this.#cn;return[(this.#xn+(t[0]-e[0])/2-s)/n,(this.#Tn+(t[1]-e[1])/2-i)/a,(this.#xn+(e[0]-t[0])/2-s)/n,(this.#Tn+(e[1]-t[1])/2-i)/a]}add({x:t,y:e}){this.#xn=t;this.#Tn=e;const[s,i,n,a]=this.#cn;let[r,o,l,h]=this.#wn.subarray(8,12);const c=t-l;const d=e-h;const u=Math.hypot(c,d);if(u<this.#Sn){return false}const p=u-this.#Cn;const g=p/u;const f=g*c;const m=g*d;let b=r;let _=o;r=l;o=h;l+=f;h+=m;this.#kn?.push(t,e);const A=-m/p;const v=f/p;const y=A*this.#Mn;const E=v*this.#Mn;this.#wn.set(this.#wn.subarray(2,8),0);this.#wn.set([l+y,h+E],4);this.#wn.set(this.#wn.subarray(14,18),12);this.#wn.set([l-y,h-E],16);if(isNaN(this.#wn[6])){if(this.#En.length===0){this.#wn.set([r+y,o+E],2);this.#En.push(NaN,NaN,NaN,NaN,(r+y-s)/n,(o+E-i)/a);this.#wn.set([r-y,o-E],14);this.#An.push(NaN,NaN,NaN,NaN,(r-y-s)/n,(o-E-i)/a)}this.#wn.set([b,_,r,o,l,h],6);return!this.isEmpty()}this.#wn.set([b,_,r,o,l,h],6);const w=Math.abs(Math.atan2(_-o,b-r)-Math.atan2(m,f));if(w<Math.PI/2){[r,o,l,h]=this.#wn.subarray(2,6);this.#En.push(NaN,NaN,NaN,NaN,((r+l)/2-s)/n,((o+h)/2-i)/a);[r,o,b,_]=this.#wn.subarray(14,18);this.#An.push(NaN,NaN,NaN,NaN,((b+r)/2-s)/n,((_+o)/2-i)/a);return true}[b,_,r,o,l,h]=this.#wn.subarray(0,6);this.#En.push(((b+5*r)/6-s)/n,((_+5*o)/6-i)/a,((5*r+l)/6-s)/n,((5*o+h)/6-i)/a,((r+l)/2-s)/n,((o+h)/2-i)/a);[l,h,r,o,b,_]=this.#wn.subarray(12,18);this.#An.push(((b+5*r)/6-s)/n,((_+5*o)/6-i)/a,((5*r+l)/6-s)/n,((5*o+h)/6-i)/a,((r+l)/2-s)/n,((o+h)/2-i)/a);return true}toSVGPath(){if(this.isEmpty()){return""}const t=this.#En;const e=this.#An;const s=this.#wn.subarray(4,6);const i=this.#wn.subarray(16,18);const[n,a,r,o]=this.#cn;const[l,h,c,d]=this.#Ln();if(isNaN(this.#wn[6])&&!this.isEmpty()){return`M${(this.#wn[2]-n)/r} ${(this.#wn[3]-a)/o} L${(this.#wn[4]-n)/r} ${(this.#wn[5]-a)/o} L${l} ${h} L${c} ${d} L${(this.#wn[16]-n)/r} ${(this.#wn[17]-a)/o} L${(this.#wn[14]-n)/r} ${(this.#wn[15]-a)/o} Z`}const u=[];u.push(`M${t[4]} ${t[5]}`);for(let e=6;e<t.length;e+=6){if(isNaN(t[e])){u.push(`L${t[e+4]} ${t[e+5]}`)}else{u.push(`C${t[e]} ${t[e+1]} ${t[e+2]} ${t[e+3]} ${t[e+4]} ${t[e+5]}`)}}u.push(`L${(s[0]-n)/r} ${(s[1]-a)/o} L${l} ${h} L${c} ${d} L${(i[0]-n)/r} ${(i[1]-a)/o}`);for(let t=e.length-6;t>=6;t-=6){if(isNaN(e[t])){u.push(`L${e[t+4]} ${e[t+5]}`)}else{u.push(`C${e[t]} ${e[t+1]} ${e[t+2]} ${e[t+3]} ${e[t+4]} ${e[t+5]}`)}}u.push(`L${e[4]} ${e[5]} Z`);return u.join(" ")}getOutlines(){const t=this.#En;const e=this.#An;const s=this.#wn;const i=s.subarray(4,6);const n=s.subarray(16,18);const[a,r,o,l]=this.#cn;const h=new Float64Array((this.#kn?.length??0)+2);for(let t=0,e=h.length-2;t<e;t+=2){h[t]=(this.#kn[t]-a)/o;h[t+1]=(this.#kn[t+1]-r)/l}h[h.length-2]=(this.#xn-a)/o;h[h.length-1]=(this.#Tn-r)/l;const[c,d,u,p]=this.#Ln();if(isNaN(s[6])&&!this.isEmpty()){const t=new Float64Array(36);t.set([NaN,NaN,NaN,NaN,(s[2]-a)/o,(s[3]-r)/l,NaN,NaN,NaN,NaN,(s[4]-a)/o,(s[5]-r)/l,NaN,NaN,NaN,NaN,c,d,NaN,NaN,NaN,NaN,u,p,NaN,NaN,NaN,NaN,(s[16]-a)/o,(s[17]-r)/l,NaN,NaN,NaN,NaN,(s[14]-a)/o,(s[15]-r)/l],0);return new FreeHighlightOutline(t,h,this.#cn,this.#Pn,this.#vn,this.#yn)}const g=new Float64Array(this.#En.length+24+this.#An.length);let f=t.length;for(let e=0;e<f;e+=2){if(isNaN(t[e])){g[e]=g[e+1]=NaN;continue}g[e]=t[e];g[e+1]=t[e+1]}g.set([NaN,NaN,NaN,NaN,(i[0]-a)/o,(i[1]-r)/l,NaN,NaN,NaN,NaN,c,d,NaN,NaN,NaN,NaN,u,p,NaN,NaN,NaN,NaN,(n[0]-a)/o,(n[1]-r)/l],f);f+=24;for(let t=e.length-6;t>=6;t-=6){for(let s=0;s<6;s+=2){if(isNaN(e[t+s])){g[f]=g[f+1]=NaN;f+=2;continue}g[f]=e[t+s];g[f+1]=e[t+s+1];f+=2}}g.set([NaN,NaN,NaN,NaN,e[4],e[5]],f);return new FreeHighlightOutline(g,h,this.#cn,this.#Pn,this.#vn,this.#yn)}}class FreeHighlightOutline extends Outline{#cn;#Dn=null;#vn;#yn;#kn;#Pn;#On;constructor(t,e,s,i,n,a){super();this.#On=t;this.#kn=e;this.#cn=s;this.#Pn=i;this.#vn=n;this.#yn=a;this.#Nn(a);const{x:r,y:o,width:l,height:h}=this.#Dn;for(let e=0,s=t.length;e<s;e+=2){t[e]=(t[e]-r)/l;t[e+1]=(t[e+1]-o)/h}for(let t=0,s=e.length;t<s;t+=2){e[t]=(e[t]-r)/l;e[t+1]=(e[t+1]-o)/h}}toSVGPath(){const t=[`M${this.#On[4]} ${this.#On[5]}`];for(let e=6,s=this.#On.length;e<s;e+=6){if(isNaN(this.#On[e])){t.push(`L${this.#On[e+4]} ${this.#On[e+5]}`);continue}t.push(`C${this.#On[e]} ${this.#On[e+1]} ${this.#On[e+2]} ${this.#On[e+3]} ${this.#On[e+4]} ${this.#On[e+5]}`)}t.push("Z");return t.join(" ")}serialize([t,e,s,i],n){const a=s-t;const r=i-e;let o;let l;switch(n){case 0:o=this.#Bn(this.#On,t,i,a,-r);l=this.#Bn(this.#kn,t,i,a,-r);break;case 90:o=this.#Hn(this.#On,t,e,a,r);l=this.#Hn(this.#kn,t,e,a,r);break;case 180:o=this.#Bn(this.#On,s,e,-a,r);l=this.#Bn(this.#kn,s,e,-a,r);break;case 270:o=this.#Hn(this.#On,s,i,-a,-r);l=this.#Hn(this.#kn,s,i,-a,-r);break}return{outline:Array.from(o),points:[Array.from(l)]}}#Bn(t,e,s,i,n){const a=new Float64Array(t.length);for(let r=0,o=t.length;r<o;r+=2){a[r]=e+t[r]*i;a[r+1]=s+t[r+1]*n}return a}#Hn(t,e,s,i,n){const a=new Float64Array(t.length);for(let r=0,o=t.length;r<o;r+=2){a[r]=e+t[r+1]*i;a[r+1]=s+t[r]*n}return a}#Nn(t){const e=this.#On;let s=e[4];let i=e[5];let n=s;let a=i;let r=s;let o=i;let l=s;let h=i;const c=t?Math.max:Math.min;for(let t=6,d=e.length;t<d;t+=6){if(isNaN(e[t])){n=Math.min(n,e[t+4]);a=Math.min(a,e[t+5]);r=Math.max(r,e[t+4]);o=Math.max(o,e[t+5]);if(h<e[t+5]){l=e[t+4];h=e[t+5]}else if(h===e[t+5]){l=c(l,e[t+4])}}else{const d=Util.bezierBoundingBox(s,i,...e.slice(t,t+6));n=Math.min(n,d[0]);a=Math.min(a,d[1]);r=Math.max(r,d[2]);o=Math.max(o,d[3]);if(h<d[3]){l=d[2];h=d[3]}else if(h===d[3]){l=c(l,d[2])}}s=e[t+4];i=e[t+5]}const d=n-this.#vn,u=a-this.#vn,p=r-n+2*this.#vn,g=o-a+2*this.#vn;this.#Dn={x:d,y:u,width:p,height:g,lastPoint:[l,h]}}get box(){return this.#Dn}getNewOutline(t,e){const{x:s,y:i,width:n,height:a}=this.#Dn;const[r,o,l,h]=this.#cn;const c=n*l;const d=a*h;const u=s*l+r;const p=i*h+o;const g=new FreeOutliner({x:this.#kn[0]*c+u,y:this.#kn[1]*d+p},this.#cn,this.#Pn,t,this.#yn,e??this.#vn);for(let t=2;t<this.#kn.length;t+=2){g.add({x:this.#kn[t]*c+u,y:this.#kn[t+1]*d+p})}return g.getOutlines()}}class ColorPicker{#ci=this.#di.bind(this);#Un=this.#x.bind(this);#zn=null;#Gn=null;#Vn;#Wn=null;#jn=false;#$n=false;#E=null;#Kn;#k=null;#qn;static get _keyboardManager(){return shadow(this,"_keyboardManager",new KeyboardManager([[["Escape","mac+Escape"],ColorPicker.prototype._hideDropdownFromKeyboard],[[" ","mac+ "],ColorPicker.prototype._colorSelectFromKeyboard],[["ArrowDown","ArrowRight","mac+ArrowDown","mac+ArrowRight"],ColorPicker.prototype._moveToNext],[["ArrowUp","ArrowLeft","mac+ArrowUp","mac+ArrowLeft"],ColorPicker.prototype._moveToPrevious],[["Home","mac+Home"],ColorPicker.prototype._moveToBeginning],[["End","mac+End"],ColorPicker.prototype._moveToEnd]]))}constructor({editor:t=null,uiManager:e=null}){if(t){this.#$n=false;this.#qn=AnnotationEditorParamsType.HIGHLIGHT_COLOR;this.#E=t}else{this.#$n=true;this.#qn=AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR}this.#k=t?._uiManager||e;this.#Kn=this.#k._eventBus;this.#Vn=t?.color||this.#k?.highlightColors.values().next().value||"#FFFF98"}renderButton(){const t=this.#zn=document.createElement("button");t.className="colorPicker";t.tabIndex="0";t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-button");t.setAttribute("aria-haspopup",true);const e=this.#k._signal;t.addEventListener("click",this.#Xn.bind(this),{signal:e});t.addEventListener("keydown",this.#ci,{signal:e});const s=this.#Gn=document.createElement("span");s.className="swatch";s.setAttribute("aria-hidden",true);s.style.backgroundColor=this.#Vn;t.append(s);return t}renderMainDropdown(){const t=this.#Wn=this.#Yn();t.setAttribute("aria-orientation","horizontal");t.setAttribute("aria-labelledby","highlightColorPickerLabel");return t}#Yn(){const t=document.createElement("div");const e=this.#k._signal;t.addEventListener("contextmenu",noContextMenu,{signal:e});t.className="dropdown";t.role="listbox";t.setAttribute("aria-multiselectable",false);t.setAttribute("aria-orientation","vertical");t.setAttribute("data-l10n-id","pdfjs-editor-colorpicker-dropdown");for(const[s,i]of this.#k.highlightColors){const n=document.createElement("button");n.tabIndex="0";n.role="option";n.setAttribute("data-color",i);n.title=s;n.setAttribute("data-l10n-id",`pdfjs-editor-colorpicker-${s}`);const a=document.createElement("span");n.append(a);a.className="swatch";a.style.backgroundColor=i;n.setAttribute("aria-selected",i===this.#Vn);n.addEventListener("click",this.#Jn.bind(this,i),{signal:e});t.append(n)}t.addEventListener("keydown",this.#ci,{signal:e});return t}#Jn(t,e){e.stopPropagation();this.#Kn.dispatch("switchannotationeditorparams",{source:this,type:this.#qn,value:t})}_colorSelectFromKeyboard(t){if(t.target===this.#zn){this.#Xn(t);return}const e=t.target.getAttribute("data-color");if(!e){return}this.#Jn(e,t)}_moveToNext(t){if(!this.#Qn){this.#Xn(t);return}if(t.target===this.#zn){this.#Wn.firstChild?.focus();return}t.target.nextSibling?.focus()}_moveToPrevious(t){if(t.target===this.#Wn?.firstChild||t.target===this.#zn){if(this.#Qn){this._hideDropdownFromKeyboard()}return}if(!this.#Qn){this.#Xn(t)}t.target.previousSibling?.focus()}_moveToBeginning(t){if(!this.#Qn){this.#Xn(t);return}this.#Wn.firstChild?.focus()}_moveToEnd(t){if(!this.#Qn){this.#Xn(t);return}this.#Wn.lastChild?.focus()}#di(t){ColorPicker._keyboardManager.exec(this,t)}#Xn(t){if(this.#Qn){this.hideDropdown();return}this.#jn=t.detail===0;window.addEventListener("pointerdown",this.#Un,{signal:this.#k._signal});if(this.#Wn){this.#Wn.classList.remove("hidden");return}const e=this.#Wn=this.#Yn();this.#zn.append(e)}#x(t){if(this.#Wn?.contains(t.target)){return}this.hideDropdown()}hideDropdown(){this.#Wn?.classList.add("hidden");window.removeEventListener("pointerdown",this.#Un)}get#Qn(){return this.#Wn&&!this.#Wn.classList.contains("hidden")}_hideDropdownFromKeyboard(){if(this.#$n){return}if(!this.#Qn){this.#E?.unselect();return}this.hideDropdown();this.#zn.focus({preventScroll:true,focusVisible:this.#jn})}updateColor(t){if(this.#Gn){this.#Gn.style.backgroundColor=t}if(!this.#Wn){return}const e=this.#k.highlightColors.values();for(const s of this.#Wn.children){s.setAttribute("aria-selected",e.next().value===t)}}destroy(){this.#zn?.remove();this.#zn=null;this.#Gn=null;this.#Wn?.remove();this.#Wn=null}}class HighlightEditor extends AnnotationEditor{#Zn=null;#ta=0;#ea;#sa=null;#y=null;#ia=null;#na=null;#aa=0;#ra=null;#oa=null;#l=null;#la=false;#Et=this.#ha.bind(this);#ca=null;#da;#ua=null;#pa="";#Mn;#ga="";static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=12;static _l10nPromise;static _type="highlight";static _editorType=AnnotationEditorType.HIGHLIGHT;static _freeHighlightId=-1;static _freeHighlight=null;static _freeHighlightClipId="";static get _keyboardManager(){const t=HighlightEditor.prototype;return shadow(this,"_keyboardManager",new KeyboardManager([[["ArrowLeft","mac+ArrowLeft"],t._moveCaret,{args:[0]}],[["ArrowRight","mac+ArrowRight"],t._moveCaret,{args:[1]}],[["ArrowUp","mac+ArrowUp"],t._moveCaret,{args:[2]}],[["ArrowDown","mac+ArrowDown"],t._moveCaret,{args:[3]}]]))}constructor(t){super({...t,name:"highlightEditor"});this.color=t.color||HighlightEditor._defaultColor;this.#Mn=t.thickness||HighlightEditor._defaultThickness;this.#da=t.opacity||HighlightEditor._defaultOpacity;this.#ea=t.boxes||null;this.#ga=t.methodOfCreation||"";this.#pa=t.text||"";this._isDraggable=false;if(t.highlightId>-1){this.#la=true;this.#fa(t);this.#ma()}else{this.#Zn=t.anchorNode;this.#ta=t.anchorOffset;this.#na=t.focusNode;this.#aa=t.focusOffset;this.#ba();this.#ma();this.rotate(this.rotation)}}get telemetryInitialData(){return{action:"added",type:this.#la?"free_highlight":"highlight",color:this._uiManager.highlightColorNames.get(this.color),thickness:this.#Mn,methodOfCreation:this.#ga}}get telemetryFinalData(){return{type:"highlight",color:this._uiManager.highlightColorNames.get(this.color)}}static computeTelemetryFinalData(t){return{numberOfColors:t.get("color").size}}#ba(){const t=new Outliner(this.#ea,.001);this.#oa=t.getOutlines();({x:this.x,y:this.y,width:this.width,height:this.height}=this.#oa.box);const e=new Outliner(this.#ea,.0025,.001,this._uiManager.direction==="ltr");this.#ia=e.getOutlines();const{lastPoint:s}=this.#ia.box;this.#ca=[(s[0]-this.x)/this.width,(s[1]-this.y)/this.height]}#fa({highlightOutlines:t,highlightId:e,clipPathId:s}){this.#oa=t;const i=1.5;this.#ia=t.getNewOutline(this.#Mn/2+i,.0025);if(e>=0){this.#l=e;this.#sa=s;this.parent.drawLayer.finalizeLine(e,t);this.#ua=this.parent.drawLayer.highlightOutline(this.#ia)}else if(this.parent){const e=this.parent.viewport.rotation;this.parent.drawLayer.updateLine(this.#l,t);this.parent.drawLayer.updateBox(this.#l,HighlightEditor.#_a(this.#oa.box,(e-this.rotation+360)%360));this.parent.drawLayer.updateLine(this.#ua,this.#ia);this.parent.drawLayer.updateBox(this.#ua,HighlightEditor.#_a(this.#ia.box,e))}const{x:n,y:a,width:r,height:o}=t.box;switch(this.rotation){case 0:this.x=n;this.y=a;this.width=r;this.height=o;break;case 90:{const[t,e]=this.parentDimensions;this.x=a;this.y=1-n;this.width=r*e/t;this.height=o*t/e;break}case 180:this.x=1-n;this.y=1-a;this.width=r;this.height=o;break;case 270:{const[t,e]=this.parentDimensions;this.x=1-a;this.y=n;this.width=r*e/t;this.height=o*t/e;break}}const{lastPoint:l}=this.#ia.box;this.#ca=[(l[0]-n)/r,(l[1]-a)/o]}static initialize(t,e){AnnotationEditor.initialize(t,e);HighlightEditor._defaultColor||=e.highlightColors?.values().next().value||"#fff066"}static updateDefaultParams(t,e){switch(t){case AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR:HighlightEditor._defaultColor=e;break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:HighlightEditor._defaultThickness=e;break}}translateInPage(t,e){}get toolbarPosition(){return this.#ca}updateParams(t,e){switch(t){case AnnotationEditorParamsType.HIGHLIGHT_COLOR:this.#sn(e);break;case AnnotationEditorParamsType.HIGHLIGHT_THICKNESS:this.#Aa(e);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_DEFAULT_COLOR,HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,HighlightEditor._defaultThickness]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.HIGHLIGHT_COLOR,this.color||HighlightEditor._defaultColor],[AnnotationEditorParamsType.HIGHLIGHT_THICKNESS,this.#Mn||HighlightEditor._defaultThickness],[AnnotationEditorParamsType.HIGHLIGHT_FREE,this.#la]]}#sn(t){const e=t=>{this.color=t;this.parent?.drawLayer.changeColor(this.#l,t);this.#y?.updateColor(t)};const s=this.color;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.HIGHLIGHT_COLOR,overwriteIfSameType:true,keepUndo:true});this._reportTelemetry({action:"color_changed",color:this._uiManager.highlightColorNames.get(t)},true)}#Aa(t){const e=this.#Mn;const s=t=>{this.#Mn=t;this.#va(t)};this.addCommands({cmd:s.bind(this,t),undo:s.bind(this,e),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:true,keepUndo:true});this._reportTelemetry({action:"thickness_changed",thickness:t},true)}async addEditToolbar(){const t=await super.addEditToolbar();if(!t){return null}if(this._uiManager.highlightColors){this.#y=new ColorPicker({editor:this});t.addColorPicker(this.#y)}return t}disableEditing(){super.disableEditing();this.div.classList.toggle("disabled",true)}enableEditing(){super.enableEditing();this.div.classList.toggle("disabled",false)}fixAndSetPosition(){return super.fixAndSetPosition(this.#ya())}getBaseTranslation(){return[0,0]}getRect(t,e){return super.getRect(t,e,this.#ya())}onceAdded(){this.parent.addUndoableEditor(this);this.div.focus()}remove(){this.#Ea();this._reportTelemetry({action:"deleted"});super.remove()}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}this.#ma();if(!this.isAttachedToDOM){this.parent.add(this)}}setParent(t){let e=false;if(this.parent&&!t){this.#Ea()}else if(t){this.#ma(t);e=!this.parent&&this.div?.classList.contains("selectedEditor")}super.setParent(t);this.show(this._isVisible);if(e){this.select()}}#va(t){if(!this.#la){return}this.#fa({highlightOutlines:this.#oa.getNewOutline(t/2)});this.fixAndSetPosition();const[e,s]=this.parentDimensions;this.setDims(this.width*e,this.height*s)}#Ea(){if(this.#l===null||!this.parent){return}this.parent.drawLayer.remove(this.#l);this.#l=null;this.parent.drawLayer.remove(this.#ua);this.#ua=null}#ma(t=this.parent){if(this.#l!==null){return}({id:this.#l,clipPathId:this.#sa}=t.drawLayer.highlight(this.#oa,this.color,this.#da));this.#ua=t.drawLayer.highlightOutline(this.#ia);if(this.#ra){this.#ra.style.clipPath=this.#sa}}static#_a({x:t,y:e,width:s,height:i},n){switch(n){case 90:return{x:1-e-i,y:t,width:i,height:s};case 180:return{x:1-t-s,y:1-e-i,width:s,height:i};case 270:return{x:e,y:1-t-s,width:i,height:s}}return{x:t,y:e,width:s,height:i}}rotate(t){const{drawLayer:e}=this.parent;let s;if(this.#la){t=(t-this.rotation+360)%360;s=HighlightEditor.#_a(this.#oa.box,t)}else{s=HighlightEditor.#_a(this,t)}e.rotate(this.#l,t);e.rotate(this.#ua,t);e.updateBox(this.#l,s);e.updateBox(this.#ua,HighlightEditor.#_a(this.#ia.box,t))}render(){if(this.div){return this.div}const t=super.render();if(this.#pa){t.setAttribute("aria-label",this.#pa);t.setAttribute("role","mark")}if(this.#la){t.classList.add("free")}else{this.div.addEventListener("keydown",this.#Et,{signal:this._uiManager._signal})}const e=this.#ra=document.createElement("div");t.append(e);e.setAttribute("aria-hidden","true");e.className="internal";e.style.clipPath=this.#sa;const[s,i]=this.parentDimensions;this.setDims(this.width*s,this.height*i);bindEvents(this,this.#ra,["pointerover","pointerleave"]);this.enableEditing();return t}pointerover(){this.parent.drawLayer.addClass(this.#ua,"hovered")}pointerleave(){this.parent.drawLayer.removeClass(this.#ua,"hovered")}#ha(t){HighlightEditor._keyboardManager.exec(this,t)}_moveCaret(t){this.parent.unselect(this);switch(t){case 0:case 2:this.#wa(true);break;case 1:case 3:this.#wa(false);break}}#wa(t){if(!this.#Zn){return}const e=window.getSelection();if(t){e.setPosition(this.#Zn,this.#ta)}else{e.setPosition(this.#na,this.#aa)}}select(){super.select();if(!this.#ua){return}this.parent?.drawLayer.removeClass(this.#ua,"hovered");this.parent?.drawLayer.addClass(this.#ua,"selected")}unselect(){super.unselect();if(!this.#ua){return}this.parent?.drawLayer.removeClass(this.#ua,"selected");if(!this.#la){this.#wa(false)}}get _mustFixPosition(){return!this.#la}show(t=this._isVisible){super.show(t);if(this.parent){this.parent.drawLayer.show(this.#l,t);this.parent.drawLayer.show(this.#ua,t)}}#ya(){return this.#la?this.rotation:0}#xa(){if(this.#la){return null}const[t,e]=this.pageDimensions;const s=this.#ea;const i=new Float32Array(s.length*8);let n=0;for(const{x:a,y:r,width:o,height:l}of s){const s=a*t;const h=(1-r-l)*e;i[n]=i[n+4]=s;i[n+1]=i[n+3]=h;i[n+2]=i[n+6]=s+o*t;i[n+5]=i[n+7]=h+l*e;n+=8}return i}#Ta(t){return this.#oa.serialize(t,this.#ya())}static startHighlighting(t,e,{target:s,x:i,y:n}){const{x:a,y:r,width:o,height:l}=s.getBoundingClientRect();const h=e=>{this.#Sa(t,e)};const c=t._signal;const d={capture:true,passive:false,signal:c};const u=t=>{t.preventDefault();t.stopPropagation()};const p=e=>{s.removeEventListener("pointermove",h);window.removeEventListener("blur",p);window.removeEventListener("pointerup",p);window.removeEventListener("pointerdown",u,d);window.removeEventListener("contextmenu",noContextMenu);this.#Ca(t,e)};window.addEventListener("blur",p,{signal:c});window.addEventListener("pointerup",p,{signal:c});window.addEventListener("pointerdown",u,d);window.addEventListener("contextmenu",noContextMenu,{signal:c});s.addEventListener("pointermove",h,{signal:c});this._freeHighlight=new FreeOutliner({x:i,y:n},[a,r,o,l],t.scale,this._defaultThickness/2,e,.001);({id:this._freeHighlightId,clipPathId:this._freeHighlightClipId}=t.drawLayer.highlight(this._freeHighlight,this._defaultColor,this._defaultOpacity,true))}static#Sa(t,e){if(this._freeHighlight.add(e)){t.drawLayer.updatePath(this._freeHighlightId,this._freeHighlight)}}static#Ca(t,e){if(!this._freeHighlight.isEmpty()){t.createAndAddNewEditor(e,false,{highlightId:this._freeHighlightId,highlightOutlines:this._freeHighlight.getOutlines(),clipPathId:this._freeHighlightClipId,methodOfCreation:"main_toolbar"})}else{t.drawLayer.removeFreeHighlight(this._freeHighlightId)}this._freeHighlightId=-1;this._freeHighlight=null;this._freeHighlightClipId=""}static deserialize(t,e,s){const i=super.deserialize(t,e,s);const{rect:[n,a,r,o],color:l,quadPoints:h}=t;i.color=Util.makeHexColor(...l);i.#da=t.opacity;const[c,d]=i.pageDimensions;i.width=(r-n)/c;i.height=(o-a)/d;const u=i.#ea=[];for(let t=0;t<h.length;t+=8){u.push({x:(h[4]-r)/c,y:(o-(1-h[t+5]))/d,width:(h[t+2]-h[t])/c,height:(h[t+5]-h[t+1])/d})}i.#ba();return i}serialize(t=false){if(this.isEmpty()||t){return null}const e=this.getRect(0,0);const s=AnnotationEditor._colorManager.convert(this.color);return{annotationType:AnnotationEditorType.HIGHLIGHT,color:s,opacity:this.#da,thickness:this.#Mn,quadPoints:this.#xa(),outlines:this.#Ta(e),pageIndex:this.pageIndex,rect:e,rotation:this.#ya(),structTreeParentId:this._structTreeParentId}}static canCreateNewEmptyEditor(){return false}}class InkEditor extends AnnotationEditor{#Pa=0;#Ma=0;#ka=this.canvasPointermove.bind(this);#Ia=this.canvasPointerleave.bind(this);#Ra=this.canvasPointerup.bind(this);#Fa=this.canvasPointerdown.bind(this);#La=null;#Da=new Path2D;#Oa=false;#Na=false;#Ba=false;#Ha=null;#Ua=0;#za=0;#Ga=null;static _defaultColor=null;static _defaultOpacity=1;static _defaultThickness=1;static _type="ink";static _editorType=AnnotationEditorType.INK;constructor(t){super({...t,name:"inkEditor"});this.color=t.color||null;this.thickness=t.thickness||null;this.opacity=t.opacity||null;this.paths=[];this.bezierPath2D=[];this.allRawPaths=[];this.currentPath=[];this.scaleFactor=1;this.translationX=this.translationY=0;this.x=0;this.y=0;this._willKeepAspectRatio=true}static initialize(t,e){AnnotationEditor.initialize(t,e)}static updateDefaultParams(t,e){switch(t){case AnnotationEditorParamsType.INK_THICKNESS:InkEditor._defaultThickness=e;break;case AnnotationEditorParamsType.INK_COLOR:InkEditor._defaultColor=e;break;case AnnotationEditorParamsType.INK_OPACITY:InkEditor._defaultOpacity=e/100;break}}updateParams(t,e){switch(t){case AnnotationEditorParamsType.INK_THICKNESS:this.#Aa(e);break;case AnnotationEditorParamsType.INK_COLOR:this.#sn(e);break;case AnnotationEditorParamsType.INK_OPACITY:this.#Va(e);break}}static get defaultPropertiesToUpdate(){return[[AnnotationEditorParamsType.INK_THICKNESS,InkEditor._defaultThickness],[AnnotationEditorParamsType.INK_COLOR,InkEditor._defaultColor||AnnotationEditor._defaultLineColor],[AnnotationEditorParamsType.INK_OPACITY,Math.round(InkEditor._defaultOpacity*100)]]}get propertiesToUpdate(){return[[AnnotationEditorParamsType.INK_THICKNESS,this.thickness||InkEditor._defaultThickness],[AnnotationEditorParamsType.INK_COLOR,this.color||InkEditor._defaultColor||AnnotationEditor._defaultLineColor],[AnnotationEditorParamsType.INK_OPACITY,Math.round(100*(this.opacity??InkEditor._defaultOpacity))]]}#Aa(t){const e=t=>{this.thickness=t;this.#Wa()};const s=this.thickness;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.INK_THICKNESS,overwriteIfSameType:true,keepUndo:true})}#sn(t){const e=t=>{this.color=t;this.#ja()};const s=this.color;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.INK_COLOR,overwriteIfSameType:true,keepUndo:true})}#Va(t){const e=t=>{this.opacity=t;this.#ja()};t/=100;const s=this.opacity;this.addCommands({cmd:e.bind(this,t),undo:e.bind(this,s),post:this._uiManager.updateUI.bind(this._uiManager,this),mustExec:true,type:AnnotationEditorParamsType.INK_OPACITY,overwriteIfSameType:true,keepUndo:true})}rebuild(){if(!this.parent){return}super.rebuild();if(this.div===null){return}if(!this.canvas){this.#$a();this.#Ka()}if(!this.isAttachedToDOM){this.parent.add(this);this.#qa()}this.#Wa()}remove(){if(this.canvas===null){return}if(!this.isEmpty()){this.commit()}this.canvas.width=this.canvas.height=0;this.canvas.remove();this.canvas=null;if(this.#La){clearTimeout(this.#La);this.#La=null}this.#Ha?.disconnect();this.#Ha=null;super.remove()}setParent(t){if(!this.parent&&t){this._uiManager.removeShouldRescale(this)}else if(this.parent&&t===null){this._uiManager.addShouldRescale(this)}super.setParent(t)}onScaleChanging(){const[t,e]=this.parentDimensions;const s=this.width*t;const i=this.height*e;this.setDimensions(s,i)}enableEditMode(){if(this.#Oa||this.canvas===null){return}super.enableEditMode();this._isDraggable=false;this.canvas.addEventListener("pointerdown",this.#Fa,{signal:this._uiManager._signal})}disableEditMode(){if(!this.isInEditMode()||this.canvas===null){return}super.disableEditMode();this._isDraggable=!this.isEmpty();this.div.classList.remove("editing");this.canvas.removeEventListener("pointerdown",this.#Fa)}onceAdded(){this._isDraggable=!this.isEmpty()}isEmpty(){return this.paths.length===0||this.paths.length===1&&this.paths[0].length===0}#Xa(){const{parentRotation:t,parentDimensions:[e,s]}=this;switch(t){case 90:return[0,s,s,e];case 180:return[e,s,e,s];case 270:return[e,0,s,e];default:return[0,0,e,s]}}#Ya(){const{ctx:t,color:e,opacity:s,thickness:i,parentScale:n,scaleFactor:a}=this;t.lineWidth=i*n/a;t.lineCap="round";t.lineJoin="round";t.miterLimit=10;t.strokeStyle=`${e}${opacityToHex(s)}`}#Ja(t,e){const s=this._uiManager._signal;this.canvas.addEventListener("contextmenu",noContextMenu,{signal:s});this.canvas.addEventListener("pointerleave",this.#Ia,{signal:s});this.canvas.addEventListener("pointermove",this.#ka,{signal:s});this.canvas.addEventListener("pointerup",this.#Ra,{signal:s});this.canvas.removeEventListener("pointerdown",this.#Fa);this.isEditing=true;if(!this.#Ba){this.#Ba=true;this.#qa();this.thickness||=InkEditor._defaultThickness;this.color||=InkEditor._defaultColor||AnnotationEditor._defaultLineColor;this.opacity??=InkEditor._defaultOpacity}this.currentPath.push([t,e]);this.#Na=false;this.#Ya();this.#Ga=()=>{this.#Qa();if(this.#Ga){window.requestAnimationFrame(this.#Ga)}};window.requestAnimationFrame(this.#Ga)}#Za(t,e){const[s,i]=this.currentPath.at(-1);if(this.currentPath.length>1&&t===s&&e===i){return}const n=this.currentPath;let a=this.#Da;n.push([t,e]);this.#Na=true;if(n.length<=2){a.moveTo(...n[0]);a.lineTo(t,e);return}if(n.length===3){this.#Da=a=new Path2D;a.moveTo(...n[0])}this.#tr(a,...n.at(-3),...n.at(-2),t,e)}#er(){if(this.currentPath.length===0){return}const t=this.currentPath.at(-1);this.#Da.lineTo(...t)}#sr(t,e){this.#Ga=null;t=Math.min(Math.max(t,0),this.canvas.width);e=Math.min(Math.max(e,0),this.canvas.height);this.#Za(t,e);this.#er();let s;if(this.currentPath.length!==1){s=this.#ir()}else{const i=[t,e];s=[[i,i.slice(),i.slice(),i]]}const i=this.#Da;const n=this.currentPath;this.currentPath=[];this.#Da=new Path2D;const a=()=>{this.allRawPaths.push(n);this.paths.push(s);this.bezierPath2D.push(i);this._uiManager.rebuild(this)};const r=()=>{this.allRawPaths.pop();this.paths.pop();this.bezierPath2D.pop();if(this.paths.length===0){this.remove()}else{if(!this.canvas){this.#$a();this.#Ka()}this.#Wa()}};this.addCommands({cmd:a,undo:r,mustExec:true})}#Qa(){if(!this.#Na){return}this.#Na=false;const t=Math.ceil(this.thickness*this.parentScale);const e=this.currentPath.slice(-3);const s=e.map(t=>t[0]);const i=e.map(t=>t[1]);const n=Math.min(...s)-t;const a=Math.max(...s)+t;const r=Math.min(...i)-t;const o=Math.max(...i)+t;const{ctx:l}=this;l.save();l.clearRect(0,0,this.canvas.width,this.canvas.height);for(const t of this.bezierPath2D){l.stroke(t)}l.stroke(this.#Da);l.restore()}#tr(t,e,s,i,n,a,r){const o=(e+i)/2;const l=(s+n)/2;const h=(i+a)/2;const c=(n+r)/2;t.bezierCurveTo(o+2*(i-o)/3,l+2*(n-l)/3,h+2*(i-h)/3,c+2*(n-c)/3,h,c)}#ir(){const t=this.currentPath;if(t.length<=2){return[[t[0],t[0],t.at(-1),t.at(-1)]]}const e=[];let s;let[i,n]=t[0];for(s=1;s<t.length-2;s++){const[a,r]=t[s];const[o,l]=t[s+1];const h=(a+o)/2;const c=(r+l)/2;const d=[i+2*(a-i)/3,n+2*(r-n)/3];const u=[h+2*(a-h)/3,c+2*(r-c)/3];e.push([[i,n],d,u,[h,c]]);[i,n]=[h,c]}const[a,r]=t[s];const[o,l]=t[s+1];const h=[i+2*(a-i)/3,n+2*(r-n)/3];const c=[o+2*(a-o)/3,l+2*(r-l)/3];e.push([[i,n],h,c,[o,l]]);return e}#ja(){if(this.isEmpty()){this.#nr();return}this.#Ya();const{canvas:t,ctx:e}=this;e.setTransform(1,0,0,1,0,0);e.clearRect(0,0,t.width,t.height);this.#nr();for(const t of this.bezierPath2D){e.stroke(t)}}commit(){if(this.#Oa){return}super.commit();this.isEditing=false;this.disableEditMode();this.setInForeground();this.#Oa=true;this.div.classList.add("disabled");this.#Wa(true);this.select();this.parent.addInkEditorIfNeeded(true);this.moveInDOM();this.div.focus({preventScroll:true})}focusin(t){if(!this._focusEventsAllowed){return}super.focusin(t);this.enableEditMode()}canvasPointerdown(t){if(t.button!==0||!this.isInEditMode()||this.#Oa){return}this.setInForeground();t.preventDefault();if(!this.div.contains(document.activeElement)){this.div.focus({preventScroll:true})}this.#Ja(t.offsetX,t.offsetY)}canvasPointermove(t){t.preventDefault();this.#Za(t.offsetX,t.offsetY)}canvasPointerup(t){t.preventDefault();this.#ar(t)}canvasPointerleave(t){this.#ar(t)}#ar(t){this.canvas.removeEventListener("pointerleave",this.#Ia);this.canvas.removeEventListener("pointermove",this.#ka);this.canvas.removeEventListener("pointerup",this.#Ra);this.canvas.addEventListener("pointerdown",this.#Fa,{signal:this._uiManager._signal});if(this.#La){clearTimeout(this.#La)}this.#La=setTimeout(()=>{this.#La=null;this.canvas.removeEventListener("contextmenu",noContextMenu)},10);this.#sr(t.offsetX,t.offsetY);this.addToAnnotationStorage();this.setInBackground()}#$a(){this.canvas=document.createElement("canvas");this.canvas.width=this.canvas.height=0;this.canvas.className="inkEditorCanvas";this.canvas.setAttribute("data-l10n-id","pdfjs-ink-canvas");this.div.append(this.canvas);this.ctx=this.canvas.getContext("2d")}#Ka(){this.#Ha=new ResizeObserver(t=>{const e=t[0].contentRect;if(e.width&&e.height){this.setDimensions(e.width,e.height)}});this.#Ha.observe(this.div);this._uiManager._signal.addEventListener("abort",()=>{this.#Ha?.disconnect();this.#Ha=null},{once:true})}get isResizable(){return!this.isEmpty()&&this.#Oa}render(){if(this.div){return this.div}let t,e;if(this.width){t=this.x;e=this.y}super.render();this.div.setAttribute("data-l10n-id","pdfjs-ink");const[s,i,n,a]=this.#Xa();this.setAt(s,i,0,0);this.setDims(n,a);this.#$a();if(this.width){const[s,i]=this.parentDimensions;this.setAspectRatio(this.width*s,this.height*i);this.setAt(t*s,e*i,this.width*s,this.height*i);this.#Ba=true;this.#qa();this.setDims(this.width*s,this.height*i);this.#ja();this.div.classList.add("disabled")}else{this.div.classList.add("editing");this.enableEditMode()}this.#Ka();return this.div}#qa(){if(!this.#Ba){return}const[t,e]=this.parentDimensions;this.canvas.width=Math.ceil(this.width*t);this.canvas.height=Math.ceil(this.height*e);this.#nr()}setDimensions(t,e){const s=Math.round(t);const i=Math.round(e);if(this.#Ua===s&&this.#za===i){return}this.#Ua=s;this.#za=i;this.canvas.style.visibility="hidden";const[n,a]=this.parentDimensions;this.width=t/n;this.height=e/a;this.fixAndSetPosition();if(this.#Oa){this.#rr(t,e)}this.#qa();this.#ja();this.canvas.style.visibility="visible";this.fixDims()}#rr(t,e){const s=this.#or();const i=(t-s)/this.#Ma;const n=(e-s)/this.#Pa;this.scaleFactor=Math.min(i,n)}#nr(){const t=this.#or()/2;this.ctx.setTransform(this.scaleFactor,0,0,this.scaleFactor,this.translationX*this.scaleFactor+t,this.translationY*this.scaleFactor+t)}static#lr(t){const e=new Path2D;for(let s=0,i=t.length;s<i;s++){const[i,n,a,r]=t[s];if(s===0){e.moveTo(...i)}e.bezierCurveTo(n[0],n[1],a[0],a[1],r[0],r[1])}return e}static#hr(t,e,s){const[i,n,a,r]=e;switch(s){case 0:for(let e=0,s=t.length;e<s;e+=2){t[e]+=i;t[e+1]=r-t[e+1]}break;case 90:for(let e=0,s=t.length;e<s;e+=2){const s=t[e];t[e]=t[e+1]+i;t[e+1]=s+n}break;case 180:for(let e=0,s=t.length;e<s;e+=2){t[e]=a-t[e];t[e+1]+=n}break;case 270:for(let e=0,s=t.length;e<s;e+=2){const s=t[e];t[e]=a-t[e+1];t[e+1]=r-s}break;default:throw new Error("Invalid rotation")}return t}static#cr(t,e,s){const[i,n,a,r]=e;switch(s){case 0:for(let e=0,s=t.length;e<s;e+=2){t[e]-=i;t[e+1]=r-t[e+1]}break;case 90:for(let e=0,s=t.length;e<s;e+=2){const s=t[e];t[e]=t[e+1]-n;t[e+1]=s-i}break;case 180:for(let e=0,s=t.length;e<s;e+=2){t[e]=a-t[e];t[e+1]-=n}break;case 270:for(let e=0,s=t.length;e<s;e+=2){const s=t[e];t[e]=r-t[e+1];t[e+1]=a-s}break;default:throw new Error("Invalid rotation")}return t}#dr(t,e,s,i){const n=[];const a=this.thickness/2;const r=t*e+a;const o=t*s+a;for(const e of this.paths){const s=[];const a=[];for(let i=0,n=e.length;i<n;i++){const[l,h,c,d]=e[i];if(l[0]===d[0]&&l[1]===d[1]&&n===1){const e=t*l[0]+r;const i=t*l[1]+o;s.push(e,i);a.push(e,i);break}const u=t*l[0]+r;const p=t*l[1]+o;const g=t*h[0]+r;const f=t*h[1]+o;const m=t*c[0]+r;const b=t*c[1]+o;const _=t*d[0]+r;const A=t*d[1]+o;if(i===0){s.push(u,p);a.push(u,p)}s.push(g,f,m,b,_,A);a.push(g,f);if(i===n-1){a.push(_,A)}}n.push({bezier:InkEditor.#hr(s,i,this.rotation),points:InkEditor.#hr(a,i,this.rotation)})}return n}#ur(){let t=Infinity;let e=-Infinity;let s=Infinity;let i=-Infinity;for(const n of this.paths){for(const[a,r,o,l]of n){const n=Util.bezierBoundingBox(...a,...r,...o,...l);t=Math.min(t,n[0]);s=Math.min(s,n[1]);e=Math.max(e,n[2]);i=Math.max(i,n[3])}}return[t,s,e,i]}#or(){return this.#Oa?Math.ceil(this.thickness*this.parentScale):0}#Wa(t=false){if(this.isEmpty()){return}if(!this.#Oa){this.#ja();return}const e=this.#ur();const s=this.#or();this.#Ma=Math.max(AnnotationEditor.MIN_SIZE,e[2]-e[0]);this.#Pa=Math.max(AnnotationEditor.MIN_SIZE,e[3]-e[1]);const i=Math.ceil(s+this.#Ma*this.scaleFactor);const n=Math.ceil(s+this.#Pa*this.scaleFactor);const[a,r]=this.parentDimensions;this.width=i/a;this.height=n/r;this.setAspectRatio(i,n);const o=this.translationX;const l=this.translationY;this.translationX=-e[0];this.translationY=-e[1];this.#qa();this.#ja();this.#Ua=i;this.#za=n;this.setDims(i,n);const h=t?s/this.scaleFactor/2:0;this.translate(o-this.translationX-h,l-this.translationY-h)}static deserialize(t,e,s){if(t instanceof InkAnnotationElement){return null}const i=super.deserialize(t,e,s);i.thickness=t.thickness;i.color=Util.makeHexColor(...t.color);i.opacity=t.opacity;const[n,a]=i.pageDimensions;const r=i.width*n;const o=i.height*a;const l=i.parentScale;const h=t.thickness/2;i.#Oa=true;i.#Ua=Math.round(r);i.#za=Math.round(o);const{paths:c,rect:d,rotation:u}=t;for(let{bezier:t}of c){t=InkEditor.#cr(t,d,u);const e=[];i.paths.push(e);let s=l*(t[0]-h);let n=l*(t[1]-h);for(let i=2,a=t.length;i<a;i+=6){const a=l*(t[i]-h);const r=l*(t[i+1]-h);const o=l*(t[i+2]-h);const c=l*(t[i+3]-h);const d=l*(t[i+4]-h);const u=l*(t[i+5]-h);e.push([[s,n],[a,r],[o,c],[d,u]]);s=d;n=u}const a=this.#lr(e);i.bezierPath2D.push(a)}const p=i.#ur();i.#Ma=Math.max(AnnotationEditor.MIN_SIZE,p[2]-p[0]);i.#Pa=Math.max(AnnotationEditor.MIN_SIZE,p[3]-p[1]);i.#rr(r,o);return i}serialize(){if(this.isEmpty()){return null}const t=this.getRect(0,0);const e=AnnotationEditor._colorManager.convert(this.ctx.strokeStyle);return{annotationType:AnnotationEditorType.INK,color:e,thickness:this.thickness,opacity:this.opacity,paths:this.#dr(this.scaleFactor/this.parentScale,this.translationX,this.translationY,t),pageIndex:this.pageIndex,rect:t,rotation:this.rotation,structTreeParentId:this._structTreeParentId}}}class StampEditor extends AnnotationEditor{#pr=null;#gr=null;#fr=null;#mr=null;#br=null;#_r="";#Ar=null;#Ha=null;#vr=null;#yr=false;#Er=false;static _type="stamp";static _editorType=AnnotationEditorType.STAMP;constructor(t){super({...t,name:"stampEditor"});this.#mr=t.bitmapUrl;this.#br=t.bitmapFile}static initialize(t,e){AnnotationEditor.initialize(t,e)}static get supportedTypes(){const t=["apng","avif","bmp","gif","jpeg","png","svg+xml","webp","x-icon"];return shadow(this,"supportedTypes",t.map(t=>`image/${t}`))}static get supportedTypesStr(){return shadow(this,"supportedTypesStr",this.supportedTypes.join(","))}static isHandlingMimeForPasting(t){return this.supportedTypes.includes(t)}static paste(t,e){e.pasteEditor(AnnotationEditorType.STAMP,{bitmapFile:t.getAsFile()})}#wr(t,e=false){if(!t){this.remove();return}this.#pr=t.bitmap;if(!e){this.#gr=t.id;this.#yr=t.isSvg}if(t.file){this.#_r=t.file.name}this.#$a()}#xr(){this.#fr=null;this._uiManager.enableWaiting(false);if(this.#Ar){this.div.focus()}}#Tr(){if(this.#gr){this._uiManager.enableWaiting(true);this._uiManager.imageManager.getFromId(this.#gr).then(t=>this.#wr(t,true)).finally(()=>this.#xr());return}if(this.#mr){const t=this.#mr;this.#mr=null;this._uiManager.enableWaiting(true);this.#fr=this._uiManager.imageManager.getFromUrl(t).then(t=>this.#wr(t)).finally(()=>this.#xr());return}if(this.#br){const t=this.#br;this.#br=null;this._uiManager.enableWaiting(true);this.#fr=this._uiManager.imageManager.getFromFile(t).then(t=>this.#wr(t)).finally(()=>this.#xr());return}const t=document.createElement("input");t.type="file";t.accept=StampEditor.supportedTypesStr;const e=this._uiManager._signal;this.#fr=new Promise(s=>{t.addEventListener("change",async()=>{if(!t.files||t.files.length===0){this.remove()}else{this._uiManager.enableWaiting(true);const e=await this._uiManager.imageManager.getFromFile(t.files[0]);this.#wr(e)}s()},{signal:e});t.addEventListener("cancel",()=>{this.remove();s()},{signal:e})}).finally(()=>this.#xr());t.click()}remove(){if(this.#gr){this.#pr=null;this._uiManager.imageManager.deleteId(this.#gr);this.#Ar?.remove();this.#Ar=null;this.#Ha?.disconnect();this.#Ha=null;if(this.#vr){clearTimeout(this.#vr);this.#vr=null}}super.remove()}rebuild(){if(!this.parent){if(this.#gr){this.#Tr()}return}super.rebuild();if(this.div===null){return}if(this.#gr&&this.#Ar===null){this.#Tr()}if(!this.isAttachedToDOM){this.parent.add(this)}}onceAdded(){this._isDraggable=true;this.div.focus()}isEmpty(){return!(this.#fr||this.#pr||this.#mr||this.#br||this.#gr)}get isResizable(){return true}render(){if(this.div){return this.div}let t,e;if(this.width){t=this.x;e=this.y}super.render();this.div.hidden=true;this.addAltTextButton();if(this.#pr){this.#$a()}else{this.#Tr()}if(this.width){const[s,i]=this.parentDimensions;this.setAt(t*s,e*i,this.width*s,this.height*i)}return this.div}#$a(){const{div:t}=this;let{width:e,height:s}=this.#pr;const[i,n]=this.pageDimensions;const a=.75;if(this.width){e=this.width*i;s=this.height*n}else if(e>a*i||s>a*n){const t=Math.min(a*i/e,a*n/s);e*=t;s*=t}const[r,o]=this.parentDimensions;this.setDims(e*r/i,s*o/n);this._uiManager.enableWaiting(false);const l=this.#Ar=document.createElement("canvas");t.append(l);t.hidden=false;this.#Sr(e,s);this.#Ka();if(!this.#Er){this.parent.addUndoableEditor(this);this.#Er=true}this._reportTelemetry({action:"inserted_image"});if(this.#_r){l.setAttribute("aria-label",this.#_r)}}#Cr(t,e){const[s,i]=this.parentDimensions;this.width=t/s;this.height=e/i;this.setDims(t,e);if(this._initialOptions?.isCentered){this.center()}else{this.fixAndSetPosition()}this._initialOptions=null;if(this.#vr!==null){clearTimeout(this.#vr)}const n=200;this.#vr=setTimeout(()=>{this.#vr=null;this.#Sr(t,e)},n)}#Pr(t,e){const{width:s,height:i}=this.#pr;let n=s;let a=i;let r=this.#pr;while(n>2*t||a>2*e){const s=n;const i=a;if(n>2*t){n=n>=16384?Math.floor(n/2)-1:Math.ceil(n/2)}if(a>2*e){a=a>=16384?Math.floor(a/2)-1:Math.ceil(a/2)}const o=new OffscreenCanvas(n,a);const l=o.getContext("2d");l.drawImage(r,0,0,s,i,0,0,n,a);r=o.transferToImageBitmap()}return r}#Sr(t,e){t=Math.ceil(t);e=Math.ceil(e);const s=this.#Ar;if(!s||s.width===t&&s.height===e){return}s.width=t;s.height=e;const i=this.#yr?this.#pr:this.#Pr(t,e);if(this._uiManager.hasMLManager&&!this.hasAltText()){const s=new OffscreenCanvas(t,e);const n=s.getContext("2d");n.drawImage(i,0,0,i.width,i.height,0,0,t,e);this._uiManager.mlGuess({service:"image-to-text",request:{data:n.getImageData(0,0,t,e).data,width:t,height:e,channels:4}}).then(t=>{const e=t?.output||"";if(this.parent&&e&&!this.hasAltText()){this.altTextData={altText:e,decorative:false}}})}const n=s.getContext("2d");n.filter=this._uiManager.hcmFilter;n.drawImage(i,0,0,i.width,i.height,0,0,t,e)}getImageForAltText(){return this.#Ar}#Mr(t){if(t){if(this.#yr){const t=this._uiManager.imageManager.getSvgUrl(this.#gr);if(t){return t}}const t=document.createElement("canvas");({width:t.width,height:t.height}=this.#pr);const e=t.getContext("2d");e.drawImage(this.#pr,0,0);return t.toDataURL()}if(this.#yr){const[t,e]=this.pageDimensions;const s=Math.round(this.width*t*PixelsPerInch.PDF_TO_CSS_UNITS);const i=Math.round(this.height*e*PixelsPerInch.PDF_TO_CSS_UNITS);const n=new OffscreenCanvas(s,i);const a=n.getContext("2d");a.drawImage(this.#pr,0,0,this.#pr.width,this.#pr.height,0,0,s,i);return n.transferToImageBitmap()}return structuredClone(this.#pr)}#Ka(){if(!this._uiManager._signal){return}this.#Ha=new ResizeObserver(t=>{const e=t[0].contentRect;if(e.width&&e.height){this.#Cr(e.width,e.height)}});this.#Ha.observe(this.div);this._uiManager._signal.addEventListener("abort",()=>{this.#Ha?.disconnect();this.#Ha=null},{once:true})}static deserialize(t,e,s){if(t instanceof StampAnnotationElement){return null}const i=super.deserialize(t,e,s);const{rect:n,bitmapUrl:a,bitmapId:r,isSvg:o,accessibilityData:l}=t;if(r&&s.imageManager.isValidId(r)){i.#gr=r}else{i.#mr=a}i.#yr=o;const[h,c]=i.pageDimensions;i.width=(n[2]-n[0])/h;i.height=(n[3]-n[1])/c;if(l){i.altTextData=l}return i}serialize(t=false,e=null){if(this.isEmpty()){return null}const s={annotationType:AnnotationEditorType.STAMP,bitmapId:this.#gr,pageIndex:this.pageIndex,rect:this.getRect(0,0),rotation:this.rotation,isSvg:this.#yr,structTreeParentId:this._structTreeParentId};if(t){s.bitmapUrl=this.#Mr(true);s.accessibilityData=this.altTextData;return s}const{decorative:i,altText:n}=this.altTextData;if(!i&&n){s.accessibilityData={type:"Figure",alt:n}}if(e===null){return s}e.stamps||=new Map;const a=this.#yr?(s.rect[2]-s.rect[0])*(s.rect[3]-s.rect[1]):null;if(!e.stamps.has(this.#gr)){e.stamps.set(this.#gr,{area:a,serialized:s});s.bitmap=this.#Mr(false)}else if(this.#yr){const t=e.stamps.get(this.#gr);if(a>t.area){t.area=a;t.serialized.bitmap.close();t.serialized.bitmap=this.#Mr(false)}}return s}}class AnnotationEditorLayer{#Gi;#kr=false;#Ir=null;#Rr=null;#Fr=null;#Lr=null;#Dr=null;#Or=new Map;#Nr=false;#Br=false;#Hr=false;#Ur=null;#k;static _initialized=false;static#Q=new Map([FreeTextEditor,InkEditor,StampEditor,HighlightEditor].map(t=>[t._editorType,t]));constructor({uiManager:t,pageIndex:e,div:s,accessibilityManager:i,annotationLayer:n,drawLayer:a,textLayer:r,viewport:o,l10n:l}){const h=[...AnnotationEditorLayer.#Q.values()];if(!AnnotationEditorLayer._initialized){AnnotationEditorLayer._initialized=true;for(const e of h){e.initialize(l,t)}}t.registerEditorTypes(h);this.#k=t;this.pageIndex=e;this.div=s;this.#Gi=i;this.#Ir=n;this.viewport=o;this.#Ur=r;this.drawLayer=a;this.#k.addLayer(this)}get isEmpty(){return this.#Or.size===0}get isInvisible(){return this.isEmpty&&this.#k.getMode()===AnnotationEditorType.NONE}updateToolbar(t){this.#k.updateToolbar(t)}updateMode(t=this.#k.getMode()){this.#zr();switch(t){case AnnotationEditorType.NONE:this.disableTextSelection();this.togglePointerEvents(false);this.toggleAnnotationLayerPointerEvents(true);this.disableClick();return;case AnnotationEditorType.INK:this.addInkEditorIfNeeded(false);this.disableTextSelection();this.togglePointerEvents(true);this.disableClick();break;case AnnotationEditorType.HIGHLIGHT:this.enableTextSelection();this.togglePointerEvents(false);this.disableClick();break;default:this.disableTextSelection();this.togglePointerEvents(true);this.enableClick()}this.toggleAnnotationLayerPointerEvents(false);const{classList:e}=this.div;for(const s of AnnotationEditorLayer.#Q.values()){e.toggle(`${s._type}Editing`,t===s._editorType)}this.div.hidden=false}hasTextLayer(t){return t===this.#Ur?.div}addInkEditorIfNeeded(t){if(this.#k.getMode()!==AnnotationEditorType.INK){return}if(!t){for(const t of this.#Or.values()){if(t.isEmpty()){t.setInBackground();return}}}const e=this.createAndAddNewEditor({offsetX:0,offsetY:0},false);e.setInBackground()}setEditingState(t){this.#k.setEditingState(t)}addCommands(t){this.#k.addCommands(t)}togglePointerEvents(t=false){this.div.classList.toggle("disabled",!t)}toggleAnnotationLayerPointerEvents(t=false){this.#Ir?.div.classList.toggle("disabled",!t)}enable(){this.div.tabIndex=0;this.togglePointerEvents(true);const t=new Set;for(const e of this.#Or.values()){e.enableEditing();e.show(true);if(e.annotationElementId){this.#k.removeChangedExistingAnnotation(e);t.add(e.annotationElementId)}}if(!this.#Ir){return}const e=this.#Ir.getEditableAnnotations();for(const s of e){s.hide();if(this.#k.isDeletedAnnotationElement(s.data.id)){continue}if(t.has(s.data.id)){continue}const e=this.deserialize(s);if(!e){continue}this.addOrRebuild(e);e.enableEditing()}}disable(){this.#Hr=true;this.div.tabIndex=-1;this.togglePointerEvents(false);const t=new Map;const e=new Map;for(const s of this.#Or.values()){s.disableEditing();if(!s.annotationElementId){continue}if(s.serialize()!==null){t.set(s.annotationElementId,s);continue}else{e.set(s.annotationElementId,s)}this.getEditableAnnotation(s.annotationElementId)?.show();s.remove()}if(this.#Ir){const s=this.#Ir.getEditableAnnotations();for(const i of s){const{id:s}=i.data;if(this.#k.isDeletedAnnotationElement(s)){continue}let n=e.get(s);if(n){n.resetAnnotationElement(i);n.show(false);i.show();continue}n=t.get(s);if(n){this.#k.addChangedExistingAnnotation(n);n.renderAnnotationElement(i);n.show(false)}i.show()}}this.#zr();if(this.isEmpty){this.div.hidden=true}const{classList:s}=this.div;for(const t of AnnotationEditorLayer.#Q.values()){s.remove(`${t._type}Editing`)}this.disableTextSelection();this.toggleAnnotationLayerPointerEvents(true);this.#Hr=false}getEditableAnnotation(t){return this.#Ir?.getEditableAnnotation(t)||null}setActiveEditor(t){const e=this.#k.getActive();if(e===t){return}this.#k.setActiveEditor(t)}enableTextSelection(){this.div.tabIndex=-1;if(this.#Ur?.div&&!this.#Lr){this.#Lr=this.#Gr.bind(this);this.#Ur.div.addEventListener("pointerdown",this.#Lr,{signal:this.#k._signal});this.#Ur.div.classList.add("highlighting")}}disableTextSelection(){this.div.tabIndex=0;if(this.#Ur?.div&&this.#Lr){this.#Ur.div.removeEventListener("pointerdown",this.#Lr);this.#Lr=null;this.#Ur.div.classList.remove("highlighting")}}#Gr(t){this.#k.unselectAll();if(t.target===this.#Ur.div){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}this.#k.showAllEditors("highlight",true,true);this.#Ur.div.classList.add("free");HighlightEditor.startHighlighting(this,this.#k.direction==="ltr",t);this.#Ur.div.addEventListener("pointerup",()=>{this.#Ur.div.classList.remove("free")},{once:true,signal:this.#k._signal});t.preventDefault()}}enableClick(){if(this.#Fr){return}const t=this.#k._signal;this.#Fr=this.pointerdown.bind(this);this.#Rr=this.pointerup.bind(this);this.div.addEventListener("pointerdown",this.#Fr,{signal:t});this.div.addEventListener("pointerup",this.#Rr,{signal:t})}disableClick(){if(!this.#Fr){return}this.div.removeEventListener("pointerdown",this.#Fr);this.div.removeEventListener("pointerup",this.#Rr);this.#Fr=null;this.#Rr=null}attach(t){this.#Or.set(t.id,t);const{annotationElementId:e}=t;if(e&&this.#k.isDeletedAnnotationElement(e)){this.#k.removeDeletedAnnotationElement(t)}}detach(t){this.#Or.delete(t.id);this.#Gi?.removePointerInTextLayer(t.contentDiv);if(!this.#Hr&&t.annotationElementId){this.#k.addDeletedAnnotationElement(t)}}remove(t){this.detach(t);this.#k.removeEditor(t);t.div.remove();t.isAttachedToDOM=false;if(!this.#Br){this.addInkEditorIfNeeded(false)}}changeParent(t){if(t.parent===this){return}if(t.parent&&t.annotationElementId){this.#k.addDeletedAnnotationElement(t.annotationElementId);AnnotationEditor.deleteAnnotationElement(t);t.annotationElementId=null}this.attach(t);t.parent?.detach(t);t.setParent(this);if(t.div&&t.isAttachedToDOM){t.div.remove();this.div.append(t.div)}}add(t){if(t.parent===this&&t.isAttachedToDOM){return}this.changeParent(t);this.#k.addEditor(t);this.attach(t);if(!t.isAttachedToDOM){const e=t.render();this.div.append(e);t.isAttachedToDOM=true}t.fixAndSetPosition();t.onceAdded();this.#k.addToAnnotationStorage(t);t._reportTelemetry(t.telemetryInitialData)}moveEditorInDOM(t){if(!t.isAttachedToDOM){return}const{activeElement:e}=document;if(t.div.contains(e)&&!this.#Dr){t._focusEventsAllowed=false;this.#Dr=setTimeout(()=>{this.#Dr=null;if(!t.div.contains(document.activeElement)){t.div.addEventListener("focusin",()=>{t._focusEventsAllowed=true},{once:true,signal:this.#k._signal});e.focus()}else{t._focusEventsAllowed=true}},0)}t._structTreeParentId=this.#Gi?.moveElementInDOM(this.div,t.div,t.contentDiv,true)}addOrRebuild(t){if(t.needsToBeRebuilt()){t.parent||=this;t.rebuild();t.show()}else{this.add(t)}}addUndoableEditor(t){const e=()=>t._uiManager.rebuild(t);const s=()=>{t.remove()};this.addCommands({cmd:e,undo:s,mustExec:false})}getNextId(){return this.#k.getId()}get#Vr(){return AnnotationEditorLayer.#Q.get(this.#k.getMode())}get _signal(){return this.#k._signal}#Wr(t){const e=this.#Vr;return e?new e.prototype.constructor(t):null}canCreateNewEmptyEditor(){return this.#Vr?.canCreateNewEmptyEditor()}pasteEditor(t,e){this.#k.updateToolbar(t);this.#k.updateMode(t);const{offsetX:s,offsetY:i}=this.#jr();const n=this.getNextId();const a=this.#Wr({parent:this,id:n,x:s,y:i,uiManager:this.#k,isCentered:true,...e});if(a){this.add(a)}}deserialize(t){return AnnotationEditorLayer.#Q.get(t.annotationType??t.annotationEditorType)?.deserialize(t,this,this.#k)||null}createAndAddNewEditor(t,e,s={}){const i=this.getNextId();const n=this.#Wr({parent:this,id:i,x:t.offsetX,y:t.offsetY,uiManager:this.#k,isCentered:e,...s});if(n){this.add(n)}return n}#jr(){const{x:t,y:e,width:s,height:i}=this.div.getBoundingClientRect();const n=Math.max(0,t);const a=Math.max(0,e);const r=Math.min(window.innerWidth,t+s);const o=Math.min(window.innerHeight,e+i);const l=(n+r)/2-t;const h=(a+o)/2-e;const[c,d]=this.viewport.rotation%180===0?[l,h]:[h,l];return{offsetX:c,offsetY:d}}addNewEditor(){this.createAndAddNewEditor(this.#jr(),true)}setSelected(t){this.#k.setSelected(t)}toggleSelected(t){this.#k.toggleSelected(t)}isSelected(t){return this.#k.isSelected(t)}unselect(t){this.#k.unselect(t)}pointerup(t){const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}if(t.target!==this.div){return}if(!this.#Nr){return}this.#Nr=false;if(!this.#kr){this.#kr=true;return}if(this.#k.getMode()===AnnotationEditorType.STAMP){this.#k.unselectAll();return}this.createAndAddNewEditor(t,false)}pointerdown(t){if(this.#k.getMode()===AnnotationEditorType.HIGHLIGHT){this.enableTextSelection()}if(this.#Nr){this.#Nr=false;return}const{isMac:e}=util_FeatureTest.platform;if(t.button!==0||t.ctrlKey&&e){return}if(t.target!==this.div){return}this.#Nr=true;const s=this.#k.getActive();this.#kr=!s||s.isEmpty()}findNewParent(t,e,s){const i=this.#k.findParent(e,s);if(i===null||i===this){return false}i.changeParent(t);return true}destroy(){if(this.#k.getActive()?.parent===this){this.#k.commitOrRemove();this.#k.setActiveEditor(null)}if(this.#Dr){clearTimeout(this.#Dr);this.#Dr=null}for(const t of this.#Or.values()){this.#Gi?.removePointerInTextLayer(t.contentDiv);t.setParent(null);t.isAttachedToDOM=false;t.div.remove()}this.div=null;this.#Or.clear();this.#k.removeLayer(this)}#zr(){this.#Br=true;for(const t of this.#Or.values()){if(t.isEmpty()){t.remove()}}this.#Br=false}render({viewport:t}){this.viewport=t;setLayerDimensions(this.div,t);for(const t of this.#k.getEditors(this.pageIndex)){this.add(t);t.rebuild()}this.updateMode()}update({viewport:t}){this.#k.commitOrRemove();this.#zr();const e=this.viewport.rotation;const s=t.rotation;this.viewport=t;setLayerDimensions(this.div,{rotation:s});if(e!==s){for(const t of this.#Or.values()){t.rotate(s)}}this.addInkEditorIfNeeded(false)}get pageDimensions(){const{pageWidth:t,pageHeight:e}=this.viewport.rawDims;return[t,e]}get scale(){return this.#k.viewParameters.realScale}}class DrawLayer{#Ei=null;#l=0;#$r=new Map;#Kr=new Map;constructor({pageIndex:t}){this.pageIndex=t}setParent(t){if(!this.#Ei){this.#Ei=t;return}if(this.#Ei!==t){if(this.#$r.size>0){for(const e of this.#$r.values()){e.remove();t.append(e)}}this.#Ei=t}}static get _svgFactory(){return shadow(this,"_svgFactory",new DOMSVGFactory)}static#qr(t,{x:e=0,y:s=0,width:i=1,height:n=1}={}){const{style:a}=t;a.top=`${100*s}%`;a.left=`${100*e}%`;a.width=`${100*i}%`;a.height=`${100*n}%`}#Xr(t){const e=DrawLayer._svgFactory.create(1,1,true);this.#Ei.append(e);e.setAttribute("aria-hidden",true);DrawLayer.#qr(e,t);return e}#Yr(t,e){const s=DrawLayer._svgFactory.createElement("clipPath");t.append(s);const i=`clip_${e}`;s.setAttribute("id",i);s.setAttribute("clipPathUnits","objectBoundingBox");const n=DrawLayer._svgFactory.createElement("use");s.append(n);n.setAttribute("href",`#${e}`);n.classList.add("clip");return i}highlight(t,e,s,i=false){const n=this.#l++;const a=this.#Xr(t.box);a.classList.add("highlight");if(t.free){a.classList.add("free")}const r=DrawLayer._svgFactory.createElement("defs");a.append(r);const o=DrawLayer._svgFactory.createElement("path");r.append(o);const l=`path_p${this.pageIndex}_${n}`;o.setAttribute("id",l);o.setAttribute("d",t.toSVGPath());if(i){this.#Kr.set(n,o)}const h=this.#Yr(r,l);const c=DrawLayer._svgFactory.createElement("use");a.append(c);a.setAttribute("fill",e);a.setAttribute("fill-opacity",s);c.setAttribute("href",`#${l}`);this.#$r.set(n,a);return{id:n,clipPathId:`url(#${h})`}}highlightOutline(t){const e=this.#l++;const s=this.#Xr(t.box);s.classList.add("highlightOutline");const i=DrawLayer._svgFactory.createElement("defs");s.append(i);const n=DrawLayer._svgFactory.createElement("path");i.append(n);const a=`path_p${this.pageIndex}_${e}`;n.setAttribute("id",a);n.setAttribute("d",t.toSVGPath());n.setAttribute("vector-effect","non-scaling-stroke");let r;if(t.free){s.classList.add("free");const t=DrawLayer._svgFactory.createElement("mask");i.append(t);r=`mask_p${this.pageIndex}_${e}`;t.setAttribute("id",r);t.setAttribute("maskUnits","objectBoundingBox");const n=DrawLayer._svgFactory.createElement("rect");t.append(n);n.setAttribute("width","1");n.setAttribute("height","1");n.setAttribute("fill","white");const o=DrawLayer._svgFactory.createElement("use");t.append(o);o.setAttribute("href",`#${a}`);o.setAttribute("stroke","none");o.setAttribute("fill","black");o.setAttribute("fill-rule","nonzero");o.classList.add("mask")}const o=DrawLayer._svgFactory.createElement("use");s.append(o);o.setAttribute("href",`#${a}`);if(r){o.setAttribute("mask",`url(#${r})`)}const l=o.cloneNode();s.append(l);o.classList.add("mainOutline");l.classList.add("secondaryOutline");this.#$r.set(e,s);return e}finalizeLine(t,e){const s=this.#Kr.get(t);this.#Kr.delete(t);this.updateBox(t,e.box);s.setAttribute("d",e.toSVGPath())}updateLine(t,e){const s=this.#$r.get(t);const i=s.firstChild;const n=i.firstChild;n.setAttribute("d",e.toSVGPath())}removeFreeHighlight(t){this.remove(t);this.#Kr.delete(t)}updatePath(t,e){this.#Kr.get(t).setAttribute("d",e.toSVGPath())}updateBox(t,e){DrawLayer.#qr(this.#$r.get(t),e)}show(t,e){this.#$r.get(t).classList.toggle("hidden",!e)}rotate(t,e){this.#$r.get(t).setAttribute("data-main-rotation",e)}changeColor(t,e){this.#$r.get(t).setAttribute("fill",e)}changeOpacity(t,e){this.#$r.get(t).setAttribute("fill-opacity",e)}addClass(t,e){this.#$r.get(t).classList.add(e)}removeClass(t,e){this.#$r.get(t).classList.remove(e)}remove(t){if(this.#Ei===null){return}this.#$r.get(t).remove();this.#$r.delete(t)}destroy(){this.#Ei=null;for(const t of this.#$r.values()){t.remove()}this.#$r.clear()}}const pdfjsVersion="4.4.168";const pdfjsBuild="19fbc8998";var __webpack_exports__AbortException=__webpack_exports__.AbortException;var __webpack_exports__AnnotationEditorLayer=__webpack_exports__.AnnotationEditorLayer;var __webpack_exports__AnnotationEditorParamsType=__webpack_exports__.AnnotationEditorParamsType;var __webpack_exports__AnnotationEditorType=__webpack_exports__.AnnotationEditorType;var __webpack_exports__AnnotationEditorUIManager=__webpack_exports__.AnnotationEditorUIManager;var __webpack_exports__AnnotationLayer=__webpack_exports__.AnnotationLayer;var __webpack_exports__AnnotationMode=__webpack_exports__.AnnotationMode;var __webpack_exports__CMapCompressionType=__webpack_exports__.CMapCompressionType;var __webpack_exports__ColorPicker=__webpack_exports__.ColorPicker;var __webpack_exports__DOMSVGFactory=__webpack_exports__.DOMSVGFactory;var __webpack_exports__DrawLayer=__webpack_exports__.DrawLayer;var __webpack_exports__FeatureTest=__webpack_exports__.FeatureTest;var __webpack_exports__GlobalWorkerOptions=__webpack_exports__.GlobalWorkerOptions;var __webpack_exports__ImageKind=__webpack_exports__.ImageKind;var __webpack_exports__InvalidPDFException=__webpack_exports__.InvalidPDFException;var __webpack_exports__MissingPDFException=__webpack_exports__.MissingPDFException;var __webpack_exports__OPS=__webpack_exports__.OPS;var __webpack_exports__Outliner=__webpack_exports__.Outliner;var __webpack_exports__PDFDataRangeTransport=__webpack_exports__.PDFDataRangeTransport;var __webpack_exports__PDFDateString=__webpack_exports__.PDFDateString;var __webpack_exports__PDFWorker=__webpack_exports__.PDFWorker;var __webpack_exports__PasswordResponses=__webpack_exports__.PasswordResponses;var __webpack_exports__PermissionFlag=__webpack_exports__.PermissionFlag;var __webpack_exports__PixelsPerInch=__webpack_exports__.PixelsPerInch;var __webpack_exports__RenderingCancelledException=__webpack_exports__.RenderingCancelledException;var __webpack_exports__TextLayer=__webpack_exports__.TextLayer;var __webpack_exports__UnexpectedResponseException=__webpack_exports__.UnexpectedResponseException;var __webpack_exports__Util=__webpack_exports__.Util;var __webpack_exports__VerbosityLevel=__webpack_exports__.VerbosityLevel;var __webpack_exports__XfaLayer=__webpack_exports__.XfaLayer;var __webpack_exports__build=__webpack_exports__.build;var __webpack_exports__createValidAbsoluteUrl=__webpack_exports__.createValidAbsoluteUrl;var __webpack_exports__fetchData=__webpack_exports__.fetchData;var __webpack_exports__getDocument=__webpack_exports__.getDocument;var __webpack_exports__getFilenameFromUrl=__webpack_exports__.getFilenameFromUrl;var __webpack_exports__getPdfFilenameFromUrl=__webpack_exports__.getPdfFilenameFromUrl;var __webpack_exports__getXfaPageViewport=__webpack_exports__.getXfaPageViewport;var __webpack_exports__isDataScheme=__webpack_exports__.isDataScheme;var __webpack_exports__isPdfFile=__webpack_exports__.isPdfFile;var __webpack_exports__noContextMenu=__webpack_exports__.noContextMenu;var __webpack_exports__normalizeUnicode=__webpack_exports__.normalizeUnicode;var __webpack_exports__renderTextLayer=__webpack_exports__.renderTextLayer;var __webpack_exports__setLayerDimensions=__webpack_exports__.setLayerDimensions;var __webpack_exports__shadow=__webpack_exports__.shadow;var __webpack_exports__updateTextLayer=__webpack_exports__.updateTextLayer;var __webpack_exports__version=__webpack_exports__.version;export{__webpack_exports__AbortException as AbortException,__webpack_exports__AnnotationEditorLayer as AnnotationEditorLayer,__webpack_exports__AnnotationEditorParamsType as AnnotationEditorParamsType,__webpack_exports__AnnotationEditorType as AnnotationEditorType,__webpack_exports__AnnotationEditorUIManager as AnnotationEditorUIManager,__webpack_exports__AnnotationLayer as AnnotationLayer,__webpack_exports__AnnotationMode as AnnotationMode,__webpack_exports__CMapCompressionType as CMapCompressionType,__webpack_exports__ColorPicker as ColorPicker,__webpack_exports__DOMSVGFactory as DOMSVGFactory,__webpack_exports__DrawLayer as DrawLayer,__webpack_exports__FeatureTest as FeatureTest,__webpack_exports__GlobalWorkerOptions as GlobalWorkerOptions,__webpack_exports__ImageKind as ImageKind,__webpack_exports__InvalidPDFException as InvalidPDFException,__webpack_exports__MissingPDFException as MissingPDFException,__webpack_exports__OPS as OPS,__webpack_exports__Outliner as Outliner,__webpack_exports__PDFDataRangeTransport as PDFDataRangeTransport,__webpack_exports__PDFDateString as PDFDateString,__webpack_exports__PDFWorker as PDFWorker,__webpack_exports__PasswordResponses as PasswordResponses,__webpack_exports__PermissionFlag as PermissionFlag,__webpack_exports__PixelsPerInch as PixelsPerInch,__webpack_exports__RenderingCancelledException as RenderingCancelledException,__webpack_exports__TextLayer as TextLayer,__webpack_exports__UnexpectedResponseException as UnexpectedResponseException,__webpack_exports__Util as Util,__webpack_exports__VerbosityLevel as VerbosityLevel,__webpack_exports__XfaLayer as XfaLayer,__webpack_exports__build as build,__webpack_exports__createValidAbsoluteUrl as createValidAbsoluteUrl,__webpack_exports__fetchData as fetchData,__webpack_exports__getDocument as getDocument,__webpack_exports__getFilenameFromUrl as getFilenameFromUrl,__webpack_exports__getPdfFilenameFromUrl as getPdfFilenameFromUrl,__webpack_exports__getXfaPageViewport as getXfaPageViewport,__webpack_exports__isDataScheme as isDataScheme,__webpack_exports__isPdfFile as isPdfFile,__webpack_exports__noContextMenu as noContextMenu,__webpack_exports__normalizeUnicode as normalizeUnicode,__webpack_exports__renderTextLayer as renderTextLayer,__webpack_exports__setLayerDimensions as setLayerDimensions,__webpack_exports__shadow as shadow,__webpack_exports__updateTextLayer as updateTextLayer,__webpack_exports__version as version};
//# sourceMappingURL=pdf.js.map