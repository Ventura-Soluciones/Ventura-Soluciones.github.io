/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../NodeContentType","./Element","./Rectangle","./Path","sap/base/assert","sap/base/util/uid","../TransformationMatrix","../thirdparty/imagetracer","../uuidv4"],function(t,e,r,a,i,n,o,s,l){"use strict";var u=function(){};u.prototype.duplicateHotspot=function(t,r,a,i){t=Array.isArray(t)?t:[t];var n;if(a){n=e._multiplyMatrices(e._invertMatrix(t[0]._matrixWorld()),a)}else if(i){var o=i._camera._transformRect({x1:0,y1:0,x2:30,y2:30});n=[1,0,0,1,o.x2-o.x1,o.y2-o.y1]}var s=e._invertMatrix(r._matrixWorld());var l=[];t.forEach(function(t){var a=t.clone();a.userData.duplicatedFrom=t.sid;var i=e._multiplyMatrices(n,t._matrixWorld());var o=e._multiplyMatrices(s,i);a.matrix.set(o);r.add(a);l.push(a)});return l};u.prototype.updateHotspot=function(a){var i=a.children.length;while(i-- >0){var n=a.children[i];if(n.userData.sourceJointNode!==undefined){a.remove(n)}}var o=e._invertMatrix(a._matrixWorld());function s(i){i.traverse(function(i){if(i.nodeContentType===t.Hotspot||i.parent===a){return}var n;if(i.type==="Image"){n=new r({x:i.x,y:i.y,width:i.width,height:i.height})}else if(i.type!=="Group"){n=(new i.constructor).copy(i,false)}if(n){n.matrix=e._multiplyMatrices(o,i._matrixWorld());n.userData.sourceJointNode=i;a.add(n)}})}const l=a.userData.jointNodes;if(l){l.forEach(function(e){if(e.nodeContentType!==t.Hotspot&&e.parent!==a){s(e)}})}a._initAsHotspot()};u.prototype.mergeHotspots=function(r,a){var i=r.getDefaultNodeHierarchy();var s=a[0];var l=s.getPageIndex();var u=i.createNode(null,s.name,null,t.Hotspot,{sid:n()});if(l!=null){u.setPageIndex(l)}var d=[],h=[];var c=e._invertMatrix(u._matrixWorld());var f=function(t,e){return e._vkGetNodeContentType()===t};a.forEach(function(r){if(r.children.every(f.bind(null,t.Hotspot))){var a=r.children.length;while(a--){var i=r.children[0];var n=e._multiplyMatrices(c,i._matrixWorld());r.remove(i);u.add(i);i.matrix=n;d.push(i)}h.push(r)}else if(r.children.every(f.bind(null,t.Regular))){r.parent.remove(r);u.add(r);r.matrix=e._multiplyMatrices(c,r._matrixWorld());d.push(r)}});if(d){u.userData.jointNodes=Array.from(d)}if(s.hotspotColor!=null){u.setHotspotColor(s.vMask,s.hotspotColor)}if(s.customHotspotColor!=null){u.setCustomHotspotColor(s.vMask,s.customHotspotColor)}i.removeNode(h);var p=[],m=[],v=[],g=[],x=[];var y={name:u.name,contentType:t.Hotspot,joints:[],children:[]};if(l!=null){y.pageIndex=l}u.userData.jointNodes.forEach(function(e,r){var a=e.getParametricContent(v,g,x);m.push(a);const i={name:e.name,transform:o.convert3x2To4x3(e.matrix),parametric:r,contentType:t.Hotspot};if(l!=null){i.pageIndex=l}p.push(i);y.joints.push({child:r,type:"LINK",action:"bubble"});y.children.push(r)});p.push(y);a.forEach(function(t){p.push({suppressed:true,sid:t.sid})});var w=r.getViewStateManager().getCurrentView();return{nodeRef:u,request:{views:[{id:w?.getViewId(),name:w?.getName(),nodes:p}],parametrics:m,fillstyles:v,linestyles:g,textStyles:x}}};u.prototype.mergeElements=function(r,a){i(a.length&&"HotspotHelper.mergeElements: at least one node must be provided");var o=r.createNode(null,a[0].name,null,t.Regular,{sid:n()});var s=e._invertMatrix(o._matrixWorld());var l={name:o.name,contentType:"geometry",parametric:0};var u=[l],d=[],h=[],c=[],f=[];var p=new Set;a.forEach(function(t){t.traverse(function(t){if(t._isGeometryNode()){p.add(t)}})});a.forEach(function(t){u.push({suppressed:true,sid:t.sid})});p.forEach(function(t){var r=t._matrixWorld();t.parent.remove(t);o.add(t);t.setMatrix(e._multiplyMatrices(s,r));t.userData.skipIt=true;var a=t._getParametricShape(h,c,f);if(a.type!==undefined){d.push(a)}});a.forEach(function(t){if(!p.has(t)){t.parent.remove(t)}});var m={nodes:u,parametrics:[{shapes:d}]};if(h.length>0){m.fillStyles=h}if(c.length>0){m.lineStyles=c}if(f.length>0){m.textStyles=f}return{nodeRef:o,request:m}};u.prototype.createHotspotFromGeometry=function(r,i,n){return new Promise(function(o,l){r=Array.isArray(r)?r:[r];var u=[];r.forEach(function(t){t.traverseVisible(function(t){if(t._isGeometryNode()){u.push(t)}},-1>>>0)});if(u.length===1){switch(u[0].type){case"Rectangle":case"Ellipse":case"Line":var d=i.createNode(n,r[0].name,null,t.Hotspot);d.setMatrix(e._multiplyMatrices(e._invertMatrix(d.parent._matrixWorld()),u[0]._matrixWorld()));var h=u[0].clone();h.setMatrix([1,0,0,1,0,0]);d.add(h);o(d);return;default:break}}var c;var f=document.createElementNS("http://www.w3.org/2000/svg","svg");u.forEach(function(t){var e=t._getBBox(t._matrixWorld());if(!c){c=e}else{c.width=Math.max(c.x+c.width,e.x+e.width);c.height=Math.max(c.y+c.height,e.y+e.height);c.x=Math.min(c.x,e.x);c.y=Math.min(c.y,e.y);c.width-=c.x;c.height-=c.y}var r=t.domRef.cloneNode(true);if(r.getAttribute("fill")){r.setAttribute("fill","#000")}if(r.getAttribute("stroke")){r.setAttribute("stroke","#000")}r.setAttribute("transform","matrix("+t._matrixWorld().join(",")+")");f.appendChild(r)});var p=c.width*.05;var m=c.height*.05;c.x-=p;c.y-=m;c.width+=p*2;c.height+=m*2;f.setAttribute("width",Math.ceil(1e3*c.width/Math.max(c.width,c.height)));f.setAttribute("height",Math.ceil(1e3*c.height/Math.max(c.width,c.height)));f.setAttribute("viewBox",[c.x,c.y,c.width,c.height].join(" "));f.setAttribute("font-family",'"72","72full",Arial,Helvetica,sans-serif');var v=new Image;v.onload=function(){var u=document.createElement("canvas");var d=u.width=this.width;var h=u.height=this.height;var f=u.getContext("2d");var p=i.createNode(n,r[0].name,null,t.Hotspot);var m=p.parent._matrixWorld();var v=m[3]<0;if(v){p.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/d,0,0,-c.height/h,c.x,c.y+c.height]));f.transform(1,0,0,-1,0,h)}else{p.setMatrix(e._multiplyMatrices(e._invertMatrix(m),[c.width/d,0,0,c.height/h,c.x,c.y]))}f.drawImage(this,0,0,d,h);var g=f.getImageData(0,0,d,h);function x(t,e){return t+e*d<<2}var y=f.createImageData(d,h);var w,_;var M,b;function H(t,e){return t>=0&&t<d&&e>=0&&e<h?M[x(t,e)+3]:0}for(var N=0;N<2;N++){M=g.data;b=y.data;for(_=1;_<h;_++){for(w=1;w<d;w++){if(H(w,_)>127||H(w-1,_)>127||H(w+1,_)>127||H(w,_-1)>127||H(w,_+1)>127){b[x(w,_)+3]=255}}}var C=g;g=y;y=C}var A=g.data;function E(t,e){var r=x(t,e);return A[r+3]<128&&A[r]!==1}var I=[0,0];while(I.length>0){_=I.pop();w=I.pop();A[x(w,_)]=1;if(w+1<d&&E(w+1,_)){I.push(w+1,_)}if(w>0&&E(w-1,_)){I.push(w-1,_)}if(_+1<h&&E(w,_+1)){I.push(w,_+1)}if(_>0&&E(w,_-1)){I.push(w,_-1)}}for(_=0;_<h;_++){for(w=0;w<d;w++){if(E(w,_)){A[x(w,_)+3]=255}}}var S=s.imagedataToSVG(g,{ltres:2,qtres:2,pathomit:8,rightangleenhance:false,colorsampling:0,numberofcolors:2,mincolorratio:0,colorquantcycles:1,blurradius:0,blurdelta:20,strokewidth:0,linefilter:true,roundcoords:0,pal:[{r:0,g:0,b:0,a:0},{r:0,g:0,b:0,a:255}],desc:false});var T=[];var D=(new DOMParser).parseFromString(S,"image/svg+xml");if(D&&D.firstChild&&D.firstChild.tagName==="svg"){for(var W=D.firstChild.firstChild;W!==null;W=W.nextSibling){if(W.tagName==="path"&&W.getAttribute("opacity")>.5){T=T.concat(a._extractSegmentsFromDomRef(W))}}}if(T.length>0){p.add(new a({segments:T}));o(p)}else{p.parent.remove(p);l()}};v.src="data:image/svg+xml;base64,"+btoa((new XMLSerializer).serializeToString(f))})};u.prototype.createRequest=function(e,r){if(!e||!r){return null}var a=[];var i=[];var n=[];var s=[];var u=[];var d=r&&r._currentView;function h(e,r){r.setNodePersistentId(e,l());var d={name:e.name,transform:o.convert3x2To4x3(e.matrix),veId:e.sid};const c=e.getPageIndex();if(c!=null){d.pageIndex=c}if(e.nodeContentType===t.Hotspot){d.contentType="HOTSPOT"}if(e.userData.duplicatedFrom){d.duplicatedFrom=e.userData.duplicatedFrom;delete e.userData.duplicatedFrom}var f=e.getParametricContent(n,s,u);if(f){d.parametric=i.length;i.push(f)}var p=a.length;a.push(d);var m=e.children;if(m.length>0){var v=[];for(var g=0;g<m.length;g++){if(m[g].type==="Group"){v.push(h(m[g],r))}}if(v.length>0){d.children=v}}return p}var c=r.getScene();(Array.isArray(e)?e:[e]).forEach(function(t){h(t,c)});var f={views:[{id:d&&d.getViewId(),nodes:a}],parametrics:i};if(n.length>0){f.fillstyles=n}if(s.length>0){f.linestyles=s}if(u.length>0){f.textStyles=u}return f};return u});
//# sourceMappingURL=HotspotHelper.js.map