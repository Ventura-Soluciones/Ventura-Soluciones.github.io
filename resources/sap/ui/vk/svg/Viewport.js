/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["../Core","../ViewportBase","sap/ui/core/Element","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../ViewStateManager","./ViewStateManager","../ViewportHandler","../VisibilityMode","../ZoomTo","../SelectionMode","../NodeContentType","../getResourceBundle","../Messages","./Scene","./OrthographicCamera","../measurements/Surface","./Rectangle","./HotspotHelper","../colorToCSSColor","../cssColorToColor","../colorToABGR","../abgrToColor","./MiniMap","sap/m/Dialog","sap/base/Log","sap/base/i18n/Localization"],function(e,t,i,s,a,r,o,n,h,l,u,d,c,f,m,g,p,_,v,y,w,S,C,R,M,b,x,V){"use strict";var I=t.extend("sap.ui.vk.svg.Viewport",{metadata:{library:"sap.ui.vk",aggregations:{miniMap:{type:"sap.m.Dialog",multiple:false}},events:{cameraChanged:{parameters:{offset:"float[]",zoom:"float"},enableEventBubbling:true},hotspotEnter:{parameters:{nodeRef:"any"},enableEventBubbling:true},hotspotLeave:{parameters:{nodeRef:"any"},enableEventBubbling:true}}}});var E=I.getMetadata().getParent().getClass().prototype;I.prototype.init=function(){if(E.init){E.init.call(this)}this._measurementSurface=new _;this._resizeListenerId=null;this._animLoopRequestId=0;this._animLoopFunction=this._animLoop.bind(this);this._width=this._height=0;this._camera=new p;this._gestureX=0;this._gestureY=0;this._scene=null;this._selectionRect=new v({material:{lineColor:[.75,.75,0,1],lineStyle:{dashPattern:[2,2]}}});this._styles=new Map;this.raster={rasterImage:document.createElement("canvas"),vectorImage:new Image,bmpCanvas:null,rasterMode:false,useRasterMode:false,delayEnd:false,endRasterModeTimer:null,updateImageTimer:null,bmpDrawRequestId:null,nodesThreshold:2500};this.raster.vectorImage.onload=function(){var e=this.raster.vectorImage;var t=this.raster.rasterImage;t.viewBox=e.viewBox;N(t,e.width,e.height);var i=t.getContext("2d");i.clearRect(0,0,t.width,t.height);i.drawImage(e,0,0,t.width,t.height);this._requestBmpDraw()}.bind(this);this._viewportHandler=new h(this);this._loco=new r(this);this._loco.addHandler(this._viewportHandler,-1);this._hotspotHelper=new y;this._currentViewIndex=0;this._currentView=null;e.getEventBus().subscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);V.attachChange(this._onLocalizationChanged.bind(this));const t=this._miniMap=new M({viewport:this});const i=new b({showHeader:false,horizontalScrolling:false,verticalScrolling:false,content:t,escapeHandler:function(){}}).addStyleClass("sapUiVkMiniMapDialog");i.attachBeforeOpen(function(){i.oPopup.setModal(false)});i._calcPosition=()=>{const e=this.getDomRef()?.getBoundingClientRect()??{top:0,right:0};return{top:e.top+16+"px",left:e.right-t._width-16-4+"px"}};t.attachSizeChanged(e=>{i.setContentWidth(e.getParameter("width")+4+"px");i.setContentHeight(e.getParameter("height")+4+"px")});this.setMiniMap(i)};I.prototype.exit=function(){V.detachChange(this._onLocalizationChanged);e.getEventBus().unsubscribe("sap.ui.vk","viewStateApplied",this._onViewStateApplied,this);this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){s.deregister(this._resizeListenerId);this._resizeListenerId=null}this._setScene(null);this._renderer=null;this._loco.destroy();this._loco=null;this._viewportHandler=null;this._miniMap=null;E.exit?.call(this);var t=this.getTools();for(var a=0;a<t.length;a++){var r=i.getElementById(t[a]);if(r){r.setActive(false)}}this._measurementSurface.destroy();this._measurementSurface=null;this.raster.rasterMode=false;this.raster.useRasterMode=false};I.prototype._onLocalizationChanged=function(e){var t=this._measurementSurface;if(t&&t.getMeasurements().length>0){t.update(this,this.getCamera())}};I.prototype.onBeforeRendering=function(){if(this._resizeListenerId){s.deregister(this._resizeListenerId);this._resizeListenerId=null}};I.prototype.onAfterRendering=function(){this._resizeListenerId=s.register(this,this._handleResize.bind(this));var e=this.getDomRef();e.append(this._measurementSurface.getDomRef());if(this._scene){var t=this._scene.getRootElement();t._setDomRef(document.getElementById(t.uid));this._svgElement=t.domRef.parentNode}this._handleResize({size:{width:e.clientWidth,height:e.clientHeight}});this._miniMap._onContentUpdate()};I.prototype._handleResize=function(e){var t=this._width;var i=this._height;this._width=e.size.width;this._height=e.size.height;this._camera.update(this._width,this._height,false);if((t===0||i===0)&&(!this._camera._initialZoom||this._camera._initialZoom<0||!this._camera._initialPosition)){this.zoomTo(u.All,null,0,0)}else{this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}var s=this._measurementSurface.getDomRef();s.style.width=this._width+"px";s.style.height=this._height+"px";const a=this.getMiniMap();a.$().css(a._calcPosition());this.fireResize({size:{width:this._width,height:this._height}});if(this._svgElement!=null){this.raster.bmpCanvas=this._svgElement.previousSibling;this._invalidateRasterImage()}return true};I.prototype.setScene=function(e){return this._setScene(e)};I.prototype._setScene=function(e){if(this._scene){this._scene.getDefaultNodeHierarchy().detachNodeCreated(this._nodeCreatedHandler,this)}this._scene=e;this._currentViewIndex=0;this._currentView=null;this._styles.clear();if(e){this.setCamera(new p);var t=this._scene.getDefaultNodeHierarchy();this.raster.useRasterMode=t.findNodesByName().length>this.raster.nodesThreshold;t.attachNodeCreated(this._nodeCreatedHandler,this);var i=e.getInitialView();if(i){this.activateView(i)}this._onContentLoadingFinished()}return this};I.prototype.setCamera=function(e){if(!(e instanceof p)){return this}if(E.setCamera){E.setCamera.call(this,e)}if(e){e.update(this._width,this._height,true);this._updateViewBox()}return this};I.prototype._nodeCreatedHandler=function(e){var t=e.getParameter("nodeRef");if(t._vkGetNodeContentType()===c.Annotation&&t.children&&t.children.length&&t.children[0].type==="Image"){this.invalidate()}};I.prototype.getScene=function(){return this._scene};I.prototype.onSetViewStateManager=function(e){this._viewStateManager=e;this._miniMap.setViewStateManager(e);e.attachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.attachSelectionChanged(this._onOutliningOrSelectionChanged,this)};I.prototype.onUnsetViewStateManager=function(e){e.detachOutliningChanged(this._onOutliningOrSelectionChanged,this);e.detachSelectionChanged(this._onOutliningOrSelectionChanged,this);this._viewStateManager=null;this._miniMap?.setViewStateManager(null)};I.prototype._getViewStateManagerSVG=function(){if(this._viewStateManager){if(this._viewStateManager instanceof n){return this._viewStateManager}if(this._viewStateManager instanceof o&&this._viewStateManager._implementation instanceof n){return this._viewStateManager._implementation}}return null};I.prototype.hitTest=function(e,t,i,s,a){var r=this._getViewStateManagerSVG();if(!r||!this._scene){return null}var o=this._scene.getRootElement();var n=this.getDomRef().getBoundingClientRect();var h=function(e,t){var i;if(a){var s=document.elementsFromPoint(e+n.x,t+n.y);for(var r=0;r<s.length;r++){i=s[r];var h=i!=null&&i.id?o.getElementById(i.id):null;if(!h){return null}var l=h._getSceneTreeElement();if(l&&l._vkGetNodeContentType()!==c.Hotspot){return h}}return null}else{i=document.elementFromPoint(e+n.x,t+n.y);return i!==null&&i.id?o.getElementById(i.id):null}};var l=h(e,t);if(i){var u=3;var d=3;for(var f=t-d;f<t+d&&!l;f++){for(var m=e-u;m<e+u&&!l;m++){l=h(m,f)}}}if(s){return l}return l?l._getSceneTreeElement():null};I.prototype.tap=function(e,t,i){var s=this.getDomRef();if(s){s.focus()}var a=this.hitTest(e,t,true);if(!i){this.tapObject(a);if(a!==null){this.fireNodeClicked({nodeRef:a,x:e,y:t},true,true)}}else if(!this.getFreezeCamera()){if(a&&this._camera.zoomedObject!==a){this._camera.zoomedObject=a;this.zoomTo(u.Node,this._camera.zoomedObject,.5,.1)}else{this._camera.zoomedObject=null;this.zoomTo(u.Visible,null,.5,0)}}return this};I.prototype.tapObject=function(e){var t={picked:e?[e]:[]};this.fireNodesPicked(t);if(this.getSelectionMode()===d.Exclusive){this.exclusiveSelectionHandler(t.picked)}else if(this.getSelectionMode()===d.Sticky){this.stickySelectionHandler(t.picked)}return this};var B={x:-2,y:-2};var T=2;var H=5;I.prototype.onkeydown=function(e){if(!e.isMarked()){switch(e.keyCode){case a.ARROW_LEFT:case a.ARROW_RIGHT:case a.ARROW_UP:case a.ARROW_DOWN:if(e.ctrlKey||e.altKey||e.metaKey){break}var t={x:0,y:0};switch(e.keyCode){case a.ARROW_LEFT:t.x=-1;break;case a.ARROW_RIGHT:t.x=+1;break;case a.ARROW_UP:t.y=-1;break;case a.ARROW_DOWN:t.y=+1;break;default:break}this.beginGesture(B.x,B.y);if(e.shiftKey){this.pan(H*t.x,H*t.y)}else{this.rotate(T*t.x,T*t.y,true)}this.endGesture();e.preventDefault();e.stopPropagation();break;case 189:case a.PLUS:case a.NUMPAD_MINUS:case a.NUMPAD_PLUS:this.beginGesture(this._width*.5,this._height*.5);this.zoom(e.keyCode===a.PLUS||e.keyCode===a.NUMPAD_PLUS?1.02:.98);this.endGesture();e.preventDefault();e.stopPropagation();break;case a.D:if(e.ctrlKey){this._dumpSceneData()}break;default:break}}};I.prototype._onOutliningOrSelectionChanged=function(e){var t=this.getTools();for(var s=0;s<t.length;s++){var a=i.getElementById(t[s]);var r=a.getGizmoForContainer(this);if(r&&r.handleSelectionChanged){r.handleSelectionChanged(e)}}this._invalidateRasterImage()};I.prototype.setSelectionRect=function(e){var t=document.getElementById(this._selectionRect.uid);if(t){if(e){t.removeAttribute("display");e=this._camera._transformRect(e);t.setAttribute("x",e.x1,e.x2);t.setAttribute("y",e.y1,e.y2);t.setAttribute("width",e.x2-e.x1);t.setAttribute("height",e.y2-e.y1)}else{t.setAttribute("display","none")}}};I.prototype._select=function(e){var t=this._getViewStateManagerSVG();if(t&&this._scene){e=this._camera._transformRect(e);var i=new Set;this._scene.getRootElement()._findRectElementsRecursive(i,e,t._mask);return Array.from(i)}return[]};I.prototype.getImage=function(e,t,i,s,a){return null};I.prototype._setContent=function(e){E._setContent.apply(this,arguments);this._setScene(e instanceof g?e:null);if(this._measurementSurface!=null){this._measurementSurface.setScale(1)}return this};I.prototype.onSetContentConnector=function(e){t.prototype.onSetContentConnector.call(this,e);e.attachContentLoadingFinished(this._onContentLoadingFinished,this)};I.prototype.onUnsetContentConnector=function(e){e.detachContentLoadingFinished(this._onContentLoadingFinished,this);t.prototype.onUnsetContentConnector.call(this,e)};I.prototype._onContentLoadingFinished=function(e){if(this._scene){var t=this._scene.getDefaultNodeHierarchy();if(t){var i=this._getViewStateManagerSVG();var s=i&&i._mask||1;var a=this.getShowAllHotspots()?this.getShowAllHotspotsTintColor():null;var r=t.getHotspotNodeRefs();r.forEach(function(e){this._hotspotHelper.updateHotspot(e);if(a!=null){e.setHotspotColor(s,a)}if(this.getDisableHotspotHovering()){e.addClass("sapUiVizKitNonInteractiveHotspot")}},this)}if(e&&(!this._camera._initialZoom||this._camera._initialZoom===-1)){this.zoomTo(u.All,null,0,0);this._camera._initialZoom=this._camera.getZoomFactor();this._camera._initialPosition=this._camera.getPosition()}this.invalidate()}};function A(e,t,i){return e+(t-e)*i}function z(e,t,i){i=Math.min(Math.max((i-e)/(t-e),0),1);return i*i*i*(i*(i*6-15)+10)}I.prototype._animLoop=function(){this._animLoopRequestId=0;var e=this._anim;if(e){var t=e.start;var i=e.end;var s=Date.now();var a=Math.min(z(0,1,(s-t.time)/e.duration),1);var r=this._camera.offsetX;var o=this._camera.offsetY;var n=this._camera.zoom;this._camera.offsetX=A(t.offsetX,i.offsetX,a);this._camera.offsetY=A(t.offsetY,i.offsetY,a);this._camera.zoom=A(t.zoom,i.zoom,a);if(this._redlineHandler){this._redlineHandler.pan(this._camera.offsetX-r,this._camera.offsetY-o);this._redlineHandler.zoom(this._camera.zoom/n,this._camera.offsetX,this._camera.offsetY)}this.fireCameraChanged({viewBox:this._getViewBox()});if(this._updateViewBox()&&s-t.time<e.duration){this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{delete this._anim;this._endRasterMode()}}};I.prototype.getCurrentView=function(){return this._currentView};I.prototype._onViewStateApplied=function(e,t,i){if(i.source===this._getViewStateManagerSVG()){this.activateView(i.view)}};I.prototype.activateView=function(t){if(!this._scene){return this}var i=this._scene.getViewGroups();var s=this;if(i){i.forEach(function(e){e.getViews().forEach(function(i){if(i===t){s._currentViewIndex=e.getViews().indexOf(i)}})})}this.fireViewActivated({viewIndex:this._currentViewIndex,view:t});e.getEventBus().publish("sap.ui.vk","viewActivated",{source:this,view:t,viewIndex:this._currentViewIndex});this._currentView=t;var a=t.getCamera();if(a){this.setCamera(a)}var r=t.getTopColor();if(r!=null){if(Array.isArray(r)&&r.length>2){this.setBackgroundColorTop(w({red:Math.floor(r[0]*255),green:Math.floor(r[1]*255),blue:Math.floor(r[2]*255),alpha:r.length>3?r[3]:1}))}else{this.setBackgroundColorTop(r)}}var o=t.getBottomColor();if(o!=null){if(Array.isArray(o)&&o.length>2){this.setBackgroundColorBottom(w({red:Math.floor(o[0]*255),green:Math.floor(o[1]*255),blue:Math.floor(o[2]*255),alpha:o.length>3?o[3]:1}))}else{this.setBackgroundColorBottom(o)}}e.getEventBus().publish("sap.ui.vk","readyForAnimation",{source:this._getViewStateManagerSVG(),view:t,ignoreAnimationPosition:false});this.rerender();if(a?.zoom<=p._MIN_ZOOM){this.zoomTo(u.Visible,null,0,0)}this.fireViewFinished({viewIndex:this._currentViewIndex});return this};I.prototype.resetCurrentView=function(){if(this._currentView){this._getViewStateManagerSVG()._resetNodesStatusByCurrentView(this._currentView);this.rerender()}return this};I.prototype.zoomTo=function(e,t,i,s){if(this._width===0||this._height===0||this._scene==null){return this}var a={min:{x:Infinity,y:Infinity},max:{x:-Infinity,y:-Infinity}};var r=this._getViewStateManagerSVG();(Array.isArray(e)?e:[e]).forEach(function(e){switch(e){case u.All:this._scene.getRootElement()._expandBoundingBoxRecursive(a,-1>>>0);break;case u.Visible:if(r){this._scene.getRootElement()._expandBoundingBoxRecursive(a,r._mask)}break;case u.Selected:if(r){r.enumerateSelection(function(e){e._expandBoundingBoxRecursive(a,-1>>>0)})}break;case u.Node:if(!t){return}if(Array.isArray(t)){t.forEach(function(e){e._expandBoundingBoxRecursive(a,-1>>>0)})}else{t._expandBoundingBoxRecursive(a,-1>>>0)}break;case u.Restore:x.error(f().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return;case u.NodeSetIsolation:x.error(f().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return;case u.RestoreRemoveIsolation:x.error(f().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return;case u.ViewLeft:case u.ViewRight:case u.ViewTop:case u.ViewBottom:case u.ViewBack:case u.ViewFront:return;default:break}}.bind(this));if(a.min.x>=a.max.x||a.min.y>=a.max.y){a={min:{x:0,y:0},max:{x:1,y:1}}}var o=new p;o._zoomTo(a,this._width,this._height,s);this._activateCamera(o,i);return this};I.prototype._activateCamera=function(e,t){if(t>0&&!this._animLoopRequestId){this._anim={start:{time:Date.now(),offsetX:this._camera.offsetX,offsetY:this._camera.offsetY,zoom:this._camera.zoom},end:{offsetX:e.offsetX,offsetY:e.offsetY,zoom:e.zoom},duration:t*1e3};this._startRasterMode();this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction)}else{if(this._redlineHandler){this._redlineHandler.pan(e.offsetX-this._camera.offsetX,e.offsetY-this._camera.offsetY);this._redlineHandler.zoom(e.zoom/this._camera.zoom,e.offsetX,e.offsetY)}this._camera.zoom=e.zoom;this._camera.offsetX=e.offsetX;this._camera.offsetY=e.offsetY;this._updateViewBox();this._invalidateRasterImage();this.fireCameraChanged({viewBox:this._getViewBox()})}};I.prototype.beginGesture=function(e,t){this._gestureX=(e-this._camera.offsetX)/this._camera.zoom;this._gestureY=(t-this._camera.offsetY)/this._camera.zoom};I.prototype.endGesture=function(){this._gestureX=0;this._gestureY=0;this._endRasterMode()};function N(e,t,i){if(e.width!==t*devicePixelRatio||e.height!==i*devicePixelRatio){e.width=t*devicePixelRatio;e.height=i*devicePixelRatio;e.style.width=t+"px";e.style.height=i+"px"}}I.prototype.invalidate=function(){t.prototype.invalidate.call(this);if(this.raster){this._invalidateRasterImage()}};I.prototype._invalidateRasterImage=function(){if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.useRasterMode){this.raster.updateImageTimer=setTimeout(this._updateRasterImage.bind(this),100)}};I.prototype._updateRasterImage=function(){this.raster.updateImageTimer=null;if(this._svgElement==null||!this.raster.useRasterMode||!this.raster.bmpCanvas){return}var e=Math.round(Math.max(Math.max(this._width,this._height)*.5,512));var t=this._width+e;var i=this._height+e;var s=t/this._width;var a=i/this._height;var r=this._getViewBox();var o=[r[0]-r[2]*(s-1)*.5,r[1]-r[3]*(a-1)*.5,r[2]*s,r[3]*a];this._svgElement.setAttribute("width",t+"px");this._svgElement.setAttribute("height",i+"px");this._svgElement.setAttribute("viewBox",o.join(" "));var n=(new XMLSerializer).serializeToString(this._svgElement);var h="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n);this._svgElement.setAttribute("width","100%");this._svgElement.setAttribute("height","100%");this._svgElement.setAttribute("viewBox",r.join(" "));this.raster.vectorImage.viewBox=o;this.raster.vectorImage.src=h};I.prototype._startRasterMode=function(e){if(this.raster.endRasterModeTimer){clearTimeout(this.raster.endRasterModeTimer);this.raster.endRasterModeTimer=null}if(this.raster.updateImageTimer){clearTimeout(this.raster.updateImageTimer);this.raster.updateImageTimer=null}if(this.raster.rasterMode||!this.raster.useRasterMode||this._svgElement==null){return}this.raster.rasterMode=true;this.raster.delayEnd=e;this._svgElement.style.display="none";this.raster.bmpCanvas.style.display="block";this._requestBmpDraw()};I.prototype._endRasterMode=function(){if(!this.raster.rasterMode){return}var e=function(){this.raster.bmpCanvas.style.display="none";this._svgElement.style.display="";this.raster.rasterMode=false;this._invalidateRasterImage()}.bind(this);if(this.raster.delayEnd){this.raster.endRasterModeTimer=setTimeout(function(){this.raster.endRasterModeTimer=null;e()}.bind(this),500)}else{e()}};I.prototype.pan=function(e,t){if(!this.getFreezeCamera()){this._startRasterMode();this._camera.offsetX+=e;this._camera.offsetY+=t;this._updateViewBox();if(this._redlineHandler){this._redlineHandler.pan(e,t)}this.fireCameraChanged({viewBox:this._getViewBox()})}};I.prototype.rotate=function(e,t){this.pan(e,t)};I.prototype.zoom=function(e){if(!this.getFreezeCamera()){this._startRasterMode(true);var t=this._camera.zoom;this._camera.zoom=Math.max(this._camera.zoom*e,p._MIN_ZOOM);this._camera.offsetX+=this._gestureX*(t-this._camera.zoom);this._camera.offsetY+=this._gestureY*(t-this._camera.zoom);if(this._redlineHandler){this._redlineHandler.zoom(this._camera.zoom/t)}this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()})}};I.prototype.hover=function(e,t){var i=this._getViewStateManagerSVG();if(!i){return}var s=this.getDisableHotspotHovering()?null:this.hitTest(e,t);var a=false;if(this._hotspotElement&&this._hotspotElement!==s){this.fireHotspotLeave({nodeRef:this._hotspotElement});if(!this.getShowAllHotspots()){this._hotspotElement.setHotspotColor(i._mask,null)}this._hotspotElement=null;a=true}if(s&&s._vkGetNodeContentType()===c.Hotspot){this._hotspotElement=s;if(!this.getShowAllHotspots()){s.setHotspotColor(i._mask,this.getHotspotColorABGR())}this.fireHotspotEnter({nodeRef:s});a=true}if(a){this._invalidateRasterImage()}};I.prototype._getViewBox=function(){return this._camera._getViewBox()};I.prototype._requestBmpDraw=function(){if(this.raster.rasterMode){this.raster.bmpDrawRequestId=this.raster.bmpDrawRequestId||window.requestAnimationFrame(this._bmpDraw.bind(this))}};I.prototype._bmpDraw=function(){this.raster.bmpDrawRequestId=null;var e=this._getViewBox();var t=this.raster.rasterImage;var i=this.raster.bmpCanvas;N(i,this._width,this._height);var s=i.getContext("2d");s.resetTransform();s.clearRect(0,0,i.width,i.height);var a=t.viewBox;if(a){var r=this._camera._worldToScreen(a[0],a[1]);var o=this._camera._worldToScreen(e[0],e[1]);s.translate((r.x-o.x)*devicePixelRatio,(r.y-o.y)*devicePixelRatio);s.scale(a[2]*i.width/(e[2]*t.width),a[3]*i.height/(e[3]*t.height));s.imageSmoothingEnabled=true;s.imageSmoothingQuality="high";s.drawImage(t,0,0)}};I.prototype._updateViewBox=function(){if(this._svgElement==null){return false}this._requestBmpDraw();if(this._measurementSurface!=null){this._measurementSurface.update(this,this.getCamera())}this._svgElement.setAttribute("viewBox",this._getViewBox().join(" "));return true};I.prototype.getViewInfo=function(e){var t={};if(e==null){e={}}if(e.camera==null){e.camera=true}if(e.camera){t.camera={viewBox:this._getViewBox()}}if(e.visibility&&this._viewStateManager){var i=e.visibility.mode==null?l.Complete:e.visibility.mode;t.visibility={mode:i};if(i===l.Complete){var s=this._viewStateManager.getVisibilityComplete();t.visibility.visible=s.visible;t.visibility.hidden=s.hidden}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){t.visibility.changes=this._viewStateManager.getVisibilityChanges()}else{x.warning(f().getText(m.VIT32.summary),m.VIT32.code,"sap.ui.vk.threejs.Viewport")}}var a=this._getViewStateManagerSVG();if(e.selection&&a){t.selection=a._getSelectionComplete()}return t};I.prototype.setViewInfo=function(e,t){var i=e.camera;if(i&&i.viewBox){var s=new p;s._setViewBox(i.viewBox,this._width,this._height);this._activateCamera(s,t)}var a=new Map;if(e.visibility||e.selection){var r=this._viewStateManager.getNodeHierarchy(),o=r.findNodesByName();o.forEach(function(e){var t=r.createNodeProxy(e);var i=t.getVeId();r.destroyNodeProxy(t);if(i){a.set(i,e)}})}if(e.visibility){switch(e.visibility.mode){case l.Complete:const t=e.visibility.visible.map(e=>a.get(e)).filter(e=>e!=null),i=e.visibility.hidden.map(e=>a.get(e)).filter(e=>e!=null);this._viewStateManager.setVisibilityState(t,true,false);this._viewStateManager.setVisibilityState(i,false,false);break;case l.Differences:this._viewStateManager.resetVisibility();e.visibility.changes.forEach(function(e){var t=a.get(e);if(t){this._viewStateManager.setVisibilityState(t,!this._viewStateManager.getVisibilityState(t),false)}},this);break;default:x.error(f().getText(m.VIT28.summary),m.VIT28.code,"sap.ui.vk.threejs.Viewport");break}}var n=this._getViewStateManagerSVG();var h=e.selection;if(h&&n){var u=n._getSelectionComplete();if(Array.isArray(h.selected)){var d=[];var c=[];h.selected.forEach(function(e){var t=a.get(e);if(t){d.push(t)}});u.selected.forEach(function(e){var t=a.get(e);if(t&&h.selected.indexOf(e)<0){c.push(t)}});n.setSelectionStates(d,c,false,false)}}return this};I.prototype.queueCommand=function(e){if(this instanceof I){e()}return this};I.prototype.getOutputSize=function(){var e=this.getDomRef().getBoundingClientRect();var t=e.width;var i=e.height;var s;s=Math.min(t,i);return{left:(t-s)*.5,top:(i-s)*.5,sideLength:s}};I.prototype.setShouldRenderFrame=function(){this.invalidate()};I.prototype._isPanoramicActivated=function(){return false};I.prototype.setShowAllHotspots=function(e){this.setProperty("showAllHotspots",e,true);var t=this._getViewStateManagerSVG();if(t){var i=t._mask;var s=t.getNodeHierarchy().getHotspotNodeRefs();var a=this._hotspotElement;var r=this.getShowAllHotspotsTintColor();s.forEach(function(t){if(e){t.setHotspotColor(i,r)}else if(t===a){t.setHotspotColor(i,this.getHotspotColorABGR())}else{t.setHotspotColor(i,null)}},this);if(s.length>0){this.invalidate()}}};I.prototype.setDisableHotspotHovering=function(e){this.setProperty("disableHotspotHovering",e,true);if(e){this.hover(0,0)}var t=this._getViewStateManagerSVG();if(t){var i=t.getNodeHierarchy().getHotspotNodeRefs();i.forEach(function(t){if(e){t.addClass("sapUiVizKitNonInteractiveHotspot")}else{t.removeClass("sapUiVizKitNonInteractiveHotspot")}})}};I.prototype.setHotspotColorABGR=function(e){this.setProperty("hotspotColorABGR",e,true);this.setProperty("hotspotColor",w(R(e)),true);this.invalidate();return this};I.prototype.setHotspotColor=function(e){this.setProperty("hotspotColor",e,true);this.setProperty("hotspotColorABGR",C(S(e)),true);this.invalidate();return this};I.prototype.showHotspots=function(e,t,i){if(e==null){return this}if(!Array.isArray(e)){e=[e]}var s=t?i||this.getHotspotColorABGR():null;var a=this._getViewStateManagerSVG()._mask;e.forEach(function(e){e.setCustomHotspotColor(a,s)});this.invalidate();return this};I.prototype._getFillStyleId=function(e){if(e.highlightColor||e.tintColor){return null}var t;if(e.fillStyle&&e.fillStyle.veid!==undefined){t="f"+e.fillStyle.veid}else if(e.fill!==undefined&&e.fill[3]===0){t="fn"}else{return null}if(!this._styles.has(t)){var i=[];e._setFillStyleAttributes(function(e,t){i.push(e,t)});this._styles.set(t,i)}return t};I.prototype._getLineStyleId=function(e){if(e.highlightColor||e.tintColor){return null}var t;if(e.lineStyle&&e.lineStyle.veid!==undefined){t="l"+e.lineStyle.veid}else if(e.materialId){t="m"+e.materialId}else{return null}if(!this._styles.has(t)){var i=[];e._setLineStyleAttributes(function(e,t){i.push(e,t)});this._styles.set(t,i)}return t};I.prototype.getMeasurementSurface=function(){return this._measurementSurface};I.prototype._dumpSceneData=function(){var e=this._scene.getDefaultNodeHierarchy();var t=e.findNodesByName();var i=x.getLevel();x.setLevel(x.Level.INFO);x.info("**************************************");x.info("Nodes in the scene: "+t.length);var s=0;var a=0;var r=0;var o=0;var n=document.getElementsByTagName("svg")[0];var h=function(e){s+=e.children.length;var t=e;var i=1;while(t!=n){t=t.parentNode;i++}if(a<i){a=i}if(e.children.length===0){r++;if(e.tagName==="g"){o++}}for(var l=0;l<e.children.length;l++){h(e.children[l])}};h(n);x.info("DOM statistics:");x.info("    Nodes:      "+s);x.info("    Tree depth: "+a);x.info("    Leaf nodes: "+r);x.info("    Empty nodes:"+o);x.info("    Groups:     "+document.getElementsByTagName("g").length);x.info("    Lines:      "+document.getElementsByTagName("line").length);x.info("    Polylines:   "+document.getElementsByTagName("polyline").length);x.info("    Polygons:   "+document.getElementsByTagName("polygon").length);x.info("    Paths:      "+document.getElementsByTagName("path").length);x.info("    Ellipses:   "+document.getElementsByTagName("ellipse").length);x.info("    Rectangles: "+document.getElementsByTagName("rect").length);x.info("    Texts:      "+document.getElementsByTagName("text").length);x.info("    Images:     "+document.getElementsByTagName("image").length);x.info("**************************************");x.setLevel(i)};I.prototype.projectToScreen=function(e,t,i,s){var a=s._worldToScreen(e,t,0);a.z=0;return a};return I});
//# sourceMappingURL=Viewport.js.map