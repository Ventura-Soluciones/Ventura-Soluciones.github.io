/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../ContentManager","../getResourceBundle","../svg/Element","../svg/HotspotHelper","../svg/Scene","../svg/SceneBuilder","./Document","./Utils","./Viewport","./ViewStateManager"],(e,t,n,o,s,r,i,a,c)=>{"use strict";const d=t.extend("sap.ui.vk.pdf.ContentManager",{metadata:{library:"sap.ui.vk"}});d.prototype.loadContent=function(t,o){this.fireContentChangesStarted();if(o.length!==1){setTimeout(()=>{this.fireContentChangesFinished({content:null,failureReason:{errorMessage:n().getText("PDFCONTENTMANAGER_ONLY_LOAD_SINGLE_PDF")}})},0)}else if(o[0].getContentResources().length>0){setTimeout(()=>{this.fireContentChangesFinished({content:null,failureReason:{errorMessage:n().getText("PDFCONTENTMANAGER_CANNOT_LOAD_PDF_HIERARCHY")}})},0)}else{(async()=>{try{const e=o[0];const[t,n]=await Promise.all([this._loadDocument(e),this._loadHotspots(e),this._loadExtraModules()]);const s=this._buildSvgScene(e,n);const r=new a(t,s);this.fireContentChangesFinished({content:r})}catch(t){e.error("Failed to load PDF content",t);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:n().getText("PDFCONTENTMANAGER_FAILED_TO_LOAD_PDF",[t.message])}})}})()}return this};d.prototype.destroyContent=function(e){if(e instanceof a){e.destroy()}return this};d.prototype._loadDocument=async function(e){const t={};let o=e.getSource();if(typeof o==="string"){const n=e.getVeid()??"";if(n!==""){if(!o.endsWith("/")){o+="/"}o+=`scenes/${n}/pdf`}t.url=o}else if(o instanceof File){t.data=await new Promise((e,t)=>{const n=new FileReader;n.onload=t=>e(t.target.result);n.onerror=e=>t(e.target.error);n.readAsArrayBuffer(o)})}else{throw new Error(n().getText("PDFCONTENTMANAGER_SOURCE_TYPE_NOT_SUPPORTED"))}const s=await c.loadPdfjsLib();return await s.getDocument(t).promise};d.prototype._loadHotspots=async function(e){const t=e.getSource();if(typeof t==="string"){const t=e.getVeid()??"";if(t!==""){const t=await fetch(l(e));if(!t.ok){throw new Error(t.statusText)}return await t.json()}}return{scene:{id:"-1"},tree:{sid:"-1",nodes:[]},parametrics:[]}};d.prototype._loadExtraModules=async function(){return new Promise((e,t)=>{sap.ui.require(["sap/ui/vk/pdf/Viewport"],e,e=>t(e))})};d.prototype._buildSvgScene=function(e,t){const n=new r;const s=n.getRootElement();const a=new o;a.name=e.getName();a.sourceId=e.getSourceId();s.add(a);e._shadowContentResource={nodeProxy:n.getDefaultNodeHierarchy().createNodeProxy(a)};const{scene:{id:c},tree:{sid:d,nodes:l=[]},parametrics:f=[]}=t;const g=new i(a,e);g.setRootNode(a,d,c,n);n.setSceneBuilder(g);u(g,c,l,f);return n};d.prototype.updateContent=async function(e,t,n){const o=e[0];const{nodeIds:s}=n;const r=await fetch(l(o,{sids:s}));if(!r.ok){throw new Error(r.statusText)}const i=await r.json();const a=t.scene;const c=a.getSceneBuilder();const d=a.getDefaultNodeHierarchy();const{scene:{id:f},tree:{nodes:g},parametrics:p=[]}=i;const h=g.map(e=>a.persistentIdToNodeRef(e.sid)).filter(e=>e!=null);d.removeNode(h);u(c,f,g,p)};function u(e,t,n,o){for(const s of n){const n=o[s.parametric];if(n!=null){s.parametricId=n.id}e.createNode(s,t);if(n!=null){e.setParametricContent(s.sid,n,t)}}}function l(e,t){let n=e.getSource();let o=e.getVeid()??"";if(!n.endsWith("/")){n+="/"}n+=`scenes/${o}`;n+="?contentType=hotspot";n+="&$select=contentType,name,transform,visible,pageIndex";n+="&$expand=parametric";n+=`&hidden=${e.getIncludeHidden()}`;const s=t?.sids;if(s!=null){n+="&sid="+s.join("&sid=")}return n}return d});
//# sourceMappingURL=ContentManager.js.map