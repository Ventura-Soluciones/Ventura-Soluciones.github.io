/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/base/ManagedObjectObserver","sap/ui/core/Element","./Messages","./getResourceBundle","./ContentResource","./Core","sap/base/Log"],function(e,t,n,a,s,r,o,i){"use strict";var u=n.prototype;var c=n.extend("sap.ui.vk.ContentConnector",{metadata:{library:"sap.ui.vk",aggregations:{contentResources:{type:"sap.ui.vk.ContentResource",bindable:"bindable"},viewStateManagers:{type:"sap.ui.vk.ViewStateManagerBase"},defaultViewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false,visibility:"hidden"},contentManagers:{type:"sap.ui.vk.ContentManager",visibility:"hidden"}},defaultAggregation:"contentResources",events:{contentChangesStarted:{parameters:{}},contentChangesFinished:{parameters:{content:{type:"any"},failureReason:{type:"any"}}},contentChangesProgress:{parameters:{phase:{type:"string"},percentage:{type:"float"},source:{type:"any"}}},contentLoadingFinished:{parameters:{source:{type:"any"},node:{type:"any"}}},contentReplaced:{parameters:{newContent:{type:"any"},oldContent:{type:"any"}}},contentDestroying:{parameters:{content:{type:"any"},preventGarbageCollection:{type:"function"}}}}},constructor:function(e,t){this._inLoading=false;this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdateTimerId=null;this._content=null;this._contentManager=null;this._decryptionHandler=null;this._authorizationHandler=null;this._consumptionScenario=null;this._retryCount=1;u.constructor.apply(this,arguments);o.observeLifetime(this)}});c.prototype.isTreeBinding=function(e){return e==="contentResources"};c.prototype.init=function(){if(u.init){u.init.call(this)}this._selfObserver=new t(this._observeChanges.bind(this));this._selfObserver.observe(this,{aggregations:["contentResources","viewStateManagers"]})};c.prototype.destroy=function(){this._selfObserver.disconnect();this._selfObserver=null;if(this._scheduleContentResourcesUpdateTimerId){clearTimeout(this._scheduleContentResourcesUpdateTimerId);this._scheduleContentResourcesUpdateTimerId=null}this._delayContentResourcesUpdate=false;this._setContent(null,null);u.destroy.call(this)};c.prototype._observeChanges=function(e){if(e.name==="contentResources"){this._scheduleContentResourcesUpdate()}else if(e.name==="viewStateManagers"){if(e.mutation==="insert"){e.child.setContentConnector(this)}else if(e.mutation==="remove"){e.child.setContentConnector(null)}}};c.prototype.invalidate=function(e){if(e instanceof r){this._scheduleContentResourcesUpdate();return}u.invalidate.apply(this,arguments)};c.prototype._scheduleContentResourcesUpdate=function(){if(this._inLoading){this._delayContentResourcesUpdate=true;return this}if(!this._scheduleContentResourcesUpdateTimerId){this._scheduleContentResourcesUpdateTimerId=setTimeout(function(){this._scheduleContentResourcesUpdateTimerId=null;var e=this.getContentResources();if(e.length>0){this._collectContentResourceSourceTypeInformation(e).then(function(t){if(t.dimensions.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:s().getText(a.VIT17.cause)}});i.error(s().getText(a.VIT17.summary),a.VIT17.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length>1){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:s().getText(a.VIT35.cause)}});i.error(s().getText(a.VIT35.summary),a.VIT35.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length===0){setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null,failureReason:{errorMessage:s().getText(a.VIT36.cause)}});i.error(s().getText(a.VIT36.summary),a.VIT36.code,"sap.ui.vk.ContentConnector")}.bind(this),0)}else if(t.contentManagerClassNames.length===1){var n=this;this._getContentManagerByClassName(t.contentManagerClassNames[0]).then(function(t){if(n._contentManager&&t!==n._contentManager){n.fireContentChangesStarted();n._setContent(null,null);n.fireContentChangesFinished({content:null})}t.loadContent(n._content,e)})}}.bind(this))}else{setTimeout(function(){this.fireContentChangesStarted();this._setContent(null,null);this.fireContentChangesFinished({content:null})}.bind(this),0)}}.bind(this),0)}return this};c.prototype._handleContentChangesStarted=function(e){this._inLoading=true;this.fireContentChangesStarted()};c.prototype._handleContentChangesFinished=function(e){var t=e.getParameter("content");this._setContent(t,e.getSource());this.fireContentChangesFinished({content:t,failureReason:e.getParameter("failureReason")});this._inLoading=false;if(this._delayContentResourcesUpdate){this._delayContentResourcesUpdate=false;this._scheduleContentResourcesUpdate()}};c.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")})};c.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")})};c.prototype._getContentManagerByClassName=function(e){var t;var n=this.getAggregation("contentManagers",[]);for(var a=0,s=n.length;a<s;++a){t=n[a];if(t.getMetadata().getName()===e){return Promise.resolve(t)}}var r=this;return new Promise(function(t,n){sap.ui.require([e.replaceAll(".","/")],function(e){var n=new e;r.addAggregation("contentManagers",n);n.attachContentChangesStarted(r._handleContentChangesStarted,r);n.attachContentChangesFinished(r._handleContentChangesFinished,r);n.attachContentChangesProgress(r._handleContentChangesProgress,r);n.attachContentLoadingFinished(r._handleContentLoadingFinished,r);r._assignDecryptionHandler([n]);r._assignAuthorizationHandler([n]);r._assignConsumptionScenario([n]);r._assignRetryCount([n]);t(n)})})};c.prototype.getContent=function(){return this._content};c.prototype.getContentManager=function(){return this._contentManager};c.prototype.getDefaultViewStateManager=function(){return this.getAggregation("defaultViewStateManager")};c.prototype._assignDecryptionHandler=function(e){for(var t=0;t<e.length;t++){e[t].setDecryptionHandler(this._decryptionHandler)}};c.prototype._assignAuthorizationHandler=function(e){for(var t=0;t<e.length;t++){e[t].setAuthorizationHandler(this._authorizationHandler)}};c.prototype._assignConsumptionScenario=function(e){for(var t=0;t<e.length;t++){e[t].setConsumptionScenario(this._consumptionScenario)}};c.prototype._assignRetryCount=function(e){for(var t=0;t<e.length;t++){e[t].setRetryCount(this._retryCount)}};c.prototype.setDecryptionHandler=function(e){this._decryptionHandler=e;this._assignDecryptionHandler(this.getAggregation("contentManagers",[]));return this};c.prototype.setAuthorizationHandler=function(e){this._authorizationHandler=e;this._assignAuthorizationHandler(this.getAggregation("contentManagers",[]));return this};c.prototype.setConsumptionScenario=function(e){this._consumptionScenario=e;this._assignConsumptionScenario(this.getAggregation("contentManagers",[]));return this};c.prototype.setRetryCount=function(e){this._retryCount=Math.max(e,0);this._assignRetryCount(this.getAggregation("contentManagers",[]));return this};c.prototype._setContent=function(e,t){var n=this._content;var a=this._contentManager;if(n!==e){this._content=e;this._contentManager=t;this.destroyAggregation("defaultViewStateManager");if(t){var s=t.getMetadata().getName();var r;switch(s){case"sap.ui.vk.threejs.ContentManager":r="sap.ui.vk.threejs.ViewStateManager";break;case"sap.ui.vk.dvl.ContentManager":r="sap.ui.vk.dvl.ViewStateManager";break;case"sap.ui.vk.svg.ContentManager":r="sap.ui.vk.svg.ViewStateManager";break;case"sap.ui.vk.pdf.ContentManager":r="sap.ui.vk.pdf.ViewStateManager";break;default:break}if(r){var o=sap.ui.require(r.replaceAll(".","/"));var i=new o(this.getId()+"-defaultviewstatemanager",{contentConnector:this});this.setAggregation("defaultViewStateManager",i)}}this.fireContentReplaced({oldContent:n,newContent:e});if(n){var u=false;this.fireContentDestroying({content:n,preventGarbageCollection:function(e){u=e}});a.destroyContent(n);if(!u){a.collectGarbage()}}}return this};c.prototype.updateContent=async function(e){const t=this.getContentResources();const n=this.getContentManager();const a=this.getContent();if(t.length===0||n==null||a==null){throw new Error("No content is loaded.")}const s=await n.updateContent(t,a,e);this.fireEvent("_contentUpdated",{result:s});return s};var g=[{pattern:/(^threejs[:.])|(^(threejs|stream|vds4)$)/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^vdsl?$/,dimension:3,contentManagerClassName:"sap.ui.vk.threejs.ContentManager"},{pattern:/^(png|jpg|jpeg|gif|bmp|tiff?|svg)$/,dimension:2,contentManagerClassName:"sap.ui.vk.ImageContentManager"},{pattern:/^(stream2d|vds4-2d)$/,dimension:2,contentManagerClassName:"sap.ui.vk.svg.ContentManager"},{pattern:/^(pdf)$/,dimension:2,contentManagerClassName:"sap.ui.vk.pdf.ContentManager"}];(function(){g[1].contentManagerClassName="sap.ui.vk.dvl.ContentManager"})();var l=function(e){return new Promise(function(t,n){var a=g.slice();var s=function(r){if(r>=a.length){n();return}var o=a[r];(function(){var t=e.getSourceType();if(t){t=t.toLowerCase()}if(typeof o==="function"){return o(e)}else if(typeof o.pattern==="string"){var n=o.pattern.toLowerCase();if(n===t){return Promise.resolve(o)}}else if(o.pattern instanceof RegExp){if(o.pattern.test(t)){return Promise.resolve(o)}}return Promise.reject()})().then(function(e){t({dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings})},function(){s(r+1)})};s(0)})};c.addContentManagerResolver=function(e){if(typeof e==="function"){g.unshift(e)}else{g.unshift({pattern:e.pattern,dimension:e.dimension,contentManagerClassName:e.contentManagerClassName,settings:e.settings})}return this};c.removeAllContentManagerResolvers=function(){g=[];return this};c.removeContentManagerResolver=function(e){var t=typeof e==="function",n=typeof e==="string",a=e instanceof RegExp,s=typeof e==="object"&&!a;for(var r=0,o=g.length;r<o;++r){if(t&&g[r]===e){g.splice(r,1);return true}else if(typeof g[r]==="object"){if(s){if(e.pattern&&g[r].pattern===e.pattern){g.splice(r,1);return true}}else if(a){if(g[r].pattern.source===e.source){g.splice(r,1);return true}}else if(n){if(g[r].pattern instanceof RegExp){if(g[r].pattern.source===e){g.splice(r,1);return true}}else if(g[r].pattern===e){g.splice(r,1);return true}}}}return false};c.prototype._collectContentResourceSourceTypeInformation=function(e){var t=false;var n=false;var a={};var s={};var r=[];e.forEach(function e(t){r.push(t);t.getContentResources().forEach(e)});return Promise.all(r.map(function(e){return l(e).then(function(e){a[e.dimension]=true;s[e.contentManagerClassName]=true;return e},function(){if(e.getSourceType()){n=true}else{t=true}return false})})).then(function(e){for(var o=0,i=r.length;o<i;++o){if(e[o]){r[o]._contentManagerResolver=e[o]}}return{noSourceTypes:t,unknownSourceTypes:n,dimensions:Object.getOwnPropertyNames(a).sort(),contentManagerClassNames:Object.getOwnPropertyNames(s)}})};return c});
//# sourceMappingURL=ContentConnector.js.map