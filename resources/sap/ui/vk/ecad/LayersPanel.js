/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/m/Button","sap/m/SearchField","sap/m/OverflowToolbar","sap/m/ToolbarLayoutData","sap/m/ToolbarSpacer","sap/m/Text","sap/m/Table","sap/m/Column","sap/m/Sticky","sap/m/ScrollContainer","sap/m/ColumnListItem","sap/ui/core/Core","sap/ui/core/Control","sap/ui/core/Element","sap/ui/core/Icon","sap/ui/core/library","sap/ui/core/ResizeHandler","sap/ui/model/json/JSONModel","../Core","../library","../ViewStateManager","./LayersPanelRenderer","./VisibilityType","../getResourceBundle"],function(e,t,n,i,s,a,o,r,h,l,d,c,u,_,p,g,f,m,y,C,b,E,S,L){"use strict";var T=u.extend("sap.ui.vk.ecad.LayersPanel",{metadata:{library:"sap.ui.vk",aggregations:{content:{type:"sap.m.ScrollContainer",multiple:false}},associations:{contentConnector:{type:"sap.ui.vk.ContentConnector",multiple:false},viewStateManager:{type:"sap.ui.vk.ViewStateManagerBase",multiple:false}},events:{contentChanged:{enableEventBubbling:true}}},renderer:E,constructor:function(e,t){u.apply(this,arguments);y.observeAssociations(this)}});var v="sap-icon://status-inactive";var w="sap-icon://rhombus-milestone";var B="sap-icon://rhombus-milestone-2";T.prototype.onSetViewStateManager=function(e){this._manager=e;e.attachVisibilityChanged(this._onVisibilityChanged,this);this.refresh()};T.prototype.onUnsetViewStateManager=function(e){this._manager=null;e.detachVisibilityChanged(this._onVisibilityChanged,this);this.refresh()};T.prototype.onSetContentConnector=function(e){e.attachContentReplaced(this._onContentReplaced,this);e.attachContentChangesFinished(this._onContentChangesFinished,this);this._setContent(e.getContent())};T.prototype.onUnsetContentConnector=function(e){this._setContent(null);e.detachContentReplaced(this._onContentReplaced,this);e.detachContentChangesFinished(this._onContentChangesFinished,this)};T.prototype.init=function(){if(u.prototype.init){u.prototype.init.apply(this)}var c=this;this._showButton=new e({enabled:false,iconFirst:true,icon:B,text:L().getText("LAYERS_PANEL_SHOW_BUTTON"),tooltip:L().getText("LAYERS_PANEL_SHOW_BUTTON_TOOLTIP"),press:this._onShowLayers.bind(this)});this._hideButton=new e({enabled:false,iconFirst:true,icon:v,text:L().getText("LAYERS_PANEL_HIDE_BUTTON"),tooltip:L().getText("LAYERS_PANEL_HIDE_BUTTON_TOOLTIP"),press:this._onHideLayers.bind(this)});this._table=new o({mode:"MultiSelect",sticky:[h.HeaderToolbar,h.ColumnHeaders],selectionChange:this._onSelectionChanged.bind(this),headerToolbar:new n({content:[new t({layoutData:new i({shrinkable:true,maxWidth:"400px"}),search:function(e){this._onSearch(e.getParameter("query")).bind(this)}}),new s,this._showButton,this._hideButton]}),columns:[new r({minScreenWidth:"10rem",hAlign:g.TextAlign.Begin,header:new a({text:L().getText("LAYERS_PANEL__NAME_COLUMN")})}),new r({minScreenWidth:"6rem",hAlign:g.TextAlign.Center,header:new a({text:L().getText("LAYERS_PANEL_VISIBLE_COLUMN")})})],items:{path:"/",template:new d({vAlign:"Middle",cells:[new a({text:"{name}"}),new p({src:{path:"",formatter:function(e){var t=c._getVisibility(e);if(t===S.Hidden){return v}else if(t===S.Partial){return w}return B}},tooltip:{path:"",formatter:function(e){var t=c._getVisibility(e);if(t===S.Hidden){return L().getText("LAYERS_PANEL_VISIBLE_COLUMN_HIDDEN_TOOLTIP")}else if(t===S.Partial){return L().getText("LAYERS_PANEL_VISIBLE_COLUMN_PARTIAL_TOOLTIP")}return L().getText("LAYERS_PANEL_VISIBLE_COLUMN_VISIBLE_TOOLTIP")}}})]})}});this._scrollContainer=new l({vertical:true,horizontal:false,height:"100%",content:this._table});this.setAggregation("content",this._scrollContainer);this._scene=null;this._model=new m;this._table.setModel(this._model)};T.prototype.refresh=function(){if(!this._scene||!this._manager||!this._manager.getNodeHierarchy()){this._model.setData([]);return}var e=new Map;this._scanTree(e,this._manager.getNodeHierarchy().getSceneRef());this._model.setData(e.values().toArray());this._table.setModel(this._model);this.fireContentChanged()};T.prototype.onBeforeRendering=function(){this._table.setVisible(true);if(!this._resizeListenerId){this._resizeListenerId=f.register(this,this._handleResize.bind(this))}};T.prototype._setScene=function(e){this._scene=e;this.refresh()};T.prototype._getVisibility=function(e){if(e.hiddenElements===0){return S.Visible}else if(e.hiddenElements<e.elements.size){return S.Partial}return S.Hidden};T.prototype._extractMetadata=function(e){if(e.length!=undefined){var t=new Map;e.forEach(function(e){if(e.category==="ecad"){t.set(e.tag,e.value)}});return t}return null};T.prototype._addElement=function(e,t,n,i){var s=e.get(t);if(!s){s={name:t,order:0,elements:new Map,hiddenElements:0};e.set(t,s)}if(i==false){s.hiddenElements++}s.elements.set(n.uid,n)};T.prototype._scanTree=function(e,t){var n=this._manager.getNodeHierarchy();var i=n.createNodeProxy(t);var s=this._extractMetadata(i.getNodeMetadata());n.destroyNodeProxy(i);if(s){var a=s.get("layer");if(a){this._addElement(e,a,t,this._manager.getVisibilityState(t));return}}n.getChildren(t).forEach(function(t){this._scanTree(e,t)},this)};T.prototype._onSelectionChanged=function(e){this._updateButtons()};T.prototype._onVisibilityChanged=function(e){};T.prototype._handleResize=function(e){};T.prototype._setContent=function(e){if(e&&!this.getViewStateManager()){var t=_.getElementById(this.getContentConnector());if(t){var n=t.getDefaultViewStateManager();if(n){this.setViewStateManager(n)}}}this._setScene(e);return this};T.prototype._onContentReplaced=function(e){this._setContent(e.getParameter("newContent"))};T.prototype._onContentChangesFinished=function(e){this.refresh()};T.prototype._updateButtons=function(){var e=false,t=false;var n=this._table.getSelectedItems();n.forEach(function(n){var i=n.getBindingContext().getObject();var s=this._getVisibility(i);if(s===S.Visible){t=true}else if(s===S.Hidden){e=true}else{t=e=true}},this);this._showButton.setEnabled(e);this._hideButton.setEnabled(t)};T.prototype._onShowLayers=function(){var e=[];var t=this._table.getSelectedItems();t.forEach(function(t){var n=t.getBindingContext().getObject();if(n.hiddenElements!==0){n.hiddenElements=0;n.elements.forEach(function(t){e.push(t)})}});this._manager.setVisibilityState(e,true,true,true);this._model.updateBindings(true);this._updateButtons()};T.prototype._onHideLayers=function(){var e=[];var t=this._table.getSelectedItems();t.forEach(function(t){var n=t.getBindingContext().getObject();if(n.hiddenElements!==n.elements.size){n.hiddenElements=n.elements.size;n.elements.forEach(function(t){e.push(t)})}});this._manager.setVisibilityState(e,false,true,true);this._model.updateBindings(true);this._updateButtons()};return T});
//# sourceMappingURL=LayersPanel.js.map