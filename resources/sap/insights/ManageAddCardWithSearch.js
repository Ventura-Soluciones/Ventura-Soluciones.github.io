/*!
 * 
		SAP UI development toolkit for HTML5 (SAPUI5)
		(c) Copyright 2009-2015 SAP SE. All rights reserved
	
 */
sap.ui.define(["sap/ui/core/Control","sap/m/Button","sap/m/Dialog","./utils/InsightsUtils","sap/ui/integration/widgets/Card","sap/m/VBox","sap/m/HBox","sap/m/ScrollContainer","./utils/AppConstants","./utils/CardSkeletonManifest","sap/m/MessageToast","sap/base/Log","sap/m/IllustratedMessage","sap/ui/performance/trace/FESRHelper","sap/m/Title","sap/m/Label","sap/m/FlexBox","sap/m/Panel","sap/m/Toolbar","sap/m/TextArea","sap/m/Text","sap/m/MessageStrip","sap/ui/core/Icon","sap/m/MessageBox","sap/m/Token","sap/m/Tokenizer","sap/m/IllustratedMessageSize","sap/m/IllustratedMessageType"],function(e,t,s,i,a,n,r,o,l,d,g,h,u,p,c,f,y,T,B,m,_,C,x,S,v,b,I,w){"use strict";var M=JSON.parse(JSON.stringify(d));var E=JSON.parse(JSON.stringify(d));var A=e.extend("sap.insights.ManageAddCardWithSearch",{renderer:null,metadata:{events:{onAddButtonPress:{parameters:{manifest:{type:"string"}}}},aggregations:{_queryDialog:{type:"sap.m.Dialog",multiple:false,visibility:"hidden"}}}});A.prototype.init=function(){this.i18Bundle=i.getResourceBundle();this._createStaticControls();this._getQueryDialog()};A.prototype._getQueryDialog=function(){if(!this.getAggregation("_queryDialog")){var e=new s({title:this.i18Bundle.getText("addToInsights"),content:[this._getOuterVbox()],showHeader:true,contentHeight:"41.1rem",contentWidth:"59.3rem",verticalScrolling:false,horizontalScrolling:false,afterClose:this.resetDialog.bind(this,true),escapeHandler:this.closeDialog.bind(this),afterOpen:this.afterOpenDialog.bind(this),beginButton:this._getAddButton(),endButton:this._getCancelButton()});this.setAggregation("_queryDialog",e,true)}return this.getAggregation("_queryDialog")};A.prototype._createStaticControls=function(){var e={};e.searchedCard=new a(this.getId()+"--searchedCard",{manifest:M,manifestApplied:this._setAriaTextOnManifest.bind(this),width:"19rem",height:"33.5rem",previewMode:"Abstract",visible:true});e.placeholder=new a(this.getId()+"--placeholderCard",{manifest:E,manifestReady:this._onManifestReady.bind(this),width:"19rem",height:"33.5rem",previewMode:"Off",visible:false});e.oAddButton=new t(this.getId()+"--addButton",{text:this.i18Bundle.getText("INT_DIALOG_Ok"),press:this.addCard.bind(this),type:"Emphasized",enabled:false});p.setSemanticStepname(e.oAddButton,"press",l.FESR_AIGENERATE_ADD_CARD);e.oCancelButton=new t(this.getId()+"--cancelButton",{text:this.i18Bundle.getText("cancelButton"),press:this.closeDialog.bind(this)});p.setSemanticStepname(e.oCancelButton,"press",l.FESR_AIGENERATE_CANCEL);e.messageStripHbox=this._createMessageStripHBox();e.oNoCardMessage=new u(this.getId()+"--editInsightNoInsightsCardsMsg",{illustrationSize:I.Medium,illustrationType:w.NoEntries,description:" "}).addStyleClass("sapFIllustratedMessageAlign sapFFrequentIllustratedMessageAlign");e.noCardBox=new n(this.getId()+"--illusCardVbox",{alignItems:"Center",height:"100%",renderType:"Bare",justifyContent:"Center",items:[e.oNoCardMessage],visible:false}).addStyleClass("aiErrorPadding");var s=new _(this.getId()+"--label",{text:this.i18Bundle.getText("typed_text_label"),wrapping:true}).addStyleClass("sapUiSmallMarginBeginEnd sapUiSmallMarginTop");const i=500;e.oTextBox=new m(this.getId()+"--textBox",{width:"calc(100% - 2rem)",height:"7rem",placeholder:this.i18Bundle.getText("SAMPLE_QUERY_MSG")+" "+this.i18Bundle.getText("SAMPLE_QUERY_TEXT"),maxLength:i,showExceededText:true,liveChange:this.onChange.bind(this)}).addStyleClass("sapUiNoMarginBottom sapUiSmallMarginBeginEnd sapUiTinyMarginTop");e.oTextBox.attachBrowserEvent("keydown",function(t){if(t.keyCode===13&&e.oRegenerateButton.getEnabled()){this._onSearch()}}.bind(this));e.oRegenerateButton=new t(this.getId()+"--searchButton",{type:"Default",icon:"sap-icon://ai",text:this.i18Bundle.getText("GO"),press:this._onSearch.bind(this),enabled:false}).addStyleClass("sapUiSmallMarginBegin");p.setSemanticStepname(e.oRegenerateButton,"press",l.FESR_AIGENERATE_CARD);e.oClearButton=new t(this.getId()+"--clearButton",{type:"Transparent",text:this.i18Bundle.getText("Clear"),enabled:false,press:this._onClear.bind(this)}).addStyleClass("sapUiTinyMarginBegin sapUiSmallMarginEnd");p.setSemanticStepname(e.oClearButton,"press",l.FESR_AIGENERATE_CLEARALL);var d=new r(this.getId()+"--buttonHBox",{width:"100%",alignItems:"End",renderType:"Bare",justifyContent:"End",items:[e.oRegenerateButton,e.oClearButton]}).addStyleClass("sapUiTinyMarginTop");var g=new x(this.getId()+"--helpIcon",{src:"sap-icon://sys-help",size:"0.875rem",height:"0.875rem",color:"Neutral"});var h=new f(this.getId()+"--sampleQueryLabel",{text:this.i18Bundle.getText("SAMPLE_QUERY")}).addStyleClass("sapUiTinyMarginBegin");var T=new r(this.getId()+"--queryHbox",{width:"calc(100% - 1rem)",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",alignItems:"Center",items:[g,h]}).addStyleClass("sapUiSmallMarginBegin sapUiSmallMarginTop");e.oFilterHBox=new n(this.getId()+"--filterHBox",{width:"calc(100% - 1rem)",alignItems:"Start",justifyContent:"Start",renderType:"Bare",items:[new f({text:this.i18Bundle.getText("INT_TOKEN_INFO"),showColon:true,wrapping:true}).addStyleClass("sapUiSmallMarginBegin"),new b({editable:false,renderMode:"Narrow",width:"calc(100%)",visible:true}).addStyleClass("sapUiTinyMarginTop sapUi-Std-PaddingS sapUiSmallMarginBegin customPaddingToken")],visible:false}).addStyleClass("sapUiTinyMarginTop");var S=e.oFilterHBox.getItems()?.[1];if(S){var v="mouse";document.addEventListener("keydown",function(){v="keyboard"});S.attachRenderModeChange(function(){var e=S.getDomRef()?.contains(document.activeElement);var t=v==="keyboard"&&e?"Loose":"Narrow";S.setRenderMode(t)})}var A=new y(this.getId()+"--defaultPreviewFormFlex",{height:"100%",width:"50%",direction:"Column",renderType:"Bare",items:[s,e.oTextBox,d,e.oFilterHBox,T,this._createSampleQueryListBox()]});var D=new c(this.getId()+"--defaultPreviewCardText",{text:this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview"),textAlign:"Left"}).addStyleClass("sapUiSmallMarginTop");var R=new r(this.getId()+"--defaultPreviewHBox",{width:"100%",height:"100%",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",items:[D]}).addStyleClass("sapUiTinyMarginBegin");var L=new B(this.getId()+"--defaultPreviewToolBar",{width:"100%",height:"2rem",style:"Clear",design:"Auto",content:[R]}).addStyleClass("sapThemeBaseBG");var P=new r(this.getId()+"--insightsCardOverflowInnerHBox",{width:"19rem",height:"2rem"}).addStyleClass("insightsCardOverflowLayer insightsCardOverflowTop");e.oInsightsCardOverflowLayer=new r(this.getId()+"--insightsCardOverflowLayer",{height:"0",visible:false,items:[P]}).addStyleClass("sapMFlexBoxJustifyCenter");var O=new n(this.getId()+"--defaultPreviewVBox",{height:"100%",alignItems:"Center",backgroundDesign:"Transparent",justifyContent:"SpaceAround",items:[e.searchedCard,e.placeholder,e.oInsightsCardOverflowLayer,e.messageStripHbox]});var U=new n(this.getId()+"--defaultPreviewInnerVBox",{height:"100%",backgroundDesign:"Transparent",justifyContent:"Center",items:[O]}).addStyleClass("sapUiTinyMarginTopBottom sapUiSmallMarginBeginEnd");e.oDefaultPreviewPanelFlex=new y(this.getId()+"--defaultPreviewPanelFlex",{height:"100%",backgroundDesign:"Transparent",renderType:"Bare",justifyContent:"Center",items:[U]}).addStyleClass("sapUiSmallMarginTop");var F=new C(this.getId()+"--busyMessageStrip",{text:this.i18Bundle.getText("CARD_GENERATE_MSG"),showIcon:true,showCloseButton:false});e.busyMessageBox=new r(this.getId()+"--busyMessageBox",{alignItems:"Center",renderType:"Bare",width:"calc(100% - 2rem)",height:"3rem",visible:false,justifyContent:"Start",backgroundDesign:"Transparent",items:[F]}).addStyleClass("sapUiSmallMarginBeginEnd sapUiTinyMarginTopBottom");var k=new o(this.getId()+"--defaultPreviewScroll",{vertical:true,horizontal:false,height:"100%",content:[L,e.busyMessageBox,e.oDefaultPreviewPanelFlex,e.noCardBox]});var N=new y(this.getId()+"--defaultPreviewFlex",{height:"100%",width:"50%",direction:"Column",renderType:"Bare",items:[k]}).addStyleClass("sapMPageBgStandard");e.oDefaultVBox=new n(this.getId()+"--defaultVBox",{height:"100%",width:"100%",direction:"Row",justifyContent:"SpaceBetween",items:[A,N]});this._setAccessMethods(e)};A.prototype._createMessageStripHBox=function(){var e=new _(this.getId()+"--messageAIText",{text:this.i18Bundle.getText("addCardsAIInfo")}).addStyleClass("sapThemeHighlight-asColor aiTextWidth");var t=new f(this.getId()+"--messageAIVerificationText",{text:this.i18Bundle.getText("addVerifyInfo")});var s=new r(this.getId()+"--messageHBox",{alignItems:"Center",renderType:"Bare",width:"19rem",height:"1rem",visible:false,justifyContent:"Start",backgroundDesign:"Transparent",items:[e,t]}).addStyleClass("sapUiTinyMarginTop");return s};A.prototype._setQueryItem=function(e,t){var s=function(e){return e+". "};var i=new f(this.getId()+"--queryItem"+e,{text:s(e),wrapping:true}).addStyleClass("aiDialogText sapUiTinyMarginEnd");var a=new f(this.getId()+"--queryListItem"+e,{showColon:false,text:this.i18Bundle.getText(t),wrapping:true}).addStyleClass("aiDialogText");var n=new r(this.getId()+"--queryListBox"+e,{items:[i,a]}).addStyleClass("sapUiTinyMarginTop");return n};A.prototype._createSampleQueryListBox=function(){var e=new n(this.getId()+"--sampleQueryListBox",{alignItems:"Start",justifyContent:"Start",backgroundDesign:"Transparent",renderType:"Bare",items:[this._setQueryItem(1,"QUERY_LIST_ITEM1"),this._setQueryItem(2,"QUERY_LIST_ITEM2"),this._setQueryItem(3,"QUERY_LIST_ITEM3")]}).addStyleClass("sapUiSmallMarginBeginEnd");return e};A.prototype._setAccessMethods=function(e){this._getSearchedCard=function(){return e&&e.searchedCard};this._getPlaceholder=function(){return e&&e.placeholder};this._getAddButton=function(){return e&&e.oAddButton};this._getCancelButton=function(){return e&&e.oCancelButton};this._enableFocusAddButton=function(t){if(e&&e.oAddButton){e.oAddButton.setEnabled(t);if(t){setTimeout(function(){e.oAddButton.focus()},0)}}};this._getTextBox=function(){return e&&e.oTextBox};this._setMessageStripOverflowVisibility=function(t){if(e&&e.messageStripHbox&&e.oInsightsCardOverflowLayer){e.messageStripHbox.setVisible(t);e.oInsightsCardOverflowLayer.setVisible(t)}};this._getNoCardMessage=function(){return e&&e.oNoCardMessage};this._getDefaultPreviewPanelFlex=function(){return e&&e.oDefaultPreviewPanelFlex};this._toggleCardBox=function(t){e.oDefaultPreviewPanelFlex.setVisible(t);e.noCardBox.setVisible(!t)};this._toggleButtonAndText=function(t){e.oTextBox.setEnabled(t);this._toggleStyleClass(t);e.busyMessageBox.setVisible(!t);e.oRegenerateButton.setEnabled(t);this._enableClearButton(t)};this._toggleStyleClass=function(t){if(t){if(!e.oDefaultPreviewPanelFlex.hasStyleClass("sapUiSmallMarginTop")){e.oDefaultPreviewPanelFlex.addStyleClass("sapUiSmallMarginTop")}}else{e.oDefaultPreviewPanelFlex.removeStyleClass("sapUiSmallMarginTop")}};this._enableClearButton=function(t){e.oClearButton.setEnabled(t)};this._enableRegenerateButton=function(t){e.oRegenerateButton.setEnabled(t)};this._getOuterVbox=function(){return e&&e.oDefaultVBox};this._getFilterHBox=function(){return e&&e.oFilterHBox}};A.prototype._onClear=function(){this.resetDialog(true);g.show(this.i18Bundle.getText("Query_Deleted"));this._getTextBox().focus()};A.prototype.addCard=function(){var e=this._getSearchedCard()&&this._getSearchedCard().getManifest();this.getAggregation("_queryDialog").setBusy(true);sap.ui.require(["sap/insights/CardHelper"],function(t){t.getServiceAsync().then(function(t){t._createCard(e).then(function(e){this.getAggregation("_queryDialog").setBusy(false);g.show(this.i18Bundle.getText("Card_Created"));this.closeDialog();if(!e["sap.insights"].visible){S.information(this.i18Bundle.getText("INT_CARD_LIMIT_MESSAGEBOX"),{styleClass:"msgBoxAlign"})}if(this.hasListeners("onAddButtonPress")){this.fireOnAddButtonPress()}}.bind(this))}.bind(this)).catch(function(e){this.getAggregation("_queryDialog").setBusy(false);h.error(e.message);g.show(e.message)}.bind(this))}.bind(this))};A.prototype.closeDialog=function(){this._getQueryDialog().close()};A.prototype.openDialog=function(){this._getQueryDialog().open()};A.prototype.afterOpenDialog=function(){this._getTextBox().focus()};A.prototype._setAriaTextOnManifest=function(e){var t=e.getSource()._ariaText.getText();var s=this.i18Bundle.getText("INT_DIALOG_TITLE_CardPreview");e.getSource()._ariaText.setText(s+t);var i=e.getSource().getManifest()["sap.app"];if(i&&!(i.title===M["sap.app"].title)){e.getSource().setPreviewMode("Off")}};A.prototype._onManifestReady=function(e){var t=e.getSource();t.showLoadingPlaceholders()};A.prototype.onChange=function(e){const t=500;const s=this._getTextBox().getValue();const i=s.length>0&&s.length<=t;if(s?.trim().length){this._enableRegenerateButton(i);this._enableClearButton(true)}else{this.resetDialog()}};A.prototype._onSearch=function(){var e=this._getTextBox().getValue();var t=this._getSearchedCard();if(e&&e.trim().length){this._startGenerate=true;this.resetDialog();t.setVisible(false);this._getPlaceholder().setVisible(true);this._getCancelButton().focus();this._toggleButtonAndText(false);var s={UserInput:e};fetch(l.AI_INSIGHTCARD_BASEURL,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}}).then(function(e){var t=e.headers.get("X-CSRF-Token");return fetch(l.ADD_AI_INSIGHTCARD_COMPLETEURL,{method:l.POST,headers:{"X-CSRF-Token":t,"content-type":"application/json;odata.metadata=minimal;charset=utf-8"},body:JSON.stringify(s)})}).then(function(e){if(!e.ok){return e.json().then(function(e){return Promise.reject({message:e.message||e.error.message})})}return e.json()}).then(function(e){this._handleSearchSuccess(t,e)}.bind(this)).catch(function(e){this._handleSearchError(t,e)}.bind(this))}else{this._getTextBox().focus()}};A.prototype._handleSearchSuccess=function(e,t){if(this._startGenerate){this._toggleButtonAndText(true);var s="";if(t&&t.CardManifest){s=JSON.parse(t.CardManifest);var i=s["sap.insights"];var a=t.ApplicationInformation;if(i&&a&&a.SemanticObject&&a.SemanticAction){var n="#"+a.SemanticObject+"-"+a.SemanticAction;i["parentAppUrl"]=n}}if(s){this._getPlaceholder().setVisible(false);e.setVisible(true);e.setManifest(s);this._enableFocusAddButton(true);this._setMessageStripOverflowVisibility(true);this._toggleCardBox(true);var r=this._getFilterHBox();if(t.FilterTokens){var o=this._processFilterTokens(t.FilterTokens);o.forEach(function(e,t){if(e){var s=new v({text:e,key:t,editable:false}).addStyleClass("customTokenLineHeight");r.getItems()[1].addToken(s)}});this._addTokenArias()}}this._startGenerate=false}};A.prototype._processFilterTokens=function(e){var t=[];if(e){var s=e.filters||[];var i=e.orders||[];var a=e.app&&e.app.name;t.push(this.i18Bundle.getText("APP_LABEL")+": "+a);if(e.topWithLabel){t.push(e.topWithLabel.topLabel+": "+e.topWithLabel.value)}else if(e.top){t.push(this.i18Bundle.getText("TOP_LABEL")+": "+e.top)}s.forEach(function(e){const s=e.propertylabel||e.name;const i=this._formatFilterToken(e.operator,s,e.values);if(i&&!t.includes(i)){t.push(i)}}.bind(this));i.forEach(function(e){t.push(e.propertylabel+": "+(e.operatorlabel||e.operator))})}return t};A.prototype._formatFilterToken=function(e,t,s){var i=s[0].value.replace(/^'|'$/g,"");var a=s[1]?.value?.replace(/^'|'$/g,"");const n={eq:"",ne:"!=",gt:">",ge:">=",lt:"<",le:"<="};if(n[e]!==undefined){return`${t}: ${n[e]} ${i}`}const r={startswith:`${t}: ${i}*`,notstartswith:`${t}: !(${i}*)`,endswith:`${t}: *${i}`,notendswith:`${t}: !(*${i})`,contains:`${t}: *${i}*`,notcontains:`${t}: !(*${i}*)`,bt:`${t}: (${i}...${a})`,nb:`${t}: !(${i}...${a})`};return r[e]||`${t}: ${i}`};A.prototype._handleSearchError=function(e,t){if(this._startGenerate){this._toggleButtonAndText(true);h.error(t.message);this._getPlaceholder().setVisible(false);var s=/\((\d{2})\d*\)\s*(.*)/;var i=t.message.match(s);var a="",n="";if(i){a=i[1]}n=t.message;var r=this.setErrorMessage(a,n);var o=this._getNoCardMessage();o.setTitle(r.title);o.setDescription(r.description);o.setIllustrationType(r.type);this._toggleCardBox(false);setTimeout(function(){this._getTextBox().focus()}.bind(this),0);this._startGenerate=false}else{this._getTextBox().focus()}};A.prototype._addTokenArias=function(){var e=this._getFilterHBox();var t=e.getItems()[1];var s=t&&t.getTokens();if(s&&s.length){e.setVisible(true);s.forEach(function(e){t.addAriaDescribedBy(e.getId())})}};A.prototype.setErrorMessage=function(e,t){var s={type1:"sapIllus-UnableToLoad",type2:"sapIllus-NoSearchResults",type3:"sapIllus-NoData",type4:"sapIllus-UnableToUpload"};var i={type:"",title:"",description:t};switch(e){case"10":i.type=s.type1;i.title=this.i18Bundle.getText("ERRORCODE_TITLE1");break;case"20":i.type=s.type2;i.title=this.i18Bundle.getText("ERRORCODE_TITLE2");break;case"30":i.type=s.type3;i.title=this.i18Bundle.getText("ERRORCODE_TITLE3");break;case"40":i.type=s.type4;i.title=this.i18Bundle.getText("ERRORCODE_TITLE4");break;default:i.type=s.type4;i.title=this.i18Bundle.getText("ERRORCODE_TITLE");break}return i};A.prototype.resetDialog=function(e){if(e){this._getTextBox().setValue("");this._getNoCardMessage().setDescription(" ");this._toggleButtonAndText(true);this._startGenerate=false}this._getPlaceholder().setVisible(false);this._getSearchedCard().setVisible(true);var t=this._getFilterHBox();t.getItems()[1].removeAllAriaDescribedBy();t.getItems()[1].removeAllTokens();t.setVisible(false);this._setMessageStripOverflowVisibility(false);const s={"/sap.card/header/dataTimestamp":""};var i=this._getSearchedCard();i.setManifestChanges([s]);i.setManifest(M);i.setPreviewMode("Abstract");this._toggleCardBox(true);this._enableFocusAddButton(false);this._enableClearButton(false);this._enableRegenerateButton(false)};return A});
//# sourceMappingURL=ManageAddCardWithSearch.js.map