// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/i18n/Localization","sap/ushell/utils/HttpClient","sap/base/util/ObjectPath","sap/ushell/Config","sap/base/Log","sap/ushell/Container","sap/base/util/deepExtend","sap/ushell/adapters/cdm/v3/utilsCdm","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/ushell/utils","sap/base/util/uid"],function(e,t,n,a,s,i,r,o,p,u,c,l){"use strict";var d=function(){this.httpClient=new t;this._sBaseUrl=a.last("/core/workPages/contentApiUrl");const e=new URLSearchParams(window.location.search);this._sSiteId=e.get("siteId")||a.last("/core/site/siteId")};d.prototype._validateData=function(e){s.debug("cep/editMode: load Page: validate","Work Page service");if(e.errors&&e.errors.length>0){return Promise.reject(e.errors.map(function(e){return e.message}).join(",\n"))}if(!n.get("data.workPage",e)){s.debug("cep/editMode: load Page: validate: reject: data is empty","Work Page service");return Promise.reject("Work Page data is empty")}return Promise.resolve(e)};d.prototype.loadWorkPageAndVisualizations=async function(e,t){let n;let s;do{const i=a.last("/core/shell/intentNavigation");const r=this._createWorkPageQuery(this._sSiteId,e,s===undefined,n?.endCursor,i,t);const o=await this._doRequest(r);const p=await this._validateData(o);const u=await this._parseWorkPageData(p);if(!s){s=u.workPage}else{s.usedVisualizations.nodes.push(...u.workPage.usedVisualizations.nodes)}n=u.pageInfo}while(n?.hasNextPage);return Promise.resolve({workPage:s})};d.prototype._createWorkPageQuery=function(e,t,n,a,s,i){if(!e||!t){throw new Error(`Invalid Arguments, missing either siteId: ${e} or pageId: ${t}`)}const r=c.getFormFactor();const o=`\n            queryInput: {\n                filterWidgets: {\n                    visualization: {\n                        targetApp: {\n                            deviceType: { eq: "${r}" },\n                            launchType: { in: ["embedded", "standalone"] }\n                        }\n                    }\n                }\n            }`;return`{\n            workPage(\n                siteId: "${e}",\n                workPageId: "${t}"\n                ) {\n                    ${n?`\n                        id,\n                        contents${i?`(${o})`:""},\n                        editable,\n                        `:""}\n                    usedVisualizations${a?`(after:"${a}")`:""}{\n                        pageInfo{\n                            endCursor,\n                            hasNextPage\n                        }\n                        nodes{\n                            id,\n                            ${s?`\n                                targetAppIntent{\n                                    semanticObject,\n                                    action,\n                                    businessAppId\n                            },`:""}\n                            type,\n                            descriptor{\n                                value\n                            },\n                            descriptorResources{\n                                baseUrl,\n                                descriptorPath\n                            },\n                            provider{\n                                id\n                            },\n                            indicatorDataSource{\n                                url,\n                                refreshInterval\n                            }\n                        }\n                    }\n                }\n            }`.replace(/\s\s+/g,"").replace(/\n/gm,"")};d.prototype.loadSiteAndDataDestinationMappings=function(){const e=`{\n            site(siteId:"${this._sSiteId}") {\n              providers {\n                nodes {\n                  id,\n                  logicalDataDestinationMappings {\n                    logicalDestinationName,\n                    resolvedUrl\n                  }\n                }\n              }\n            }\n           }`.replace(/\s\s+/g,"").replace(/\n/gm,"");return this._doRequest(e)};d.prototype._parseWorkPageData=async function(e){const t=n.get("data.workPage.contents",e);const a=n.get("data.workPage.usedVisualizations.nodes",e)||[];const s=await this._transformVizData(a);const i=n.get("data.workPage.editable",e)===true;const r=n.get("data.workPage.usedVisualizations.pageInfo",e);return Promise.resolve({workPage:{contents:t,usedVisualizations:{nodes:s},editable:i},pageInfo:r})};d.prototype.loadVisualizations=function(e,t){let n=`\n        visualizations($queryInput: QueryVisualizationsInput) {\n            visualizations(queryInput: $queryInput, siteId: "${this._sSiteId}") {\n                totalCount,\n                nodes {\n                    id,\n                    type,\n                    descriptor {\n                        value,\n                        schemaVersion\n                    },\n                    descriptorResources {\n                        baseUrl,\n                        descriptorPath\n                    },\n                    indicatorDataSource {\n                        url,\n                        refreshInterval\n                    },\n                    targetAppIntent {\n                        semanticObject,\n                        action,\n                        businessAppId\n                    },\n                    systemLabel\n                }\n            }\n        }`;n=n.replace(/\n/g,"").replace(/ /g,"");n=`query ${n}`;if(t){const t=c.getFormFactor();e.filter=e.filter||[{}];e.filter=e.filter.map(e=>({...e,targetApp:{deviceType:{eq:t},launchType:{in:["embedded","standalone"]}}}))}const a={queryInput:e};return this._doRequest(n,JSON.stringify(a)).then(e=>({visualizations:e.data.visualizations||[],totalCount:e.data.totalCount||0}))};d.prototype._doRequest=function(t,n){let s=`${this._sBaseUrl}?query=${t}`;if(n){s+=`&variables=${encodeURIComponent(n)}`}const i={"Content-Type":"application/json",Accept:"application/json","Accept-Language":e.getLanguageTag().toString()};if(a.last("/core/site/sapCdmVersion")){i["sap-cdm-content-version"]=a.last("/core/site/sapCdmVersion")}return this.httpClient.get(s,{headers:i}).then(function(e){if(e.status<200||e.status>=300){return Promise.reject("HTTP request failed with status: "+e.status+" - "+e.statusText)}return JSON.parse(e.responseText||"{}")})};d.prototype._transformVizData=async function(e){const t=e.find(e=>e.type==="sap.ushell.StaticAppLauncher"||e.type==="sap.ushell.DynamicAppLauncher"||this._isSmartBusinessVizType(e));if(!t){return Promise.resolve(e)}const n=await i.getServiceAsync("CommonDataModel");const a=await n.getApplications();const s=await Promise.all(e.map(e=>{if(e.type==="sap.ushell.StaticAppLauncher"||e.type==="sap.ushell.DynamicAppLauncher"){return this._setApplicationProperties(e,a)}if(this._isSmartBusinessVizType(e)){return this._setSmartBusinessTilesProperties(e,n)}return e}));return Promise.resolve(s)};d.prototype._setApplicationProperties=async function(e,t){const s=n.get(["descriptor","value","sap.flp","target","appId"],e);const i=t[s];const c=n.get(["descriptor","value","sap.flp","indicatorDataSource","dataSource"],e);const l=n.get(["sap.app","dataSources",c],i);const d=n.get(["sap.app","contentProviderId"],i);const g=await p.getContentProviderLabel(d);const h=a.last("/core/shell/intentNavigation");const v={vizConfig:n.get(["descriptor","value"],e)};v.target=p.harmonizeTarget(u.getTarget(v)||{});if(h){e.target=v.target;e.targetURL=o.toHashFromTargetIntent(e.targetAppIntent,v.target)}const y=r({},e,{_siteData:{contentProviderId:d,contentProviderLabel:g,target:h?"":v.target,targetURL:h?"":o.toHashFromVizData(v,t),dataSource:l}});return y};d.prototype._isSmartBusinessVizType=function(e){return e.type.startsWith("ssuite.smartbusiness.tiles.")};d.prototype._setSmartBusinessTilesProperties=async function(e,t){const n=await t.getVizTypes();var a=l();return p.getVizData({vizTypes:n,visualizations:{[e.id]:{vizType:e,vizConfig:e.descriptor.value}}},{id:a,vizId:e.id,vizType:e.type}).then(t=>r({},e,{_siteData:t,vizType:t._instantiationData.vizType,descriptor:{value:t.vizConfig}}))};return d},true);
//# sourceMappingURL=WorkPageService.js.map