// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/Core","sap/ui/integration/Extension","sap/ushell/utils/DynamicTileRequest","sap/ui/core/format/NumberFormat","sap/base/Log","sap/m/library","sap/ui/core/library"],function(t,e,r,i,n,a,s){"use strict";const u=e.extend("sap.ushell.utils.workpage.TileCardExtension");u._DynamicTileRequest=r;u._DynamicTileRequestTimeout=3e4;const o=n.getLogger("sap.ushell.utils.tilecard.TileCardExtension");const l=a.ValueColor;const m=s.ValueState;const f={Positive:"Positive",Negative:"Negative",Critical:"Critical"};const c=[{factor:1e6,value:"M"},{factor:1e3,value:"k"}];function b(t){if(t===f.Positive){return m.Success}else if(t===f.Negative){return m.Error}else if(t===f.Critical){return m.Warning}return m[t]||m.None}function d(t){if(t===f.Positive){return l.Good}else if(t===f.Negative){return l.Error}return l[t]||l.None}function h(t,e){if(t.info){return t.info}if(t.number==="#"){return e}return""}function p(t){if(!t.hasOwnProperty("number")||t.number==="..."||t.number==="#"){return l.None}return d(t.numberState)}function _(t){if(!t.hasOwnProperty("number")){t.number="..."}if(typeof t.number==="string"&&t.number!=="..."){t.number=parseFloat(t.number);if(isNaN(t.number)){t.number="#"}}if(!isNaN(t.number)){if(!t.hasOwnProperty("numberFactor")){t._data.unit="";if(t.number>=1e3){const e=c.find(function(e){return t.number/e.factor>=1&&t.number/(e.factor*1e3)<1});t._data.unit=e.value;t.number=t.number/e.factor}}else{t._data.unit=t.numberFactor}if(!t.hasOwnProperty("numberDigits")&&t._data.unit){t.numberDigits=2}const e=i.getFloatInstance({minFractionDigits:Math.min(t.numberDigits,3),maxFractionDigits:Math.min(t.numberDigits,3)});t.number=e.format(t.number)}return t.number}function g(t,e){if(!isNaN(t)){t={number:t}}if(Array.isArray(t.results)){t.targetParams=t.targetParams||[];t.number=t.results.reduce(function(e,r){if(r.targetParams){t.targetParams.push(r.targetParams)}return e+(parseFloat(r.number)||0)},0)}t._data={};t._data.number=_(t);t._data.details={};t._data.details.text=h(t,e);t._data.details.state=b(t.infoState);t._data.state=p(t);t._data.trend=t.stateArrow||null;t._data.icon=t.icon||null;t._data.title=t.title||null;t._data.subtitle=t.subtitle||null;if(Array.isArray(t._data.targetParams)){t._data.targetParams=t.targetParams.join("&")}return t}u.prototype.onCardReady=function(){this.bFirstRequest=true;this._oCurrentDataRequest=null;this._oCurrentDataRequestSendTS=0;this._sErrorText=this.getCard().getTranslatedText("TileCard.Data.Error");this._sTimeoutText=this.getCard().getTranslatedText("TileCard.Data.Timeout");this._oErrorResponse=g({number:"...",info:this._sErrorText},this._sErrorText);this._oTimeoutResponse=g({number:"...",info:this._sTimeoutText},this._sErrorText)};u.prototype.fetch=function(t){if(t.startsWith("/.")){t=t.substring(1)}if(!this.bFirstRequest&&Date.now()-this._oCurrentDataRequestSendTS<2e3){return this._oCurrentDataRequest}this._oCurrentDataRequestSendTS=Date.now();this._oCurrentDataRequest=this._fetchTileCardData(t);if(this.bFirstRequest){this.bFirstRequest=false;return Promise.resolve(new Response(new Blob(['number: "..."'],{type:"application/json"}),{status:429}))}return this._oCurrentDataRequest};u.prototype._fetchTileCardData=function(e){let r=false;const i=this._sErrorText;return new Promise(function(t){setTimeout(()=>{r=true;t(this._oTimeoutResponse)},u._DynamicTileRequestTimeout);setTimeout(()=>{try{new u._DynamicTileRequest(e,function(n){o.debug("Dynamic tileCard request successful.",e);if(!r){t(g(n,i))}},function(){o.info("Dynamic tileCard request failed.",e);if(!r){t(this._oErrorResponse)}})}catch(e){o.error("Dynamic tileCard normalization failed.",e);if(!r){t(this._oErrorResponse)}}},1)}.bind(this)).then(function(e){var r=t.byId(this.getCard().getDomRef().id).getCardHeader();if(e.title){r.setTitle(e.title)}if(e.subtitle){r.setSubtitle(e.subtitle)}return new Response(new Blob([JSON.stringify(e)],{type:"application/json"}),{status:200})}.bind(this)).catch(function(t){return new Response(new Blob(["{}"],{type:"application/json"}),{status:200})})};return u});
//# sourceMappingURL=TileCardExtension.js.map