// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/thirdparty/jquery","sap/ushell/appIntegration/PostMessagePluginInterface","sap/ushell/services/PluginManager/Extensions","sap/ushell/UI5ComponentType","sap/ushell/utils","sap/ushell/Container","sap/ushell/services/PluginManager/SimpleExpression"],(e,jQuery,n,i,t,o,s,r)=>{"use strict";const a="sap.ushell.services.PluginManager";const l="sap-ushell-plugin-type";const u="RendererExtensions";const c="sap.ushell.components.shell.defaults";const g=[u,"UserDefaults","UserImage","AppWarmup"];function p(p,d,f){const h=this;this._oPluginCollection={};this._oCategoryLoadingProgress={};this._mInitializedComponentPromise={};this._sPluginAgentsNames="";this._oConfig=f&&f.config||{};if(this._oConfig.isBlueBox===undefined){this._oConfig.isBlueBox=false}g.forEach(e=>{h._oPluginCollection[e]={};h._oCategoryLoadingProgress[e]=new jQuery.Deferred});this._handlePluginCreation=async function(n,i,t,s){const r=h._oPluginCollection[n][i];o.setPerformanceMark(`FLP -- PluginManager.loadPlugin[${n}][${i}]`);try{if(r.hasOwnProperty("component")){if(h._mInitializedComponentPromise.hasOwnProperty(r.component)){h._mInitializedComponentPromise[r.component].then(()=>{h._instantiateComponent(r,t,s)},()=>{h._instantiateComponent(r,t,s)})}else{h._mInitializedComponentPromise[r.component]=h._instantiateComponent(r,t,s)}}else{e.error(`Invalid plugin configuration. The plugin ${i} must contain a <component> key`,a)}}catch(n){e.error(`Error while loading bootstrap plugin: ${r.component}`||"",a);if(t){t.reject(n)}}};this._getFileNameForXhrAuth=function(){return"Component-preload.js"};this._handleXhrAuthentication=function(n,i){let t;if(n&&["true",true,"X"].indexOf(n["sap-ushell-xhr-authentication"])>-1){if(!i){e.error(["Illegal state: configuration parameter 'sap-ushell-xhr-authentication-timeout' set, but no component URL specified.","XHR authentication request will not be sent. Please check the target mapping definitions for plug-ins","and the application index."].join(" "),undefined,a);return jQuery.when()}if(n.hasOwnProperty("sap-ushell-xhr-authentication-timeout")){t=parseInt(n["sap-ushell-xhr-authentication-timeout"],10);if(isNaN(t)){e.error(["Invalid value for configuration parameter 'sap-ushell-xhr-authentication-timeout' for plug-in component with URL '",i,"': '",n["sap-ushell-xhr-authentication-timeout"],"' is not a number. Timeout will be ignored."].join(""),undefined,a)}else{s.setXhrLogonTimeout(i,t)}}return jQuery.ajax(`${i}/${this._getFileNameForXhrAuth()}`,{dataType:"text"})}return jQuery.when()};this._instantiateComponent=function(n,o,r){const l=new jQuery.Deferred;const u=JSON.parse(JSON.stringify(n));const c={ui5ComponentName:u.component,url:u.url,getExtensions:i.bind(null,n.component)};function g(n){return function(i){n=n||`Cannot create UI5 plugin component: (componentId/appdescrId :${c.ui5ComponentName})\n${i} properties ${JSON.stringify(c)}\n This indicates a plugin misconfiguration, see e.g. Note 2316443.`;i=i||"";e.error(n,i.stack,a);if(o){o.reject.apply(this,arguments)}l.reject.apply(this,arguments)}}u.name=u.component;delete u.component;c.applicationDependencies=u;if(u.config){c.applicationConfiguration=u.config;delete u.config}c.loadDefaultDependencies=false;if(r!==undefined){c.oPostMessageInterface=r}s.getServiceAsync("Ui5ComponentLoader").then(e=>{this._handleXhrAuthentication(c.applicationConfiguration,u.url).done(()=>{e.createComponent(c,{},[],t.Plugin).then(function(e){if(o){o.resolve(e)}l.resolve.apply(this,arguments)}).catch(g())}).fail(g("XHR logon for FLP plugin failed"))}).catch(g());return l.promise()};this.getSupportedPluginCategories=function(){return JSON.parse(JSON.stringify(g))};this.getRegisteredPlugins=function(){return JSON.parse(JSON.stringify(this._oPluginCollection))};this.isPluginConfigured=function(e,n=u){if(!this._oPluginCollection[n]){return false}const i=new URLSearchParams(window.location.search).get("sap-ushell-xx-pluginmode")||"";const t=this.filterPluginIds(Object.keys(this._oPluginCollection[n]),i,n);return t.includes(e)};this.registerPlugins=async function(n){let i;if(!n){return}if(this._oConfig.isBlueBox===true){i=new URLSearchParams(window.location.search).get("sap-plugins");if(i&&i.length>0){i=`,${i},`}else{i=undefined}}const t=await this._addPluginsIntoCollection(n,i);try{if(this._oConfig.isBlueBox!==true){this._buildNamesOfPluginsWithAgents()}}catch(n){e.error("failed to build plugin agents names list",n.message||n.toString(),"sap.ushell.services.PluginManager")}t.forEach(e=>{if(Object.hasOwn(this._oCategoryLoadingProgress,e)&&this._oCategoryLoadingProgress[e].state()==="resolved"){this.loadPlugins(e)}})};this._addPluginsIntoCollection=async function(n,i=""){const t=[];for(const s of Object.keys(n).sort()){const r=n[s]||{};const c=r.config||{};const p=c[l]||"";r.enabled??=true;if(r.enabled===false){continue}if(!this._isFormFactorSupported(r)){e.info(`Plugin '${s}' filtered from result: form factor not supported`);continue}if(this._oConfig.isBlueBox===true&&c["sap-plugin-agent"]===true){const e=c["sap-plugin-agent-id"]||s;if(!i.includes(`,${e},`)){continue}}if(Object.hasOwn(r,"module")){const n=(r.module||"").replace(/\./g,"/");e.error(`Plugin ${s} cannot get registered, because the module mechanism for plugins is not valid anymore. Plugins need to be defined as SAPUI5 components.`,a);try{await o.requireAsync([n])}catch(i){e.error(`Plugin module ${n} is not found.`)}continue}if(Object.hasOwn(c,l)){if(g.includes(p)){if(!t.includes(p)){t.push(p)}this._oPluginCollection[p][s]=JSON.parse(JSON.stringify(r))}else{e.warning(`Plugin ${s} will not be inserted into the plugin collection of the PluginManager, because of unsupported category ${p}`,a)}}else{this._oPluginCollection[u][s]=JSON.parse(JSON.stringify(r));if(!t.includes(u)){t.push(u)}}}return t};this._isFormFactorSupported=function(e){const n=e.deviceTypes;const i=o.getFormFactor();if(n&&n[i]===false){return false}return true};this.getPluginLoadingPromise=function(e){if(this._oCategoryLoadingProgress.hasOwnProperty(e)){return this._oCategoryLoadingProgress[e].promise()}};this.filterPluginIds=function(e,n,i){let t;if(n.startsWith("discard-filter-")){t="discardFilterPluginsAccordingToSimpleExpression"}else if(n.startsWith("discard")){t="discardAlmostAllPlugins"}else{t="noDiscard"}switch(t){case"discardFilterPluginsAccordingToSimpleExpression":var o=n.replace("discard-filter-","");return r.filterByExpression(e,o);case"discardAlmostAllPlugins":return e.filter(e=>h._oPluginCollection[i][e].component===c);case"noDiscard":default:return e}};this.loadPlugins=function(i){let t;o.setPerformanceMark(`FLP -- PluginManager.startLoadPlugins[${i}]`);if(i===u){t=n.getInterface()}if(g&&Array.prototype.indexOf.call(g,i)!==-1){if(h._oCategoryLoadingProgress[i].pluginLoadingTriggered===undefined){h._oCategoryLoadingProgress[i].pluginLoadingTriggered=true}if(Object.keys(h._oPluginCollection[i]).length>0){const e=[];let n=Object.keys(h._oPluginCollection[i]);const s=new URLSearchParams(window.location.search).get("sap-ushell-xx-pluginmode")||"";n=this.filterPluginIds(n,s,i,h);n.forEach(n=>{const o=h._oPluginCollection[i][n];if(!o.loaded){o.loaded=true;const s=new jQuery.Deferred;e.push(s.promise());h._handlePluginCreation(i,n,s,t)}});if(e.length>0){Promise.allSettled(e.map((e,i)=>new Promise(t=>{const o={pluginName:n[i],success:true};e.done(()=>{t(o)}).fail(e=>{o.success=false;o.error=e;t(o)})}))).then(e=>{o.setPerformanceMark(`FLP -- PluginManager.endLoadPlugins[${i}]`);h._oCategoryLoadingProgress[i].resolve(e.map(e=>e.value))})}}else{h._oCategoryLoadingProgress[i].resolve()}}else{e.error(`Plugins with category ${i} cannot be loaded by the PluginManager`,a);h._oCategoryLoadingProgress[i].reject(`Plugins with category ${i} cannot be loaded by the PluginManager`)}return h._oCategoryLoadingProgress[i].promise()};this._buildNamesOfPluginsWithAgents=function(){let e="";Object.keys(h._oPluginCollection).forEach(n=>{Object.keys(h._oPluginCollection[n]).forEach(i=>{const t=h._oPluginCollection[n][i];if(t&&t.enabled&&t.enabled===true){if(t.config&&t.config["sap-plugin-agent"]===true){e+=`${t.config["sap-plugin-agent-id"]||i},`}}})});if(e.endsWith(",")){e=e.slice(0,-1)}this._sPluginAgentsNames=e};this._getNamesOfPluginsWithAgents=function(){return this._sPluginAgentsNames}}p.hasNoAdapter=true;return p},true);
//# sourceMappingURL=PluginManager.js.map