// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/core/EventBus","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/library","sap/ushell/utils","sap/base/util/deepClone","sap/base/util/deepExtend","sap/base/Log"],function(e,jQuery,r,t,o,n,a,i){"use strict";var s="sap.ushell.services.Bookmark";var u="X-SAP-UI2-HANA:hana?remoteId=HANA_CATALOG";var c=t.ContentNodeType;function l(){this._oLaunchPageServicePromise=sap.ushell.Container.getServiceAsync("LaunchPage");if(r.last("/core/spaces/enabled")){this._oPagesServicePromise=sap.ushell.Container.getServiceAsync("Pages")}this._addBookmarkToContentNodes=function(e,r,t,o){var n=r.map(function(r){if(r&&r.hasOwnProperty("type")&&r.isContainer){switch(r.type){case c.Page:return this.addBookmarkToPage(e,r.id,o);case c.HomepageGroup:return new Promise(function(e,t){this._oLaunchPageServicePromise.then(function(o){o.getGroupById(r.id).done(e).fail(t)})}.bind(this)).then(function(r){return this.addBookmarkToHomepageGroup(e,r,t,o)}.bind(this));default:return Promise.reject("Bookmark Service: The API needs to be called with a valid content node type. '"+r.type+"' is not supported.")}}return Promise.reject("Bookmark Service: Not a valid content node.")}.bind(this));return Promise.all(n)};this.addBookmark=function(e,t,o){var n=new jQuery.Deferred;var a=r.last("/core/shell/enablePersonalization");var u=r.last("/core/spaces/enabled");var c=r.last("/core/spaces/myHome/enabled");if(!a&&(!u||!c)){return n.resolve().promise()}this._checkBookmarkParameters(e).then(()=>this._changeUrlStatesToPersistent(e.url)).then(function(r){e.url=r;if(typeof t==="undefined"&&u){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getDefaultSpace()}).then(function(e){var r=e&&e.children&&e.children[0];return r}).then(function(r){return this._addBookmarkToContentNodes(e,[r],false,o)}.bind(this))}if((typeof t==="undefined"||!t.hasOwnProperty("type"))&&!Array.isArray(t)){return this.addBookmarkToHomepageGroup(e,t,false,o)}var n=[].concat(t);return this._addBookmarkToContentNodes(e,n,false,o)}.bind(this)).then(n.resolve).catch(function(e){i.error("Error during Bookmark creation: ",e,s);n.reject(e)});return n.promise()};this.addCustomBookmark=async function(e,r,t,o){var i=n(r);var s=a(i,{vizType:e,vizConfig:{"sap.flp":{chipConfig:i.chipConfig},"sap.platform.runtime":{includeManifest:!i.loadManifest}}});delete s.chipConfig;delete s.loadManifest;s.url=await this._changeUrlStatesToPersistent(s.url);var u=[].concat(t);return this._addBookmarkToContentNodes(s,u,true,o)};this.addBookmarkToHomepageGroup=function(t,o,n,a){if(r.last("/core/spaces/enabled")){var i="Bookmark Service: The API is not available in spaces mode.";return Promise.reject(i)}return new Promise(function(r,i){this._oLaunchPageServicePromise.then(function(s){var u;if(n){u=s.addCustomBookmark(t,o,a)}else{u=s.addBookmark(t,o,a)}u.done(function(t){var n={tile:t,group:o};e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileAdded",n);r()}).fail(i)})}.bind(this))};this.addBookmarkToPage=function(e,t,o){if(!r.last("/core/spaces/enabled")){return Promise.reject("Bookmark Service: 'addBookmarkToPage' is not valid in launchpad home page mode, use 'addBookmark' instead.")}var n=r.last("/core/shell/enablePersonalization");var a=r.last("/core/spaces/myHome/enabled");var i=r.last("/core/spaces/myHome/myHomePageId");if(!n&&(!a||a&&t!==i)){return Promise.reject("Bookmark Service: Add bookmark is not allowed as the personalization functionality is not enabled.")}if(e&&(typeof e.title!=="string"||typeof e.url!=="string")){return Promise.reject("Bookmark Service - Invalid bookmark data.")}return this._oPagesServicePromise.then(function(r){return r.addBookmarkToPage(t,e,undefined,o)})};this.addBookmarkByGroupId=function(e,t,o){var n=new jQuery.Deferred;if(r.last("/core/spaces/enabled")){var a="Bookmark Service: The API 'addBookmarkByGroupId' is not supported in launchpad spaces mode.";return n.reject(a).promise()}this._oLaunchPageServicePromise.then(function(r){r.getGroups().done(function(r){var a=r.find(function(e){return e.id===t})||null;this.addBookmark(e,a,o).done(n.resolve).fail(n.reject)}.bind(this)).fail(n.reject)}.bind(this)).catch(n.reject);return n.promise()};this.getShellGroupIDs=function(e){var t=new jQuery.Deferred;if(r.last("/core/spaces/enabled")){var o="Bookmark Service: The API 'getShellGroupIDs' is not supported in launchpad spaces mode.";return t.reject(o).promise()}this._oLaunchPageServicePromise.then(function(r){r.getGroupsForBookmarks(e).done(function(e){e=e.map(function(e){return{id:r.getGroupId(e.object),title:e.title}});t.resolve(e)}).fail(t.reject)});return t.promise()};this._doAddCatalogTileToGroup=function(e,r,t,o){this._oLaunchPageServicePromise.then(function(n){if(o){n.getGroups().fail(e.reject).done(function(a){var s=a.some(function(a){if(n.getGroupId(a)===o){this._addToGroup(t,e,r,a);return true}}.bind(this));if(!s){var u="Group '"+o+"' is unknown";i.error(u,null,"sap.ushell.services.Bookmark");e.reject(u)}}.bind(this))}else{n.getDefaultGroup().fail(e.reject).done(function(o){this._addToGroup(t,e,r,o)}.bind(this))}}.bind(this));return e.promise()};this._isSameCatalogTile=function(e,r,t){var o=t.getCatalogTileId(r);if(o===undefined){return false}return o.indexOf(e)===0};this._addToGroup=function(r,t,o,n){return this._oLaunchPageServicePromise.then(function(a){a.getCatalogTiles(r).fail(t.reject).done(function(s){var u=a.getGroupId(n);var c=s.some(function(r){if(this._isSameCatalogTile(o,r,a)){a.addTile(r,n).fail(t.reject).done(function(){t.resolve();e.getInstance().publish("sap.ushell.services.Bookmark","catalogTileAdded",u)});return true}}.bind(this));if(!c){var l="No tile '"+o+"' in catalog '"+a.getCatalogId(r)+"'";i.error(l,null,"sap.ushell.services.Bookmark");t.reject(l)}}.bind(this))}.bind(this))};this.addCatalogTileToGroup=function(e,t,o){var n=new jQuery.Deferred;var a;i.error("Deprecated API call of 'sap.ushell.Bookmark.addCatalogTileToGroup'. Please use 'addBookmark' instead",null,"sap.ushell.services.Bookmark");if(r.last("/core/spaces/enabled")){a="Bookmark Service: The API 'addCatalogTileToGroup' is not supported in launchpad spaces mode.";return n.reject(a).promise()}this._oLaunchPageServicePromise.then(function(r){var s=o?this._isMatchingRemoteCatalog:this._isLegacyHANACatalog;o=o||{id:u};r.onCatalogTileAdded(e);r.getCatalogs().fail(n.reject).done(function(u){var c;u.forEach(function(e){if(s(e,o,r)){if(!c){c=e}else{i.warning("More than one matching catalog: "+JSON.stringify(o),null,"sap.ushell.services.Bookmark")}}});if(c){this._doAddCatalogTileToGroup(n,e,c,t)}else{a="No matching catalog found: "+JSON.stringify(o);i.error(a,null,"sap.ushell.services.Bookmark");n.reject(a)}}.bind(this))}.bind(this));return n.promise()};this._checkBookmarkParameters=function(e){return Promise.resolve().then(function(){if(!e){throw new Error("Invalid Bookmark Data: No bookmark parameters passed.")}var r=e.dataSource;var t;if(r){if(r.type!=="OData"){throw new Error("Invalid Bookmark Data: Unknown data source type: "+r.type)}t=r.settings&&r.settings.odataVersion;var o=["2.0","4.0"];if(!o.includes(t)){throw new Error("Invalid Bookmark Data: Unknown OData version in the data source: "+t)}}if(e.serviceUrl){return sap.ushell.Container.getServiceAsync("ReferenceResolver").then(function(t){if(t.hasSemanticDateRanges(e.serviceUrl)&&!r){throw new Error("Invalid Bookmark Data: Provide a data source to use semantic date ranges.")}})}})};this._isMatchingRemoteCatalog=function(e,r,t){var o=t.getCatalogData(e);return o.remoteId===r.remoteId&&o.baseUrl.replace(/\/$/,"")===r.baseUrl.replace(/\/$/,"")};this._isLegacyHANACatalog=function(e,r,t){return t.getCatalogId(e)===u};this.countBookmarks=function(e,t){var o=new jQuery.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(r){return r.countBookmarks({url:e,contentProviderId:t})}).then(o.resolve,o.reject)}else{this._oLaunchPageServicePromise.then(function(r){r.countBookmarks(e,t).done(o.resolve).fail(o.reject)})}return o.promise()};this.countCustomBookmarks=function(e){if(!e||!e.url||!e.vizType){return Promise.reject("countCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.countBookmarks(e)})}return this._oLaunchPageServicePromise.then(function(r){return r.countCustomBookmarks(e)})};this.deleteBookmarks=function(t,o){var n=new jQuery.Deferred;if(r.last("/core/spaces/enabled")){this._oPagesServicePromise.then(function(e){return e.deleteBookmarks({url:t,contentProviderId:o})}).then(n.resolve,n.reject)}else{this._oLaunchPageServicePromise.then(function(r){r.deleteBookmarks(t,o).done(function(r){e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",t);n.resolve(r)}).fail(n.reject)})}return n.promise()};this.deleteCustomBookmarks=function(t){if(!t||!t.url||!t.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(e){return e.deleteBookmarks(t)})}return this._oLaunchPageServicePromise.then(function(e){return e.deleteCustomBookmarks(t)}).then(function(){e.getInstance().publish("sap.ushell.services.Bookmark","bookmarkTileDeleted",t.url)})};this.updateBookmarks=function(e,t,o){var n=new jQuery.Deferred;if(r.last("/core/spaces/enabled")){Promise.all([this._oPagesServicePromise,this._changeUrlStatesToPersistent(t.url)]).then(function([r,n]){t.url=n;return r.updateBookmarks({url:e,contentProviderId:o},t)}).then(n.resolve,n.reject)}else{Promise.all([this._oLaunchPageServicePromise,this._changeUrlStatesToPersistent(t.url)]).then(function([r,a]){t.url=a;r.updateBookmarks(e,t,o).done(n.resolve).fail(n.reject)})}return n.promise()};this.updateCustomBookmarks=async function(e,t){if(!e||!e.url||!e.vizType){return Promise.reject("deleteCustomBookmarks: Some required parameters are missing.")}var o=a({},t,{vizConfig:{"sap.flp":{chipConfig:t.chipConfig},"sap.platform.runtime":{includeManifest:!t.loadManifest}}});delete o.chipConfig;delete o.loadManifest;o.url=await this._changeUrlStatesToPersistent(o.url);if(r.last("/core/spaces/enabled")){return this._oPagesServicePromise.then(function(r){return r.updateBookmarks(e,o)})}return this._oLaunchPageServicePromise.then(function(r){return r.updateCustomBookmarks(e,o)})};this.getContentNodes=function(){if(r.last("/core/spaces/enabled")){return sap.ushell.Container.getServiceAsync("Menu").then(function(e){return e.getContentNodes()})}return new Promise(function(e,r){this._oLaunchPageServicePromise.then(function(t){t.getGroupsForBookmarks().done(function(r){var o=r.map(function(e){return{id:t.getGroupId(e.object),label:e.title,type:c.HomepageGroup,isContainer:true}});e(o)}).fail(r)})}.bind(this))};this._changeUrlStatesToPersistent=async function(e){const r=await sap.ushell.Container.getServiceAsync("AppState");var t=r.getPersistentWhenShared();if(r.getSupportedPersistencyMethods().length===0&&t!==true){return e}if(e&&e.length>0){return o.promisify(r.setAppStateToPublic(e))}return e}}l.hasNoAdapter=true;return l},true);
//# sourceMappingURL=Bookmark.js.map