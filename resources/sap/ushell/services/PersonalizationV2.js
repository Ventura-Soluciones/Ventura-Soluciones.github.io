// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/Deferred","sap/ui/base/ManagedObject","sap/ui/base/Object","sap/ui/core/Component","sap/ui/thirdparty/jquery","sap/ushell/utils","sap/ushell/services/PersonalizationV2/utils","sap/ushell/services/PersonalizationV2/constants","sap/ushell/services/PersonalizationV2/ContextContainer","sap/ushell/services/PersonalizationV2/WindowAdapter","sap/ushell/services/PersonalizationV2/TransientPersonalizer","sap/ushell/services/PersonalizationV2/Personalizer","sap/ushell/services/PersonalizationV2/VariantSetAdapter","sap/ushell/services/PersonalizationV2/Variant","sap/ushell/services/PersonalizationV2/VariantSet","sap/ushell/services/PersonalizationV2/WindowAdapterContainer"],function(e,t,n,r,a,jQuery,i,o,s,p,d,u,c,l,f,h,A){"use strict";function _(e,t,n,r){this._oConfig=r&&r.config||{};this._oAppVariantAdapterWithBackendAdapter=this._configureAppVariantStorage(this._oConfig.appVariantStorage);this._oAdapterWithBackendAdapter={lazy:false,instance:new d(this,e)};this._oAdapterWindowOnly={lazy:false,instance:new d(this,undefined)};this._oContainerMap=new i.Map;this._oPendingOperationsMap=new i.Map}_.prototype.SAVE_DEFERRED_DROPPED="Deferred save dropped (OK) - Data superseded by subsequent save";_.prototype.constants=s;_.prototype.KeyCategory=s.keyCategory;_.prototype.WriteFrequency=s.writeFrequency;_.prototype._configureAppVariantStorage=function(e){var n=this;var r="sap.ushell.adapters.AppVariantPersonalizationAdapter";if(!e){e={adapter:{module:r}}}if(Object.keys(e).length===0||e.enabled===false){return}var a=e.adapter&&e.adapter.module||r;var i=a.split(".").join("/");var o=function(){n._oAppVariantAdapterLoadPromise=n._oAppVariantAdapterLoadPromise||function(){var e=new t;try{sap.ui.require([i],r)}catch(t){e.reject(t)}function r(t){try{var r=new t;var a=new d(n,r);e.resolve(a)}catch(t){e.reject(t)}}return e.promise}();return n._oAppVariantAdapterLoadPromise};return{lazy:true,create:o}};_.prototype.getGeneratedKey=async function(){return i.generateRandomKey()};_.prototype.getPersonalizer=async function(e,t,n){n=n||this._getApplicationComponent();return new c(this,this._oAdapterWithBackendAdapter.instance,e,t,n)};_.prototype._getApplicationComponent=function(){var e=n._sOwnerId;if(e){var t=a.getComponentById(e);if(r.isObjectA(t,"sap.ui.core.Component")){return t}}return undefined};_.prototype.getTransientPersonalizer=async function(){return new u};_.prototype.getContainer=async function(e,t,n){n=n||this._getApplicationComponent();const r=await this._createContainer(e,t,false,n);return r};_.prototype.createEmptyContainer=async function(e,t,n){n=n||this._getApplicationComponent();const r=await this._createContainer(e,t,true,n);return r};_.prototype._createContainer=async function(e,t,n,r){if(typeof e!=="string"){throw new i.Error("sContainerKey is not a string: sap.ushell.services.Personalization"," ")}var a=!!(o.isAppVariant(r)&&(!t||!t.shared)&&this._oAppVariantAdapterWithBackendAdapter);var s=o.adjustScope(t);var d=o.addContainerPrefix(e);if(a){var u=r.getManifestObject();s.component=r;s.appVarId=u.getEntry("/sap.ui5/appVariantId");s.appVersion=u.getEntry("/sap.app/applicationVersion/version");d+="#"+u.getEntry("/sap.ui5/appVariantId")}var c=a?this._oAppVariantAdapterWithBackendAdapter:this._oAdapterWithBackendAdapter;var l=this._oAdapterWindowOnly;var f=o.pickAdapter(t,l,c);const h=await o.loadAdapter(f);var A=new p(this,h,d,s,r);var _=h&&h.supportsGetWithoutSubsequentLoad===true;if(!(n&&_)){await A.load()}if(n||A.isExpired()){A.clearData()}return A};_.prototype.deleteContainer=function(t,n){var r="";var a=this;n=a._adjustScope(n);r=o.addContainerPrefix(t);const s=new jQuery.Deferred;var p=a._pendingContainerOperations_cancelAddNext(t,null);p.always(function(){a.getContainer(t,n).then(function(){var i;a._pendingContainerOperations_cancelAddNext(t,s);i=n.validity===0?a._oAdapterWindowOnly:a._oAdapterWithBackendAdapter;o.loadAdapter(i).then(function(t){t.delAdapterContainer(r,n).fail(function(t){e.error("Delete failed",t);s.reject()}).done(function(){s.resolve()})},function(t){e.error("Delete failed",t);s.reject()})}).catch(function(n){e.error("Delete failed",n);a._pendingContainerOperations_cancelAddNext(t,s);s.reject()})});return i.promisify(s.promise())};_.prototype._pendingContainerOperations_flushAddNext=function(e,t){var n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;if(typeof n._sapFnSave==="function"){var r=n._sapFnSave;n._sapFnSave=undefined;r()}return n};_.prototype._pendingContainerOperations_cancelAddNext=function(e,t){var n;n=this._oPendingOperationsMap.get(e);if(!n){n=new jQuery.Deferred;n.resolve()}if(t!==null){this._oPendingOperationsMap.put(e,t)}if(!n||n.state()!=="pending"){return n}if(n._sapTimeoutId){clearTimeout(n._sapTimeoutId);n._sapTimeoutId=undefined;n.resolve(_.prototype.SAVE_DEFERRED_DROPPED)}return n};_.prototype._getBackendAdapter=function(){return this._oAdapterWithBackendAdapter.instance._oBackendAdapter};_.prototype.resetEntirePersonalization=function(){var e=this._getBackendAdapter();return this.isResetEntirePersonalizationSupported().then(function(t){if(t){return e.resetEntirePersonalization()}return Promise.reject()})};_.prototype.isResetEntirePersonalizationSupported=function(){var t=this._getBackendAdapter();if(typeof t.resetEntirePersonalization!=="function"){return Promise.resolve(false)}if(typeof t.isResetEntirePersonalizationSupported==="function"){return t.isResetEntirePersonalizationSupported().then(function(e){return e}).catch(function(t){e.error("isResetEntirePersonalizationSupported failed with error:",t);return Promise.reject(t)})}return Promise.resolve(true)};_.prototype._adjustScope=o.adjustScope;_.hasNoAdapter=false;_.ContextContainer=p;_.Variant=f;_.VariantSet=h;_.VariantSetAdapter=l;_.WindowAdapter=d;_.WindowAdapterContainer=A;return _});
//# sourceMappingURL=PersonalizationV2.js.map