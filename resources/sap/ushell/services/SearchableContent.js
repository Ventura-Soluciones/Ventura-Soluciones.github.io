// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/Config","sap/ushell/Container","sap/ushell/adapters/cdm/v3/_LaunchPage/readApplications","sap/ushell/adapters/cdm/v3/_LaunchPage/readPages","sap/ushell/adapters/cdm/v3/_LaunchPage/readUtils","sap/ushell/adapters/cdm/v3/utilsCdm","sap/base/util/values","sap/ushell/library","sap/ushell/adapters/cdm/v3/_LaunchPage/readVisualizations","sap/base/Log","sap/ushell/utils/UrlParsing","sap/ushell/utils"],function(t,e,i,a,n,r,o,s,l,u,c,p){"use strict";var h=s.DisplayFormat;var g=function(){};g.COMPONENT_NAME="sap/ushell/services/SearchableContent";g.prototype.getApps=function(e={}){const i={includeAppsWithoutVisualizations:false,enableVisualizationPreview:true};const a={includeAppsWithoutVisualizations:e.includeAppsWithoutVisualizations??i.includeAppsWithoutVisualizations,enableVisualizationPreview:e.enableVisualizationPreview??i.enableVisualizationPreview};if(!t.last("/core/spaces/enabled")){return this._getLaunchPageAppData(a).then(function(t){return this._filterGetApps(t,a)}.bind(this)).then(function(t){u.debug("SearchableContent@getApps in classic mode found "+t.length+" apps");return t}).catch(function(t){u.error("SearchableContent@getApps in classic mode failed",t);return Promise.reject(t)})}return this._getPagesAppData(a).then(function(t){return this._filterGetApps(t,a)}.bind(this))};g.prototype._filterGetApps=function(t,e){var i=t;i.forEach(function(t){var e=t.visualizations;var i=[];t.visualizations=[];e.forEach(function(e){var a=JSON.stringify({title:e.title,subtitle:e.subtitle,icon:e.icon,vizType:e.vizType});if(i.indexOf(a)===-1){t.visualizations.push(e);i.push(a)}})});if(!e.includeAppsWithoutVisualizations){i=i.filter(function(t){return t.visualizations.length>0})}p.setPerformanceMark("FLP-Search-FilterApps",{bUseUniqueMark:true});return i};g.prototype._getLaunchPageAppData=function(t){return e.getServiceAsync("FlpLaunchPage").then(function(t){this._oLaunchPageService=t;return this._collectLaunchPageTiles()}.bind(this)).then(function(t){var e=t[0];var i=t[1];var a=e.concat(i);return Promise.all(a.map(function(t){var i=e.includes(t);var a={tileId:null,tile:t};var n;try{if(i){a.tileId=this._oLaunchPageService.getCatalogTileId(t)}else{a.tileId=this._oLaunchPageService.getTileId(t)}n=this._oLaunchPageService.getCatalogTilePreviewTitle(t)}catch(t){u.error("Could not get search data from tile "+a.tileId,t)}if(!n){return new Promise(function(e,a){if(i){this._oLaunchPageService.getCatalogTileViewControl(t).done(e).fail(a)}else{this._oLaunchPageService.getTileView(t).done(e).fail(a)}}.bind(this)).then(function(t){a.view=t;return a}).catch(function(t){u.error("Could not get search data from tile "+a.tileId,t);return a})}return Promise.resolve(a)}.bind(this)))}.bind(this)).then(function(e){var i={};var a=e.map(function(e){try{return this._buildVizDataFromLaunchPageTile(e.tile,t)}catch(t){u.error("Could not get search data from tile "+e.tileId,t);return null}}.bind(this)).filter(function(t){return t});e.forEach(function(t){var e=t.view;if(e){if(!e.destroy){u.error("The tile with id '"+t.tileId+"' does not implement mandatory function destroy")}else{e.destroy()}}});a.forEach(function(t){var e=t.targetURL;if(e){if(i[e]){i[e].visualizations.push(t)}else{i[e]=this._buildAppDataFromViz(t)}}}.bind(this));return o(i)}.bind(this))};g.prototype._collectLaunchPageTiles=function(){var t=this._oLaunchPageService.getGroups().then(function(t){return t.reduce(function(t,e){return Promise.all([t,this._oLaunchPageService.getGroupTilesForSearch(e)]).then(function(t){var e=t[0];var i=t[1];return e.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));var e=this._oLaunchPageService.getCatalogs().then(function(t){return t.reduce(function(t,e){return Promise.all([t,this._oLaunchPageService.getCatalogTiles(e)]).then(function(t){var e=t[0];var i=t[1];return e.concat(i)})}.bind(this),Promise.resolve([]))}.bind(this));return Promise.all([e,t])};g.prototype._getPagesAppData=async function(t){const i=await e.getServiceAsync("CommonDataModel");const[a,n,r,s,l]=await Promise.all([i.getAllPages({personalizedPages:true}),i.getApplications(),i.getVisualizations(),i.getVizTypes(),e.getServiceAsync("ClientSideTargetResolution")]);const u={applications:n,visualizations:r,vizTypes:s};const c={};await this._applyCdmVisualizations(u,c,t);await this._applyCdmPages(u,a,c,t);await this._filterAppDataByIntent(c,l);this._applyCdmApplications(u,c,t);return o(c)};g.prototype._filterAppDataByIntent=function(t,e){var i=Object.keys(t).map(function(t){return c.isIntentUrlAsync(t).then(function(e){return e?t:null})});return Promise.all(i).then(function(i){var a=i.filter(function(t){return!!t});if(a.length===0){return}var n=500;var r=0;var o=n;var s=[];while(r<a.length){s.push(a.slice(r,o));r=r+n;o=o+n}return s.reduce(function(i,a){return i.then(function(t){p.setPerformanceMark("FLP-Search-IntentPackageStart");return e.isIntentSupported(t)}.bind(null,a)).then(function(e){Object.keys(e).forEach(function(i){if(!e[i].supported&&t[i]){delete t[i]}})}).catch(function(){})},Promise.resolve())})};g.prototype._applyCdmApplications=function(t,e,a){var n={};Object.keys(e).forEach(function(a){try{var n=e[a].visualizations;var r=n.find(function(t){return t.target.appId&&t.target.inboundId});if(r){var o=t.applications[r.target.appId];var s=i.getInbound(o,r.target.inboundId);e[a]=this._buildAppDataFromAppAndInbound(o,s);e[a].visualizations=n;e[a].target=n[0].target}else{e[a]=this._buildAppDataFromViz(n[0]);e[a].visualizations=n;e[a].target=n[0].target}}catch(t){u.error("Could not get search data from application "+a,t)}}.bind(this));if(a.includeAppsWithoutVisualizations){o(e).forEach(function(t){n[t.id]=t});o(t.applications).forEach(function(t){var a=i.getId(t);var r=o(i.getInbounds(t));var s=r.length>0?r[0]:undefined;if(!n.hasOwnProperty(a)){e[a]=this._buildAppDataFromAppAndInbound(t,s,true)}}.bind(this))}};g.prototype._applyCdmVisualizations=async function(t,e,i){for(const a in t.visualizations){try{const r={vizId:a,displayFormatHint:h.Standard};const o=await n.getVizData(t,r);const s=o.targetURL;if(i.enableVisualizationPreview){this._changeVizType(o);o.preview=true}if(s){if(e[s]){e[s].visualizations.push(o)}else{e[s]={visualizations:[o]}}}}catch(t){u.error("Could not get search data from visualization "+a,t)}}};g.prototype._applyCdmPages=async function(t,e,i,r){for(const o of e){const e=a.getVisualizationReferences(o);for(let a of e){try{if(a.displayFormatHint&&a.displayFormatHint!==h.Standard){a=Object.assign({},a);a.displayFormatHint=h.Standard}const e=await n.getVizData(t,a);const o=e.targetURL;if(r.enableVisualizationPreview){this._changeVizType(e);e.preview=true}if(o){if(i[o]){i[o].visualizations.push(e)}else{i[o]={visualizations:[e]}}}}catch(t){u.error("Could not get search data from vizReference "+a.id,t)}}}};g.prototype._changeVizType=function(t){if(t._instantiationData.platform==="CDM"&&!l.isStandardVizType(t.vizType)){t.vizType="sap.ushell.StaticAppLauncher";t._instantiationData.vizType={"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}};g.prototype._buildAppDataFromAppAndInbound=function(t,e,a){e=e||{};var n=i.getId(t);var o={id:n,title:e.title||i.getTitle(t),subtitle:e.subTitle||i.getSubTitle(t),icon:e.icon||i.getIcon(t),info:e.info||i.getInfo(t),keywords:e.keywords||i.getKeywords(t),technicalAttributes:i.getTechnicalAttributes(t),visualizations:[]};var s;if(a){s=r.toHashFromInbound(e,n);if(s){o.targetURL="#"+s}}return o};g.prototype._buildAppDataFromViz=function(t){return{id:t.vizId,title:t.title,subtitle:t.subtitle,icon:t.icon,info:t.info,keywords:t.keywords,technicalAttributes:t.technicalAttributes,target:t.target,visualizations:[t]}};g.prototype._buildVizDataFromLaunchPageTile=function(t,e){var i;if(this._oLaunchPageService.getCatalogTileTargetURL(t)&&this._oLaunchPageService.isTileIntentSupported(t)){i={id:this._oLaunchPageService.getTileId(t)||this._oLaunchPageService.getCatalogTileId(t),vizId:this._oLaunchPageService.getCatalogTileId(t)||this._oLaunchPageService.getTileId(t)||"",vizType:"",title:this._oLaunchPageService.getCatalogTilePreviewTitle(t)||this._oLaunchPageService.getCatalogTileTitle(t)||this._oLaunchPageService.getTileTitle(t)||"",subtitle:this._oLaunchPageService.getCatalogTilePreviewSubtitle(t)||"",icon:this._oLaunchPageService.getCatalogTilePreviewIcon(t)||"sap-icon://business-objects-experience",info:this._oLaunchPageService.getCatalogTilePreviewInfo(t)||"",keywords:this._oLaunchPageService.getCatalogTileKeywords(t)||[],technicalAttributes:this._oLaunchPageService.getCatalogTileTechnicalAttributes(t)||[],target:{type:"URL",url:this._oLaunchPageService.getCatalogTileTargetURL(t)},targetURL:this._oLaunchPageService.getCatalogTileTargetURL(t)};i._instantiationData={platform:"LAUNCHPAGE",launchPageTile:t};if(t.getContract){t.getContract("preview").setEnabled(e.enableVisualizationPreview)}if(e.enableVisualizationPreview){if(!t.getChip){i._instantiationData={platform:"CDM",vizType:{"sap.ui5":{componentName:"sap.ushell.components.tiles.cdm.applauncher"}}}}}}return i};g.hasNoAdapter=true;return g},true);
//# sourceMappingURL=SearchableContent.js.map