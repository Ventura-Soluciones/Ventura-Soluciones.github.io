// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/ui/core/EventBus","sap/ushell/utils/Deferred","sap/ui/core/ws/SapPcpWebSocket","sap/ui/model/json/JSONModel","sap/ui/thirdparty/datajs","sap/ushell/utils","sap/ushell/Container"],function(e,t,i,s,n,o,a,r,c){"use strict";const u="/sap/bc/apc/iwngw/notification_push_apc";const f=60;function l(l,d,h){this.Priority={LOW:"LOW",MEDIUM:"MEDIUM",HIGH:"HIGH"};this.Nature={POSITIVE:"POSITIVE",NEGATIVE:"NEGATIVE",NEUTRAL:"NEUTRAL"};const g=new o;const p=h&&h.config;const N={getNotifications:{},getNotificationsByType:{},getNotificationsInGroup:{},getBadgeNumber:{},resetBadgeNumber:{},getNotificationTypesSettings:{},getNotificationsGroupHeaders:{},getMobileSupportSettings:{},getEmailSupportSettings:{},getWebSocketValidity:{},getNotificationCount:{}};const _=[];const S=[];const T=5e3;const I=6e3;const v={NOTIFICATIONS:0,NOTIFICATIONS_BY_TYPE:1,GET_BADGE_NUMBER:2,RESET_BADGE_NUMBER:3,GET_SETTINGS:4,GET_MOBILE_SUPPORT_SETTINGS:5,NOTIFICATIONS_GROUP_HEADERS:6,NOTIFICATIONS_IN_GROUP:7,GET_NOTIFICATIONS_COUNT:8,VALIDATE_WEBSOCKET_CHANNEL:9,GET_EMAIL_SUPPORT_SETTINGS:10,NOTIFICATIONS_BY_DATE_DESCENDING:"notificationsByDateDescending",NOTIFICATIONS_BY_PRIORITY_DESCENDING:"notificationsByPriorityDescending",NOTIFICATIONS_BY_TYPE_DESCENDING:"notificationsByTypeDescending"};const m={PACKAGED_APP:0,FIORI_CLIENT:1,WEB_SOCKET:2,POLLING:3};const b=new s;const C=new s;const y=b.promise();const P={};const E=10;let R=new Date;let O;let D;let A;let B;let U;let k=false;let w=[];let G=false;let F=false;let q=true;let M="fetch";let L;let H=false;let V;let W=false;let X=true;let x;let z;let $=false;let J=false;let j=false;let Y=[];let K;this.isEnabled=function(){if(!p.enabled||!p.serviceUrl){q=false;if(p.enabled&&!p.serviceUrl){e.warning("No serviceUrl was found in the service configuration")}}else{q=true}return q};this.init=function(){if(!G&&this.isEnabled()){i.getInstance().subscribe("launchpad","sessionTimeout",this.destroy,this);K=this.fireInitialRequest();this.lastNotificationDate=new Date;this._setWorkingMode();G=true;this.bUpdateDependencyInitiatorExists=false;this._userSettingInitialization()}i.getInstance().subscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this.fireInitialRequest=async function(){return new Promise(e=>{const t={requestUri:p.serviceUrl+"/GetBadgeNumber()",headers:{"X-CSRF-Token":M}};a.request(t,t=>{if(t.response){this._updateCSRF(t.response)}e()},t=>{if(t.response){this._updateCSRF(t.response)}e()})})};this.fireODataRequest=async function(e){await K;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=M}a.request.apply(this,arguments)};this.fireODataRead=async function(e){await K;if(e.headers&&e.headers["X-CSRF-Token"]){e.headers["X-CSRF-Token"]=M}a.read.apply(this,arguments)};this._onSetConnectionToServer=function(e,t,i){if(i.active){this._resumeConnection()}else{this._closeConnection()}};this.getUnseenNotificationsCount=function(){return Promise.resolve(g.getProperty("/UnseenCount"))};this.getNotificationsCount=function(){return g.getProperty("/NotificationsCount")||"0"};this._createRequest=function(e){const i={"Accept-Language":t.getLanguageTag().toString(),"X-CSRF-Token":this._getHeaderXcsrfToken()||"fetch"};return{requestUri:e,headers:i}};this.getNotificationsByTypeWithGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_BY_TYPE));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");s(t)}})})};this.getNotificationsGroupHeaders=function(){const t=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_GROUP_HEADERS));return new Promise((i,s)=>{this.fireODataRequest(t,i,t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData executeAction failed: ",t,"sap.ushell.services.NotificationsV2");s()}})})};this.getNotificationsBufferInGroup=function(t,i,s){if($===true){const e=P[v.NOTIFICATIONS_IN_GROUP].slice(i,i+s);const t=JSON.stringify({"@odata.context":"$metadata#Notifications",value:e});return new Promise(e=>{window.setTimeout(()=>e(t),1e3)})}const n=this;const o={group:t,skip:i,top:s};const a=this._createRequest(this._getRequestURI(v.NOTIFICATIONS_IN_GROUP,o));return new Promise((t,i)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);t(e.value)},s=>{if(s.response&&s.response.statusCode===200&&s.response.body){n._updateCSRF(s.response);t(JSON.parse(s.response.body).value)}else{e.error("Notification service - oData executeAction failed: ",s,"sap.ushell.services.NotificationsV2");i()}})})};this.getNotificationsBufferBySortingType=function(t,i,s){if($===true){const e=JSON.stringify({"@odata.context":"$metadata#Notifications",value:P[t].slice(i,i+s)});return new Promise(t=>window.setTimeout(()=>t(e),1e3))}const n=this;const o={skip:i,top:s};const a=this._createRequest(this._getRequestURI(t,o));return new Promise((o,r)=>{this.fireODataRequest(a,e=>{n._updateCSRF(e.response);o(e.value)},a=>{if(a.response&&a.response.statusCode===200&&a.response.body){n._updateCSRF(a.response);var c=this._parseJSON(a.response.body);if(c){o(c.value)}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");r()}}else if(n._csrfTokenInvalid(a)&&J===false){n._invalidCsrfTokenRecovery(o,r,n.getNotificationsBufferBySortingType,[t,i,s])}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");r()}})})};this.getNotifications=function(){if(V===m.FIORI_CLIENT||V===m.PACKAGED_APP){return this._readNotificationsData(false).then(()=>g.getProperty("/Notifications"))}return Promise.resolve(g.getProperty("/Notifications"))};this.executeBulkAction=function(e,t){return new Promise((i,s)=>{this.sendBulkAction(e,t).then(e=>{const t=[];const n=[];e.forEach(e=>{const i=e.NotificationId;if(e.Success){t.push(i)}else{n.push(i)}});const o={succededNotifications:t,failedNotifications:n};if(n.length){s(o)}else{i(o)}})})};this.dismissBulkNotifications=function(e){return this.sendBulkDismiss(e)};this.executeAction=function(t,i){const s=this;const n=p.serviceUrl+"/ExecuteAction";const o={NotificationId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{const t={isSucessfull:true,message:""};if(e&&e.response&&e.response.statusCode===200&&e.response.body){const i=JSON.parse(e.response.body);t.isSucessfull=i.Success;t.message=i.MessageText}n(t)},a=>{const r={isSucessfull:false,message:""};if(a.response&&a.response.statusCode===200&&a.response.body){const e=JSON.parse(a.response.body);r.isSucessfull=e.Success;r.message=e.MessageText;n(r)}else if(s._csrfTokenInvalid(a)&&J===false){s._invalidCsrfTokenRecovery(n,o,s.executeAction,[t,i])}else{e.error("Notification service - oData executeAction failed: ",a,"sap.ushell.services.NotificationsV2");o(a)}})})};this.sendBulkAction=function(t,i){const s=this;const n=p.serviceUrl+"/BulkActionByHeader";const o={ParentId:t,ActionId:i};const a={requestUri:n,method:"POST",data:o,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};return new Promise((n,o)=>{this.fireODataRequest(a,e=>{let t;if(e&&e.response&&e.response.statusCode===200&&e.response.body){let i=JSON.parse(e.response.body);t=i.value}n(t)},a=>{if(a.response&&a.response.statusCode===200&&a.response.body){let e=JSON.parse(a.response.body);let t=e.value;n(t)}else if(s._csrfTokenInvalid(a)&&J===false){s._invalidCsrfTokenRecovery(n,o,s.sendBulkAction,[t,i])}else{e.error("Notification service - oData executeBulkAction failed: ",a.message,"sap.ushell.services.NotificationsV2");o()}})})};this.sendBulkDismiss=function(t){const i=this;const s=p.serviceUrl+"/DismissAll";const n={ParentId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(o.response&&o.response.statusCode===200){s()}else if(i._csrfTokenInvalid(o)&&J===false){i._invalidCsrfTokenRecovery(s,n,i.sendBulkDismiss,[t])}else{const t=o?o.message:"";e.error("Notification service - oData executeBulkAction failed: ",t,"sap.ushell.services.NotificationsV2");n()}})})};this.markRead=function(t){const i=this;const s=p.serviceUrl+"/MarkRead";const n={NotificationId:t};const o={requestUri:s,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};return new Promise((s,n)=>{this.fireODataRequest(o,()=>s(),o=>{if(i._csrfTokenInvalid(o)&&J===false){i._invalidCsrfTokenRecovery(s,n,i.markRead,[t])}else{e.error("Notification service - oData reset badge number failed: ",o,"sap.ushell.services.NotificationsV2");n(o)}})})};this.dismissNotification=function(t){const i=p.serviceUrl+"/Dismiss";const s=this;const n={NotificationId:t};const o={requestUri:i,method:"POST",data:n,headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};return new Promise((i,n)=>{this.fireODataRequest(o,()=>{s._addDismissNotifications(t);i()},o=>{if(s._csrfTokenInvalid(o)&&J===false){s._invalidCsrfTokenRecovery(i,n,s.dismissNotification,[t])}else{e.error("Notification service - oData dismiss notification failed: ",o,"sap.ushell.services.NotificationsV2");n(o)}})})};this.registerNotificationsUpdateCallback=function(e){_.push(e)};this.registerNotificationCountUpdateCallback=function(e){S.push(e)};this.isFirstDataLoaded=function(){return W};this.getUserSettingsFlags=async function(){try{await r.promisify(y)}catch(e){}return{highPriorityBannerEnabled:X}};this.setUserSettingsFlags=function(e){X=e.highPriorityBannerEnabled;this._writeUserSettingsFlagsToPersonalization(e)};this._getNotificationSettingsMobileSupport=function(){return x};this._getDismissNotifications=function(){return Y};this.filterDismisssedItems=function(e,t){return e.filter(e=>!t.some(t=>t===e.originalItemId))};this._addDismissNotifications=function(e){if(Y.indexOf(e)===-1){Y.push(e)}};this._initializeDismissNotifications=function(){Y=[]};this._getNotificationSettingsEmailSupport=function(){return z};this.destroy=function(){F=true;if(D){clearTimeout(D)}else if(A){clearTimeout(A)}else if(B){clearTimeout(B)}if(V===m.WEB_SOCKET&&O){O.close()}i.getInstance().unsubscribe("launchpad","sessionTimeout",this.destroy,this);i.getInstance().unsubscribe("launchpad","setConnectionToServer",this._onSetConnectionToServer,this)};this._readUnseenNotificationsCount=function(){const t=this;const i=this._createRequest(this._getRequestURI(v.GET_BADGE_NUMBER));return new Promise((s,n)=>{this.fireODataRead(i,(e,i)=>{g.setProperty("/UnseenCount",i.data.GetBadgeNumber.Number);t._setNativeIconBadge(i.data.GetBadgeNumber.Number);s(i.data.GetBadgeNumber.Number)},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){const e=JSON.parse(i.response.body);g.setProperty("/UnseenCount",e.value);t._setNativeIconBadge(e.value);s(e.value)}else{e.error("Notification service - oData read unseen notifications count failed: ",i.message,"sap.ushell.services.NotificationsV2");n(i)}})})};this.readNotificationsCount=function(){const t=this._createRequest(this._getRequestURI(v.GET_NOTIFICATIONS_COUNT));return new Promise((i,s)=>{this.fireODataRead(t,(e,t)=>i(t.data),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.value)}else{e.error("Notification service - oData read notifications count failed: ",t.message,"sap.ushell.services.NotificationsV2");s(t)}})})};this._getNotificationSettingsAvailability=function(){return C.promise()};this.notificationsSeen=function(){const t=this;const i={requestUri:this._getRequestURI(v.RESET_BADGE_NUMBER),method:"POST",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};if(this._isFioriClientMode()===true||this._isPackagedMode()===true){this._setNativeIconBadge(0)}return new Promise((s,n)=>{this.fireODataRequest(i,s,function(i){if(t._csrfTokenInvalid(i)){t._invalidCsrfTokenRecovery(s,n,t.notificationsSeen)}else{e.error("Notification service - oData reset badge number failed: ",i,"sap.ushell.services.NotificationsV2");n(i)}})})};this._readNotificationsData=function(e){const t=this;this.readNotificationsCount().then(e=>g.setProperty("/NotificationsCount",e));const i=this._readUnseenNotificationsCount(e).then(()=>{if(e===true){t._updateNotificationsCountConsumers()}});const s=this.getNotificationsBufferBySortingType(v.NOTIFICATIONS_BY_DATE_DESCENDING,0,E).then(i=>{g.setProperty("/Notifications",i);t._notificationAlert(i);if(e===true){t._updateNotificationsConsumers()}});return Promise.all([i,s])};this._getHeaderXcsrfToken=function(){return M};this._getDataServiceVersion=function(){return L};this._getRequestURI=function(e,t){const i=encodeURI(this._getConsumedIntents(e));let s;switch(e){case v.NOTIFICATIONS:if(N.getNotifications.basic===undefined){N.getNotifications.basic=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20false"}if(this._isIntentBasedConsumption()){if(N.getNotifications.byIntents===undefined){N.getNotifications.byIntents=N.getNotifications.basic.concat("&intents%20eq%20"+i)}return N.getNotifications.byIntents}return N.getNotifications.basic;case v.NOTIFICATIONS_BY_TYPE:if(N.getNotificationsByType.basic===undefined){N.getNotificationsByType.basic=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams"}if(this._isIntentBasedConsumption()){if(N.getNotificationsByType.byIntents===undefined){N.getNotificationsByType.byIntents=N.getNotificationsByType.basic.concat("&$filter=intents%20eq%20"+i)}return N.getNotificationsByType.byIntents}return N.getNotificationsByType.basic;case v.NOTIFICATIONS_GROUP_HEADERS:if(N.getNotificationsGroupHeaders.basic===undefined){N.getNotificationsGroupHeaders.basic=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$filter=IsGroupHeader%20eq%20true"}if(this._isIntentBasedConsumption()){if(N.getNotificationsGroupHeaders.byIntents===undefined){N.getNotificationsGroupHeaders.byIntents=N.getNotificationsGroupHeaders.basic.concat("&intents%20eq%20"+i)}return N.getNotificationsGroupHeaders.byIntents}return N.getNotificationsGroupHeaders.basic;case v.NOTIFICATIONS_IN_GROUP:s=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt desc&$filter=IsGroupHeader eq false and ParentId eq "+t.group+"&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;case v.GET_BADGE_NUMBER:if(N.getBadgeNumber.basic===undefined){N.getBadgeNumber.basic=p.serviceUrl+"/GetBadgeNumber()"}if(this._isIntentBasedConsumption()){if(N.getBadgeNumber.byIntents===undefined){N.getBadgeNumber.byIntents=p.serviceUrl+"/GetBadgeCountByIntent("+i+")"}return N.getBadgeNumber.byIntents}return N.getBadgeNumber.basic;case v.GET_NOTIFICATIONS_COUNT:if(N.getNotificationCount.basic===undefined){N.getNotificationCount.basic=p.serviceUrl+"/Notifications/$count"}return N.getNotificationCount.basic;case v.RESET_BADGE_NUMBER:if(N.resetBadgeNumber.basic===undefined){N.resetBadgeNumber.basic=p.serviceUrl+"/ResetBadgeNumber"}return N.resetBadgeNumber.basic;case v.GET_SETTINGS:if(N.getNotificationTypesSettings.basic===undefined){N.getNotificationTypesSettings.basic=p.serviceUrl+"/NotificationTypePersonalizationSet"}return N.getNotificationTypesSettings.basic;case v.GET_MOBILE_SUPPORT_SETTINGS:if(N.getMobileSupportSettings.basic===undefined){N.getMobileSupportSettings.basic=p.serviceUrl+"/Channels(ChannelId='SAP_SMP')"}return N.getMobileSupportSettings.basic;case v.GET_EMAIL_SUPPORT_SETTINGS:if(N.getEmailSupportSettings.basic===undefined){N.getEmailSupportSettings.basic=p.serviceUrl+"/Channels(ChannelId='SAP_EMAIL')"}return N.getEmailSupportSettings.basic;case v.VALIDATE_WEBSOCKET_CHANNEL:if(N.getWebSocketValidity.basic===undefined){N.getWebSocketValidity.basic=p.serviceUrl+"/Channels('SAP_WEBSOCKET')"}return N.getWebSocketValidity.basic;case v.NOTIFICATIONS_BY_DATE_DESCENDING:s=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=CreatedAt%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;case v.NOTIFICATIONS_BY_PRIORITY_DESCENDING:s=p.serviceUrl+"/Notifications?$expand=Actions,NavigationTargetParams&$orderby=Priority%20desc&$filter=IsGroupHeader%20eq%20false&$skip="+t.skip+"&$top="+t.top;if(this._isIntentBasedConsumption()===true){s=s.concat("&intents%20eq%20"+i)}break;default:s=""}return s};this.readSettings=function(){const t=this._createRequest(this._getRequestURI(v.GET_SETTINGS));return new Promise((i,s)=>{this.fireODataRequest(t,e=>i(e.results),t=>{if(t.response&&t.response.statusCode===200&&t.response.body){i(t.response.body)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");s(t)}})})};this._readMobileSettingsFromServer=function(){return this._readChannelSettingsFromServer(v.GET_MOBILE_SUPPORT_SETTINGS)};this._readEmailSettingsFromServer=function(){return this._readChannelSettingsFromServer(v.GET_EMAIL_SUPPORT_SETTINGS)};this._readChannelSettingsFromServer=function(t){const i=this._getRequestURI(t);const s=this._createRequest(i);let n;let o;return new Promise(t=>{this.fireODataRequest(s,e=>{if(typeof e.results==="string"){n=JSON.parse(e.results);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.results.successStatus=true;t(e.results)}},i=>{if(i.response&&i.response.statusCode===200&&i.response.body){n=JSON.parse(i.response.body);n.successStatus=true;o=JSON.stringify(n);t(o)}else{e.error("Notification service - oData get settings failed: ",i,"sap.ushell.services.NotificationsV2");t(JSON.stringify({successStatus:false}))}})})};this._checkWebSocketActivity=function(){const t=this._createRequest(this._getRequestURI(v.VALIDATE_WEBSOCKET_CHANNEL));return new Promise(i=>{this.fireODataRequest(t,e=>{if(typeof e.results==="string"){const t=JSON.parse(e.results);i(t.IsActive)}else{i(false)}},t=>{if(t.response&&t.response.statusCode===200&&t.response.body){const e=JSON.parse(t.response.body);i(e.IsActive)}else{e.error("Notification service - oData get settings failed: ",t,"sap.ushell.services.NotificationsV2");i(false)}})})};this.saveSettingsEntry=function(t){const i=this;const s=this._getRequestURI(v.GET_SETTINGS)+"(NotificationTypeId="+t.NotificationTypeId+")";const n={requestUri:s,method:"PUT",headers:{"X-Requested-With":"XMLHttpRequest","Content-Type":"application/json",DataServiceVersion:L,"X-CSRF-Token":M}};n.data=JSON.parse(JSON.stringify(t));n.data["@odata.context"]="$metadata#NotificationTypePersonalizationSet/$entity";return new Promise((s,o)=>{this.fireODataRequest(n,s,n=>{if(n.response&&n.response.statusCode===200&&n.response.body){s(n.response.body)}else if(i._csrfTokenInvalid(n)&&J===false){i._invalidCsrfTokenRecovery(s,o,i.saveSettingsEntry,[t])}else{e.error("Notification service - oData set settings entry failed: ",n,"sap.ushell.services.NotificationsV2");o(n)}})})};this._updateNotificationsConsumers=function(){_.forEach(e=>e())};this._updateNotificationsCountConsumers=function(){S.forEach(e=>e())};this._updateAllConsumers=function(){this._updateNotificationsConsumers();this._updateNotificationsCountConsumers()};this._getModel=function(){return g};this._getMode=function(){return V};this._setWorkingMode=function(){let e;if(p.intentBasedConsumption===true){w=this._getIntentsFromConfiguration(p.consumedIntents);if(w.length>0){k=true}}if(this._isPackagedMode()){V=m.PACKAGED_APP;e=this._getIntentsFromConfiguration(window.fiori_client_appConfig.applications);if(e.length>0){w=e}if(w.length>0){k=true}this._registerForPush();this._readNotificationsData(true);this._setNativeIconBadgeWithDelay();return}this._performFirstRead()};this._performFirstRead=function(){const t=this;this._readNotificationsData(true).then(()=>{const e=t._getFioriClientRemainingDelay();if(e<=0){t._fioriClientStep()}else{D=setTimeout(function(){t._fioriClientStep()},e)}W=true}).catch(t=>{e.error("Notifications oData read failed. Error: "+t)})};this._fioriClientStep=function(){if(this._isFioriClientMode()){V=m.FIORI_CLIENT;this._addPushNotificationHandler();this.getUnseenNotificationsCount().then(function(e){this._setNativeIconBadge(e,()=>{})}.bind(this)).catch(()=>{})}else{this._webSocketStep()}};this._webSocketStep=function(){V=m.WEB_SOCKET;this._establishWebSocketConnection()};this._webSocketRecoveryStep=function(){if(H===false){H=true;A=window.setTimeout(this._webSocketStep.bind(this),T)}else{this._activatePollingAfterInterval()}};this._activatePollingAfterInterval=function(){U=p.pollingIntervalInSeconds||f;window.clearTimeout(B);B=window.setTimeout(this._activatePolling.bind(this),r.sanitizeTimeoutDelay(U*1e3))};this._activatePolling=function(){U=p.pollingIntervalInSeconds||f;V=m.POLLING;this._readNotificationsData(true);window.clearTimeout(B);U=window.setTimeout(this._activatePolling.bind(this,U,false),r.sanitizeTimeoutDelay(U*1e3))};this._deactivatePolling=function(){if(V===m.POLLING){window.clearTimeout(U)}};this._formatAsDate=function(e){return new Date(e)};this._notificationAlert=function(e){if(X===false){return}const t=[];let s=0;for(const i in e){if(this.lastNotificationDate&&this._formatAsDate(e[i].CreatedAt)>this.lastNotificationDate){if(e[i].Priority==="HIGH"){t.push(e[i])}}if(s<this._formatAsDate(e[i].CreatedAt)){s=this._formatAsDate(e[i].CreatedAt)}}if(this.lastNotificationDate&&t.length>0){i.getInstance().publish("sap.ushell.services.Notifications","onNewNotifications",t)}this.lastNotificationDate=s};this._getFioriClientRemainingDelay=function(){return I-(new Date-R)};this._establishWebSocketConnection=function(){const t=this;let i=false;try{O=this._getWebSocketObjectObject(p.webSocketUrl||u,[n.SUPPORTED_PROTOCOLS.v10]);O.attachMessage(this,function(e){const i=e.getParameter("pcpFields");if(i&&i.Command&&i.Command==="Notification"){t._readNotificationsData(true)}});O.attachOpen(this,function(){t._checkWebSocketActivity().then(e=>{if(!e){i=true;O.close();t._activatePollingAfterInterval()}});e.info("Notifications UShell service WebSocket: webSocket connection opened")});O.attachClose(this,function(s){e.warning("Notifications UShell service WebSocket: attachClose called with code: "+s.mParameters.code+" and reason: "+s.mParameters.reason);if(!F&&!i){t._webSocketRecoveryStep()}});O.attachError(this,function(){e.warning("Notifications UShell service WebSocket: attachError called!")})}catch(t){e.error("Exception occurred while creating new sap.ui.core.ws.SapPcpWebSocket. Message: "+t.message)}};this._isFioriClientMode=function(){return!(sap.FioriClient===undefined)};this._isPackagedMode=function(){return window.fiori_client_appConfig&&window.fiori_client_appConfig.prepackaged===true};this._setNativeIconBadge=function(e){if(sap.Push&&sap.Push.setBadgeNumber){sap.Push.setBadgeNumber(e,()=>{})}};this._setNativeIconBadgeWithDelay=function(){setTimeout(function(){this.getUnseenNotificationsCount().then(function(e){this._setNativeIconBadge(e)}.bind(this)).catch(()=>{})}.bind(this),4e3)};this._getIntentsFromConfiguration=function(e){const t=[];if(e&&e.length>0){let i;for(let s=0;s<e.length;s++){i=e[s].intent;t.push(i)}}return t};this._handlePushedNotification=function(e){let t;let i;let s;let n=[];if(e!==undefined){if(e.additionalData===undefined||e.additionalData.foreground===true){this._readNotificationsData(true)}else{if(e.additionalData&&e.additionalData.NavigationTargetObject){t=e.additionalData.NavigationTargetObject}else{t=e.NavigationTargetObject}if(e.additionalData&&e.additionalData.NavigationTargetAction){i=e.additionalData.NavigationTargetAction}else{i=e.NavigationTargetAction}if(e.additionalData&&e.additionalData.NavigationTargetParam){s=e.additionalData.NavigationTargetParam}else{s=e.NavigationTargetParam}if(s){if(typeof s==="string"||s instanceof String){n[0]=s}else if(Array.isArray(s)===true){n=s}}const o=e.NotificationId;if(t&&i){r.toExternalWithParameters(t,i,n)}this.markRead(o);this._readNotificationsData(true)}}};this._registerForPush=function(){if(sap.Push){sap.Push.initPush(this._handlePushedNotification.bind(this))}};this._addPushNotificationHandler=function(){document.addEventListener("deviceready",this._registerForPush.bind(this),false)};this._isIntentBasedConsumption=function(){return k};this._getConsumedIntents=function(e){let t="";if(!this._isIntentBasedConsumption()){return t}if(w.length>0){if(e!==v.GET_BADGE_NUMBER){t="&"}for(let i=0;i<w.length;i++){if(e===v.GET_BADGE_NUMBER){if(i===0){t=w[i]}else{t=t+","+w[i]}}else{t=t+"NavigationIntent%20eq%20%27"+w[i]+"%27"}}}return t};this._revalidateCsrfToken=function(){M="fetch";j=false;return this.getNotificationsBufferBySortingType(v.NOTIFICATIONS_BY_DATE_DESCENDING,0,1)};this._csrfTokenInvalid=function(e){const t=e.response;const i=t&&t.statusCode===403;const s=t&&t.headers["x-csrf-token"]||"";const n=s.toLowerCase()==="required";return i&&n};this._invalidCsrfTokenRecovery=function(t,i,s,n){const o=this;J=true;this._revalidateCsrfToken().then(()=>{s.apply(o,n).then(t).catch(e=>{if(e.response&&e.response.statusCode===200&&e.response.body){t(e.response.body)}else{i(e)}}).finally(()=>{J=false})}).catch(t=>{J=false;e.error("Notification service - oData markRead failed: ",t.message,"sap.ushell.services.NotificationsV2");i(t)})};this._getWebSocketObjectObject=function(e,t){return new n(e,t)};this.getOperationEnum=function(){return v};this._readUserSettingsFlagsFromPersonalization=function(){const t=this;this._getUserSettingsPersonalizer().then(i=>{i.getPersData().then(e=>{if(e===undefined){t._writeUserSettingsFlagsToPersonalization({highPriorityBannerEnabled:X})}else{X=e.highPriorityBannerEnabled}b.resolve()}).catch(()=>{e.error("Reading User Settings flags from Personalization service failed");b.reject()})}).catch(t=>{e.error("Personalization service does not work:");e.error(t.name+": "+t.message);e.error("Reading User Settings flags from Personalization service failed")})};this._writeUserSettingsFlagsToPersonalization=function(t){return this._getUserSettingsPersonalizer().then(e=>e.setPersData(t)).catch(t=>{e.error("Personalization service does not work:");e.error(t.name+": "+t.message)})};this._getUserSettingsPersonalizer=function(){if(!this.oUserSettingsPersonalizerPromise){this.oUserSettingsPersonalizerPromise=c.getServiceAsync("PersonalizationV2").then(e=>{const t={keyCategory:e.KeyCategory.FIXED_KEY,writeFrequency:e.WriteFrequency.LOW,clientStorageAllowed:true};const i={container:"sap.ushell.services.Notifications",item:"userSettingsData"};return e.getPersonalizer(i,t)})}return this.oUserSettingsPersonalizerPromise};this._updateCSRF=function(e){if(j===true||e.headers===undefined){return}if(this._getHeaderXcsrfToken()==="fetch"){M=e.headers["x-csrf-token"]||e.headers["X-CSRF-Token"]||e.headers["X-Csrf-Token"]||"fetch"}if(!this._getDataServiceVersion()){L=e.headers.DataServiceVersion||e.headers["odata-version"]}j=true};this._userSettingInitialization=function(){if(this._bSettingsInitialized){return}this._bSettingsInitialized=true;const t={settingsAvailable:false,mobileAvailable:false,emailAvailable:false};this._readUserSettingsFlagsFromPersonalization();const i=this.readSettings();const s=this._readMobileSettingsFromServer();const n=this._readEmailSettingsFromServer();const o=[i,s,n];i.then(()=>{t.settingsAvailable=true}).catch(()=>{e.warning("User settings for the Notification service are not available.");C.promise().catch(()=>{});C.reject()});s.then(e=>{const i=JSON.parse(e);if(i.successStatus){x=e?i.IsActive:false;t.mobileAvailable=x}else{x=false;t.mobileAvailable=false}}).catch(()=>{e.warning("Mobile settings for the Notification service are not available.");x=false;t.mobileAvailable=false});n.then(e=>{const i=JSON.parse(e);if(i.successStatus){z=e?i.IsActive:false;t.emailAvailable=z}else{z=false;t.emailAvailable=false}}).catch(()=>{e.warning("Email settings for the Notification service are not available.");z=false;t.emailAvailable=false});Promise.all(o).then(()=>{C.resolve(t)}).catch(()=>e.warning("Settings for the Notification service are not loaded completely."))};this._closeConnection=function(){if(!F){if(V===m.WEB_SOCKET&&O){O.close();F=true}if(V===m.POLLING&&B){window.clearTimeout(B);F=true}}};this._resumeConnection=function(){if(F){F=false;this._webSocketStep()}};this._parseJSON=function(e){try{return JSON.parse(e)}catch(e){this._deactivatePolling();return false}}}l.hasNoAdapter=true;return l},true);
//# sourceMappingURL=NotificationsV2.js.map