// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/fe/navigation/SelectionVariant","sap/ushell/utils","sap/ushell/Container"],function(e,t,r,a,n){"use strict";var i="sap.ushell.services.ClientSideTargetResolution.PrelaunchOperations";async function s(e){if(!e){return null}return n.getServiceAsync("AppState").then(function(t){return new Promise(function(r,a){t.getAppState(e).done(function(e){r(e)}).fail(function(e){a(e)})})})}async function o(e,t,r,i,s){if(e.startupParametersModified){t.mappedIntentParamsPlusSimpleDefaults=i}if(e.defaultedParameterNamesModified){t.mappedDefaultedParamNames=s}if(e.selectionVariantModified){const e=await n.getServiceAsync("AppState");var o=e.createEmptyAppState(undefined,true);o.setData({selectionVariant:r.toJSONObject()});await a.promisify(o.save());t.mappedIntentParamsPlusSimpleDefaults["sap-xapp-state"]=[o.getKey()]}return Promise.resolve(t)}function l(e){var t=e.type;switch(t){case"merge":case"split":return t+" - source: "+e.source+" & target: "+e.target;case"delete":return t+" - target: "+e.target;default:return""}}function u(e,t){if(t.getSelectOption(e)){return t.getSelectOption(e)[0].Low}return undefined}function f(e,t){if(t.getSelectOption(e)){return t.getSelectOption(e)[0].High}return undefined}function d(e,t){if(t[e]){return t[e][0]}return undefined}function p(e,t,r){var a=e.source[0],n=e.source[1],i=u(a,t),s=u(n,t),o=d(a,r),l=d(n,r),f,p,c=e.target;function m(e,t){if(t===undefined||e===t){return e}return undefined}if(i&&s){f=m(i,o);p=m(s,l)}else if(o&&l){f=m(o,i);p=m(l,s)}if(f&&p&&!t.getSelectOption(c)&&!r.hasOwnProperty(c)){t.addSelectOption(c,"I","BT",f,p);return{selectionVariantModified:true,startupParametersModified:false,defaultedParameterNamesModified:false}}return{}}function c(t,r,a){var n=t.target,i=t.source;if(!r.getSelectOption(i)){e.error("Invalid split operation: "+i+" does not exist in selection variant");return false}if(r.getSelectOption(n[0])){e.error("Invalid split operation: "+n[0]+" already exists in selection variant");return false}if(r.getSelectOption(n[1])){e.error("Invalid split operation: "+n[1]+" already exists in selection variant");return false}if(a[n[0]]){e.error("Invalid split operation: "+n[0]+" already exists in startup parameters");return false}if(a[n[1]]){e.error("Invalid split operation: "+n[1]+" already exists in startup parameters");return false}return true}function m(e,t,r){var a=e.target,n=e.source,i=c(e,t,r);if(i){var s=u(n,t),o=f(n,t);t.addSelectOption(a[0],"I","EQ",s,null);r[a[0]]=[s];t.addSelectOption(a[1],"I","EQ",o||s,null);r[a[1]]=[o||s];return{selectionVariantModified:true,startupParametersModified:true,defaultedParameterNamesModified:false}}return{}}function g(t,r,a,n){var i=t.target,s={selectionVariantModified:false,startupParametersModified:false,defaultedParameterNamesModified:false};for(var o=0;o<i.length;o++){var l=i[o];if(l==="sap-xapp-state"){e.warning("Cannot execute delete: 'sap-xapp-state' is not allowed to be deleted");continue}if(r.getParameter(l)){r.removeParameter(l);s.selectionVariantModified=true}if(r.getSelectOption(l)){r.removeSelectOption(l);s.selectionVariantModified=true}if(a[l]){delete a[l];s.startupParametersModified=true}var u=n.indexOf(l);if(u>-1){n.splice(u,1);s.defaultedParameterNamesModified=true}}return s}function v(t){var r;if(t===""){return[]}t=t.replaceAll("“",'"');t=t.replaceAll("”",'"');try{r=JSON.parse(t)}catch(t){e.error("Cannot parse operation array: sap-prelaunch-operations should be in json format.");return[]}if(!Array.isArray(r)){e.error("Invalid operation array: sap-prelaunch-operations should be an array.");return[]}return r}function y(t){if(t.length===0){return null}var r={split:true,merge:true,delete:true};var a=t.filter(function(e){return!r[e.type]});if(a.length>0){e.error("Invalid operation: the following sap-prelaunch-operations are invalid: "+a.join(", "));return null}var n=t.some(function(e){return e.type==="split"&&e.target[0]===e.target[1]});if(n){e.error("Invalid operation: split operation contains the same target value. Use two different target values instead.");return null}var i=t.some(function(e){if(e.type==="split"){return!e.hasOwnProperty("source")||!e.hasOwnProperty("target")||typeof e.source!=="string"||!Array.isArray(e.target)||Object.keys(e).length!==3||Object.keys(e.target).length!==2}if(e.type==="merge"){return!e.hasOwnProperty("source")||!e.hasOwnProperty("target")||typeof e.target!=="string"||!Array.isArray(e.source)||Object.keys(e).length!==3||Object.keys(e.source).length!==2}if(e.type==="delete"){return!e.hasOwnProperty("target")||!Array.isArray(e.target)||Object.keys(e).length!==2}});if(i){e.error("Invalid operation: one or more operations are specified in an incorrect format.");return null}return t}function P(e){var t=v(e);return y(t)}function h(t,r,a,n){var s=e.getLevel()>=e.Level.DEBUG?[]:null,o={selectionVariantModified:false,startupParametersModified:false};r.forEach(function(r){var i={};switch(r.type){case"split":i=m(r,t,a);break;case"merge":i=p(r,t,a);break;case"delete":i=g(r,t,a,n);break;default:e.error("Invalid operation: "+r.type+" prelaunch operation type is not supported")}if(s){var u=Object.keys(i).length!==0?"✅":"❌";s.push(u+" "+l(r))}if(Object.keys(i).length===0){e.warning("Cannot execute "+l(r))}o.selectionVariantModified=o.selectionVariantModified||i.selectionVariantModified;o.startupParametersModified=o.startupParametersModified||i.startupParametersModified;o.defaultedParameterNamesModified=o.defaultedParameterNamesModified||i.defaultedParameterNamesModified});if(s){e.debug(i+"\n"+s.join("\n"))}return o}function O(e,a){if(!a){return Promise.resolve(e)}var n=e.mappedIntentParamsPlusSimpleDefaults,i=e.mappedDefaultedParamNames,l=n["sap-xapp-state"]&&n["sap-xapp-state"][0],u=P(a);if(!u||u.length===0){return Promise.resolve(e)}return s(l).then(function(a){var s=a?a.getData():{},l=t({},n),f=t([],i),d;if(s.selectionVariant){d=new r(JSON.stringify(s.selectionVariant))}else{d=new r}var p=h(d,u,l,f);return o(p,e,d,l,f)})}return{executePrelaunchOperations:O,parseAndValidateOperations:P}});
//# sourceMappingURL=PrelaunchOperations.js.map