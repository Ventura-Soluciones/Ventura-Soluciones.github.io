// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ushell/EventHub","sap/base/util/isPlainObject","sap/base/Log","sap/ushell/Config","sap/ui/Device","sap/base/util/fetch"],function(e,t,s,i,r,n){"use strict";var a=32768;var c=2;var o=1;var h="UITracer.trace";function u(e,t,s){this._sServiceUrl=s.serviceUrl||"/bff/ui-trace/v1/trace";this._pToken=null;this._sToken="";this._resetTrace();this._attachBrowserEvents();this._attachEventHubEvents();this._sSpacesPages=i.last("/core/spaces/enabled")?"-spaces":"-groups";this._sSiteType="wz-standard"+this._sSpacesPages;this._sSiteId=new URLSearchParams(window.location.search).get("siteId")||i.last("/core/site/siteId");this._sDeviceType=this._getDeviceType();const r=sap.ui.require("sap/ushell/Container");if(r){this._initialized=r.getFLPPlatform().then(function(e){if(e==="MYHOME"){this._sSiteType="sap-start"+this._sSpacesPages;return}return r.getServiceAsync("CommonDataModel").then(function(e){e.getApplications().then(function(e){if(e.SFHost){this._sSiteType="wz-advancedhr"+this._sSpacesPages}else if(e.WorkzoneHome){this._sSiteType="wz-advanced"+this._sSpacesPages}}.bind(this))}.bind(this))}.bind(this))}else{this._initialized=Promise.resolve()}}u.prototype._getToken=function(){this._pToken=n(this._sServiceUrl).then(function(e){this._sToken="-";return e.json()}.bind(this)).then(function(e){if(e&&e.token){this._sToken=e.token}}.bind(this)).catch(function(){s.debug("UITracer: getToken failed on "+this._sServiceUrl,"","sap.ushell.services.UITracer");this._sToken="-"}.bind(this))};u.prototype.trace=function(e){if(!this._sToken&&!this._pToken){this._getToken()}this._addEntry(e)};u.prototype._getDeviceType=function(){var e="desktop";if(r.system.tablet){e="tablet"}else if(r.system.phone){e="phone"}return"browser-"+e};u.prototype._resetTrace=function(){this._aTrace=[];this._iSize=c};u.prototype._addEntry=function(e){if(t(e)&&Object.keys(e).length>0){try{var i=this._createTraceEntry(e);var r=this._getBlob(i).size+o;if(this._iSize+r>a){this._sendTrace()}this._iSize+=r;this._aTrace.push(i);s.debug("UITracer: Trace entry added with size "+r,JSON.stringify(i),"sap.ushell.services.UITracer");return true}catch(e){return false}}return false};u.prototype._createTraceEntry=function(e){var t=JSON.parse(JSON.stringify(e));var s=t.data||{};s.siteType=this._sSiteType;s.siteId=this._sSiteId;s.deviceType=this._sDeviceType;t._ts=(new Date).toISOString();t.data=s;return t};u.prototype._sendTrace=function(e){if(!this._sToken||this._sToken==="-"){s.debug("UITracer: _sendTrace failed, token "+this._sToken==="-"?"request failed ":"is missing","","sap.ushell.services.UITracer");return}if(this._aTrace.length>0){var t=this._aTrace[this._aTrace.length-1];if(!e&&t.reason==="LaunchApp"&&t.data&&t.data.targetUrl&&t.data.targetUrl.indexOf("#")===0){return}var i=this._getBlob({token:this._sToken,data:this._aTrace});try{window.navigator.sendBeacon(this._sServiceUrl,i);s.debug("UITracer: _sendTrace to "+this._sServiceUrl+"with size "+i.size+" byte, entry count "+this._aTrace.length,"","sap.ushell.services.UITracer")}catch(e){s.debug("UITracer: _sendTrace failed "+this._sServiceUrl+"with size "+i.size+" byte, entry count "+this._aTrace.length,"","sap.ushell.services.UITracer")}}this._resetTrace()};u.prototype._getBlob=function(e){if(t(e)||Array.isArray(e)){e=JSON.stringify(e)}if(typeof e==="string"){return new Blob([e],{type:"application/json"})}return null};u.prototype._attachBrowserEvents=function(){if(document.visibilityState){document.addEventListener("visibilitychange",function(){if(document.visibilityState==="hidden"){this._sendTrace()}}.bind(this))}window.addEventListener("beforeunload",function(){this._sendTrace(true)}.bind(this))};u.prototype._attachEventHubEvents=function(){e.on(h).do(function(e){this.trace(e)}.bind(this))};u.hasNoAdapter=true;return u},true);
//# sourceMappingURL=UITracer.js.map