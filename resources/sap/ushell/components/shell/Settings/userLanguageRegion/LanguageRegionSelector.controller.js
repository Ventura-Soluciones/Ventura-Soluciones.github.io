// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Formatting","sap/ui/core/Locale","sap/ui/core/LocaleData","sap/ui/core/format/DateFormat","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/ushell/Config","sap/ushell/Container"],function(e,t,r,a,n,s,i,g,o,l){"use strict";return s.extend("sap.ushell.components.shell.Settings.userLanguageRegion.LanguageRegionSelector",{onInit:function(){this.oUserInfoServicePromise=l.getServiceAsync("UserInfo");this.oUserInfoServicePromise.then(function(e){this.oUser=l.getUser();var s=new r(t.getLanguageTag());var g=a.getInstance(s);var u,m,d,c,L;var h=l.getRendererInternal("fiori2").getShellConfig().enableSetLanguage||false;var f=this.oUser.isLanguagePersonalized();var P=e.getUserSettingListEditSupported();var p=[];const F=e=>this.oUser.getEditState(e)!==1;const S={preferredLogonLanguage:F("PREFERRED_LOGON_LANGUAGE"),dateFormat:F("DATE_FORMAT"),timeFormat:F("TIME_FORMAT"),numberFormat:F("NUMBER_FORMAT"),timeZone:F("TIME_ZONE")};S.showWarning=Object.values(S).some(e=>e===false);if(P){u=t.getABAPDateFormat();d=t.getABAPTimeFormat();c=this._getABAPNumberFormat();L=this.oUser.getCalendarWeekNumbering?.()||"Default";p.push(this._loadUserSettingList())}else{u=g.getDatePattern("medium");m=g.getTimePattern("medium");d=m.indexOf("H")===-1?"12h":"24h";L="Default"}var T=new i({languageList:null,DateFormatList:null,TimeFormatList:null,NumberFormatList:null,TimeZoneList:null,CalendarWeekNumberingList:null,cuaFlags:S,selectedLanguage:this.oUser.getLanguage(),selectedLanguageText:this.oUser.getLanguageText(),selectedDatePattern:u,selectedTimeFormat:d,selectedNumberFormat:c,selectedTimeZone:this.oUser.getTimeZone(),selectedCalendarWeekNumbering:L,isSettingsLoaded:true,isLanguagePersonalized:f,isEnableSetLanguage:h,isEnableUserProfileSetting:P,isTimeZoneFromServerInUI5:o.last("/core/ui5/timeZoneFromServerInUI5")});T.setSizeLimit(1e3);if(h){p.push(this._loadLanguagesList())}if(p.length>0){this.getView().setBusy(true);return Promise.all(p).then(function(t){var r=P?t[0]:null;var a=null;if(h){a=t.length===1?t[0]:t[1]}if(a?.length>1){T.setProperty("/languageList",a);var s=a.some(function(e){return e.key==="default"});if(!f&&s){T.setProperty("/selectedLanguage","default")}}if(r?.TIME_FORMAT?.length>0){T.setProperty("/TimeFormatList",r.TIME_FORMAT)}if(r?.DATE_FORMAT?.length>0){T.setProperty("/DateFormatList",r.DATE_FORMAT)}if(r?.TIME_ZONE?.length>0){var i=n.getDateTimeWithTimezoneInstance({showDate:false,showTime:false});var g=r.TIME_ZONE.map(function(e){var t=i.format(null,e.description)||e.description;return{description:t,value:e.value}});T.setProperty("/TimeZoneList",g)}if(r?.NUMBER_FORMAT?.length>0){T.setProperty("/NumberFormatList",r.NUMBER_FORMAT)}if(r?.CALENDAR_WEEK_NUMBERING){var o=e.getCalendarWeekNumberingList().map(e=>{e.selected=e.value===T.getProperty("/selectedCalendarWeekNumbering");return e});T.setProperty("/CalendarWeekNumberingList",o)}this.oView.setModel(T);this.getView().setBusy(false)}.bind(this))}this.oView.setModel(T)}.bind(this))},_loadLanguagesList:function(){g.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");return this.oUserInfoServicePromise.then(function(t){return new Promise(function(r){g.start("FLP:LanguageRegionSelector._getLanguagesList","_getLanguagesList","FLP");t.getLanguageList().done(function(e){g.end("FLP:LanguageRegionSelector._getLanguagesList");r(e)}).fail(function(t){g.end("FLP:LanguageRegionSelector._getLanguagesList");e.error("Failed to load language list.",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");r(null)})})})},_loadUserSettingList:function(){g.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");return this.oUserInfoServicePromise.then(function(e){return new Promise(function(t){g.start("FLP:LanguageRegionSelector._loadUserSettingList","_loadUserSettingList","FLP");e.getUserSettingList().then(function(e){g.end("FLP:LanguageRegionSelector._loadUserSettingList");t(e)})})})},_resetLanguage:function(){var e=this.oUser.getLanguage(),t=this.getView().getModel(),r=t.getData();var a=r.isLanguagePersonalized?e:"default";t.setProperty("/selectedLanguage",a);this._updateTextFields(e)},onCancel:function(){var e=this.getView().getModel(),t=e.getData(),r=t.languageList,a=t.isEnableSetLanguage;if(a&&r){this._resetLanguage()}if(t.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}},onSaveSuccess:function(t,r,a){var n={refresh:true};t.resetChangedProperty("dateFormat");t.resetChangedProperty("timeFormat");t.resetChangedProperty("numberFormat");t.resetChangedProperty("timeZone");t.resetChangedProperty("calendarWeekNumbering");if(r){e.debug("[000] onSaveSuccess: oUser.resetChangedPropertyLanguage:","LanguageRegionSelector.controller");t.resetChangedProperty("language");n.obsoleteUrlParams=["sap-language"];n.clearSapUserContextCookie=true}return n},onSave:function(r){var a=this.oUser,n=this.getView().getModel().getData(),s=n.selectedLanguage,i=a.getLanguage(),g=s&&s!==(n.isLanguagePersonalized?i:"default"),o=n.isEnableUserProfileSetting,l=n.isEnableSetLanguage&&n.languageList&&g,u=false,m=["DATE_FORMAT","TIME_FORMAT","NUMBER_FORMAT","TIME_ZONE","LANGUAGE","CALENDAR_WEEK_NUMBERING"];e.debug("[000] LanguageRegionSelector:onSave:bUpdateLanguage, bIsEnableSetUserProfileSetting:",l,"LanguageRegionSelector.controller");if(l){e.debug("[000] LanguageRegionSelector:onSave:UserInfo: oUser.setLanguage:",s,"LanguageRegionSelector.controller");a.setLanguage(s)}else{this._resetLanguage()}if(o){if(t.getABAPDateFormat()!==n.selectedDatePattern){u=true;a.setChangedProperties({propertyName:"dateFormat",name:"DATE_FORMAT"},t.getABAPDateFormat(),n.selectedDatePattern)}if(t.getABAPTimeFormat()!==n.selectedTimeFormat){u=true;a.setChangedProperties({propertyName:"timeFormat",name:"TIME_FORMAT"},t.getABAPTimeFormat(),n.selectedTimeFormat)}if(this._getABAPNumberFormat()!==n.selectedNumberFormat){u=true;a.setChangedProperties({propertyName:"numberFormat",name:"NUMBER_FORMAT"},this._getABAPNumberFormat(),n.selectedNumberFormat)}if(!n.selectedTimeZone){this.getView().getModel().setProperty("/selectedTimeZone",this.oUser.getTimeZone())}else if(this.oUser.getTimeZone()!==n.selectedTimeZone){u=true;a.setChangedProperties({propertyName:"timeZone",name:"TIME_ZONE"},this.oUser.getTimeZone(),n.selectedTimeZone)}if(t.getCalendarWeekNumbering()!==n.selectedCalendarWeekNumbering){u=true;a.setChangedProperties({propertyName:"calendarWeekNumbering",name:"CALENDAR_WEEK_NUMBERING"},t.getCalendarWeekNumbering(),n.selectedCalendarWeekNumbering.trim());t.setCalendarWeekNumbering(n.selectedCalendarWeekNumbering)}}if(l||u){return r().then(function(){e.debug("[000] onSave:fnUpdateUserPreferences","LanguageRegionSelector.controller");return this.onSaveSuccess(a,l,s)}.bind(this)).catch(function(t){e.debug("[000] onSave:catch:errorMessage",t,"LanguageRegionSelector.controller");var r=m.some(function(e){return t.includes(e)});if(!r){return this.onSaveSuccess(a,l,s)}if(l){a.setLanguage(i);a.resetChangedProperty("language");this._updateTextFields(i)}a.resetChangedProperty("dateFormat");a.resetChangedProperty("timeFormat");a.resetChangedProperty("numberFormat");a.resetChangedProperty("timeZone");a.resetChangedProperty("calendarWeekNumbering");if(n.isEnableUserProfileSetting){this._restoreUserSettingPreferenceValues()}e.error("Failed to save Language and Region Settings",t,"sap.ushell.components.ushell.settings.userLanguageRegion.LanguageRegionSelector.controller");throw t}.bind(this))}return Promise.resolve()},_restoreUserSettingPreferenceValues:function(){var e=this.getView().getModel();e.setProperty("/selectedDatePattern",t.getABAPDateFormat());e.setProperty("/selectedTimeFormat",t.getABAPTimeFormat());e.setProperty("/selectedNumberFormat",this._getABAPNumberFormat());e.setProperty("/selectedTimeZone",this.oUser.getTimeZone());e.setProperty("/selectedCalendarWeekNumbering",t.getCalendarWeekNumbering());var r=e.getProperty("/CalendarWeekNumberingList").map(e=>{e.selected=e.value===t.getCalendarWeekNumbering();return e});e.setProperty("/CalendarWeekNumberingList",r)},_handleLanguageSelectChange:function(e){var t=e.getSource().getSelectedKey();if(t){this._updateTextFields(t)}},_updateTextFields:function(e){var n;if(e===this.oUser.getLanguage()){n=new r(t.getLanguageTag())}else{n=new r(e)}var s=this.getView().getModel(),i=a.getInstance(n),g=i.getDatePattern("medium"),o=i.getTimePattern("medium"),l=o.indexOf("H")===-1?"12h":"24h";if(!s.getData().isEnableUserProfileSetting){s.setProperty("/selectedDatePattern",g);s.setProperty("/selectedTimeFormat",l)}},_getABAPNumberFormat:function(){var e=t.getABAPNumberFormat();if(e){return e.trim()}},_handleCalendarWeekNumberingChange:function(e){var t=e.getSource().getSelectedItem().getCustomData()[0].getValue();this.getView().getModel().setProperty("/selectedCalendarWeekNumbering",t)}})});
//# sourceMappingURL=LanguageRegionSelector.controller.js.map