// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/base/util/deepExtend","sap/base/util/deepEqual","sap/m/Button","sap/m/Input","sap/m/library","sap/ui/core/mvc/Controller","sap/ui/comp/smartfield/SmartField","sap/ui/comp/smartfield/SmartLabel","sap/ui/comp/smartform/Group","sap/ui/comp/smartform/GroupElement","sap/ui/comp/smartvariants/PersonalizableInfo","sap/ui/core/Title","sap/ui/model/json/JSONModel","sap/ui/model/odata/v2/ODataModel","sap/ushell/resources","sap/m/MessageBox","./ExtendedValueDialog.controller","sap/ushell/Container"],function(e,t,a,r,i,n,s,o,d,l,u,m,h,c,f,p,v,g,y,P){"use strict";var M=s.ButtonType;function b(e,t){if(!(t.editorMetadata&&t.editorMetadata.groupId)){return-1}if(!(e.editorMetadata&&e.editorMetadata.groupId)){return 1}if(e.editorMetadata.groupId<t.editorMetadata.groupId){return-1}if(e.editorMetadata.groupId>t.editorMetadata.groupId){return 1}return 0}function S(e,t){if(!(t.editorMetadata&&t.editorMetadata.parameterIndex)){return-1}if(!(e.editorMetadata&&e.editorMetadata.parameterIndex)){return 1}return e.editorMetadata.parameterIndex-t.editorMetadata.parameterIndex}function D(e,t){var a=b(e,t);if(a===0){return S(e,t)}return a}return o.extend("sap.ushell.components.shell.Settings.userDefaults.controller.UserDefaultsSetting",{onInit:function(){this.oModelRecords={};this.aChangedParamsNames=[];this.oBlockedParameters={};this.aDisplayedUserDefaults=[];this.oDirtyStateModel=new f({isDirty:false,selectedVariant:null});this.getView().setModel(this.oDirtyStateModel,"DirtyState");this.oOriginalParameters={};var t=this.getView();t.setBusy(true);t.setModel(v.getTranslationModel(),"i18n");this.getSystemContextsModel().then(function(e){t.setModel(e,"systemContexts");return this._fillGroups()}.bind(this)).then(this._saveIsSupportedPlatform.bind(this)).then(this._initializeSmartVariantManagement.bind(this)).then(function(){t.setBusy(false)}).catch(function(a){e.error("Error during UserDefaultsSetting controller initialization",a,"sap.ushell.components.shell.Settings.userDefaults.UserDefaultsSetting");t.setBusy(false)})},getSystemContextsModel:function(){var e=new f({systemContexts:[],selectedKey:""});var t=this._getContentProviderIds();var a=P.getServiceAsync("ClientSideTargetResolution");var r=P.getServiceAsync("UserDefaultParameters");return Promise.all([t,a,r]).then(function(t){var a=t[0];var r=t[1];var i=t[2];if(a.length===0){a.push("")}return Promise.all(a.map(function(t){return r.getSystemContext(t).then(function(t){var a=e.getProperty("/systemContexts");return i.hasRelevantMaintainableParameters(t).then(function(e){if(e){a.push(t)}})})})).then(function(){var t=e.getProperty("/systemContexts");if(t.length>0){e.setProperty("/selectedKey",t[0].id)}return e})})},_getContentProviderIds:function(){return P.getServiceAsync("CommonDataModel").then(function(e){return e.getContentProviderIds()}).catch(function(){return[""]})},handleSystemContextChanged:function(){if(this.oDirtyStateModel.getProperty("/isDirty")){var e=v.i18n.getText("userDefaultsSave");var t=v.i18n.getText("userDefaultsDiscard");g.show(v.i18n.getText("userDefaultsUnsavedChangesMessage"),{title:v.i18n.getText("userDefaultsUnsavedChangesTitle"),actions:[e,t,g.Action.CANCEL],emphasizedAction:e,icon:g.Icon.QUESTION,onClose:function(a){if(a===t){this._fillGroups();this._setDirtyState(false)}else if(a===e){this.onSave();this._fillGroups();this._setDirtyState(false)}else{this.getView().getModel("systemContexts").setProperty("/selectedKey",this.sLastSelectedKey)}}.bind(this)})}else{this._fillGroups()}},_fillGroups:async function(){var e=this.getView().byId("userDefaultsForm");e.removeAllGroups();var t=this.getView().getModel("systemContexts").getProperty("/selectedKey");var r=this.getView().getModel("systemContexts").getProperty("/systemContexts").find(function(e){return e.id===t});const i=await P.getServiceAsync("UserDefaultParameters");const n=await i.editorGetParameters(r);this.oOriginalParameters=a({},n);this.oModel=new f(n);this.oModel.setDefaultBindingMode("TwoWay");this.getView().setModel(this.oModel,"MdlParameter");const s=await this._getFormattedParameters(this.oModel);var o=this._createContent(s);o.forEach(function(t){e.addGroup(t)})},_getFormattedParameters:function(t){var r=t.getData("/");var i=Object.keys(r).map(function(i){var n=a({},r[i]);n.parameterName=i;n.editorMetadata=n.editorMetadata||{};if(n.editorMetadata.editorInfo&&n.editorMetadata.editorInfo.propertyName){return this._createOdataModelBinding(n,t).then(function(e){n.modelBind=e;var t=e.model?e.model.getMetaModel():undefined;if(t){return t.loaded().then(function(){var e=t.getObject("/dataServices/schema/0/namespace");var a=t.getODataEntityType(e+"."+n.editorMetadata.editorInfo.entityName);var r=a.property.find(function(e){if(e.name===n.editorMetadata.editorInfo.propertyName){return true}});switch(r.type){case"Edm.DateTime":n.valueObject.value=n.valueObject.value?new Date(n.valueObject.value):null;break;default:n.valueObject.value=n.valueObject.value?n.valueObject.value:"";break}return n})}n.valueObject=a({value:""},n.valueObject);return n}).catch(function(){e.error("Metadata loading for parameter "+n.parameterName+" failed"+JSON.stringify(n.editorMetadata));n.valueObject=a({value:""},n.valueObject);n.modelBind=this._createPlainModelBinding(n,t);this.oBlockedParameters[n.parameterName]=false;return Promise.resolve(n)}.bind(this))}n.valueObject=a({value:""},n.valueObject);n.modelBind=this._createPlainModelBinding(n,t);return Promise.resolve(n)}.bind(this));return Promise.all(i).then(function(e){e.sort(D);this.aDisplayedUserDefaults=e;e.forEach(function(e){e.modelBind.model.setProperty(e.modelBind.sFullPropertyPath,e.valueObject.value);e.modelBind.model.bindTree(e.modelBind.sFullPropertyPath).attachChange(this.storeChangedData.bind(this))}.bind(this));return e}.bind(this))},_createPlainModelBinding:function(e,t){var a="/"+e.parameterName+"/valueObject/value";if(!t.getProperty("/"+e.parameterName+"/valueObject")){t.setProperty("/"+e.parameterName+"/valueObject",{})}var r={isOdata:false,model:t,extendedModel:t,sFullPropertyPath:a,sPropertyName:"{"+a+"}"};return r},_createOdataModelBinding:function(e,t){var a=e.editorMetadata.editorInfo;var r=this._getODataServiceData(a.odataURL,e);return r.metadataLoaded.then(function(){var e={isOdata:true,model:r.model,extendedModel:t,sPropertyName:"{"+a.propertyName+"}",sFullPropertyPath:a.bindingPath+"/"+a.propertyName};return e})},_getODataServiceData:function(e,a){if(!this.oModelRecords[e]){var r=new p(e,{metadataUrlParams:{"sap-documentation":"heading,quickinfo","sap-value-list":"none","sap-lang-cachebuster":t.getLanguageTag().toString()},json:true});r.setDefaultCountMode("None");r.setDefaultBindingMode("TwoWay");this.oModelRecords[e]={attachedListeners:[],model:r,metadataLoaded:new Promise(function(e,t){r.attachMetadataLoaded(e);r.attachMetadataFailed(t)})}}if(this.oModelRecords[e].attachedListeners.indexOf(a.parameterName)===-1){this.oModelRecords[e].attachedListeners.push(a.parameterName);this.oModelRecords[e].model.attachRequestCompleted(this._overrideOdataModelValue.bind(this,a));this.oBlockedParameters[a.parameterName]=true}return this.oModelRecords[e]},_overrideOdataModelValue:function(e,t){var a=t.getSource();var r="/"+t.getParameter("url").replace(/\?.*/,"");if(e.editorMetadata.editorInfo.bindingPath===r){var i=e.editorMetadata.editorInfo.bindingPath+"/"+e.editorMetadata.editorInfo.propertyName;if(a.getProperty(i)!==e.valueObject.value){a.setProperty(i,e.valueObject.value)}this.oBlockedParameters[e.parameterName]=false}},_createContent:function(e){let t="nevermore";let a;const r={};const i=[];for(var n=0;n<e.length;++n){const d=e[n];const l=d.modelBind;if(t!==d.editorMetadata.groupId){a=new u({title:new c({text:d.editorMetadata.groupTitle||undefined})});t=d.editorMetadata.groupId;i.push(a)}const m=this._createGroupElement(d);m.setModel(l.model);if(l.isOdata){var s=d.editorMetadata.editorInfo.odataURL;if(!r[s]){var o=d.editorMetadata.editorInfo.bindingPath;m.bindElement(o);r[s]=d.modelBind.model.getContext(o)}else{m.setBindingContext(r[s])}}a.addGroupElement(m)}return i},_createGroupElement:function(e){let t;const a=new l({});const r=new i({text:"{i18n>userDefaultsExtendedParametersTitle}",tooltip:"{i18n>userDefaultsExtendedParametersTooltip}",visible:!!e.editorMetadata.extendedUsage,type:{parts:[`MdlParameter>/${e.parameterName}/valueObject/extendedValue/Ranges`],formatter:e=>e&&e.length?M.Emphasized:M.Transparent},press:t=>{y.openDialog(e,this.saveExtendedValue.bind(this))}});if(e.modelBind.isOdata&&e.editorMetadata.editorInfo){t=new d({value:e.modelBind.sPropertyName,name:e.parameterName,fieldGroupIds:["UserDefaults"]});a.setLabelFor(t)}else{t=new n({name:e.parameterName,value:e.modelBind.sPropertyName,fieldGroupIds:["UserDefaults"],type:"Text"});t.addAriaLabelledBy(a);a.setText(e.editorMetadata.displayText||e.parameterName);a.setTooltip(e.editorMetadata.description||e.parameterName)}t.attachChange(this.storeChangedData.bind(this));t.attachChange(this._setDirtyState.bind(this,true),this);const s=new m({elements:[t,r],label:a});return s},saveExtendedValue:function(e){var t=e.getSource().getModel().getProperty("/parameterName");var a=this.oModel;var r=e.getParameters().tokens||[];var i="/"+t+"/valueObject/extendedValue/Ranges";var n=r.map(function(e){var t=e.data("range");return{Sign:t.exclude?"E":"I",Option:t.operation!=="Contains"?t.operation:"CP",Low:t.value1,High:t.value2||null}});if(!a.getProperty("/"+t+"/valueObject/extendedValue")){a.setProperty("/"+t+"/valueObject/extendedValue",{})}a.setProperty(i,n);this.aChangedParamsNames.push(t);if(e.getParameter("_tokensHaveChanged")){this._setDirtyState(true)}},_setDirtyState:function(e){this.oDirtyStateModel.setProperty("/isDirty",e);this._setSmartVariantModified(e);if(e){this.sLastSelectedKey=this.getView().getModel("systemContexts").getProperty("/selectedKey")}},_setSelectedVariant:function(e){this.oDirtyStateModel.setProperty("/selectedVariant",e);this.storeChangedData()},storeChangedData:function(){var e=this.aDisplayedUserDefaults||[];for(var t=0;t<e.length;++t){var i=e[t].parameterName;var n=this.oModel.getProperty("/"+i+"/valueObject/");var s=e[t].modelBind;if(!this.oBlockedParameters[i]){var o={value:n&&n.value,extendedValue:n&&n.extendedValue};if(s&&s.model){var d=s.model;var l=s.extendedModel;var u=s.sFullPropertyPath;var m={value:d.getProperty(u)!==""?d.getProperty(u):undefined,extendedValue:l.getProperty("/"+i+"/valueObject/extendedValue")||undefined};if(!r(m,o)){n.value=m.value;if(m.extendedValue){n.extendedValue={};a(n.extendedValue,m.extendedValue)}this.oModel.setProperty("/"+i+"/valueObject",n);this.aChangedParamsNames.push(i)}}}}},onCancel:function(){this._setDirtyState(false);var e=this.aDisplayedUserDefaults;if(this.aChangedParamsNames.length>0){for(var t=0;t<e.length&&this.aChangedParamsNames.length>0;t++){var a=e[t].parameterName;if(this.aChangedParamsNames.indexOf(a)>-1){var r=this.oOriginalParameters[a];var i=e[t];var n=i.modelBind;var s=n.model?n.model.getMetaModel():undefined;if(s){var o=s.getObject("/dataServices/schema/0/namespace");var d=s.getODataEntityType(o+"."+i.editorMetadata.editorInfo.entityName);var l=d.property.find(function(e){if(e.name===i.editorMetadata.editorInfo.propertyName){return true}});switch(l.type){case"Edm.DateTime":n.model.setProperty(n.sFullPropertyPath,new Date(r.valueObject.value)||null);break;default:n.model.setProperty(n.sFullPropertyPath,r.valueObject.value||"");break}}else{n.model.setProperty(n.sFullPropertyPath,r.valueObject.value||"")}if(r.editorMetadata&&r.editorMetadata.extendedUsage){n.extendedModel.setProperty("/"+a+"/valueObject/extendedValue",r.valueObject.extendedValue||{})}}}this.aChangedParamsNames=[]}this._setDefaultVariant()},onSave:function(){this.storeChangedData();this._setDirtyState(false);var e;if(this.aChangedParamsNames.length===0){e=Promise.resolve()}else{e=P.getServiceAsync("ClientSideTargetResolution").then(function(e){return e.getSystemContext(this.sLastSelectedKey)}.bind(this)).then(function(e){var t=this.aChangedParamsNames.sort();this.aChangedParamsNames=[];return this._saveParameterValues(t,e)}.bind(this))}return e.then(this._resetSmartVariantManagement.bind(this)).then(this._setDefaultVariant.bind(this))},_saveParameterValues:function(e,t){var a=[];for(var i=0;i<e.length;i++){var n=e[i];var s=this.oModel.getProperty("/"+n+"/valueObject/");var o=this.oOriginalParameters[n].valueObject;if(!r(o,s)){if(s&&s.value===null||s&&s.value===""){s.value=undefined}if(s&&s.extendedValue&&Array.isArray(s.extendedValue.Ranges)&&s.extendedValue.Ranges.length===0){s.extendedValue=undefined}var d=this._saveParameterValue(n,s,o,t);a.push(d)}}return Promise.all(a)},_saveParameterValue:async function(e,t,a,r){const i=await P.getServiceAsync("UserDefaultParameters");await i.editorSetValue(e,t,r);a.value=t.value},_setSmartVariantModified:function(e){if(!this._bIsSupportedPlatform){return}this.getView().byId("defaultSettingsVariantManagement").currentVariantSetModified(e)},_setDefaultVariant:function(){if(!this._bIsSupportedPlatform){return}var e=this.getView().byId("defaultSettingsVariantManagement");e.setCurrentVariantId(e.getDefaultVariantKey());this._setSelectedVariant(e.getDefaultVariantKey())},_resetSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve()}this.getView().byId("defaultSettingsVariantManagement").removeAllPersonalizableControls();return this._initializeSmartVariantManagement()},_initializeSmartVariantManagement:function(){if(!this._bIsSupportedPlatform){return Promise.resolve()}var e=this.getView().byId("defaultSettingsVariantManagement");var t=function(){this._setSelectedVariant(e.getSelectionKey())}.bind(this);return new Promise(function(a){var r=this.getView().byId("userDefaultsForm");var i=new h({type:"wrapper",keyName:"persistencyKey",dataSource:"none",control:r});e.detachSelect(t).detachAfterSave(t).addPersonalizableControl(i).attachSelect(t).attachAfterSave(t).initialise(function(){e.setVisible(true);a()},r)}.bind(this)).then(t)},_saveIsSupportedPlatform:function(){var e=P.getLogonSystem().getPlatform();this._bIsSupportedPlatform=e!=="cdm";return Promise.resolve(this._bIsSupportedPlatform)},displayDiffText:function(){if(!this._bIsSupportedPlatform){return false}var e=this.getView().byId("defaultSettingsVariantManagement");var t=this.getView().byId("userDefaultsForm");var a=e.getStandardVariantKey();var i=e.getSelectionKey();if(i===a){return false}var n=e.getVariantContent(t,a);var s=e.getVariantContent(t,i);delete s.executeOnSelection;return!r(n,s)}})});
//# sourceMappingURL=UserDefaultsSetting.controller.js.map