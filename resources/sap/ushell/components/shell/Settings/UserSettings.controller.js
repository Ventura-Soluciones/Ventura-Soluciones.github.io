// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/ui/core/Element","sap/ui/core/mvc/Controller","sap/ui/core/Fragment","sap/ui/model/json/JSONModel","sap/ui/Device","sap/ushell/Config","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils/WindowUtils","sap/ushell/components/shell/Settings/ErrorMessageHelper","sap/ui/core/message/Message","sap/ui/core/message/MessageType","sap/ui/base/Object","sap/base/util/deepClone","sap/ushell/Container"],function(e,t,n,s,r,i,o,a,l,u,d,c,g,f,h,p){"use strict";return n.extend("sap.ushell.components.shell.Settings.UserSettings",{onInit:function(){const e=this.getView();this._aPreviouslySelectedItems=[];e.byId("userSettingEntryList").addEventDelegate({onAfterRendering:this._listAfterRendering.bind(this)});this._mLoadedEntryContent=new Map;this._mLoadedWrappers=new Map;e.setModel(new r({}));e.setModel(l.i18nModel,"i18n");e.setModel(new r({entries:{}}),"results");i.orientation.attachHandler(this._fnOrientationChange,this);this._oSelectedItemOnMobile=null;this._oConfigDoable=o.on("/core/userPreferences/entries").do(this._processNewEntries.bind(this))},_fnOrientationChange:function(){var e=this.getView().byId("settingsApp");this._updateHeaderButtonVisibility(e.isMasterShown())},_formatDescription:function(e,t,n){if(t.length>1){return""}return n[e].valueResult||""},_processNewEntries:function(e){var t=this.getView();var n=t.getModel("results");e.forEach(function(e){var t=n.getProperty("/entries/"+e.id);if(!t){n.setProperty("/entries/"+e.id,{valueResult:null,contentResult:null})}this._setEntryValueResult(e.id)}.bind(this));var s=t.getModel();var r=t.byId("userSettingEntryList");var o=r.getSelectedItem();if(!i.system.phone&&!o){o=r.getItems()[0]}if(o){var a=o.getBindingContext().getObject();this._aPreviouslySelectedItems=a.tabs.map(function(e){return e.id})}s.setProperty("/entries",this._calculateEntryGroups(e));t.byId("userSettingEntryList").invalidate()},_calculateEntryGroups:function(e){var t=[];var n=new Map;var s=this.getView().getModel("results");e.forEach(function(e){if(e.visible===false){var r=s.getProperty("/entries/"+e.id+"/contentResult");if(r){this.getView().byId("settingsApp").removeDetailPage(r);s.setProperty("/entries/"+e.id+"/contentResult",null)}var i=a.last("UserSettingsOpened")||{};delete i[e.id];a.emit("UserSettingsOpened",i);return}if(e.groupingEnablement){s.setProperty("/entries/"+e.id+"/contentResult",null);var o=n.get(e.groupingId);if(o||o===0){t[o].tabs.push(e);return}n.set(e.groupingId,t.length)}e.tabs=[e];t.push(e)}.bind(this));return t},_afterClose:function(){if(window.document.activeElement&&window.document.activeElement.tagName==="BODY"){window.document.getElementById("userActionsMenuHeaderButton").focus()}},open:function(e){const t=this.byId("userSettingsDialog");if(e){this.sTargetEntryId=e}t.open()},_listAfterRendering:function(){var e=this.getView();var t=e.byId("userSettingEntryList");var n=t.getItems();var s;var r;n.forEach(function(e){var t=e.getBindingContext().getObject();this._setEntryValueResult(t.id);r=t?.tabs?.find(e=>e.id===this.sTargetEntryId)?.id;if(t.id===this.sTargetEntryId||r){s=e;this.sTargetEntryId=null}}.bind(this));if(!i.system.phone){if(!s&&this._aPreviouslySelectedItems){for(var o=0;o<this._aPreviouslySelectedItems.length;o++){for(var a=0;a<n.length;a++){var l=n[a];if(l.getBindingContext().getObject().id===this._aPreviouslySelectedItems[o]){t.setSelectedItem(l);this._toDetail(l,r);l.focus();return}}}}s=s||n[0];if(s){t.setSelectedItem(s);this._toDetail(s,r);s.focus()}}},_setEntryValueResult:function(t){var n;var s=this.getView().getModel("results");var r=o.last("/core/userPreferences/entries");var i=r.findIndex(function(e){return e.id===t});if(i===-1){return Promise.resolve()}return Promise.resolve().then(function(){var a=r[i].title;var u=r[i].valueArgument;if(typeof u!=="function"){var d=s.getProperty("/entries/"+t+"/valueResult");if(d!==null&&d!==undefined){return d}return u}n=h(s.getProperty("/entries"));n[t].valueResult=l.i18n.getText("genericLoading");s.setProperty("/entries",n);return Promise.resolve().then(u).then(function(e){if(typeof e!=="object"){return e}if(e&&e.value!==undefined){r=o.last("/core/userPreferences/entries");i=r.findIndex(function(e){return e.id===t});if(i>-1){r[i].visible=!!e.value;o.emit("/core/userPreferences/entries",r)}}return e.displayText}).catch(function(t){e.error("Can not load value for "+a+" entry",t);return l.i18n.getText("loadingErrorMessage")})}).then(function(e){n=h(s.getProperty("/entries"));n[t].valueResult=e||"";s.setProperty("/entries",n)})},_navBackButtonPressHandler:function(){var e=this.getView().byId("settingsApp");e.backDetail();this._updateHeaderButtonVisibility(true)},_navToggleButtonPressHandler:function(){var e=this.getView().byId("settingsApp");var t=e.isMasterShown();if(t){e.hideMaster()}else{e.showMaster()}this._updateHeaderButtonVisibility(!t)},_updateHeaderButtonVisibility:function(e){if(i.system.phone){var t=this.getView().byId("userSettingsNavBackButton");t.setVisible(!e)}else{var n=this.getView().byId("userSettingsMenuButton");if(i.orientation.portrait){n.setVisible(true);n.setPressed(e);n.setTooltip(l.i18n.getText(e?"ToggleButtonHide":"ToggleButtonShow"))}else{n.setVisible(false)}}},_afterMasterClose:function(){this._updateHeaderButtonVisibility(false)},_onSelectionChange:function(e){this._toDetail(e.getSource().getSelectedItem())},_toDetail:function(e,t){var n=this.getView();var s=n.getModel();var r=n.getModel("results");var a=n.byId("settingsApp");var l=e.getBindingContextPath();var u=s.getProperty(l);var d=u.id;var c=r.getProperty("/entries/"+d+"/contentResult");if(u.tabs){this._aPreviouslySelectedItems=u.tabs.map(function(e){return e.id})}else{this._aPreviouslySelectedItems=[d]}if(i.system.phone){this._oSelectedItemOnMobile=e;e.setSelected(false)}if(c){this._navToDetail(c,n);var g=u.tabs.map(function(e){return e.id}).join("-");var f=this._mLoadedWrappers.get(g);if(f){f.then(function(e){var n=e.getContent()[1];if(t){n.setSelectedKey(t)}var s=n.getSelectedKey();var r=n.getItems();var i=r.findIndex(function(e){return e.getId()===s});if(i===-1){i=0}this._emitEntryOpened(u.tabs[i].id)}.bind(this));return Promise.resolve()}}if(i.system.phone){a.setBusy(true)}else{this._navToBusyPage()}return Promise.all([this._createContentWrapper(u),this._createEntryContent(u)]).then(function(s){var i=s[0];var l=s[1];var c=o.last("/core/userPreferences/entries");var g=c.some(function(e){return e.id===d&&e.visible!==false});var f=n.byId("userSettingEntryList");var h=f.getSelectedItem()||this._oSelectedItemOnMobile;var p=e===h;if(!g){if(p){if(a.getMode()==="ShowHideMode"){a.showMaster();this._updateHeaderButtonVisibility(true)}else{this._toDetail(h||f.getItems()[0])}}return}a.addDetailPage(i);if(u.tabs.length>1){i.getContent()[1].getItems()[0].addContent(l)}else{i.addContent(l)}var v=i.getId();r.setProperty("/entries/"+d+"/contentResult",v);if(t){var y=i.getContent()?.[1];y?.setSelectedKey(t)}if(p){this._navToDetail(v,n);this._emitEntryOpened(d)}return i.getId()}.bind(this))},_createEntryContent:function(e){if(!this._mLoadedEntryContent.get(e.id)){if(typeof e.contentFunc==="function"){this._mLoadedEntryContent.set(e.id,new Promise(function(t){e.contentFunc().then(function(e){if(f.isObjectA(e,"sap.ui.core.Control")){t(e)}else{this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}}.bind(this)).catch(function(){this._createErrorContent(l.i18n.getText("loadingErrorMessage")).then(t)}.bind(this))}.bind(this)))}else{this._mLoadedEntryContent.set(e.id,this._createErrorContent(l.i18n.getText("userSettings.noContent")))}}return this._mLoadedEntryContent.get(e.id)},_createContentWrapper:function(e){var n=e.tabs.map(function(e){return e.id});var i=n.join("-");if(!this._mLoadedWrappers.get(i)){this._mLoadedWrappers.set(i,s.load({name:"sap.ushell.components.shell.Settings.ContentWrapper",controller:{onTabSelected:function(n){var s=t.getElementById(n.getParameter("id"));var r=n.getParameter("item");var i=s.indexOfItem(r);var o=e.tabs[i];this._emitEntryOpened(o.id);this._createEntryContent(o).then(function(e){r.addContent(e)})}.bind(this)}}).then(function(t){t.setModel(new r({title:e.title,showHeader:!e.provideEmptyWrapper,tabs:e.tabs}),"entryInfo");return t}))}return this._mLoadedWrappers.get(i).then(function(t){var n=t.getContent()[1];var s=n.getSelectedKey();var r=n.getItems().findIndex(function(e){return e.getId()===s});if(r>-1){var i=e.tabs[r];this._emitEntryOpened(i.id)}return t}.bind(this))},_createErrorContent:function(e){return s.load({name:"sap.ushell.components.shell.Settings.ErrorContent"}).then(function(t){t.setModel(new r({errorMessage:e}));return t})},_navToBusyPage:function(){var e=this.getView();this._navToDetail(e.createId("userSettingBusyPage"),e)},_navToDetail:function(e,t){var n=t.byId("settingsApp");n.setBusy(false);n.toDetail(e);if(n.getMode()==="ShowHideMode"){n.hideMaster();this._updateHeaderButtonVisibility(false)}},_emitEntryOpened:function(e){var t=a.last("UserSettingsOpened")||{};t[e]=true;a.emit("UserSettingsOpened",t)},updateUserPreferences:function(){e.debug("[000] updateUserPreferences: ","UserSettings.controller");if(this._updateUserPreferencesPromise){return this._updateUserPreferencesPromise}var t,n;this._updateUserPreferencesPromise=new Promise(function(e,s){t=e;n=s});this._updateUserPreferencesPromise.sendRequest=function(){p.getServiceAsync("UserInfo").then(function(s){e.debug("[000] updateUserPreferences: sendRequest","UserSettings.controller");s.updateUserPreferences().done(t).fail(n).always(function(){e.debug("[000] updateUserPreferences: sendRequest: _updateUserPreferencesPromise","UserSettings.controller");this._updateUserPreferencesPromise=null}.bind(this))}.bind(this))}.bind(this);return this._updateUserPreferencesPromise},_maybeReload:function(t){var n=false;var s=false;var r=false;var i=[];var o=[];t.forEach(function(e){if(e&&e.clearSapUserContextCookie){s=true}if(e&&e.refresh){n=true}if(e&&e.noHash){r=true}if(e&&e.urlParams&&e.urlParams.length>0){i=i.concat(e.urlParams)}if(e&&e.obsoleteUrlParams&&e.obsoleteUrlParams.length>0){o=o.concat(e.obsoleteUrlParams)}});if(n){e.debug("[000]refresh browser with Parameters:",JSON.stringify(i),"UserSettings.controller");if(s){u.clearSapUserContextCookie()}if(r){window.location=window.location.href.replace(window.location.hash,"")}else{u.refreshBrowser(i,o)}return true}},_handleSaveButtonPress:function(){d.removeErrorMessages();var t=this.getView().byId("userSettingsDialog");var n=o.last("/core/userPreferences/entries");var s=a.last("UserSettingsOpened")||{};if(Object.keys(s).length===0){this._handleSettingsDialogClose();this._showSuccessMessageToast();return Promise.resolve()}t.setBusy(true);var r=n.reduce(function(t,n){if(s[n.id]){e.debug("[000] _handleSaveButtonPress: oEntry.id: ",n.id,"UserSettings.controller");t.push(this._executeEntrySave(n))}return t}.bind(this),[]);e.debug("[000] _handleSaveButtonPress:_updateUserPreferencesPromise",this._updateUserPreferencesPromise,"UserSettings.controller");if(this._updateUserPreferencesPromise){this._updateUserPreferencesPromise.sendRequest()}return Promise.all(r).then(function(n){e.debug("[000] _handleSaveButtonPress: then save aResults",JSON.stringify(n),"UserSettings.controller");var s=d.filterMessagesToDisplay();var r={};var i="";var o="";t.setBusy(false);this._handleSettingsDialogClose();if(s.length>0){r=s[0];i=r.getDescription();a.emit("UserSettingsOpened",null);s.forEach(function(e){o+="Entry: "+e.getAdditionalText()+" - Error message: "+e.getDescription()+"\n"});e.error("Failed to save the following entries",o);if(this._maybeReload(n)){return}return p.getServiceAsync("MessageInternal").then(function(e){e.init();e.show(e.Type.ERROR,l.i18n.getText("userSettings.SavingError.SomeChanges"),{details:i})})}this._showSuccessMessageToast();a.emit("UserSettingsOpened",null);this._maybeReload(n)}.bind(this))},_executeEntrySave:function(t){var n,s;function r(e){return e||{}}function i(n){e.debug("[000] _onError: errorInformation",JSON.stringify(n),"UserSettings.controller");var s;var r=t.id;var i=t.title;if(!n){s=l.i18n.getText("userSettings.SavingError.Undefined")}else if(typeof n==="string"){s=n}else if(Array.isArray(n)){n.forEach(function(e){e.setAdditionalText(i);e.setTechnicalDetails({pluginId:r});d.addMessage(e)});return}else if(f.isObjectA(n,"sap.ui.core.message.Message")){n.setAdditionalText(i);n.setTechnicalDetails({pluginId:r});d.addMessage(n);return}else{s=l.i18n.getText("userSettings.SavingError.WithMessage",[n.message])}d.addMessage(new c({type:g.Error,additionalText:i,technicalDetails:{pluginId:r},description:s,message:s}))}try{e.debug("[000] onSave: oEntry.id: "+t.id,"UserSettings.controller");this._isExecuteEntrySavedInUserSettingsController=true;n=t.onSave(this.updateUserPreferences.bind(this))}catch(e){return i(e)}if(n){if(n.promise){e.warning("jQuery.promise is used to save "+t.title+" settings entry.\n"+"The using of jQuery.promise for onSave is deprecated. Please use the native promise instead.");s=new Promise(function(e){n.done(function(t){e(r(t))}).fail(function(t){e(i(t))})})}else{s=n.then(r).catch(i)}}else{s=Promise.resolve();e.warning(t.title+" settings might not be saved correctly, it seems like the API contract is not correctly fullfilled.\n"+"Please contact the owner of the setting.")}return s},_showSuccessMessageToast:function(){sap.ui.require(["sap/m/MessageToast"],function(e){var t=l.i18n.getText("savedChanges");e.show(t,{offset:"0 -50"})})},_handleCancel:function(){var t=o.last("/core/userPreferences/entries");var n=a.last("UserSettingsOpened")||{};if(n){t.forEach(function(t){if(n[t.id]&&t.onCancel){try{t.onCancel()}catch(t){e.error("Failed to cancel the following entries",t)}}})}a.emit("UserSettingsOpened",null);this._handleSettingsDialogClose()},_handleSettingsDialogClose:function(){p.getUser().resetChangedProperties();if(i.system.phone){this.getView().byId("settingsApp").toMaster("settingsView--userSettingMaster")}this.getView().byId("userSettingsMessagePopoverBtn").setVisible(false);this.getView().byId("userSettingsDialog").close()},onExit:function(){this._oConfigDoable.off();i.orientation.detachHandler(this._fnOrientationChange,this)}})});
//# sourceMappingURL=UserSettings.controller.js.map