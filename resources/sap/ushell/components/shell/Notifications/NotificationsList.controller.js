// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/m/MessageToast","sap/m/Text","sap/ui/core/format/DateFormat","sap/ui/core/Fragment","sap/ui/core/mvc/Controller","sap/ui/Device","sap/ui/model/json/JSONModel","sap/ushell/Container","sap/ushell/EventHub","sap/ushell/resources","sap/ushell/utils"],function(t,e,i,o,s,n,a,r,c,f,g,u,h){"use strict";async function l(t){const e=await f.getServiceAsync("MessageInternal");e.error(t)}return a.extend("sap.ushell.components.shell.Notifications.Notifications",{oPagingConfiguration:{MAX_NOTIFICATION_ITEMS_DESKTOP:400,MAX_NOTIFICATION_ITEMS_MOBILE:100,NOTIFICATIONS_COUNT_INITIAL:60,NOTIFICATIONS_COUNT:30},oSetFocusReason:{ListRefreshed:"ListRefreshed",MoreButtonPressed:"MoreButtonPressed",NotificationRemoved:"NotificationRemoved"},onInit:function(){if(r.system.desktop){this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_DESKTOP}else{this.iMaxNotificationItemsForDevice=this.oPagingConfiguration.MAX_NOTIFICATION_ITEMS_MOBILE}const t=this.getView();this.oNotificationsService=t.getViewData().notificationsService;this.oSortingTypes=this.oNotificationsService.getOperationEnum();this.sCurrentSorting=this.oSortingTypes.NOTIFICATIONS_BY_DATE_DESCENDING;this._oItemSet=new Set;const e=new c({settingsAvailable:false});e.setSizeLimit(1500);t.setModel(e);t.setModel(u.i18nModel,"i18n");this._resetModel();const i=this.oNotificationsService._getNotificationSettingsAvailability();if(i.state()==="pending"){this.oNotificationsService._userSettingInitialization()}this.oNotificationsService._getNotificationSettingsAvailability().then(t=>{if(t.settingsAvailable){this._getModel().setProperty("/settingsAvailable",true)}})},onAfterRendering:function(){this._sortUpdateSelectionState()},getNextPage:async function(t){const e=this._getModel();let i;if(t){this.getView().setVisible(false);i=await this.getOwnerComponent()._getPopover();this._resetModel()}else{i=this.byId("sapUshellNotificationsListMoreButton")}if(!this._moreNotificationsCanBeFetched()){return}const o=this._getNumberOfNotificationsToFetch();if(o===0){return}i.setBusy(true);e.setProperty("/inUpdate",true);try{let i=0;const s=this._oItemSet.size;if(!t&&s>0){await this.oNotificationsService.getNotifications();i=parseInt(await this.oNotificationsService.getUnseenNotificationsCount(),10)}const n=s+i;const a=await this.oNotificationsService.getNotificationsBufferBySortingType(this.sCurrentSorting,n,o);if(!a||a.length===0){e.setProperty("/hasMoreItemsInBackend",false)}else{const t=a.length>=this._getNumberOfNotificationsToFetch();e.setProperty("/hasMoreItemsInBackend",t);const i=a.filter(t=>{if(!this._oItemSet.has(t.Id)){this._oItemSet.add(t.Id);return true}return false});const o=e.getProperty("/notifications");const s=this._groupNotifications(o,i);e.setProperty("/notifications",s);e.refresh(true)}}catch(t){await l(u.i18n.getText("errorOccurredMsg"))}finally{this._updateListMaxReached();e.setProperty("/inUpdate",false);this.getView().setVisible(true);i.setBusy(false);const o=t?this.oSetFocusReason.ListRefreshed:this.oSetFocusReason.MoreButtonPressed;await this._setFocus(o)}},_resetModel:function(){const t=this._getModel();t.setProperty("/notifications",[]);this._oItemSet.clear();t.setProperty("/hasMoreItemsInBackend",true);t.setProperty("/listMaxReached",false);t.setProperty("/inUpdate",false)},_groupNotifications:function(t,e){t=t.length>0?t:undefined;if(this.sCurrentSorting===this.oSortingTypes.NOTIFICATIONS_BY_PRIORITY_DESCENDING){return this._groupNotificationsByPriority(t,e)}return this._groupNotificationsByTimePeriods(t,e)},_groupNotificationsByPriority:function(t,e){const i=t||this._getGroupsForPriority();for(let t=0;t<e.length;t++){const o=e[t];if(o.Priority.toUpperCase()==="HIGH"){i[0].items.push(o)}else{i[1].items.push(o)}}return i},_groupNotificationsByTimePeriods:function(t,e){const i=new Date;const o=24*60*60*1e3;const n=s.getDateInstance({pattern:"dMy"});const a=n.format(i);const r=n.format(new Date(Date.now()-o));const c=s.getDateInstance({pattern:"w"});const f=parseInt(c.format(i),10);const g=new Date;g.setFullYear(g.getFullYear()-1,11,31);const u=f-1||parseInt(c.format(g),10);const h=s.getDateInstance({pattern:"M"});const l=parseInt(h.format(i),10);const m=l-1||12;const d=s.getDateInstance({pattern:"y"});const I=parseInt(d.format(i),10);const p=t||this._getGroupsForTimePeriods();const N={TODAY:0,YESTERDAY:1,THIS_WEEK:2,LAST_WEEK:3,THIS_MONTH:4,LAST_MONTH:5,THIS_YEAR:6,OLDER:7};for(let t=0;t<e.length;t++){const i=e[t];const o=new Date(i.CreatedAt);const s=n.format(o);if(s===a){p[N.TODAY].items.push(i);continue}if(s===r){p[N.YESTERDAY].items.push(i);continue}const g=parseInt(d.format(o),10);const T=parseInt(c.format(o),10);if(g===I&&T===f){p[N.THIS_WEEK].items.push(i);continue}if(g===I&&T===u){p[N.LAST_WEEK].items.push(i);continue}const _=parseInt(h.format(o),10);if(g===I&&_===l){p[N.THIS_MONTH].items.push(i);continue}if(g===I&&_===m||g===I-1&&m===12){p[N.LAST_MONTH].items.push(i);continue}if(g===I){p[N.THIS_YEAR].items.push(i);continue}p[N.OLDER].items.push(i)}return p},_getGroupsForPriority:function(){return[{key:"IMPORTANT",titleText:u.i18n.getText("Notifications.Popover.Group.Important"),items:[]},{key:"OTHERS",titleText:u.i18n.getText("Notifications.Popover.Group.Others"),items:[]}]},_getGroupsForTimePeriods:function(){return[{key:"TODAY",titleText:u.i18n.getText("Notifications.Popover.Group.Today"),items:[]},{key:"YESTERDAY",titleText:u.i18n.getText("Notifications.Popover.Group.Yesterday"),items:[]},{key:"THIS_WEEK",titleText:u.i18n.getText("Notifications.Popover.Group.ThisWeek"),items:[]},{key:"LAST_WEEK",titleText:u.i18n.getText("Notifications.Popover.Group.LastWeek"),items:[]},{key:"THIS_MONTH",titleText:u.i18n.getText("Notifications.Popover.Group.ThisMonth"),items:[]},{key:"LAST_MONTH",titleText:u.i18n.getText("Notifications.Popover.Group.LastMonth"),items:[]},{key:"THIS_YEAR",titleText:u.i18n.getText("Notifications.Popover.Group.ThisYear"),items:[]},{key:"OLDER",titleText:u.i18n.getText("Notifications.Popover.Group.Older"),items:[]}]},_markNotificationRead:async function(t){const e=t.getBindingContext().getObject();try{await this.oNotificationsService.markRead(e.Id);t.getBindingContext().setProperty("IsRead",true)}catch(t){await l(u.i18n.getText("notificationsFailedMarkRead"))}},_moreNotificationsCanBeFetched:function(){const t=this._getModel();const e=t.getProperty("/hasMoreItemsInBackend");const i=t.getProperty("/listMaxReached");return e&&!i},_updateListMaxReached:function(){const t=this._getModel();const e=this._getNumberOfNotificationsToFetch()<=0;t.setProperty("/listMaxReached",e)},_sortUpdateSelectionState:function(){const t=n.byId(this.getOwnerComponent().createId("notificationsListCustomHeader"),"sortMenu").getItems();t.forEach(t=>{if(t.data("sortBy")===this.sCurrentSorting){t.setIcon("sap-icon://accept");t.setSelected(true)}else{t.setIcon("");t.setSelected(false)}})},_getModel:function(){return this.getView().getModel()},_getNumberOfNotificationsToFetch:function(){const t=this._oItemSet.size;const e=t>0?this.oPagingConfiguration.NOTIFICATIONS_COUNT:this.oPagingConfiguration.NOTIFICATIONS_COUNT_INITIAL;if(t>=this.iMaxNotificationItemsForDevice){return 0}if(t+e>this.iMaxNotificationItemsForDevice){return this.iMaxNotificationItemsForDevice-t}return e},_removeItemFromModel:async function(t,i){const o=this._getModel();const s=o.getObject(i)?.items||[];const n=s.findIndex(e=>e.Id===t);if(n===-1){return}s.splice(n,1);this._oItemSet.delete(t);o.setProperty(`${i}/items`,e([],s));this._updateListMaxReached();o.refresh(true);if(this._oItemSet.size===0&&!this._moreNotificationsCanBeFetched()){(await this.getOwnerComponent()._getPopover()).close()}},_setFocus:async function(t,e){const i=this._oItemSet.size>0;const o=this._moreNotificationsCanBeFetched();const s=this.byId("sapUshellNotificationsList");const n=()=>{const t=this.byId("sapUshellNotificationsListNoData");const e={onAfterRendering:()=>{t.focus();t.removeEventDelegate(e)}};t.addEventDelegate(e)};const a=t=>{t?.getParent()?.setCollapsed(false);const e={onAfterRendering:()=>{setTimeout(()=>{t?.getFocusDomRef()?.focus()},0);t.removeEventDelegate(e)}};t.addEventDelegate(e)};switch(t){case this.oSetFocusReason.ListRefreshed:if(i){const t=s.getItems()[0];const e=t?.getItems()[0];a(e)}else{n()}break;case this.oSetFocusReason.MoreButtonPressed:if(o){this.byId("sapUshellNotificationsListMoreButton")?.focus()}else{const t=s.getItems().length-1;const e=s.getItems()[t];const i=e?.getItems().length-1;const o=e?.getItems()[i];a(o)}break;case this.oSetFocusReason.NotificationRemoved:if(i){if(!e){break}a(e)}else if(o){this.byId("sapUshellNotificationsListMoreButton")?.focus();await this.getNextPage(false)}else{n()}break;default:(await this.getOwnerComponent()._getPopover()).focus();break}},_handleRemove:async function(t,e){const i=t.getParent();const o=i.getParent();const s=o.getItems().indexOf(i);const n=Math.max(s-1,0);const a=s-1<0;const r=i.getItems().length<=1;if(r){(await this.getOwnerComponent()._getPopover()).focus()}e().then(()=>{if(r){const t=o.getItems()[n];let e=0;if(!a){e=t?.getItems().length-1}const i=t?.getItems()[e];this._setFocus(this.oSetFocusReason.NotificationRemoved,i)}})},onLoadMorePress:async function(){const t=this._getModel();if(!t.getProperty("/inUpdate")){await this.getNextPage(false)}},onSettingsPress:async function(){g.emit("openUserSettings",{time:Date.now(),targetEntryId:"notificationsEntry"});(await this.getOwnerComponent()._getPopover()).close()},onSortMenuPress:function(){n.byId(this.getOwnerComponent().createId("notificationsListCustomHeader"),"sortMenu").setOpen(true)},onSortMenuItemPress:async function(t){const e=t.getParameter("item");this.sCurrentSorting=e.data("sortBy")||this.oSortingTypes.NOTIFICATIONS_BY_DATE_DESCENDING;this._sortUpdateSelectionState(e.data("sortBy"));await this.getNextPage(true)},onNotificationPress:async function(t){const e=t.getParameter("item");if(this._bRemoving||!e?.isA||!e.isA("@ui5/webcomponents-fiori.NotificationListItem")){return}const i=e.getBindingContext().getObject();const o=i.NavigationTargetObject;const s=i.NavigationTargetAction;const n=i.NavigationTargetParams;if(o&&s){h.toExternalWithParameters(o,s,n)}await this._markNotificationRead(e)},onNotificationRemovePress:async function(t){this._bRemoving=true;const e=t.getParameter("item");const i=e.getParent().getBindingContext().getPath();return this._handleRemove(e,async()=>{const t=e.getBindingContext().getObject();return this.oNotificationsService.dismissNotification(t.Id).then(()=>this._removeItemFromModel(t.Id,i)).finally(()=>{this._bRemoving=false})}).catch(async()=>{await l(u.i18n.getText("notificationsFailedDismiss"))})},onNotificationActionPress:async function(t){const e=t.getParameter("item");const o=e.getBindingContext().getObject();const s=e.getParent().getParent();const n=s.getBindingContext().getObject();s.setBusy(true);this._bRemoving=true;return this.oNotificationsService.executeAction(n.Id,o.ActionId).then(async t=>{if(t?.isSucessfull){if(t.message&&t.message.length){i.show(t.message,{duration:4e3})}else{const t=o.ActionText;i.show(u.i18n.getText("ActionAppliedToNotification",[t]),{duration:4e3})}if(t.DeleteOnReturn!==false){await this._handleRemove(s,async()=>{this.oNotificationsService._addDismissNotifications(n.Id);const t=s.getParent().getBindingContext().getPath();await this._removeItemFromModel(n.Id,t);s.setBusy(false)})}}else if(t){await l(t.message)}else{await l(u.i18n.getText("notificationsFailedExecuteAction"))}}).catch(async()=>{await l(u.i18n.getText("notificationsFailedExecuteAction"))}).finally(()=>{this._bRemoving=false;s.setBusy(false)})},formatShowNoDataIllustration:function(t,e){return this._oItemSet.size===0&&!t&&!e}})});
//# sourceMappingURL=NotificationsList.controller.js.map