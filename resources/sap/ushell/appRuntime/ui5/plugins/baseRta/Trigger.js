/*!
 * Copyright (c) 2009-2025 SAP SE, All Rights Reserved
 */
sap.ui.define(["sap/ui/thirdparty/hasher","sap/ui/core/BusyIndicator","sap/ui/core/EventBus","sap/ui/core/Lib","sap/ushell/appRuntime/ui5/plugins/baseRta/BaseRTAPluginStatus","sap/ushell/appRuntime/ui5/plugins/baseRta/AppLifeCycleUtils"],function(t,i,e,s,n,r){"use strict";var o=n.STATUS_STARTING;var a=n.STATUS_STARTED;var h=n.STATUS_STOPPING;var u=n.STATUS_STOPPED;var p=function(t){this.mConfig=t;this.sStatus=n.STATUS_STOPPED;this.oStartingPromise=null;this.oStoppingPromise=null;var i=r.getContainer();i.registerDirtyStateProvider(this._dirtyStateProvider.bind(this));this.oInitPromise=i.getServiceAsync("URLParsing").then(function(t){this.oURLParsingService=t}.bind(this)).catch(function(t){throw new Error("Error during retrieval of URLParsing ushell service: "+t)})};function l(){return new Promise(function(t,i){sap.ui.require(["sap/ui/rta/api/startAdaptation"],t,i)})}function c(){return r.getCurrentRunningApplication().then(function(t){return t.componentInstance})}function g(t,i){var e;if(t instanceof Error){e=i.getText("TECHNICAL_ERROR")}else if(typeof t==="string"){e=t}sap.ui.require(["sap/ui/rta/Utils","sap/m/MessageBox"],function(t,s){s.error(e,{title:i.getText("ERROR_TITLE"),onClose:null,styleClass:t.getRtaStyleClassName()})})}p.prototype.getInitPromise=function(){return this.oInitPromise};p.prototype._onRtaFailed=function(t){i.hide();this._oRTA=t.getSource();this.mConfig.onErrorHandler();g(t.getParameter("error"),this.mConfig.i18n)};p.prototype._startRta=function(){this.sStatus=o;e.getInstance().subscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);e.getInstance().subscribe("sap.ushell","appKeepAliveDeactivate",this._onAppClosed,this);i.show(0);var n;return c().then(function(t){n=t;return s.load({name:"sap.ui.rta"})}).then(l.bind(this)).then(function(i){this.sOldHash=t.getHash();var e={rootControl:n,flexSettings:{layer:this.mConfig.layer,developerMode:this.mConfig.developerMode}};return i(e,this.mConfig.loadPlugins,this.mConfig.onStartHandler,this._onRtaFailed.bind(this),this.mConfig.onStopHandler)}.bind(this)).then(function(t){i.hide();this._oRTA=t;this.sStatus=a}.bind(this)).catch(function(t){i.hide();if(t.reason==="flexEnabled"){this.handleFlexDisabledOnStart()}this.sStatus=u}.bind(this))};p.prototype._stopRta=function(){this.sStatus=h;return this._oRTA.stop.apply(this._oRTA,arguments).then(function(){this.exitRta()}.bind(this))};p.prototype.triggerStartRta=function(){var t=this.sStatus;switch(t){case o:break;case a:this.oStartingPromise=Promise.resolve();break;case h:this.oStartingPromise=this.oStoppingPromise.then(function(){return this._startRta()}.bind(this));break;case u:this.oStartingPromise=this._startRta();break;default:}if(t!==o){this.oStartingPromise.then(function(){this.oStartingPromise=null}.bind(this))}return this.oStartingPromise};p.prototype.triggerStopRta=function(){var t=this.sStatus;switch(t){case o:this.oStoppingPromise=this.oStartingPromise.then(function(){return this._stopRta.apply(this,arguments)}.bind(this));break;case a:this.oStoppingPromise=this._stopRta.apply(this,arguments);break;case h:break;case u:this.oStoppingPromise=Promise.resolve();break;default:}if(t!==h){this.oStoppingPromise.then(function(){this.oStoppingPromise=null}.bind(this))}return this.oStoppingPromise};p.prototype.handleFlexDisabledOnStart=function(){sap.ui.require(["sap/ui/rta/util/showMessageBox","sap/m/MessageBox"],function(t,i){t(this.mConfig.i18n.getText("MSG_FLEX_DISABLED"),{icon:i.Icon.INFORMATION,title:this.mConfig.i18n.getText("HEADER_FLEX_DISABLED"),actions:[i.Action.OK],initialFocus:null,isCustomAction:false})}.bind(this))};p.prototype._dirtyStateProvider=function(){if(this._oRTA&&this.sStatus===a){var i=t.getHash();var e=this.oURLParsingService.parseShellHash(i);var s=this.oURLParsingService.parseShellHash(this.sOldHash);this.sOldHash=i;if(e.semanticObject===s.semanticObject&&e.action===s.action&&e.appSpecificRoute!==s.appSpecificRoute){return false}return this._oRTA.canSave()}return false};p.prototype.exitRta=function(){if(this._oRTA){this._oRTA.destroy();this.sStatus=u;this.oStartingPromise=null;this.oStoppingPromise=null;this._oRTA=null}e.getInstance().unsubscribe("sap.ushell.renderers.fiori2.Renderer","appClosed",this._onAppClosed,this);e.getInstance().unsubscribe("sap.ushell","appKeepAliveDeactivate",this._onAppClosed,this)};p.prototype._onAppClosed=function(){this.triggerStopRta(true,true)};return p},true);
//# sourceMappingURL=Trigger.js.map