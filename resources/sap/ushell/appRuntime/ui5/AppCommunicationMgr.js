// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/util/deepExtend","sap/base/util/Deferred","sap/base/util/ObjectPath","sap/base/Log","sap/ushell/utils"],function(e,s,t,n,i){"use strict";var r="sap.ushell.appRuntime.ui5.AppCommunicationMgr";var a={},o=[],u=0;function g(){this.init=async function(e){var s=this;s.handleMessageEvent=g.prototype._handleMessageEvent.bind(s,s);addEventListener("message",s.handleMessageEvent);if(e===true){s.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid");setInterval(function(){s.sendMessageToOuterShell("sap.ushell.appRuntime.iframeIsValid")},2500)}const t=await this._getPostMessageInterface();t.init(false,this.registerCommHandlers.bind(this))};this._getPostMessageInterface=async function(){const[e]=await i.requireAsync(["sap/ushell/appIntegration/PostMessagePluginInterface"]);return e};this.destroy=function(){removeEventListener("message",this.handleMessageEvent)};this.registerCommHandlers=function(s){e(a,s)};this._handleMessageResponse=function(e){if(e.request_id&&o[e.request_id]){var s=o[e.request_id];delete o[e.request_id];if(e.status==="success"){s.resolve(e.body.result)}else{let t;if(e?.body?.message){t=new Error(e.body.message)}else{t=new Error("Unknown error")}if(e?.body?.stack){t.stack=e.body.stack}s.reject(t)}}};this._handleMessageRequest=function(e,s,i){var o=t.create("sap-ushell-config.services.PostMessage.config"),u=i&&i.service,g,c,d,l,p;n.debug("App Runtime received post message request from origin '"+s.origin+"': "+JSON.stringify(i),null,r);if(!u){return}if(o&&o.enabled===false){n.warning("App Runtime received message for "+c+", but this "+"feature is disabled. It can be enabled via launchpad configuration "+"property 'services.PostMessage.config.enabled: true'",undefined,r);return}if(!this._isTrustedPostMessageSource(e,s)){n.warning("App Runtime received message from untrusted origin '"+s.origin+"': "+JSON.stringify(s.data),null,r);return}if(u==="sap.ushell.services.MessageBroker"){u=u.concat("._execute")}if(u.indexOf(".")>0){g=u.split(".");d=g[g.length-1];c=u.substr(0,u.length-d.length-1)}else{n.warning("App Runtime received message with invalid service name ("+u+") :"+JSON.stringify(s.data),null,r);return}var f={oMessage:s,oMessageData:i,oContainer:e};try{l=a[c];p=l&&l.oServiceCalls[d];if(p&&p.executeServiceCallFn){try{p.executeServiceCallFn(f).then(e=>{var t=e&&e.hasOwnProperty("_noresponse_")?true:false;if(!t){this.sendResponseMessage(s,i,"success",{result:e})}},e=>{let t;let n=e;if(e instanceof Error){n=e.message;t=e.stack}this.sendResponseMessage(s,i,"error",{message:n,stack:t})})}catch(e){this.sendResponseMessage(s,i,"error",{message:e.message,stack:e.stack})}}else{n.warning("App Runtime received message with unknown service name ("+i.service+") :"+JSON.stringify(s.data),null,r)}}catch(e){n.warning("Error in processing message: "+e.message+") :"+JSON.stringify(s.data),null,r)}};this._getCFLPWindow=function(){return window.parent};this._isTrustedPostMessageSource=function(e,s){var t=false,n=e._getCFLPWindow();if(n){t=s.source===n}return t};this.sendResponseMessage=function(e,s,t,i){var a=JSON.stringify({type:"response",service:s.service,request_id:s.request_id,status:t,body:i});n.debug("Sending post message response to origin ' "+e.origin+"': "+a,null,r);if(typeof e.source!=="object"||e.source===null){n.debug("Cannot send response message to origin ' "+e.origin,"`source` member of request message is not an object",r);return}e.source.postMessage(a,e.origin)};this._getTargetWindow=function(){return window.parent};this.postMessage=function(e){var s,t=this._getTargetWindow();if(e){try{if(e.type==="request"&&!e.request_id){e.request_id=this.getId()}s=JSON.stringify(e);t.postMessage(s,"*")}catch(s){n.error("Message '"+e+"' cannot be posted: "+s,"sap.ui5Isolation.AppCommunicationMgr")}}};this.sendMessageToOuterShell=function(e,t,n,i,r){const a=new s;const u={type:"request",service:e,body:t||{},request_id:n};this.postMessage(u);o[u.request_id]=a;if(i){setTimeout(function(){a.resolve(r)},i)}return a.promise};this.getId=function(){return"SAPUI5_APPRUNTIME_MSGID_"+ ++u}}g.prototype._handleMessageEvent=function(e,s){if(s===undefined){return}var t=s.data;if(typeof t==="string"){try{t=JSON.parse(s.data,this)}catch(e){n.debug("Message received from origin '"+s.origin+"' cannot be parsed: "+e,t,r);return}}if(t.type==="request"){return e._handleMessageRequest(e,s,t)}else if(t.type==="response"){return e._handleMessageResponse(t)}};return new g});
//# sourceMappingURL=AppCommunicationMgr.js.map