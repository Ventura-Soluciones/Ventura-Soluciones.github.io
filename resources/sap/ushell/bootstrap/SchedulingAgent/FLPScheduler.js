// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/ui/performance/trace/FESR","sap/ushell/bootstrap/SchedulingAgent/state","sap/base/util/LoaderExtensions","sap/base/Log","sap/ushell/Config","sap/ushell/state/StateManager"],function(e,o,n,t,a,i){"use strict";var d={Loaded:"loaded",Wait:"wait",Step:"step",Error:"error",BlockDone:"blockDone",Start:"start",Done:"done",Skipped:"skipped"};var s="sap/ushell/bootstrap/SchedulingAgent/LoadingConfiguration.json";var l="sap/ushell/bootstrap/SchedulingAgent/StepConfiguration.json";var r={oSchedule:{iBlockIndex:0,aBlocksLoading:[]},initializeSchedule:function(){var e=n.loadResource(l,{async:true});var t=n.loadResource(s,{async:true});var a=Promise.all([e,t]).then(function(e){this._adaptForSpecialEvents(e);var n=e[0];var t=e[1];var a=this._validateConfig(t,n);if(a){this.oSchedule.oBlocks=t.LoadingBlocks;this.oSchedule.oSteps=n;this.oSchedule.aBlockOrder=t.OrderOfLoadingBlocks;this.oSchedule.iBlockIndex=0;o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.Initialized,"Schedule validated")}else{o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.WrongConfiguration,"Configuration error")}return a}.bind(this));return a},getNextLoadingStep:function(){var e={sStatus:d.Start,oContent:{}};if(this.oSchedule.aBlocksLoading.length===0){var n=this._startLoadingBlock();if(n){e.sStatus=d.Done;return e}}var t=true;var a=false;var i,s,l,r,c,p,u,S,g;for(var h=0;h<this.oSchedule.aBlocksLoading.length;h++){i=this.oSchedule.aBlocksLoading[h];s=this.oSchedule.oBlocks[i];l=s.iStepIndex;r=s.LoadingSteps[l];c=l===s.LoadingSteps.length-1;p=this._checkAndUpdateAsyncQueue(s);g=o.isStepLoaded(r.LoadingStep)||o.isStepSkipped(r.LoadingStep);S=o.isStepLoading(r.LoadingStep);t=p.bAllStepsDone&&g;a=p.bAStepIsLoading||S;if(S&&!r.canBeLoadedAsync||a&&c){e.sStatus=d.Wait;continue}if(!c||!g&&!S){if(g||r.canBeLoadedAsync&&S){l+=1}e=this._prepareStepForLoading(s,i,l)}if(t&&c){u=this.oSchedule.aBlocksLoading.indexOf(i);this.oSchedule.aBlocksLoading.splice(u,1);e.sStatus=d.BlockDone;o.setForLoadingBlock(i,o.id.loadingBlock.Done,"","Block removed from loading queue")}if(e.sStatus!==d.wait){break}}return e},dumpSchedule:function(){t.debug(JSON.stringify(this.oSchedule))},_adaptForSpecialEvents:function(o){const n=o[0];if(n.ConditionalWaitForAppLoading&&e.getActive()===false){n.ConditionalWaitForAppLoading={loadingMode:"waitInMs",waitInMs:{waitingTime:3e3},mandatoryShellModeAndLaunchpadStates:[{shellMode:"default",launchpadState:"app"}]};t.info("Step 'ConditionalWaitForAppLoading' was overwritten to 3 sec timeout for apps only.","FLPScheduler")}},_matchesShellModeAndLaunchpadState:function(e,o){const n=i.getLaunchpadState();const t=i.getShellMode()||"default";let a=false;if(e&&o){a=t===e&&n===o}else if(e){a=t===e}else if(o){a=n===o}return a},_loadingIsEnabled:function(e){if(Array.isArray(e.oConfig.excludedShellModeAndLaunchpadStates)){const o=e.oConfig.excludedShellModeAndLaunchpadStates.map(({shellMode:e,launchpadState:o})=>this._matchesShellModeAndLaunchpadState(e,o));if(o.some(e=>e)){return false}}if(Array.isArray(e.oConfig.mandatoryShellModeAndLaunchpadStates)&&e.oConfig.mandatoryShellModeAndLaunchpadStates.length!==0){const o=e.oConfig.mandatoryShellModeAndLaunchpadStates.map(({shellMode:e,launchpadState:o})=>this._matchesShellModeAndLaunchpadState(e,o));return o.every(e=>e)}function o(e){return e.path&&a.last(e.path)!==e.assertionValue}if(e.oConfig.configSwitch){const n=[].concat(e.oConfig.configSwitch);if(n.some(o)){return false}}return true},_checkAndUpdateAsyncQueue:function(e){var n=[];var t,a,i;var d=true;var s=false;if(Array.isArray(e.aAsyncStepsLoading)){for(var l=0;l<e.aAsyncStepsLoading.length;l++){i=e.aAsyncStepsLoading[l];t=o.isStepLoaded(i)||o.isStepSkipped(i);a=o.isStepLoading(i);if(a){n.push(i)}d=d&&t;s=s||a}}e.aAsyncStepsLoading=n;return{bAllStepsDone:d,bAStepIsLoading:s}},_startLoadingBlock:function(){var e=false;if(this.oSchedule.iBlockIndex<this.oSchedule.aBlockOrder.length){var n=this.oSchedule.aBlockOrder[this.oSchedule.iBlockIndex];this.oSchedule.aBlocksLoading.push(n);this.oSchedule.oBlocks[n].iStepIndex=0;this.oSchedule.oBlocks[n].aAsyncStepsLoading=[];this.oSchedule.iBlockIndex+=1;o.setForLoadingBlock(n,o.id.loadingBlock.Prepared,"","Block added to the loading queue.")}else{e=true}return e},_prepareStepForLoading:function(e,n,t){var a;var i={sStatus:d.Step,oContent:e.LoadingSteps[t],oConfig:this.oSchedule.oSteps[e.LoadingSteps[t].LoadingStep]};if(!this._loadingIsEnabled(i)){i.sStatus=d.Skipped;e.iStepIndex=t;o.setForLoadingStep(i.oContent.LoadingStep,o.id.loadingStep.Skipped,"","Step set to skipped");return i}var s=this._checkDependencies(i,n);if(s.bMissing){i.sStatus=d.Error}else if(s.bAllLoaded){o.setForLoadingStep(i.oContent.LoadingStep,o.id.loadingStep.Prepared,"","Step prepared for control unit");a=i.oContent.canBeLoadedAsync;e.iStepIndex=t;if(a){o.setForLoadingStep(i.oContent.LoadingStep,o.id.loadingStep.Prepared,"","Step set on the async loading queue");e.aAsyncStepsLoading.push(i.oContent.LoadingStep)}}else{i.sStatus=d.Wait;o.setForLoadingStep(i.oContent.LoadingStep,o.id.loadingStep.WaitingForDependencies,"","Step missing dependencies")}return i},_checkDependencies:function(e,n){var t={bAllLoaded:true,bMissing:false};if(e.oConfig.Dependencies){for(var a=0;a<e.oConfig.Dependencies.length;a++){t.bAllLoaded=t.bAllLoaded&&o.isStepLoaded(e.oConfig.Dependencies[a]);if(!o.isStepLoaded(e.oConfig.Dependencies[a])&&!o.isStepLoading(e.oConfig.Dependencies[a])){o.setForLoadingStep(e.oContent.LoadingStep,o.id.loadingStep.Aborted,e.oConfig.Dependencies[a],"Missing a dependency");o.setForLoadingBlock(n,o.id.loadingBlock.Aborted,e.oConfig.Dependencies[a],"A step is missing a dependency");o.setForModule(o.id.module.flpScheduler.id,o.id.module.flpScheduler.LoadingAborted,"Dependencies can not be resolved: a dependency isn't loading before it is required.");t.bMissing=true;t.bAllLoaded=false;break}}}return t},_validateConfig:function(e,o){var n=e&&e.OrderOfLoadingBlocks&&e.LoadingBlocks&&e.OrderOfLoadingBlocks.length&&o;if(!n){return false}var t=e.OrderOfLoadingBlocks.reduce(function(n,t){n=n&&e.LoadingBlocks[t];if(n){var a=e.LoadingBlocks[t];var i=true;if(a.LoadingSteps){var d;for(var s=0;s<a.LoadingSteps.length;s++){d=a.LoadingSteps[s].LoadingStep;i=i&&o[d]}}n=n&&i}return!!n},true);return t}};return r},false);
//# sourceMappingURL=FLPScheduler.js.map