// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/thirdparty/URI","sap/ushell/ApplicationType/systemAlias","sap/ushell/ApplicationType/utils","sap/ushell/Config","sap/ushell/Container","sap/ushell/services/ClientSideTargetResolution/ParameterMapping","sap/ushell/services/ClientSideTargetResolution/Utils"],(e,t,s,n,a,r,i,o,l)=>{"use strict";function p(e,t){t.forEach(t=>{delete e[t]})}function u(e,t){return t&&t.signature&&t.signature&&t.signature.parameters&&t.signature.parameters[e]&&t.signature.parameters[e].required===true}function c(e,t){const s=u("DYNP_OKCODE",t)||u("DYNP_NO1ST",t);let n=[];if(s){return[]}const a=m(e);function r(e){return e.toUpperCase()}const i=Object.keys(a).map(r).sort();function o(e,t){if(e.length!==t.length){return false}return e.every((s,n)=>e[n]===t[n])}if(o(["DYNP_NO1ST","DYNP_OKCODE"],i)||o(["DYNP_OKCODE"],i)||o(["DYNP_NO1ST"],i)){n=Object.keys(a)}return n}function m(e){const t=l.filterObject(e,f);return t}function f(e,t){let s;if(arguments.length===1){s=e.split(/[=](.+)?/);if(s.length>1){return f.apply(null,s)}}return!(e.indexOf("sap-")===0||e.indexOf("saml")===0||e.charAt(0)==="~")}function d(e,t,s){const n=e.inbound;const o=n&&n.resolutionResult;let l;if(!(!n||!o||!o["sap.gui"]||!(o.applicationType==="TR"))){l=h(e,t,s)}else if(!(!n||!o||!(o.applicationType==="TR")||!(o.url.indexOf("/~canvas;")>=0)||!(o.url.indexOf("app/transaction/APB_LPD_CALL_")===-1))){l=b(e,t,s)}else if(!(!n||!o||!(o.applicationType==="TR")||!(o.url.indexOf("/~canvas;")>=0)||!(o.url.indexOf("app/transaction/APB_LPD_CALL_")>=0))){l=R(e,t,s)}else if(!(!n||!o||!(o.applicationType==="TR")||!(o.url.indexOf("/its/webgui")>=0)||!(o.url.indexOf("APB_LPD_CALL_")===-1))){l=O(e,t,s)}else if(!(!n||!o||!(o.applicationType==="TR")||!(o.url.indexOf("/its/webgui")>=0)||!(o.url.indexOf("APB_LPD_CALL_")!==-1))){l=S(e,t,s)}if(l){return l.then(async t=>{if(t.url){t.url=a.appendParametersToUrl("sap-iframe-hint=GUI",t.url);if(r.last("/core/extension/dap/enabled")){const e=await i.getServiceAsync("PluginManager");const s=e.isPluginConfigured(r.last("/core/extension/dap/pluginName"));t.url=a.appendParametersToUrl(`sap-load-dap=${s}`,t.url)}else{t.url=a.appendParametersToUrl("sap-load-dap=false",t.url)}}t.extendedInfo=a.getExtendedInfo(e);a.checkOpenWithPost(e,t);a.addKeepAliveToURLTemplateResult(t);return t})}throw new Error("Cannot generate TR resolution result")}function y(e,t,a,r){let i;let o;e=encodeURIComponent(e);i=`/gui/sap/its/webgui?%7etransaction=${e}&%7enosplash=1`;o=new s(i);return n.spliceSapSystemIntoURI(o,n.LOCAL_SYSTEM_ALIAS,t,a,"NATIVEWEBGUI",n.SYSTEM_ALIAS_SEMANTICS.apply,r)}function g(e,t,s,n){let r;const i=`P_OBJECT${n}`;const o=132;let l=a.getURLParsing().privparamsToString(t,"%25","%21");if(!l){return e}let p="";P("P_OBJECT",e,s,n,e=>{const t=e.replace(i,"");p=decodeURIComponent(t);if(p.length>0){p=`${p}%25`}return i});l=p+l;const u={pObjX:"",pObject:""};l.match(new RegExp(`.{1,${o}}`,"g")).map(e=>encodeURIComponent(e)).forEach((e,t)=>{let a="P_OBJECT";let r="pObject";if(t>0){a=`P_OBJ${t}`;r="pObjX"}const i=u[r].length===0?"":s;u[r]=u[r]+i+a+n+e});r=[u.pObjX,u.pObject].filter(e=>e.length>0).join(s);const c=P("P_OBJECT",e,s,n,e=>r);if(c.found){return c.query}return e+(e.length===0?"":s)+r}function P(e,t,s,n,a){let r=false;const i=e+n;const o=t.split(s).map(e=>{if(e.indexOf(i)!==0){return e}r=true;return a(e)}).filter(e=>typeof e!=="undefined").join(s);return{found:r,query:o}}function S(e,r,i){const o=e.inbound;const l=o&&o.resolutionResult;const p={};const u=new s(r);const c=t({},e.mappedIntentParamsPlusSimpleDefaults);const m=c["sap-system"]&&c["sap-system"][0];const f=c["sap-system-src"]&&c["sap-system-src"][0];p["sap-system"]=m;delete c["sap-system"];if(typeof f==="string"){p["sap-system-src"]=f;delete c["sap-system-src"]}return n.spliceSapSystemIntoURI(u,l.systemAlias,m,f,"NATIVEWEBGUI",l.systemAliasSemantics||n.SYSTEM_ALIAS_SEMANTICS.applied,i).then(e=>{const t=e.search();const s=t.split("&").map(e=>{let t;if(e.indexOf("?%7etransaction")===0||e.indexOf("%7etransaction")===0){t=g(e,c,"%3b","%3d");return t}return e}).join("&");e.search(s);["additionalInformation","applicationDependencies"].forEach(e=>{if(o.resolutionResult.hasOwnProperty(e)){p[e]=o.resolutionResult[e]}});p.url=e.toString();p.text=o.title;p.applicationType="TR";a.setSystemAlias(p,o.resolutionResult);return p})}function h(e,t,s){const n=e.inbound;const r=n&&n.resolutionResult;const i=e.mappedIntentParamsPlusSimpleDefaults||{};let l=r.systemAlias;if(i["sap-system"]){l=i["sap-system"][0]}let p;if(i["sap-system-src"]){p=i["sap-system-src"][0]}return y(n.resolutionResult["sap.gui"].transaction,l,p,s).then(t=>{o.mapParameterNamesAndRemoveObjects(e);const s=T(e.inbound,e.mappedIntentParamsPlusSimpleDefaults,t);if(s&&e.inbound&&e.inbound.resolutionResult&&e.inbound.resolutionResult["sap.platform.runtime"]){s["sap.platform.runtime"]=e.inbound.resolutionResult["sap.platform.runtime"]}s["sap-system"]=l;a.setSystemAlias(s,n.resolutionResult);return s})}function R(e,r,i){const o=e.inbound;const l=o&&o.resolutionResult;const p={};const u=new s(r);const c=t({},e.mappedIntentParamsPlusSimpleDefaults);const m=c["sap-system"]&&c["sap-system"][0];const f=c["sap-system-src"]&&c["sap-system-src"][0];p["sap-system"]=m;delete c["sap-system"];if(typeof f==="string"){p["sap-system-src"]=f;delete c["sap-system-src"]}return n.spliceSapSystemIntoURI(u,l.systemAlias,m,f,"WEBGUI",l.systemAliasSemantics||n.SYSTEM_ALIAS_SEMANTICS.applied,i).then(e=>{let t=e.search();t=g(t,c,"&","=");e.search(t);["additionalInformation","applicationDependencies"].forEach(e=>{if(o.resolutionResult.hasOwnProperty(e)){p[e]=o.resolutionResult[e]}});p.url=e.toString();p.text=o.title;p.applicationType="NWBC";a.setSystemAlias(p,o.resolutionResult);return p})}function b(e,r,i){const o=e.inbound;const l=o&&o.resolutionResult;const u={};const m=new s(r);const f=t({},e.mappedIntentParamsPlusSimpleDefaults);const d=f["sap-system"]&&f["sap-system"][0];const y=f["sap-system-src"]&&f["sap-system-src"][0];u["sap-system"]=d;delete f["sap-system"];if(typeof y==="string"){u["sap-system-src"]=y;delete f["sap-system-src"]}const g=c(f,o||{});p(f,g);return n.spliceSapSystemIntoURI(m,l.systemAlias,d,y,"WEBGUI",u.systemAliasSemantics||n.SYSTEM_ALIAS_SEMANTICS.applied,i).then(e=>{const t=a.getURLParsing().paramsToString(f);let s=e.search();if(t){s=s+(s.indexOf("?")<0?"?":"&")+t}e.search(s);["additionalInformation","applicationDependencies"].forEach(e=>{if(o.resolutionResult.hasOwnProperty(e)){u[e]=o.resolutionResult[e]}});u.url=e.toString();u.text=o.title;u.applicationType="NWBC";a.setSystemAlias(u,o.resolutionResult);return u})}function O(e,a,r){const i=e.inbound;const o=i&&i.resolutionResult;const l={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true,"sap-system-src":true};const p=new s(a);const u=t({},e.mappedIntentParamsPlusSimpleDefaults);const c=u["sap-system"]&&u["sap-system"][0];const m=u["sap-system-src"]&&u["sap-system-src"][0];Object.keys(u).forEach(e=>{if(l[e.toLowerCase()]){delete u[e]}});return n.spliceSapSystemIntoURI(p,o.systemAlias,c,m,"NATIVEWEBGUI",o.systemAliasSemantics||n.SYSTEM_ALIAS_SEMANTICS.applied,r).then(t=>{const s=T(e.inbound,e.mappedIntentParamsPlusSimpleDefaults,t);return s})}function T(s,n,r){const i={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true,"sap-system":true};const o={};const l=t({},n);const u=l["sap-system"]&&l["sap-system"][0];const m=l["sap-system-src"]&&l["sap-system-src"][0];o["sap-system"]=u;if(typeof m==="string"){o["sap-system-src"]=m}Object.keys(l).forEach(e=>{if(i[e.toLowerCase()]){delete l[e]}});const d=c(l,s||{});p(l,d);const y=I(l);p(l,Object.keys(y));const g=r.search();let P=g.split("&").map(t=>{let s;if(!f(t)){if(t.indexOf("=")>=0){s=t.split("=");if(!y.hasOwnProperty(s[0])){y[s[0]]=s[1]}}else{e.error("Found no '=' separator of Webgui non-business parameter. Parameter will be skipped.",`'${t}'`,"sap.ushell.services.ClientSideTargetResolution")}return undefined}let n;if(t.indexOf("?%7etransaction")===0||t.indexOf("%7etransaction")===0){n=A(t,l,"%3b","%3d");return n}return t}).filter(e=>typeof e!=="undefined").join("&");const S=a.getURLParsing().paramsToString(y);P=[P,S.replace("~","%7e")].join("&");r.search(P);["additionalInformation","applicationDependencies","sap.platform.runtime"].forEach(e=>{if(s.resolutionResult.hasOwnProperty(e)){o[e]=s.resolutionResult[e]}});o.url=r.toString();o.text=s.title;o.applicationType="TR";a.setSystemAlias(o,s.resolutionResult);return o}function I(e){let t;t=l.filterObject(e,(e,t)=>!f(e,t));return t}function E(e){const t="^(.+?)(%20|(%20)(.+))?$";const s=new RegExp(t,"i");let n;const a={hasParameters:null,transactionParamName:"",transactionCode:"",parameters:[]};const r=e.split("=");if(r.length>2){return{error:"Found more than one assignment ('=') in the transaction query parameter",details:`Only one '=' sign is expected in ${e}`}}if(r.length<2||typeof r[1]==="undefined"||r[1].length===0){return{error:"The transaction query parameter must specify at least the transaction name",details:`Got ${e} instead.`}}a.transactionParamName=r[0];n=r[1];const i=n.match(s);if(!i){return{error:"Cannot parse ~transaction query parameter value.",details:`${n} should match /${t}/`}}a.transactionCode=i[1];if(i[2]&&i[2]!=="%20"){const e=i[4]||"";e.split("%3b").forEach(e=>{const t=e.split("%3d");const s=t[0];if(s&&typeof s==="string"&&s.length>0){a.parameters.push({name:s,value:t[1]})}})}a.hasParameters=false;if(a.parameters.length>0){a.hasParameters=true;a.transactionCode=a.transactionCode.replace(/^[*]/,"")}return a}function A(t,s){const n=E(t);if(n.error){e.error(n.error,n.details,"sap.ushell.services.ClientSideTargetResolution");return t}const r=n.parameters.map(e=>`${e.name.toUpperCase()}%3d${e.value}`);const i=C(s);const o={};Object.keys(s).forEach(e=>{o[e.toUpperCase()]=s[e]});let l=a.getURLParsing().privparamsToString(o,"%3b","%3d");if(l){if(Object.keys(s).length>0){l+="%3b"}r.push(l)}const p=r.length>0;return`${n.transactionParamName}=${p&&(i===""||i==="1")?"*":""}${n.transactionCode}${p?"%20":""}${r.join("%3b")}`}function C(e){let t="";if(e.hasOwnProperty("DYNP_SKIP_SEL_SCREEN")){const s=e.DYNP_SKIP_SEL_SCREEN[0];delete e.DYNP_SKIP_SEL_SCREEN;if(s===""||s===" "||s==="0"||s===0||typeof s==="string"&&s.toLowerCase()==="false"){t="0"}else if(s==="1"||s===1||typeof s==="string"&&s.toLowerCase()==="true"){t="1"}}return t}function _(e,t,s){return new Promise((n,r)=>{let i;if(e.params["sap-system-src"]){i=e.params["sap-system-src"][0]}const l=e.params["sap-system"]?e.params["sap-system"][0]:undefined;const p=e.params["sap-ui2-tcode"]?e.params["sap-ui2-tcode"][0]:undefined;y(p,l,i,s).then(e=>{delete t.intentParamsPlusAllDefaults["sap-ui2-tcode"];o.mapParameterNamesAndRemoveObjects(t);const s=T(t.inbound,t.mappedIntentParamsPlusSimpleDefaults,e);if(s&&t.inbound&&t.inbound.resolutionResult&&t.inbound.resolutionResult["sap.platform.runtime"]){s["sap.platform.runtime"]=t.inbound.resolutionResult["sap.platform.runtime"]}s["sap-system"]=l;s.text=p;s.url=a.appendParametersToUrl("sap-iframe-hint=GUI",s.url);n(s)}).catch(e=>{r(e)})})}return{generateTRResolutionResult:d,resolveEasyAccessMenuIntentWebgui:_,getUnnecessaryWebguiParameters:c,removeObjectKey:p,getExplicitSkipSelectionScreenParameter:C,injectEffectiveParametersIntoWebguiQueryParam:A,injectEffectiveParametersIntoWebguiPobjectParam:g,amendGuiParam:P,parseWebguiTransactionQueryParam:E,getWebguiNonBusinessParameters:I,getWebguiBusinessParameters:m,isWebguiBusinessParameter:f,buildNativeWebGuiURI:y,constructFullWebguiResolutionResult:h}});
//# sourceMappingURL=guiResolution.js.map