// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/ui/thirdparty/hasher","sap/base/util/ObjectPath","sap/ushell/utils","sap/ushell/User","sap/ushell/Config","sap/ui/thirdparty/URI","sap/ui/core/routing/History","sap/ushell/ApplicationType/utils","sap/base/util/deepClone","sap/base/util/isPlainObject","sap/ushell/Container","sap/ushell/ApplicationType/guiResolution","sap/ushell/utils/UrlParsing","sap/ushell/ApplicationType/systemAlias"],function(e,a,t,n,r,i,s,p,o,l,u,d,m,c,f,h){"use strict";var g=new p(document.URL).search(true),v=g["iframe-url"];function P(a,i,s){return new Promise(function(i){sap.ui.require(["sap/ushell/URLTemplateProcessor"],function(s){var p=a.inbound;var o=p.templateContext;var d=o.payload.capabilities||{};if(sap?.cf?.config?.siteId!==undefined&&o?.siteAppSection["sap.integration"]?.navMode==="inplace"){e.warning("URL template's navigationMode capability is ignored! navigationMode is forced to 'embedded'.");d.navigationMode="embedded"}if(a.mappedIntentParamsPlusSimpleDefaults&&a.mappedIntentParamsPlusSimpleDefaults.hasOwnProperty("sap-ushell-innerAppRoute")){var c=t.getHash();if(a.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"].length>0&&c.indexOf("&/")===-1){c+="&/"+a.mappedIntentParamsPlusSimpleDefaults["sap-ushell-innerAppRoute"];t.replaceHash(c)}}f.removeParametersWithEmptyValue(a.mappedIntentParamsPlusSimpleDefaults,["sap-system"]);var g={innerAppRoute:x(o)||a.parsedIntent.appSpecificRoute,targetNavMode:C(a),defaultParameterNames:a.mappedDefaultedParamNames,startupParameter:a.mappedIntentParamsPlusSimpleDefaults,remoteApplication:{remoteSO:undefined,remoteAction:undefined}};L().then(function(t){g.env=t;var c=n.get(["sap.integration","urlTemplateParams","query"],o.siteAppSection)||{};if(c.hasOwnProperty("sap-cssurl")){g.env.themeServiceRoot=undefined;g.env.theme=undefined}if(d.appFrameworkId==="UI5"&&g.startupParameter){for(var f in g.startupParameter){if(f!=="sap-ushell-innerAppRoute"){g.startupParameter[f][0]=encodeURIComponent(g.startupParameter[f][0])}if(f==="sap-shell-so"){g.remoteApplication.remoteSO=g.startupParameter[f][0]}if(f==="sap-shell-action"){g.remoteApplication.remoteAction=g.startupParameter[f][0]}}if(a.mappedDefaultedParamNames&&a.mappedDefaultedParamNames.length>0){var P=a.mappedDefaultedParamNames.filter(function(e){return e!=="sap-shell-so"&&e!=="sap-shell-action"&&e!=="sap-system"});g.startupParameter["sap-ushell-defaultedParameterNames"]=[JSON.stringify(P)]}delete g.startupParameter["sap-shell-so"];delete g.startupParameter["sap-shell-action"]}var S="/universal_search/search";var T=g.innerAppRoute&&g.innerAppRoute.indexOf(S);var R;if(T===0){R=g.innerAppRoute.substring(1);g.innerAppRoute="/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE"}const U=r.getMember(o.siteAppSection,"sap|integration.urlTemplateId");let L=o.payload;if(U==="urltemplate.gui"){L=u(o.payload,20);E(L,g,p)}L=M(U,L,c);var x=s.expand(L,o.site,g,o.siteAppSection,"startupParameter");if(T===0){x=x.replace("/JAMSEARCHPATHH?JAMSEARCHVALUEE=VALUEE","/"+R)}if(g.env.theme===undefined){x=x.replace("&sap-theme=","")}if(d.appFrameworkId==="UI5"&&H.getBrowserHash().length>1){x=x.split("#")[0]+H.getBrowserHash();e.debug("- created URL with fixed hash: "+x,"sap.ushell.ApplicationType")}var C=function(e){var a=u(o.payload,20);a.urlTemplate=e;return s.expand(a,o.site,g,o.siteAppSection,"startupParameter")};var O=o.siteAppSection["sap.app"]&&o.siteAppSection["sap.app"].destination||o.siteAppSection.destination||"";var q=o?.siteAppSection["sap.app"]?.contentProviderId||"";var D=h.getSystemAliasInProvider(O,q);var N={applicationType:"URL",text:p.title,appCapabilities:I(d,o.siteAppSection,C),url:x,extendedInfo:l.getExtendedInfo(a,o.siteAppSection,o.site),contentProviderId:p.contentProviderId||"",systemAlias:D};l.addIframeCacheHintToURL(N,N.appCapabilities.appFrameworkId);l.addKeepAliveToURLTemplateResult(N);A(N);y(N,o.siteAppSection,g);var k=new Promise(function(e){m.getServiceAsync("URLTemplate").then(function(a){sap.ui.require(["sap/ushell/appIntegration/ApplicationContainerCache"],function(t){var n=!t.findFreeContainerByUrl(N.url);a.handlePostTemplateProcessing(N.url,o.siteAppSection,n).then(e)})})});k.then(function(e){if(v&&e.indexOf("ui5appruntime.html")>0){var a=e.split("?");a[0]=v;e=a.join("?")}N.url=e;w(s,N.url,d,o).then(function(e){N.url=e;if(N.url&&typeof N.url==="string"&&N.url.indexOf("sap-iframe-hint=GUI")>0){i(N)}else{b(N.url,g.targetNavMode,d).then(function(e){N.url=e;i(N)},function(){i(N)})}})})})})})}function A(e){if(e.url&&typeof e.url==="string"){let a=e.url,t=s.last("/core/spaces/enabled"),n=a.indexOf("ui5appruntime.html")>-1,r=a.indexOf("ui5appruntimescube.html")>-1;if(t===true&&(n||r)){l.appParameterToUrl(e,"sap-spaces",t)}}}function y(e,a,t){var r=n.get(["sap.integration","urlTemplateId"],a);if(r==="urltemplate.url-dynamic"&&e.url.includes("sap/bc/bsp/sap/crm_ui_start/")&&!e.url.includes("sap-language=")){l.appParameterToUrl(e,"sap-language",t.env.language)}}function b(e,a,t){return new Promise(function(n,r){var i=new p(e);var s=i.query(true);var o=true;var l=["sap-language","sap-theme","sap-shell","sap-ui-app-id","transaction","sap-iframe-hint","sap-keep-alive","sap-ui-versionedLibCss","sap-wd-configId","wcf-target-id"];if(t&&t.mandatoryUrlParams){l=l.concat(t.mandatoryUrlParams.split(","));l=l.filter(function(e,a){return l.indexOf(e)===a})}if(a==="explace"){o=false}m.getServiceAsync("ShellNavigationInternal").then(function(a){a.compactParams(s,l,undefined,o).done(function(a){if(!a.hasOwnProperty("sap-intent-param")){n(e);return}var t;if(a["sap-theme"]){var r="sap-theme="+a["sap-theme"];a["sap-theme"]="sap-theme-temp-placeholder";i.query(a);t=i.toString();t=t.replace("sap-theme=sap-theme-temp-placeholder",r)}else{i.query(a);t=i.toString()}n(t)}).fail(function(e){r(e)})})})}function w(a,t,r,i){return new Promise(function(s){var o=r.urlTransformation||{enabled:false};if(S(a,o,i)){var l=new p(t);var u=o.transformations[0];var d=u.service.uri;var m=a.prepareExpandData({urlTemplate:"",parameters:{names:d.queryOptions}},{},{urlComponent:{query:l.query(),fragment:l.fragment()}},i.siteAppSection,"");var c=p.expand("{+rootPath}/{+resourcePath}{?queryParams*}",{rootPath:d.rootPath,resourcePath:d.resourcePath,queryParams:m.oResolvedParameters}).toString();sap.ui.require(["sap/ui/thirdparty/datajs"],function(a){a.read({requestUri:c,headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}},function(a){var r=n.get("transformAppLaunchQueryString.value",a);if(r===undefined){r=n.get("transformAppLaunchIntent.value",a)}if(r===undefined){r=n.get("transformAppLaunchQueryString.queryString",a)}e.info("URL Transformation Succeeded",JSON.stringify({URLBeforeTransformation:t,URLAfterTransformation:r}),"sap.ushell.ApplicationType");var i=u.sourceURLComponent;if(i===undefined){i="query"}if(i==="query"||i==="fragment"){t=l[i](r).toString()}else{e.error("The "+i+" component of the URL in URI.js is not transformed","","sap.ushell.ApplicationType")}s(t)},function(a){e.error("URL Transformation Failed",JSON.stringify(a),"sap.ushell.ApplicationType");s(t)})})}else{s(t)}})}function S(e,a,t){if(typeof a.enabled==="boolean"){return a.enabled}var n=e.prepareExpandData({urlTemplate:"",parameters:{names:{enabled:a.enabled}}},{},{},t.siteAppSection,"");return typeof n.oResolvedParameters.enabled==="boolean"?n.oResolvedParameters.enabled:false}function T(a,t){var n=r.getMember(t,"sap|integration.navMode");switch(n){case"inplace":if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"embedded"}e.error("App-defined navigation mode was ignored","Application requests to be opened inplace, but the template's navigation mode doesn't allow!","sap.ushell.ApplicationType");return"newWindow";case"explace":if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"newWindowThenEmbedded"}if(["standalone","explace","newWindow"].includes(a)){return"newWindow"}default:e.error("App-defined navigation mode is not valid!","Fallback to URL Template's capability","sap.ushell.ApplicationType");if(["embedded","inplace","newWindowThenEmbedded"].includes(a)){return"embedded"}return"newWindow"}}function R(e){if(["embedded","inplace","newWindowThenEmbedded"].includes(e)){return"embedded"}if(["standalone","explace","newWindow"].includes(e)){return"standalone"}}function I(e,a,t){var n=u(e);n.navigationMode=T(e.navigationMode,a);n.templateNavigationMode=R(e.navigationMode);n.appId=t(e.appId||"");n.technicalAppComponentId=t(e.technicalAppComponentId||"");n.appSupportInfo=a["sap.app"]&&a["sap.app"].ach;n.appFrameworkId=e.appFrameworkId;delete n.urlTransformation;return n}function U(){var e=t&&t.getHash();var a="";if(e&&e.length>0&&e.indexOf("sap-iapp-state=")>0){var n=/(?:sap-iapp-state=)([^&/\\]+)/.exec(e);if(n&&n.length===2){a=n[1]}}return a}function L(){return new Promise(function(e){Promise.all([m.getServiceAsync("UserInfo"),m.getServiceAsync("PluginManager"),r.getUi5Version()]).then(function(t){var n=t[0];var r=t[1];var p=t[2];var l=n.getUser();var u=l.getContentDensity()||(document.body.classList.contains("sapUiSizeCompact")?"compact":"cozy");var d=l.getTheme();if(d.indexOf("sap_")!==0){var m=i.prototype.constants.themeFormat.THEME_NAME_PLUS_URL;d=l.getTheme(m)}var c=a.getLanguage();var f=a.getSAPLogonLanguage();var h=window.location.protocol+"//"+window.location.host+"/comsapuitheming.runtime/themeroot/v1";var g=0;if(s.last("/core/shell/sessionTimeoutIntervalInMinutes")>0){g=s.last("/core/shell/sessionTimeoutIntervalInMinutes")}var v=false;if(window["sap-ui-debug"]!==false&&window["sap-ui-debug"]!==undefined){v=window["sap-ui-debug"]}const P=s.last("/core/shell/enablePersonalization");e({language:c,logonLanguage:f,theme:d,themeServiceRoot:h,isDebugMode:v,ui5Version:p,contentDensity:u,sapPlugins:r._getNamesOfPluginsWithAgents(),innerAppState:U(),sessionTimeout:g,historyDirection:o.getInstance().getDirection()||"",enableShellPersonalization:P})})})}function x(a){var n=a.payload;var r;var i=t.getHash()||H.getBrowserHash();var s=i.indexOf("&/");var p=1;var o=false;if(a.siteAppSection?.["sap.integration"]?.urlTemplateId==="urltemplate.jam"){o=true}if(s>0){if(n&&n.capabilities&&n.capabilities.appFrameworkId==="UI5"){p=2}r=i.substring(s+p);try{if(!o&&r&&r.length>0){r=decodeURIComponent(r)}}catch(a){e.warning("inner route should be double encoded",a,"sap.ushell.ApplicationType.getInnerAppRoute")}}return r}function C(e){var a=e.targetNavigationMode;if(a===undefined||a===""){if(r.isColdStart()){a="explace"}else{a="inplace"}}return a}function O(){return window.location.hash}function E(e,a,t){if(d(a.startupParameter)&&Object.keys(a.startupParameter).length>0){a.startupParameter=u(a.startupParameter);const n={"sap-wd-run-sc":true,"sap-wd-auto-detect":true,"sap-ep-version":true};Object.keys(a.startupParameter).forEach(function(e){if(n[e.toLowerCase()]){delete a.startupParameter[e]}});const r=c.getUnnecessaryWebguiParameters(a.startupParameter,t||{});c.removeObjectKey(a.startupParameter,r);const i=c.getWebguiNonBusinessParameters(a.startupParameter);c.removeObjectKey(a.startupParameter,Object.keys(i));const s=c.getExplicitSkipSelectionScreenParameter(a.startupParameter);if(e?.parameters?.names?.skipScreenChar.length>0){e.parameters.names.skipScreenChar=Object.keys(a.startupParameter).length>0&&(s===""||s==="1")?"*":""}}}function M(e,a,t){try{if(e==="urltemplate.url"&&t.hasOwnProperty("sapit-external-ui5app")){const e=u(a,20);e.urlTemplate=e.urlTemplate.replace(",paramSapLocale",",appStartupParameters,paramSapLocale");e.parameters.names={...e.parameters.names};e.parameters.names["appStartupParameters"]={renameTo:"sap-startup-params",value:"{*|match(^(?!sap-ushell(-innerAppRoute\\|-navmode)$))|join(&,=)}"};return e}}catch(e){}return a}var H={generateURLTemplateResolutionResult:P,handleURLTransformation:w,getBrowserHash:O,_createEnv:L,_addLanguageToURLTemplateResult:y};return H});
//# sourceMappingURL=urlTemplateResolution.js.map