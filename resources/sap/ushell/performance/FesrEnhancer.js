// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ui/performance/trace/FESR","sap/ushell/EventHub","sap/ushell/performance/ShellAnalytics"],function(e,t,n,r,a){"use strict";const s="FesrEnhancer";const i="[FesrFlp]";const o={HOME_INITIAL:"FLP@LOAD",HOME_LOADING:"FLP@DURING_LOAD",FINDER_INITIAL:"FLP@LOAD_FINDER",APP_INITIAL:"FLP@DEEP_LINK",NAVIGATION:"NAVIGATION",CUSTOM_HOME_INITIAL:"FLPCUSTOMHOME"};const c=[o.HOME_INITIAL,o.FINDER_INITIAL,o.CUSTOM_HOME_INITIAL,o.APP_INITIAL];const l={APP_START:1,STEP_IN_APP:2,UNKNOWN:3};const u=["stepName","appNameLong","appNameShort","interactionType","timeToInteractive"];const p={stepName:{maxLength:20,postfix:"@H2H"},appNameShort:{maxLength:20}};const d={_fnOriginalOnBeforeCreated:null,_oLastTrackedRecord:null,init:function(){if(n.getActive()){a.enable();this._fnOriginalOnBeforeCreated=n.onBeforeCreated;n.onBeforeCreated=this._onBeforeCreatedHandler.bind(this)}},reset:function(){n.onBeforeCreated=this._fnOriginalOnBeforeCreated;a.disable();this._setLastTrackedRecord(null)},_getPerformanceEntries:function(e,t){if(t){return performance.getEntriesByName(e)}return performance.getEntriesByType("mark").filter(t=>t.name.includes(e))},_getLastTrackedApplicationId:function(){const e=a.getCurrentApplication();if(e){return e.id}return null},_getLastTrackedRecord:function(){return this._oLastTrackedRecord},_setLastTrackedRecord:function(e){this._oLastTrackedRecord=e},_getLastFesrHandle:function(){const e=this._oLastFesrHandle;this._oLastFesrHandle=undefined;return e!==undefined?e:null},_setLastFesrHandle:function(e){this._oLastFesrHandle=e},_onBeforeCreatedHandler:function(n,a){let l=t({},n);try{const{scenario:t,relatedRecord:n}=this._detectScenario(l);e.debug(`${i} identified scenario: ${t}`,null,s);const a=this._getLastTrackedApplicationId();if(a){l.appNameShort=a}let u;switch(t){case o.HOME_INITIAL:case o.CUSTOM_HOME_INITIAL:case o.FINDER_INITIAL:u=this._enhanceInitialStart(l,t,n);break;case o.APP_INITIAL:u=this._enhanceInitialAppStart(t,n);break;case o.NAVIGATION:case o.HOME_LOADING:u=this._enhanceNavigationRecord(t,n);break;default:e.debug(`${i} unknown scenario, step name: ${l.stepName}`,null,s);this._setLastFesrHandle(l);return l}if(c.includes(t)){r.emit("startUpFesrEnhanced",Date.now())}u=this.sanitizeEnhancement(u);l={...l,...u};e.debug(`${i} passing enhancements:`,JSON.stringify(u,null,2),s)}catch(t){e.error(`${i} Could not enhance the FESR:`,t,s)}e.debug(`${i}      => UI5: ${l.stepName} - ${l.appNameShort}`,null,s);this._setLastFesrHandle(l);return l},shortenAccordingToFormatter:function(e,t){var n="";if(t&&t.maxLength){n=e.substring(0,t.maxLength)}else{n=e}return n},shortenWithPostfix:function(e,t){const n=p[t];if(n){if(n.postfix){if(e.endsWith(n.postfix)){const t={...n,maxLength:n.maxLength-n.postfix.length};const r=this.shortenAccordingToFormatter(e.slice(0,-1*t.postfix.length),t);return r+t.postfix}}return this.shortenAccordingToFormatter(e,n)}return e},sanitizeEnhancement:function(e){return Object.keys(e).reduce((t,n)=>{const r=e[n];if(u.includes(n)&&!!r){t[n]=this.shortenWithPostfix(r,n)}return t},{})},_getRelevantPerformanceMark:function(t){if(!t){e.warning(`${i} Could not determine performance mark`,"No Statistical Record found",s);return}const n=[];if(t.getTargetIsHomeApp()){n.push(this._getPerformanceEntries("FLP-TTI-Homepage-Custom",true)[0])}else{switch(t.getTargetApplication()){case"FLP_HOME":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);break;case"FLP_PAGE":n.push(this._getPerformanceEntries("FLP-TTI-Homepage",true)[0]);n.push(this._getPerformanceEntries("FLP-Pages-Service-loadPage-end",false)[0]);break;case"FLP_FINDER":n.push(this._getPerformanceEntries("FLP-TTI-AppFinder",true)[0]);break;default:}}return n.filter(e=>{if(!e){return false}if(typeof e.startTime!=="number"){return false}if(e.startTime>t.getTimeStart()){return true}return false})[0]},_detectScenario:function(t){if(t.stepName==="undetermined_startup"){let n;const r=a.getLastClosedRecord();if(r){this._setLastTrackedRecord(r)}else{e.warning(`${i} Identified undetermined_startup but could not find a closed StatisticalRecord`,null,s);return{scenario:null,relatedRecord:null}}if(r.getTargetIsHomeApp()){n=o.CUSTOM_HOME_INITIAL}else{switch(t.appNameLong){case"sap.ushell.components.homepage":case"sap.ushell.components.pages":n=o.HOME_INITIAL;break;case"sap.ushell.components.appfinder":n=o.FINDER_INITIAL;break;default:n=o.APP_INITIAL}}return{scenario:n,relatedRecord:r}}const n=this._getLastTrackedRecord();const r=a.getNextNavigationRecords(n);if(r.length){const t=r[r.length-1];if(r.length>1){const t=r.reduce((e,t,n)=>{if(n<r.length-1){e.push(t.getTargetHash())}return e},[]);e.warning(`${i} skipped Records:`,JSON.stringify(t,null,2),s)}if(n&&t.isEqual(n)){return{scenario:null,relatedRecord:null}}this._setLastTrackedRecord(t);const a=t.getStep()===o.HOME_LOADING?o.HOME_LOADING:o.NAVIGATION;return{scenario:a,relatedRecord:t}}return{scenario:null,relatedRecord:null}},_enhanceInitialStart:function(t,n,r){const a={};if(n===o.CUSTOM_HOME_INITIAL){a.stepName=n+"@"+t.appNameShort}else{a.stepName=n}a.interactionType=l.APP_START;a.appNameShort=r.getTargetAppNameShort()||r.getTargetApplication();const c=this._getRelevantPerformanceMark(r);if(c){e.debug(`${i} using performance mark: ${c.name}`,null,s);a.timeToInteractive=c.startTime}else{e.warning(`${i} Scenario ${n} detected did not found a performance mark`,null,s)}return a},_enhanceNavigationRecord:function(t,n){const r={};if(t!=="FLP@DURING_LOAD"){r.stepName=n.getStep()}if(n.getTargetApplicationType()==="UI5"){r.interactionType=l.APP_START}r.appNameShort=n.getTargetAppNameShort()||n.getTargetApplication();const a=this._getRelevantPerformanceMark(n);if(/^FLP_BACK/.test(r.stepName)&&a){e.debug(`${i} using performance mark: ${a.name}`,null,s);r.timeToInteractive=a.startTime-n.getTimeStart()}return r},_enhanceInitialAppStart:function(e,t){const n={};n.stepName=e;if(t.getTargetApplicationType()==="UI5"){n.interactionType=l.APP_START}else{n.interactionType=l.STEP_IN_APP}return n}};return d},true);
//# sourceMappingURL=FesrEnhancer.js.map