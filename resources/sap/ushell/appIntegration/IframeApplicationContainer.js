// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/uid","sap/ui/Device","sap/ui/thirdparty/URI","sap/ushell/appIntegration/ApplicationContainer","sap/ushell/appIntegration/IframeApplicationContainerRenderer","sap/ushell/appIntegration/PostMessageManager","sap/ushell/ApplicationType/UrlPostProcessing","sap/ushell/ApplicationType/systemAlias","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/System","sap/ushell/utils","sap/ushell/utils/UriParameters"],(e,t,s,i,r,a,n,o,l,p,g,h,u,f,c)=>{"use strict";const d=r.extend("sap.ushell.appIntegration.IframeApplicationContainer",{metadata:{library:"sap.ushell",properties:{visible:{type:"boolean",defaultValue:true},globalDirtyStorageKey:{defaultValue:"",type:"string"},iframeUrl:{defaultValue:"",type:"string",visibility:"hidden"},iframePostAllParams:{defaultValue:false,type:"boolean"},iframeWithPost:{defaultValue:false,type:"boolean"}},interfaces:["sap.ushell.renderer.INavContainerPage"]},renderer:a});d.prototype.init=function(){r.prototype.init.apply(this,arguments);this._aPendingRequestsWaitingForResponse=[];this.setProperty("isIframeValidTime",{time:0},true);const e=`sap.ushell.Container.dirtyState.${t()}`;this.setProperty("globalDirtyStorageKey",e,true);localStorage.removeItem(this.getGlobalDirtyStorageKey());this._fnStorageEventListener=this._handleStorageEvent.bind(this);addEventListener("storage",this._fnStorageEventListener);this._fnPagehideEventListener=this.exit.bind(this);addEventListener("pagehide",this._fnPagehideEventListener)};d.prototype.onBeforeRendering=function(){if(!this.getReadyForRendering()){return}this._attachLogoutEvent();this._initNWBCStorage();this._addRemoteSystemForUrl();this._calculateIframeUrl();this._calculateIframeWithPost();if(!this.getProperty("iframeWithPost")){const e=this.getProperty("iframeUrl");const t=l.addSystemAlias(e,this);this.setProperty("iframeUrl",t,true)}};d.prototype.onAfterRendering=async function(){if(!this.getReadyForRendering()){return}const e=await g.getServiceAsync("MessageBroker");const t=this.getPostMessageTargetOrigin();e.addAcceptedOrigin(t);if(s.os.ios&&this.$().prop("tagName")==="IFRAME"){this.$().parent().css("overflow","auto")}};d.prototype.setVisibility=function(e){this.setProperty("visible",e,true);const t=this.getDomRef();if(t){t.setAttribute("aria-hidden",!e)}if(e){this.removeStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive");return}if(this._aPendingRequestsWaitingForResponse.length>0){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}else{this.addStyleClass("sapUShellApplicationContainerIframeHidden")}};d.prototype.setDataHelpId=function(e){r.prototype.setDataHelpId.apply(this,arguments);if(!this.getDomRef()||!this.getIframeWithPost()){return this}const t=this._getIframe();if(t){t.setAttribute("data-help-id",`${e}-iframe`)}return this};d.prototype._attachLogoutEvent=function(){const e=this.getApplicationType();if(f.isApplicationTypeEmbeddedInIframe(e)){this._fnLogout=this._handleLogout.bind(this);g.attachLogoutEvent(this._fnLogout)}};d.prototype._initNWBCStorage=function(){const e=this.getApplicationType();if(f.isApplicationTypeEmbeddedInIframe(e,true)||f.isApplicationTypeEmbeddedInIframe(this.getFrameworkId())){f.localStorageSetItem(this.getGlobalDirtyStorageKey(),g.DirtyState.INITIAL)}};d.prototype._calculateIframeWithPost=function(){const e=c.fromURL(document.URL);const t=this.getApplicationType();const s=p.last("/core/shell/enableOpenIframeWithPost")??true;const i=e.get("sap-post")==="false";const r=e.get("sap-post")==="true";const a=this.getOpenWithPostByAppParam()===false;const n=["NWBC","TR","WDA","WCF"].includes(t);let o;if(r){o=true}else if(i){o=false}else if(a){o=false}else{o=s&&n}if(o&&t==="TR"){this.setProperty("iframePostAllParams",true,true)}this.setProperty("iframeWithPost",o,true)};d.prototype._calculateIframeUrl=function(){const e=this.getApplicationType();let t=this.getUrl();t=o.processUrl(t,e,false,this);t=this._injectParametersFromUrl(t);this.setProperty("iframeUrl",t,true)};d.prototype._injectParametersFromUrl=function(e){const t=c.fromURL(document.URL);if(!t.has("sap-iframe-params")){return e}const s=t.get("sap-iframe-params")||"";const r=s.split(",");if(r.length===0){return e}const a=new i(e);r.forEach(e=>{if(e&&t.has(e)){a.addQuery(e,t.get(e))}});e=a.toString();return e};d.prototype._addRemoteSystemForUrl=function(){if(this._oSystem){return}const e=this.getUrl();const t=document.createElement("a");const s=c.fromURL(e).get("sap-client");t.href=e;const i=`${t.protocol}//${t.host}`;this._oSystem=new u({alias:s?`${i}?sap-client=${s}`:i,baseUrl:i,client:s||undefined,platform:"abap"});g.addRemoteSystem(this._oSystem)};d.prototype._handleStorageEvent=function(t){if(t.key!==this.getGlobalDirtyStorageKey()){return}if(t.newValue!==g.DirtyState.PENDING){return}const s=this.getPostMessageTarget();if(!s){return}e.debug("getGlobalDirty() send pro54_getGlobalDirty ",null,"sap.ushell.appIntegration.ApplicationContainer");const i=this.getPostMessageTargetOrigin();const r=JSON.stringify({action:"pro54_getGlobalDirty"});s.postMessage(r,i)};d.prototype._handleLogout=function(e){const t=this.getPostMessageTarget();const s=this.getApplicationType();if(t&&f.isApplicationTypeEmbeddedInIframe(s)){const s=this.getPostMessageTargetOrigin();t.postMessage(JSON.stringify({action:"pro54_disableDirtyHandler"}),s);e.preventDefault()}};d.prototype._getIframe=function(){const e=this.getDomRef();if(!e||e.tagName!=="IFRAME"){if(this.getIframeWithPost()===true&&e&&e.getAttribute&&e.getAttribute("data-sap-ushell-iframe-app")==="true"){return document.getElementById(`${e.getAttribute("id")}-iframe`)}return null}return e};d.prototype.getPostMessageTarget=function(){const e=this._getIframe();return e?.contentWindow};d.prototype.getPostMessageTargetOrigin=function(){let e;const t=this._getIframe();if(!t){return""}if(this.getIframeWithPost()===true){const s=`${t.getAttribute("id").replace("-iframe","-form")}`;const r=document.getElementById(s);e=r?.action;if(e===undefined&&(new i).query(true).hasOwnProperty("sap-isolation-enabled")){e=t.src}}else{e=t.src}const s=new i(e);const r=`${s.protocol()}://${s.host()}`;return r};d.prototype.isTrustedPostMessageSource=function(e){if(!e){return false}if(e.source&&e.source===this.getPostMessageTarget()){return true}if(e.origin&&e.origin===this.getPostMessageTargetOrigin()){return true}return false};d.prototype.sendRequest=async function(e,t,s=false){if(!s){return n.sendRequest(e,t,this.getPostMessageTarget(),this.getPostMessageTargetOrigin(),false)}if(!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHiddenButActive");this.removeStyleClass("sapUShellApplicationContainerIframeHidden")}const i=n.sendRequest(e,t,this.getPostMessageTarget(),this.getPostMessageTargetOrigin(),true);this._aPendingRequestsWaitingForResponse.push(i);const r=await i;this._aPendingRequestsWaitingForResponse=this._aPendingRequestsWaitingForResponse.filter(e=>e!==i);if(this._aPendingRequestsWaitingForResponse.length===0&&!this.getProperty("visible")){this.addStyleClass("sapUShellApplicationContainerIframeHidden");this.removeStyleClass("sapUShellApplicationContainerIframeHiddenButActive")}return r};d.prototype.sendBeforeAppCloseEvent=async function(){const e=this.getBeforeAppCloseEvent&&this.getBeforeAppCloseEvent();if(e&&e.enabled&&e.enabled===true){return this.sendRequest("sap.ushell.services.CrossApplicationNavigation.beforeAppCloseEvent",e.params,true)}};d.prototype.exit=function(){localStorage.removeItem(this.getGlobalDirtyStorageKey());if(this._fnStorageEventListener){removeEventListener("storage",this._fnStorageEventListener)}if(this._fnPagehideEventListener){removeEventListener("pagehide",this._fnPagehideEventListener)}if(this._fnLogout){g.detachLogoutEvent(this._fnLogout)}r.prototype.exit.apply(this,arguments)};return d});
//# sourceMappingURL=IframeApplicationContainer.js.map