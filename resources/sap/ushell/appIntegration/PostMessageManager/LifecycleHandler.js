// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/Deferred","sap/m/library","sap/ui/thirdparty/hasher","sap/ui/thirdparty/URI","sap/ushell/appIntegration/PostMessageManager","sap/ushell/Container","sap/ushell/EventHub","sap/ushell/library","sap/ushell/resources","sap/ushell/state/ShellModel","sap/ushell/utils"],function(e,s,t,l,r,i,a,n,o,c,p,u){"use strict";const d=t.URLHelper;const h=o.appIntegration.contracts.StatefulType;const y=[(e,s)=>{if(s.service?.startsWith("sap.ushell.services.appLifeCycle")){s.service=s.service.replace(/appLifeCycle/gi,"AppLifeCycle");return new MessageEvent("message",{data:JSON.stringify(s),origin:e.origin,source:e.source})}}];const v={"sap.ushell.services.AppLifeCycle.create":{activeOnly:true},"sap.ushell.services.AppLifeCycle.destroy":{activeOnly:true},"sap.ushell.services.AppLifeCycle.store":{activeOnly:true},"sap.ushell.services.AppLifeCycle.restore":{activeOnly:true},"sap.ushell.sessionHandler.extendSessionEvent":{ignoreCapabilities:true},"sap.ushell.sessionHandler.logout":{isValidRequestTarget(e){if(",WCF,GUI,TR,WDA,".includes(e.getApplicationType())){return false}return true}}};const g={"sap.gui.loadFinished":{async handler(e,s,t){s.setStatefulType(h.ContractV1)},options:{provideApplicationContext:true,allowInactive:true}},"sap.ushell.services.AppLifeCycle.subscribe":{async handler(s,t,l){const r=s;if(!Array.isArray(r)){e.error("subscribe service call failed: capabilities must be an array");throw new Error("subscribe service call failed: capabilities must be an array")}const i=r.map(e=>`${e.service}.${e.action}`);t.addCapabilities(i)},options:{provideApplicationContext:true,allowInactive:true}},"sap.ushell.services.AppLifeCycle.setup":{async handler(e,s,t){const l=e;const r=[];if(l){if(l.isStateful){s.setStatefulType(h.ContractV2);r.push("sap.ushell.services.AppLifeCycle.create");r.push("sap.ushell.services.AppLifeCycle.destroy");const e=!u.isSAPLegacyApplicationType(s.getApplicationType(),s.getFrameworkId());if(e){r.push("sap.ushell.services.AppLifeCycle.store");r.push("sap.ushell.services.AppLifeCycle.restore")}}if(l.isIframeValid){r.push("sap.ushell.appRuntime.iframeIsValid")}if(l.session?.bLogoutSupport){r.push("sap.ushell.sessionHandler.logout")}s.addCapabilities(r)}},options:{provideApplicationContext:true,allowInactive:true}},"sap.ushell.sessionHandler.notifyUserActive":{handler:f},"sap.ushell.sessionHandler.extendSessionEvent":{handler:f},"sap.ushell.ui5service.ShellUIService.setTitle":{async handler(e,s,t){const{sTitle:l,oAdditionalInformation:r}=e;const i=s.getShellUIService();i.setTitle(l,r)},options:{provideApplicationContext:true}},"sap.ushell.ui5service.ShellUIService.setBackNavigation":{async handler(e,s,t){const l=s.getShellUIService();let r;if(e.callbackMessage?.service){r=()=>{i.sendRequest(e.callbackMessage.service,null,s.getPostMessageTarget(),s.getPostMessageTargetOrigin(),false)}}l.setBackNavigation(r)},options:{provideApplicationContext:true}},"sap.ushell.services.ShellUIService.setTitle":{async handler(e,s,t){const{sTitle:l,oAdditionalInformation:r}=e;const i=s.getShellUIService();i.setTitle(l,r)},options:{provideApplicationContext:true}},"sap.ushell.services.ShellUIService.setHierarchy":{async handler(e,s,t){const{aHierarchyLevels:l}=e;const r=s.getShellUIService();r.setHierarchy(l)},options:{provideApplicationContext:true}},"sap.ushell.services.ShellUIService.setRelatedApps":{async handler(e,s,t){const{aRelatedApps:l}=e;const r=s.getShellUIService();r.setRelatedApps(l)},options:{provideApplicationContext:true}},"sap.ushell.services.ShellUIService.setDirtyFlag":{async handler(e,s){const{bIsDirty:t}=e;a.setDirtyFlag(t)}},"sap.ushell.services.ShellUIService.showShellUIBlocker":{async handler(e,s){}},"sap.ushell.services.ShellUIService.getFLPUrl":{async handler(e,s){const t=e.bIncludeHash;return a.getFLPUrlAsync(t)}},"sap.ushell.services.ShellUIService.getShellGroupIDs":{async handler(e,s){if(true){const{bGetAll:s}=e;const t=await a.getServiceAsync("BookmarkV2");return t.getShellGroupIDs(s)}throw new Error("Bookmark.getShellGroupIDs is deprecated. Use BookmarkV2.getContentNodes instead.")}},"sap.ushell.services.ShellUIService.addBookmark":{async handler(e,s){if(true){const{oParameters:s,groupId:t}=e;const l=await a.getServiceAsync("BookmarkV2");return l.addBookmarkByGroupId(s,t)}throw new Error("Bookmark.addBookmarkByGroupId is deprecated. Use BookmarkV2.addBookmark instead.")}},"sap.ushell.services.ShellUIService.addBookmarkDialog":{async handler(e,s){const[t]=await u.requireAsync(["sap/ushell/ui/footerbar/AddBookmarkButton"]);const l=new t;l.firePress({})}},"sap.ushell.services.ShellUIService.getShellGroupTiles":{async handler(e,s){if(true){const{groupId:s}=e;const t=await a.getServiceAsync("FlpLaunchPage");const l=t.getTilesByGroupId(s);return u.promisify(l)}throw new Error("Classic homepage is deprecated.")}},"sap.ushell.services.ShellUIService.sendUrlAsEmail":{async handler(e,s){const t=p.getModel().getProperty("/application/title");let l;if(t===undefined){l=c.i18n.getText("linkToApplication")}else{l=`${c.i18n.getText("linkTo")} '${t}'`}A("",l,document.URL,"","",document.URL,true)}},"sap.ushell.services.ShellUIService.sendEmailWithFLPButton":{async handler(e,s){const{bSetAppStateToPublic:t}=e;const l=p.getModel().getProperty("/application/title");let r;if(l===undefined){r=c.i18n.getText("linkToApplication")}else{r=`${c.i18n.getText("linkTo")} '${l}'`}A("",r,document.URL,"","",document.URL,t)}},"sap.ushell.services.ShellUIService.sendEmail":{async handler(e,s){const{sTo:t,sSubject:l,sBody:r,sCc:i,sBcc:a,sIFrameURL:n,bSetAppStateToPublic:o}=e;A(t,l,r,i,a,n,o)}},"sap.ushell.services.ShellUIService.processHotKey":{async handler(e,s){const t=e;let l;try{l=new KeyboardEvent("keydown",t)}catch(e){const{altKey:s,ctrlKey:r,shiftKey:i,key:a,keyCode:n}=t;const o=document.createEvent("KeyboardEvent");let c="";if(s){c+="Alt "}if(r){c+="Control "}if(i){c+="Shift "}o.initKeyboardEvent("keydown",false,false,null,a,n,c,0,false);l=o}document.dispatchEvent(l)}},"sap.ushell.services.Container.setDirtyFlag":{async handler(e,s){const{bIsDirty:t}=e;a.setDirtyFlag(t)}},"sap.ushell.services.Container.registerDirtyStateProvider":{async handler(e,t,l){const{bRegister:r}=e;if(r){a.setAsyncDirtyStateProvider(async function(e){const l=new s;const r=setTimeout(()=>{l.resolve(false)},2500);i.sendRequest("sap.ushell.appRuntime.handleDirtyStateProvider",{oNavigationContext:e},t.getPostMessageTarget(),t.getPostMessageTargetOrigin(),true).then(e=>{if(r){clearTimeout(r)}l.resolve(e.result||false)});return l.promise})}else{a.setAsyncDirtyStateProvider()}},options:{provideApplicationContext:true}},"sap.ushell.services.Container.getFLPUrl":{async handler(e,s){const t=e.bIncludeHash;return a.getFLPUrlAsync(t)}},"sap.ushell.services.Container.getFLPConfig":{async handler(e,s){return a.getFLPConfig()}},"sap.ushell.services.Container.getFLPPlatform":{async handler(e,s){return a.getFLPPlatform()}},"sap.ushell.services.Container.attachLogoutEvent":{async handler(e,s,t){a.attachLogoutEvent(async function(){return i.sendRequest("sap.ushell.appRuntime.executeLogoutFunctions",{},s.getPostMessageTarget(),s.getPostMessageTargetOrigin(),true)},true)},options:{provideApplicationContext:true}},"sap.ushell.services.AppLifeCycle.reloadCurrentApp":{async handler(e,s){n.emit("reloadCurrentApp",{sCurrentHash:l.getHash(),date:Date.now()})}},"sap.ushell.services.AppLifeCycle.getFullyQualifiedXhrUrl":{async handler(e,s){const{path:t}=e;if(t!==""&&t!==undefined&&t!==null){const e=await a.getServiceAsync("AppLifeCycle");const s=await e.getCurrentApplication().getSystemContext();const l=s.getFullyQualifiedXhrUrl(t);let i="";let n="";let o="";const c=a.getFLPUrl(true);const p=new r(c);if(p.protocol()!==null&&p.protocol()!==undefined&&p.protocol()!==""){n=`${p.protocol()}://`}if(p.hostname()!==null&&p.hostname()!==undefined&&p.hostname()!==""){i=p.hostname()}if(p.port()!==null&&p.port()!==undefined&&p.port()!==""){o=`:${p.port()}`}const u=n+i+o+l;return u}}},"sap.ushell.services.AppLifeCycle.getSystemAlias":{async handler(e,s,t){const l=s.getCurrentAppTargetResolution();const r=l.systemAlias;const i=l.contentProviderId;const[a]=await u.requireAsync(["sap/ushell/ApplicationType/systemAlias"]);return a.getSystemAliasInProvider(r,i)},options:{provideApplicationContext:true}},"sap.ushell.services.AppLifeCycle.setNewAppInfo":{async handler(e,s){const t=e;const l=await a.getServiceAsync("AppLifeCycle");l.setAppInfo(t,true)}},"sap.ushell.services.AppLifeCycle.updateCurrentAppInfo":{async handler(e,s){const t=e;const l=await a.getServiceAsync("AppLifeCycle");l.setAppInfo(t,false)}},"sap.ushell.services.AppConfiguration.setApplicationFullWidth":{async handler(e,s){const{bValue:t}=e;const[l]=await u.requireAsync(["sap/ushell/services/AppConfiguration"]);l.setApplicationFullWidthInternal(t)}}};async function f(){const e=a.getRenderer().getShellController();const s=e._getSessionHandler();if(s?.isInitialized?.()){s.userActivityHandler()}}async function A(s="",t="",l="",r="",i="",n,o){let c=u.getDocumentUrl();function p(e,s,r,i,a,n){t=t.includes(e)?t.replace(e,s):t;l=l.includes(e)?l.replace(e,s):l;if(r&&a){t=t.includes(r)?t.replaceAll(r,a):t;l=l.includes(r)?l.replaceAll(r,a):l}if(i&&n){t=t.includes(i)?t.replaceAll(i,n):t;l=l.includes(i)?l.replaceAll(i,n):l}}if(o){const o=await a.getServiceAsync("AppState");o.setAppStateToPublic(n).then((e,a,o,u="",h="")=>{if(u){c=c.replace(a,u)}if(h){c=c.replace(o,h)}p(n,c,a,o,u,h);d.triggerEmail(s,t,l,r,i)},e.error)}else{p(n,c);d.triggerEmail(s,t,l,r,i)}}return{register(){y.forEach(e=>{i.addEventPreprocessor(e)});Object.keys(v).forEach(e=>{const s=v[e];i.setDistributionPolicy(e,s)});Object.keys(g).forEach(e=>{const s=g[e];i.setRequestHandler(e,s.handler,s.options)})},sendEmail:A}});
//# sourceMappingURL=LifecycleHandler.js.map