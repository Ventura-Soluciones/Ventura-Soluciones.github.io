// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["./ContentNodeSelectorRenderer","sap/base/util/deepClone","sap/m/Column","sap/m/ColumnListItem","sap/m/Label","sap/m/MultiInput","sap/m/Token","sap/ui/core/Element","sap/ui/core/Fragment","sap/ui/core/Control","sap/ui/Device","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/json/JSONModel","sap/ushell/Config","sap/ushell/Container","sap/ushell/library","sap/ushell/resources"],function(e,t,n,o,i,a,s,r,l,d,u,p,g,c,h,f,_,y){"use strict";var v=_.ContentNodeType;var m=d.extend("sap.ushell.ui.ContentNodeSelector",{metadata:{library:"sap.ushell",aggregations:{content:{type:"sap.m.MultiInput",multiple:false,visibility:"hidden"}},associations:{labelId:{type:"sap.ui.core.Control",multiple:false}},events:{selectionChanged:{},valueHelpEndButtonPressed:{}}},renderer:e});m.prototype.init=function(){this._oModel=new c({items:[],suggestions:[],isSpaces:h.last("/core/spaces/enabled")});this._oDeviceModel=new c(u);this.setModel(this._oModel,"_internal");this.setModel(this._oDeviceModel,"_device");this.setModel(y.getTranslationModel(),"_i18n");if(!this.getAggregation("content")){const e=this._createMultiInput();this.setAggregation("content",e)}this.setBusyIndicatorDelay(0);this._loadContentNodes().then(this._overwriteLabel.bind(this))};m.prototype._createMultiInput=function(){const e=new a({ariaLabelledBy:this.getLabelId(),valueHelpRequest:this._showValueHelp.bind(this),tokenUpdate:this._onTokenUpdate.bind(this),required:true,suggestionColumns:[new n({header:new i({text:"{= ${_internal>/isSpaces} ? ${_i18n>contentNodeSelectorPage} : ${_i18n>contentNodeSelectorHomepageGroup}}"})}),new n({visible:"{= ${_internal>/isSpaces}}",header:new i({text:"{_i18n>contentNodeSelectorSpace}"})})],suggestionRows:{path:"_internal>/suggestions",template:new o({cells:[new i({text:"{_internal>label}"}),new i({visible:"{_internal>/isSpaces}",text:"{= ${_internal>spaceTitles}.join(', ')}"})]}),templateShareable:false}});e.addValidator(this._validateItem.bind(this));return e};m.prototype._overwriteLabel=function(){var e=this.getLabelId();var t=r.getElementById(e);if(t&&typeof t.setText==="function"){if(this._oModel.getProperty("/isSpaces")){t.setText(y.i18n.getText("contentNodeSelectorHomepagePages"))}else{t.setText(y.i18n.getText("contentNodeSelectorHomepageGroups"))}}if(t&&typeof t.setRequired==="function"&&t.isPropertyInitial("required")){t.setRequired(true)}};m.prototype.exit=function(){this._oModel.destroy();this._oDeviceModel.destroy()};m.prototype.setLabelId=function(e){this.setAssociation("labelId",e);this._overwriteLabel();var t=this.getAggregation("content");if(t){t.addAriaLabelledBy(e)}return this};m.prototype.getSelectedContentNodes=function(){var e=this.getAggregation("content");var n=e.getTokens();return n.map(function(e){var n=e.getBindingContext("_internal").getObject();var o=t(n);delete o.selected;delete o.spaceTitles;return o})};m.prototype._getMyHomeEnablement=function(){return new Promise(function(e,t){var n=h.last("/core/spaces/myHome/enabled");var o=f.getUser().getShowMyHome();e(n&&o)})};m.prototype._filterPersonalizableContentNodes=function(e){if(!Array.isArray(e)){return[]}return e.reduce(function(e,t){if(this._bShowOnlyMyHome&&t.id!==this._sMyHomeSpaceId&&t.id!==this._sMyHomePageId){return e}t.children=this._filterPersonalizableContentNodes(t.children);if(t.type===v.HomepageGroup||t.type===v.Space&&t.children.length||t.type===v.Page&&t.isContainer){e.push(t)}return e}.bind(this),[])};m.prototype._loadContentNodes=function(){this.setBusy(true);return Promise.all([f.getServiceAsync("BookmarkV2"),this._getMyHomeEnablement()]).then(function(e){var n=e[0];var o=e[1];var i=h.last("/core/shell/enablePersonalization");this._bShowOnlyMyHome=!i&&o;this._sMyHomeSpaceId=h.last("/core/spaces/myHome/myHomeSpaceId");this._sMyHomePageId=h.last("/core/spaces/myHome/myHomePageId");return n.getContentNodes().then(function(e){e=t(e);e=this._filterPersonalizableContentNodes(e);m._normalizeContentNodes(e);this._oModel.setProperty("/items",e);var n=m._getSuggestions(e);for(var o=0;o<n.length;o++){n[o].selected=false}this._oModel.setProperty("/suggestions",n);this.setBusy(false)}.bind(this))}.bind(this))};m.prototype._showValueHelp=function(e){var t=e.getSource();var n=t.getValue();if(!this._oValueHelpDialog){l.load({id:this.getId()+"-ValueHelpDialog",name:"sap.ushell.ui.ContentNodeSelectorValueHelp",controller:this}).then(function(e){this.addDependent(e);this._oValueHelpDialog=e;this._openValueHelpDialog(n)}.bind(this))}else{this._openValueHelpDialog(n)}};m.prototype._openValueHelpDialog=function(e){var t=l.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");t.expandToLevel(1);this._oValueHelpDialog.open();var n=l.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");n.setValue(e);this._onValueHelpSearch()};m.prototype._onValueHelpSearch=function(){var e=l.byId(this.getId()+"-ValueHelpDialog","ContentNodesSearch");var t=e.getValue();var n=l.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var o=n.getBinding("items");o.filter(new p({path:"label",operator:g.Contains,value1:t}))};m.prototype._onValueHelpBeginButtonPressed=function(){var e=l.byId(this.getId()+"-ValueHelpDialog","ContentNodesTree");var t=e.getSelectedContextPaths();var n=this.getAggregation("content");n.destroyTokens();var o;var i;for(var a=0;a<t.length;a++){i=t[a];var s=this.getModel("_internal");var r=n.getAggregation("tokens").map(function(e){return e.getProperty("key")}).indexOf(s.getProperty(i).id);if(r<0){o=this._createToken(i);n.addValidateToken({token:o})}}n.setValue("");this._oValueHelpDialog.close()};m.prototype._onValueHelpEndButtonPressed=function(){this.fireValueHelpEndButtonPressed();this._oValueHelpDialog.close()};m.prototype._onTokenUpdate=function(e){var t=e.getParameter("addedTokens");var n=e.getParameter("removedTokens");this._setTokensSelected(t,true);this._setTokensSelected(n,false);setTimeout(this.fireSelectionChanged.bind(this),0)};m.prototype._setTokensSelected=function(e,t){var n;for(var o=0;o<e.length;o++){n=e[o].getBindingContext("_internal");n.getModel().setProperty(n.getPath("selected"),t)}};m.prototype._validateItem=function(e){if(e.suggestedToken){return e.suggestedToken}var t=e.suggestionObject;if(!t){return null}var n=t.getBindingContext("_internal");return this._createToken(n.getPath())};m.prototype._createToken=function(e){var t=new s({key:"{_internal>id}",text:"{_internal>label}"});t.bindObject({path:e,model:"_internal"});return t};m._getSuggestions=function(e){var t=[];m._getChildren(e,t);return t};m._getChildren=function(e,t){var n;for(var o=0;o<e.length;o++){n=e[o];if(n.isContainer&&t.indexOf(n)===-1){t.push(n)}if(n.children){m._getChildren(n.children,t)}}};m._normalizeContentNodes=function(e){var t={};m._visitPages(e,function(e,n){n.spaceTitles=n.spaceTitles||[];if(t[n.id]){t[n.id].spaceTitles.push(e.label);return t[n.id]}n.spaceTitles.push(e.label);t[n.id]=n;return n})};m._visitPages=function(e,t){if(e===undefined||e===null){return}for(var n=0;n<e.length;n++){var o=e[n];if(o.type!==v.Space){return}if(o.children){for(var i=0;i<o.children.length;i++){var a=o.children[i];o.children[i]=t(o,a)}}}};m.prototype.clearSelection=function(){var e=this.getAggregation("content");var t=e.getTokens();t.forEach(function(e){var t=e.getBindingContext("_internal");this._oModel.setProperty(t.getPath("selected"),false)}.bind(this));e.destroyTokens()};m.prototype.setValueState=function(e){var t=this.getAggregation("content");t.setValueState(e)};m.prototype.setValueStateText=function(e){var t=this.getAggregation("content");t.setValueStateText(e)};return m});
//# sourceMappingURL=ContentNodeSelector.js.map