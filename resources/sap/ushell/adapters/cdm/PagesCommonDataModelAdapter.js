// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepExtend","sap/ushell/adapters/cdm/util/cdmSiteUtils","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/jquery","sap/ushell/Config","sap/ushell/Container"],function(e,t,i,n,a,jQuery,r,o){"use strict";var s=function(){this._oCDMPagesRequests={};this._oUnstableVisualizations={};this._sComponent="sap.ushell.adapters.cdm.PagesCommonDataModelAdapter";this.oSitePromise=new Promise(function(e,t){this.fnSiteResolve=e;this.fnSiteReject=t}.bind(this))};s.prototype.getSite=function(){var e=new jQuery.Deferred;o.getServiceAsync("NavigationDataProvider").then(function(e){return e.getNavigationData()}).then(function(e){var n={};var a=e.inbounds;for(var r=0;r<a.length;r++){var o=a[r].permanentKey||a[r].id;n[o]=a[r]}var s={_version:"3.1.0",site:{},catalogs:{},groups:{},visualizations:{},applications:i.getApplications(n),vizTypes:{},systemAliases:t({},e.systemAliases),pages:{}};this.fnSiteResolve(s);return s}.bind(this)).then(e.resolve).catch(function(t){e.reject(t);this.fnSiteReject(t)}.bind(this));return e.promise()};s.prototype.getPage=function(t){if(!t){var i="PagesCommonDataModelAdapter: getPage was called without a pageId";e.fatal(i,null,this._sComponent);return Promise.reject(i)}return this.oSitePromise.then(function(i){if(i.pages[t]){return i.pages[t]}return Promise.all([o.getServiceAsync("PagePersistence"),o.getServiceAsync("NavigationDataProvider")]).then(function(e){var i=e[0];var n=e[1];return Promise.all([i.getPage(t),n.getNavigationData()])}).then(function(e){var t=e[0];var n=e[1];this._addVisualizationsToSite(i,t.visualizations);this._addVizTypesToSite(i,t);this._addPageToSite(i,t.page,n);this._storeUnstableVisualizations(t.page.id,t.unstableVisualizations);return i.pages[t.page.id]}.bind(this)).catch(function(t){e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);return Promise.reject(t)}.bind(this))}.bind(this))};s.prototype._storeUnstableVisualizations=function(e,t){if(!t){return}this._oUnstableVisualizations[e]=t};s.prototype._addVizTypesToSite=function(e,t){var a={};Object.keys(t.vizTypes).forEach(function(i){if(!e.vizTypes[i]){a[i]=t.vizTypes[i]}});n(e.vizTypes,i.getVizTypes(a))};s.prototype._addVisualizationsToSite=function(e,t,a){var r;if(a){r={};Object.keys(t).forEach(function(i){if(!e.visualizations[i]){r[i]=t[i]}})}else{r=t}n(e.visualizations,i.getVisualizations(r))};s.prototype._addPageToSite=function(t,i,n){var a={};var r=n.inbounds;for(var o=0;o<r.length;o++){var s=r[o].permanentKey||r[o].id;a[s]=r[o]}var u=t.pages[i.id]={identification:{id:i.id,title:i.title},payload:{layout:{sectionOrder:i.sections.map(function(e){return e.id})},sections:{}}};var c;var l;for(var d=0;d<i.sections.length;d++){c=i.sections[d];l=u.payload.sections[c.id]={id:c.id,title:c.title,layout:{vizOrder:c.viz.map(function(e){return e.id})},viz:{}};var v,p;for(var h=0;h<c.viz.length;h++){v=c.viz[h];p=!t.visualizations[v.vizId];if(p){var f=l.layout.vizOrder;f.splice(f.indexOf(v.id),1);if(p){e.error(`Tile '${v.id}' with vizId '${v.vizId}' has no matching visualization. As the tile cannot be used to start an app it is removed from the page.`,null,this._sComponent)}continue}l.viz[v.id]={id:v.id,vizId:v.vizId,displayFormatHint:v.displayFormatHint}}}};s.prototype.getPages=function(t){if(!(t&&Array.isArray(t)&&t.length!==0)){var i="PagesCommonDataModelAdapter: getPages is not an array or does not contain any Page id";e.fatal(i,null,this._sComponent);return Promise.reject(i)}return this.oSitePromise.then(function(i){var n;var a=[];for(var r=0;r<t.length;r++){n=t[r];if(!i.pages[n]){a.push(t[r])}}if(a.length===0){return i.pages}return Promise.all([o.getServiceAsync("PagePersistence"),o.getServiceAsync("NavigationDataProvider")]).then(function(e){var t=e[0];var i=e[1];return Promise.all([t.getPages(a),i.getNavigationData()])}).then(function(e){var t=e[0];var n=e[1];for(var a=0;a<t.length;a++){this._addVisualizationsToSite(i,t[a].visualizations,true);this._addVizTypesToSite(i,t[a]);this._addPageToSite(i,t[a].page,n);this._storeUnstableVisualizations(t[a].page.id,t[a].unstableVisualizations)}return i.pages}.bind(this)).catch(function(t){e.fatal("PagesCommonDataModelAdapter encountered an error while fetching required services: ",t,this._sComponent);return Promise.reject(t)}.bind(this))}.bind(this)).then(function(e){var i={};t.forEach(function(t){var n=e[t];if(n){i[t]=n}});return i})};s.prototype.getPersonalization=function(t){var i=new jQuery.Deferred;o.getServiceAsync("PersonalizationV2").then(async function(n){var r;var o=new a(t);r={container:"sap.ushell.cdm.personalization",item:"data"};if(o.inRange("3.1.0","4.0.0")){r={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var s={validity:"Infinity",keyCategory:n.KeyCategory.GENERATED_KEY,writeFrequency:n.WriteFrequency.HIGH,clientStorageAllowed:false};const u=await n.getPersonalizer(r,s);u.getPersData().then(function(e){i.resolve(e||{})}).catch(function(t){e.error("Could not load page personalization",t,this._sComponent);i.reject(t)}.bind(this))}.bind(this)).catch(function(){i.reject("Personalization Service could not be loaded")});return i.promise()};s.prototype.setPersonalization=function(e){var t=new jQuery.Deferred;o.getServiceAsync("PersonalizationV2").then(async function(i){var n;var r=new a(e.version);n={container:"sap.ushell.cdm.personalization",item:"data"};if(r.inRange("3.1.0","4.0.0")){n={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var o={validity:"Infinity",keyCategory:i.KeyCategory.GENERATED_KEY,writeFrequency:i.WriteFrequency.HIGH,clientStorageAllowed:false};const s=await i.getPersonalizer(n,o);s.setPersData(e).then(function(){t.resolve(e)}).catch(function(e){t.reject(e)})}).catch(function(){t.reject("Personalization Service could not be loaded")});return t.promise()};s.prototype.getVisualizations=function(){return o.getServiceAsync("VisualizationDataProvider").then(function(e){return Promise.all([e.getVisualizationData(),this.oSitePromise]).then(function(e){var t=e[0];var i=e[1];this._addVisualizationsToSite(i,t.visualizations);return i.visualizations}.bind(this))}.bind(this))};s.prototype.getVizTypes=function(){return o.getServiceAsync("VisualizationDataProvider").then(function(e){return Promise.all([e.getVisualizationData(),this.oSitePromise]).then(function(e){var t=e[0];var i=e[1];this._addVizTypesToSite(i,t);return i.vizTypes}.bind(this))}.bind(this))};s.prototype.getVizType=function(e){return this.oSitePromise.then(function(t){var a=t.vizTypes[e];if(a){return a}if(!e.startsWith("X-SAP-UI2-CHIP:")){return}return o.getServiceAsync("VisualizationDataProvider").then(function(t){return t.loadVizType(e)}).then(function(a){if(!a){return}var r={};r[e]=a;n(t.vizTypes,i.getVizTypes(r));return t.vizTypes[e]})})};s.prototype.getCachedVisualizations=function(){return this.oSitePromise.then(function(e){return e.visualizations})};s.prototype.getCachedVizTypes=function(){return this.oSitePromise.then(function(e){return e.vizTypes})};s.prototype.migratePersonalizedPages=function(e){var t=[];e.forEach(function(e){var i=e.identification.id;var n=this._oUnstableVisualizations[i];if(!n){return}Object.keys(e.payload.sections).forEach(function(a){var r=e.payload.sections[a];Object.keys(r.viz).forEach(function(e){var a=r.viz[e];var o=n[a.vizId];if(o){a.vizId=o.vizId;if(!t.includes(i)){t.push(i)}}})});this._oUnstableVisualizations[i]=null}.bind(this));return Promise.resolve(t)};return s},false);
//# sourceMappingURL=PagesCommonDataModelAdapter.js.map