// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/extend","sap/base/util/Version","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/Container"],function(e,t,i,r,jQuery,n){"use strict";var o=function(e,t,i){this.oAdapterConfiguration=i;if(i&&i.config&&i.config.siteData){this.oCdmSiteDataRequestPromise=(new jQuery.Deferred).resolve(i.config.siteData)}else if(i&&i.config&&i.config.siteDataPromise){this.oCdmSiteDataRequestPromise=i.config.siteDataPromise}else{var r=this._identifySiteUrlFromConfig(i);var n=this._normalizeUrl(r,location.href);this.oCdmSiteDataRequestPromise=this._requestSiteData(n)}};o.prototype._requestSiteData=function(t){var i=new jQuery.Deferred;if(!t){return i.reject("Cannot load site: configuration property 'siteDataUrl' is missing for CommonDataModelAdapter.")}jQuery.ajax({type:"GET",dataType:"json",url:t}).done(function(e){i.resolve(e)}).fail(function(t){e.error(t.responseText);i.reject("CDM Site was requested but could not be loaded.")});return i.promise()};o.prototype._normalizeUrl=function(e,t){if(typeof e!=="string"){return e}if(e.indexOf("http")===0){return e}var i=document.getElementsByTagName("base")[0];return new r(e,i).absoluteTo(t).toString()};o.prototype.getSite=function(){var e=new jQuery.Deferred;this.oCdmSiteDataRequestPromise.done(function(i){var r=t({},i);delete r.personalization;e.resolve(r)}).fail(function(t){e.reject(t)});return e.promise()};o.prototype.getPersonalization=function(){var i=new jQuery.Deferred,r=this;this.oCdmSiteDataRequestPromise.done(function(n){var o=t({},n),a=o._version,s;if(r.oAdapterConfiguration&&r.oAdapterConfiguration.config&&r.oAdapterConfiguration.config.ignoreSiteDataPersonalization){delete o.personalization}if(o.personalization){s=o.personalization._version;if(Object.keys(o.personalization).length>0&&!r._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);i.resolve();return}i.resolve(o.personalization)}else{r._readPersonalizationDataFromStorage(a).done(function(t){s=t._version;if(Object.keys(t).length>0&&!r._isPersonalizationVersionValid(a,s)){e.error("Personalization version is not compatible to the site version and will not be loaded."+" Please proceed to personalize the homepage again if needed. Personalization version: "+s+"; Site version: "+a);i.resolve();return}i.resolve(t)}).fail(function(e){i.reject(e)})}}).fail(function(e){i.reject(e)});return i.promise()};o.prototype._isPersonalizationVersionValid=function(e,t){if(!e){return false}var r=new i(e).getMajor(),n=new i(t);if(r>=3){return n.getMajor()===r}return n.getMajor()<3};o.prototype.setPersonalization=function(t){var r=new jQuery.Deferred;n.getServiceAsync("PersonalizationV2").then(async function(n){var o,a={keyCategory:n.KeyCategory.FIXED_KEY,writeFrequency:n.WriteFrequency.LOW,clientStorageAllowed:true},s={container:"sap.ushell.cdm.personalization",item:"data"},l=new i(t.version);if(l.inRange("3.1.0","4.0.0")){s={container:"sap.ushell.cdm3-1.personalization",item:"data"}}var c=await n.getPersonalizer(s,a,o);c.setPersData(t).then(function(){e.info("Personalization data has been stored successfully.");r.resolve()}).catch(function(){r.reject("Writing personalization data failed.")})});return r.promise()};o.prototype._readPersonalizationDataFromStorage=function(e){var t=new jQuery.Deferred;n.getServiceAsync("PersonalizationV2").then(async function(r){var n={keyCategory:r.KeyCategory.FIXED_KEY,writeFrequency:r.WriteFrequency.LOW,clientStorageAllowed:true};var o={container:"sap.ushell.cdm.personalization",item:"data"};if(e){var a=new i(e);if(a&&a.inRange("3.1.0","4.0.0")){o={container:"sap.ushell.cdm3-1.personalization",item:"data"}}}const s=await r.getPersonalizer(o,n);s.getPersData().then(function(e){t.resolve(e||{})}).catch(function(){t.reject("Fetching personalization data failed.")})});return t.promise()};o.prototype._identifySiteUrlFromConfig=function(e){var t=new URLSearchParams(window.location.search);var i=t.get("sap-ushell-cdm-site-url");var r=e&&e.config;if(r&&!r.allowSiteSourceFromURLParameter&&i){i=null}if(r&&!i){i=r.siteDataUrl||r.cdmSiteUrl}this.sCdmSiteUrl=i;return i};return o},false);
//# sourceMappingURL=CommonDataModelAdapter.js.map