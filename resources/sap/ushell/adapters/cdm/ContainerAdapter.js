// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/extend","sap/base/util/ObjectPath","sap/ui/thirdparty/URI","sap/ui/thirdparty/jquery","sap/ushell/System","sap/ushell/User","sap/ushell/utils","sap/ushell/Container","sap/ushell/resources","sap/ushell/Config"],function(e,t,i,s,n,jQuery,r,o,a,l,u,c){"use strict";var d=e.getLogger("sap/ushell/adapters/cdm/ContainerAdapter",e.Level.INFO);var f=function(c,f,g){var m="/sap/public/bc/icf/logoff",h=v(g.config,m),p=s.get("systemProperties.logoutMethod",g.config)||"GET",y=s.get("systemProperties.csrfTokenUrl",g.config),P=R(g.config),A=w(c,g.config),b=S(g.config);function v(e,t){if(e.systemProperties&&e.systemProperties.logoutUrl){return e.systemProperties.logoutUrl}return t}function R(e){var t,i=e.userProfile;if(i){t=T(i.defaults,e.userProfilePersonalization,i.metadata)}const s=L(t||C());return new o(s)}function w(e,t){var i=t.systemProperties,s=e.getAlias(),n=e.getPlatform(),o=e.getBaseUrl(),a,l,u,c,d,f,g;if(i){s=i.alias||s;n=i.platform||n;a=i.SID;l=i.client;u=i.productName;c=i.productVersion;d=i.systemName;f=i.systemRole;g=i.tenantRole}return new r({alias:s,platform:n,baseUrl:o,system:a,client:l,productName:u,productVersion:c,systemName:d,systemRole:f,tenantRole:g})}function T(e,t,s){var n=i(C(),e,t);n.bootTheme=n.bootTheme||{theme:n.theme,root:""};delete n.theme;if(s){if(s.editablePropterties){n.setThemePermitted=s.editablePropterties.indexOf("theme")>-1;n.setAccessibilityPermitted=s.editablePropterties.indexOf("accessibility")>-1;n.setContentDensityPermitted=s.editablePropterties.indexOf("contentDensity")>-1}if(s.ranges){n.ranges=s.ranges}}return n}function C(){return{setThemePermitted:false,setAccessibilityPermitted:false,setContentDensityPermitted:false,getLanguageAndRegionSettingsEntry:async function(){var[e]=await a.requireAsync(["sap/ushell/adapters/cdm/Settings/UserLanguageAndRegion/UserLanguageAndRegionEntry"]);return e}}}function S(e){var t=e&&e.systemProperties&&e.systemProperties.sessionKeepAlive;if(!t){return null}if(!t.url){d.error("Mandatory parameter 'url' missing in 'sessionKeepAlive' configuration.");return null}if(t.method!=="HEAD"&&t.method!=="GET"){t.method="HEAD"}return t}this._getLogoutUrl=function(){return h};this._setDocumentLocation=function(e){document.location=e};this._setWindowLocation=function(e){window.location.href=e};this.getSystem=function(){return A};this.getUser=function(){return P};this.load=function(){return jQuery.when()};this.getCurrentUrl=function(){return window.location.href};this.logout=async function(e){var t;if(!e){throw new Error("Not implemented")}if(a.hasNativeLogoutCapability()){t=new n(this._getLogoutUrl()).absoluteTo(this.getCurrentUrl()).search("").toString();a.getPrivateEpcm().doLogOff(t)}else{await this.logoutRedirect()}};this.logoutRedirect=async function(){const t=A.adjustUrl(this._getLogoutUrl());if(p==="POST"){e.info("performing logout from system via POST",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");let i=false;let s;try{s=await fetch(y,{method:"HEAD",headers:{"X-CSRF-Token":"Fetch"}})}catch(e){i=true}if(i||!s.ok){e.error("fetching X-CSRF-Token for logout via POST failed for system: "+A.getAlias(),undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");if(s.status===401){a.reload();return}const t=await l.getServiceAsync("MessageInternal");t.show(t.Type.ERROR,u.i18n.getText("LogoutFailed"),{callback:a.reload});return}let n;try{n=await fetch(t,{method:"POST",headers:{"X-CSRF-Token":s.headers.get("X-CSRF-Token")}});const e=await n.text();this._setWindowLocation(e)}catch(e){i=true}if(i||!n.ok){e.error("logout via POST failed for system: "+A.getAlias(),undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect")}}else{e.info("performing logout from system via GET (redirect)",undefined,"sap.ushell.adapters.cdm.ContainerAdapter::logoutRedirect");this._setDocumentLocation(t)}};this.sessionKeepAlive=function(){if(!b){return}var e=new XMLHttpRequest;e.open(b.method,b.url,true);e.onreadystatechange=function(){if(this.readyState===4){d.debug("Server session was extended")}};e.send()};this._getSessionKeepAliveConfig=function(){return b};function L(e){const i=t(e);const s=["id","email","firstName","lastName","fullName","isJamActive","isAdminUser","timeZone","language","languageBcp47","image","isImageConsent","isLanguagePersonalized","calendarWeekNumbering","trackUsageAnalytics","contentDensity","setContentDensityPermitted","accessibility","setAccessibilityPermitted","bootTheme","themeRoot","ranges","setThemePermitted","importBookmarks","showMyHome","detectDarkMode","getLanguageAndRegionSettingsEntry"];Object.keys(i).forEach(function(e){if(!s.includes(e)){delete i[e]}});return i}};return f},false);
//# sourceMappingURL=ContainerAdapter.js.map