// Copyright (c) 2009-2025 SAP SE, All Rights Reserved
sap.ui.define(["sap/base/Log","sap/base/i18n/Localization","sap/ushell/components/tiles/utils","sap/ushell/Config","sap/ushell/library","sap/ushell/utils/HttpClient","sap/ushell/utils/workpage/WorkPageService"],function(e,t,n,i,s,a,r){"use strict";var o=s.ContentNodeType;var u="sap.ushell.adapters.cep.MenuAdapter";const p={Workpage:"workpage",Visualization:"visualization"};const l={workpage:"workpage",page:"page"};const c={Menu:"FLP menu",ContentNodes:"content nodes"};var d=function(t,n,i){if(i&&i.config&&i.config.serviceUrl&&i.config.siteId){this.httpClient=new a;this.serviceUrl=i.config.serviceUrl;this.siteId=i.config.siteId;this.oWorkPageService=new r;this.oSiteDataPromise=this._doRequest(this.serviceUrl,this.siteId);this.oVizDataPromise=this._loadVisualizations()}else{e.error("Invalid configuration provided.","",u)}};d.prototype._loadVisualizations=async function(){if(i.last("/core/menuQueryAvailable")){const e=await this._getVisualizationIds();if(e.length>0){const t={filter:[{id:{in:e}}]};return this.oWorkPageService.loadVisualizations(t,true)}}return[]};d.prototype.isMenuEnabled=function(){if(!i.last("/core/menu/enabled")){return Promise.resolve(false)}return this.getMenuEntries().then(function(e){return e.length>0})};d.prototype.isSideNavigationEnabled=async function(){if(!i.last("/core/sideNavigation/enabled")){return false}const e=await this.getMenuEntries();return e.length>0};d.prototype.getMenuEntries=async function(){const[e,t]=await Promise.all([this._getMenu(),this._getVisualizations()]);return this._buildMenuEntries(e,t)};d.prototype.getContentNodes=async function(){const e=await this._getMenu();return this._buildContentNodes(e)};d.prototype._getVisualizationIds=async function(){const t=new Set;const n=await this._getMenu();n.forEach(n=>{if(!Array.isArray(n?.subMenu)){e.warning(`Menu entry ${n.id} does not contain a sub menu array for site-id: ${this.siteId}, ${u}`);return}n.subMenu.forEach(e=>{if(e.type===p.Visualization&&e.id){t.add(e.id)}})});return[...t]};d.prototype._buildMenuEntries=function(e,t){return e.filter(this._isSpaceNotEmpty.bind(null,c.Menu)).map(e=>{const n=this._buildMenuEntry(e,t);const i=[];e.subMenu.forEach(n=>{n.spaceid=e.id;const s=this._buildMenuEntry(n,t);i.push(s)});if(i.length>1){n.menuEntries=i}return n})};d.prototype._buildMenuEntry=function(t,i){let s=t;let a=t.title;let r=t.icon;let o="Page-";let l="Launchpad";let c="openFLPPage";let d="pageId";let g=t.id;if(Array.isArray(t?.subMenu)&&t.subMenu.length>0){s=t.subMenu[0];o="Space-";g=s.id;if(t.subMenu.length===1&&s.type===p.Visualization){a=s.title;r=s.icon}}const f=i.find(e=>e.id===s?.id);if(f&&f!==undefined){o="App-";d="sap-ui-app-id-hint";if(f.targetAppIntent){g=f.targetAppIntent.businessAppId;l=f.targetAppIntent.semanticObject;c=f.targetAppIntent.action}else{e.warning(`Visualization ${f.id} does not contain a targetAppIntent for site-id: ${this.siteId}, ${u}`)}}if(!n.isIconURIValid(r)){r=undefined}return{title:a,"help-id":o+t.id,description:"",icon:r,type:"IBN",target:{semanticObject:l,action:c,parameters:[{name:"spaceId",value:t.spaceid||t.id},{name:d,value:g}],innerAppRoute:undefined},menuEntries:[]}};d.prototype._buildContentNodes=function(e){return e.filter(this._isSpaceNotEmpty.bind(null,c.ContentNodes)).map(function(e){return{id:e.id,label:e.title||e.id,type:o.Space,isContainer:false,children:e.subMenu.map(function(e){const t=e.type===p.Workpage;return{id:e.id,label:e.title||e.id,type:t?o.Page:o.Visualization,isContainer:e?.pageType===l.page,children:[]}})}})};d.prototype.isWorkPage=async function(e){const t=await this._getMenu();const n=t.flatMap(e=>e.subMenu||[]).filter(e=>e.pageType===l.workpage&&e.type===p.Workpage).find(t=>t.id===e);return!!n};d.prototype._doRequest=function(n,s){let a="";if(i.last("/core/menuQueryAvailable")){a=`{\n            menu(siteId: "${s}")\n        }`}else{a=`{\n                spaces(siteId: "${s}") {\n                    nodes {\n                        id,\n                        descriptor {\n                            value(select: ["/title"])\n                        },\n                        workPages {\n                            nodes {\n                                id,\n                                contents(queryInput: {selectProperties: ["/descriptor"], selectDescriptorValueProperties: ["/title", "/pageType"]})\n                            }\n                        }\n                    }\n                }\n            }`}a=a.replace(/\n/g,"").replace(/ /g,"");const r={"Content-Type":"application/json",Accept:"application/json","Accept-Language":t.getLanguageTag().toString()};if(i.last("/core/site/sapCdmVersion")){r["sap-cdm-content-version"]=i.last("/core/site/sapCdmVersion")}return this.httpClient.get(n+"?query="+a,{headers:r}).then(function(t){if(t.status<200||t.status>=300){e.error(t.responseText,"",u);return Promise.reject(`HTTP request to GraphQL service failed with status: ${t.status} - ${t.statusText}`)}return JSON.parse(t.responseText||"{}")}).then(function(e){if(!i.last("/core/menuQueryAvailable")){e.data.menu=e.data.spaces.nodes.map(function(e){return{id:e.id,type:"space",title:e?.descriptor?.value?.title,subMenu:e?.workPages?.nodes?.map(function(e){return{id:e.id,type:"workpage",title:e?.contents?.descriptor?.value?.title,pageType:e.contents.descriptor?.value?.pageType?"page":"workpage"}})}})}try{e.data.menu=e.data.menu.filter(function(e){return e.id!=="default_space"})}catch(e){}return e})};d.prototype._getMenu=async function(){const t=await this.oSiteDataPromise;if(Array.isArray(t?.data?.menu)&&t.data.menu.length>0){return t.data.menu}e.warning("No menu found for site-id: "+this.siteId,"",u);return[]};d.prototype._getVisualizations=async function(){const t=await this.oVizDataPromise;if(Array.isArray(t?.visualizations?.nodes)&&t.visualizations.nodes.length>0){return t.visualizations.nodes}e.info("No visualizations found for site-id: "+this.siteId,"",u);return[]};d.prototype._isSpaceNotEmpty=function(t,n){if(!(Array.isArray(n?.subMenu)&&n.subMenu.length>0)||!n.subMenu?.some(e=>Object.keys(e).length>0)){e.warning(`FLP space ${n.id} without sub menu content omitted in ${t}.`,"",u);return false}return true};return d});
//# sourceMappingURL=MenuAdapter.js.map